<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LEKER - Sistema de Gestión Logística</title>
  <!-- Favicon: color en light mode, blanco en dark mode -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" media="(prefers-color-scheme: light)">
  <link rel="icon" type="image/svg+xml" href="/favicon-light.svg" media="(prefers-color-scheme: dark)">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e1b4b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- =============================================
       TRACKING SCRIPTS - CONFIGURAR IDs
       ============================================= -->

  <!-- Google Analytics 4 -->
  <!-- CONFIGURAR: Reemplazar GA_MEASUREMENT_ID con tu ID (ej: G-XXXXXXXXXX) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'GA_MEASUREMENT_ID'); // <- Reemplazar con tu ID
    // Google Ads - CONFIGURAR: Reemplazar AW_CONVERSION_ID (ej: AW-XXXXXXXXXX)
    // gtag('config', 'AW_CONVERSION_ID');
  </script>

  <!-- Meta Pixel (Facebook) -->
  <!-- CONFIGURAR: Reemplazar META_PIXEL_ID con tu ID (ej: 1234567890123456) -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', 'META_PIXEL_ID'); // <- Reemplazar con tu ID
    fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.net/tr?id=META_PIXEL_ID&ev=PageView&noscript=1"/></noscript>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Google Maps will load its own styles -->

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <style>
    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      --border: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --purple: #8b5cf6;
      --bg-overlay: rgba(255, 255, 255, 0.95);
      --input-bg: #ffffff;
    }

    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --bg-hover: #334155;
      --border: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --bg-overlay: rgba(30, 41, 59, 0.95);
      --input-bg: #334155;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      max-width: 100vw;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
      transition: width 0.25s ease;
    }

    .sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 57px;
    }

    /* Collapse toggle button */
    .sidebar-collapse-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .sidebar-collapse-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* Sidebar search */
    .sidebar-search {
      padding: 12px 12px 0;
    }
    .sidebar-search-input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    .sidebar-search-input::placeholder {
      color: var(--text-muted);
    }
    .sidebar-search-input:focus {
      border-color: var(--accent);
    }
    .sidebar-search-wrap {
      position: relative;
    }
    .sidebar-search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 14px;
      height: 14px;
      color: var(--text-muted);
      pointer-events: none;
    }

    /* Collapsed sidebar */
    .sidebar.collapsed {
      width: 68px;
      overflow-x: hidden;
    }
    .sidebar.collapsed .sidebar-header {
      padding: 16px 10px;
      justify-content: center;
      flex-direction: column;
      align-items: center;
    }
    .sidebar.collapsed .logo-isotipo {
      display: block !important;
      cursor: pointer;
    }
    .sidebar.collapsed .logo-expand-arrow {
      display: block !important;
      cursor: pointer;
      text-align: center;
    }
    .sidebar.collapsed .logo-expand-arrow:hover {
      color: var(--accent) !important;
    }
    .sidebar.collapsed .logo-img,
    .sidebar.collapsed .logo-text,
    .sidebar.collapsed .sidebar-version,
    .sidebar.collapsed .sidebar-collapse-btn,
    .sidebar.collapsed .sidebar-search,
    .sidebar.collapsed .nav-section-title,
    .sidebar.collapsed .nav-item span,
    .sidebar.collapsed .nav-item-parent .submenu-arrow,
    .sidebar.collapsed .nav-submenu,
    .sidebar.collapsed .sidebar-footer > div > div > div:nth-child(2),
    .sidebar.collapsed .sidebar-footer > div > div > i:last-child,
    .sidebar.collapsed #install-btn-sidebar .install-btn-text {
      display: none !important;
    }
    .sidebar.collapsed #install-btn-sidebar { padding: 0 8px 8px 8px; }
    .sidebar.collapsed #install-btn-sidebar button { padding: 9px; justify-content: center; }
    .sidebar.collapsed .logo {
      gap: 0;
      justify-content: center;
    }
    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 11px;
      position: relative;
      overflow: hidden;
    }
    .sidebar.collapsed .nav-item i {
      margin: 0;
    }
    .sidebar.collapsed .nav-section {
      margin-bottom: 12px;
    }
    .sidebar.collapsed .sidebar-footer > div {
      padding: 8px;
      display: flex;
      justify-content: center;
    }
    .sidebar.collapsed .sidebar-footer > div > div {
      justify-content: center;
    }
    .sidebar.collapsed + .sidebar-overlay + .main {
      margin-left: 68px;
    }

    /* Tooltip for collapsed sidebar */
    .sidebar.collapsed .nav-item[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      left: calc(100% + 8px);
      top: 50%;
      transform: translateY(-50%);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 1px solid var(--border);
      z-index: 200;
      pointer-events: none;
    }

    /* Nav item hidden by search */
    .nav-section.search-hidden,
    .nav-item.search-hidden,
    .nav-subitem.search-hidden,
    .nav-item-expandable.search-hidden {
      display: none !important;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 34px;
      height: 34px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo-text span {
      color: var(--accent);
    }

    .nav {
      padding: 16px 12px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    .nav::-webkit-scrollbar {
      width: 4px;
    }
    .nav::-webkit-scrollbar-track {
      background: transparent;
    }
    .nav::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    .nav::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text-secondary);
      margin-bottom: 2px;
      font-size: 13px;
      font-weight: 500;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--accent);
      color: white;
    }

    .nav-item i {
      width: 20px;
      height: 20px;
    }

    /* Expandable Submenu */
    .nav-item-expandable {
      margin-bottom: 4px;
    }

    .nav-item-parent {
      justify-content: flex-start;
    }

    .nav-item-parent .submenu-arrow {
      margin-left: auto;
      width: 16px;
      height: 16px;
      transition: transform 0.2s;
    }

    .nav-item-expandable.open .submenu-arrow {
      transform: rotate(180deg);
    }

    .nav-submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding-left: 16px;
    }

    .nav-item-expandable.open .nav-submenu {
      max-height: 300px;
    }

    .nav-subitem {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
      font-size: 13px;
      margin-bottom: 2px;
    }

    .nav-subitem:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .nav-subitem.active {
      background: var(--accent);
      color: white;
      font-weight: 600;
      border-radius: 6px;
    }
    .nav-subitem.active i {
      color: white;
    }

    .nav-item-expandable.has-active-child > .nav-item-parent {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent);
      border-left: 3px solid var(--accent);
      font-weight: 600;
    }
    .nav-item-expandable.has-active-child > .nav-item-parent i {
      color: var(--accent);
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
    }

    .demo-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      font-size: 12px;
      color: var(--warning);
    }

    /* Main Content */
    .main {
      flex: 1;
      margin-left: 240px;
      min-height: 100vh;
      transition: margin-left 0.25s ease;
      max-width: 100%;
      overflow-x: hidden;
      min-width: 0;
    }

    .topbar {
      height: 52px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .page-title {
      font-size: 16px;
      font-weight: 600;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      box-shadow: none;
      border: none;
      font-size: 12px;
      color: white;
    }

    .theme-toggle {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: all 0.15s;
    }

    .theme-toggle:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .theme-toggle .icon-sun,
    .theme-toggle .icon-moon {
      width: 20px;
      height: 20px;
    }

    .theme-toggle .icon-sun { display: none; }
    .theme-toggle .icon-moon { display: block; }

    [data-theme="dark"] .theme-toggle .icon-sun { display: block; }
    [data-theme="dark"] .theme-toggle .icon-moon { display: none; }

    .content {
      padding: 24px;
      max-width: 100%;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .dash-grid-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
    .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .stat-icon.purple { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
    .stat-icon.orange { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .stat-icon.red { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .stat-icon.yellow { background: rgba(234, 179, 8, 0.15); color: #ca8a04; }

    .stat-info h3 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 2px;
      line-height: 1.2;
    }

    .stat-info p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Panels */
    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    /* Grid Layout */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .grid-3-1 {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: visible;
    }

    /* Resizable cards */
    .card[style*="resize"] {
      position: relative;
    }

    .card[style*="resize"]::-webkit-resizer {
      background: linear-gradient(-45deg, transparent 30%, var(--border) 30%, var(--border) 40%, transparent 40%, transparent 60%, var(--border) 60%, var(--border) 70%, transparent 70%);
      cursor: se-resize;
    }

    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
    }

    .card-header h3 {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .card-header h3 i, .card-header h3 svg {
      color: var(--accent);
      width: 16px;
      height: 16px;
    }

    .card-body {
      padding: 16px;
    }

    /* Map */
    .map-container {
      height: 500px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }
    #map-route {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    .map-overlay {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 1000;
      background: var(--bg-overlay);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .map-legend {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-filter {
      transition: all 0.2s ease;
      opacity: 1;
      user-select: none;
    }

    .legend-filter.active {
      background: rgba(0,0,0,0.04);
      border-radius: 6px;
    }

    .legend-filter:hover {
      background: var(--bg-hover) !important;
    }

    .legend-filter:not(.active) {
      opacity: 0.35;
    }

    .legend-filter:not(.active) .legend-dot {
      background: #d1d5db !important;
    }

    .legend-filter .toggle-eye { color: #10b981; }
    .legend-filter:not(.active) .toggle-eye { color: #9ca3af; }

    /* Map top-right buttons */
    .map-btn {
      background: white; border: 1px solid #e5e7eb; border-radius: 8px;
      padding: 6px 10px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      display: flex; align-items: center; gap: 4px; font-size: 11px;
      font-weight: 600; color: #374151; transition: all 0.15s;
    }
    .map-btn:hover { background: #f9fafb; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    /* Fullscreen map overlay */
    #main-map-container:fullscreen,
    #main-map-container:-webkit-full-screen {
      height: 100vh !important;
      width: 100vw !important;
      border-radius: 0;
    }
    #main-map-container:fullscreen #map,
    #main-map-container:-webkit-full-screen #map {
      height: 100% !important;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-dot.seg-8020 { background: #f59e0b; }
    .legend-dot.seg-l    { background: #3b82f6; }
    .legend-dot.seg-n    { background: #94a3b8; }
    .legend-dot.seg-none { background: #cbd5e1; }
    .legend-dot.route { background: var(--accent); }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .form-control {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      transition: all 0.15s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn:active {
      transform: scale(0.95);
      opacity: 0.85;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-purple {
      background: var(--purple);
      color: white;
    }

    .btn-purple:hover {
      background: #7c3aed;
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.18);
    }

    .btn-secondary {
      background: var(--bg-hover);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .btn-block {
      width: 100%;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Response Box */
    .response-box {
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .response-box pre {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 11px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-secondary);
    }

    .response-box.success {
      border-color: var(--success);
    }

    .response-box.error {
      border-color: var(--danger);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    .modal-content {
      position: relative;
      background: var(--bg-card);
      border-radius: 10px;
      width: 90%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
      animation: modalSlide 0.2s ease-out;
    }
    @keyframes modalSlide {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h3 {
      margin: 0;
      font-size: 15px;
    }
    .btn-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .btn-close:hover {
      color: var(--text-primary);
    }
    .modal-body {
      padding: 18px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 12px 18px;
      border-top: 1px solid var(--border);
    }
    .btn-icon {
      background: none;
      border: none;
      padding: 6px;
      cursor: pointer;
      color: var(--text-muted);
      border-radius: 4px;
      transition: all 0.2s;
    }
    .btn-icon:hover {
      background: var(--bg-hover);
      color: var(--accent);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease;
      min-width: 280px;
      max-width: 400px;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    .toast-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .toast.success .toast-icon { color: var(--success); }
    .toast.error .toast-icon { color: var(--danger); }
    .toast.warning .toast-icon { color: var(--warning); }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 1px;
    }

    .toast-message {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .toast-close {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-close:hover {
      color: var(--text-primary);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Data Panel Tabs */
    .data-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .data-tab {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.15s;
      font-family: inherit;
    }

    .data-tab:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .data-tab.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .data-tab.active .badge {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .data-tab .badge {
      font-size: 11px;
      padding: 2px 8px;
    }

    .data-subpanel {
      display: none;
    }

    .data-subpanel.active {
      display: block;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .spin {
      animation: spin 1s linear infinite;
    }

    /* Google Sheets Tables */
    .gs-table-wrap {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      border-radius: 8px;
    }
    .gs-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }
    .gs-table thead {
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .gs-table thead th {
      padding: 10px 14px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
      user-select: none;
    }
    .gs-table tbody tr {
      transition: background 0.15s;
    }
    .gs-table tbody tr:nth-child(even) {
      background: var(--bg-hover);
    }
    .gs-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.06);
    }
    [data-theme="dark"] .gs-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.12);
    }
    .gs-table tbody td {
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      max-width: 280px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .gs-table tbody td.num {
      text-align: right;
      font-weight: 500;
    }
    .gs-table tbody tr.row-danger {
      background: rgba(239, 68, 68, 0.07);
    }
    .gs-table tbody tr.row-danger:hover {
      background: rgba(239, 68, 68, 0.12);
    }

    /* GSheets Tabs Bar */
    .gs-tabs-bar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      padding: 10px 12px;
      background: var(--bg-hover);
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .gs-tabs-bar .data-tab {
      border: none;
      background: transparent;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      gap: 6px;
    }
    .gs-tabs-bar .data-tab:hover {
      background: var(--bg-card);
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .gs-tabs-bar .data-tab.active {
      background: var(--bg-card);
      color: var(--accent);
      border-color: transparent;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .gs-tab-badge {
      font-size: 10px;
      font-weight: 600;
      background: var(--border);
      color: var(--text-muted);
      padding: 1px 7px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    .gs-tabs-bar .data-tab.active .gs-tab-badge {
      background: rgba(59, 130, 246, 0.12);
      color: var(--accent);
    }

    /* GSheets Pagination */
    .gs-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      font-size: 13px;
      color: var(--text-muted);
    }
    .gs-pagination-info {
      font-size: 12px;
    }
    .gs-pagination-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .gs-pagination-controls button {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .gs-pagination-controls button:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      color: var(--accent);
    }
    .gs-pagination-page {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Responsive utility classes for JS-generated content */
    .gs-vendedores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .gs-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .gs-filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .gs-filter-bar select,
    .gs-filter-bar input {
      min-width: 0;
      flex: 1 1 160px;
      max-width: 260px;
    }
    .gs-zone-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    @media (max-width: 768px) {
      .gs-vendedores-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .gs-summary-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .gs-filter-bar {
        gap: 8px;
      }
      .gs-filter-bar select,
      .gs-filter-bar input {
        flex: 1 1 120px;
        max-width: 100%;
        font-size: 12px;
      }
    }
    @media (max-width: 480px) {
      .gs-vendedores-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .gs-summary-grid {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }
      .gs-filter-bar {
        gap: 6px;
      }
      .gs-filter-bar select,
      .gs-filter-bar input {
        flex: 1 1 100%;
        max-width: 100%;
        font-size: 12px;
        padding: 8px 10px;
      }
    }

    /* Tables */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px 14px;
      text-align: left;
      font-size: 13px;
    }

    th {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
    }

    td {
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    tr:hover td {
      background: var(--bg-hover);
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-a { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .badge-b { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .badge-c { background: rgba(100, 116, 139, 0.15); color: var(--text-muted); }
    .badge-foco { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .badge-active { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
    .badge-sale, .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .badge-pending, .badge-secondary { background: rgba(100, 116, 139, 0.15); color: var(--text-muted); }
    .badge-contacted { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
    .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .badge-primary { background: rgba(59, 130, 246, 0.15); color: var(--accent); }

    /* Price Comparison */
    .price-card {
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .price-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .price-card-title {
      font-weight: 500;
      font-size: 13px;
    }

    .price-value {
      font-size: 18px;
      font-weight: 700;
    }

    .price-value.leker {
      color: var(--success);
    }

    .price-diff {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .price-diff.positive {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }

    .price-diff.negative {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    /* Visit Cards */
    .visit-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .visit-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
    }

    .visit-item:last-child {
      border-bottom: none;
    }

    .visit-number {
      width: 26px;
      height: 26px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      color: white;
    }

    .visit-info {
      flex: 1;
    }

    .visit-client {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .visit-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Executive Panel */
    .executive-item {
      border-bottom: 1px solid var(--border);
    }

    .executive-item:last-child {
      border-bottom: none;
    }

    .executive-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .executive-header:hover {
      background: var(--bg-hover);
    }

    .executive-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .executive-details {
      padding: 0 16px 16px 16px;
      background: var(--bg-primary);
      border-top: 1px solid var(--border);
    }

    .executive-details > div:first-child {
      padding-top: 12px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 32px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* Responsive */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      z-index: 99;
    }

    .sidebar-overlay.active {
      display: block;
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .menu-toggle:hover {
      background: var(--bg-hover);
    }

    .sidebar {
      transition: transform 0.3s ease;
    }

    .responsive-grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-2, .grid-3-1 {
        grid-template-columns: 1fr;
      }
      .dash-grid-row {
        grid-template-columns: 1fr 1fr !important;
      }
      .responsive-grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      }
      .main {
        margin-left: 0 !important;
        max-width: 100vw;
        overflow-x: hidden;
      }
      .menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .sidebar-collapse-btn {
        display: none;
      }
      /* Prevent panels from exceeding viewport */
      .panel, .wizard-layout {
        max-width: 100%;
      }
      .card {
        max-width: 100%;
        min-width: 0;
      }
      .wizard-layout > div {
        min-width: 0;
      }
      /* Map sticky → relative en mobile */
      .wizard-layout .card[style*="sticky"] {
        position: relative !important;
        top: auto !important;
      }
      .sidebar.collapsed {
        width: 240px;
        transform: translateX(-100%);
      }
      .content {
        padding: 20px;
      }
      .topbar {
        padding: 0 16px;
      }
      .page-title {
        font-size: 15px;
      }
      .gs-tabs-bar {
        gap: 4px;
        padding: 8px 10px;
      }
      .gs-tabs-bar .data-tab {
        padding: 6px 10px;
        font-size: 12px;
      }
      .executive-header {
        padding: 10px 14px;
        flex-wrap: wrap;
        gap: 8px;
      }
      .executive-details {
        padding: 0 14px 14px 14px;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .grid-2, .grid-3-1 {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .dash-grid-row {
        grid-template-columns: 1fr !important;
      }
      .content {
        padding: 14px;
      }
      .topbar {
        padding: 0 12px;
        height: 48px;
      }
      .page-title {
        font-size: 14px;
      }
      .modal-content {
        width: 95%;
        max-height: 95vh;
        border-radius: 8px;
      }
      .modal-body {
        padding: 16px;
      }
      .card-header {
        padding: 12px 14px;
        flex-wrap: wrap;
        gap: 8px;
      }
      .card-header h3 {
        font-size: 13px;
      }
      .card-body {
        padding: 12px 14px;
      }
      .responsive-grid-4 {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 8px 10px;
        white-space: nowrap;
      }
      .stat-card {
        padding: 10px;
        gap: 8px;
      }
      .stat-icon {
        width: 32px;
        height: 32px;
      }
      .stat-icon svg, .stat-icon i {
        width: 16px !important;
        height: 16px !important;
      }
      .stat-info h3 {
        font-size: 18px;
      }
      .stat-info p {
        font-size: 11px;
      }
      .map-container {
        height: 350px !important;
        min-height: 300px !important;
      }
      .map-left-panel {
        position: relative !important;
        width: 100% !important;
        max-height: 200px;
        overflow-y: auto;
        top: auto !important;
        left: auto !important;
      }
      .btn {
        font-size: 12px;
        padding: 6px 12px;
      }
      .form-control, .form-select {
        font-size: 13px;
      }
      .route-legend {
        bottom: 10px;
        left: 10px;
        min-width: 180px;
        max-width: 220px;
        padding: 8px 12px;
        font-size: 12px;
      }
      /* Google Sheets responsive */
      .gs-tabs-bar {
        gap: 4px;
        padding: 6px 8px;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .gs-tabs-bar .data-tab {
        padding: 6px 8px;
        font-size: 11px;
        border-radius: 6px;
      }
      .gs-tab-badge {
        font-size: 9px;
        padding: 1px 5px;
      }
      .gs-table {
        font-size: 11px;
      }
      .gs-table thead th {
        padding: 8px 10px;
        font-size: 10px;
      }
      .gs-table tbody td {
        padding: 7px 10px;
        max-width: 180px;
      }
      .gs-table-wrap {
        max-height: 450px;
      }
      .gs-pagination {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
      }
      .gs-pagination-controls button {
        padding: 5px 10px;
        font-size: 11px;
      }
      /* Executive panel responsive */
      .executive-header {
        padding: 10px 12px;
        flex-wrap: wrap;
        gap: 8px;
      }
      .executive-avatar {
        width: 34px;
        height: 34px;
        font-size: 12px;
      }
      .executive-details {
        padding: 0 12px 12px 12px;
      }
      .executive-details > div:first-child {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
      }
      .content {
        padding: 8px;
      }
      .responsive-grid-4 {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }
      .topbar {
        height: 50px;
        padding: 0 10px;
      }
      .topbar-actions {
        gap: 4px;
      }
      .topbar-actions .btn {
        padding: 6px;
      }
      .user-avatar {
        width: 30px;
        height: 30px;
        font-size: 11px;
      }
      .page-title {
        font-size: 13px;
      }
      .modal-content {
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }
      .modal-body {
        padding: 10px;
      }
      .modal-header {
        padding: 12px 14px;
      }
      .modal-header h3 {
        font-size: 14px;
      }
      .map-left-panel {
        width: 100% !important;
        max-height: 160px;
      }
      .map-container {
        height: 280px !important;
      }
      .card {
        border-radius: 8px;
      }
      .card-header {
        padding: 10px 12px;
      }
      .card-header h3 {
        font-size: 12px;
      }
      .card-body {
        padding: 10px 12px;
      }
      table {
        font-size: 11px;
      }
      th, td {
        padding: 6px 8px;
      }
      .stat-card {
        padding: 10px;
        gap: 8px;
      }
      .stat-icon {
        width: 32px;
        height: 32px;
      }
      .stat-icon svg, .stat-icon i {
        width: 16px !important;
        height: 16px !important;
      }
      .stat-value {
        font-size: 18px;
      }
      .stat-info p {
        font-size: 10px;
      }
      .btn {
        font-size: 11px;
        padding: 6px 10px;
      }
      .sidebar-header {
        padding: 16px;
      }
      /* Google Sheets mobile */
      .gs-tabs-bar {
        gap: 3px;
        padding: 5px 6px;
        border-radius: 6px;
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      .gs-tabs-bar .data-tab {
        padding: 5px 7px;
        font-size: 10px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .gs-tab-badge {
        font-size: 8px;
        padding: 0px 4px;
        min-width: 14px;
      }
      .gs-table {
        font-size: 10px;
      }
      .gs-table thead th {
        padding: 6px 8px;
        font-size: 9px;
      }
      .gs-table tbody td {
        padding: 5px 8px;
        max-width: 140px;
      }
      .gs-table-wrap {
        max-height: 380px;
        border-radius: 6px;
      }
      .gs-pagination {
        flex-direction: column;
        gap: 6px;
        padding: 8px 0;
        font-size: 11px;
      }
      .gs-pagination-controls button {
        padding: 4px 8px;
        font-size: 10px;
      }
      .gs-pagination-page {
        font-size: 10px;
        padding: 4px 8px;
      }
      /* Executive panel mobile */
      .executive-header {
        padding: 8px 10px;
        gap: 6px;
      }
      .executive-avatar {
        width: 30px;
        height: 30px;
        font-size: 11px;
      }
      .executive-header > div:first-child > div:last-child > div:first-child {
        font-size: 12px;
      }
      .executive-header > div:last-child {
        flex-wrap: wrap;
        gap: 4px;
      }
      .executive-details {
        padding: 0 10px 10px 10px;
      }
      .executive-details > div:first-child {
        grid-template-columns: 1fr 1fr 1fr;
        gap: 6px;
      }
      /* Form controls mobile */
      .form-control, .form-select {
        font-size: 13px;
        padding: 10px 12px;
      }
    }

    /* =============== PWA MOBILE RESPONSIVE =============== */

    @media (max-width: 768px) {

      /* --- ROUTE TABS: scroll horizontal --- */
      .route-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap;
        gap: 3px;
        padding: 3px;
        margin-bottom: 10px;
        scrollbar-width: none;
      }
      .route-tabs::-webkit-scrollbar { display: none; }
      .route-tab {
        padding: 7px 10px;
        font-size: 11px;
        gap: 4px;
        flex-shrink: 0;
      }
      .route-tab i { width: 12px !important; height: 12px !important; }

      /* --- ROUTE STEPPER: compacto --- */
      .route-stepper { padding: 6px 8px; margin-bottom: 8px; }
      .route-step .step-number { width: 22px; height: 22px; font-size: 10px; }
      .route-step .step-label { font-size: 8px; }
      .step-line { max-width: 24px; margin: 0 2px; margin-bottom: 12px; }

      /* --- WIZARD: stack vertical --- */
      .wizard-layout { grid-template-columns: 1fr !important; }

      /* --- TOPBAR --- */
      .topbar { max-width: 100%; overflow: hidden; }

      /* --- ROUTE STAT CARDS: grid 2 cols, horizontal layout --- */
      .route-dashboard-stats {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 6px !important;
        margin-bottom: 10px;
      }
      .route-stat-card {
        flex-direction: row !important;
        align-items: center !important;
        padding: 8px 10px !important;
        gap: 8px !important;
        border-radius: 8px;
      }
      .route-stat-card:nth-child(5) {
        grid-column: 1 / -1;
      }
      .route-stat-card .stat-icon {
        width: 28px; height: 28px; flex-shrink: 0;
        border-radius: 6px;
      }
      .route-stat-card .stat-icon i { width: 14px !important; height: 14px !important; }
      .route-stat-card .stat-value { font-size: 16px; line-height: 1; }
      .route-stat-card .stat-label { font-size: 8px; line-height: 1.2; letter-spacing: 0.3px; }

      /* --- DASHBOARD STAT CARDS --- */
      .stats-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; }
      .stat-card { padding: 10px; gap: 8px; }
      .stat-card .stat-info h3 { font-size: 16px; }
      .stat-card .stat-info p { font-size: 10px; }

      /* --- DASHBOARD GRID ROWS: stack --- */
      .dash-grid-row {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }

      /* --- CARDS: no min-width, allow internal scroll --- */
      .card[style*="min-width"] { min-width: 0 !important; }
      .card-header { flex-wrap: wrap !important; gap: 6px !important; }

      /* --- RUTAS PROGRAMADAS TABLE → CARDS --- */
      #dashboard-scheduled-table table,
      #dashboard-scheduled-table tbody {
        display: block !important;
        width: 100% !important;
      }
      #dashboard-scheduled-table thead {
        display: none !important;
      }
      #dashboard-scheduled-table .vendor-route-row {
        display: flex !important;
        flex-wrap: wrap;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        gap: 2px 0;
        cursor: pointer;
      }
      #dashboard-scheduled-table .vendor-route-row td {
        border: none !important;
        padding: 1px 0 !important;
        white-space: normal !important;
        background: none !important;
      }
      /* Chevron */
      #dashboard-scheduled-table .vendor-route-row td:nth-child(1) {
        width: 24px; flex-shrink: 0; text-align: center;
      }
      /* Vendor name */
      #dashboard-scheduled-table .vendor-route-row td:nth-child(2) {
        flex: 1; font-size: 13px;
      }
      /* Actions (trash) */
      #dashboard-scheduled-table .vendor-route-row td:nth-child(7) {
        width: auto; flex-shrink: 0; margin-left: auto;
      }
      /* Days: full row below name */
      #dashboard-scheduled-table .vendor-route-row td:nth-child(3) {
        width: 100%; padding-left: 24px !important;
        font-size: 11px; color: var(--text-muted); order: 10;
      }
      /* Clients, KM, Cost: inline row */
      #dashboard-scheduled-table .vendor-route-row td:nth-child(4),
      #dashboard-scheduled-table .vendor-route-row td:nth-child(5),
      #dashboard-scheduled-table .vendor-route-row td:nth-child(6) {
        font-size: 11px; padding-left: 4px !important; order: 11;
      }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(4) {
        padding-left: 24px !important;
      }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(4)::before { content: "🏠 "; }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(5)::before { content: "📍 "; }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(6) {
        margin-left: auto; font-weight: 700; color: #10b981;
      }
      /* Detail row stays block */
      #dashboard-scheduled-table .exec-detail-row td {
        display: block !important;
        padding: 0 !important;
      }

      /* --- MAP: adjust heights + panel position --- */
      .map-container[style*="height: 450px"],
      .map-container[style*="height: 400px"] {
        height: 280px !important;
      }
      .map-left-panel,
      .map-left-panel[style*="position: absolute"] {
        position: relative !important;
        top: auto !important;
        left: auto !important;
        width: 100% !important;
        max-height: 160px;
        overflow-y: auto;
        margin-bottom: 4px;
      }

      /* --- CALENDARIO MENSUAL: scroll horizontal --- */
      #monthly-calendar-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }
      .monthly-calendar-grid { min-width: 560px; }
      .monthly-cal-day { min-height: 65px; padding: 4px; }
      .monthly-cal-day .day-number { font-size: 11px; }
      .exec-badge { font-size: 8px; padding: 1px 4px; }

      /* --- PLANNER SEMANAL: scroll horizontal --- */
      #schedule-result {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }
      #schedule-result > div { overflow-x: auto; }
      .schedule-calendar { grid-template-columns: 1fr !important; gap: 8px; }
      .week-nav .week-label { font-size: 11px !important; min-width: 120px !important; }

      /* --- GOOGLE SHEETS --- */
      #panel-gsheets > div:first-child {
        padding: 14px !important; gap: 10px !important;
        flex-direction: column !important; align-items: stretch !important;
      }
      #panel-gsheets > div:first-child h2 { font-size: 15px !important; }
      #panel-gsheets > div:first-child p { font-size: 12px !important; }
      #panel-gsheets > div:first-child > div:last-child { width: 100%; }
      #panel-gsheets > div:first-child .btn {
        flex: 1; justify-content: center; font-size: 11px; padding: 8px 10px;
      }

      /* --- VENDOR CARD --- */
      #selected-vendor-card > div:nth-child(2) { flex-wrap: wrap; }
      #selected-vendor-card > div:nth-child(2) > div { flex: 1 1 40% !important; min-width: 0; }
      #vendor-card-gps-warning {
        flex-direction: column !important; align-items: stretch !important; gap: 6px !important;
      }

      /* --- GENERIC SCROLL CONTAINERS --- */
      .card-body, .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }

    @media (max-width: 480px) {
      .content { padding: 8px; }
      .route-stat-card .stat-value { font-size: 14px; }
      .route-stat-card .stat-label { font-size: 7px; }
      .map-container { height: 240px !important; min-height: 200px !important; }
      .route-stepper { padding: 5px; }
      .monthly-calendar-grid { min-width: 500px; }
      .monthly-cal-day { min-height: 55px; }
      .card-header {
        flex-direction: column !important; align-items: flex-start !important; gap: 6px !important;
      }
      .card-header > div { width: 100%; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Leaflet custom markers */
    .custom-marker {
      background: none;
      border: none;
    }

    .marker-pin {
      width: 30px;
      height: 30px;
      border-radius: 50% 50% 50% 0;
      position: absolute;
      transform: rotate(-45deg);
      left: 50%;
      top: 50%;
      margin: -15px 0 0 -15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .marker-pin::after {
      content: '';
      width: 14px;
      height: 14px;
      background: white;
      position: absolute;
      border-radius: 50%;
    }

    .marker-pin.segment-a { background: #d97706; }
    .marker-pin.segment-b { background: #3b82f6; }
    .marker-pin.segment-c { background: #059669; }
    .marker-pin.segment-d { background: #f97316; }
    .marker-pin.segment-e { background: #9ca3af; }
    .marker-pin.foco {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5), 0 0 10px rgba(239, 68, 68, 0.3);
      animation: pulse-foco 2s infinite;
    }
    @keyframes pulse-foco {
      0%, 100% { box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5); }
      50% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.3); }
    }

    /* Route legend */
    .route-legend {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 0;
      z-index: 1000;
      min-width: 0;
      max-width: 220px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 11px;
      transition: all 0.2s;
    }
    [data-theme="dark"] .route-legend { background: rgba(30,30,40,0.9); }
    .route-legend.collapsed { max-width: 44px; min-width: 0; overflow: hidden; border-radius: 8px; }
    .route-legend.collapsed #route-info { display: none; }
    .route-legend .legend-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px; cursor: pointer; gap: 6px;
    }
    .route-legend .legend-header:hover { background: rgba(0,0,0,0.04); border-radius: 8px 8px 0 0; }
    .route-legend.collapsed .legend-header { border-radius: 8px; }
    .route-legend .legend-title {
      font-weight: 600;
      font-size: 11px;
      color: var(--text-primary);
      margin: 0;
      white-space: nowrap;
    }
    .route-legend.collapsed .legend-title { display: none; }
    .route-legend #route-info { padding: 0 10px 8px; }
    .route-legend .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .route-legend .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .route-legend .legend-dot.visited { background: var(--success); }
    .route-legend .legend-dot.current { background: var(--accent); }
    .route-legend .legend-dot.pending { background: var(--text-muted); }

    /* Visit markers */
    .visit-marker {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      color: white;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .visit-marker.visited { background: var(--success); }
    .visit-marker.current { background: var(--accent); animation: pulse-current 1.5s infinite; }
    .visit-marker.pending { background: var(--text-muted); }
    .visit-marker.sale { background: var(--success); }
    .visit-marker.no_stock { background: var(--warning); }
    .visit-marker.not_interested { background: var(--danger); }

    @keyframes pulse-current {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    /* Leaflet popup custom styles */
    .leaflet-popup-content-wrapper {
      background: var(--bg-card);
      color: var(--text-primary);
      border-radius: 8px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .leaflet-popup-tip {
      background: var(--bg-card);
    }

    /* Popup content styles */
    .popup-content {
      min-width: 180px;
    }
    .popup-title {
      font-size: 13px;
      color: var(--text-primary);
      display: block;
      margin-bottom: 4px;
    }
    .popup-subtitle {
      color: var(--text-secondary);
      font-size: 12px;
      display: block;
      margin-bottom: 4px;
    }
    .popup-address {
      color: var(--text-muted);
      display: block;
      font-size: 12px;
    }
    .popup-badges {
      margin-top: 8px;
      display: flex;
      gap: 4px;
    }

    /* Card shadows for light mode */
    .card {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    .stat-card {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    /* Sidebar light adjustments */
    .sidebar {
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
    }

    .nav-item.active {
      background: var(--accent);
      color: white;
    }

    /* Form inputs light mode */
    .form-control {
      background: var(--input-bg);
    }

    /* Response box */
    .response-box {
      background: var(--bg-hover);
    }

    /* Price card light */
    .price-card {
      background: #f8fafc;
    }

    /* Segmentation badges */
    .seg-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .seg-badge-8020 {
      background: #292524;
      color: #e7c46c;
      border: 1px solid rgba(231, 196, 108, 0.25);
    }
    .seg-badge-L {
      background: rgba(59, 130, 246, 0.15);
      color: #2563eb;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    .seg-badge-N {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
      border: 1px solid rgba(107, 114, 128, 0.3);
    }

    /* Checklist panel */
    .checklist-panel {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      background: var(--bg-card);
    }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--bg-hover);
      margin-bottom: 8px;
    }
    .checklist-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      cursor: pointer;
      accent-color: var(--success);
    }
    .checklist-item.checked {
      background: rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .checklist-item-label {
      font-weight: 600;
      font-size: 13px;
    }
    .checklist-item-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Route planner calendar V2 */
    .schedule-calendar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .schedule-day {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: var(--bg-card);
      cursor: pointer;
      transition: box-shadow 0.2s, border-color 0.2s;
      min-width: 0;
    }
    .schedule-day:hover { border-color: var(--accent); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
    .schedule-day.day-green { background: linear-gradient(180deg, rgba(16,185,129,0.04) 0%, var(--bg-card) 100%); }
    .schedule-day.day-yellow { background: linear-gradient(180deg, rgba(245,158,11,0.04) 0%, var(--bg-card) 100%); }
    .schedule-day.day-red { background: linear-gradient(180deg, rgba(239,68,68,0.04) 0%, var(--bg-card) 100%); }
    .schedule-day-header {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .schedule-day-stats {
      display: flex; gap: 10px; font-size: 12px; color: var(--text-muted);
      margin-bottom: 8px; padding-bottom: 6px;
    }
    .schedule-day-stats span { display: flex; align-items: center; gap: 3px; }
    .schedule-day-client {
      font-size: 13px;
      padding: 7px 10px;
      border-radius: 6px;
      margin-bottom: 4px;
      background: var(--bg-hover);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .schedule-day-client .time-badge {
      font-size: 11px; font-weight: 600; color: var(--accent);
      min-width: 38px; text-align: right;
    }
    .schedule-day-client.client-8020 { background: rgba(245, 200, 66, 0.08); }

    /* Executive route layout (list + map) */
    .exec-route-layout {
      display: grid; grid-template-columns: 1fr 1fr; min-height: 320px;
    }
    .exec-route-list {
      padding: 16px; overflow-y: auto; max-height: 420px;
      border-right: 1px solid var(--border);
    }
    .exec-route-map { min-height: 320px; }
    @media (max-width: 768px) {
      .exec-route-layout { grid-template-columns: 1fr; }
      .exec-route-list { border-right: none; border-bottom: 1px solid var(--border); max-height: 300px; }
      .exec-route-map { min-height: 250px; }
    }

    /* Planner header + summary */
    .planner-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 14px; flex-wrap: wrap; gap: 8px;
    }
    .planner-avatar {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .planner-exec-name { font-size: 16px; font-weight: 800; line-height: 1.2; }
    .planner-summary-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 0;
      margin-bottom: 16px; border-radius: 12px; overflow: hidden;
      border: 1px solid var(--border);
    }
    .planner-summary-cell {
      padding: 14px 10px; text-align: center; background: var(--bg-hover);
      border-right: 1px solid var(--border);
    }
    .planner-summary-cell:last-child { border-right: none; }
    .planner-summary-val { font-size: 24px; font-weight: 800; }
    .planner-summary-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

    @media (max-width: 768px) {
      .planner-summary-grid { grid-template-columns: repeat(2, 1fr); }
      .planner-summary-cell { border-bottom: 1px solid var(--border); }
      .planner-summary-cell:nth-child(2) { border-right: none; }
      .planner-summary-val { font-size: 16px; }
      .planner-exec-name { font-size: 14px; }
      .planner-avatar { width: 30px; height: 30px; }
      .planner-avatar i { width: 14px !important; height: 14px !important; }
      .schedule-day { padding: 10px; }
      .schedule-day-header { font-size: 12px; }
      .schedule-day-client { font-size: 11px; padding: 5px 6px; }
      .schedule-day-stats { font-size: 10px; flex-wrap: wrap; }
    }

    /* Day detail expanded */
    .day-detail-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); z-index: 9000; display: flex;
      justify-content: center; align-items: center; padding: 20px;
    }
    .day-detail-panel {
      background: var(--bg-card); border-radius: 12px; width: 100%; max-width: 900px;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .day-detail-panel .detail-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .day-detail-panel .detail-body { padding: 16px 24px; }
    .day-detail-stats {
      display: grid; grid-template-columns: repeat(5, 1fr); gap: 0;
      border-bottom: 1px solid var(--border); background: var(--bg-hover);
    }
    .day-detail-stat-cell {
      padding: 10px; text-align: center; border-right: 1px solid var(--border);
    }
    .day-detail-stat-cell:last-child { border-right: none; }
    .day-detail-stat-val { font-size: 18px; font-weight: 800; }
    .day-detail-stat-lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
    .day-detail-body {
      display: grid; grid-template-columns: 1fr 1fr; min-height: 350px;
    }
    .day-detail-clients-col {
      border-right: 1px solid var(--border); overflow-y: auto; max-height: 55vh; padding: 12px 16px;
    }
    .day-detail-map-col { position: relative; }
    @media (max-width: 768px) {
      .day-detail-overlay { padding: 8px; align-items: flex-start; }
      .day-detail-panel { max-height: 95vh; border-radius: 10px; }
      .day-detail-panel .detail-header { padding: 12px 14px; flex-wrap: wrap; gap: 8px; }
      .day-detail-stats { grid-template-columns: repeat(3, 1fr); }
      .day-detail-stat-cell:nth-child(3) { border-right: none; }
      .day-detail-stat-cell:nth-child(n+4) { border-top: 1px solid var(--border); }
      .day-detail-stat-val { font-size: 15px; }
      .day-detail-body { grid-template-columns: 1fr; }
      .day-detail-clients-col { border-right: none; border-bottom: 1px solid var(--border); max-height: 40vh; }
      .day-detail-map-col { min-height: 250px; }
    }
    .day-detail-client {
      display: flex; align-items: flex-start; gap: 12px; padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .day-detail-client:last-child { border-bottom: none; }
    .day-detail-client .client-time {
      min-width: 50px; text-align: center; font-weight: 700; font-size: 13px; color: var(--accent);
    }
    .day-detail-client .client-info { flex: 1; }
    .day-detail-client .client-info .client-name { font-weight: 600; font-size: 13px; }
    .day-detail-client .client-info .client-address { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .day-detail-client .client-actions { display: flex; gap: 6px; }

    /* Alerts badge */
    .alert-badge {
      position: absolute; top: 4px; right: 4px;
      background: #ef4444; color: white; font-size: 10px; font-weight: 700;
      min-width: 18px; height: 18px; border-radius: 9px;
      display: flex; align-items: center; justify-content: center; padding: 0 4px;
    }
    .route-alert-item {
      padding: 12px; border-radius: 8px; background: var(--bg-hover);
      margin-bottom: 8px; font-size: 12px; display: flex; gap: 10px; align-items: flex-start;
    }
    .route-alert-item.unread { background: rgba(59, 130, 246, 0.08); border-left: 3px solid #3b82f6; }
    .route-alert-item .alert-time { font-size: 10px; color: var(--text-muted); white-space: nowrap; }

    /* Week navigator */
    .week-nav { display: flex; align-items: center; gap: 6px; background: var(--bg-hover); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
    .week-nav button {
      background: transparent; border: none; border-radius: 6px;
      padding: 5px 8px; cursor: pointer; display: flex; align-items: center; color: var(--text-primary);
    }
    .week-nav button:hover { background: var(--accent); color: white; }
    .week-nav .week-label { font-size: 13px; font-weight: 700; min-width: 150px; text-align: center; }

    @media (max-width: 900px) {
      .schedule-calendar { grid-template-columns: 1fr; }
    }

    /* Vendor stats cards */
    .vendor-stat-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: var(--bg-card);
    }
    .vendor-stat-card h4 {
      font-size: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Monthly calendar grid */
    .month-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .month-calendar-header {
      text-align: center;
      font-weight: 700;
      font-size: 11px;
      color: var(--text-muted);
      padding: 6px 2px;
    }
    .month-calendar-day {
      text-align: center;
      padding: 8px 4px;
      border-radius: 6px;
      font-size: 11px;
      border: 1px solid transparent;
      min-height: 50px;
    }
    .month-calendar-day.today {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.08);
    }
    .month-calendar-day.has-data {
      background: var(--bg-hover);
    }
    .month-calendar-day .day-num {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .month-calendar-day .day-stats {
      display: flex;
      justify-content: center;
      gap: 4px;
    }
    .month-calendar-day .day-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    /* ========== MONTHLY CALENDAR MULTI-EXEC ========== */
    .monthly-calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .cal-header {
      text-align: center;
      font-weight: 700;
      font-size: 11px;
      color: var(--text-muted);
      padding: 10px 2px 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border);
    }
    .cal-header.weekend {
      color: #94a3b8;
      border-bottom-color: rgba(148,163,184,0.3);
    }
    .monthly-cal-day {
      min-height: 95px;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 7px;
      position: relative;
      background: var(--bg-primary);
      transition: box-shadow 0.15s, border-color 0.15s;
    }
    .monthly-cal-day:hover {
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-color: rgba(59,130,246,0.3);
    }
    .monthly-cal-day.today {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.03);
      box-shadow: 0 0 0 2px rgba(59,130,246,0.15);
    }
    .monthly-cal-day.other-month {
      opacity: 0.3;
      background: var(--bg-hover);
      pointer-events: none;
    }
    .monthly-cal-day.weekend {
      background: repeating-linear-gradient(135deg, var(--bg-hover), var(--bg-hover) 4px, transparent 4px, transparent 8px);
    }
    .monthly-cal-day .day-number {
      font-weight: 700;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 5px;
      display: inline-block;
    }
    .monthly-cal-day.weekend .day-number {
      color: #94a3b8;
    }
    .monthly-cal-day.today .day-number {
      color: white;
      background: var(--accent);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }
    .monthly-cal-day .exec-badges {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .exec-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
    }
    .exec-badge:hover {
      opacity: 0.85;
      transform: scale(1.03);
    }
    .exec-badge .eb-name {
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    .exec-badge .eb-count {
      font-weight: 800;
      flex-shrink: 0;
    }
    .exec-badge .eb-star {
      color: #f59e0b;
      flex-shrink: 0;
      font-size: 9px;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 3px;
      border: 1px solid var(--border);
    }
    .month-nav button {
      background: transparent;
      border: none;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      transition: background 0.15s;
    }
    .month-nav button:hover {
      background: var(--accent);
      color: white;
    }
    .month-label {
      font-size: 14px;
      font-weight: 700;
      min-width: 160px;
      text-align: center;
    }
    .monthly-totals-bar {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      padding: 10px 14px;
      background: var(--bg-hover);
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .monthly-totals-bar .mt-stat {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .monthly-totals-bar .mt-stat strong {
      font-size: 14px;
    }
    .exec-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .exec-legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
    }
    .exec-legend-item .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    /* Monthly day detail overlay */
    .monthly-detail-overlay {
      position: fixed;
      inset: 0;
      z-index: 9000;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.15s;
    }
    .monthly-detail-panel {
      background: var(--bg-primary);
      border-radius: 12px;
      width: 520px;
      max-width: 95vw;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
    }

    /* ========== LOGIN SCREEN ========== */
    .login-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s;
    }
    .login-overlay.hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }
    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .login-logo {
      text-align: center;
      margin-bottom: 28px;
    }
    .login-logo .logo-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .login-logo h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .login-logo h2 span { color: #6366f1; }
    .login-logo p {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .login-field {
      margin-bottom: 16px;
    }
    .login-field label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .login-field input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }
    .login-field input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
    }
    .login-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }
    [data-theme="dark"] .login-error {
      background: rgba(220,38,38,0.1);
      border-color: rgba(220,38,38,0.3);
    }
    .login-btn {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
      font-family: inherit;
    }
    .login-btn:hover { opacity: 0.9; }
    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .login-setup-link {
      text-align: center;
      margin-top: 16px;
      font-size: 12px;
    }
    .login-setup-link a {
      color: #6366f1;
      cursor: pointer;
      text-decoration: underline;
    }

    /* =============== ROUTE PANEL SUBTABS =============== */
    .route-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      padding: 4px;
      background: var(--bg-hover);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .route-tab {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 9px 18px;
      background: transparent;
      border: none;
      border-radius: 9px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      transition: all 0.2s ease;
      font-family: inherit;
      position: relative;
      white-space: nowrap;
    }
    .route-tab:hover {
      color: var(--text-primary);
      background: rgba(255,255,255,0.6);
    }
    .route-tab.active {
      color: var(--text-primary);
      background: var(--bg-card);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
    }
    .route-tab.active i { color: var(--accent); }
    .route-tab.active .badge { background: var(--accent); color: white; }
    .route-tab .badge { font-size: 10px; padding: 1px 6px; }
    .route-subpanel { display: none; }
    .route-subpanel.active { display: block; }

    /* =============== ROUTE WIZARD STEPPER =============== */
    .route-stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      margin-bottom: 12px;
      background: var(--bg-card);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .route-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      position: relative;
      z-index: 1;
    }
    .route-step .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg-hover);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .route-step .step-label {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-muted);
      text-align: center;
      transition: color 0.2s;
    }
    .route-step.active .step-number {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
    }
    .route-step.active .step-label { color: var(--accent); font-weight: 600; }
    .route-step.completed .step-number {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }
    .route-step.completed .step-label { color: #10b981; }
    .step-line {
      flex: 1;
      height: 2px;
      background: var(--border);
      margin: 0 6px;
      margin-bottom: 16px;
      max-width: 60px;
      transition: background 0.2s;
    }
    .step-line.completed { background: #10b981; }
    .step-content { display: none; }
    .step-content.active { display: block; }

    /* =============== WIZARD LAYOUT (content + sticky map) =============== */
    .wizard-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (min-width: 1400px) {
      .wizard-layout { grid-template-columns: 1fr 1.1fr; }
    }
    @media (max-width: 1024px) {
      .wizard-layout { grid-template-columns: 1fr; }
    }

    /* =============== DASHBOARD STAT CARDS =============== */
    .route-dashboard-stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }
    @media (max-width: 900px) {
      .route-dashboard-stats { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 600px) {
      .route-dashboard-stats { grid-template-columns: repeat(2, 1fr); }
    }
    .route-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: box-shadow 0.2s, transform 0.15s;
      cursor: pointer;
      position: relative;
    }
    .route-stat-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
      transform: translateY(-2px);
    }
    .route-stat-card.active-card {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(59,130,246,0.15), 0 4px 12px rgba(0,0,0,0.06);
    }
    .route-stat-card .stat-icon {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-bottom: 2px;
    }
    .route-stat-card .stat-value {
      font-size: 32px;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.5px;
    }
    .route-stat-card .stat-label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 600;
      line-height: 1.3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* =============== DASHBOARD ALERTS =============== */
    .route-alert-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 10px;
      font-size: 14px;
      line-height: 1.5;
      transition: background 0.15s;
    }
    .route-alert-item:hover { background: var(--bg-hover); }
    .route-alert-item.alert-warning { background: rgba(245,158,11,0.04); border-left: 4px solid #f59e0b; }
    .route-alert-item.alert-danger { background: rgba(239,68,68,0.04); border-left: 4px solid #ef4444; }
    .route-alert-item.alert-info { background: rgba(59,130,246,0.04); border-left: 4px solid #3b82f6; }

    /* =============== VENDOR ROW CLICKABLE =============== */
    .vendor-route-row {
      cursor: pointer;
      transition: background 0.1s;
    }
    .vendor-route-row:hover { background: var(--bg-hover); }
    .vendor-route-row .chevron-icon { transition: transform 0.2s; color: var(--text-muted); }
    .vendor-route-row.expanded {
      background: #eef4ff;
      border-left: 4px solid var(--primary-color);
      font-weight: 600;
    }
    [data-theme="dark"] .vendor-route-row.expanded { background: rgba(59, 130, 246, 0.12); }
    .vendor-route-row.expanded td:first-child { padding-left: 4px; }
    .vendor-route-row.expanded .chevron-icon { transform: rotate(90deg); color: var(--primary-color); }
    .exec-detail-row td { padding: 0 !important; border: none !important; }
    .exec-detail-content {
      background: linear-gradient(135deg, #f0f5ff 0%, #f8faff 100%);
      border-left: 4px solid var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
      padding: 16px 24px 20px;
      margin: 0;
      box-shadow: inset 0 6px 12px -6px rgba(59, 130, 246, 0.12), 0 2px 8px rgba(0,0,0,0.04);
    }
    [data-theme="dark"] .exec-detail-content {
      background: linear-gradient(135deg, rgba(59,130,246,0.08) 0%, rgba(59,130,246,0.03) 100%);
    }
    .exec-detail-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 14px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(59, 130, 246, 0.15);
    }
    .exec-detail-header h4 {
      margin: 0; font-size: 15px; color: var(--primary-color);
      display: flex; align-items: center; gap: 6px;
    }
    .exec-day-bar {
      background: white;
      border: 1px solid var(--border-color);
      border-left: 4px solid #10b981;
      padding: 10px 14px;
      margin-bottom: 6px;
      border-radius: 8px;
      cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px;
      user-select: none;
      transition: box-shadow 0.15s, background 0.15s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    [data-theme="dark"] .exec-day-bar { background: var(--bg-card); }
    .exec-day-bar:hover { box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2); background: #f0fdf8; }
    [data-theme="dark"] .exec-day-bar:hover { background: rgba(16,185,129,0.08); }
    .exec-day-bar .day-chevron { transition: transform 0.2s; color: var(--text-muted); }
    .exec-day-bar.expanded {
      background: #ecfdf5; border-color: #10b981;
      box-shadow: 0 2px 6px rgba(16, 185, 129, 0.15);
    }
    [data-theme="dark"] .exec-day-bar.expanded { background: rgba(16,185,129,0.12); }
    .exec-day-bar.expanded .day-chevron { transform: rotate(90deg); color: #10b981; }
    .exec-day-clients {
      padding: 4px 0 10px 22px;
      margin-bottom: 4px;
      border-left: 2px solid rgba(16, 185, 129, 0.25);
      margin-left: 10px;
    }
    .exec-day-client-item {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 12px;
      font-size: 12px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 4px;
      transition: background 0.1s;
    }
    [data-theme="dark"] .exec-day-client-item { background: var(--bg-card); }
    .exec-day-client-item:hover { background: #f8faff; }
    [data-theme="dark"] .exec-day-client-item:hover { background: var(--bg-hover); }
    .exec-day-client-num {
      background: #3b82f6; color: #ffffff;
      min-width: 26px; width: 26px; height: 26px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 800; flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.35);
      line-height: 1;
    }
    .exec-detail-title-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: #dc2626; color: #ffffff;
      padding: 6px 16px; border-radius: 6px;
      font-size: 14px; font-weight: 700;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
      letter-spacing: 0.3px;
    }
    .exec-detail-title-badge i { color: #ffffff; }
    /* Stat card detail popup */
    .dash-stat-detail-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 20px 24px;
      margin-bottom: 18px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      animation: slideDown 0.25s ease;
    }
    @keyframes slideDown { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }
    .dash-stat-detail-panel h4 {
      margin: 0 0 14px; font-size: 16px; font-weight: 700;
      display: flex; align-items: center; gap: 8px; justify-content: space-between;
    }
    .dash-stat-detail-panel h4 span { display: flex; align-items: center; gap: 8px; }
    .dash-stat-detail-subtitle {
      font-size: 13px; color: var(--text-muted); margin-bottom: 14px; line-height: 1.4;
    }
    .dash-stat-detail-list {
      display: flex; flex-wrap: wrap; gap: 10px;
    }
    .dash-stat-detail-chip {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--bg-hover); border: 1px solid var(--border-color);
      border-radius: 10px; padding: 10px 16px; font-size: 14px; font-weight: 500;
      transition: all 0.15s;
    }
    .dash-stat-detail-chip[style*="cursor:pointer"]:hover,
    .dash-stat-detail-chip[onclick]:hover {
      background: rgba(59,130,246,0.08);
      border-color: rgba(59,130,246,0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .dash-stat-detail-chip .chip-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    .dash-stat-detail-empty {
      color: var(--text-muted); font-size: 14px; padding: 8px 0;
    }

    /* =============== AI CHAT WIDGET =============== */
    .ai-chat-fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(99,102,241,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9990;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .ai-chat-fab:hover { transform: scale(1.06); box-shadow: 0 4px 20px rgba(99,102,241,0.4); }
    .ai-chat-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 380px;
      max-width: calc(100vw - 40px);
      height: 480px;
      max-height: calc(100vh - 110px);
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      display: none;
      flex-direction: column;
      z-index: 9991;
      overflow: hidden;
    }
    .ai-chat-panel.open { display: flex; }
    .ai-chat-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      font-size: 13px;
    }
    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .ai-msg {
      max-width: 85%;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.5;
      word-break: break-word;
    }
    .ai-msg.user {
      align-self: flex-end;
      background: var(--accent);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .ai-msg.assistant {
      align-self: flex-start;
      background: var(--bg-hover);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }
    .ai-chat-input {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }
    .ai-chat-input input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--bg-main);
      color: var(--text);
      font-family: inherit;
    }
    .ai-chat-input button {
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    /* Geocoding Progress Panel */
    .geocode-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 360px;
      max-width: calc(100vw - 40px);
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,0.18);
      z-index: 9992;
      overflow: hidden;
      display: none;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    .geocode-panel.open { display: flex; }
    .geocode-panel.minimized { height: auto; }
    .geocode-panel.minimized .geocode-panel-body { display: none; }
    .geocode-panel-header {
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .geocode-panel-header .geocode-header-actions { display: flex; gap: 6px; align-items: center; }
    .geocode-panel-header button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    .geocode-panel-header button:hover { background: rgba(255,255,255,0.35); }
    .geocode-panel-body {
      max-height: 320px;
      overflow-y: auto;
      font-size: 12px;
    }
    .geocode-progress-bar {
      height: 4px;
      background: rgba(255,255,255,0.2);
      position: relative;
    }
    .geocode-progress-bar .fill {
      height: 100%;
      background: #34d399;
      transition: width 0.3s ease;
      border-radius: 0 2px 2px 0;
    }
    .geocode-log-entry {
      padding: 4px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    .geocode-log-entry.success { color: #059669; }
    .geocode-log-entry.error { color: #dc2626; }
    .geocode-log-entry.info { color: #6b7280; }
    .geocode-panel-stats {
      padding: 8px 14px;
      display: flex;
      justify-content: space-between;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 600;
    }
    /* ====== MOBILE OVERRIDES (must be last to win cascade) ====== */
    @media (max-width: 768px) {

      /* --- ROUTE TABS: grilla 2x2 en mobile --- */
      .route-tabs {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 4px !important;
        padding: 4px !important;
        overflow: visible !important;
      }
      .route-tab {
        padding: 9px 8px !important;
        font-size: 12px !important;
        gap: 5px !important;
        justify-content: center;
        white-space: nowrap;
      }
      .route-tab i { width: 14px !important; height: 14px !important; }

      /* --- ROUTE STAT CARDS: 2-col grid, horizontal, MÁS GRANDES --- */
      .route-dashboard-stats {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }
      .route-stat-card {
        flex-direction: row !important;
        align-items: center !important;
        padding: 12px 14px !important;
        gap: 10px !important;
        border-radius: 10px;
      }
      .route-stat-card:nth-child(5) { grid-column: 1 / -1; }
      .route-stat-card .stat-value { font-size: 20px !important; line-height: 1.1; }
      .route-stat-card .stat-label { font-size: 10px !important; line-height: 1.2; }
      .route-stat-card .stat-icon { width: 34px !important; height: 34px !important; flex-shrink: 0; border-radius: 8px; }
      .route-stat-card .stat-icon i { width: 16px !important; height: 16px !important; }

      /* --- DASHBOARD MAIN STAT CARDS --- */
      .stats-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }
      #exec-stats-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }
      #exec-stats-grid .stat-card:nth-child(5) { grid-column: span 2; }
      #exec-clients-segmentation { grid-template-columns: repeat(3, 1fr) !important; gap: 8px !important; }
      #exec-ventas-summary { grid-template-columns: repeat(3, 1fr) !important; }

      /* --- DASHBOARD GRIDS → 1 col --- */
      .dash-grid-row { grid-template-columns: 1fr !important; gap: 12px !important; }
      .card[style*="min-width"] { min-width: 0 !important; }

      /* --- RUTAS PROGRAMADAS TABLE → CARDS --- */
      #dashboard-scheduled-table table,
      #dashboard-scheduled-table tbody { display: block !important; width: 100% !important; }
      #dashboard-scheduled-table thead { display: none !important; }
      #dashboard-scheduled-table .vendor-route-row {
        display: flex !important; flex-wrap: wrap; align-items: center;
        padding: 12px 14px; border-bottom: 1px solid var(--border); gap: 2px 0;
      }
      #dashboard-scheduled-table .vendor-route-row td {
        border: none !important; padding: 2px 0 !important; white-space: normal !important;
      }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(1) { width: 24px; flex-shrink: 0; }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(2) { flex: 1; font-size: 14px; }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(7) { flex-shrink: 0; margin-left: auto; }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(3) {
        width: 100%; padding-left: 24px !important; font-size: 12px; color: var(--text-muted); order: 10;
      }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(4) { padding-left: 24px !important; font-size: 12px; order: 11; }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(5) { padding-left: 8px !important; font-size: 12px; order: 12; }
      #dashboard-scheduled-table .vendor-route-row td:nth-child(6) { margin-left: auto; font-weight: 700; font-size: 14px; color: #10b981; order: 13; }
      #dashboard-scheduled-table .exec-detail-row td { display: block !important; padding: 0 !important; }

      /* --- PLANNER SEMANAL: tabla scrolleable --- */
      #schedule-result {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }
      #schedule-result > div { overflow-x: auto !important; }
      #schedule-result table { min-width: 600px !important; }
      .schedule-calendar { grid-template-columns: 1fr !important; }

      /* --- CALENDARIO MENSUAL: scroll horizontal --- */
      #monthly-calendar-container {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }
      .monthly-calendar-grid { min-width: 560px !important; }
    }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div class="login-overlay" id="login-overlay">
    <div class="login-card">
      <div class="login-logo">
        <img src="/leker-logo.png" alt="LEKER" style="max-width: 220px; height: auto; margin-bottom: 8px;">
        <p>Sistema de Gestión Logística</p>
        <div style="font-size: 11px; color: #818cf8; margin-top: 6px; letter-spacing: 1.5px; font-weight: 600; background: rgba(99,102,241,0.1); padding: 2px 10px; border-radius: 12px; display: inline-block;">v1.9.9</div>
      </div>

      <!-- Login Form -->
      <form id="login-form-container" onsubmit="event.preventDefault(); doLogin();" autocomplete="on">
        <div class="login-error" id="login-error"></div>
        <div class="login-field">
          <label>Email</label>
          <input type="email" id="login-email" name="email" placeholder="tu@email.com" autocomplete="username">
        </div>
        <div class="login-field">
          <label>Contraseña</label>
          <div style="position:relative;">
            <input type="password" id="login-password" name="password" placeholder="Ingresa tu contraseña" autocomplete="current-password" style="padding-right:40px;">
            <button type="button" onclick="togglePasswordVisibility('login-password', this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;">
              <i data-lucide="eye" style="width:18px;height:18px;"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="login-btn" id="login-btn">Iniciar Sesión</button>
        <div class="login-setup-link" id="login-setup-link" style="display:none;">
          <a onclick="showSetupForm()">Primera vez? Configurar administrador</a>
        </div>

        <!-- Install PWA button - hidden by default, shown only if not installed -->
        <button type="button" id="install-btn-login" onclick="installPWA()" style="display:none; width:100%; margin-top:14px; padding:10px 18px; background:rgba(99,102,241,0.08); color:#818cf8; border:1px solid rgba(99,102,241,0.2); border-radius:8px; cursor:pointer; font-size:12px; font-weight:500; transition:all 0.2s; gap:6px; align-items:center; justify-content:center; letter-spacing:0.2px;"
          onmouseenter="this.style.background='rgba(99,102,241,0.14)';this.style.borderColor='rgba(99,102,241,0.35)'"
          onmouseleave="this.style.background='rgba(99,102,241,0.08)';this.style.borderColor='rgba(99,102,241,0.2)'">
          <i data-lucide="monitor-smartphone" style="width:14px;height:14px;opacity:0.7;"></i>
          <span>Instalar como aplicaci&oacute;n</span>
        </button>
      </form>

      <!-- Setup Form (first time) -->
      <div id="setup-form-container" style="display:none;">
        <div style="text-align:center;margin-bottom:16px;">
          <span style="background:#fef3c7;color:#92400e;padding:4px 12px;border-radius:6px;font-size:12px;font-weight:500;">Configuración Inicial</span>
        </div>
        <div class="login-error" id="setup-error"></div>
        <div class="login-field">
          <label>Email del Administrador</label>
          <input type="email" id="setup-email" placeholder="admin@leker.cl" autocomplete="email">
        </div>
        <div class="login-field">
          <label>Nueva Contraseña</label>
          <div style="position:relative;">
            <input type="password" id="setup-password" placeholder="Mínimo 4 caracteres" style="padding-right:40px;">
            <button type="button" onclick="togglePasswordVisibility('setup-password', this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;">
              <i data-lucide="eye" style="width:18px;height:18px;"></i>
            </button>
          </div>
        </div>
        <div class="login-field">
          <label>Confirmar Contraseña</label>
          <div style="position:relative;">
            <input type="password" id="setup-password-confirm" placeholder="Repite la contraseña" style="padding-right:40px;">
            <button type="button" onclick="togglePasswordVisibility('setup-password-confirm', this)" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;">
              <i data-lucide="eye" style="width:18px;height:18px;"></i>
            </button>
          </div>
        </div>
        <button class="login-btn" id="setup-btn" onclick="doSetup()">Configurar y Entrar</button>
        <div class="login-setup-link">
          <a onclick="showLoginForm()">Volver al login</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div style="cursor: pointer;" onclick="expandSidebar()">
        <div class="logo">
          <img src="/leker-logo.png" alt="LEKER" class="logo-img" style="max-width: 130px; height: auto;">
          <img src="/leker-isotipo.png" alt="LEKER" class="logo-isotipo" style="width: 34px; height: auto; display: none;">
        </div>
        <div class="sidebar-version" style="font-size: 11px; color: #818cf8; margin-top: 4px; letter-spacing: 1.5px; font-weight: 600; background: rgba(99,102,241,0.1); padding: 2px 10px; border-radius: 12px; display: inline-block;">v1.9.9</div>
        <div class="logo-expand-arrow" onclick="event.stopPropagation(); expandSidebar();" title="Expandir menú" style="display:none; margin-top: 6px; color: var(--text-muted); transition: color 0.2s;">
          <i data-lucide="chevrons-right" style="width: 18px; height: 18px;"></i>
        </div>
      </div>
      <button class="sidebar-collapse-btn" onclick="toggleCollapseSidebar()" title="Contraer menú (Ctrl+B)">
        <i data-lucide="panel-left-close" style="width: 16px; height: 16px;"></i>
      </button>
    </div>

    <div class="sidebar-search">
      <div class="sidebar-search-wrap">
        <i data-lucide="search" class="sidebar-search-icon"></i>
        <input type="text" class="sidebar-search-input" id="sidebar-search" placeholder="Buscar... (Ctrl+K)" oninput="filterSidebar(this.value)">
      </div>
    </div>

    <nav class="nav">
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <div class="nav-item active" data-tab="dashboard" data-tooltip="Dashboard">
          <i data-lucide="layout-dashboard"></i>
          <span>Dashboard</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Datos Comerciales</div>
        <div class="nav-item-expandable">
          <div class="nav-item nav-item-parent" data-tooltip="Datos Comerciales" onclick="toggleSubmenu(this)">
            <i data-lucide="sheet"></i>
            <span>Google Sheets</span>
            <i data-lucide="chevron-down" class="submenu-arrow"></i>
          </div>
          <div class="nav-submenu">
            <div class="nav-subitem" data-tab="gsheets" data-subtab="gs-ventas">
              <i data-lucide="trending-up" style="width: 16px; height: 16px;"></i>
              <span>Ventas por Mes</span>
            </div>
            <div class="nav-subitem" data-tab="gsheets" data-subtab="gs-cobranzas">
              <i data-lucide="credit-card" style="width: 16px; height: 16px;"></i>
              <span>Cobranzas</span>
            </div>
            <div class="nav-subitem" data-tab="gsheets" data-subtab="gs-vendedores">
              <i data-lucide="users" style="width: 16px; height: 16px;"></i>
              <span>Vendedores / Zonales</span>
            </div>
            <div class="nav-subitem" data-tab="gsheets" data-subtab="gs-8020">
              <i data-lucide="pie-chart" style="width: 16px; height: 16px;"></i>
              <span>Análisis 80-20</span>
            </div>
            <div class="nav-subitem" data-tab="gsheets" data-subtab="gs-rendimiento">
              <i data-lucide="bar-chart-3" style="width: 16px; height: 16px;"></i>
              <span>Rendimiento Visitas</span>
            </div>
            <div class="nav-subitem" data-tab="gsheets" data-subtab="gs-direcciones">
              <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
              <span>Direcciones</span>
            </div>
            <div class="nav-subitem" data-tab="gsheets" data-subtab="gs-reasignacion">
              <i data-lucide="repeat" style="width: 16px; height: 16px;"></i>
              <span>Reasignación</span>
            </div>
          </div>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Logística</div>
        <div class="nav-item" data-tab="routes" data-tooltip="Rutas y Mapa" style="position: relative;">
          <i data-lucide="map-pin"></i>
          <span>Rutas y Mapa</span>
          <span id="nav-route-alerts-badge" class="alert-badge" style="display: none;">0</span>
        </div>
        <div class="nav-item" data-tab="visits" data-tooltip="Visitas">
          <i data-lucide="clipboard-check"></i>
          <span>Visitas</span>
        </div>
        <div class="nav-item" data-tab="crm" data-tooltip="Logística CRM">
          <i data-lucide="contact-2"></i>
          <span>Logística CRM</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Inteligencia</div>
        <div class="nav-item" data-tab="intelligence" data-tooltip="Precios Mercado">
          <i data-lucide="trending-up"></i>
          <span>Precios Mercado</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Marketing</div>
        <div class="nav-item-expandable">
          <div class="nav-item nav-item-parent" data-tooltip="Marketing" onclick="toggleSubmenu(this)">
            <i data-lucide="megaphone"></i>
            <span>Herramientas</span>
            <i data-lucide="chevron-down" class="submenu-arrow"></i>
          </div>
          <div class="nav-submenu">
            <div class="nav-subitem" data-tab="marketing" data-subtab="google-analytics">
              <i data-lucide="bar-chart-2" style="width: 16px; height: 16px;"></i>
              <span>Google Analytics</span>
            </div>
            <div class="nav-subitem" data-tab="marketing" data-subtab="google-ads">
              <i data-lucide="target" style="width: 16px; height: 16px;"></i>
              <span>Google Ads</span>
            </div>
            <div class="nav-subitem" data-tab="marketing" data-subtab="meta-ads">
              <i data-lucide="facebook" style="width: 16px; height: 16px;"></i>
              <span>Meta Ads</span>
            </div>
          </div>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Base de Datos</div>
        <div class="nav-item-expandable">
          <div class="nav-item nav-item-parent" data-tooltip="Base de Datos" onclick="toggleSubmenu(this)">
            <i data-lucide="database"></i>
            <span>Base de Datos</span>
            <i data-lucide="chevron-down" class="submenu-arrow"></i>
          </div>
          <div class="nav-submenu">
            <div class="nav-subitem" data-tab="data" data-subtab="vendedores">
              <i data-lucide="users" style="width: 16px; height: 16px;"></i>
              <span>Vendedores</span>
            </div>
            <div class="nav-subitem" data-tab="data" data-subtab="vehiculos">
              <i data-lucide="truck" style="width: 16px; height: 16px;"></i>
              <span>Vehículos</span>
            </div>
            <div class="nav-subitem" data-tab="data" data-subtab="clientes">
              <i data-lucide="building-2" style="width: 16px; height: 16px;"></i>
              <span>Clientes</span>
            </div>
            <div class="nav-subitem" data-tab="data" data-subtab="productos">
              <i data-lucide="package" style="width: 16px; height: 16px;"></i>
              <span>Productos</span>
            </div>
            <div class="nav-subitem" data-tab="data" data-subtab="importar">
              <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
              <span>Importar Excel</span>
            </div>
          </div>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Administración</div>
        <div class="nav-item" data-tab="users" data-tooltip="Usuarios y Roles">
          <i data-lucide="shield-check"></i>
          <span>Usuarios y Roles</span>
        </div>
      </div>
    </nav>

    <!-- Install PWA button in sidebar - hidden by default, shown only if not installed -->
    <div id="install-btn-sidebar" style="padding: 0 16px 8px 16px; display: none;">
      <button onclick="installPWA()" style="width:100%; padding:8px 12px; background:rgba(99,102,241,0.06); color:#a5b4fc; border:1px solid rgba(129,140,248,0.12); border-radius:8px; cursor:pointer; font-size:11px; font-weight:500; display:flex; align-items:center; justify-content:center; gap:6px; transition:all 0.2s;"
        onmouseenter="this.style.background='rgba(99,102,241,0.12)';this.style.borderColor='rgba(129,140,248,0.25)'"
        onmouseleave="this.style.background='rgba(99,102,241,0.06)';this.style.borderColor='rgba(129,140,248,0.12)'">
        <i data-lucide="monitor-smartphone" style="width:13px;height:13px;opacity:0.6;"></i>
        <span class="install-btn-text">Instalar app</span>
      </button>
    </div>

    <div class="sidebar-footer">
      <div style="padding: 12px; background: var(--bg-hover); border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div id="sidebar-admin-avatar" style="width: 36px; height: 36px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);">
            <i data-lucide="crown" style="width: 18px; height: 18px;"></i>
          </div>
          <div style="flex: 1; min-width: 0;">
            <div id="sidebar-admin-name" style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Administrador</div>
            <div id="sidebar-admin-role" style="font-size: 10px; color: #a78bfa; display: flex; align-items: center; gap: 4px;">
              <i data-lucide="shield-check" style="width: 10px; height: 10px;"></i>
              <span>Control Maestro</span>
            </div>
          </div>
          <button onclick="doLogout()" title="Cerrar Sesión" style="background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;">
            <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
      </div>
    </div>
  </aside>

  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Main Content -->
  <main class="main">
    <header class="topbar">
      <div style="display: flex; align-items: center; gap: 12px;">
        <button class="menu-toggle" onclick="toggleSidebar()" title="Menu">
          <i data-lucide="menu" style="width: 22px; height: 22px;"></i>
        </button>
        <h1 class="page-title" id="page-title">Dashboard</h1>
      </div>
      <div class="topbar-actions">
        <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
          <i data-lucide="sun" class="icon-sun"></i>
          <i data-lucide="moon" class="icon-moon"></i>
        </button>
        <div class="user-avatar" title="Administrador">
          <i data-lucide="crown" style="width: 18px; height: 18px;"></i>
        </div>
      </div>
    </header>

    <div class="content">
      <!-- Dashboard Panel -->
      <div class="panel active" id="panel-dashboard">
        <!-- Barra de carga -->
        <div id="dash-loading-bar" style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;">
            <div id="dash-loading-spinner" style="width: 20px; height: 20px; border: 2.5px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0;"></div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <span id="dash-loading-label" style="font-size: 12px; font-weight: 600; color: var(--text-primary);">Cargando datos...</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span id="dash-loading-pct" style="font-size: 12px; font-weight: 700; color: var(--accent);">0%</span>
                  <button id="btn-skip-sheets" onclick="skipSheetsLoad()" style="display:none; font-size:10px; padding:2px 8px; background:#f59e0b; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:600; white-space:nowrap;">Saltar</button>
                </div>
              </div>
              <div style="height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                <div id="dash-loading-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #8b5cf6); border-radius: 3px; transition: width 0.4s ease;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ========== DASHBOARD EJECUTIVO (solo visible para role=executive) ========== -->
        <div id="exec-dashboard" style="display: none;">
          <!-- Fila 1: 5 stat cards personales -->
          <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 20px;" id="exec-stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue"><i data-lucide="building-2"></i></div>
              <div class="stat-info">
                <h3 id="exec-stat-clients">0</h3>
                <p>Mis Clientes</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon purple"><i data-lucide="route"></i></div>
              <div class="stat-info">
                <h3 id="exec-stat-route" style="font-size: 18px;">Sin ruta</h3>
                <p>Ruta Hoy</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon green"><i data-lucide="map-pin-check"></i></div>
              <div class="stat-info">
                <h3 id="exec-stat-visits">0</h3>
                <p>Visitas Hoy</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon yellow"><i data-lucide="trending-up"></i></div>
              <div class="stat-info">
                <h3 id="exec-stat-ventas" style="font-size: 16px;">-</h3>
                <p>Ventas Mes</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon orange"><i data-lucide="alert-circle"></i></div>
              <div class="stat-info">
                <h3 id="exec-stat-cobranzas">-</h3>
                <p>Cobranzas Pend.</p>
              </div>
            </div>
          </div>

          <!-- Fila 2: Mi Ruta de Hoy (lista + mapa) -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3><i data-lucide="navigation" style="width: 18px; height: 18px;"></i> Mi Ruta de Hoy</h3>
              <div id="exec-route-actions"></div>
            </div>
            <div class="card-body" style="padding: 0;">
              <div class="exec-route-layout">
                <div id="exec-route-today" class="exec-route-list">
                  <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px;">Cargando ruta...</div>
                </div>
                <div id="exec-route-map" class="exec-route-map">
                  <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 12px;">
                    <i data-lucide="map" style="width: 24px; height: 24px; opacity: 0.3;"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Fila 3: Mis Ventas del Mes -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="display: flex; align-items: center; gap: 8px;">
                <i data-lucide="trending-up" style="width: 18px; height: 18px;"></i> Mis Ventas del Mes
                <span id="exec-ventas-month-label" style="font-size: 11px; font-weight: 500; color: var(--text-muted);"></span>
              </h3>
              <span id="exec-ventas-total" style="font-size: 14px; font-weight: 700; color: #10b981;"></span>
            </div>
            <div class="card-body" style="padding: 0;">
              <div id="exec-ventas-summary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; border-bottom: 1px solid var(--border);"></div>
              <div id="exec-ventas-list" style="padding: 16px;">
                <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Cargando ventas...</div>
              </div>
            </div>
          </div>

          <!-- Fila 4: Mis Clientes -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3><i data-lucide="users" style="width: 18px; height: 18px;"></i> Mis Clientes</h3>
              <span id="exec-clients-count" style="font-size: 12px; color: var(--text-muted);"></span>
            </div>
            <div class="card-body" style="padding: 0;">
              <div id="exec-clients-segmentation" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 16px; border-bottom: 1px solid var(--border);"></div>
              <div style="padding: 10px 16px; border-bottom: 1px solid var(--border);">
                <input type="search" id="exec-clients-search" class="form-control" placeholder="Buscar cliente..." oninput="filterExecClients()" style="font-size: 13px;">
              </div>
              <div style="overflow-x: auto;">
                <table class="data-table" id="exec-clients-table">
                  <thead>
                    <tr>
                      <th>Cliente</th>
                      <th>Comuna</th>
                      <th>Segmento</th>
                      <th style="width: 36px;"></th>
                    </tr>
                  </thead>
                  <tbody id="exec-clients-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Fila 4: Mis Cobranzas -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="display: flex; align-items: center; gap: 8px;">
                <i data-lucide="clock" style="width: 18px; height: 18px;"></i> Mis Cobranzas
                <span id="exec-cobranzas-badge" style="font-size: 11px; font-weight: 700; background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; display: none;">0</span>
              </h3>
            </div>
            <div class="card-body" style="padding: 0;">
              <div id="exec-cobranzas-list" style="padding: 16px;">
                <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Cargando cobranzas...</div>
              </div>
            </div>
          </div>
        </div>
        <!-- ========== FIN DASHBOARD EJECUTIVO ========== -->

        <!-- Fila 1: 4 Stats principales (admin/supervisor) -->
        <div class="stats-grid">
          <div class="stat-card" style="cursor: pointer;" onclick="document.querySelector('[data-tab=data][data-subtab=vendedores]').click()">
            <div class="stat-icon blue">
              <i data-lucide="users"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-users">0</h3>
              <p>Vendedores Activos</p>
            </div>
          </div>
          <div class="stat-card" style="cursor: pointer;" onclick="document.querySelector('[data-tab=data][data-subtab=clientes]').click()">
            <div class="stat-icon green">
              <i data-lucide="building-2"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-clients">0</h3>
              <p>Clientes Totales</p>
              <span id="stat-clients-sub" style="font-size:11px;font-weight:600;color:#b8860b;background:rgba(212,175,55,0.12);padding:1px 7px;border-radius:8px;margin-top:2px;display:inline-block;">⭐ <span id="stat-clients-8020">-</span> 80/20</span>
            </div>
          </div>
          <div class="stat-card" style="cursor: pointer;" onclick="document.querySelector('[data-tab=routes]').click()">
            <div class="stat-icon purple">
              <i data-lucide="route"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-routes">0</h3>
              <p>Rutas Hoy</p>
            </div>
          </div>
          <div class="stat-card" style="cursor: pointer;" onclick="document.querySelector('[data-tab=routes]').click()">
            <div class="stat-icon orange">
              <i data-lucide="map-pin-check"></i>
            </div>
            <div class="stat-info">
              <h3 id="stat-visits-today">0</h3>
              <p>Visitas Hoy</p>
            </div>
          </div>
        </div>

        <!-- Fila 2: Segmentación de Clientes + Clientes por Región -->
        <div class="dash-grid-row dash-row-seg">
          <!-- Segmentación de Clientes -->
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3><i data-lucide="pie-chart" style="width: 18px; height: 18px;"></i> Segmentación de Clientes</h3>
              <button onclick="syncSegmentation()" id="btn-sync-seg" style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 6px 16px; border: 1px solid #10b981; background: rgba(16, 185, 129, 0.08); color: #10b981; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#10b981';this.style.color='white'" onmouseout="this.style.background='rgba(16,185,129,0.08)';this.style.color='#10b981'">
                <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Sincronizar
              </button>
            </div>
            <div class="card-body">
              <!-- Segmentos A-E -->
              <div id="segmentation-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div style="text-align: center; padding: 14px 8px; background: rgba(217,119,6,0.08); border-radius: 10px; border: 1px solid rgba(217,119,6,0.3); cursor: pointer;" onclick="goToClientsBySegment('A')">
                  <div style="font-size: 26px; font-weight: 700; color: #d97706;" id="seg-A-count">-</div>
                  <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">A · Prioritario</div>
                </div>
                <div style="text-align: center; padding: 14px 8px; background: rgba(59,130,246,0.08); border-radius: 10px; border: 1px solid rgba(59,130,246,0.2); cursor: pointer;" onclick="goToClientsBySegment('B')">
                  <div style="font-size: 26px; font-weight: 700; color: #3b82f6;" id="seg-B-count">-</div>
                  <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">B · Con dirección</div>
                </div>
                <div style="text-align: center; padding: 14px 8px; background: rgba(5,150,105,0.08); border-radius: 10px; border: 1px solid rgba(5,150,105,0.2); cursor: pointer;" onclick="goToClientsBySegment('C')">
                  <div style="font-size: 26px; font-weight: 700; color: #059669;" id="seg-C-count">-</div>
                  <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">C · Con vendedor</div>
                </div>
                <div style="text-align: center; padding: 14px 8px; background: rgba(249,115,22,0.08); border-radius: 10px; border: 1px solid rgba(249,115,22,0.2); cursor: pointer;" onclick="goToClientsBySegment('D')">
                  <div style="font-size: 26px; font-weight: 700; color: #f97316;" id="seg-D-count">-</div>
                  <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">D · Potencial</div>
                </div>
                <div style="text-align: center; padding: 14px 8px; background: rgba(156,163,175,0.08); border-radius: 10px; border: 1px solid rgba(156,163,175,0.2); cursor: pointer;" onclick="goToClientsBySegment('E')">
                  <div style="font-size: 26px; font-weight: 700; color: #9ca3af;" id="seg-E-count">-</div>
                  <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">E · Sin dirección</div>
                </div>
                <div style="text-align: center; padding: 14px 8px; background: var(--bg-hover); border-radius: 10px; border: 1px solid var(--border); cursor: pointer;" onclick="goToClientsBySegmentation('')">
                  <div style="font-size: 26px; font-weight: 700; color: var(--text-primary);" id="seg-total-count">-</div>
                  <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">Total</div>
                </div>
              </div>
              <!-- Sub-segmentación comercial (80-20, L, N) -->
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                <div style="text-align: center; padding: 10px 6px; background: rgba(212,175,55,0.08); border: 1px solid rgba(212,175,55,0.25); border-radius: 8px; cursor: pointer;" onclick="goToClientsBySegmentation('80-20')">
                  <div style="font-size: 20px; font-weight: 700; color: #b8860b;" id="seg-8020-count">-</div>
                  <div style="font-size: 10px; color: var(--text-muted); font-weight: 600;">80/20</div>
                  <div style="font-size: 9px; color: var(--text-muted);">Clave</div>
                </div>
                <div style="text-align: center; padding: 10px 6px; background: rgba(37,99,235,0.08); border: 1px solid rgba(37,99,235,0.2); border-radius: 8px; cursor: pointer;" onclick="goToClientsBySegmentation('L')">
                  <div style="font-size: 20px; font-weight: 700; color: #2563eb;" id="seg-L-count">-</div>
                  <div style="font-size: 10px; color: var(--text-muted); font-weight: 600;">L</div>
                  <div style="font-size: 9px; color: var(--text-muted);">Con ventas</div>
                </div>
                <div style="text-align: center; padding: 10px 6px; background: var(--bg-hover); border-radius: 8px; cursor: pointer;" onclick="goToClientsBySegmentation('N')">
                  <div style="font-size: 20px; font-weight: 700; color: #6b7280;" id="seg-N-count">-</div>
                  <div style="font-size: 10px; color: var(--text-muted); font-weight: 600;">N</div>
                  <div style="font-size: 9px; color: var(--text-muted);">Nuevos</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Clientes por Región -->
          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i> Clientes por Región</h3>
            </div>
            <div class="card-body">
              <div id="regions-chart" style="max-height: 400px; overflow-y: auto; padding-right: 18px;"></div>
            </div>
          </div>
        </div>

        <!-- Fila 3: Mapa de Clientes - Ancho completo -->
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <h3><i data-lucide="map" style="width: 18px; height: 18px;"></i> Mapa de Clientes</h3>
            <div id="geocode-alert" style="display: none; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 8px 16px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 8px rgba(29,78,216,0.3);">
              <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
              <span><strong id="geocode-count">0</strong> clientes sin ubicación</span>
              <button id="btn-geocode-header" onclick="geocodeClientsWithoutCoords()" style="background: white; color: #1d4ed8; border: none; padding: 6px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.15); display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                <i data-lucide="map-pin" style="width:13px;height:13px;color:#1d4ed8;"></i> Cargar Ubicaciones
              </button>
            </div>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="map-container" id="main-map-container" style="height: 450px; transition: height 0.3s ease;">
              <div id="map"></div>
              <!-- Map control buttons -->
              <div style="position: absolute; top: 10px; right: 10px; z-index: 11; display: flex; gap: 6px;">
                <button onclick="toggleMapSize()" id="btn-toggle-map" class="map-btn" title="Expandir / Contraer mapa">
                  <i data-lucide="maximize-2" style="width: 14px; height: 14px;" id="icon-toggle-map"></i>
                  <span id="lbl-toggle-map">Expandir</span>
                </button>
                <button onclick="toggleMapFullscreen()" id="btn-fullscreen-map" class="map-btn" title="Pantalla completa">
                  <i data-lucide="fullscreen" style="width: 14px; height: 14px;" id="icon-fullscreen-map"></i>
                  <span>Pantalla completa</span>
                </button>
              </div>
              <!-- Left Panel: Search + Filters -->
              <div class="map-left-panel" style="position: absolute; top: 10px; left: 10px; z-index: 10; width: 220px;">
                <!-- Search -->
                <div style="background: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); margin-bottom: 8px;">
                  <div style="padding: 8px;">
                    <input type="text" id="map-client-search" class="form-control" placeholder="Buscar por código o nombre..." oninput="searchClientOnMap()" style="font-size: 12px; padding: 8px 12px;">
                  </div>
                  <div id="map-search-results" style="max-height: 180px; overflow-y: auto; display: none; border-top: 1px solid var(--border);">
                  </div>
                </div>
                <!-- Segment Filters -->
                <div style="background: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 10px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 11px; text-transform: uppercase; color: var(--text-muted);">Segmentación</span>
                    <button onclick="filterMapBySegment('ALL')" style="font-size: 9px; padding: 2px 7px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Ver todos</button>
                  </div>
                  <div class="legend-item legend-filter active" onclick="filterMapBySegment('80-20')" data-segment="80-20" style="cursor: pointer; padding: 5px 8px; border-radius: 6px; margin: 2px 0; display: flex; align-items: center; gap: 0;">
                    <div class="legend-dot seg-8020"></div>
                    <span style="flex: 1; font-size: 11px; font-weight: 600;">80/20 — Clave</span>
                    <span id="count-seg-8020" style="font-size: 10px; background: rgba(245,158,11,0.2); padding: 2px 6px; border-radius: 10px; font-weight: 600; margin-right: 4px;">0</span>
                    <i data-lucide="eye" class="toggle-eye" style="width:12px;height:12px;flex-shrink:0;"></i>
                  </div>
                  <div class="legend-item legend-filter active" onclick="filterMapBySegment('L')" data-segment="L" style="cursor: pointer; padding: 5px 8px; border-radius: 6px; margin: 2px 0; display: flex; align-items: center;">
                    <div class="legend-dot seg-l"></div>
                    <span style="flex: 1; font-size: 11px;">L — Con ventas</span>
                    <span id="count-seg-l" style="font-size: 10px; background: rgba(59,130,246,0.2); padding: 2px 6px; border-radius: 10px; font-weight: 600; margin-right: 4px;">0</span>
                    <i data-lucide="eye" class="toggle-eye" style="width:12px;height:12px;flex-shrink:0;"></i>
                  </div>
                  <div class="legend-item legend-filter active" onclick="filterMapBySegment('N')" data-segment="N" style="cursor: pointer; padding: 5px 8px; border-radius: 6px; margin: 2px 0; display: flex; align-items: center;">
                    <div class="legend-dot seg-n"></div>
                    <span style="flex: 1; font-size: 11px;">N — Nuevos</span>
                    <span id="count-seg-n" style="font-size: 10px; background: rgba(148,163,184,0.2); padding: 2px 6px; border-radius: 10px; font-weight: 600; margin-right: 4px;">0</span>
                    <i data-lucide="eye" class="toggle-eye" style="width:12px;height:12px;flex-shrink:0;"></i>
                  </div>
                  <div class="legend-item legend-filter active" onclick="filterMapBySegment('none')" data-segment="none" style="cursor: pointer; padding: 5px 8px; border-radius: 6px; margin: 2px 0; display: flex; align-items: center;">
                    <div class="legend-dot seg-none"></div>
                    <span style="flex: 1; font-size: 11px;">Sin clasificar</span>
                    <span id="count-seg-none" style="font-size: 10px; background: rgba(203,213,225,0.4); padding: 2px 6px; border-radius: 10px; font-weight: 600; margin-right: 4px;">0</span>
                    <i data-lucide="eye" class="toggle-eye" style="width:12px;height:12px;flex-shrink:0;"></i>
                  </div>
                  <div class="legend-item legend-filter active" onclick="filterMapBySegment('FOCO')" data-segment="FOCO" style="cursor: pointer; padding: 5px 8px; border-radius: 6px; margin: 2px 0; margin-top: 6px; padding-top: 8px; border-top: 1px solid var(--border); display: flex; align-items: center;">
                    <div style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,0.4); margin-right: 8px; flex-shrink:0;"></div>
                    <span style="flex: 1; font-size: 11px;">FOCO</span>
                    <span id="count-seg-foco" style="font-size: 10px; background: rgba(239,68,68,0.2); padding: 2px 6px; border-radius: 10px; font-weight: 600; margin-right: 4px;">0</span>
                    <i data-lucide="eye" class="toggle-eye" style="width:12px;height:12px;flex-shrink:0;"></i>
                  </div>
                  <button onclick="filterMapBySegment('ALL')" style="width: 100%; margin-top: 8px; padding: 5px 8px; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Mostrar Todos
                  </button>
                </div>
                <!-- Location Stats -->
                <div style="background: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 8px 10px; margin-top: 8px;">
                  <div style="display: flex; justify-content: space-between; font-size: 11px;">
                    <span style="color: var(--text-muted);">Con GPS: <strong id="stats-with-coords" style="color: var(--success);">0</strong></span>
                    <span style="color: var(--text-muted);">Sin GPS: <strong id="stats-without-coords" style="color: var(--warning);">0</strong></span>
                  </div>
                  <button id="btn-geocode" onclick="geocodeClientsWithoutCoords()" style="width: 100%; padding: 4px 6px; font-size: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; display: none; margin-top: 6px;">
                    <i data-lucide="map-pin" style="width: 10px; height: 10px; vertical-align: middle;"></i> Geocodificar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fila 4: Rutas Activas Hoy + Equipo por Zona -->
        <div class="dash-grid-row dash-row-ops" style="margin-top: 20px;">
          <!-- Rutas Activas Hoy -->
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3><i data-lucide="navigation" style="width: 18px; height: 18px;"></i> Rutas Activas Hoy</h3>
              <a href="#" onclick="document.querySelector('[data-tab=routes]').click(); return false;" style="font-size: 12px; color: var(--primary); text-decoration: none; font-weight: 500;">Ver mapa →</a>
            </div>
            <div class="card-body" style="padding: 0;">
              <div id="dash-rutas-summary" style="padding: 16px;">
                <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px;">
                  <i data-lucide="loader-2" class="spin" style="width: 24px; height: 24px; margin-bottom: 8px;"></i>
                  <p>Cargando rutas...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Equipo por Zona -->
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3><i data-lucide="map-pin" style="width: 18px; height: 18px;"></i> Equipo por Zona</h3>
              <a href="#" onclick="document.querySelector('[data-tab=gsheets][data-subtab=gs-vendedores]')?.click(); return false;" style="font-size: 12px; color: var(--primary); text-decoration: none; font-weight: 500;">Ver detalle →</a>
            </div>
            <div class="card-body" style="padding: 12px;">
              <div id="dash-zonas-summary" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px; grid-column: span 2;">Cargando zonas...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fila 5: Resumen Ventas + Cobranzas Pendientes -->
        <div class="dash-grid-row dash-row-fin" style="margin-top: 20px;">
          <!-- Resumen Ventas -->
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3><i data-lucide="trending-up" style="width: 18px; height: 18px;"></i> Resumen Ventas</h3>
              <a href="#" onclick="document.querySelector('[data-tab=gsheets][data-subtab=gs-ventas]')?.click(); return false;" style="font-size: 12px; color: var(--primary); text-decoration: none; font-weight: 500;">Ver detalle →</a>
            </div>
            <div class="card-body" style="padding: 0;">
              <div id="dash-ventas-summary" style="padding: 16px;">
                <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px;">
                  <i data-lucide="loader-2" class="spin" style="width: 24px; height: 24px; margin-bottom: 8px;"></i>
                  <p>Cargando datos de ventas...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Cobranzas Pendientes -->
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3 style="display: flex; align-items: center; gap: 8px;">
                <i data-lucide="clock" style="width: 18px; height: 18px;"></i> Cobranzas Pendientes
                <span id="dash-cobranzas-badge" style="font-size: 11px; font-weight: 700; background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; display: none;">0</span>
              </h3>
              <a href="#" onclick="document.querySelector('[data-tab=gsheets][data-subtab=gs-cobranzas]')?.click(); return false;" style="font-size: 12px; color: var(--primary); text-decoration: none; font-weight: 500;">Ver todo →</a>
            </div>
            <div class="card-body" style="padding: 0;">
              <div id="dash-cobranzas-summary" style="padding: 16px;">
                <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Cargando cobranzas...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fila 6: Comparativo de Competencia -->
        <div class="card" id="card-comparativo-summary" style="margin-top: 20px;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3><i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i> Comparativo de Competencia</h3>
            <a href="#" onclick="document.querySelector('[data-tab=intelligence]').click(); return false;" style="font-size: 12px; color: var(--primary); text-decoration: none;">Ver detalle →</a>
          </div>
          <div class="card-body" style="padding: 16px; overflow: auto;">
            <div id="dashboard-comparativo-summary">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                <div style="text-align: center; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                  <div style="font-size: 20px; font-weight: 700; color: #3b82f6;" id="dash-comp-products">-</div>
                  <div style="font-size: 10px; color: var(--text-muted);">Productos</div>
                </div>
                <div style="text-align: center; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                  <div style="font-size: 20px; font-weight: 700; color: #059669;" id="dash-comp-sources">-</div>
                  <div style="font-size: 10px; color: var(--text-muted);">Fuentes</div>
                </div>
                <div style="text-align: center; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                  <div style="font-size: 20px; font-weight: 700; color: #f97316;" id="dash-comp-avg">-</div>
                  <div style="font-size: 10px; color: var(--text-muted);">Precio Prom</div>
                </div>
              </div>
              <div id="dash-comp-bars" style="font-size: 12px;"></div>
            </div>
          </div>
        </div>

        <!-- Fila 7: Rendimiento por Vendedor -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <h3><i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i> Rendimiento por Vendedor</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="month" id="vendor-stats-month" class="form-control" style="width: 180px; font-size: 13px;" onchange="loadVendorDashboard()">
              <button class="btn btn-secondary" onclick="loadVendorDashboard()" style="font-size: 12px; padding: 6px 12px;">
                <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="vendor-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
              <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px; grid-column: 1 / -1;">
                <i data-lucide="users" style="width: 36px; height: 36px; margin-bottom: 8px;"></i>
                <p>Selecciona un mes para ver rendimiento de vendedores</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Fila 8: Calendario de Visitas -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <h3><i data-lucide="calendar" style="width: 18px; height: 18px;"></i> Calendario Mensual de Visitas</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
              <select id="calendar-vendor" class="form-control" style="width: 200px; font-size: 13px;" onchange="loadVendorCalendar()">
                <option value="">-- Seleccionar Vendedor --</option>
              </select>
              <input type="month" id="calendar-month" class="form-control" style="width: 180px; font-size: 13px;" onchange="loadVendorCalendar()">
            </div>
          </div>
          <div class="card-body">
            <div id="calendar-grid" style="min-height: 200px;">
              <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px;">
                <i data-lucide="calendar-days" style="width: 36px; height: 36px; margin-bottom: 8px;"></i>
                <p>Selecciona vendedor y mes para ver el calendario</p>
              </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 16px; justify-content: center; font-size: 11px;">
              <span><span style="display: inline-block; width: 10px; height: 10px; background: #b8860b; border-radius: 50%;"></span> 80/20</span>
              <span><span style="display: inline-block; width: 10px; height: 10px; background: #2563eb; border-radius: 50%;"></span> L</span>
              <span><span style="display: inline-block; width: 10px; height: 10px; background: #6b7280; border-radius: 50%;"></span> N</span>
              <span><span style="display: inline-block; width: 10px; height: 10px; background: #10b981; border-radius: 50%;"></span> Completada</span>
              <span><span style="display: inline-block; width: 10px; height: 10px; background: #f59e0b; border-radius: 50%;"></span> Pendiente</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Routes Panel -->
      <div class="panel" id="panel-routes">

        <!-- ============ ROUTE SUBTAB NAVIGATION ============ -->
        <div class="route-tabs">
          <button class="route-tab active" data-routetab="dashboard" onclick="switchRouteTab('dashboard')">
            <i data-lucide="layout-dashboard" style="width: 15px; height: 15px;"></i>
            Dashboard
          </button>
          <button class="route-tab" data-routetab="gestionar" onclick="switchRouteTab('gestionar')">
            <i data-lucide="route" style="width: 15px; height: 15px;"></i>
            Gestionar Rutas
          </button>
          <button class="route-tab" data-routetab="planner" onclick="switchRouteTab('planner')">
            <i data-lucide="calendar-range" style="width: 15px; height: 15px;"></i>
            Planner Semanal
          </button>
          <button class="route-tab" data-routetab="monthly" onclick="switchRouteTab('monthly')">
            <i data-lucide="calendar" style="width: 15px; height: 15px;"></i>
            Calendario Mensual
          </button>
        </div>

        <!-- ============ SUBTAB 1: DASHBOARD ============ -->
        <div class="route-subpanel active" id="route-subpanel-dashboard">

          <!-- Dashboard Stat Cards -->
          <div class="route-dashboard-stats">
            <div class="route-stat-card" onclick="toggleStatDetail('with-route')">
              <div class="stat-icon" style="background: rgba(59,130,246,0.08);">
                <i data-lucide="users" style="width: 18px; height: 18px; color: #3b82f6;"></i>
              </div>
              <div class="stat-value" style="color: #3b82f6;" id="dash-rt-active-vendors">0</div>
              <div class="stat-label">Con ruta hoy</div>
            </div>
            <div class="route-stat-card" onclick="toggleStatDetail('without-route')">
              <div class="stat-icon" style="background: rgba(239,68,68,0.08);">
                <i data-lucide="user-x" style="width: 18px; height: 18px; color: #ef4444;"></i>
              </div>
              <div class="stat-value" style="color: #ef4444;" id="dash-rt-no-route">0</div>
              <div class="stat-label">Sin ruta</div>
            </div>
            <div class="route-stat-card" onclick="toggleStatDetail('completed')">
              <div class="stat-icon" style="background: rgba(16,185,129,0.08);">
                <i data-lucide="check-circle" style="width: 18px; height: 18px; color: #10b981;"></i>
              </div>
              <div class="stat-value" style="color: #10b981;" id="dash-rt-completed">0</div>
              <div class="stat-label">Completadas</div>
            </div>
            <div class="route-stat-card" onclick="toggleStatDetail('scheduled')">
              <div class="stat-icon" style="background: rgba(139,92,246,0.08);">
                <i data-lucide="calendar-check" style="width: 18px; height: 18px; color: #8b5cf6;"></i>
              </div>
              <div class="stat-value" style="color: #8b5cf6;" id="dash-rt-scheduled">0</div>
              <div class="stat-label">Programadas</div>
            </div>
            <div class="route-stat-card" onclick="toggleStatDetail('fuel')">
              <div class="stat-icon" style="background: rgba(99,102,241,0.08);">
                <i data-lucide="fuel" style="width: 18px; height: 18px; color: #6366f1;"></i>
              </div>
              <div class="stat-value" style="color: #6366f1;" id="dash-rt-fuel-cost">$0</div>
              <div class="stat-label">Costo bencina</div>
            </div>
          </div>

          <!-- Stat Detail Panel (shows on card click) -->
          <div id="dash-stat-detail" style="display:none;"></div>

          <!-- Dashboard Alerts -->
          <div id="dashboard-route-alerts" style="margin-bottom: 18px;"></div>

          <!-- Scheduled Routes Table -->
          <div class="card" style="border-radius: 14px; overflow: hidden;">
            <div class="card-header" style="padding: 18px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);">
              <h3 style="font-size: 17px; font-weight: 700; display: flex; align-items: center; gap: 10px; margin: 0;">
                <span style="width: 36px; height: 36px; border-radius: 10px; background: rgba(139,92,246,0.08); display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="calendar-check" style="width: 18px; height: 18px; color: #8b5cf6;"></i>
                </span>
                Rutas Programadas
              </h3>
              <div style="display:flex;gap:10px;align-items:center;">
                <button class="btn" onclick="deleteAllScheduledRoutes()" style="font-size: 13px; padding: 9px 16px; background:none; border:1px solid rgba(239,68,68,0.25); color:#ef4444; border-radius:10px; cursor:pointer; font-weight: 600;" title="Eliminar todas las rutas programadas">
                  <i data-lucide="trash-2" style="width: 14px; height: 14px; vertical-align: -2px;"></i> Eliminar todas
                </button>
                <button class="btn btn-secondary" onclick="updateRouteDashboard()" style="font-size: 13px; padding: 9px 16px; border-radius: 10px; font-weight: 600;">
                  <i data-lucide="refresh-cw" style="width: 14px; height: 14px; vertical-align: -2px;"></i> Actualizar
                </button>
              </div>
            </div>
            <div id="dashboard-scheduled-table" style="padding: 0;"></div>
          </div>
        </div>

        <!-- ============ SUBTAB 2: GESTIONAR RUTAS ============ -->
        <div class="route-subpanel" id="route-subpanel-gestionar">

          <!-- Wizard Stepper -->
          <div class="route-stepper">
            <div class="route-step active" data-step="1" onclick="goToRouteStep(1)">
              <div class="step-number">1</div>
              <div class="step-label">Vendedor</div>
            </div>
            <div class="step-line"></div>
            <div class="route-step" data-step="2" onclick="goToRouteStep(2)">
              <div class="step-number">2</div>
              <div class="step-label">Ruta Óptima</div>
            </div>
            <div class="step-line"></div>
            <div class="route-step" data-step="3" onclick="goToRouteStep(3)">
              <div class="step-number">3</div>
              <div class="step-label">Revisar</div>
            </div>
            <div class="step-line"></div>
            <div class="route-step" data-step="4" onclick="goToRouteStep(4)">
              <div class="step-number">4</div>
              <div class="step-label">Programar</div>
            </div>
          </div>

          <!-- WIZARD LAYOUT: Content Left + Map Right -->
          <div class="wizard-layout">
            <!-- Left: Wizard Steps Content -->
            <div>
              <!-- STEP 1: Elegir Vendedor -->
              <div class="step-content active" id="wizard-step-1">
                <!-- Vendor Selector -->
                <div style="margin-bottom: 12px; position: relative; z-index: 10;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="width: 6px; height: 6px; border-radius: 50%; background: #1e40af; flex-shrink: 0;"></span>
                    <span style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Paso 1 — Elegir Vendedor</span>
                  </div>
                  <div style="display: flex; gap: 6px; align-items: center;">
                    <div style="position: relative; flex: 1;">
                      <input type="text" id="executive-search" class="form-control" placeholder="Buscar vendedor por nombre..."
                        style="width: 100%; padding: 7px 30px 7px 10px; font-size: 13px; border: 1px solid var(--border); border-radius: 6px;"
                        oninput="filterExecutiveDropdown(this.value)" onfocus="showExecutiveDropdown()" autocomplete="off">
                      <i data-lucide="search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: var(--text-muted); pointer-events: none;"></i>
                      <div id="executive-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 260px; overflow-y: auto; z-index: 1000; margin-top: 2px;">
                        <div id="executive-dropdown-list"></div>
                      </div>
                    </div>
                    <button class="btn" onclick="clearExecutiveFilter()" style="background: var(--bg-hover); color: var(--text-muted); padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px;" title="Limpiar">
                      <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                    </button>
                  </div>
                </div>

                <!-- Selected Vendor Info Card (hidden until selection) -->
                <div id="selected-vendor-card" style="display: none; margin-bottom: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                  <!-- Vendor header -->
                  <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i data-lucide="user" style="width: 18px; height: 18px; color: white;"></i>
                      </div>
                      <div>
                        <div id="vendor-card-name" style="font-weight: 600; font-size: 16px; color: var(--text);">—</div>
                        <div id="vendor-card-zone" style="font-size: 12px; color: var(--text-muted);">—</div>
                      </div>
                    </div>
                    <div id="vendor-card-status-badge" style="padding: 5px 14px; border-radius: 12px; font-size: 12px; font-weight: 600;">—</div>
                  </div>
                  <!-- Vendor stats row -->
                  <div style="padding: 10px 16px; display: flex; gap: 0;">
                    <div style="flex: 1; text-align: center; padding: 8px 2px; border-right: 1px solid var(--border);">
                      <div id="vendor-card-clients" style="font-size: 20px; font-weight: 700; color: var(--accent); line-height: 1;">0</div>
                      <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-top: 4px;">Clientes</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 8px 2px; border-right: 1px solid var(--border);">
                      <div id="vendor-card-visits" style="font-size: 20px; font-weight: 700; color: var(--warning); line-height: 1;">0</div>
                      <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-top: 4px;">Visitas Hoy</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 8px 2px; border-right: 1px solid var(--border);">
                      <div id="vendor-card-scheduled" style="font-size: 20px; font-weight: 700; color: var(--primary); line-height: 1;">0</div>
                      <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-top: 4px;">Programadas</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 8px 2px;">
                      <div id="vendor-card-gps" style="font-size: 20px; font-weight: 700; color: #10b981; line-height: 1;">0%</div>
                      <div style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-top: 4px;">Con GPS</div>
                    </div>
                  </div>
                  <!-- GPS warning + actions (shown when GPS% < 80) -->
                  <div id="vendor-card-gps-warning" style="display: none; padding: 10px 16px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-top: 1px solid #fde68a; align-items: center; justify-content: space-between; gap: 8px;">
                    <span style="font-size: 13px; color: #92400e; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                      <i data-lucide="alert-triangle" style="width:15px;height:15px;"></i>
                      <span id="vendor-card-no-gps-count">0</span> dirección pendiente de confirmación
                    </span>
                    <div style="display: flex; gap: 6px;">
                      <button onclick="syncAddressesFromGSheets()" style="background: white; color: #92400e; border: 1px solid #f59e0b; padding: 6px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: all 0.15s;" onmouseover="this.style.background='#f59e0b';this.style.color='white'" onmouseout="this.style.background='white';this.style.color='#92400e'">
                        <i data-lucide="refresh-cw" style="width:13px;height:13px;"></i> Sync
                      </button>
                      <button onclick="geocodeClientsWithoutCoords()" style="background: #3b82f6; color: white; border: none; padding: 6px 14px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 1px 4px rgba(59,130,246,0.3); transition: all 0.15s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        <i data-lucide="map-pin" style="width:13px;height:13px;"></i> Geocodificar
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Hidden stats for backward compatibility -->
                <div id="executive-stats" style="display: none;">
                  <span id="stat-total-executives">0</span>
                  <span id="stat-active-routes">0</span>
                  <span id="stat-today-visits">0</span>
                  <span id="stat-assigned-clients">0</span>
                </div>

                <!-- Iniciar Jornada (hidden until vendor selected) -->
                <div id="iniciar-jornada-wrapper" class="card" style="display: none; margin-bottom: 12px; border-radius: 12px;">
                  <div class="card-header" style="padding: 12px 16px;">
                    <div>
                      <h3 style="font-size: 16px; margin: 0;"><i data-lucide="play-circle" style="width: 18px; height: 18px;"></i> Iniciar Jornada</h3>
                      <p style="font-size: 12px; color: var(--text-muted); margin: 4px 0 0 0;">Registra el inicio de jornada para seguimiento de kilometraje y visitas del día</p>
                    </div>
                  </div>
                  <div class="card-body" style="padding: 14px 16px;">
                    <form id="form-start-day">
                      <div class="form-group">
                        <label style="font-size: 13px;">Vendedor</label>
                        <select id="start-user" class="form-control" required onchange="checkActiveRoute(this.value)"></select>
                      </div>
                      <div class="form-group">
                        <label style="font-size: 13px;">Vehículo</label>
                        <div id="standard-vehicle-display" style="background: var(--bg-hover); padding: 10px 14px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                          <i data-lucide="car" style="width: 18px; height: 18px; color: var(--primary);"></i>
                          <div>
                            <div style="font-weight: 600; font-size: 14px; color: var(--text);" id="standard-vehicle-name">Vehículo Estándar Chile</div>
                            <div style="font-size: 12px; color: var(--text-muted);">10 km/L • Bencina 93 oct • $1,150/L</div>
                          </div>
                        </div>
                        <input type="hidden" id="start-vehicle" value="">
                      </div>
                      <div class="form-group">
                        <label style="font-size: 13px;">Kilometraje Inicial</label>
                        <p style="font-size: 11px; color: var(--text-muted); margin: 0 0 6px 0;">Lectura actual del odómetro</p>
                        <input type="number" id="start-km" class="form-control" value="" placeholder="Ingresa KM del odómetro" required style="font-size: 14px; padding: 10px 12px;">
                        <small id="start-km-hint" style="font-size: 11px; color: var(--text-muted); display: none;"></small>
                      </div>
                      <div style="display: flex; justify-content: flex-end;">
                        <button type="submit" class="btn btn-primary" style="padding: 10px 24px; font-size: 14px; border-radius: 8px;">
                          <i data-lucide="play" style="width: 15px; height: 15px;"></i>
                          Iniciar Día
                        </button>
                      </div>
                    </form>
                    <div class="response-box" id="response-start" style="display: none;"></div>

                    <!-- Stale Route Warning Banner -->
                    <div id="stale-route-warning" style="display: none; margin-top: 12px; padding: 12px 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                      <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                          <span style="font-size: 18px; flex-shrink: 0;">&#9888;&#65039;</span>
                          <span id="stale-route-text" style="font-size: 12px; color: #92400e; font-weight: 500;"></span>
                        </div>
                        <button type="button" class="btn" onclick="endStaleRoute()" style="background: #f59e0b; color: white; padding: 4px 12px; font-size: 11px; white-space: nowrap; border: none; border-radius: 4px; cursor: pointer;">
                          Finalizar
                        </button>
                      </div>
                    </div>

                    <!-- Active Route Info -->
                    <div id="active-route-info" style="display: none; margin-top: 10px; padding: 10px 12px; background: var(--bg-hover); border-radius: 6px; border-left: 3px solid var(--success);">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h4 style="margin: 0; color: var(--success); display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <i data-lucide="check-circle" style="width: 15px; height: 15px;"></i>
                          Ruta Activa
                          <span id="active-route-date-badge" style="font-size: 9px; font-weight: 400; background: var(--success); color: white; padding: 1px 6px; border-radius: 8px;"></span>
                        </h4>
                        <div style="display: flex; gap: 6px;">
                          <button type="button" class="btn btn-secondary" onclick="viewActiveRouteOnMap()" style="padding: 4px 12px; font-size: 11px;">
                            <i data-lucide="map" style="width: 14px; height: 14px;"></i> Ver en Mapa
                          </button>
                          <button type="button" class="btn" onclick="endRoute(currentActiveRoute?.id)" style="background: var(--danger); color: white; padding: 4px 12px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer;">
                            <i data-lucide="flag" style="width: 14px; height: 14px;"></i> Finalizar
                          </button>
                          <button type="button" class="btn" onclick="if(confirm('¿Eliminar esta ruta activa?')) deleteRouteById(currentActiveRoute?.id)" style="background: none; border: 1px solid rgba(239,68,68,0.3); color: #ef4444; padding: 4px 8px; font-size: 11px; border-radius: 4px; cursor: pointer;" title="Eliminar ruta">
                            <i data-lucide="trash-2" style="width: 13px; height: 13px;"></i>
                          </button>
                        </div>
                      </div>
                      <div id="active-route-details" style="font-size: 13px;"></div>
                      <div id="active-route-metrics-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 10px;">
                        <div style="text-align: center; padding: 6px; background: var(--bg-card); border-radius: 6px;">
                          <div style="font-size: 15px; font-weight: 700; color: #6366f1;" id="route-odometer-km">-</div>
                          <div style="font-size: 9px; color: var(--text-muted);">KM Odómetro</div>
                        </div>
                        <div style="text-align: center; padding: 6px; background: var(--bg-card); border-radius: 6px;">
                          <div style="font-size: 15px; font-weight: 700; color: var(--primary);" id="route-distance">-</div>
                          <div style="font-size: 9px; color: var(--text-muted);">Km Calc.</div>
                        </div>
                        <div style="text-align: center; padding: 6px; background: var(--bg-card); border-radius: 6px;">
                          <div style="font-size: 15px; font-weight: 700; color: var(--warning);" id="route-duration">-</div>
                          <div style="font-size: 9px; color: var(--text-muted);">Duración</div>
                        </div>
                        <div style="text-align: center; padding: 6px; background: var(--bg-card); border-radius: 6px;">
                          <div style="font-size: 15px; font-weight: 700; color: #6366f1;" id="route-fuel-cost">-</div>
                          <div style="font-size: 9px; color: var(--text-muted);">Costo</div>
                        </div>
                      </div>
                      <div id="active-route-no-gps-warning" style="display: none; margin-top: 12px; padding: 10px 14px; background: #fef3c7; border-radius: 6px; font-size: 12px; color: #92400e; text-align: center;"></div>
                      <div id="route-km-comparison" style="display: none; margin-top: 8px; padding: 8px 12px; background: var(--bg-card); border-radius: 6px; font-size: 12px; text-align: center; color: var(--text-muted);"></div>
                    </div>
                  </div>
                </div>

                <!-- Step 1 Navigation -->
                <div style="margin-top: 14px;">
                  <button onclick="generateOptimizedRoute();" class="btn" style="width: 100%; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 28px; font-weight: 700; font-size: 15px; border: none; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 14px rgba(16,185,129,0.35); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 20px rgba(16,185,129,0.45)'" onmouseout="this.style.transform='none';this.style.boxShadow='0 4px 14px rgba(16,185,129,0.35)'">
                    <i data-lucide="route" style="width: 18px; height: 18px;"></i>
                    <span>Generar Ruta Óptima</span>
                    <i data-lucide="arrow-right" style="width: 18px; height: 18px;"></i>
                  </button>
                </div>
              </div><!-- /wizard-step-1 -->

              <!-- STEP 2: Ruta Óptima -->
              <div class="step-content" id="wizard-step-2">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="width: 6px; height: 6px; border-radius: 50%; background: #059669; flex-shrink: 0;"></span>
                  <span style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Paso 2 — Ruta Optimizada</span>
                </div>

                <!-- Optimized Route Info Panel -->
                <div id="optimized-route-panel" class="card" style="display: none; margin-bottom: 12px; border: 1px solid var(--border); overflow: hidden; border-radius: 10px;">
                  <!-- Header -->
                  <div style="padding: 10px 14px; background: var(--bg-hover); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div style="width: 28px; height: 28px; border-radius: 7px; background: #10b981; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="route" style="width: 14px; height: 14px; color: white;"></i>
                      </div>
                      <div>
                        <span style="font-weight: 700; font-size: 14px; color: var(--text);" id="opt-vendor-name">Vendedor</span>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <button onclick="openFullRouteInMaps()" class="btn" style="background: #4285f4; color: white; border: none; padding: 7px 14px; font-size: 12px; font-weight: 600; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="Abrir en Google Maps">
                        <i data-lucide="map-pin" style="width:14px;height:14px;"></i> Abrir en Maps
                      </button>
                      <button onclick="generateOptimizedRoute()" class="btn" style="background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border); padding: 7px 10px; font-size: 12px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px;" title="Recalcular ruta">
                        <i data-lucide="refresh-cw" style="width: 13px; height: 13px;"></i> Recalcular
                      </button>
                    </div>
                  </div>

                  <!-- Weekly Total Stats -->
                  <div id="opt-weekly-totals" style="padding: 14px 16px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 0; border-bottom: 1px solid var(--border);">
                    <div style="text-align: center; padding: 8px 4px; border-right: 1px solid var(--border);">
                      <div style="font-size: 24px; font-weight: 800; color: var(--accent); line-height: 1.1;" id="opt-total-clients">0</div>
                      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-top: 4px;">Clientes</div>
                    </div>
                    <div style="text-align: center; padding: 8px 4px; border-right: 1px solid var(--border);">
                      <div style="font-size: 24px; font-weight: 800; color: var(--text); line-height: 1.1;" id="opt-distance">0 km</div>
                      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-top: 4px;">Distancia</div>
                    </div>
                    <div style="text-align: center; padding: 8px 4px; border-right: 1px solid var(--border);">
                      <div style="font-size: 24px; font-weight: 800; color: var(--warning); line-height: 1.1;" id="opt-time">0 min</div>
                      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-top: 4px;">Jornada</div>
                    </div>
                    <div style="text-align: center; padding: 8px 4px; border-right: 1px solid var(--border);">
                      <div style="font-size: 24px; font-weight: 800; color: #e67e22; line-height: 1.1;" id="opt-liters">0 L</div>
                      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-top: 4px;">Bencina</div>
                    </div>
                    <div style="text-align: center; padding: 8px 4px;">
                      <div style="font-size: 24px; font-weight: 800; color: #6366f1; line-height: 1.1;" id="opt-cost">$0</div>
                      <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-top: 4px;">Costo</div>
                    </div>
                  </div>

                  <!-- Vehicle info bar -->
                  <div style="padding: 6px 14px; background: var(--bg-hover); font-size: 11px; color: var(--text-muted); display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                    <span><i data-lucide="car" style="width: 11px; height: 11px; vertical-align: middle;"></i> <span id="opt-efficiency">10 km/L</span></span>
                    <span><i data-lucide="fuel" style="width: 11px; height: 11px; vertical-align: middle;"></i> <span id="opt-fuel-type">93 oct</span></span>
                    <span><i data-lucide="dollar-sign" style="width: 11px; height: 11px; vertical-align: middle;"></i> <span id="opt-fuel-price">$1.150/L</span></span>
                    <span id="opt-fuel-region" style="font-size: 10px; color: #10b981; font-weight: 500;"></span>
                    <span style="margin-left: auto; color: #10b981; font-weight: 600; font-size: 10px;">TSP optimizado</span>
                  </div>

                  <!-- Day tabs -->
                  <div id="opt-day-tabs" style="display:none; padding: 8px 14px; border-top: 1px solid var(--border);">
                  </div>
                </div>

                <!-- Day Detail Panel (shown when a day is selected) -->
                <div id="opt-day-detail" style="display: none;">
                  <div class="card" style="margin-bottom: 12px; overflow: hidden; border-radius: 10px;">
                    <div style="padding: 12px 16px; background: var(--bg-hover); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-size: 15px; font-weight: 700;" id="opt-day-detail-title">Detalle del Día</span>
                      <div style="display: flex; gap: 8px; align-items: center;">
                        <span id="opt-day-detail-stats" style="font-size: 13px; color: var(--text-secondary); font-weight: 600;"></span>
                        <button onclick="openDayRouteInMapsFromOpt()" class="btn" style="background: #4285f4; color: white; border: none; padding: 6px 14px; font-size: 12px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" title="Abrir día en Google Maps">
                          <i data-lucide="map-pin" style="width:14px;height:14px;"></i> Maps
                        </button>
                      </div>
                    </div>
                    <div id="opt-day-detail-clients" style="padding: 0; max-height: 400px; overflow-y: auto;">
                    </div>
                  </div>
                </div>

                <!-- Step 2 Navigation -->
                <div style="display: flex; justify-content: space-between; gap: 8px; margin-top: 12px;">
                  <button onclick="goToRouteStep(1)" class="btn btn-secondary" style="padding: 10px 20px; font-size: 13px; border-radius: 8px; font-weight: 600;">
                    <i data-lucide="arrow-left" style="width: 14px; height: 14px;"></i> Volver
                  </button>
                  <button onclick="goToRouteStep(3)" class="btn" style="background: var(--accent); color: white; padding: 10px 24px; font-weight: 700; font-size: 13px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(99,102,241,0.3);">
                    Revisar Clientes <i data-lucide="arrow-right" style="width: 14px; height: 14px; margin-left: 4px;"></i>
                  </button>
                </div>
              </div><!-- /wizard-step-2 -->

              <!-- STEP 3: Revisar Clientes -->
              <div class="step-content" id="wizard-step-3">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                  <span style="width: 6px; height: 6px; border-radius: 50%; background: #7c3aed; flex-shrink: 0;"></span>
                  <span style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Paso 3 — Revisar y Editar</span>
                </div>

                <!-- Assigned Clients Card -->
                <div class="card" style="margin-bottom: 12px; border-radius: 10px;">
                  <div class="card-header" style="padding: 10px 14px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 14px; font-weight: 700;"><i data-lucide="users-round" style="width: 16px; height: 16px;"></i> Clientes del Vendedor</h3>
                    <button class="btn btn-secondary" onclick="openAssignClientsModal()" style="padding: 7px 14px; font-size: 12px; border-radius: 6px; font-weight: 600;">
                      <i data-lucide="user-plus" style="width: 14px; height: 14px;"></i> Asignar
                    </button>
                  </div>
                  <div class="card-body" style="padding: 8px 14px; max-height: 450px; overflow-y: auto;">
                    <div id="executive-clients-list">
                      <div class="empty-state" style="padding: 16px;">
                        <i data-lucide="user-search" style="width: 28px; height: 28px;"></i>
                        <p style="font-size: 12px;">Selecciona un vendedor para ver sus clientes</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 3 Navigation -->
                <div style="display: flex; justify-content: space-between; gap: 8px; margin-top: 12px;">
                  <button onclick="goToRouteStep(2)" class="btn btn-secondary" style="padding: 10px 20px; font-size: 13px; border-radius: 8px; font-weight: 600;">
                    <i data-lucide="arrow-left" style="width: 14px; height: 14px;"></i> Volver
                  </button>
                  <button onclick="goToRouteStep(4); scheduleOptimizedRoute();" class="btn" style="background: #10b981; color: white; padding: 10px 24px; font-weight: 700; font-size: 13px; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(16,185,129,0.3); display: inline-flex; align-items: center; gap: 6px;">
                    <i data-lucide="calendar-plus" style="width: 15px; height: 15px;"></i>
                    Programar Ruta
                    <i data-lucide="arrow-right" style="width: 14px; height: 14px;"></i>
                  </button>
                </div>
              </div><!-- /wizard-step-3 -->

              <!-- STEP 4: Programar -->
              <div class="step-content" id="wizard-step-4">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="width: 6px; height: 6px; border-radius: 50%; background: #dc2626; flex-shrink: 0;"></span>
                  <span style="font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Paso 4 — Programar y Asignar</span>
                </div>

                <div id="wizard-step4-content">
                  <!-- Route Summary -->
                  <div id="wizard-step4-summary" class="card" style="margin-bottom: 10px; overflow: hidden;"></div>

                  <!-- Schedule Action -->
                  <div class="card" style="margin-bottom: 10px; overflow: hidden;">
                    <div style="padding: 10px 14px; display: flex; align-items: center; justify-content: space-between;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="calendar-check" style="width: 18px; height: 18px; color: #10b981;"></i>
                        <div>
                          <div style="font-size: 12px; font-weight: 600;">Programar esta ruta</div>
                          <div style="font-size: 11px; color: var(--text-muted);">Asignar fechas y confirmar al vendedor</div>
                        </div>
                      </div>
                      <button id="btn-schedule-opt" onclick="scheduleOptimizedRoute()" class="btn" style="background: #10b981; color: white; padding: 6px 14px; font-weight: 600; font-size: 12px; border: none; border-radius: 6px; cursor: pointer; transition: transform 0.1s, opacity 0.15s;" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                        <i data-lucide="calendar-plus" style="width: 13px; height: 13px;"></i> Programar
                      </button>
                    </div>
                  </div>
                </div>

                <div id="wizard-step4-success" style="display: none;">
                  <div class="card" style="overflow: hidden;">
                    <div style="padding: 20px; text-align: center;">
                      <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(16,185,129,0.1); display: inline-flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                        <i data-lucide="check-circle-2" style="width: 20px; height: 20px; color: #10b981;"></i>
                      </div>
                      <h3 style="color: #10b981; margin-bottom: 4px; font-size: 14px;">Ruta Programada Exitosamente</h3>
                      <p id="wizard-success-text" style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">La ruta ha sido programada. Puedes verla en el Planificador Semanal.</p>
                      <div style="display: flex; gap: 8px; justify-content: center;">
                        <button onclick="switchRouteTab('planner')" class="btn btn-primary" style="padding: 6px 14px; font-size: 12px;">
                          <i data-lucide="calendar-range" style="width: 13px; height: 13px;"></i> Ver Planificación
                        </button>
                        <button onclick="resetRouteWizard()" class="btn btn-secondary" style="padding: 6px 14px; font-size: 12px;">
                          <i data-lucide="plus" style="width: 13px; height: 13px;"></i> Nueva Ruta
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Step 4 Navigation -->
                <div style="display: flex; justify-content: flex-start; gap: 8px; margin-top: 12px;">
                  <button onclick="goToRouteStep(3)" class="btn btn-secondary" style="padding: 10px 20px; font-size: 13px; border-radius: 8px; font-weight: 600;">
                    <i data-lucide="arrow-left" style="width: 14px; height: 14px;"></i> Volver
                  </button>
                </div>
              </div><!-- /wizard-step-4 -->
            </div><!-- /left wizard panel -->

            <!-- Right: Route Map (tall, sticky) -->
            <div>
              <div class="card" style="position: sticky; top: 8px; overflow: hidden; border-radius: 12px;">
                <div class="card-header" style="padding: 10px 16px;">
                  <h3 style="font-size: 14px; font-weight: 700;"><i data-lucide="map" style="width: 16px; height: 16px;"></i> Mapa de Ruta</h3>
                  <button id="btn-toggle-gas" onclick="toggleGasStations()" style="background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; padding: 5px 12px; font-size: 11px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 5px; font-weight: 600;" title="Mostrar bencinerías cercanas">
                    <i data-lucide="fuel" style="width:14px;height:14px;"></i> Bencinerías
                  </button>
                </div>
                <div class="card-body" style="padding: 0;">
                  <div class="map-container" style="height: calc(100vh - 200px); min-height: 480px; max-height: 700px; position: relative;">
                    <div id="map-route"></div>
                    <div id="route-legend" class="route-legend" style="display: none;">
                      <div class="legend-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <div class="legend-title">Ruta del día</div>
                        <i data-lucide="minimize-2" style="width:13px;height:13px;color:var(--text-muted);flex-shrink:0;"></i>
                      </div>
                      <div id="route-info"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- /wizard-layout -->

          <!-- Modals (fixed position - stay outside wizard) -->
          <!-- Modal: Finalizar Ruta (KM Final) -->
          <div id="end-route-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
            <div style="background:var(--bg-card); border-radius:12px; padding:24px; width:380px; max-width:90vw; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
              <h3 style="margin:0 0 16px 0; display:flex; align-items:center; gap:8px; color:var(--text);">
                <i data-lucide="flag" style="width:20px;height:20px;color:var(--danger);"></i> Finalizar Jornada
              </h3>
              <div style="background:var(--bg-hover); padding:12px; border-radius:8px; margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; font-size:13px;">
                  <span style="color:var(--text-muted);">KM Inicial:</span>
                  <strong id="end-route-start-km">0</strong>
                </div>
              </div>
              <div class="form-group" style="margin-bottom:12px;">
                <label style="font-weight:600; margin-bottom:4px; display:block;">Kilometraje Final</label>
                <input type="number" id="end-route-km-input" class="form-control" placeholder="Ej: 45120" min="0" style="font-size:16px; padding:10px;">
              </div>
              <div id="end-route-km-diff" style="text-align:center; padding:10px; background:var(--bg-hover); border-radius:8px; margin-bottom:16px; font-size:14px; color:var(--text-muted);">
                Ingresa el KM final para ver el recorrido
              </div>
              <div style="display:flex; gap:8px;">
                <button onclick="closeEndRouteModal()" class="btn btn-secondary" style="flex:1;">Cancelar</button>
                <button onclick="confirmEndRoute()" class="btn btn-primary" style="flex:1; background:var(--danger); border-color:var(--danger);">
                  <i data-lucide="flag" style="width:14px;height:14px;"></i> Finalizar
                </button>
              </div>
              <input type="hidden" id="end-route-id">
            </div>
          </div>

          <!-- Modal: Programar Ruta Optimizada (Multi-día) -->
          <div id="schedule-route-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
            <div style="background:var(--bg-card); border-radius:12px; padding:24px; width:440px; max-width:90vw; box-shadow:0 20px 60px rgba(0,0,0,0.3); max-height:80vh; overflow-y:auto;">
              <h3 style="margin:0 0 16px 0; display:flex; align-items:center; gap:8px; color:var(--text);">
                <i data-lucide="calendar-plus" style="width:20px;height:20px;color:var(--success);"></i> Programar Ruta
              </h3>
              <div style="background:var(--bg-hover); padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px;">
                <div><strong id="schedule-vendor-name">Vendedor</strong></div>
                <div style="color:var(--text-muted);" id="schedule-client-count">0 clientes en orden optimizado</div>
              </div>
              <!-- Multi-day: start date picker + summary -->
              <div id="schedule-multi-summary" style="display:none; margin-bottom:16px;">
                <div class="form-group" style="margin-bottom:12px;">
                  <label style="font-weight:600; margin-bottom:4px; display:block;">Iniciar desde</label>
                  <input type="date" id="schedule-multi-start-date" class="form-control" style="font-size:14px; padding:10px;" onchange="recalcMultiDayDates()">
                  <div style="font-size:11px; color:var(--text-muted); margin-top:4px;">Cambia la fecha de inicio y los días se ajustarán automáticamente (solo lunes a viernes)</div>
                </div>
                <table style="width:100%; font-size:12px; border-collapse:collapse;">
                  <thead>
                    <tr style="background:var(--bg-hover);">
                      <th style="padding:6px 8px; text-align:left; border-bottom:1px solid var(--border);">Fecha</th>
                      <th style="padding:6px 8px; text-align:center; border-bottom:1px solid var(--border);">Clientes</th>
                      <th style="padding:6px 8px; text-align:center; border-bottom:1px solid var(--border);">Distancia</th>
                      <th style="padding:6px 8px; text-align:center; border-bottom:1px solid var(--border);">Horas</th>
                    </tr>
                  </thead>
                  <tbody id="schedule-multi-tbody"></tbody>
                </table>
              </div>
              <!-- Single day fallback -->
              <div id="schedule-single-date" class="form-group" style="margin-bottom:16px;">
                <label style="font-weight:600; margin-bottom:4px; display:block;">Fecha de programación</label>
                <input type="date" id="schedule-route-date" class="form-control" style="font-size:14px; padding:10px;">
              </div>
              <div style="display:flex; gap:8px;">
                <button onclick="closeScheduleRouteModal()" class="btn btn-secondary" style="flex:1;">Cancelar</button>
                <button id="btn-confirm-schedule" onclick="confirmScheduleRoute()" class="btn btn-primary" style="flex:1; background:var(--success); border-color:var(--success); transition: transform 0.1s, opacity 0.15s;" onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
                  <i data-lucide="check" style="width:14px;height:14px;"></i> Programar Todo
                </button>
              </div>
            </div>
          </div>
        </div><!-- /route-subpanel-gestionar -->

        <!-- ============ SUBTAB 3: PLANNER SEMANAL ============ -->
        <div class="route-subpanel" id="route-subpanel-planner">
          <div class="card" id="weekly-planner-card">
            <div class="card-header" style="padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
              <h3 style="font-size: 15px; font-weight: 800; display: flex; align-items: center; gap: 8px; margin: 0;">
                <i data-lucide="calendar-range" style="width: 18px; height: 18px; color: var(--accent);"></i>
                Planificador Semanal
              </h3>
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <div class="week-nav">
                  <button onclick="navigateWeek(-1)" title="Semana anterior"><i data-lucide="chevron-left" style="width: 14px; height: 14px;"></i></button>
                  <span class="week-label" id="week-label">Semana actual</span>
                  <button onclick="navigateWeek(1)" title="Semana siguiente"><i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i></button>
                </div>
                <button class="btn" onclick="loadWeeklyAllExecs()" style="font-size: 11px; padding: 6px 12px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px;">
                  <i data-lucide="refresh-cw" style="width: 12px; height: 12px;"></i> Actualizar
                </button>
              </div>
            </div>
            <!-- Hidden controls for individual vendor operations -->
            <div id="planner-vendor-controls" style="display: none; padding: 8px 18px; border-bottom: 1px solid var(--border); background: var(--bg-hover);">
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <button class="btn" onclick="loadWeeklyAllExecs()" style="font-size: 11px; padding: 5px 12px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px;">
                  <i data-lucide="arrow-left" style="width: 12px; height: 12px;"></i> Todos los vendedores
                </button>
                <select id="schedule-vendor" style="display:none;"><option value="">--</option></select>
                <div style="position: relative; width: 280px;">
                  <input type="text" id="planner-vendor-search" class="form-control" placeholder="Buscar vendedor..."
                    style="font-size: 13px; padding: 7px 12px; padding-right: 28px; cursor: pointer;"
                    onfocus="openPlannerVendorDropdown()" oninput="filterPlannerVendorDropdown(this.value)" autocomplete="off" />
                  <i data-lucide="chevron-down" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--text-muted);pointer-events:none;"></i>
                  <div id="planner-vendor-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);max-height:340px;overflow-y:auto;z-index:999;margin-top:4px;">
                    <div id="planner-vendor-dropdown-list"></div>
                  </div>
                </div>
                <button class="btn btn-primary" onclick="generateWeeklySchedule()" style="font-size: 11px; padding: 6px 14px;">
                  <i data-lucide="calendar-plus" style="width: 12px; height: 12px;"></i> Generar Ruta
                </button>
                <button class="btn" onclick="loadExistingSchedule()" style="font-size: 11px; padding: 6px 14px; background: var(--bg-primary); border: 1px solid var(--border);">
                  <i data-lucide="download" style="width: 12px; height: 12px;"></i> Cargar
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Alerts section (admin only) -->
              <div id="route-alerts-section" style="display: none; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <h4 style="font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                    <i data-lucide="bell" style="width: 16px; height: 16px; color: #f59e0b;"></i> Alertas de Rutas
                    <span id="alerts-count-badge" class="badge" style="background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; display: none;">0</span>
                  </h4>
                  <button onclick="markAllRouteAlertsRead()" style="font-size: 11px; background: none; border: none; color: var(--accent); cursor: pointer; text-decoration: underline;">
                    Marcar todas como leídas
                  </button>
                </div>
                <div id="route-alerts-list" style="max-height: 200px; overflow-y: auto;"></div>
              </div>

              <div id="schedule-result" style="min-height: 100px;">
                <div class="empty-state" style="padding: 32px;">
                  <div style="width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(16,185,129,0.1));display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                    <i data-lucide="calendar-range" style="width: 28px; height: 28px; color: var(--accent);"></i>
                  </div>
                  <p style="font-size: 14px; font-weight: 600; margin-bottom: 6px;">Cargando planificador...</p>
                  <p style="font-size: 12px; color: var(--text-muted); max-width: 360px; margin: 0 auto;">Aquí verás el resumen semanal de todos los vendedores con sus rutas programadas</p>
                </div>
              </div>
              <!-- Hidden date inputs for week tracking -->
              <input type="hidden" id="schedule-start" value="">
              <input type="hidden" id="schedule-end" value="">
            </div>
          </div>
        </div><!-- /route-subpanel-planner -->

        <!-- ============ SUBTAB 4: CALENDARIO MENSUAL ============ -->
        <div class="route-subpanel" id="route-subpanel-monthly">
          <div class="card">
            <div class="card-header" style="padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
              <h3 style="font-size: 15px; font-weight: 800; display: flex; align-items: center; gap: 8px; margin: 0;">
                <i data-lucide="calendar" style="width: 18px; height: 18px; color: var(--accent);"></i>
                Calendario Mensual
                <span id="monthly-subtitle" style="font-size: 11px; font-weight: 500; color: var(--text-muted); margin-left: 4px;">Todos los Vendedores</span>
              </h3>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="month-nav">
                  <button onclick="navigateMonth(-1)" title="Mes anterior">&lsaquo;</button>
                  <span class="month-label" id="monthly-label">Febrero 2026</span>
                  <button onclick="navigateMonth(1)" title="Mes siguiente">&rsaquo;</button>
                </div>
                <button class="btn" onclick="loadMonthlyCalendar()" style="font-size: 11px; padding: 6px 12px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px;">
                  <i data-lucide="refresh-cw" style="width: 12px; height: 12px;"></i> Actualizar
                </button>
              </div>
            </div>
            <div class="card-body" style="padding: 16px;">
              <div id="monthly-exec-legend" class="exec-legend"></div>
              <div id="monthly-totals"></div>
              <div id="monthly-calendar-container">
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                  <i data-lucide="calendar" style="width: 32px; height: 32px; margin-bottom: 8px;"></i>
                  <div>Cargando calendario...</div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- /route-subpanel-monthly -->

      </div><!-- /panel-routes -->

      <!-- Visits Panel -->
      <div class="panel" id="panel-visits">
        <!-- Executive Header for Visits -->
        <div class="card" style="margin-bottom: 20px; background: #059669;">
          <div class="card-body" style="padding: 16px 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
              <div style="color: white;">
                <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Panel de Visitas</div>
                <div style="font-size: 20px; font-weight: 700;">Registro de Check-in</div>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <select id="visit-executive-filter" class="form-control" style="width: 250px; max-width: 100%; background: rgba(255,255,255,0.95); border: none;" onchange="filterVisitsByExecutive()">
                  <option value="">-- Seleccionar Vendedor --</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3><i data-lucide="user-check" style="width: 18px; height: 18px;"></i> Registrar Visita</h3>
              <span id="visit-route-status" class="badge" style="display: none;"></span>
            </div>
            <div class="card-body">
              <form id="form-checkin">
                <div class="form-group">
                  <label>Ruta Activa del Vendedor</label>
                  <select id="checkin-route" class="form-control" required onchange="onRouteSelected()">
                    <option value="">-- Selecciona un vendedor arriba --</option>
                  </select>
                  <small id="route-info-text" style="color: var(--text-muted); font-size: 11px; display: none;"></small>
                </div>
                <div class="form-group">
                  <label>Buscar Cliente <span id="client-count-label" style="font-size: 11px; color: var(--text-muted);"></span></label>
                  <div style="position: relative;">
                    <input type="text" id="checkin-client-search" class="form-control" placeholder="Escribe código, nombre o nombre fantasía..." oninput="filterCheckinClients()" autocomplete="off" style="padding-left: 36px;">
                    <i data-lucide="search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted);"></i>
                  </div>
                  <div id="client-search-results" style="margin-top: 8px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; display: none;">
                  </div>
                  <input type="hidden" id="checkin-client" required>
                  <div id="selected-client-card" style="display: none; margin-top: 8px; padding: 12px; background: var(--bg-hover); border-radius: 8px; border: 1px solid var(--accent);">
                  </div>
                </div>

                <!-- Verificación de dirección -->
                <div id="address-verification" style="display: none; margin-bottom: 16px;">
                  <div style="padding: 12px; border-radius: 8px; background: var(--bg-hover); border: 1px solid var(--border);">
                    <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                      <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
                      Verificar Dirección
                    </div>

                    <!-- Dirección actual del cliente -->
                    <div id="client-current-address" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                      <strong>Dirección registrada:</strong>
                      <span id="client-address-text">-</span>
                    </div>

                    <!-- Comparación de distancia -->
                    <div id="distance-check" style="display: none; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 12px;">
                    </div>

                    <!-- Checkbox para corregir -->
                    <div style="margin-bottom: 10px;">
                      <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                        <input type="checkbox" id="correct-address-check" onchange="toggleAddressCorrection()">
                        <span>La dirección es incorrecta, quiero corregirla</span>
                      </label>
                    </div>

                    <!-- Campo de corrección de dirección -->
                    <div id="address-correction-fields" style="display: none;">
                      <div class="form-group" style="margin-bottom: 8px;">
                        <label style="font-size: 12px;">Buscar dirección correcta</label>
                        <input type="text" id="address-search" class="form-control" placeholder="Escribe la dirección..." style="font-size: 13px;">
                      </div>
                      <div class="form-group" style="margin-bottom: 8px;">
                        <label style="font-size: 12px;">Comuna</label>
                        <input type="text" id="address-commune" class="form-control" placeholder="Comuna" style="font-size: 13px;">
                      </div>
                      <div style="display: flex; gap: 8px; font-size: 11px; color: var(--text-muted);">
                        <span>Lat: <span id="new-lat">-</span></span>
                        <span>Lng: <span id="new-lng">-</span></span>
                      </div>
                      <button type="button" class="btn btn-secondary" onclick="useCurrentGpsLocation()" style="margin-top: 8px; font-size: 12px; padding: 6px 12px;">
                        <i data-lucide="crosshair" style="width: 12px; height: 12px;"></i>
                        Usar mi ubicación actual
                      </button>
                      <div id="address-map-picker" style="height: 300px; border-radius: 8px; margin-top: 12px; border: 1px solid var(--border); display: none;"></div>
                    </div>
                  </div>
                </div>

                <!-- Checklist de Visita -->
                <div id="checklist-panel" class="checklist-panel" style="display: none;">
                  <div style="font-weight: 700; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="clipboard-check" style="width: 18px; height: 18px; color: var(--accent);"></i>
                    Checklist de Visita
                  </div>

                  <!-- 1. Cobranzas -->
                  <div class="checklist-item" id="checklist-cobranzas">
                    <input type="checkbox" id="chk-cobranzas" onchange="updateChecklistState()">
                    <div style="flex: 1;">
                      <div class="checklist-item-label">Cobranzas</div>
                      <div class="checklist-item-detail" id="chk-cobranzas-detail">Verificar facturas vencidas o próximas a vencer</div>
                    </div>
                  </div>

                  <!-- 2. Última compra -->
                  <div class="checklist-item" id="checklist-compra">
                    <input type="checkbox" id="chk-compra" onchange="updateChecklistState()">
                    <div style="flex: 1;">
                      <div class="checklist-item-label">Última Compra</div>
                      <div class="checklist-item-detail" id="chk-compra-detail">Verificar mes de última compra del cliente</div>
                    </div>
                  </div>

                  <!-- 3. Última visita -->
                  <div class="checklist-item" id="checklist-visita">
                    <input type="checkbox" id="chk-visita" onchange="updateChecklistState()">
                    <div style="flex: 1;">
                      <div class="checklist-item-label">Última Visita</div>
                      <div class="checklist-item-detail" id="chk-visita-detail">Verificar fecha de última visita registrada</div>
                    </div>
                  </div>

                  <!-- Ficha del cliente (editable) -->
                  <div style="margin-top: 12px; padding: 12px; background: var(--bg-hover); border-radius: 8px;">
                    <div style="font-weight: 600; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; color: var(--text-muted);">Ficha del Cliente</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                      <div>
                        <label style="font-size: 11px; color: var(--text-muted);">Dueño</label>
                        <input type="text" id="chk-owner" class="form-control" placeholder="Nombre dueño" style="font-size: 12px; padding: 6px 10px;">
                      </div>
                      <div>
                        <label style="font-size: 11px; color: var(--text-muted);">Comprador</label>
                        <input type="text" id="chk-buyer" class="form-control" placeholder="Nombre comprador" style="font-size: 12px; padding: 6px 10px;">
                      </div>
                      <div>
                        <label style="font-size: 11px; color: var(--text-muted);">Teléfono 1</label>
                        <input type="text" id="chk-phone" class="form-control" placeholder="Teléfono" style="font-size: 12px; padding: 6px 10px;">
                      </div>
                      <div>
                        <label style="font-size: 11px; color: var(--text-muted);">Teléfono 2</label>
                        <input type="text" id="chk-phone2" class="form-control" placeholder="Teléfono 2" style="font-size: 12px; padding: 6px 10px;">
                      </div>
                      <div>
                        <label style="font-size: 11px; color: var(--text-muted);">Email</label>
                        <input type="email" id="chk-email" class="form-control" placeholder="correo@email.com" style="font-size: 12px; padding: 6px 10px;">
                      </div>
                      <div>
                        <label style="font-size: 11px; color: var(--text-muted);">Segmentación</label>
                        <select id="chk-segmentation" class="form-control" style="font-size: 12px; padding: 6px 10px;">
                          <option value="N">N (Nuevo)</option>
                          <option value="L">L (Con ventas)</option>
                          <option value="80-20">80-20 (Clave)</option>
                        </select>
                      </div>
                    </div>
                    <div style="margin-top: 8px;">
                      <label style="font-size: 11px; color: var(--text-muted);">Observaciones</label>
                      <textarea id="chk-observations" class="form-control" rows="2" placeholder="Observaciones de la visita..." style="font-size: 12px; padding: 6px 10px;"></textarea>
                    </div>

                    <!-- Competencia -->
                    <div style="margin-top: 10px; padding: 10px; background: var(--bg-card); border-radius: 6px; border: 1px solid var(--border);">
                      <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">Competencia</div>
                      <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 6px; cursor: pointer;">
                        <input type="checkbox" id="chk-is-competitor" style="width: 16px; height: 16px;">
                        <span>Compra a proveedor competencia</span>
                      </label>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <input type="text" id="chk-competitor1" class="form-control" placeholder="Proveedor 1" style="font-size: 11px; padding: 5px 8px;">
                        <input type="text" id="chk-competitor2" class="form-control" placeholder="Proveedor 2" style="font-size: 11px; padding: 5px 8px;">
                      </div>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="saveClientProfile()" style="margin-top: 10px; font-size: 12px; padding: 6px 14px; width: 100%;">
                      <i data-lucide="save" style="width: 14px; height: 14px;"></i> Guardar Ficha
                    </button>
                  </div>
                </div>

                <div class="form-group">
                  <label>Resultado de Visita</label>
                  <select id="checkin-outcome" class="form-control">
                    <option value="pending">Pendiente</option>
                    <option value="contacted">Contactado</option>
                    <option value="no_contact">Sin Contacto</option>
                    <option value="sale">Venta Realizada</option>
                  </select>
                </div>
                <div id="gps-status" style="padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 13px; display: flex; align-items: center; gap: 8px; background: var(--bg-hover);">
                  <i data-lucide="loader-2" class="spin" style="width: 16px; height: 16px; color: var(--text-muted);"></i>
                  <span>Obteniendo ubicación GPS...</span>
                </div>
                <div id="checklist-warning" style="display: none; padding: 8px 12px; border-radius: 8px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: #d97706; font-size: 12px; margin-bottom: 12px;">
                  <i data-lucide="alert-triangle" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                  Completa los 3 puntos del checklist antes de registrar el check-in
                </div>
                <button type="submit" class="btn btn-success btn-block" id="btn-checkin-submit">
                  <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
                  Registrar Check-in con GPS
                </button>
              </form>
              <div class="response-box" id="response-checkin" style="display: none;"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="clock" style="width: 18px; height: 18px;"></i> Visitas de Hoy</h3>
            </div>
            <div class="card-body">
              <div class="visit-list" id="today-visits">
                <div class="empty-state">
                  <i data-lucide="clipboard" style="width: 48px; height: 48px;"></i>
                  <p>No hay visitas registradas hoy</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CRM Panel -->
      <div class="panel" id="panel-crm">
        <!-- Header -->
        <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);">
          <div class="card-body" style="padding: 16px 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div style="color: white;">
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7;">Gestión Comercial</div>
                <div style="font-size: 20px; font-weight: 700;">Logística CRM</div>
              </div>
              <div id="crm-stats-bar" style="display: flex; gap: 16px; flex-wrap: wrap;">
                <!-- populated by renderCrmPanel() -->
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-body" style="padding: 12px 16px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
              <div style="position: relative; flex: 1; min-width: 180px;">
                <i data-lucide="search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 15px; height: 15px; color: var(--text-muted);"></i>
                <input id="crm-search" type="text" class="form-control" placeholder="Buscar por código, nombre..." style="padding-left: 32px;" oninput="filterCrmClients()">
              </div>
              <select id="crm-vendor-filter" class="form-control" style="max-width: 180px; font-size: 13px;" onchange="filterCrmClients()">
                <option value="">Todos los vendedores</option>
              </select>
              <select id="crm-zone-filter" class="form-control" style="max-width: 150px; font-size: 13px;" onchange="filterCrmClients()">
                <option value="">Todas las zonas</option>
              </select>
              <select id="crm-seg-filter" class="form-control" style="max-width: 150px; font-size: 13px;" onchange="filterCrmClients()">
                <option value="">Toda segmentación</option>
                <option value="80-20">⭐ 80/20 Clave</option>
                <option value="L">L Con ventas</option>
                <option value="N">N Nuevos</option>
              </select>
              <select id="crm-gps-filter" class="form-control" style="max-width: 120px; font-size: 13px;" onchange="filterCrmClients()">
                <option value="">Todo GPS</option>
                <option value="has">Con GPS</option>
                <option value="none">Sin GPS</option>
              </select>
              <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;" onclick="resetCrmFilters()">
                <i data-lucide="x" style="width: 13px; height: 13px;"></i> Limpiar
              </button>
              <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;" onclick="exportCrmCsv()">
                <i data-lucide="download" style="width: 13px; height: 13px;"></i> CSV
              </button>
              <span id="crm-count-label" style="font-size: 12px; color: var(--text-muted); white-space: nowrap;"></span>
            </div>
          </div>
        </div>

        <!-- Client Table -->
        <div class="card">
          <div class="card-body" style="padding: 0;">
            <div style="overflow-x: auto;">
              <table class="data-table" id="crm-clients-table">
                <thead>
                  <tr>
                    <th style="width: 90px;">Código</th>
                    <th>Cliente</th>
                    <th>Dirección / Comuna</th>
                    <th style="width: 110px;">Zona</th>
                    <th style="width: 150px;">Vendedor</th>
                    <th style="width: 90px;">Segment.</th>
                    <th style="width: 80px;">GPS</th>
                    <th style="width: 90px;">Acciones</th>
                  </tr>
                </thead>
                <tbody id="crm-clients-body">
                  <tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:40px;">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
            <div id="crm-pagination" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-top: 1px solid var(--border); font-size: 13px; color: var(--text-muted);">
            </div>
          </div>
        </div>
      </div>

      <!-- Intelligence Panel -->
      <div class="panel" id="panel-intelligence">
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="webhook" style="width: 18px; height: 18px;"></i> Simular Webhook n8n</h3>
            </div>
            <div class="card-body">
              <form id="form-webhook">
                <div class="form-group">
                  <label>Producto (SKU)</label>
                  <select id="webhook-product" class="form-control" required></select>
                </div>
                <div class="form-group">
                  <label>Competidor</label>
                  <input type="text" id="webhook-competitor" class="form-control" value="Sodimac" required>
                </div>
                <div class="form-group">
                  <label>Precio Detectado ($)</label>
                  <input type="number" id="webhook-price" class="form-control" value="39990" required>
                </div>
                <button type="submit" class="btn btn-purple btn-block">
                  <i data-lucide="send" style="width: 16px; height: 16px;"></i>
                  Enviar Precio
                </button>
              </form>
              <div class="response-box" id="response-webhook" style="display: none;"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i> Comparativa de Precios</h3>
            </div>
            <div class="card-body">
              <div class="form-group">
                <label>Seleccionar Producto</label>
                <select id="compare-product" class="form-control" onchange="loadComparison()"></select>
              </div>
              <div id="comparison-result"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <h3><i data-lucide="history" style="width: 18px; height: 18px;"></i> Historial de Precios</h3>
          </div>
          <div class="table-wrapper">
            <table id="table-prices">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Competidor</th>
                  <th>Precio</th>
                  <th>Fuente</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Comparativo de Competencia (n8n) -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header" style="cursor: pointer;" onclick="toggleComparativoPanel()">
            <h3><i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i> Comparativo de Competencia</h3>
            <i data-lucide="chevron-down" id="comparativo-toggle-icon" style="width: 18px; height: 18px;"></i>
          </div>
          <div class="card-body" id="comparativo-panel" style="display: none;">
            <!-- Header con estadísticas -->
            <div class="responsive-grid-4" style="gap: 10px; margin-bottom: 16px;">
              <div style="background: var(--bg-hover); border-radius: 6px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: #3b82f6;" id="comp-total-products">-</div>
                <div style="font-size: 11px; color: var(--text-muted);">Productos Monitoreados</div>
              </div>
              <div style="background: var(--bg-hover); border-radius: 6px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: #059669;" id="comp-sources">-</div>
                <div style="font-size: 11px; color: var(--text-muted);">Fuentes</div>
              </div>
              <div style="background: var(--bg-hover); border-radius: 6px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: #f97316;" id="comp-avg-price">-</div>
                <div style="font-size: 11px; color: var(--text-muted);">Precio Promedio</div>
              </div>
              <div style="background: var(--bg-hover); border-radius: 6px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; font-weight: 700; color: #7c3aed;" id="comp-last-update">-</div>
                <div style="font-size: 11px; color: var(--text-muted);">Última Actualización</div>
              </div>
            </div>

            <!-- Gráfico de precios por fuente -->
            <div style="margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0;">
                  <i data-lucide="trending-up" style="width: 16px; height: 16px; color: #3b82f6;"></i>
                  Comparativo de Precios por Fuente
                </h4>
                <button class="btn btn-secondary" onclick="loadComparativoData()" style="font-size: 11px; padding: 4px 10px;">
                  <i data-lucide="refresh-cw" style="width: 12px; height: 12px;"></i> Actualizar
                </button>
              </div>
              <div id="comparativo-chart" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 20px; min-height: 300px;">
                <div style="display: flex; align-items: center; justify-content: center; height: 260px; color: var(--text-muted); font-size: 13px;">
                  <div style="text-align: center;">
                    <i data-lucide="bar-chart-2" style="width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                    <p>Cargando datos del comparativo...</p>
                    <p style="font-size: 11px;">Los datos se actualizan cada lunes desde n8n</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabla de comparativo por fuente -->
            <div style="margin-bottom: 24px;">
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="table-2" style="width: 16px; height: 16px; color: #059669;"></i>
                Detalle por Fuente
              </h4>
              <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                <table id="comparativo-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                  <thead>
                    <tr style="background: var(--bg-hover);">
                      <th style="padding: 12px; text-align: left; font-weight: 600;">Fuente</th>
                      <th style="padding: 12px; text-align: center; font-weight: 600;">Productos</th>
                      <th style="padding: 12px; text-align: right; font-weight: 600;">Precio Mín</th>
                      <th style="padding: 12px; text-align: right; font-weight: 600;">Precio Prom</th>
                      <th style="padding: 12px; text-align: right; font-weight: 600;">Precio Máx</th>
                    </tr>
                  </thead>
                  <tbody id="comparativo-table-body">
                    <tr>
                      <td colspan="5" style="padding: 40px; text-align: center; color: var(--text-muted);">
                        Sin datos. Ejecuta el workflow n8n "LEKER v32 - STOCKS FIX" para obtener datos.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Lista de productos por fuente -->
            <div>
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="package" style="width: 16px; height: 16px; color: #7c3aed;"></i>
                Productos por Fuente
              </h4>
              <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;" id="comparativo-source-filters">
                <button class="btn btn-primary" data-source="all" onclick="filterComparativoBySource('all')" style="font-size: 11px; padding: 6px 12px;">
                  Todas
                </button>
              </div>
              <div id="comparativo-products-list" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; max-height: 400px; overflow-y: auto;">
                <div style="padding: 40px; text-align: center; color: var(--text-muted); font-size: 12px;">
                  Selecciona una fuente para ver sus productos
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Panel -->
      <div class="panel" id="panel-data">
        <!-- Sub-navigation tabs -->
        <div class="data-tabs" style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid var(--border); padding-bottom: 12px;">
          <button class="data-tab active" data-subtab="vendedores" onclick="switchDataTab('vendedores')">
            <i data-lucide="users" style="width: 16px; height: 16px;"></i>
            Vendedores
            <span class="badge badge-active" id="tab-users-count">0</span>
          </button>
          <button class="data-tab" data-subtab="vehiculos" onclick="switchDataTab('vehiculos')">
            <i data-lucide="truck" style="width: 16px; height: 16px;"></i>
            Vehículos
            <span class="badge badge-active" id="tab-vehicles-count">0</span>
          </button>
          <button class="data-tab" data-subtab="clientes" onclick="switchDataTab('clientes')">
            <i data-lucide="building-2" style="width: 16px; height: 16px;"></i>
            Clientes
            <span class="badge badge-active" id="tab-clients-count">0</span>
          </button>
          <button class="data-tab" data-subtab="productos" onclick="switchDataTab('productos')">
            <i data-lucide="package" style="width: 16px; height: 16px;"></i>
            Productos
            <span class="badge badge-active" id="tab-products-count">0</span>
          </button>
        </div>

        <!-- ==================== VENDEDORES ==================== -->
        <div class="data-subpanel active" id="subpanel-vendedores">
          <!-- Header con stats -->
          <div class="responsive-grid-4" style="gap: 10px; margin-bottom: 16px;">
            <div class="card" style="text-align: center; padding: 12px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--primary);" id="stat-exec-total">0</div>
              <div style="font-size: 11px; color: var(--text-muted);">Total Vendedores</div>
            </div>
            <div class="card" style="text-align: center; padding: 12px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="stat-exec-active">0</div>
              <div style="font-size: 11px; color: var(--text-muted);">Activos Hoy</div>
            </div>
            <div class="card" style="text-align: center; padding: 12px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--warning);" id="stat-exec-clients">0</div>
              <div style="font-size: 11px; color: var(--text-muted);">Clientes Asignados</div>
            </div>
            <div class="card" style="text-align: center; padding: 12px;">
              <div style="font-size: 20px; font-weight: 700; color: var(--accent);" id="stat-exec-unassigned">0</div>
              <div style="font-size: 11px; color: var(--text-muted);">Sin Asignar</div>
            </div>
          </div>

          <!-- Agregar Vendedor (colapsable) -->
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header" style="cursor: pointer;" onclick="toggleAddUserForm()">
              <h3><i data-lucide="user-plus" style="width: 18px; height: 18px;"></i> Agregar Nuevo Vendedor</h3>
              <i data-lucide="chevron-down" id="add-user-chevron" style="width: 18px; height: 18px; transition: transform 0.2s;"></i>
            </div>
            <div class="card-body" id="add-user-form-body" style="display: none;">
              <form id="form-add-user" style="display: grid; grid-template-columns: 1fr 1fr auto auto auto; gap: 12px; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Nombre Completo</label>
                  <input type="text" id="user-name" class="form-control" placeholder="Ej: Juan Pérez" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Email</label>
                  <input type="email" id="user-email" class="form-control" placeholder="juan.perez@leker.cl" required>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Rol</label>
                  <select id="user-role" class="form-control">
                    <option value="executive">Vendedor</option>
                    <option value="zonal">Zonal</option>
                    <option value="admin">Administrador</option>
                  </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label>Zona</label>
                  <select id="user-zone" class="form-control">
                    <option value="">Sin zona</option>
                    <option value="Norte">Norte</option>
                    <option value="Centro">Centro</option>
                    <option value="Centro Sur">Centro Sur</option>
                    <option value="Sur">Sur</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                  Agregar
                </button>
              </form>
            </div>
          </div>

          <!-- Lista de Vendedores por Zona -->
          <div class="card">
            <div class="card-header" style="flex-direction: column; align-items: stretch; gap: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i data-lucide="users" style="width: 18px; height: 18px;"></i> Vendedores por Zona</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <select id="filter-user-zone" class="form-control" style="max-width: 150px; width:100%; padding: 6px 10px; font-size: 12px;" onchange="filterUsers()">
                    <option value="">Todas las zonas</option>
                    <option value="Zona Norte">Zona Norte</option>
                    <option value="Zona Centro">Zona Centro</option>
                    <option value="Zona Centro Sur">Zona Centro Sur</option>
                    <option value="Zona Sur">Zona Sur</option>
                    <option value="sin_zona">Sin Zona</option>
                  </select>
                  <select id="filter-user-role" class="form-control" style="max-width: 150px; width:100%; padding: 6px 10px; font-size: 12px;" onchange="filterUsers()">
                    <option value="">Todos los roles</option>
                    <option value="executive">Solo Vendedores</option>
                    <option value="admin">Solo Admins</option>
                    <option value="zonal">Solo Zonales</option>
                  </select>
                  <span class="badge badge-active" id="users-count">0</span>
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <input type="text" id="search-users" class="form-control" placeholder="Buscar por nombre o email..." oninput="filterUsers()" style="flex: 1;">
                <button class="btn btn-primary" onclick="openReassignModal()" style="padding: 6px 14px; font-size: 12px; white-space: nowrap;">
                  <i data-lucide="arrow-left-right" style="width: 14px; height: 14px;"></i> Reasignar
                </button>
              </div>
            </div>
            <div id="vendors-by-zone-container" style="max-height: 600px; overflow-y: auto;">
              <table id="table-users" style="table-layout: fixed;">
                <colgroup>
                  <col style="width: 22%;">
                  <col style="width: 25%;">
                  <col style="width: 10%;">
                  <col style="width: 10%;">
                  <col style="width: 10%;">
                  <col style="width: 23%;">
                </colgroup>
                <thead>
                  <tr>
                    <th>Vendedor</th>
                    <th>Zona / Comunas</th>
                    <th style="text-align: center;">Clientes</th>
                    <th style="text-align: center;">Hoy</th>
                    <th style="text-align: center;">Estado</th>
                    <th style="text-align: center;">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- ==================== REASIGNACIÓN DE CLIENTES ==================== -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header" style="background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(245,158,11,0.05) 100%); border-bottom: 2px solid var(--accent);">
              <div>
                <h3 style="display: flex; align-items: center; gap: 8px; color: var(--accent);">
                  <i data-lucide="arrow-left-right" style="width: 20px; height: 20px;"></i>
                  Reasignación de Clientes
                </h3>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                  Transfiere clientes de un vendedor a otro de forma visual
                </div>
              </div>
            </div>
            <div class="card-body" style="padding: 24px;">
              <!-- Selectores de Vendedores -->
              <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start; margin-bottom: 24px;">
                <!-- Vendedor Origen -->
                <div>
                  <label style="font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
                    <i data-lucide="user-minus" style="width: 14px; height: 14px; color: var(--danger);"></i>
                    Vendedor Origen
                  </label>
                  <select id="reassign-section-from" class="form-control" onchange="loadOriginClients()" style="font-size: 13px;">
                    <option value="">Seleccionar vendedor...</option>
                  </select>
                  <div id="origin-info" style="margin-top: 8px; font-size: 11px; color: var(--text-muted); display: none;">
                    <span id="origin-client-total">0</span> clientes asignados
                  </div>
                </div>
                <!-- Flecha Central -->
                <div style="display: flex; align-items: center; justify-content: center; padding-top: 28px;">
                  <div style="background: linear-gradient(135deg, var(--accent) 0%, var(--success) 100%); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(59,130,246,0.3);">
                    <i data-lucide="arrow-right" style="width: 22px; height: 22px; color: white;"></i>
                  </div>
                </div>
                <!-- Vendedor Destino -->
                <div>
                  <label style="font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 4px;">
                    <i data-lucide="user-plus" style="width: 14px; height: 14px; color: var(--success);"></i>
                    Vendedor Destino
                  </label>
                  <select id="reassign-section-to" class="form-control" onchange="updateSectionPreview()" style="font-size: 13px;">
                    <option value="">Seleccionar vendedor...</option>
                  </select>
                  <div id="dest-info" style="margin-top: 8px; font-size: 11px; color: var(--text-muted); display: none;">
                    <span id="dest-client-total">0</span> clientes actuales
                  </div>
                </div>
              </div>

              <!-- Panel de Clientes (Dos Columnas) -->
              <div id="reassign-section-panels" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                  <!-- Panel Izquierdo: Clientes del Origen -->
                  <div style="border: 2px solid var(--border); border-radius: 8px; overflow: hidden;">
                    <div style="background: rgba(239,68,68,0.06); padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                      <div style="font-weight: 600; font-size: 13px;">Clientes a Transferir</div>
                      <label style="font-size: 12px; display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="section-select-all" onchange="sectionToggleAll(this.checked)" style="width: 16px; height: 16px; cursor: pointer;">
                        Todos
                      </label>
                    </div>
                    <div id="section-origin-list" style="max-height: 400px; overflow-y: auto; padding: 8px;">
                      <div style="padding: 30px; text-align: center; color: var(--text-muted); font-size: 12px;">Selecciona un vendedor origen</div>
                    </div>
                  </div>
                  <!-- Panel Derecho: Preview -->
                  <div style="border: 2px solid var(--border); border-radius: 8px; overflow: hidden;">
                    <div style="background: rgba(16,185,129,0.06); padding: 10px 16px; border-bottom: 1px solid var(--border);">
                      <div style="font-weight: 600; font-size: 13px;">Vista Previa: Recibe</div>
                      <div id="section-preview-count" style="font-size: 11px; color: var(--text-muted);">0 seleccionados</div>
                    </div>
                    <div id="section-dest-list" style="max-height: 400px; overflow-y: auto; padding: 8px;">
                      <div style="display: flex; flex-direction: column; align-items: center; padding: 40px 20px; text-align: center; color: var(--text-muted);">
                        <i data-lucide="inbox" style="width: 40px; height: 40px; opacity: 0.2; margin-bottom: 8px;"></i>
                        <div style="font-size: 12px;">Selecciona clientes de la izquierda</div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Botones -->
                <div style="display: flex; justify-content: center; gap: 12px; padding-top: 16px; border-top: 1px solid var(--border);">
                  <button id="btn-section-reassign" class="btn btn-primary" onclick="executeSectionReassign()" disabled style="padding: 10px 32px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i>
                    Confirmar Reasignación
                  </button>
                  <button class="btn btn-secondary" onclick="resetSectionReassign()" style="padding: 10px 24px; font-size: 14px;">
                    <i data-lucide="x" style="width: 16px; height: 16px;"></i> Limpiar
                  </button>
                </div>
              </div>

              <!-- Estado Vacío -->
              <div id="reassign-section-empty" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                <i data-lucide="arrow-right-left" style="width: 56px; height: 56px; opacity: 0.15; margin-bottom: 12px;"></i>
                <div style="font-size: 14px; font-weight: 500;">Selecciona los vendedores para comenzar</div>
                <div style="font-size: 12px; margin-top: 4px;">Elige un vendedor origen y un destino para ver sus clientes</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== VEHÍCULOS ==================== -->
        <div class="data-subpanel" id="subpanel-vehiculos">
          <div class="grid-2">
            <!-- Agregar Vehículo -->
            <div class="card">
              <div class="card-header">
                <h3><i data-lucide="car" style="width: 18px; height: 18px;"></i> Agregar Vehículo</h3>
              </div>
              <div class="card-body">
                <form id="form-add-vehicle">
                  <div class="form-group">
                    <label>Patente</label>
                    <input type="text" id="vehicle-plate" class="form-control" placeholder="Ej: ABCD-12" required>
                  </div>
                  <div class="form-group">
                    <label>Modelo</label>
                    <input type="text" id="vehicle-model" class="form-control" placeholder="Ej: Fiat Fiorino 2024" required>
                  </div>
                  <div class="form-group">
                    <label>Rendimiento (Km/L)</label>
                    <input type="number" id="vehicle-efficiency" class="form-control" value="12" step="0.1" required>
                  </div>
                  <button type="submit" class="btn btn-primary btn-block">
                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                    Agregar Vehículo
                  </button>
                </form>
              </div>
            </div>

            <!-- Lista de Vehículos -->
            <div class="card">
              <div class="card-header" style="flex-direction: column; align-items: stretch; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <h3><i data-lucide="truck" style="width: 18px; height: 18px;"></i> Lista de Vehículos</h3>
                  <span class="badge badge-active" id="vehicles-count">0</span>
                </div>
                <input type="text" id="search-vehicles" class="form-control" placeholder="Buscar por patente o modelo..." oninput="filterVehicles()">
              </div>
              <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                <table id="table-vehicles">
                  <thead>
                    <tr>
                      <th>Patente</th>
                      <th>Modelo</th>
                      <th>Km/L</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== CLIENTES ==================== -->
        <div class="data-subpanel" id="subpanel-clientes">
          <!-- Importar Excel -->
          <div class="card" style="margin-bottom: 24px; border: 2px dashed var(--accent); background: rgba(59, 130, 246, 0.03);">
            <div class="card-header">
              <h3><i data-lucide="file-spreadsheet" style="width: 18px; height: 18px;"></i> Importar desde Excel</h3>
            </div>
            <div class="card-body">
              <div style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 250px; margin-bottom: 0;">
                  <label>Archivo Excel (.xlsx, .xls)</label>
                  <input type="file" id="file-clients" class="form-control" accept=".xlsx,.xls" style="padding: 10px;">
                </div>
                <button class="btn btn-primary" onclick="uploadClientsExcel()" style="height: 48px; padding: 0 24px;">
                  <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                  Importar Clientes
                </button>
              </div>
              <div id="upload-result" style="margin-top: 16px; display: none;"></div>
              <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
                <strong>Columnas:</strong> Código, Razón Social, Nombre Fantasía, Dirección, Comuna, Segmento (A/B/C/D/E), Prioridad (FOCO/Normal)
              </div>
            </div>
          </div>

          <!-- Lista de Clientes -->
          <div class="card">
            <div class="card-header" style="flex-direction: column; align-items: stretch; gap: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i data-lucide="building-2" style="width: 18px; height: 18px;"></i> Lista de Clientes</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <span class="badge badge-active" id="clients-count">0</span>
                  <button class="btn btn-primary" onclick="openClientModal()" style="padding: 6px 12px; font-size: 13px;">
                    <i data-lucide="plus" style="width: 14px; height: 14px;"></i> Nuevo
                  </button>
                </div>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <input type="text" id="search-clients" class="form-control" placeholder="Buscar por código o nombre..." oninput="filterClients()" style="flex: 1; min-width: 200px;">
                <select id="filter-zone" class="form-control" onchange="filterClients()" style="max-width: 160px; width:100%;">
                  <option value="">Todas las zonas</option>
                </select>
                <select id="filter-segment" class="form-control" onchange="filterClients()" style="max-width: 130px; width:100%;">
                  <option value="">Segmento</option>
                  <option value="A">A - 80/20 Top</option>
                  <option value="B">B - Con dirección</option>
                  <option value="C">C - Con vendedor</option>
                  <option value="D">D - Potencial</option>
                  <option value="E">E - Sin dirección</option>
                </select>
                <select id="filter-segmentation" class="form-control" onchange="filterClients()" style="max-width: 130px; width:100%;">
                  <option value="">Segmentación</option>
                  <option value="80-20">80-20 (Clave)</option>
                  <option value="L">L (Con ventas)</option>
                  <option value="N">N (Nuevos)</option>
                </select>
                <select id="filter-priority" class="form-control" onchange="filterClients()" style="width: 100px;">
                  <option value="">Todos</option>
                  <option value="FOCO">FOCO</option>
                </select>
              </div>
              <div id="clients-pagination" style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid var(--border);">
                <span id="clients-showing" style="font-size: 13px; color: var(--text-muted);">Mostrando 0 de 0</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button class="btn btn-secondary" onclick="prevClientsPage()" id="btn-prev-clients" disabled style="padding: 6px 12px;">
                    <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
                  </button>
                  <span id="clients-page-info" style="padding: 6px 12px; font-size: 13px;">Página 1</span>
                  <button class="btn btn-secondary" onclick="nextClientsPage()" id="btn-next-clients" style="padding: 6px 12px;">
                    <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="table-wrapper" style="max-height: 500px; overflow-y: auto;">
              <table id="table-clients">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Nombre Fantasía</th>
                    <th>Dirección</th>
                    <th>Zona</th>
                    <th>Vendedor</th>
                    <th>Segmento</th>
                    <th style="width: 100px;">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== PRODUCTOS ==================== -->
        <div class="data-subpanel" id="subpanel-productos">
          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="package" style="width: 18px; height: 18px;"></i> Lista de Productos</h3>
              <span class="badge badge-active" id="products-count">0</span>
            </div>
            <div class="table-wrapper" style="max-height: 500px; overflow-y: auto;">
              <table id="table-products">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Nombre</th>
                    <th>Costo Base</th>
                    <th>Precio Lista</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ==================== IMPORTAR EXCEL ==================== -->
        <div class="data-subpanel" id="subpanel-importar">
          <div class="grid-2">
            <!-- Instrucciones -->
            <div class="card">
              <div class="card-header">
                <h3><i data-lucide="info" style="width: 18px; height: 18px;"></i> Instrucciones de Importación</h3>
              </div>
              <div class="card-body">
                <div style="font-size: 14px; line-height: 1.8;">
                  <p style="margin-bottom: 16px;"><strong>Tipos de importación:</strong></p>
                  <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 12px; display: flex; align-items: flex-start; gap: 8px;">
                      <span class="badge badge-a">1</span>
                      <div>
                        <strong>Incremental (Recomendado)</strong><br>
                        <span style="color: var(--text-muted); font-size: 13px;">Agrega nuevos registros y actualiza existentes. Ideal para actualizaciones diarias o semanales.</span>
                      </div>
                    </li>
                    <li style="margin-bottom: 12px; display: flex; align-items: flex-start; gap: 8px;">
                      <span class="badge badge-b">2</span>
                      <div>
                        <strong>Reemplazo Total</strong><br>
                        <span style="color: var(--text-muted); font-size: 13px;">Elimina todos los registros y carga los nuevos. Usar solo para carga inicial o correcciones masivas.</span>
                      </div>
                    </li>
                  </ul>
                  <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; font-size: 13px;">
                    <strong>Tip:</strong> Puedes subir datos de cualquier período (día, semana, mes, año). El sistema detecta duplicados por código y los actualiza.
                  </div>
                </div>
              </div>
            </div>

            <!-- Formato esperado -->
            <div class="card">
              <div class="card-header">
                <h3><i data-lucide="file-text" style="width: 18px; height: 18px;"></i> Formato de Archivo</h3>
              </div>
              <div class="card-body">
                <div style="font-size: 13px;">
                  <p style="margin-bottom: 12px;"><strong>Clientes:</strong></p>
                  <code style="display: block; padding: 12px; background: var(--bg-hover); border-radius: 6px; margin-bottom: 16px;">
                    Código | Razón Social | Nombre Fantasía | Dirección | Comuna | Zona | Segmento | Prioridad
                  </code>

                  <p style="margin-bottom: 12px;"><strong>Vendedores:</strong></p>
                  <code style="display: block; padding: 12px; background: var(--bg-hover); border-radius: 6px; margin-bottom: 16px;">
                    Nombre | Email | Rol | Zona
                  </code>

                  <p style="margin-bottom: 12px;"><strong>Vehículos:</strong></p>
                  <code style="display: block; padding: 12px; background: var(--bg-hover); border-radius: 6px;">
                    Patente | Modelo | Rendimiento (Km/L) | Estado
                  </code>
                </div>
              </div>
            </div>
          </div>

          <!-- Importar por categoría -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3><i data-lucide="upload" style="width: 18px; height: 18px;"></i> Cargar Archivo Excel</h3>
            </div>
            <div class="card-body">
              <div class="grid-2" style="gap: 24px;">
                <div>
                  <div class="form-group">
                    <label>Categoría a importar</label>
                    <select id="import-category" class="form-control">
                      <option value="clients">Clientes</option>
                      <option value="users">Vendedores</option>
                      <option value="vehicles">Vehículos</option>
                      <option value="products">Productos</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Modo de importación</label>
                    <select id="import-mode" class="form-control">
                      <option value="upsert">Incremental (Agrega/Actualiza)</option>
                      <option value="replace">Reemplazo Total (Elimina y carga)</option>
                    </select>
                  </div>
                </div>
                <div>
                  <div class="form-group">
                    <label>Archivo Excel (.xlsx, .xls)</label>
                    <input type="file" id="import-file" class="form-control" accept=".xlsx,.xls" style="padding: 10px;">
                  </div>
                  <button class="btn btn-primary btn-block" onclick="importExcelFile()" style="margin-top: 8px;">
                    <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                    Importar Archivo
                  </button>
                </div>
              </div>
              <div id="import-result" style="margin-top: 20px; display: none;"></div>
            </div>
          </div>

          <!-- Historial de importaciones -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3><i data-lucide="history" style="width: 18px; height: 18px;"></i> Últimas Importaciones</h3>
            </div>
            <div class="card-body" id="import-history">
              <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                No hay importaciones recientes
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- Panel Marketing -->
      <div class="panel" id="panel-marketing">
        <div class="panel-header">
          <h2><i data-lucide="megaphone" style="width: 24px; height: 24px;"></i> Marketing Digital</h2>
          <p class="panel-subtitle">Gestiona tus campañas y analíticas</p>
        </div>

        <!-- Google Analytics -->
        <div class="data-subpanel active" id="subpanel-google-analytics">
          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="bar-chart-2" style="width: 18px; height: 18px;"></i> Google Analytics</h3>
            </div>
            <div class="card-body">
              <div style="text-align: center; padding: 40px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: #F9AB00; border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="bar-chart-2" style="width: 40px; height: 40px; color: white;"></i>
                </div>
                <h3 style="margin-bottom: 8px;">Google Analytics 4</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Conecta tu cuenta de Google Analytics para ver métricas de tu sitio web</p>
                <div class="form-group" style="max-width: 400px; margin: 0 auto 16px;">
                  <label>Measurement ID (GA4)</label>
                  <input type="text" id="ga-measurement-id" class="form-control" placeholder="G-XXXXXXXXXX" value="">
                </div>
                <button class="btn btn-primary" onclick="saveGaConfig()">
                  <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                  Guardar Configuración
                </button>
                <div style="margin-top: 20px;">
                  <a href="https://analytics.google.com/" target="_blank" class="btn btn-secondary">
                    <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
                    Abrir Google Analytics
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Google Ads -->
        <div class="data-subpanel" id="subpanel-google-ads">
          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="target" style="width: 18px; height: 18px;"></i> Google Ads</h3>
            </div>
            <div class="card-body">
              <div style="text-align: center; padding: 40px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: #4285F4; border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="target" style="width: 40px; height: 40px; color: white;"></i>
                </div>
                <h3 style="margin-bottom: 8px;">Google Ads</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Gestiona tus campañas publicitarias en Google</p>
                <div class="form-group" style="max-width: 400px; margin: 0 auto 16px;">
                  <label>Conversion ID</label>
                  <input type="text" id="gads-conversion-id" class="form-control" placeholder="AW-XXXXXXXXX" value="">
                </div>
                <div class="form-group" style="max-width: 400px; margin: 0 auto 16px;">
                  <label>Conversion Label (opcional)</label>
                  <input type="text" id="gads-conversion-label" class="form-control" placeholder="XXXXXXXXXXXXXXXXXXX" value="">
                </div>
                <button class="btn btn-primary" onclick="saveGadsConfig()">
                  <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                  Guardar Configuración
                </button>
                <div style="margin-top: 20px;">
                  <a href="https://ads.google.com/" target="_blank" class="btn btn-secondary">
                    <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
                    Abrir Google Ads
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Meta Ads -->
        <div class="data-subpanel" id="subpanel-meta-ads">
          <div class="card">
            <div class="card-header">
              <h3><i data-lucide="facebook" style="width: 18px; height: 18px;"></i> Meta Ads (Facebook & Instagram)</h3>
            </div>
            <div class="card-body">
              <div style="text-align: center; padding: 40px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: #0081FB; border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="facebook" style="width: 40px; height: 40px; color: white;"></i>
                </div>
                <h3 style="margin-bottom: 8px;">Meta Pixel</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Conecta Meta Pixel para rastrear conversiones de Facebook e Instagram</p>
                <div class="form-group" style="max-width: 400px; margin: 0 auto 16px;">
                  <label>Pixel ID</label>
                  <input type="text" id="meta-pixel-id" class="form-control" placeholder="XXXXXXXXXXXXXXXX" value="">
                </div>
                <button class="btn btn-primary" onclick="saveMetaConfig()">
                  <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                  Guardar Configuración
                </button>
                <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                  <a href="https://business.facebook.com/" target="_blank" class="btn btn-secondary">
                    <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
                    Meta Business Suite
                  </a>
                  <a href="https://www.facebook.com/business/tools/ads-manager" target="_blank" class="btn btn-secondary">
                    <i data-lucide="external-link" style="width: 16px; height: 16px;"></i>
                    Ads Manager
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Google Sheets Panel -->
      <div class="panel" id="panel-gsheets">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; padding: 24px 24px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px;">
          <div>
            <h2 style="font-size: 22px; font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 4px;">
              <i data-lucide="sheet" style="width: 24px; height: 24px; color: var(--accent);"></i> Datos Comerciales
            </h2>
            <p style="font-size: 13px; color: var(--text-muted); margin: 0;">Datos sincronizados desde Google Sheets</p>
          </div>
          <div style="display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap;">
            <a href="https://docs.google.com/spreadsheets/d/1W8yim9i13YN3lUx0saEkVplT0MhJm8XYwZKhyK_nzvI/edit?usp=sharing" target="_blank" rel="noopener" class="btn btn-success" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;">
              <i data-lucide="file-spreadsheet" style="width:16px;height:16px;"></i>
              Abrir Excel
            </a>
            <button class="btn btn-primary" onclick="loadGoogleSheetsData(true)" id="gs-refresh-btn">
              <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
              Actualizar Datos
            </button>
          </div>
        </div>

        <!-- Loading state with progress -->
        <div id="gs-loading" style="display: none; padding: 40px 20px;">
          <div style="max-width:420px;margin:0 auto;background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:28px 32px;box-shadow:0 4px 24px rgba(0,0,0,0.06);">
            <!-- Header with animated icon -->
            <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px;">
              <div style="width:44px;height:44px;background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(129,140,248,0.1));border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <i data-lucide="file-spreadsheet" style="width:22px;height:22px;color:var(--accent);animation:pulse 2s ease-in-out infinite;"></i>
              </div>
              <div>
                <h3 id="gs-load-title" style="font-size:14px;font-weight:700;margin:0;color:var(--text-primary);">Sincronizando Datos Comerciales</h3>
                <p id="gs-load-step" style="color:var(--text-muted);font-size:12px;margin:3px 0 0;">Conectando con Google Sheets...</p>
              </div>
            </div>
            <!-- Progress section -->
            <div style="margin-bottom:6px;">
              <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
                <span id="gs-load-percent" style="font-size:28px;font-weight:800;color:var(--accent);line-height:1;">0%</span>
                <span id="gs-load-detail" style="font-size:11px;color:var(--text-muted);">Preparando...</span>
              </div>
              <div style="width:100%;height:6px;background:var(--bg-hover);border-radius:3px;overflow:hidden;">
                <div id="gs-load-bar" style="width:0%;height:100%;background:linear-gradient(90deg,var(--accent),#818cf8);border-radius:3px;transition:width 0.4s ease;"></div>
              </div>
            </div>
            <!-- Steps checklist -->
            <div id="gs-load-steps" style="margin-top:16px;display:flex;flex-direction:column;gap:6px;">
              <div class="gs-step" data-step="connect" style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-muted);">
                <div style="width:16px;height:16px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;"><div style="width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 1s ease-in-out infinite;"></div></div>
                Conectando con Google Sheets
              </div>
              <div class="gs-step" data-step="download" style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-muted);opacity:0.4;">
                <div style="width:16px;height:16px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;"></div>
                Descargando hojas de datos
              </div>
              <div class="gs-step" data-step="process" style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-muted);opacity:0.4;">
                <div style="width:16px;height:16px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;"></div>
                Procesando registros
              </div>
              <div class="gs-step" data-step="render" style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-muted);opacity:0.4;">
                <div style="width:16px;height:16px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;"></div>
                Renderizando tablas
              </div>
            </div>
          </div>
        </div>

        <!-- Not configured state -->
        <div id="gs-not-configured" style="display: none; text-align: center; padding: 60px 20px;">
          <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: var(--bg-hover); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
            <i data-lucide="alert-circle" style="width: 40px; height: 40px; color: var(--warning);"></i>
          </div>
          <h3 style="margin-bottom: 8px;">Google Sheets no configurado</h3>
          <p style="color: var(--text-muted); margin-bottom: 20px;">Agrega la URL del Apps Script en el archivo .env</p>
          <code style="background: var(--bg-hover); padding: 8px 16px; border-radius: 8px; font-size: 13px;">GOOGLE_SHEETS_SCRIPT_URL=https://script.google.com/macros/s/.../exec</code>
        </div>

        <!-- Error state -->
        <div id="gs-error" style="display: none; text-align: center; padding: 60px 20px;">
          <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: rgba(239,68,68,0.1); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
            <i data-lucide="x-circle" style="width: 40px; height: 40px; color: var(--danger);"></i>
          </div>
          <h3 style="margin-bottom: 8px;">Error al cargar datos</h3>
          <p id="gs-error-msg" style="color: var(--text-muted); margin-bottom: 20px;"></p>
          <button class="btn btn-primary" onclick="loadGoogleSheetsData(true)">Reintentar</button>
        </div>

        <!-- Data content -->
        <div id="gs-content" style="display: none;">
          <!-- Sub-tabs for gsheets panel -->
          <div class="gs-tabs-bar" id="gs-tabs">
            <button class="data-tab" data-gstab="gs-rendimiento" onclick="switchGsheetsTab('gs-rendimiento')">
              <i data-lucide="bar-chart-3" style="width: 14px; height: 14px;"></i> Rendimiento
            </button>
            <button class="data-tab active" data-gstab="gs-ventas" onclick="switchGsheetsTab('gs-ventas')">
              <i data-lucide="trending-up" style="width: 14px; height: 14px;"></i> Ventas <span class="gs-tab-badge" id="gs-badge-ventas"></span>
            </button>
            <button class="data-tab" data-gstab="gs-cobranzas" onclick="switchGsheetsTab('gs-cobranzas')">
              <i data-lucide="credit-card" style="width: 14px; height: 14px;"></i> Cobranzas <span class="gs-tab-badge" id="gs-badge-cobranzas"></span>
            </button>
            <button class="data-tab" data-gstab="gs-vendedores" onclick="switchGsheetsTab('gs-vendedores')">
              <i data-lucide="users" style="width: 14px; height: 14px;"></i> Vendedores <span class="gs-tab-badge" id="gs-badge-vendedores"></span>
            </button>
            <button class="data-tab" data-gstab="gs-8020" onclick="switchGsheetsTab('gs-8020')">
              <i data-lucide="pie-chart" style="width: 14px; height: 14px;"></i> 80-20 <span id="gs-badge-8020" class="badge-count"></span>
            </button>
            <button class="data-tab" data-gstab="gs-direcciones" onclick="switchGsheetsTab('gs-direcciones')">
              <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i> Direcciones <span class="gs-tab-badge" id="gs-badge-direcciones"></span>
            </button>
            <button class="data-tab" data-gstab="gs-reasignacion" onclick="switchGsheetsTab('gs-reasignacion')">
              <i data-lucide="repeat" style="width: 14px; height: 14px;"></i> Reasignacion <span class="gs-tab-badge" id="gs-badge-reasignacion"></span>
            </button>
          </div>

          <!-- Rendimiento Visitas -->
          <div class="data-subpanel" id="gs-subpanel-gs-rendimiento">
            <!-- Stats summary cards -->
            <div class="gs-summary-grid" style="margin-bottom: 16px;">
              <div class="card" style="text-align: center; padding: 14px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="perf-total-visits">0</div>
                <div style="font-size: 11px; color: var(--text-muted);">Total Visitas</div>
              </div>
              <div class="card" style="text-align: center; padding: 14px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="perf-total-sales">0</div>
                <div style="font-size: 11px; color: var(--text-muted);">Ventas</div>
              </div>
              <div class="card" style="text-align: center; padding: 14px;">
                <div style="font-size: 24px; font-weight: 700; color: #6366f1;" id="perf-avg-effectiveness">0%</div>
                <div style="font-size: 11px; color: var(--text-muted);">Efectividad Promedio</div>
              </div>
              <div class="card" style="text-align: center; padding: 14px;">
                <div style="font-size: 24px; font-weight: 700; color: #f59e0b;" id="perf-total-vendors">0</div>
                <div style="font-size: 11px; color: var(--text-muted);">Vendedores Activos</div>
              </div>
            </div>

            <!-- Date filter -->
            <div class="card" style="margin-bottom: 16px;">
              <div class="card-body" style="padding: 12px 16px;">
                <div class="gs-filter-bar">
                  <label style="font-weight: 600; font-size: 13px; flex-shrink:0;">Filtrar por fecha:</label>
                  <input type="date" id="perf-date-from" class="form-control" style="max-width: 160px;">
                  <span style="color: var(--text-muted); flex-shrink:0;">a</span>
                  <input type="date" id="perf-date-to" class="form-control" style="max-width: 160px;">
                  <button class="btn btn-primary" onclick="loadVisitPerformance()" style="padding: 8px 16px; flex-shrink:0;">
                    <i data-lucide="filter" style="width: 14px; height: 14px;"></i> Filtrar
                  </button>
                  <button class="btn btn-secondary" onclick="document.getElementById('perf-date-from').value='';document.getElementById('perf-date-to').value='';loadVisitPerformance();" style="padding: 8px 16px; flex-shrink:0;">
                    Limpiar
                  </button>
                </div>
              </div>
            </div>

            <!-- Performance table -->
            <div class="card">
              <div class="card-header">
                <h3><i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i> Rendimiento por Vendedor</h3>
              </div>
              <div class="card-body" id="perf-table-body" style="overflow-x: auto;">
                <p style="text-align: center; color: var(--text-muted); padding: 20px;">Cargando datos de rendimiento...</p>
              </div>
            </div>
          </div>

          <!-- Ventas por Mes -->
          <div class="data-subpanel active" id="gs-subpanel-gs-ventas">
            <div class="card">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h3><i data-lucide="trending-up" style="width: 18px; height: 18px;"></i> Ventas por Mes</h3>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                  <div style="position:relative;">
                    <i data-lucide="search" style="width:14px;height:14px;position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;"></i>
                    <input type="text" id="gs-ventas-search" class="form-control" placeholder="Buscar..." style="max-width: 200px; width:100%; padding-left: 32px; font-size: 13px;" oninput="filterGsheetsVentas()">
                  </div>
                  <select id="gs-ventas-mes" class="form-control" style="max-width: 140px; width:100%; font-size: 13px;" onchange="filterGsheetsVentas()">
                    <option value="">Todos los meses</option>
                  </select>
                  <select id="gs-ventas-vendor" class="form-control" style="max-width: 160px; width:100%; font-size: 13px;" onchange="filterGsheetsVentas()">
                    <option value="">Todos los vendedores</option>
                  </select>
                </div>
              </div>
              <div class="card-body" style="padding: 0;">
                <div id="gs-ventas-body" style="overflow-x: auto;">
                  <p style="text-align: center; color: var(--text-muted); padding: 20px;">Sin datos</p>
                </div>
                <!-- 80/20 legend -->
                <div id="gs-ventas-legend" style="display:none; padding: 8px 16px 10px; border-top: 1px solid var(--border); font-size: 11px; color: var(--text-muted); gap: 16px;">
                  <span style="display:flex;align-items:center;gap:5px;"><span style="width:12px;height:12px;background:rgba(212,175,55,0.25);border:1px solid rgba(212,175,55,0.5);border-radius:2px;display:inline-block;"></span> Cliente 80/20</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Cobranzas -->
          <div class="data-subpanel" id="gs-subpanel-gs-cobranzas">
            <div class="card">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h3><i data-lucide="credit-card" style="width: 18px; height: 18px;"></i> Cobranzas</h3>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                  <div style="position:relative;">
                    <i data-lucide="search" style="width:14px;height:14px;position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;"></i>
                    <input type="text" id="gs-cobranzas-search" class="form-control" placeholder="Buscar..." style="max-width: 180px; width:100%; padding-left: 32px; font-size: 13px;" oninput="filterGsheetsCobranzas()">
                  </div>
                  <select id="gs-cobranzas-vendor" class="form-control" style="max-width: 160px; width:100%; font-size: 13px;" onchange="filterGsheetsCobranzas()">
                    <option value="">Todos los vendedores</option>
                  </select>
                  <select id="gs-cobranzas-filter" class="form-control" style="max-width: 130px; width:100%; font-size: 13px;" onchange="filterGsheetsCobranzas()">
                    <option value="">Todos</option>
                    <option value="vencido">Vencidos</option>
                    <option value="vigente">Vigentes</option>
                  </select>
                </div>
              </div>
              <div class="card-body" style="padding: 0;">
                <div id="gs-cobranzas-body" style="overflow-x: auto;">
                  <p style="text-align: center; color: var(--text-muted); padding: 20px;">Sin datos</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Vendedores / Zonales -->
          <div class="data-subpanel" id="gs-subpanel-gs-vendedores">
            <!-- Fichas de vendedores -->
            <div class="card" style="margin-bottom: 16px;">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <div>
                  <h3><i data-lucide="users" style="width: 18px; height: 18px;"></i> Equipo Comercial</h3>
                  <p style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Datos sincronizados desde Google Sheets</p>
                </div>
                <div class="gs-filter-bar">
                  <select id="gs-vendedores-zona-filter" class="form-control" style="max-width: 160px; font-size: 13px;" onchange="filterGsheetsVendedoresCards()">
                    <option value="">Todas las zonas</option>
                  </select>
                  <div style="position:relative;flex:1 1 140px;max-width:200px;">
                    <i data-lucide="search" style="width:14px;height:14px;position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;"></i>
                    <input type="text" id="gs-vendedores-search" class="form-control" placeholder="Buscar..." style="width:100%; padding-left: 32px; font-size: 13px;" oninput="filterGsheetsVendedoresCards()">
                  </div>
                </div>
              </div>
              <div class="card-body" id="gs-vendedores-body">
                <p style="text-align: center; color: var(--text-muted); padding: 20px;">Sin datos</p>
              </div>
            </div>

            <!-- Notas por Vendedor -->
            <div class="card">
              <div class="card-header">
                <h3><i data-lucide="sticky-note" style="width: 18px; height: 18px;"></i> Notas por Vendedor</h3>
              </div>
              <div class="card-body" id="gs-vendedores-notas-body">
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: flex-end;">
                  <div style="flex: 1; min-width: 200px;">
                    <label style="font-size: 12px; color: var(--text-muted);">Vendedor</label>
                    <select id="nota-vendedor-select" class="form-control">
                      <option value="">-- Seleccionar vendedor --</option>
                    </select>
                  </div>
                  <div style="flex: 2; min-width: 300px;">
                    <label style="font-size: 12px; color: var(--text-muted);">Nota</label>
                    <textarea id="nota-vendedor-text" class="form-control" rows="2" placeholder="Escribe una nota sobre este vendedor..."></textarea>
                  </div>
                  <button class="btn btn-primary" onclick="saveVendedorNota()" style="padding: 8px 16px; white-space: nowrap;">
                    <i data-lucide="save" style="width: 14px; height: 14px;"></i> Guardar Nota
                  </button>
                </div>
                <div id="notas-vendedores-list" style="border-top: 1px solid var(--border); padding-top: 12px;">
                  <p style="text-align: center; color: var(--text-muted); padding: 12px;">No hay notas guardadas</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 80-20 -->
          <div class="data-subpanel" id="gs-subpanel-gs-8020">
            <!-- Summary cards -->
            <div id="gs-8020-summary" class="gs-summary-grid" style="margin-bottom:16px;"></div>

            <!-- Toggle Vendedores / Zonales -->
            <div style="display:flex;gap:0;margin-bottom:16px;background:var(--bg-hover);border-radius:10px;padding:4px;border:1px solid var(--border);">
              <button id="btn-8020-vendedores" onclick="switch8020View('vendedores')" style="flex:1;padding:10px 16px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;background:var(--bg-card);color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,0.08);font-family:inherit;">
                <i data-lucide="users" style="width:15px;height:15px;"></i> Vendedores
              </button>
              <button id="btn-8020-zonales" onclick="switch8020View('zonales')" style="flex:1;padding:10px 16px;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;background:transparent;color:var(--text-secondary);box-shadow:none;font-family:inherit;">
                <i data-lucide="shield" style="width:15px;height:15px;"></i> Zonales
              </button>
            </div>

            <!-- Vendedores 80-20 -->
            <div id="gs-8020-view-vendedores">
              <div class="card">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                  <h3><i data-lucide="pie-chart" style="width:18px;height:18px;"></i> Clientes 80-20 por Vendedor</h3>
                  <div class="gs-filter-bar">
                    <select id="gs-8020-vend-filter" class="form-control" style="max-width:180px;font-size:13px;" onchange="filter8020Vendedores()">
                      <option value="">Todos los vendedores</option>
                    </select>
                    <div style="position:relative;flex:1 1 160px;max-width:200px;">
                      <i data-lucide="search" style="width:14px;height:14px;position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;"></i>
                      <input type="text" id="gs-8020-vend-search" class="form-control" placeholder="Buscar cliente..." style="width:100%;padding-left:32px;font-size:13px;" oninput="filter8020Vendedores()">
                    </div>
                  </div>
                </div>
                <div class="card-body" style="padding:0;">
                  <div id="gs-8020-vendedores-body" style="overflow-x:auto;">
                    <p style="text-align:center;color:var(--text-muted);padding:20px;">Sin datos</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Zonales 80-20 -->
            <div id="gs-8020-view-zonales" style="display:none;">
              <!-- Zonal summary cards -->
              <div id="gs-8020-zonales-summary" class="gs-summary-grid" style="margin-bottom:16px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));"></div>

              <div class="card">
                <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
                  <h3><i data-lucide="shield" style="width:18px;height:18px;"></i> Clientes 80-20 por Zonal</h3>
                  <div class="gs-filter-bar">
                    <select id="gs-8020-zon-filter" class="form-control" style="max-width:180px;font-size:13px;" onchange="filter8020Zonales()">
                      <option value="">Todos los zonales</option>
                    </select>
                    <div style="position:relative;flex:1 1 160px;max-width:200px;">
                      <i data-lucide="search" style="width:14px;height:14px;position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;"></i>
                      <input type="text" id="gs-8020-zon-search" class="form-control" placeholder="Buscar cliente..." style="width:100%;padding-left:32px;font-size:13px;" oninput="filter8020Zonales()">
                    </div>
                  </div>
                </div>
                <div class="card-body" style="padding:0;">
                  <div id="gs-8020-zonales-body" style="overflow-x:auto;">
                    <p style="text-align:center;color:var(--text-muted);padding:20px;">Sin datos</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Direcciones -->
          <div class="data-subpanel" id="gs-subpanel-gs-direcciones">
            <div class="card" style="margin-bottom: 16px;">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h3><i data-lucide="map-pin" style="width: 18px; height: 18px;"></i> Direcciones <span id="dir-total-count" style="font-size:12px;font-weight:400;color:var(--text-muted);"></span></h3>
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                  <button class="btn" onclick="openCreateClientModal()" style="background: var(--accent); color: white; border: none; padding: 6px 12px; font-size: 11px; border-radius: 6px; cursor: pointer; font-weight: 600;" id="btn-create-client-dir" title="Crear nuevo cliente">
                    <i data-lucide="plus" style="width: 13px; height: 13px;"></i> Nuevo
                  </button>
                  <button class="btn" onclick="importAllFromSheets()" style="background: #10b981; color: white; border: none; padding: 6px 12px; font-size: 11px; border-radius: 6px; cursor: pointer; font-weight: 600;" id="btn-import-sheets" title="Importar todos los clientes de Google Sheets a Supabase">
                    <i data-lucide="database" style="width: 13px; height: 13px;"></i> Importar Excel → DB
                  </button>
                  <button class="btn" id="btn-batch-geo" onclick="batchGenerateGeoLinks()" style="background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); padding: 6px 12px; font-size: 11px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    <i data-lucide="locate" style="width: 13px; height: 13px;"></i> Cargar Geo
                  </button>
                  <button class="btn" id="btn-batch-geo-stop" onclick="stopBatchGeoLinks()" style="display:none; background: #ef4444; color: white; border: none; padding: 6px 12px; font-size: 11px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    <i data-lucide="square" style="width: 13px; height: 13px;"></i> Detener
                  </button>
                </div>
              </div>
              <!-- Filters bar -->
              <div style="padding: 8px 16px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <div style="position:relative; flex: 1; min-width: 180px; max-width: 280px;">
                  <i data-lucide="search" style="width:14px;height:14px;position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none;"></i>
                  <input type="text" id="dir-db-search" class="form-control" placeholder="Buscar código, nombre, dirección..." style="width:100%; padding-left: 32px; font-size: 12px;" oninput="filterDireccionesDB()">
                </div>
                <select id="dir-db-region" class="form-control" style="max-width:160px; font-size:12px;" onchange="filterDireccionesDB()">
                  <option value="">Todas las regiones</option>
                </select>
                <select id="dir-db-vendor" class="form-control" style="max-width:160px; font-size:12px;" onchange="filterDireccionesDB()">
                  <option value="">Todos los vendedores</option>
                  <option value="__none__">Sin asignar</option>
                </select>
                <div id="dir-db-geo-filters" style="display:flex;gap:4px;"></div>
              </div>
              <div class="card-body" style="padding: 0;">
                <div id="gs-direcciones-body" style="overflow-x: auto;">
                  <p style="text-align: center; color: var(--text-muted); padding: 20px;">Cargando clientes...</p>
                </div>
              </div>
            </div>
            <!-- Import banner (shown when Sheet has more clients than DB) -->
            <div id="dir-import-banner" style="display:none;padding:12px 16px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:10px;margin-bottom:12px;"></div>
            <!-- Import progress (hidden by default) -->
            <div id="dir-import-progress" style="display:none;" class="card">
              <div class="card-body" style="padding: 16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                  <span style="font-size:13px;font-weight:600;" id="dir-import-title">Importando...</span>
                  <span style="font-size:12px;color:var(--text-muted);" id="dir-import-detail"></span>
                </div>
                <div style="height:6px;background:var(--bg-hover);border-radius:3px;overflow:hidden;">
                  <div id="dir-import-bar" style="height:100%;background:var(--accent);width:0%;transition:width 0.3s;border-radius:3px;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Reasignación -->
          <div class="data-subpanel" id="gs-subpanel-gs-reasignacion">
            <!-- Reasignar zona a ejecutivo -->
            <div class="card" style="margin-bottom: 16px;">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                <h3><i data-lucide="shuffle" style="width: 18px; height: 18px;"></i> Reasignar Zona a Vendedor</h3>
              </div>
              <div class="card-body">
                <div class="gs-filter-bar" style="align-items: flex-end;">
                  <div style="flex: 1; min-width: 140px;">
                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Zona (de Google Sheets)</label>
                    <select id="reasign-zone-select" class="form-control">
                      <option value="">-- Seleccionar zona --</option>
                    </select>
                  </div>
                  <div style="flex: 1; min-width: 140px;">
                    <label style="font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 4px;">Vendedor destino</label>
                    <select id="reasign-exec-select" class="form-control">
                      <option value="">-- Seleccionar vendedor --</option>
                    </select>
                  </div>
                  <button class="btn btn-primary" onclick="executeZoneReassign()" style="padding: 10px 20px; white-space: nowrap; flex-shrink:0;">
                    <i data-lucide="check" style="width: 16px; height: 16px;"></i> Reasignar
                  </button>
                </div>
                <div id="reasign-preview" style="margin-top: 12px;"></div>
                <div id="reasign-result" style="margin-top: 12px;"></div>
              </div>
            </div>

            <!-- Tabla de datos de reasignación desde Google Sheets -->
            <div class="card">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                <h3><i data-lucide="repeat" style="width: 18px; height: 18px;"></i> Datos de Reasignacion (Google Sheets)</h3>
                <input type="text" id="gs-reasignacion-search" class="form-control" placeholder="Buscar..." style="max-width: 220px; width: 100%;" oninput="filterGsheetsReasignacion()">
              </div>
              <div class="card-body" id="gs-reasignacion-body" style="overflow-x: auto;">
                <p style="text-align: center; color: var(--text-muted); padding: 20px;">Sin datos</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Panel (Control Maestro) -->
      <div class="panel" id="panel-users">
        <!-- Admin Actual - Control Total -->
        <div class="card" style="margin-bottom: 16px; background: #1e293b; border: 2px solid #374151;">
          <div class="card-body" style="padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
              <div style="display: flex; align-items: center; gap: 16px; min-width: 0; flex: 1;">
                <div id="current-admin-avatar" style="width: 56px; min-width: 56px; height: 56px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 20px; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);">
                  <i data-lucide="crown" style="width: 28px; height: 28px;"></i>
                </div>
                <div style="color: white; min-width: 0;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                    <span style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">Usuario Actual</span>
                    <span style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">CONTROL TOTAL</span>
                  </div>
                  <div id="current-admin-name" style="font-size: 22px; font-weight: 700; overflow: hidden; text-overflow: ellipsis;">Administrador</div>
                  <div id="current-admin-email" style="font-size: 13px; opacity: 0.7;">admin@leker.cl</div>
                </div>
              </div>
              <div style="text-align: right; flex-shrink: 0;">
                <div style="color: rgba(255,255,255,0.6); font-size: 11px; margin-bottom: 8px;">
                  <i data-lucide="shield-check" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle;"></i>
                  Administrador del Sistema
                </div>
                <button class="btn" style="background: white; color: #1e293b;" onclick="openAddUserModal()">
                  <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i>
                  Nuevo Usuario
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Acciones Rápidas Admin -->
        <div class="responsive-grid-4" style="gap: 10px; margin-bottom: 14px;">
          <button class="card" style="padding: 12px; text-align: center; cursor: pointer; border: 1px solid var(--border);" onclick="showPanel('data')">
            <i data-lucide="database" style="width: 20px; height: 20px; color: var(--accent); margin-bottom: 6px;"></i>
            <div style="font-size: 12px; font-weight: 500;">Base de Datos</div>
          </button>
          <button class="card" style="padding: 12px; text-align: center; cursor: pointer; border: 1px solid var(--border);" onclick="showPanel('routes')">
            <i data-lucide="map" style="width: 20px; height: 20px; color: #059669; margin-bottom: 6px;"></i>
            <div style="font-size: 12px; font-weight: 500;">Rutas</div>
          </button>
          <button class="card" style="padding: 12px; text-align: center; cursor: pointer; border: 1px solid var(--border);" onclick="showPanel('executives')">
            <i data-lucide="users" style="width: 20px; height: 20px; color: #1e40af; margin-bottom: 6px;"></i>
            <div style="font-size: 12px; font-weight: 500;">Vendedores</div>
          </button>
          <button class="card" style="padding: 12px; text-align: center; cursor: pointer; border: 1px solid var(--border);" onclick="showPanel('marketing')">
            <i data-lucide="megaphone" style="width: 20px; height: 20px; color: #dc2626; margin-bottom: 6px;"></i>
            <div style="font-size: 12px; font-weight: 500;">Marketing</div>
          </button>
        </div>

        <!-- Stats -->
        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 16px;">
          <div class="card" style="text-align: center; padding: 12px;">
            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);" id="stat-users-total">0</div>
            <div style="font-size: 11px; color: var(--text-muted);">Total</div>
          </div>
          <div class="card" style="text-align: center; padding: 12px; border-left: 3px solid #374151;">
            <div style="font-size: 20px; font-weight: 700; color: #374151;" id="stat-users-admin">0</div>
            <div style="font-size: 11px; color: var(--text-muted);">Admins</div>
          </div>
          <div class="card" style="text-align: center; padding: 12px; border-left: 3px solid #7c3aed;">
            <div style="font-size: 20px; font-weight: 700; color: #7c3aed;" id="stat-users-supervisor">0</div>
            <div style="font-size: 11px; color: var(--text-muted);">Supervisores</div>
          </div>
          <div class="card" style="text-align: center; padding: 12px; border-left: 3px solid #0891b2;">
            <div style="font-size: 20px; font-weight: 700; color: #0891b2;" id="stat-users-zonal">0</div>
            <div style="font-size: 11px; color: var(--text-muted);">Zonales</div>
          </div>
          <div class="card" style="text-align: center; padding: 12px; border-left: 3px solid #1e40af;">
            <div style="font-size: 20px; font-weight: 700; color: #1e40af;" id="stat-users-exec">0</div>
            <div style="font-size: 11px; color: var(--text-muted);">Vendedores</div>
          </div>
          <div class="card" style="text-align: center; padding: 12px; border-left: 3px solid #059669;">
            <div style="font-size: 20px; font-weight: 700; color: #059669;" id="stat-users-viewer">0</div>
            <div style="font-size: 11px; color: var(--text-muted);">Lectura</div>
          </div>
        </div>

        <!-- Permissions Matrix -->
        <div class="card" id="permissions-matrix-card" style="margin-bottom: 20px;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3><i data-lucide="settings" style="width: 18px; height: 18px;"></i> Permisos por Rol</h3>
            <button class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;" onclick="resetRolePermissions()">
              <i data-lucide="rotate-ccw" style="width: 14px; height: 14px;"></i> Restaurar Predeterminados
            </button>
          </div>
          <div id="permissions-matrix-body" style="padding: 16px; overflow-x: auto;"></div>
        </div>

        <!-- Users Table -->
        <div class="card">
          <div class="card-header" style="flex-direction: column; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
              <h3><i data-lucide="users" style="width: 18px; height: 18px;"></i> Todos los Usuarios</h3>
              <div style="display: flex; gap: 8px; align-items: center;">
                <select id="filter-users-role" class="form-control" style="max-width: 150px; width:100%; padding: 6px 10px; font-size: 12px;" onchange="filterAllUsers()">
                  <option value="">Todos los roles</option>
                  <option value="admin">Administradores</option>
                  <option value="supervisor">Supervisores</option>
                  <option value="zonal">Zonales</option>
                  <option value="executive">Vendedores</option>
                  <option value="viewer">Solo Lectura</option>
                </select>
                <select id="filter-users-status" class="form-control" style="max-width: 120px; width:100%; padding: 6px 10px; font-size: 12px;" onchange="filterAllUsers()">
                  <option value="">Todos</option>
                  <option value="active">Activos</option>
                  <option value="inactive">Inactivos</option>
                </select>
              </div>
            </div>
            <input type="text" id="search-all-users" class="form-control" placeholder="Buscar por nombre o email..." oninput="filterAllUsers()">
          </div>
          <div class="table-wrapper" style="max-height: 500px;">
            <table id="table-all-users">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Permisos</th>
                  <th>Estado</th>
                  <th>Último Acceso</th>
                  <th style="text-align: center;">Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody-all-users"></tbody>
            </table>
          </div>
        </div>

        <!-- Roles Section -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3><i data-lucide="shield" style="width: 18px; height: 18px;"></i> Roles del Sistema</h3>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <!-- Admin Role -->
              <div style="border: 2px solid #374151; border-radius: 8px; padding: 16px; background: rgba(107, 114, 128, 0.05);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                  <div style="width: 40px; height: 40px; background: #374151; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="shield-check" style="width: 20px; height: 20px; color: white;"></i>
                  </div>
                  <div>
                    <div style="font-weight: 600;">Administrador</div>
                    <div style="font-size: 11px; color: var(--text-muted);">Control total del sistema</div>
                  </div>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Configurar sistema completo</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Gestionar usuarios y roles</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Importar/Exportar datos</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Configurar marketing</div>
                  <div><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Acceso total a reportes</div>
                </div>
              </div>

              <!-- Supervisor Role -->
              <div style="border: 2px solid #7c3aed; border-radius: 8px; padding: 16px; background: rgba(124, 58, 237, 0.05);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                  <div style="width: 40px; height: 40px; background: #7c3aed; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="user-cog" style="width: 20px; height: 20px; color: white;"></i>
                  </div>
                  <div>
                    <div style="font-weight: 600;">Supervisor</div>
                    <div style="font-size: 11px; color: var(--text-muted);">Vendedor Administrador</div>
                  </div>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Ver todos los vendedores y rutas</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Asignar clientes a vendedores</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Exportar datos y reportes</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Ver marketing y dashboards</div>
                  <div style="color: var(--text-muted);">✗ No configura sistema</div>
                </div>
              </div>

              <!-- Executive Role -->
              <div style="border: 2px solid #1e40af; border-radius: 8px; padding: 16px; background: rgba(30, 64, 175, 0.05);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                  <div style="width: 40px; height: 40px; background: #1e40af; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="briefcase" style="width: 20px; height: 20px; color: white;"></i>
                  </div>
                  <div>
                    <div style="font-weight: 600;">Vendedor</div>
                    <div style="font-size: 11px; color: var(--text-muted);">Vendedor / Representante</div>
                  </div>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Ver sus clientes asignados</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Iniciar y gestionar sus rutas</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Registrar visitas (check-in)</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Ver su historial personal</div>
                  <div style="color: var(--text-muted);">✗ No ve otros vendedores</div>
                </div>
              </div>

              <!-- Viewer Role -->
              <div style="border: 2px solid #059669; border-radius: 8px; padding: 16px; background: rgba(5, 150, 105, 0.05);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                  <div style="width: 40px; height: 40px; background: #059669; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="eye" style="width: 20px; height: 20px; color: white;"></i>
                  </div>
                  <div>
                    <div style="font-weight: 600;">Lectura</div>
                    <div style="font-size: 11px; color: var(--text-muted);">Solo visualización</div>
                  </div>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Ver dashboards asignados</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Ver metas y reportes</div>
                  <div style="margin-bottom: 4px;"><i data-lucide="check" style="width:12px;height:12px;color:#10b981;display:inline-block;vertical-align:middle;"></i> Ver marketing asignado</div>
                  <div style="color: var(--text-muted);">✗ No puede modificar datos</div>
                  <div style="color: var(--text-muted);">✗ No puede crear rutas</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Integraciones n8n -->
        <div class="card" style="margin-top: 20px;">
          <div class="card-header" style="cursor: pointer;" onclick="toggleN8nPanel()">
            <h3><i data-lucide="workflow" style="width: 18px; height: 18px;"></i> Integraciones n8n</h3>
            <i data-lucide="chevron-down" id="n8n-toggle-icon" style="width: 18px; height: 18px;"></i>
          </div>
          <div class="card-body" id="n8n-panel" style="display: none;">
            <!-- Conexión API n8n -->
            <div style="margin-bottom: 24px; padding: 16px; background: var(--bg-hover); border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0;">
                  <i data-lucide="plug" style="width: 16px; height: 16px; color: #f97316;"></i>
                  Conexión API n8n
                </h4>
                <div id="n8n-connection-status" style="font-size: 11px; padding: 4px 10px; border-radius: 4px; background: #94a3b8; color: white;">
                  No conectado
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                <div class="form-group" style="margin: 0;">
                  <label style="font-size: 11px;">URL de n8n Cloud</label>
                  <input type="url" id="n8n-api-url" class="form-control" placeholder="https://tu-cuenta.app.n8n.cloud" style="font-size: 12px;">
                </div>
                <div class="form-group" style="margin: 0;">
                  <label style="font-size: 11px;">API Key</label>
                  <input type="password" id="n8n-api-key" class="form-control" placeholder="eyJhbGci..." style="font-size: 12px;">
                </div>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn btn-secondary" onclick="testN8nApiConnection()" style="font-size: 12px;">
                  <i data-lucide="wifi" style="width: 14px; height: 14px;"></i> Probar Conexión
                </button>
                <button class="btn btn-primary" onclick="saveN8nApiConfig()" style="font-size: 12px;">
                  <i data-lucide="save" style="width: 14px; height: 14px;"></i> Guardar
                </button>
              </div>
            </div>

            <!-- Workflows de n8n -->
            <div style="margin-bottom: 24px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h4 style="font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0;">
                  <i data-lucide="git-branch" style="width: 16px; height: 16px; color: #8b5cf6;"></i>
                  Workflows Activos
                </h4>
                <button class="btn btn-secondary" onclick="loadN8nWorkflows()" style="font-size: 11px; padding: 4px 10px;">
                  <i data-lucide="refresh-cw" style="width: 12px; height: 12px;"></i> Actualizar
                </button>
              </div>
              <div id="n8n-workflows-list" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; max-height: 200px; overflow-y: auto;">
                <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">
                  Conecta con n8n para ver tus workflows
                </div>
              </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- Webhook de Salida -->
            <div style="margin-bottom: 24px;">
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="arrow-right-from-line" style="width: 16px; height: 16px; color: var(--accent);"></i>
                Webhook de Salida (LEKER → n8n)
              </h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                Configura una URL de n8n para recibir eventos cuando ocurran acciones en LEKER.
              </p>
              <div class="form-group">
                <label>URL del Webhook n8n</label>
                <input type="url" id="n8n-webhook-url" class="form-control" placeholder="https://tu-n8n.com/webhook/xxx">
              </div>
              <div class="form-group">
                <label>Secret (opcional)</label>
                <input type="password" id="n8n-webhook-secret" class="form-control" placeholder="Token secreto para validar requests">
              </div>
              <div class="form-group">
                <label>Eventos a enviar</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                  <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="evt-route-completed" checked> Ruta completada
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="evt-visit-registered" checked> Visita registrada
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="evt-sync-completed" checked> Sincronización completada
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="evt-price-alert"> Alerta de precio
                  </label>
                </div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                  <input type="checkbox" id="n8n-webhook-enabled"> Webhook habilitado
                </label>
                <div style="margin-left: auto; display: flex; gap: 8px;">
                  <button class="btn btn-secondary" onclick="testN8nWebhook()">
                    <i data-lucide="send" style="width: 14px; height: 14px;"></i> Test
                  </button>
                  <button class="btn btn-primary" onclick="saveN8nWebhookConfig()">
                    <i data-lucide="save" style="width: 14px; height: 14px;"></i> Guardar
                  </button>
                </div>
              </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- Webhooks de Entrada -->
            <div>
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="arrow-left-to-line" style="width: 16px; height: 16px; color: #059669;"></i>
                Webhooks de Entrada (n8n → LEKER)
              </h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                Usa estos endpoints en tus workflows de n8n para enviar datos a LEKER.
              </p>
              <div style="background: var(--bg-hover); border-radius: 8px; padding: 16px;">
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Sincronizar Clientes</span>
                    <span style="font-size: 10px; background: #059669; color: white; padding: 2px 6px; border-radius: 4px;">POST</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block; word-break: break-all;" id="webhook-url-clients">/webhooks/n8n-sync-clients</code>
                </div>
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Sincronizar Productos</span>
                    <span style="font-size: 10px; background: #059669; color: white; padding: 2px 6px; border-radius: 4px;">POST</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block; word-break: break-all;" id="webhook-url-products">/webhooks/n8n-sync-products</code>
                </div>
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Sincronizar Usuarios</span>
                    <span style="font-size: 10px; background: #059669; color: white; padding: 2px 6px; border-radius: 4px;">POST</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block; word-break: break-all;" id="webhook-url-users">/webhooks/n8n-sync-users</code>
                </div>
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Actualizar Precios (Scraping)</span>
                    <span style="font-size: 10px; background: #059669; color: white; padding: 2px 6px; border-radius: 4px;">POST</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block; word-break: break-all;" id="webhook-url-prices">/webhooks/n8n-price-update</code>
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Comparativo Competencia (LEKER v32)</span>
                    <span style="font-size: 10px; background: #f97316; color: white; padding: 2px 6px; border-radius: 4px;">POST</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block; word-break: break-all;" id="webhook-url-comparativo">/webhooks/n8n-comparativo</code>
                </div>
              </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">

            <!-- API de Reportes -->
            <div>
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="file-bar-chart" style="width: 16px; height: 16px; color: #7c3aed;"></i>
                API de Reportes
              </h4>
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                Endpoints para generar reportes automáticos desde n8n.
              </p>
              <div style="background: var(--bg-hover); border-radius: 8px; padding: 16px;">
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Reporte Diario de Rutas</span>
                    <span style="font-size: 10px; background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px;">GET</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block;">/api/reports/daily-routes?date=YYYY-MM-DD</code>
                </div>
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Reporte de Vendedores</span>
                    <span style="font-size: 10px; background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px;">GET</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block;">/api/reports/executives</code>
                </div>
                <div style="margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Clientes sin Visita</span>
                    <span style="font-size: 10px; background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px;">GET</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block;">/api/reports/clients-without-visit?days=30</code>
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-size: 12px; font-weight: 500;">Inteligencia de Precios</span>
                    <span style="font-size: 10px; background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px;">GET</span>
                  </div>
                  <code style="font-size: 11px; background: var(--bg-card); padding: 6px 10px; border-radius: 4px; display: block;">/api/reports/price-intelligence</code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </main>

  <!-- Modal Cliente -->
  <div id="modal-client" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeClientModal()"></div>
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3 id="modal-client-title">Nuevo Cliente</h3>
        <button class="btn-close" onclick="closeClientModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="client-id">
        <div class="form-group">
          <label>Código *</label>
          <input type="text" id="client-code" class="form-control" placeholder="Ej: 12345678-9">
        </div>
        <div class="form-group">
          <label>Razón Social *</label>
          <input type="text" id="client-name" class="form-control" placeholder="Nombre legal">
        </div>
        <div class="form-group">
          <label>Nombre Fantasía</label>
          <input type="text" id="client-fantasy" class="form-control" placeholder="Nombre comercial">
        </div>
        <div class="form-group">
          <label>Dirección</label>
          <input type="text" id="client-address" class="form-control" placeholder="Calle, número">
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Comuna</label>
            <input type="text" id="client-commune" class="form-control" placeholder="Comuna">
          </div>
          <div class="form-group">
            <label>Zona</label>
            <input type="text" id="client-zone" class="form-control" placeholder="Zona de reparto">
          </div>
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Segmento</label>
            <select id="client-segment" class="form-control">
              <option value="A">A - 80/20 Top</option>
              <option value="B">B - Con dirección</option>
              <option value="C">C - Con vendedor</option>
              <option value="D">D - Potencial</option>
              <option value="E">E - Sin dirección</option>
            </select>
          </div>
          <div class="form-group">
            <label>Prioridad</label>
            <select id="client-priority" class="form-control">
              <option value="Normal">Normal</option>
              <option value="FOCO">FOCO (Prioritario)</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Vendedor Asignado</label>
          <select id="client-vendor" class="form-control">
            <option value="">Sin asignar</option>
          </select>
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Teléfono</label>
            <input type="text" id="client-phone" class="form-control" placeholder="Contacto principal">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="client-email" class="form-control" placeholder="correo@empresa.cl">
          </div>
        </div>
        <div class="form-group">
          <label>Observaciones</label>
          <textarea id="client-observations" class="form-control" rows="2" placeholder="Notas internas..."></textarea>
        </div>
        <!-- Audit info (admin only) -->
        <div id="client-audit-info" style="display:none; margin-top:12px; padding:10px 12px; background:var(--bg-hover); border-radius:8px; font-size:12px; color:var(--text-muted);">
          <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
            <i data-lucide="shield-check" style="width:14px;height:14px;color:#6366f1;"></i>
            <span style="font-weight:600; color:var(--text-primary);">Auditoría de Dirección</span>
          </div>
          <div id="client-audit-status" style="margin-bottom:4px;"></div>
          <div id="client-audit-detail"></div>
        </div>
        <!-- Visit history (loaded async when editing) -->
        <div id="client-visit-history" style="display:none; margin-top:14px;">
          <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; font-size:12px; font-weight:600; color:var(--text-primary);">
            <i data-lucide="clock" style="width:14px;height:14px;color:#6366f1;"></i>
            Últimas Visitas
          </div>
          <div id="client-visit-history-body" style="font-size:12px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveClient()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Reasignar Clientes entre Vendedores (mejorado) -->
  <div id="modal-reassign" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeReassignModal()"></div>
    <div class="modal-content" style="max-width: 750px; width: 95%;">
      <div class="modal-header">
        <h3><i data-lucide="arrow-left-right" style="width: 18px; height: 18px;"></i> Reasignar Clientes entre Vendedores</h3>
        <button class="btn-close" onclick="closeReassignModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
          Selecciona clientes individuales o todos para transferirlos a otro vendedor.
        </p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label>Vendedor Origen (ceder clientes)</label>
            <select id="reassign-from" class="form-control" onchange="updateReassignPreview()">
              <option value="">Seleccionar vendedor...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Vendedor Destino (recibir clientes)</label>
            <select id="reassign-to" class="form-control">
              <option value="">Seleccionar vendedor...</option>
            </select>
          </div>
        </div>
        <div id="reassign-preview" style="display: none; margin-top: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 600; font-size: 14px;">Clientes a transferir:</div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="font-size: 12px; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                <input type="checkbox" id="reassign-select-all" onchange="toggleReassignSelectAll(this.checked)"> Seleccionar todos
              </label>
              <span class="badge badge-primary" id="reassign-selected-count" style="font-size: 10px;">0 seleccionados</span>
            </div>
          </div>
          <div id="reassign-client-list" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 4px;">
          </div>
          <div id="reassign-preview-content" style="font-size: 13px; color: var(--text-secondary); margin-top: 8px; padding: 12px; background: var(--bg-hover); border-radius: 8px;"></div>
        </div>
      </div>
      <div style="padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeReassignModal()">Cancelar</button>
        <button class="btn btn-primary" id="btn-reassign" onclick="executeReassign()" style="background: #f59e0b; border-color: #f59e0b;">
          <i data-lucide="arrow-left-right" style="width: 16px; height: 16px;"></i> Reasignar Seleccionados
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Asignar Clientes a Vendedor -->
  <div id="modal-assign-clients" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeAssignClientsModal()"></div>
    <div class="modal-content" style="max-width: 1000px; width: 95%;">
      <div class="modal-header">
        <h3><i data-lucide="users-round" style="width: 18px; height: 18px;"></i> Asignar Clientes a Vendedor</h3>
        <button class="btn-close" onclick="closeAssignClientsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; gap: 16px; margin-bottom: 16px;">
          <div class="form-group" style="flex: 1; margin: 0;">
            <label>Vendedor</label>
            <select id="assign-executive" class="form-control" onchange="loadClientsForAssignment()">
              <option value="">-- Seleccionar vendedor --</option>
            </select>
          </div>
          <div class="form-group" style="flex: 1; margin: 0;">
            <label>Filtrar por Zona</label>
            <select id="assign-zone-filter" class="form-control" onchange="filterAvailableClients()">
              <option value="">-- Todas las zonas --</option>
            </select>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Clientes Disponibles -->
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 600;">Clientes Disponibles <span id="available-count" style="color: var(--text-muted); font-weight: normal;">(0)</span></span>
              <input type="text" id="search-available" class="form-control" placeholder="Buscar código o nombre..." style="max-width: 180px; width:100%; padding: 6px 10px; font-size: 12px;" oninput="filterAvailableClients()">
            </div>
            <div id="available-clients-list" style="height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary);">
              <div class="empty-state" style="padding: 20px;">
                <p style="font-size: 12px;">Selecciona un vendedor</p>
              </div>
            </div>
            <button class="btn btn-primary btn-block" style="margin-top: 10px;" onclick="assignSelectedClients()">
              <i data-lucide="arrow-right" style="width: 14px; height: 14px;"></i> Asignar Seleccionados
            </button>
          </div>
          <!-- Clientes Asignados -->
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight: 600;">Clientes Asignados <span id="assigned-count" style="color: var(--primary);">(0)</span></span>
              <input type="text" id="search-assigned" class="form-control" placeholder="Buscar..." style="max-width: 180px; width:100%; padding: 6px 10px; font-size: 12px;" oninput="filterAssignedClients()">
            </div>
            <div id="assigned-clients-list" style="height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary);">
              <div class="empty-state" style="padding: 20px;">
                <p style="font-size: 12px;">Sin clientes asignados</p>
              </div>
            </div>
            <button class="btn btn-secondary btn-block" style="margin-top: 10px;" onclick="unassignSelectedClients()">
              <i data-lucide="arrow-left" style="width: 14px; height: 14px;"></i> Quitar Seleccionados
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAssignClientsModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Usuario -->
  <div id="modal-edit-user" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeEditUserModal()"></div>
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3><i data-lucide="user-cog" style="width: 18px; height: 18px;"></i> Editar Vendedor</h3>
        <button class="btn-close" onclick="closeEditUserModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-user-id">
        <div class="form-group">
          <label>Nombre Completo</label>
          <input type="text" id="edit-user-name" class="form-control" placeholder="Nombre completo">
        </div>
        <div class="form-group">
          <label>Rol</label>
          <select id="edit-user-role" class="form-control">
            <option value="executive">Vendedor</option>
            <option value="supervisor">Supervisor</option>
            <option value="zonal">Zonal</option>
            <option value="admin">Admin</option>
            <option value="viewer">Viewer</option>
          </select>
        </div>
        <hr style="border-color: var(--border); margin: 16px 0;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <i data-lucide="map-pin" style="width: 16px; height: 16px; color: var(--primary);"></i>
          <span style="font-weight: 600; font-size: 13px;">Punto de Inicio (casa u oficina)</span>
        </div>
        <p style="font-size: 11px; color: var(--text-muted); margin: -4px 0 12px;">Direccion desde donde parte y termina la jornada. Puede ser su casa o la oficina de la zona.</p>
        <div class="form-group">
          <label>Direccion base</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="edit-user-home-address" class="form-control" placeholder="Ej: Av. Ossa 971, La Reina, Santiago" style="flex: 1;">
            <button type="button" class="btn btn-secondary" onclick="geocodeUserAddress()" style="white-space: nowrap; padding: 6px 12px;">
              <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i> Geocodificar
            </button>
          </div>
        </div>
        <div class="grid-2">
          <div class="form-group">
            <label>Latitud</label>
            <input type="text" id="edit-user-home-lat" class="form-control" placeholder="Auto" readonly style="background: var(--bg-hover);">
          </div>
          <div class="form-group">
            <label>Longitud</label>
            <input type="text" id="edit-user-home-lng" class="form-control" placeholder="Auto" readonly style="background: var(--bg-hover);">
          </div>
        </div>
        <div id="edit-user-geocode-status" style="display: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; margin-top: -8px;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditUserModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveEditUser()">
          <i data-lucide="save" style="width: 14px; height: 14px;"></i> Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Google Maps JS -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA7s1MSGD_1AXZgRHue38c1TteTFiwnt4Q&libraries=places,geometry"></script>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Toast Notification System
    function showToast(type, title, message, duration = 4000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: 'check-circle',
        error: 'x-circle',
        warning: 'alert-triangle',
        info: 'info'
      };

      toast.innerHTML = `
        <i data-lucide="${icons[type]}" class="toast-icon"></i>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <i data-lucide="x" style="width: 18px; height: 18px;"></i>
        </button>
      `;

      container.appendChild(toast);
      lucide.createIcons();

      // Auto remove
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Theme Management
    // Google Maps styles for dark/light mode
    const LIGHT_MAP_STYLES = [];
    const DARK_MAP_STYLES = [
      { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
      { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
      { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
      { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
      { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
      { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
      { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] }
    ];
    // Google Maps handles styles internally

    function getStoredTheme() {
      return localStorage.getItem('leker-theme') || 'light';
    }

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('leker-theme', theme);
      updateMapTiles(theme);
      lucide.createIcons();
    }

    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('active');
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = current === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    function updateMapTiles(theme) {
      const styles = theme === 'dark' ? DARK_MAP_STYLES : LIGHT_MAP_STYLES;

      // Only update if maps are initialized
      if (typeof mainMap !== 'undefined' && mainMap) {
        mainMap.setOptions({ styles: styles });
      }
      if (typeof routeMap !== 'undefined' && routeMap) {
        routeMap.setOptions({ styles: styles });
      }
    }

    // Apply stored theme on load (only set attribute, maps will use theme when initialized)
    document.documentElement.setAttribute('data-theme', getStoredTheme());

    const API = '';

    // =============================================
    // AUTH SYSTEM
    // =============================================
    const DEFAULT_ROLE_PANELS = {
      admin:      ['dashboard', 'routes', 'visits', 'crm', 'intelligence', 'marketing', 'data', 'gsheets', 'users'],
      supervisor: ['dashboard', 'routes', 'visits', 'crm', 'data', 'gsheets'],
      zonal:      ['dashboard', 'routes', 'visits', 'crm', 'gsheets'],
      executive:  ['dashboard', 'visits', 'routes'],
      viewer:     ['dashboard']
    };

    // Load overrides from localStorage if present
    let ROLE_PANELS = JSON.parse(JSON.stringify(DEFAULT_ROLE_PANELS));
    try {
      const saved = localStorage.getItem('leker_role_panels');
      if (saved) {
        const overrides = JSON.parse(saved);
        for (const role of Object.keys(ROLE_PANELS)) {
          if (overrides[role]) ROLE_PANELS[role] = overrides[role];
        }
      }
    } catch(e) { /* ignore bad data */ }

    const PANEL_LABELS = {
      dashboard: 'Dashboard',
      routes: 'Rutas y Mapa',
      visits: 'Visitas',
      crm: 'Logística CRM',
      intelligence: 'Precios Mercado',
      marketing: 'Marketing',
      data: 'Base de Datos',
      gsheets: 'Google Sheets',
      users: 'Usuarios y Roles'
    };
    const ROLE_LABELS = {
      admin: 'Administrador',
      supervisor: 'Supervisor',
      zonal: 'Zonal',
      executive: 'Vendedor',
      viewer: 'Solo Lectura'
    };

    let currentUser = null;

    // Override fetch to inject auth token (only for same-origin / API requests)
    const _originalFetch = window.fetch;
    window.fetch = function(url, options = {}) {
      const urlStr = typeof url === 'string' ? url : url.url || '';
      const isSameOrigin = urlStr.startsWith('/') || urlStr.startsWith(location.origin) || urlStr.startsWith(API);
      const token = localStorage.getItem('leker_token');
      if (token && isSameOrigin) {
        options.headers = options.headers || {};
        if (options.headers instanceof Headers) {
          if (!options.headers.has('Authorization')) {
            options.headers.set('Authorization', 'Bearer ' + token);
          }
        } else {
          if (!options.headers['Authorization']) {
            options.headers['Authorization'] = 'Bearer ' + token;
          }
        }
      }
      return _originalFetch.call(this, url, options).then(response => {
        if (response.status === 401 && token && isSameOrigin && !urlStr.includes('/api/auth/')) {
          localStorage.removeItem('leker_token');
          localStorage.removeItem('leker_user');
          location.reload();
        }
        return response;
      });
    };

    function showLoginError(msg) {
      const el = document.getElementById('login-error');
      el.textContent = msg;
      el.style.display = 'block';
    }
    function hideLoginError() {
      document.getElementById('login-error').style.display = 'none';
    }
    function showSetupError(msg) {
      const el = document.getElementById('setup-error');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function showSetupForm() {
      document.getElementById('login-form-container').style.display = 'none';
      document.getElementById('setup-form-container').style.display = 'block';
    }
    function showLoginForm() {
      document.getElementById('setup-form-container').style.display = 'none';
      document.getElementById('login-form-container').style.display = 'block';
    }

    async function checkSetupNeeded() {
      try {
        const res = await _originalFetch(API + '/api/auth/check-setup');
        const data = await res.json();
        if (data.needsSetup) {
          document.getElementById('login-setup-link').style.display = 'block';
        }
      } catch(e) { /* ignore */ }
    }

    function togglePasswordVisibility(inputId, btn) {
      const input = document.getElementById(inputId);
      if (!input) return;
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      // When toggling to full visible, disable peek; re-enable when toggling back
      input._peekDisabled = isPassword;
      btn.innerHTML = `<i data-lucide="${isPassword ? 'eye-off' : 'eye'}" style="width:18px;height:18px;"></i>`;
      lucide.createIcons();
    }

    // Mobile-style password peek: briefly show last typed char for 500ms
    function initPasswordPeek(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      let peekTimer = null;
      input.addEventListener('input', function(e) {
        // Skip if fully visible (toggle eye) or if deleting
        if (this._peekDisabled || this.type === 'text') return;
        if (!e.data) return; // deletion or paste without new char
        // Briefly show as text
        clearTimeout(peekTimer);
        this.type = 'text';
        const cursorPos = this.selectionStart;
        peekTimer = setTimeout(() => {
          if (!this._peekDisabled) {
            this.type = 'password';
            // Restore cursor position
            this.setSelectionRange(cursorPos, cursorPos);
          }
        }, 500);
      });
      // On blur, always hide
      input.addEventListener('blur', function() {
        clearTimeout(peekTimer);
        if (!this._peekDisabled) this.type = 'password';
      });
    }

    async function doLogin() {
      hideLoginError();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!email || !password) return showLoginError('Ingresa email y contraseña');

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Ingresando...';

      try {
        const res = await _originalFetch(API + '/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!data.success) {
          showLoginError(data.error || 'Error al iniciar sesión');
          btn.disabled = false;
          btn.textContent = 'Iniciar Sesión';
          return;
        }
        localStorage.setItem('leker_token', data.data.token);
        localStorage.setItem('leker_user', JSON.stringify(data.data.user));
        currentUser = data.data.user;
        onLoginSuccess();
      } catch(e) {
        showLoginError('Error de conexión');
        btn.disabled = false;
        btn.textContent = 'Iniciar Sesión';
      }
    }

    async function doSetup() {
      const email = document.getElementById('setup-email').value.trim();
      const password = document.getElementById('setup-password').value;
      const confirm = document.getElementById('setup-password-confirm').value;

      if (!email || !password) return showSetupError('Completa todos los campos');
      if (password !== confirm) return showSetupError('Las contraseñas no coinciden');
      if (password.length < 4) return showSetupError('Mínimo 4 caracteres');

      const btn = document.getElementById('setup-btn');
      btn.disabled = true;
      btn.textContent = 'Configurando...';

      try {
        const res = await _originalFetch(API + '/api/auth/setup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!data.success) {
          showSetupError(data.error || 'Error en setup');
          btn.disabled = false;
          btn.textContent = 'Configurar y Entrar';
          return;
        }
        localStorage.setItem('leker_token', data.data.token);
        localStorage.setItem('leker_user', JSON.stringify(data.data.user));
        currentUser = data.data.user;
        onLoginSuccess();
      } catch(e) {
        showSetupError('Error de conexión');
        btn.disabled = false;
        btn.textContent = 'Configurar y Entrar';
      }
    }

    function doLogout() {
      localStorage.removeItem('leker_token');
      localStorage.removeItem('leker_user');
      currentUser = null;
      location.reload();
    }

    function onLoginSuccess() {
      document.getElementById('login-overlay').classList.add('hidden');
      applyRolePermissions();
      updateSidebarUser();
      // Now load data
      loadData();
      updateGpsStatus();
      loadDashboardComparativoSummary();
      setInterval(updateGpsStatus, 30000);

      // Restore saved tab (or default to visits for executives)
      const savedTab = localStorage.getItem('leker_active_tab');
      const savedSubtab = localStorage.getItem('leker_active_subtab');
      const isExecUser = currentUser && currentUser.role === 'executive';

      if (isExecUser && (!savedTab || savedTab === 'dashboard')) {
        // Executive default landing: visits panel
        setTimeout(() => {
          const visitsTab = document.querySelector('.nav-item[data-tab="visits"]') || document.querySelector('.nav-subitem[data-tab="visits"]');
          if (visitsTab) visitsTab.click();
        }, 100);
      } else if (savedTab && savedTab !== 'dashboard') {
        setTimeout(() => {
          const allowed = ROLE_PANELS[currentUser.role] || ['dashboard'];
          if (allowed.includes(savedTab)) {
            let tabItem = document.querySelector(`.nav-subitem[data-tab="${savedTab}"][data-subtab="${savedSubtab}"]`);
            if (!tabItem) {
              tabItem = document.querySelector(`.nav-item[data-tab="${savedTab}"]`) ||
                        document.querySelector(`.nav-subitem[data-tab="${savedTab}"]`);
            }
            if (tabItem) tabItem.click();
          }
        }, 100);
      }
    }

    function applyRolePermissions() {
      if (!currentUser) return;
      const allowed = ROLE_PANELS[currentUser.role] || ['dashboard'];

      // Hide/show nav items based on role
      document.querySelectorAll('.nav-item[data-tab], .nav-subitem[data-tab]').forEach(item => {
        const tab = item.getAttribute('data-tab');
        const section = item.closest('.nav-section');
        if (!allowed.includes(tab)) {
          item.style.display = 'none';
        } else {
          item.style.display = '';
        }
      });

      // Hide/show parent expandable items if all children are hidden
      document.querySelectorAll('.nav-item-expandable').forEach(expItem => {
        const visibleChildren = expItem.querySelectorAll('.nav-subitem[style=""], .nav-subitem:not([style])');
        const allChildren = expItem.querySelectorAll('.nav-subitem');
        let anyVisible = false;
        allChildren.forEach(ch => {
          if (ch.style.display !== 'none') anyVisible = true;
        });
        if (!anyVisible) {
          expItem.style.display = 'none';
        } else {
          expItem.style.display = '';
        }
      });

      // Hide entire nav sections if all items are hidden
      document.querySelectorAll('.nav-section').forEach(section => {
        const items = section.querySelectorAll('.nav-item[data-tab], .nav-subitem[data-tab], .nav-item-expandable');
        let anyVisible = false;
        items.forEach(item => {
          if (item.style.display !== 'none') anyVisible = true;
        });
        if (!anyVisible) {
          section.style.display = 'none';
        } else {
          section.style.display = '';
        }
      });

      // Toggle executive vs admin dashboard
      const isExec = currentUser.role === 'executive';
      const execDash = document.getElementById('exec-dashboard');
      const adminSections = ['stats-grid', 'dash-row-seg', 'dash-row-ops', 'dash-row-fin'];
      // Remaining cards (competencia, rendimiento, calendario) after dash-row-fin
      const panel = document.getElementById('panel-dashboard');

      if (execDash) execDash.style.display = isExec ? '' : 'none';

      // Hide/show admin-only dashboard sections
      adminSections.forEach(cls => {
        const el = panel?.querySelector('.' + cls);
        if (el) el.style.display = isExec ? 'none' : '';
      });

      // Cards after dash-row-fin (competencia, rendimiento, calendario)
      if (panel) {
        const dashRowFin = panel.querySelector('.dash-row-fin');
        if (dashRowFin) {
          let sibling = dashRowFin.nextElementSibling;
          while (sibling && !sibling.classList.contains('panel')) {
            if (sibling.classList.contains('card')) {
              sibling.style.display = isExec ? 'none' : '';
            }
            sibling = sibling.nextElementSibling;
          }
        }
      }

      // Route panel: hide Dashboard and Gestionar tabs for executives (can't create/manage routes)
      if (isExec) {
        document.querySelectorAll('.route-tab[data-routetab="dashboard"], .route-tab[data-routetab="gestionar"]').forEach(btn => {
          btn.style.display = 'none';
        });
        // Default to planner if on hidden tab
        const activeRouteTab = document.querySelector('.route-tab.active');
        if (activeRouteTab && (activeRouteTab.dataset.routetab === 'dashboard' || activeRouteTab.dataset.routetab === 'gestionar')) {
          switchRouteTab('planner');
        }
      } else {
        document.querySelectorAll('.route-tab[data-routetab="dashboard"], .route-tab[data-routetab="gestionar"]').forEach(btn => {
          btn.style.display = '';
        });
      }
    }

    function updateSidebarUser() {
      if (!currentUser) return;
      const nameEl = document.getElementById('sidebar-admin-name');
      const roleEl = document.getElementById('sidebar-admin-role');
      const avatarEl = document.getElementById('sidebar-admin-avatar');
      const topAvatarEl = document.querySelector('.user-avatar');

      if (nameEl) nameEl.textContent = currentUser.full_name || 'Usuario';
      if (roleEl) {
        const roleLabel = ROLE_LABELS[currentUser.role] || currentUser.role;
        roleEl.innerHTML = `<i data-lucide="shield-check" style="width: 10px; height: 10px;"></i><span>${roleLabel}</span>`;
      }

      // Update top-bar avatar title
      if (topAvatarEl) topAvatarEl.title = currentUser.full_name || 'Usuario';

      // Initials in avatar
      if (avatarEl && currentUser.full_name) {
        const parts = currentUser.full_name.split(' ');
        const initials = parts.length >= 2
          ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase()
          : parts[0].substring(0,2).toUpperCase();
        avatarEl.innerHTML = initials;
      }

      // Update admin panel display
      const adminNameEl = document.getElementById('current-admin-name');
      const adminEmailEl = document.getElementById('current-admin-email');
      if (adminNameEl) adminNameEl.textContent = currentUser.full_name || 'Usuario';
      if (adminEmailEl) adminEmailEl.textContent = currentUser.email || '';

      lucide.createIcons();
    }

    // Password management for admin
    async function setUserPassword(userId, userName) {
      const password = prompt(`Nueva contraseña para ${userName}:\n(mínimo 4 caracteres)`);
      if (!password) return;
      if (password.length < 4) return alert('La contraseña debe tener al menos 4 caracteres');

      try {
        const res = await fetch(API + '/api/auth/set-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, password })
        });
        const data = await res.json();
        if (data.success) {
          alert('Contraseña actualizada para ' + userName);
        } else {
          alert('Error: ' + (data.error || 'No se pudo actualizar'));
        }
      } catch(e) {
        alert('Error de conexión');
      }
    }

    // Enter key triggers login/setup
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const overlay = document.getElementById('login-overlay');
        if (overlay && !overlay.classList.contains('hidden')) {
          if (document.getElementById('setup-form-container').style.display !== 'none') {
            doSetup();
          } else {
            doLogin();
          }
        }
      }
    });

    let mainMap, routeMap;
    let mainMapMarkers = [];
    let routeMapMarkers = [];
    let mainInfoWindow, routeInfoWindow;
    let clientMarkers = [];

    // Global data storage for filtering
    let allUsers = [];
    let allVehicles = [];
    let allClients = [];
    let executives = []; // Vendedores/Ejecutivos
    let allRoutes = [];
    let filteredClients = [];
    let todayRoutesData = [];
    let todayScheduledData = {}; // { userId: [scheduled_routes...] }

    // Pagination for clients
    const CLIENTS_PER_PAGE = 50;
    let currentClientsPage = 1;

    // Region O'Higgins center coordinates
    const REGION_CENTER = [-34.35, -71.0];
    const REGION_ZOOM = 9;

    // Submenu Toggle
    function toggleSubmenu(element) {
      const sidebar = document.getElementById('sidebar');
      // If collapsed, expand first then open submenu
      if (sidebar.classList.contains('collapsed')) {
        expandSidebar();
      }
      const parent = element.closest('.nav-item-expandable');
      parent.classList.toggle('open');
    }

    // Sidebar Collapse/Expand
    function toggleCollapseSidebar() {
      const sidebar = document.getElementById('sidebar');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      const main = document.querySelector('.main');
      main.style.marginLeft = isCollapsed ? '68px' : '240px';
      localStorage.setItem('leker_sidebar_collapsed', isCollapsed);
      // Re-create icons for the collapse btn
      lucide.createIcons();
    }

    function expandSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        document.querySelector('.main').style.marginLeft = '240px';
        localStorage.setItem('leker_sidebar_collapsed', false);
        lucide.createIcons();
      }
    }

    // Restore sidebar collapsed state
    if (localStorage.getItem('leker_sidebar_collapsed') === 'true') {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.add('collapsed');
      document.querySelector('.main').style.marginLeft = '68px';
    }

    // Sidebar Search / Filter
    function filterSidebar(query) {
      const q = query.toLowerCase().trim();
      const sections = document.querySelectorAll('.nav-section');

      sections.forEach(section => {
        let sectionHasMatch = false;

        // Check direct nav-items
        section.querySelectorAll('.nav-item:not(.nav-item-parent)').forEach(item => {
          const text = item.textContent.toLowerCase();
          const match = !q || text.includes(q);
          item.classList.toggle('search-hidden', !match);
          if (match) sectionHasMatch = true;
        });

        // Check expandable items and their sub-items
        section.querySelectorAll('.nav-item-expandable').forEach(expandable => {
          let expandableHasMatch = false;
          const parentText = expandable.querySelector('.nav-item-parent')?.textContent.toLowerCase() || '';

          expandable.querySelectorAll('.nav-subitem').forEach(subitem => {
            const text = subitem.textContent.toLowerCase();
            const match = !q || text.includes(q) || parentText.includes(q);
            subitem.classList.toggle('search-hidden', !match);
            if (match) expandableHasMatch = true;
          });

          expandable.classList.toggle('search-hidden', !expandableHasMatch);
          if (expandableHasMatch) {
            sectionHasMatch = true;
            // Auto-expand if searching
            if (q) expandable.classList.add('open');
          }
        });

        section.classList.toggle('search-hidden', !sectionHasMatch);
      });
    }

    // Keyboard shortcuts for sidebar
    document.addEventListener('keydown', (e) => {
      // Ctrl+B or Cmd+B to toggle sidebar collapse
      if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        if (window.innerWidth > 1024) {
          toggleCollapseSidebar();
        }
      }
      // Ctrl+K or Cmd+K to focus sidebar search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('collapsed')) expandSidebar();
        const searchInput = document.getElementById('sidebar-search');
        searchInput.focus();
      }
      // Escape to clear search and blur
      if (e.key === 'Escape') {
        const searchInput = document.getElementById('sidebar-search');
        if (document.activeElement === searchInput) {
          searchInput.value = '';
          filterSidebar('');
          searchInput.blur();
        }
      }
    });

    // Tab Navigation
    document.querySelectorAll('.nav-item:not(.nav-item-parent)').forEach(item => {
      item.addEventListener('click', () => {
        const tab = item.dataset.tab;
        if (!tab) return;

        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.nav-subitem').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.nav-item-expandable').forEach(i => i.classList.remove('has-active-child'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

        item.classList.add('active');
        document.getElementById(`panel-${tab}`).classList.add('active');
        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        // Save current tab to localStorage
        localStorage.setItem('leker_active_tab', tab);
        localStorage.removeItem('leker_active_subtab');

        // Update page title
        const titles = {
          dashboard: 'Dashboard',
          routes: 'Rutas y Mapa',
          visits: 'Gestión de Visitas',
          crm: 'Logística CRM',
          intelligence: 'Inteligencia de Mercado',
          data: 'Datos del Sistema',
          marketing: 'Marketing Digital',
          gsheets: 'Datos Comerciales',
          users: 'Usuarios y Roles'
        };
        document.getElementById('page-title').textContent = titles[tab] || 'Dashboard';

        // Load data for specific tabs
        if (tab === 'marketing') {
          loadMarketingConfig();
        }
        if (tab === 'users') {
          renderAllUsersTable();
        }
        if (tab === 'intelligence') {
          loadComparativoData();
        }
        if (tab === 'routes') {
          updateRouteDashboard();
        }
        if (tab === 'crm') {
          renderCrmPanel();
        }

        // Close sidebar on mobile after navigation
        if (window.innerWidth <= 1024) {
          const sidebar = document.querySelector('.sidebar');
          const overlay = document.getElementById('sidebar-overlay');
          sidebar.classList.remove('open');
          overlay.classList.remove('active');
        }

        // Refresh maps when switching tabs
        setTimeout(() => {
          if (mainMap) google.maps.event.trigger(mainMap, 'resize');
          if (routeMap) {
            google.maps.event.trigger(routeMap, 'resize');
            // Load route on first view of routes tab
            if (tab === 'routes' && routeMarkers.length === 0) {
              loadTodayRoutes();
            }
          }
        }, 150);
      });
    });

    // Initialize Maps - Centered on Chile
    function initMaps() {
      const theme = getStoredTheme();
      const styles = theme === 'dark' ? DARK_MAP_STYLES : LIGHT_MAP_STYLES;

      const mapOptions = {
        center: { lat: REGION_CENTER[0], lng: REGION_CENTER[1] },
        zoom: REGION_ZOOM,
        styles: styles,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      };

      // Main dashboard map
      mainMap = new google.maps.Map(document.getElementById('map'), mapOptions);
      mainInfoWindow = new google.maps.InfoWindow();

      // Route map
      routeMap = new google.maps.Map(document.getElementById('map-route'), mapOptions);
      routeInfoWindow = new google.maps.InfoWindow();

      // Directions service for real street routes
      directionsService = new google.maps.DirectionsService();
    }

    // Add client markers to map using lat/lng from client data
    // Store markers with metadata for filtering
    let markersBySegment = { '80-20': [], 'L': [], 'N': [], 'none': [], 'FOCO': [] };
    let activeSegmentFilters = { '80-20': true, 'L': true, 'N': true, 'none': true, 'FOCO': true };

    function addClientMarkers(clients) {
      // Clear existing markers
      mainMapMarkers.forEach(m => m.setMap(null));
      mainMapMarkers = [];
      clientMarkers = [];
      markersBySegment = { '80-20': [], 'L': [], 'N': [], 'none': [], 'FOCO': [] };

      const bounds = new google.maps.LatLngBounds();
      let markersWithCoords = 0;
      let markersWithoutCoords = 0;
      let segmentCounts = { '80-20': 0, 'L': 0, 'N': 0, 'none': 0, 'FOCO': 0 };

      // Count ALL clients' segmentation first (not just GPS ones)
      clients.forEach(c => {
        const s = c.segmentation || 'none';
        segmentCounts[s] = (segmentCounts[s] || 0) + 1;
        if (c.priority === 'FOCO') segmentCounts.FOCO++;
      });

      // Chile bounds: lat -17 to -56, lng -76 to -66
      const isInChile = (lat, lng) => lat >= -56 && lat <= -17 && lng >= -76 && lng <= -66;

      clients.forEach(client => {
        // Check if client has coordinates
        if (!client.lat || !client.lng) {
          markersWithoutCoords++;
          return;
        }

        const lat = parseFloat(client.lat);
        const lng = parseFloat(client.lng);

        // Skip invalid coordinates (outside Chile)
        if (!isInChile(lat, lng)) {
          markersWithoutCoords++;
          return;
        }

        markersWithCoords++;
        const position = { lat, lng };
        bounds.extend(position);

        // Marker colors by segmentation (80-20=gold, L=blue, N=gray, none=light gray)
        const segColors = { '80-20': '#f59e0b', 'L': '#3b82f6', 'N': '#94a3b8', 'none': '#cbd5e1' };
        const seg = client.segmentation || 'none';
        const color = segColors[seg] || '#cbd5e1';
        const isFoco = client.priority === 'FOCO';

        const marker = new google.maps.Marker({
          position: position,
          map: mainMap,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: isFoco ? '#ef4444' : color,
            fillOpacity: seg === 'none' ? 0.5 : 1,
            strokeColor: '#fff',
            strokeWeight: isFoco ? 2 : (seg === '80-20' ? 2 : 1.5),
            scale: isFoco ? 12 : (seg === '80-20' ? 10 : 7)
          },
          title: client.name
        });

        // Store marker metadata
        marker.clientData = client;
        marker.segment = client.segment || 'E';
        marker.segmentation = seg;
        marker.isFoco = isFoco;

        const segLabel = { '80-20': '80/20 Clave', 'L': 'L · Con ventas', 'N': 'N · Nuevo', 'none': '' };
        const infoContent = `
          <div style="min-width: 250px; padding: 10px; font-family: system-ui, sans-serif;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <strong style="font-size: 14px; color: #1f2937;">${client.fantasy_name || client.name}</strong>
              <code style="font-size: 11px; background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px;">${client.external_id}</code>
            </div>
            ${client.fantasy_name && client.name !== client.fantasy_name ? `<div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">${client.name}</div>` : ''}
            <div style="font-size: 12px; color: #374151; margin-top: 8px;">
              <i data-lucide="map-pin" style="width:12px;height:12px;color:#9ca3af;display:inline-block;vertical-align:middle;"></i> ${client.address || 'Sin dirección'}
            </div>
            <div style="font-size: 12px; color: #6b7280;">${client.commune || ''}</div>
            <div style="margin-top: 10px; display: flex; gap: 4px; flex-wrap: wrap;">
              ${seg !== 'none' ? `<span style="background: ${color}; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">${segLabel[seg] || seg}</span>` : ''}
              ${client.segment ? `<span style="background: #e5e7eb; color: #374151; padding: 3px 10px; border-radius: 4px; font-size: 11px;">Seg ${client.segment}</span>` : ''}
              ${isFoco ? '<span style="background: #ef4444; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 500;">FOCO</span>' : ''}
            </div>
            ${client.zone ? `<div style="margin-top: 6px; font-size: 11px; color: #9ca3af;">Zona: ${client.zone}</div>` : ''}
          </div>
        `;

        marker.addListener('click', () => {
          mainInfoWindow.setContent(infoContent);
          mainInfoWindow.open(mainMap, marker);
        });

        mainMapMarkers.push(marker);
        clientMarkers.push(marker);

        // Store by segmentation for filtering
        if (!markersBySegment[seg]) markersBySegment[seg] = [];
        markersBySegment[seg].push(marker);
        if (isFoco) markersBySegment.FOCO.push(marker);
      });

      // Update map stats
      updateMapStats(markersWithCoords, markersWithoutCoords);

      // Update segmentation counts in legend
      const _countMap = { '80-20': 'count-seg-8020', 'L': 'count-seg-l', 'N': 'count-seg-n', 'none': 'count-seg-none', 'FOCO': 'count-seg-foco' };
      Object.entries(_countMap).forEach(([key, id]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = segmentCounts[key] || 0;
      });

      // Fit bounds to show all markers, but limit zoom
      if (markersWithCoords > 0) {
        mainMap.fitBounds(bounds);
        // Limit max zoom to avoid getting too close
        const listener = google.maps.event.addListener(mainMap, 'idle', function() {
          if (mainMap.getZoom() > 15) mainMap.setZoom(15);
          if (mainMap.getZoom() < 5) mainMap.setZoom(8); // Don't zoom out too much
          google.maps.event.removeListener(listener);
        });
      } else {
        // No markers, center on Chile
        mainMap.setCenter({ lat: -33.45, lng: -70.65 });
        mainMap.setZoom(6);
      }
    }

    // Filter map markers by segmentation
    const _segKeys = ['80-20', 'L', 'N', 'none'];
    function filterMapBySegment(segment) {
      if (segment === 'ALL') {
        activeSegmentFilters = { '80-20': true, 'L': true, 'N': true, 'none': true, 'FOCO': true };
        mainMapMarkers.forEach(m => m.setMap(mainMap));
        document.querySelectorAll('.legend-filter').forEach(el => el.classList.add('active'));
        return;
      }

      // Toggle filter
      activeSegmentFilters[segment] = !activeSegmentFilters[segment];

      // Update legend visual
      const legendItem = document.querySelector(`.legend-filter[data-segment="${segment}"]`);
      if (legendItem) {
        const isActive = activeSegmentFilters[segment];
        legendItem.classList.toggle('active', isActive);
        const eyeIcon = legendItem.querySelector('.toggle-eye');
        if (eyeIcon) {
          eyeIcon.setAttribute('data-lucide', isActive ? 'eye' : 'eye-off');
          lucide.createIcons({ nodes: [eyeIcon] });
        }
      }

      // Show/hide markers
      const onlyFoco = !_segKeys.some(k => activeSegmentFilters[k]) && activeSegmentFilters.FOCO;
      mainMapMarkers.forEach(marker => {
        const markerSeg = marker.segmentation;
        const isFoco = marker.isFoco;
        let shouldShow = false;
        if (onlyFoco) {
          shouldShow = isFoco;
        } else {
          if (activeSegmentFilters[markerSeg]) shouldShow = true;
          if (activeSegmentFilters.FOCO && isFoco) shouldShow = true;
        }
        marker.setMap(shouldShow ? mainMap : null);
      });
    }

    // Toggle map size (expand/collapse)
    let _mapExpanded = false;
    function toggleMapSize() {
      const container = document.getElementById('main-map-container');
      const icon = document.getElementById('icon-toggle-map');
      const lbl = document.getElementById('lbl-toggle-map');
      if (!container) return;
      _mapExpanded = !_mapExpanded;
      if (_mapExpanded) {
        container.style.height = 'calc(100vh - 120px)';
        container.style.minHeight = '600px';
        if (icon) icon.setAttribute('data-lucide', 'minimize-2');
        if (lbl) lbl.textContent = 'Contraer';
      } else {
        container.style.height = '450px';
        container.style.minHeight = '';
        if (icon) icon.setAttribute('data-lucide', 'maximize-2');
        if (lbl) lbl.textContent = 'Expandir';
      }
      lucide.createIcons();
      if (mainMap) setTimeout(() => google.maps.event.trigger(mainMap, 'resize'), 350);
    }

    // Toggle fullscreen map
    function toggleMapFullscreen() {
      const container = document.getElementById('main-map-container');
      const icon = document.getElementById('icon-fullscreen-map');
      if (!container) return;
      if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        const req = container.requestFullscreen || container.webkitRequestFullscreen;
        if (req) req.call(container);
        if (icon) { icon.setAttribute('data-lucide', 'minimize'); lucide.createIcons({ nodes: [icon] }); }
      } else {
        const exit = document.exitFullscreen || document.webkitExitFullscreen;
        if (exit) exit.call(document);
        if (icon) { icon.setAttribute('data-lucide', 'fullscreen'); lucide.createIcons({ nodes: [icon] }); }
      }
    }

    // Resize map when entering/exiting fullscreen
    document.addEventListener('fullscreenchange', () => {
      if (mainMap) setTimeout(() => google.maps.event.trigger(mainMap, 'resize'), 100);
    });
    document.addEventListener('webkitfullscreenchange', () => {
      if (mainMap) setTimeout(() => google.maps.event.trigger(mainMap, 'resize'), 100);
    });

    // Search client on map
    function searchClientOnMap() {
      const search = document.getElementById('map-client-search').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('map-search-results');

      if (search.length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }

      // Filter all clients (with and without GPS)
      const filtered = allClients.filter(c => {
        const matchCode = c.external_id && c.external_id.toLowerCase().includes(search);
        const matchName = c.name && c.name.toLowerCase().includes(search);
        const matchFantasy = c.fantasy_name && c.fantasy_name.toLowerCase().includes(search);
        return matchCode || matchName || matchFantasy;
      }).slice(0, 15);

      if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">No se encontraron clientes</div>';
        resultsDiv.style.display = 'block';
        return;
      }

      resultsDiv.innerHTML = filtered.map(c => {
        const hasGPS = c.lat && c.lng;
        return `
        <div onclick="${hasGPS ? `zoomToClient('${c.id}')` : `showToast('warning','Sin GPS','Este cliente no tiene ubicación registrada')`}" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s; ${!hasGPS ? 'opacity: 0.7;' : ''}" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">
          <div style="font-weight: 500; font-size: 12px; word-break: break-word;">${c.fantasy_name || c.name}</div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
            <div style="font-size: 10px; color: var(--text-muted);">${c.commune || ''} ${!hasGPS ? '· Sin GPS' : ''}</div>
            <code style="font-size: 10px; background: ${hasGPS ? 'var(--accent)' : '#94a3b8'}; color: white; padding: 2px 6px; border-radius: 4px; white-space: nowrap;">${c.external_id || ''}</code>
          </div>
        </div>`;
      }).join('');
      resultsDiv.style.display = 'block';
    }

    // Zoom to specific client on map
    function zoomToClient(clientId) {
      const client = allClients.find(c => c.id === clientId);
      if (!client || !client.lat || !client.lng) return;

      const position = { lat: parseFloat(client.lat), lng: parseFloat(client.lng) };

      // Zoom to client
      mainMap.setCenter(position);
      mainMap.setZoom(16);

      // Find and open marker
      const marker = mainMapMarkers.find(m => m.clientData && m.clientData.id === clientId);
      if (marker) {
        google.maps.event.trigger(marker, 'click');
      }

      // Clear search
      document.getElementById('map-client-search').value = '';
      document.getElementById('map-search-results').style.display = 'none';
    }

    function updateMapStats(withCoords, withoutCoords) {
      const withCoordsEl = document.getElementById('stats-with-coords');
      const withoutCoordsEl = document.getElementById('stats-without-coords');
      const geocodeBtn = document.getElementById('btn-geocode');
      const geocodeBtnHeader = document.getElementById('btn-geocode-header');
      const geocodeCount = document.getElementById('geocode-count');

      if (withCoordsEl) withCoordsEl.textContent = withCoords;
      if (withoutCoordsEl) withoutCoordsEl.textContent = withoutCoords;

      // Count clients that can be geocoded (have address or commune)
      const geocodable = allClients ? allClients.filter(c => !c.lat && !c.lng && (c.address || c.commune)).length : 0;
      const noAddressCount = allClients ? allClients.filter(c => !c.lat && !c.lng && !c.address && !c.commune).length : 0;

      if (geocodeBtn) {
        geocodeBtn.style.display = geocodable > 0 ? 'block' : 'none';
      }

      // Show/hide geocode alert banner
      const geocodeAlert = document.getElementById('geocode-alert');
      if (geocodeAlert) {
        geocodeAlert.style.display = geocodable > 0 ? 'flex' : 'none';
        if (geocodeCount) geocodeCount.textContent = geocodable;
      }

      // Show warning if many clients have no address
      if (noAddressCount > 0 && withCoords === 0) {
        console.log(`Diagnóstico de clientes: ${withCoords} con coords, ${geocodable} con dirección para geocodificar, ${noAddressCount} sin dirección ni coords`);
      }

      lucide.createIcons();
    }

    let geocodingCancelled = false;
    let geocodePanelMinimized = false;

    function openGeocodePanel() {
      const panel = document.getElementById('geocode-panel');
      panel.classList.add('open');
      panel.classList.remove('minimized');
      geocodePanelMinimized = false;
      lucide.createIcons();
    }

    function closeGeocodePanel() {
      geocodingCancelled = true;
      const panel = document.getElementById('geocode-panel');
      panel.classList.remove('open');
    }

    function toggleGeocodePanel() {
      const panel = document.getElementById('geocode-panel');
      geocodePanelMinimized = !geocodePanelMinimized;
      panel.classList.toggle('minimized', geocodePanelMinimized);
    }

    function geocodeLogEntry(text, type = 'info') {
      const log = document.getElementById('geocode-panel-log');
      if (!log) return;
      const icons = { success: 'check-circle', error: 'x-circle', info: 'loader' };
      const entry = document.createElement('div');
      entry.className = `geocode-log-entry ${type}`;
      entry.innerHTML = `<i data-lucide="${icons[type] || 'info'}" style="width:11px;height:11px;flex-shrink:0;"></i><span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${text}</span>`;
      log.insertBefore(entry, log.firstChild);
      // Keep max 100 entries
      while (log.children.length > 100) log.removeChild(log.lastChild);
      lucide.createIcons();
    }

    function updateGeocodeStats(ok, err, pending, pct) {
      document.getElementById('geocode-stat-ok').textContent = ok;
      document.getElementById('geocode-stat-err').textContent = err;
      document.getElementById('geocode-stat-pending').textContent = pending;
      document.getElementById('geocode-progress-fill').style.width = `${pct}%`;
      document.getElementById('geocode-panel-pct').textContent = `${pct}%`;
    }

    async function geocodeClientsWithoutCoords() {
      const clientsToGeocode = allClients.filter(c => !c.lat && !c.lng && (c.address || c.commune));

      if (clientsToGeocode.length === 0) {
        showToast('info', 'Sin clientes', 'No hay clientes con dirección para geocodificar');
        return;
      }

      geocodingCancelled = false;

      // Open progress panel
      openGeocodePanel();
      document.getElementById('geocode-panel-log').innerHTML = '';
      document.getElementById('geocode-panel-title').textContent = 'Geocodificando...';
      document.getElementById('geocode-close-btn').style.display = 'none';

      const btn = document.getElementById('btn-geocode-header');
      const btnLegend = document.getElementById('btn-geocode');
      const geocodeAlert = document.getElementById('geocode-alert');

      if (btn) {
        btn.textContent = 'Cancelar';
        btn.style.background = '#ef4444';
        btn.style.color = 'white';
        btn.onclick = () => { geocodingCancelled = true; };
      }
      if (btnLegend) { btnLegend.disabled = true; }

      const totalToProcess = Math.min(clientsToGeocode.length, 200);
      updateGeocodeStats(0, 0, totalToProcess, 0);
      geocodeLogEntry(`Iniciando proceso: ${totalToProcess} clientes de ${clientsToGeocode.length}`, 'info');

      const geocoder = new google.maps.Geocoder();
      let processed = 0;
      let success = 0;
      let errors = 0;
      let rateLimitHits = 0;

      const isInChile = (lat, lng) => lat >= -56 && lat <= -17 && lng >= -76 && lng <= -66;

      for (let i = 0; i < totalToProcess; i++) {
        if (geocodingCancelled) {
          geocodeLogEntry(`Cancelado por usuario. ${success} geocodificados.`, 'info');
          break;
        }

        const client = clientsToGeocode[i];
        const clientName = client.fantasy_name || client.name || client.external_id;
        let addressParts = [];
        if (client.address) addressParts.push(client.address);
        if (client.commune) addressParts.push(client.commune);
        addressParts.push('Chile');
        const address = addressParts.join(', ');

        try {
          const result = await new Promise((resolve, reject) => {
            const timeout = setTimeout(() => reject('TIMEOUT'), 10000);
            geocoder.geocode({ address }, (results, status) => {
              clearTimeout(timeout);
              if (status === 'OK' && results[0]) {
                const loc = results[0].geometry.location;
                if (isInChile(loc.lat(), loc.lng())) {
                  resolve(loc);
                } else {
                  reject('OUTSIDE_CHILE');
                }
              } else if (status === 'OVER_QUERY_LIMIT') {
                rateLimitHits++;
                reject('RATE_LIMIT');
              } else {
                reject(status);
              }
            });
          });

          await fetch(`${API}/api/clients/${client.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat: result.lat(), lng: result.lng() })
          });

          client.lat = result.lat();
          client.lng = result.lng();
          success++;
          geocodeLogEntry(`${clientName} — ${client.commune || ''}`, 'success');
        } catch (e) {
          errors++;
          const reason = e === 'OUTSIDE_CHILE' ? 'fuera de Chile' : e === 'RATE_LIMIT' ? 'límite API' : e === 'TIMEOUT' ? 'timeout' : 'sin resultado';
          geocodeLogEntry(`${clientName} — ${reason}`, 'error');
          if (e === 'RATE_LIMIT' && rateLimitHits > 3) {
            geocodeLogEntry('Esperando 5s por límite de Google...', 'info');
            await new Promise(r => setTimeout(r, 5000));
            rateLimitHits = 0;
          }
        }

        processed++;
        const pct = Math.round((processed / totalToProcess) * 100);
        updateGeocodeStats(success, errors, totalToProcess - processed, pct);

        if (btn && !geocodingCancelled) btn.textContent = `${pct}% - Cancelar`;
        if (geocodeAlert) {
          const countEl = document.getElementById('geocode-count');
          if (countEl) countEl.textContent = clientsToGeocode.length - success;
        }

        if (processed % 25 === 0 && success > 0) {
          addClientMarkers(allClients);
        }

        await new Promise(r => setTimeout(r, 500));
      }

      // Completed
      document.getElementById('geocode-panel-title').textContent = geocodingCancelled ? 'Geocodificación cancelada' : 'Geocodificación completa';
      document.getElementById('geocode-close-btn').style.display = 'flex';
      geocodeLogEntry(`Resultado: ${success} OK, ${errors} errores de ${processed} procesados`, 'info');

      addClientMarkers(allClients);

      const remaining = allClients.filter(c => !c.lat && !c.lng && (c.address || c.commune)).length;

      if (remaining === 0) {
        if (geocodeAlert) geocodeAlert.style.display = 'none';
        if (btnLegend) btnLegend.style.display = 'none';
      } else {
        if (btn) {
          btn.textContent = 'Cargar Ubicaciones';
          btn.style.background = 'white';
          btn.style.color = '#d97706';
          btn.onclick = geocodeClientsWithoutCoords;
        }
        if (btnLegend) { btnLegend.disabled = false; }
        if (geocodeAlert) {
          const countEl = document.getElementById('geocode-count');
          if (countEl) countEl.textContent = remaining;
        }
      }

      lucide.createIcons();
    }

    // Dashboard loading progress
    let _sheetsSkipped = false;
    let _sheetsSkipResolve = null;

    function skipSheetsLoad() {
      _sheetsSkipped = true;
      const btn = document.getElementById('btn-skip-sheets');
      if (btn) btn.style.display = 'none';
      updateDashLoadingProgress(100, 'Google Sheets omitido — datos de base de datos');
      if (_sheetsSkipResolve) _sheetsSkipResolve();
    }

    function updateDashLoadingProgress(pct, label) {
      const fill = document.getElementById('dash-loading-fill');
      const pctEl = document.getElementById('dash-loading-pct');
      const labelEl = document.getElementById('dash-loading-label');
      const skipBtn = document.getElementById('btn-skip-sheets');
      if (fill) fill.style.width = pct + '%';
      if (pctEl) pctEl.textContent = pct + '%';
      if (labelEl && label) labelEl.textContent = label;
      // Show skip button when stuck on Sheets step
      if (skipBtn) skipBtn.style.display = (pct >= 60 && pct < 100) ? 'inline-block' : 'none';
      if (pct >= 100) {
        if (skipBtn) skipBtn.style.display = 'none';
        setTimeout(() => {
          const bar = document.getElementById('dash-loading-bar');
          if (bar) {
            bar.style.transition = 'opacity 0.5s, max-height 0.5s';
            bar.style.opacity = '0';
            bar.style.maxHeight = '0';
            bar.style.overflow = 'hidden';
            bar.style.marginBottom = '0';
            setTimeout(() => { if (bar) bar.style.display = 'none'; }, 600);
          }
        }, 800);
      }
    }

    // Load all data
    async function loadData() {
      try {
        updateDashLoadingProgress(5, 'Conectando con servidor...');
        const [users, vehicles, clients, products, routes, prices, fuelConfig] = await Promise.all([
          fetch(`${API}/api/users`).then(r => r.json()),
          fetch(`${API}/api/vehicles`).then(r => r.json()),
          fetch(`${API}/api/clients`).then(r => r.json()),
          fetch(`${API}/api/products`).then(r => r.json()),
          fetch(`${API}/api/daily-routes`).then(r => r.json()),
          fetch(`${API}/api/price-intelligence`).then(r => r.json()),
          fetch(`${API}/api/config/fuel-price`).then(r => r.json()).catch(() => null)
        ]);

        // Update fuel price from server config
        if (fuelConfig?.data?.price) {
          FUEL_PRICE_PER_LITER = fuelConfig.data.price;
          // Update vehicle display with dynamic price
          const priceDisplay = FUEL_PRICE_PER_LITER.toLocaleString('es-CL');
          const sourceTag = fuelConfig.data.source === 'CNE API' ? ' <span style="color:#10b981;font-size:9px;font-weight:600;">CNE</span>' : '';
          const vehicleInfoEl = document.querySelector('#standard-vehicle-display div:last-child div:last-child');
          if (vehicleInfoEl) {
            vehicleInfoEl.innerHTML = `10 km/L • Bencina 93 octanos • $${priceDisplay}/L${sourceTag}`;
          }
        }

        updateDashLoadingProgress(20, 'Datos del servidor cargados...');

        // Update stats
        document.getElementById('stat-users').textContent = users.data.filter(u => u.role === 'executive' || u.role === 'supervisor').length;
        document.getElementById('stat-clients').textContent = clients.data.length;
        document.getElementById('stat-routes').textContent = routes.data.filter(r => r.status === 'active').length;

        // Populate selects
        populateSelect('start-user', users.data, 'id', 'full_name');

        // Set standard vehicle (first active vehicle)
        const activeVehicles = vehicles.data.filter(v => v.status === 'active');
        if (activeVehicles.length > 0) {
          const standardVehicle = activeVehicles[0];
          document.getElementById('start-vehicle').value = standardVehicle.id;
          document.getElementById('standard-vehicle-name').textContent = standardVehicle.model;
        }

        // Clear client search (now using search + hidden input)
        document.getElementById('checkin-client-search').value = '';
        document.getElementById('checkin-client').value = '';
        document.getElementById('selected-client-card').style.display = 'none';
        document.getElementById('client-search-results').style.display = 'none';
        populateSelect('webhook-product', products.data, 'sku', d => `${d.sku} - ${d.name}`);
        populateSelect('compare-product', products.data, 'id', d => `${d.sku} - ${d.name}`);

        // Populate route executive select (vendedores)
        executives = users.data.filter(u => u.role === 'executive');

        // Store data globally for filtering
        allUsers = users.data;
        allVehicles = vehicles.data;
        allClients = clients.data;
        allRoutes = routes.data;
        filteredClients = [...allClients];
        currentClientsPage = 1;

        // Update admin info in sidebar
        updateCurrentAdminInfo();

        // Populate executive filter dropdowns
        // Note: executive-filter was replaced with executive-search (text input with dropdown)

        const visitExecFilterEl = document.getElementById('visit-executive-filter');
        if (visitExecFilterEl) {
          // Build dropdown with route status indicators
          let visitExecOpts = '<option value="">-- Seleccionar Vendedor --</option>';
          executives.forEach(e => {
            const hasActive = todayRoutesData.some(r => r.user_id === e.id && r.status === 'active');
            const hasCompleted = todayRoutesData.some(r => r.user_id === e.id && r.status !== 'active');
            const hasScheduled = (todayScheduledData[e.id] || []).length > 0;
            let statusTag = '';
            if (hasActive) statusTag = ' \u25CF En ruta';
            else if (hasCompleted) statusTag = ' \u25CB Completada';
            else if (hasScheduled) statusTag = ' \u25D4 Programada';
            visitExecOpts += `<option value="${e.id}">${e.full_name}${statusTag}</option>`;
          });
          visitExecFilterEl.innerHTML = visitExecOpts;

          // Auto-select executive in visits panel and hide dropdown
          if (currentUser && currentUser.role === 'executive') {
            visitExecFilterEl.value = currentUser.id;
            visitExecFilterEl.closest('.card-header, div')?.querySelectorAll('select').forEach(sel => {
              if (sel.id === 'visit-executive-filter') {
                sel.style.display = 'none';
              }
            });
          }
        }

        // Update counts
        document.getElementById('users-count').textContent = allUsers.length;
        document.getElementById('vehicles-count').textContent = allVehicles.length;
        document.getElementById('clients-count').textContent = allClients.length;
        document.getElementById('products-count').textContent = products.data.length;

        // Update tab counts
        const tabProductsCount = document.getElementById('tab-products-count');
        if (tabProductsCount) tabProductsCount.textContent = products.data.length;
        updateDataTabCounts();

        // Render tables
        renderUsersTable(allUsers.filter(u => u.role !== 'admin'));
        renderVehiclesTable(allVehicles);
        populateZoneFilter();
        initReassignSection();
        renderClientsTablePaginated();
        renderProductsTable(products.data);
        renderPricesTable(prices.data);

        updateDashLoadingProgress(35, 'Renderizando tablas...');

        // Add markers to map
        addClientMarkers(clients.data);

        updateDashLoadingProgress(45, 'Cargando rutas del día...');

        // Load today's routes for executive management (must be before rendering routes table)
        try {
          const todayRes = await fetch(`${API}/api/daily-routes/today`);
          const todayData = await todayRes.json();
          todayRoutesData = todayData.success ? todayData.data : [];
        } catch (e) {
          todayRoutesData = [];
        }

        // Load today's scheduled routes for visits panel
        try {
          const schedRes = await fetch(`${API}/api/routes/today-scheduled`);
          const schedData = await schedRes.json();
          todayScheduledData = schedData.success ? schedData.data : {};
        } catch (e) {
          todayScheduledData = {};
        }

        // Update dashboard stats from today's routes
        const todayActiveRoutes = todayRoutesData.filter(r => r.status === 'active');
        const todayVisitsCount = todayRoutesData.reduce((sum, r) => sum + (r.visits?.length || r.visits_count || 0), 0);
        document.getElementById('stat-routes').textContent = todayActiveRoutes.length;
        document.getElementById('stat-visits-today').textContent = todayVisitsCount;

        updateDashLoadingProgress(55, 'Procesando rutas activas...');

        // Render dashboard rutas summary from BD data
        renderDashboardRouteSummary();

        // Update routes select for visits
        const activeRoutes = routes.data.filter(r => r.status === 'active');
        if (activeRoutes.length > 0) {
          populateSelect('checkin-route', activeRoutes, 'id', d => `${d.user?.full_name} - ${d.date}`);
        }

        // Update executive stats
        updateExecutiveStats();

        // Load comparison
        if (products.data.length > 0) {
          loadComparison();
        }

        // Render executives panel
        renderExecutivesPanel(routes.data);

        // Render today's routes table
        renderTodayRoutesTable();

        // Re-init icons
        lucide.createIcons();

        updateDashLoadingProgress(60, 'Conectando Google Sheets...');

        // Load Google Sheets — timeout 15s + botón Saltar
        _sheetsSkipped = false;
        await Promise.race([
          loadGoogleSheetsData(false, true),
          new Promise(resolve => {
            _sheetsSkipResolve = resolve;
            setTimeout(() => {
              if (!_sheetsSkipped) {
                _sheetsSkipped = true;
                updateDashLoadingProgress(100, 'Google Sheets tardó demasiado — saltando');
                resolve();
              }
            }, 15000);
          })
        ]);

        // Initialize new dashboard components (segmentation, vendor stats, calendar, planner)
        initNewDashboardComponents();

        // Render executive personal dashboard if logged in as executive
        renderExecDashboard();

        // Auto-trigger visits filter for executive
        if (currentUser && currentUser.role === 'executive') {
          filterVisitsByExecutive();
        }

        // Refresh route dashboard if currently on routes panel (fixes race condition with stat cards)
        const routesPanel = document.getElementById('panel-routes');
        if (routesPanel && routesPanel.classList.contains('active')) {
          updateRouteDashboard();
        }

      } catch (error) {
        console.error('Error loading data:', error);
        updateDashLoadingProgress(100, 'Error al cargar datos');
      }
    }


    // =============================================
    // EXECUTIVE PERSONAL DASHBOARD
    // =============================================
    function renderExecDashboard() {
      if (!currentUser || currentUser.role !== 'executive') return;
      const uid = currentUser.id;

      // --- Mis Clientes ---
      const myClients = allClients.filter(c => c.assigned_user_id === uid);
      document.getElementById('exec-stat-clients').textContent = myClients.length;
      document.getElementById('exec-clients-count').textContent = `${myClients.length} clientes asignados`;

      // Segmentation counts
      const seg8020 = myClients.filter(c => c.segmentation === '80-20').length;
      const segL = myClients.filter(c => c.segmentation === 'L').length;
      const segN = myClients.filter(c => c.segmentation === 'N').length;
      const segContainer = document.getElementById('exec-clients-segmentation');
      if (segContainer) {
        segContainer.innerHTML = `
          <div style="text-align: center; padding: 12px; background: rgba(212,175,55,0.1); border-radius: 8px; border: 1px solid rgba(212,175,55,0.35);">
            <div style="font-size: 22px; font-weight: 700; color: #b8860b;">⭐ ${seg8020}</div>
            <div style="font-size: 11px; color: var(--text-muted); font-weight: 600;">80/20 Clave</div>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(59,130,246,0.08); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
            <div style="font-size: 22px; font-weight: 700; color: #2563eb;">${segL}</div>
            <div style="font-size: 11px; color: var(--text-muted);">L Con ventas</div>
          </div>
          <div style="text-align: center; padding: 12px; background: rgba(107,114,128,0.08); border-radius: 8px; border: 1px solid rgba(107,114,128,0.2);">
            <div style="font-size: 22px; font-weight: 700; color: #6b7280;">${segN}</div>
            <div style="font-size: 11px; color: var(--text-muted);">N Nuevos</div>
          </div>`;
      }

      // Clients table
      window._execClients = [...myClients].sort((a, b) => {
        const order = { '80-20': 0, 'L': 1, 'N': 2 };
        return (order[a.segmentation] ?? 3) - (order[b.segmentation] ?? 3);
      });
      _renderExecClientsTable();

      // --- Mi Ruta de Hoy ---
      const myRoute = todayRoutesData.find(r => r.user_id === uid);
      const myScheduled = todayScheduledData[uid] || [];
      const routeStatEl = document.getElementById('exec-stat-route');
      const routeContainer = document.getElementById('exec-route-today');
      const routeActions = document.getElementById('exec-route-actions');

      if (myRoute && myRoute.status === 'active') {
        // Active route
        const visits = myRoute.visits || [];
        const completed = visits.filter(v => v.status === 'completed').length;
        const total = myScheduled.length || visits.length || 0;
        routeStatEl.textContent = `${completed}/${total}`;
        routeStatEl.style.fontSize = '22px';
        routeActions.innerHTML = `<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
          <button onclick="document.querySelector('[data-tab=visits]').click()" class="btn btn-primary" style="font-size: 12px; padding: 6px 14px;">
            <i data-lucide="map-pin-check" style="width: 14px; height: 14px; vertical-align: -2px;"></i> Ir a Visitas</button>
          <button onclick="openExecRouteMaps()" style="background:rgba(51,204,255,0.1);border:1px solid rgba(51,204,255,0.3);border-radius:6px;cursor:pointer;padding:6px 10px;font-size:11px;font-weight:600;color:#33ccff;display:inline-flex;align-items:center;gap:4px;">
            <i data-lucide="map" style="width:12px;height:12px;"></i> Ver Mapa</button>
          <button onclick="endRoute('${myRoute.id}')" style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.3);border-radius:6px;cursor:pointer;padding:6px 10px;font-size:11px;font-weight:600;color:#f59e0b;display:inline-flex;align-items:center;gap:4px;">
            <i data-lucide="flag" style="width:12px;height:12px;"></i> Finalizar</button>
        </div>`;

        // Route client list
        let html = `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <div style="flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
            <div style="height: 100%; width: ${total > 0 ? Math.round(completed / total * 100) : 0}%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 3px; transition: width 0.5s;"></div>
          </div>
          <span style="font-size: 12px; font-weight: 600; color: #10b981;">${total > 0 ? Math.round(completed / total * 100) : 0}%</span>
        </div>`;

        // Show scheduled clients with visit status
        if (myScheduled.length > 0) {
          const firstPendingIdx = myScheduled.findIndex(s => !visits.find(v => v.client_id === s.client_id && v.status === 'completed'));
          html += '<div style="display:flex;flex-direction:column;">';
          myScheduled.forEach((sc, i) => {
            const client = allClients.find(c => c.id === sc.client_id);
            const visit = visits.find(v => v.client_id === sc.client_id && v.status === 'completed');
            const isDone = !!visit;
            const isNext = i === firstPendingIdx;
            const is8020 = client?.segmentation === '80-20';
            const hasGps = !!(client?.lat && client?.lng);
            const rowBg = isDone ? 'rgba(16,185,129,0.05)' : isNext ? 'linear-gradient(90deg,rgba(99,102,241,0.07),transparent)' : 'transparent';
            const numStyle = isDone ? 'background:#10b981;color:white;' : isNext ? 'background:#6366f1;color:white;' : 'background:var(--bg-hover);color:var(--text-muted);border:1px solid var(--border);';
            const clientName = client?.fantasy_name || client?.business_name || sc.client_name || 'Cliente';
            const clientAddr = client?.address ? (client.address + (client?.commune ? ', ' + client.commune : '')) : (client?.commune || '');
            html += `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:${rowBg};border-bottom:1px solid var(--border);">
              <span style="width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:2px;${numStyle}">${isDone ? '✓' : (i + 1)}</span>
              <div style="flex:1;min-width:0;">
                <div style="font-size:12px;font-weight:600;${isDone ? 'text-decoration:line-through;opacity:0.6;' : ''}display:flex;align-items:center;gap:4px;flex-wrap:wrap;">
                  ${clientName}
                  ${is8020 ? '<span style="font-size:9px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:1px 5px;border-radius:4px;">⭐</span>' : ''}
                  ${isNext ? '<span style="font-size:9px;font-weight:700;background:rgba(99,102,241,0.15);color:#6366f1;padding:1px 6px;border-radius:4px;">Próximo</span>' : ''}
                </div>
                ${clientAddr ? `<div style="font-size:11px;color:var(--text-muted);margin-top:1px;">${clientAddr}</div>` : ''}
              </div>
              <div style="display:flex;gap:4px;flex-shrink:0;align-items:center;margin-top:1px;">
                ${hasGps && !isDone ? `<button onclick="openWazeToClient(${client.lat},${client.lng})" style="background:rgba(51,204,255,0.1);border:1px solid rgba(51,204,255,0.3);border-radius:6px;cursor:pointer;padding:4px 6px;display:flex;align-items:center;" title="Waze"><i data-lucide="navigation" style="width:11px;height:11px;color:#33ccff;"></i></button>` : ''}
                ${!isDone && client?.id ? `<button onclick="goToCheckinClient('${client.id}')" style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:6px;cursor:pointer;padding:4px 8px;font-size:10px;font-weight:600;color:#6366f1;">Visitar</button>` : ''}
                ${isDone ? '<span style="font-size:10px;color:#10b981;font-weight:600;">✓ Hecho</span>' : ''}
              </div>
            </div>`;
          });
          html += '</div>';
        } else if (visits.length > 0) {
          html += `<div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">Ruta activa con ${visits.length} visitas registradas</div>`;
        }
        routeContainer.innerHTML = html;

        // Visits stat
        const completedVisits = visits.filter(v => v.status === 'completed').length;
        document.getElementById('exec-stat-visits').textContent = completedVisits;

      } else if (myScheduled.length > 0) {
        // Has scheduled but not started
        routeStatEl.textContent = 'Programada';
        routeStatEl.style.fontSize = '15px';
        routeActions.innerHTML = `<div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
          <button onclick="startDayFromDashboard()" class="btn btn-primary" style="font-size: 12px; padding: 6px 14px;" id="exec-start-day-btn">
            <i data-lucide="play-circle" style="width: 14px; height: 14px; vertical-align: -2px;"></i> Iniciar Jornada</button>
          <button onclick="openExecRouteMaps()" style="background:rgba(51,204,255,0.1);border:1px solid rgba(51,204,255,0.3);border-radius:6px;cursor:pointer;padding:6px 10px;font-size:11px;font-weight:600;color:#33ccff;display:inline-flex;align-items:center;gap:4px;">
            <i data-lucide="map" style="width:12px;height:12px;"></i> Ver Mapa</button>
        </div>`;

        let html = `<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(59,130,246,0.06);border-radius:8px;margin-bottom:12px;">
          <i data-lucide="info" style="width:16px;height:16px;color:#3b82f6;"></i>
          <span style="font-size:12px;color:#3b82f6;font-weight:500;">Tienes ${myScheduled.length} clientes programados para hoy</span>
        </div>`;
        html += '<div style="display:flex;flex-direction:column;">';
        myScheduled.forEach((sc, i) => {
          const client = allClients.find(c => c.id === sc.client_id);
          const is8020 = client?.segmentation === '80-20';
          const hasGps = !!(client?.lat && client?.lng);
          const isFirst = i === 0;
          const numStyle = isFirst ? 'background:#6366f1;color:white;' : 'background:var(--bg-hover);color:var(--text-muted);border:1px solid var(--border);';
          const rowBg = isFirst ? 'linear-gradient(90deg,rgba(99,102,241,0.06),transparent)' : 'transparent';
          const clientName = client?.fantasy_name || client?.business_name || sc.client_name || 'Cliente';
          const clientAddr = client?.address ? (client.address + (client?.commune ? ', ' + client.commune : '')) : (client?.commune || '');
          html += `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:${rowBg};border-bottom:1px solid var(--border);">
            <span style="width:22px;height:22px;border-radius:50%;${numStyle}display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;margin-top:2px;">${i + 1}</span>
            <div style="flex:1;min-width:0;">
              <div style="font-size:12px;font-weight:600;display:flex;align-items:center;gap:4px;flex-wrap:wrap;">
                ${clientName}
                ${is8020 ? '<span style="font-size:9px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:1px 5px;border-radius:4px;">⭐</span>' : ''}
                ${isFirst ? '<span style="font-size:9px;font-weight:700;background:rgba(99,102,241,0.15);color:#6366f1;padding:1px 6px;border-radius:4px;">Primero</span>' : ''}
              </div>
              ${clientAddr ? `<div style="font-size:11px;color:var(--text-muted);margin-top:1px;">${clientAddr}</div>` : ''}
            </div>
            <div style="display:flex;gap:4px;flex-shrink:0;align-items:center;margin-top:1px;">
              ${hasGps ? `<button onclick="openWazeToClient(${client.lat},${client.lng})" style="background:rgba(51,204,255,0.1);border:1px solid rgba(51,204,255,0.3);border-radius:6px;cursor:pointer;padding:4px 6px;display:flex;align-items:center;" title="Waze"><i data-lucide="navigation" style="width:11px;height:11px;color:#33ccff;"></i></button>` : ''}
              ${client?.id ? `<button onclick="goToCheckinClient('${client.id}')" style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:6px;cursor:pointer;padding:4px 8px;font-size:10px;font-weight:600;color:#6366f1;">Visitar</button>` : ''}
            </div>
          </div>`;
        });
        html += '</div>';
        routeContainer.innerHTML = html;
        document.getElementById('exec-stat-visits').textContent = '0';

      } else if (myRoute && myRoute.status === 'completed') {
        // Route completed today - show day summary
        const visits = myRoute.visits || [];
        const completed = visits.filter(v => v.status === 'completed').length;
        const outcomes = { sale: 0, contacted: 0, no_contact: 0 };
        visits.forEach(v => {
          if (v.outcome === 'sale' || v.outcome === 'venta') outcomes.sale++;
          else if (v.outcome === 'contacted' || v.outcome === 'seguimiento') outcomes.contacted++;
          else outcomes.no_contact++;
        });
        const totalKm = myRoute.end_km && myRoute.start_km ? (myRoute.end_km - myRoute.start_km) : null;
        routeStatEl.textContent = '✓ Terminada';
        routeStatEl.style.fontSize = '14px';
        routeActions.innerHTML = '';
        routeContainer.innerHTML = `<div style="text-align: center; padding: 24px;">
          <div style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 24px;">🎯</div>
          <div style="font-size: 18px; font-weight: 700; color: #10b981; margin-bottom: 4px;">¡Jornada Completada!</div>
          <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Buen trabajo hoy</div>
          <div style="display: grid; grid-template-columns: repeat(${outcomes.sale > 0 ? 3 : 2}, 1fr); gap: 10px; max-width: 320px; margin: 0 auto;">
            <div style="background: rgba(16,185,129,0.08); border-radius: 10px; padding: 12px; text-align: center;">
              <div style="font-size: 22px; font-weight: 700; color: #10b981;">${completed}</div>
              <div style="font-size: 10px; color: var(--text-muted);">Visitas</div>
            </div>
            ${outcomes.sale > 0 ? `<div style="background: rgba(37,99,235,0.08); border-radius: 10px; padding: 12px; text-align: center;">
              <div style="font-size: 22px; font-weight: 700; color: #2563eb;">${outcomes.sale}</div>
              <div style="font-size: 10px; color: var(--text-muted);">Ventas</div>
            </div>` : ''}
            ${totalKm ? `<div style="background: rgba(99,102,241,0.08); border-radius: 10px; padding: 12px; text-align: center;">
              <div style="font-size: 20px; font-weight: 700; color: #6366f1;">${totalKm.toLocaleString()}</div>
              <div style="font-size: 10px; color: var(--text-muted);">km</div>
            </div>` : ''}
          </div>
        </div>`;
        document.getElementById('exec-stat-visits').textContent = completed;
      } else {
        // No route at all
        routeStatEl.textContent = 'Sin ruta';
        routeStatEl.style.fontSize = '16px';
        routeActions.innerHTML = '';
        routeContainer.innerHTML = `<div style="text-align: center; padding: 32px; color: var(--text-muted);">
          <i data-lucide="map-pin-off" style="width: 36px; height: 36px; margin-bottom: 8px; opacity: 0.5;"></i>
          <p style="font-size: 13px; margin: 0;">No tienes ruta programada para hoy</p>
          <p style="font-size: 11px; margin: 4px 0 0;">Contacta a tu supervisor para asignación de ruta</p>
        </div>`;
        document.getElementById('exec-stat-visits').textContent = '0';
      }

      // --- Mapa de mi ruta ---
      const mapClients = myScheduled.length > 0
        ? myScheduled.map(sc => {
            const c = allClients.find(cl => cl.id === sc.client_id);
            return c || { lat: null, lng: null, fantasy_name: sc.client_name || 'Cliente' };
          })
        : (myRoute?.visits || []).map(v => {
            const c = allClients.find(cl => cl.id === v.client_id);
            return c || { lat: null, lng: null };
          });
      initExecRouteMap(mapClients, myRoute);

      // --- Mis Ventas ---
      renderExecVentas();

      // --- Mis Cobranzas ---
      renderExecCobranzas(myClients);

      // Re-init icons
      lucide.createIcons();
    }

    function _renderExecClientsTable(search) {
      const tbody = document.getElementById('exec-clients-tbody');
      if (!tbody || !window._execClients) return;
      const q = (search || '').toLowerCase().trim();
      const list = q
        ? window._execClients.filter(c =>
            (c.fantasy_name || '').toLowerCase().includes(q) ||
            (c.business_name || '').toLowerCase().includes(q) ||
            (c.commune || '').toLowerCase().includes(q) ||
            (c.external_id || '').toLowerCase().includes(q))
        : window._execClients;

      tbody.innerHTML = list.slice(0, 100).map(c => {
        const is8020 = c.segmentation === '80-20';
        const badge8020 = is8020 ? `<span style="font-size:9px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:1px 5px;border-radius:4px;margin-left:4px;">⭐</span>` : '';
        const segBadge = is8020
          ? `<span style="font-size:11px;font-weight:700;background:rgba(212,175,55,0.15);color:#b8860b;border:1px solid rgba(212,175,55,0.35);padding:2px 8px;border-radius:10px;">80/20</span>`
          : c.segmentation === 'L'
            ? `<span style="font-size:11px;font-weight:600;background:rgba(37,99,235,0.1);color:#2563eb;border:1px solid rgba(37,99,235,0.25);padding:2px 8px;border-radius:10px;">L</span>`
            : `<span style="font-size:11px;color:var(--text-muted);border:1px solid var(--border);padding:2px 8px;border-radius:10px;">${c.segmentation || '-'}</span>`;
        const wazeBtn = (c.lat && c.lng)
          ? `<button onclick="openWazeToClient(${c.lat},${c.lng})" style="background:rgba(51,204,255,0.1);border:1px solid rgba(51,204,255,0.3);border-radius:6px;cursor:pointer;padding:3px 5px;display:flex;align-items:center;" title="Waze"><i data-lucide="navigation" style="width:11px;height:11px;color:#33ccff;"></i></button>`
          : '';
        return `<tr ${is8020 ? 'style="background:rgba(212,175,55,0.04);"' : ''}>
          <td style="font-weight:${is8020 ? '600' : '500'};">${c.fantasy_name || c.business_name || '-'}${badge8020}</td>
          <td style="font-size:12px;">${c.commune || '-'}</td>
          <td>${segBadge}</td>
          <td>${wazeBtn}</td>
        </tr>`;
      }).join('');
      if (list.length > 100) {
        tbody.innerHTML += `<tr><td colspan="4" style="text-align:center;color:var(--text-muted);font-size:12px;">...y ${list.length - 100} más</td></tr>`;
      }
      lucide.createIcons();
    }

    function filterExecClients() {
      const q = document.getElementById('exec-clients-search')?.value || '';
      _renderExecClientsTable(q);
    }

    let execMapInstance = null;
    function initExecRouteMap(clients, activeRoute) {
      const mapDiv = document.getElementById('exec-route-map');
      if (!mapDiv || typeof google === 'undefined' || !google.maps) {
        if (mapDiv) mapDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 12px;">Mapa no disponible</div>';
        return;
      }

      const withGPS = clients.filter(c => c.lat && c.lng);
      if (withGPS.length === 0) {
        mapDiv.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 12px; gap: 8px;"><i data-lucide="map-pin-off" style="width: 28px; height: 28px; opacity: 0.3;"></i>Sin ubicaciones GPS</div>';
        lucide.createIcons();
        return;
      }

      const center = { lat: withGPS[0].lat, lng: withGPS[0].lng };
      execMapInstance = new google.maps.Map(mapDiv, {
        center,
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        zoomControl: true,
        styles: [{ featureType: 'poi', stylers: [{ visibility: 'off' }] }]
      });

      const bounds = new google.maps.LatLngBounds();

      withGPS.forEach((client, idx) => {
        const pos = { lat: client.lat, lng: client.lng };
        bounds.extend(pos);

        const is8020 = client.segmentation === '80-20';
        const isVisited = activeRoute?.visits?.some(v => v.client_id === client.id && v.status === 'completed');
        const fillColor = isVisited ? '#10b981' : (is8020 ? '#f59e0b' : '#6366f1');

        const marker = new google.maps.Marker({
          position: pos,
          map: execMapInstance,
          label: { text: String(idx + 1), color: 'white', fontSize: '10px', fontWeight: '700' },
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 14,
            fillColor: fillColor,
            fillOpacity: 1,
            strokeColor: 'white',
            strokeWeight: 2
          },
          title: client.fantasy_name || client.business_name || client.name || ''
        });

        const infoContent = `<div style="font-size: 12px; max-width: 220px;">
          <strong>${idx + 1}. ${client.fantasy_name || client.business_name || ''}</strong>
          <div style="color: #666; margin-top: 2px;">${client.address || ''}</div>
          ${client.commune ? `<div style="color: #999;">${client.commune}</div>` : ''}
          ${isVisited ? '<div style="color: #10b981; font-weight: 600; margin-top: 4px;">✓ Visitado</div>' : ''}
          <div style="margin-top: 6px; display: flex; gap: 4px;">
            ${client.lat && client.lng ? `<a href="https://waze.com/ul?ll=${client.lat},${client.lng}&navigate=yes" target="_blank" style="font-size: 11px; color: #33ccff; text-decoration: none; font-weight: 600;">Waze</a>
            <span style="color: #ccc;">·</span>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${client.lat},${client.lng}" target="_blank" style="font-size: 11px; color: #4285f4; text-decoration: none; font-weight: 600;">Maps</a>` : ''}
          </div>
        </div>`;
        const infoWindow = new google.maps.InfoWindow({ content: infoContent });
        marker.addListener('click', () => infoWindow.open(execMapInstance, marker));
      });

      execMapInstance.fitBounds(bounds);
      if (withGPS.length === 1) setTimeout(() => execMapInstance.setZoom(14), 300);

      // Draw route line
      if (withGPS.length > 1) {
        const directionsService = new google.maps.DirectionsService();
        const directionsRenderer = new google.maps.DirectionsRenderer({
          map: execMapInstance,
          suppressMarkers: true,
          polylineOptions: { strokeColor: '#6366f1', strokeOpacity: 0.7, strokeWeight: 4 }
        });

        const origin = { lat: withGPS[0].lat, lng: withGPS[0].lng };
        const dest = { lat: withGPS[withGPS.length - 1].lat, lng: withGPS[withGPS.length - 1].lng };
        const wps = withGPS.slice(1, -1);
        let waypoints;
        if (wps.length <= 23) {
          waypoints = wps.map(c => ({ location: { lat: c.lat, lng: c.lng }, stopover: true }));
        } else {
          waypoints = [];
          const step = wps.length / 23;
          for (let i = 0; i < 23; i++) {
            const c = wps[Math.round(i * step)];
            waypoints.push({ location: { lat: c.lat, lng: c.lng }, stopover: true });
          }
        }

        directionsService.route({
          origin, destination: dest, waypoints,
          travelMode: google.maps.TravelMode.DRIVING,
          optimizeWaypoints: false
        }, (result, status) => {
          if (status === 'OK') directionsRenderer.setDirections(result);
        });
      }
    }

    function renderExecVentas() {
      const listEl = document.getElementById('exec-ventas-list');
      const summaryEl = document.getElementById('exec-ventas-summary');
      const totalEl = document.getElementById('exec-ventas-total');
      const monthLabel = document.getElementById('exec-ventas-month-label');
      const statEl = document.getElementById('exec-stat-ventas');

      if (!gsheetsAllVentas || gsheetsAllVentas.length <= 1) {
        if (statEl) statEl.textContent = '-';
        if (listEl) listEl.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Sin datos de ventas</div>';
        if (summaryEl) summaryEl.innerHTML = '';
        return;
      }

      const headers = gsheetsAllVentas[0];
      const vendedorIdx = headers.findIndex(h => h && (h.toLowerCase().includes('vendedor') || h.toLowerCase().includes('ejecutivo')));
      const montoIdx = headers.findIndex(h => h && (h.toLowerCase().includes('monto') || h.toLowerCase().includes('venta') || h.toLowerCase().includes('total')));
      const clienteIdx = headers.findIndex(h => h && (h.toLowerCase().includes('cliente') || h.toLowerCase().includes('razón') || h.toLowerCase().includes('razon')));
      const mesIdx = headers.findIndex(h => h && h.toLowerCase().includes('mes'));
      const fechaIdx = headers.findIndex(h => h && (h.toLowerCase().includes('fecha') || h.toLowerCase().includes('date')));
      const docIdx = headers.findIndex(h => h && (h.toLowerCase().includes('documento') || h.toLowerCase().includes('factura') || h.toLowerCase().includes('dte') || h.toLowerCase().includes('folio')));

      if (vendedorIdx < 0 || montoIdx < 0) {
        if (statEl) statEl.textContent = '-';
        if (listEl) listEl.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Columnas de ventas no reconocidas</div>';
        if (summaryEl) summaryEl.innerHTML = '';
        return;
      }

      // Match by executive name (fuzzy)
      const execName = currentUser.full_name.toLowerCase().trim();
      const execParts = execName.split(/\s+/);

      // Get current month name for filtering
      const now = new Date();
      const monthNames = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
      const currentMonthName = monthNames[now.getMonth()];
      const currentYear = now.getFullYear();

      let myRows = [];
      let totalVentas = 0;
      let countDocs = 0;

      gsheetsAllVentas.slice(1).forEach(row => {
        const vendedor = String(row[vendedorIdx] || '').toLowerCase().trim();
        // Match: name contains any significant part of exec name (surname)
        const isMyRow = execParts.some(part => part.length > 2 && vendedor.includes(part)) ||
                        vendedor.includes(execName);
        if (!isMyRow) return;

        // Optional month filter: if mes column exists, filter current month
        if (mesIdx >= 0) {
          const rowMes = String(row[mesIdx] || '').toLowerCase().trim();
          if (rowMes && !rowMes.includes(currentMonthName)) return;
        }

        const monto = parseFloat(String(row[montoIdx] || '0').replace(/[$.,\s]/g, '')) || 0;
        totalVentas += monto;
        countDocs++;

        myRows.push({
          cliente: clienteIdx >= 0 ? row[clienteIdx] : '-',
          monto: monto,
          montoRaw: row[montoIdx] || '-',
          fecha: fechaIdx >= 0 ? row[fechaIdx] : '',
          doc: docIdx >= 0 ? row[docIdx] : ''
        });
      });

      // Month label
      if (monthLabel) {
        monthLabel.textContent = `— ${currentMonthName.charAt(0).toUpperCase() + currentMonthName.slice(1)} ${currentYear}`;
      }

      // Stat card
      if (statEl) {
        statEl.textContent = totalVentas > 0 ? `$${Math.round(totalVentas / 1000)}K` : '-';
        statEl.style.fontSize = totalVentas > 0 ? '16px' : '18px';
      }

      // Total header
      if (totalEl) {
        totalEl.textContent = totalVentas > 0 ? `$${totalVentas.toLocaleString('es-CL')}` : '';
      }

      // Summary stats (3 boxes)
      if (summaryEl) {
        // Calculate unique clients
        const uniqueClients = new Set(myRows.map(r => String(r.cliente).toLowerCase().trim()).filter(Boolean));
        const avgPerDoc = countDocs > 0 ? Math.round(totalVentas / countDocs) : 0;

        summaryEl.innerHTML = `
          <div style="padding: 12px; text-align: center; border-right: 1px solid var(--border);">
            <div style="font-size: 22px; font-weight: 700; color: #10b981;">$${totalVentas.toLocaleString('es-CL')}</div>
            <div style="font-size: 11px; color: var(--text-muted);">Total Ventas</div>
          </div>
          <div style="padding: 12px; text-align: center; border-right: 1px solid var(--border);">
            <div style="font-size: 22px; font-weight: 700; color: var(--accent);">${countDocs}</div>
            <div style="font-size: 11px; color: var(--text-muted);">Documentos</div>
          </div>
          <div style="padding: 12px; text-align: center;">
            <div style="font-size: 22px; font-weight: 700;">${uniqueClients.size}</div>
            <div style="font-size: 11px; color: var(--text-muted);">Clientes</div>
          </div>`;
      }

      // List
      if (listEl) {
        if (myRows.length === 0) {
          listEl.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Sin ventas registradas este mes</div>';
          return;
        }

        // Sort by monto descending
        const sorted = myRows.sort((a, b) => b.monto - a.monto);
        let html = '<div style="display: flex; flex-direction: column;">';
        sorted.slice(0, 20).forEach((item, i) => {
          html += `<div style="display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid var(--border);">
            <span style="width: 22px; height: 22px; border-radius: 50%; background: ${i < 3 ? '#10b981' : 'var(--bg-hover)'}; color: ${i < 3 ? 'white' : 'var(--text-muted)'}; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0;">${i + 1}</span>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.cliente}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${item.doc ? item.doc + ' · ' : ''}${item.fecha}</div>
            </div>
            <span style="font-size: 12px; font-weight: 700; color: #10b981; white-space: nowrap;">$${item.monto.toLocaleString('es-CL')}</span>
          </div>`;
        });
        if (sorted.length > 20) {
          html += `<div style="text-align: center; padding: 10px; color: var(--text-muted); font-size: 11px;">...y ${sorted.length - 20} más</div>`;
        }
        html += '</div>';
        listEl.innerHTML = html;
      }
    }

    function renderExecCobranzas(myClients) {
      const listEl = document.getElementById('exec-cobranzas-list');
      const badgeEl = document.getElementById('exec-cobranzas-badge');
      const statEl = document.getElementById('exec-stat-cobranzas');

      if (!gsheetsAllCobranzas || gsheetsAllCobranzas.length <= 1) {
        statEl.textContent = '-';
        if (listEl) listEl.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Sin datos de cobranzas</div>';
        return;
      }

      // Build sets for matching: names and external_ids (codes)
      const myClientNames = new Set();
      const myClientCodes = new Set();
      myClients.forEach(c => {
        if (c.fantasy_name) myClientNames.add(c.fantasy_name.toLowerCase().trim());
        if (c.business_name) myClientNames.add(c.business_name.toLowerCase().trim());
        if (c.name) myClientNames.add(c.name.toLowerCase().trim());
        if (c.external_id) myClientCodes.add(String(c.external_id).trim());
        if (c.code) myClientCodes.add(String(c.code).trim());
      });

      const headers = gsheetsAllCobranzas[0];
      const clienteIdx = headers.findIndex(h => h && (h.toLowerCase().includes('cliente') || h.toLowerCase().includes('razón') || h.toLowerCase().includes('razon')));
      const codigoIdx = headers.findIndex(h => h && (h.toLowerCase().includes('código') || h.toLowerCase().includes('codigo') || h.toLowerCase() === 'cod' || h.toLowerCase() === 'rut'));
      const montoIdx = headers.findIndex(h => h && (h.toLowerCase().includes('monto') || h.toLowerCase().includes('saldo') || h.toLowerCase().includes('deuda')));
      const diasIdx = headers.findIndex(h => h && (h.toLowerCase().includes('días') || h.toLowerCase().includes('dias') || h.toLowerCase().includes('atraso')));
      const vencIdx = headers.findIndex(h => h && (h.toLowerCase().includes('venc') || h.toLowerCase().includes('fecha')));

      let myCobranzas = [];
      gsheetsAllCobranzas.slice(1).forEach(row => {
        const clientName = clienteIdx >= 0 ? String(row[clienteIdx] || '').toLowerCase().trim() : '';
        const clientCode = codigoIdx >= 0 ? String(row[codigoIdx] || '').trim() : '';
        // Match by code (preferred) or name
        let isMyClient = clientCode && myClientCodes.has(clientCode);
        if (!isMyClient) {
          for (const name of myClientNames) {
            if (name && clientName && (clientName.includes(name) || name.includes(clientName))) {
              isMyClient = true;
              break;
            }
          }
        }
        if (!isMyClient) return;

        const dias = diasIdx >= 0 ? parseInt(String(row[diasIdx] || '0').replace(/[^\d-]/g, '')) : 0;
        // Cross-reference with allClients for 80/20 info
        const clientObj = myClients.find(c => {
          if (clientCode && c.external_id && String(c.external_id).trim() === clientCode) return true;
          const fn = (c.fantasy_name || '').toLowerCase().trim();
          const bn = (c.business_name || '').toLowerCase().trim();
          return fn && clientName && (clientName.includes(fn) || fn.includes(clientName)) ||
                 bn && clientName && (clientName.includes(bn) || bn.includes(clientName));
        });
        myCobranzas.push({
          cliente: clienteIdx >= 0 ? row[clienteIdx] : '-',
          monto: montoIdx >= 0 ? row[montoIdx] : '-',
          dias: dias,
          fecha: vencIdx >= 0 ? row[vencIdx] : '-',
          is8020: clientObj ? clientObj.segmentation === '80-20' : false
        });
      });

      const vencidas = myCobranzas.filter(c => c.dias > 0);
      statEl.textContent = vencidas.length > 0 ? vencidas.length : (myCobranzas.length > 0 ? myCobranzas.length : '-');

      if (badgeEl && vencidas.length > 0) {
        badgeEl.textContent = vencidas.length;
        badgeEl.style.display = 'inline';
      }

      if (listEl) {
        if (myCobranzas.length === 0) {
          listEl.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Sin cobranzas pendientes</div>';
          return;
        }
        const sorted = myCobranzas.sort((a, b) => b.dias - a.dias);
        let html = '<div style="display: flex; flex-direction: column;">';
        sorted.forEach(item => {
          const diasColor = item.dias > 60 ? '#ef4444' : item.dias > 30 ? '#f59e0b' : '#6b7280';
          const badge8020 = item.is8020 ? `<span style="font-size:9px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:1px 5px;border-radius:4px;margin-left:4px;">80/20</span>` : '';
          html += `<div style="display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid var(--border); ${item.is8020 ? 'background:rgba(212,175,55,0.03);' : ''}">
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.cliente}${badge8020}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${item.monto}</div>
            </div>
            ${item.dias > 0 ? `<span style="font-size: 11px; font-weight: 700; color: ${diasColor}; background: ${diasColor}15; padding: 2px 8px; border-radius: 10px; white-space: nowrap;">${item.dias}d</span>` : `<span style="font-size: 11px; color: var(--text-muted);">${item.fecha}</span>`}
          </div>`;
        });
        html += '</div>';
        listEl.innerHTML = html;
      }
    }

    function populateSelect(id, data, valueKey, labelFn) {
      const select = document.getElementById(id);
      if (!select) return;
      const currentValue = select.value;
      select.innerHTML = '<option value="">-- Seleccionar --</option>';
      data.forEach(item => {
        const option = document.createElement('option');
        option.value = item[valueKey];
        option.textContent = typeof labelFn === 'function' ? labelFn(item) : item[labelFn];
        select.appendChild(option);
      });
      if (currentValue) select.value = currentValue;
    }

    function showResponse(elementId, data, success) {
      const box = document.getElementById(elementId);
      box.style.display = 'block';
      box.className = `response-box ${success ? 'success' : 'error'}`;
      box.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    // Form handlers
    document.getElementById('form-start-day').addEventListener('submit', async (e) => {
      e.preventDefault();
      const userId = document.getElementById('start-user').value;
      const body = {
        userId: userId,
        vehicleId: document.getElementById('start-vehicle').value,
        startKm: parseFloat(document.getElementById('start-km').value)
      };

      // Hide any previous response
      document.getElementById('response-start').style.display = 'none';

      try {
        const res = await fetch(`${API}/routes/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        if (data.success) {
          // Show success toast
          showToast('success', 'Día Iniciado', `Ruta creada para ${data.data.user.name}`);

          // Reload data
          await loadData();

          // Check and display the active route
          await checkActiveRoute(userId);

          // Load route on map
          if (data.data.route) {
            const assignedClients = allClients.filter(c => c.assigned_user_id === userId);
            const mockRoute = {
              ...data.data.route,
              user: { full_name: data.data.user.name },
              vehicle: { license_plate: data.data.vehicle.plate },
              visits: assignedClients.map(client => ({ client, outcome: 'pending' }))
            };
            await displayRouteOnMap(mockRoute);
          }
        } else {
          // Show error toast
          showToast('error', 'Error', data.error || 'No se pudo iniciar el día');
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      }
    });

    document.getElementById('form-checkin').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width: 16px; height: 16px;"></i> Obteniendo ubicación...';
      submitBtn.disabled = true;
      lucide.createIcons();

      // Get geolocation
      let lat = null, lng = null;
      try {
        const position = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('Geolocalización no soportada'));
            return;
          }
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          });
        });
        lat = position.coords.latitude;
        lng = position.coords.longitude;
      } catch (geoError) {
        console.warn('No se pudo obtener ubicación:', geoError.message);
        showToast('warning', 'Sin GPS', 'Check-in sin geolocalización');
      }

      submitBtn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width: 16px; height: 16px;"></i> Registrando...';
      lucide.createIcons();

      const clientId = document.getElementById('checkin-client').value;

      // Check if address needs correction
      const correctAddress = document.getElementById('correct-address-check').checked;
      let addressUpdate = null;

      if (correctAddress && correctedAddress) {
        addressUpdate = {
          address: correctedAddress.address || document.getElementById('address-search').value,
          commune: correctedAddress.commune || document.getElementById('address-commune').value,
          lat: correctedAddress.lat,
          lng: correctedAddress.lng
        };
      }

      // Gather checklist data
      const checklistData = {
        cobranzas_ok: document.getElementById('chk-cobranzas')?.checked || false,
        ultima_compra_ok: document.getElementById('chk-compra')?.checked || false,
        ultima_visita_ok: document.getElementById('chk-visita')?.checked || false
      };

      const body = {
        routeId: document.getElementById('checkin-route').value,
        clientId,
        outcome: document.getElementById('checkin-outcome').value,
        lat,
        lng,
        addressUpdate,
        checklistData
      };

      try {
        const res = await fetch(`${API}/routes/checkin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        if (data.success) {
          const locationMsg = lat && lng ? ` (GPS: ${lat.toFixed(4)}, ${lng.toFixed(4)})` : ' (sin GPS)';
          let successMsg = data.data.client.name + locationMsg;
          if (addressUpdate) {
            successMsg += ' - Dirección actualizada';
          }
          showToast('success', 'Check-in registrado', successMsg);

          // Reset form: clear client + address + checklist
          correctedAddress = null;
          clearSelectedClient();
          document.getElementById('correct-address-check').checked = false;
          ['chk-cobranzas', 'chk-compra', 'chk-visita'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.checked = false;
          });

          // Find next pending client in route and auto-scroll to suggest it
          const execId = document.getElementById('visit-executive-filter')?.value;
          if (execId) {
            const scheduled = todayScheduledData[execId] || [];
            const routeVisits = (todayRoutesData.find(r => r.user_id === execId)?.visits || []);
            const visitedIds = new Set(routeVisits.map(v => v.client_id));
            visitedIds.add(clientId); // include just-registered
            const nextSc = scheduled.find(sc => !visitedIds.has(sc.client_id));
            if (nextSc?.client) {
              setTimeout(() => {
                const c = nextSc.client;
                showToast('info', 'Próximo cliente', `${c.fantasy_name || c.name || 'Cliente'} — ${c.commune || ''}`);
              }, 800);
            }
          }
        }

        if (!data.success) showResponse('response-checkin', data, false);
        else document.getElementById('response-checkin').style.display = 'none';
        loadData();
      } catch (error) {
        showResponse('response-checkin', { error: error.message }, false);
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        lucide.createIcons();
      }
    });

    document.getElementById('form-webhook').addEventListener('submit', async (e) => {
      e.preventDefault();
      const body = {
        productSku: document.getElementById('webhook-product').value,
        competitorName: document.getElementById('webhook-competitor').value,
        detectedPrice: parseFloat(document.getElementById('webhook-price').value),
        source: 'n8n_scraper'
      };
      try {
        const res = await fetch(`${API}/webhooks/n8n-price-update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        showResponse('response-webhook', data, data.success);
        loadData();
      } catch (error) {
        showResponse('response-webhook', { error: error.message }, false);
      }
    });

    // Route Map Functions
    let routePolyline = null;
    let routeMarkers = [];
    let directionsService = null;
    const directionsCache = new Map();

    async function loadTodayRoutes() {
      try {
        const res = await fetch(`${API}/api/daily-routes/today`);
        const data = await res.json();

        if (data.success && data.data.length > 0) {
          // Load first route by default
          await displayRouteOnMap(data.data[0]);
        } else {
          // No routes today, show all clients
          clearRouteFromMap();
          document.getElementById('route-legend').style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading today routes:', error);
      }
    }

    async function loadExecutiveRoute() {
      const userId = document.getElementById('select-route-executive').value;
      if (!userId) {
        showToast('warning', 'Atención', 'Seleccione un vendedor');
        return;
      }

      try {
        const res = await fetch(`${API}/api/users/${userId}/routes`);
        const data = await res.json();

        if (data.success && data.data.length > 0) {
          // Get most recent/active route
          const activeRoute = data.data.find(r => r.status === 'active') || data.data[0];
          await displayRouteOnMap(activeRoute);
        } else {
          showToast('warning', 'Sin rutas', 'No hay rutas activas para este vendedor');
          clearRouteFromMap();
        }
      } catch (error) {
        console.error('Error loading executive route:', error);
      }
    }

    // Split coordinates into chunks for Directions API (max 25 points per request)
    function chunkWaypoints(latLngs, maxPerRequest = 25) {
      if (latLngs.length <= maxPerRequest) return [latLngs];
      const chunks = [];
      let start = 0;
      while (start < latLngs.length - 1) {
        const end = Math.min(start + maxPerRequest, latLngs.length);
        chunks.push(latLngs.slice(start, end));
        start = end - 1; // overlap: last point of chunk N = first of chunk N+1
      }
      return chunks;
    }

    // Get real street route via Google Directions API with caching
    async function getDirectionsRoute(coordinates) {
      console.log(`[Directions] Requesting route for ${coordinates.length} points, directionsService=${!!directionsService}`);
      if (!directionsService || coordinates.length < 2) {
        console.warn('[Directions] No directionsService or < 2 points');
        return null;
      }

      // Build cache key from rounded coordinates
      const cacheKey = coordinates.map(c => `${c.lat.toFixed(5)},${c.lng.toFixed(5)}`).join('|');
      if (directionsCache.has(cacheKey)) {
        console.log('[Directions] Cache hit');
        return directionsCache.get(cacheKey);
      }

      try {
        const chunks = chunkWaypoints(coordinates);
        let fullPath = [];
        let totalDistanceM = 0;
        let totalDurationS = 0;

        for (let ci = 0; ci < chunks.length; ci++) {
          if (ci > 0) await new Promise(r => setTimeout(r, 300)); // delay between chunks
          const chunk = chunks[ci];
          const origin = chunk[0];
          const destination = chunk[chunk.length - 1];
          const waypoints = chunk.slice(1, -1).map(c => ({
            location: new google.maps.LatLng(c.lat, c.lng),
            stopover: true
          }));

          const result = await new Promise((resolve, reject) => {
            const attemptRoute = (retries = 0) => {
              directionsService.route({
                origin: new google.maps.LatLng(origin.lat, origin.lng),
                destination: new google.maps.LatLng(destination.lat, destination.lng),
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING,
                region: 'cl'
              }, (response, status) => {
                console.log(`[Directions] Chunk ${ci+1}/${chunks.length} attempt ${retries}: status=${status}`);
                if (status === 'OK') resolve(response);
                else if (status === 'OVER_QUERY_LIMIT' && retries < 3) {
                  console.warn(`[Directions] Rate limited, retry ${retries+1} in ${(retries+1)}s...`);
                  setTimeout(() => attemptRoute(retries + 1), 1000 * (retries + 1));
                } else reject(new Error(`Directions API: ${status}`));
              });
            };
            attemptRoute();
          });

          // Extract DETAILED path from all legs/steps (not overview which is simplified)
          const route = result.routes[0];
          let chunkPath = [];
          for (const leg of route.legs) {
            totalDistanceM += leg.distance.value;
            totalDurationS += leg.duration.value;
            for (const step of leg.steps) {
              // step.path has detailed lat/lng points that follow the road
              if (step.path && step.path.length > 0) {
                if (chunkPath.length > 0) {
                  chunkPath = chunkPath.concat(step.path.slice(1)); // skip duplicate start
                } else {
                  chunkPath = chunkPath.concat(step.path);
                }
              }
            }
          }

          if (fullPath.length > 0) {
            fullPath = fullPath.concat(chunkPath.slice(1));
          } else {
            fullPath = chunkPath;
          }
        }

        const result = {
          path: fullPath,
          totalDistanceKm: Math.round((totalDistanceM / 1000) * 10) / 10,
          totalDurationMin: Math.round(totalDurationS / 60)
        };

        directionsCache.set(cacheKey, result);
        console.log(`Directions: ${result.totalDistanceKm} km, ${result.totalDurationMin} min`);
        return result;
      } catch (error) {
        console.error('[Directions] FAILED:', error.message);
        return null;
      }
    }

    function clearRouteFromMap() {
      if (routePolyline) {
        routePolyline.setMap(null);
        routePolyline = null;
      }
      routeMarkers.forEach(m => m.setMap(null));
      routeMarkers = [];
    }

    async function displayRouteOnMap(route) {
      clearRouteFromMap();

      if (!route || !route.visits || route.visits.length === 0) {
        document.getElementById('route-legend').style.display = 'none';
        return;
      }

      const coordinates = [];
      const visits = route.visits;
      const bounds = new google.maps.LatLngBounds();

      // Status colors
      const statusColors = {
        pending: '#9ca3af',
        current: '#3b82f6',
        visited: '#10b981',
        sold: '#059669',
        no_sale: '#f59e0b',
        closed: '#ef4444'
      };

      // Add visit markers
      visits.forEach((visit, index) => {
        if (!visit.client || !visit.client.lat || !visit.client.lng) return;

        const position = { lat: parseFloat(visit.client.lat), lng: parseFloat(visit.client.lng) };
        coordinates.push(position);
        bounds.extend(position);

        // Determine marker status
        let statusClass = 'pending';
        let statusLabel = 'Pendiente';
        if (visit.check_out) {
          statusClass = visit.outcome || 'visited';
          statusLabel = getOutcomeLabel(visit.outcome);
        } else if (visit.check_in) {
          statusClass = 'current';
          statusLabel = 'En visita';
        }

        const color = statusColors[statusClass] || statusColors.pending;

        const extId = visit.client.external_id || String(index + 1);
        const marker = new google.maps.Marker({
          position: position,
          map: routeMap,
          label: {
            text: extId.length > 6 ? extId.slice(-5) : extId,
            color: 'white',
            fontSize: '8px',
            fontWeight: 'bold'
          },
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: color,
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2,
            scale: 16
          },
          title: `${extId} — ${visit.client.name}`
        });

        const sheetsBtn = window._sheetsUrl
          ? `<a href="${window._sheetsUrl}" target="_blank" rel="noopener"
               style="display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:5px 10px;background:#16a34a;color:white;border-radius:6px;font-size:11px;font-weight:600;text-decoration:none;">
               <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
               Editar en Sheets (${extId})
             </a>`
          : '';
        const infoContent = `
          <div style="min-width: 220px; padding: 8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <strong style="font-size: 13px; color: #1f2937;">${index + 1}. ${visit.client.fantasy_name || visit.client.name}</strong>
              <code style="font-size:10px;background:#6366f1;color:white;padding:2px 6px;border-radius:4px;">${extId}</code>
            </div>
            <div style="color: #6b7280; font-size: 11px;">
              ${visit.client.address || ''}<br>${visit.client.commune || ''}
            </div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${statusLabel}</span>
              ${visit.client.segmentation === '80-20' ? '<span style="background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;">⭐ 80/20</span>' : ''}
              ${visit.client.priority === 'FOCO' ? '<span style="background:#ef4444;color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">FOCO</span>' : ''}
              ${visit.ai_summary ? `<p style="margin-top: 6px; font-size: 11px; color: #9ca3af; width: 100%;">${visit.ai_summary}</p>` : ''}
            </div>
            <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">
              <a href="https://waze.com/ul?ll=${position.lat},${position.lng}&navigate=yes" target="_blank" rel="noopener"
                 style="display:inline-flex;align-items:center;gap:4px;padding:5px 10px;background:#33ccff;color:#000;border-radius:6px;font-size:11px;font-weight:600;text-decoration:none;">
                &#9992; Waze
              </a>
              ${sheetsBtn}
            </div>
          </div>
        `;

        marker.addListener('click', () => {
          routeInfoWindow.setContent(infoContent);
          routeInfoWindow.open(routeMap, marker);
        });

        routeMarkers.push(marker);
      });

      // Draw route polyline (real streets via Directions API)
      if (coordinates.length > 1) {
        const directions = await getDirectionsRoute(coordinates);
        if (directions && directions.path.length > 0) {
          routePolyline = new google.maps.Polyline({
            path: directions.path,
            geodesic: false,
            strokeColor: '#3b82f6',
            strokeOpacity: 0.8,
            strokeWeight: 4
          });
          route._directionsMetrics = {
            distanceKm: directions.totalDistanceKm,
            durationMin: directions.totalDurationMin
          };
        } else {
          // Fallback: straight dashed lines
          routePolyline = new google.maps.Polyline({
            path: coordinates,
            geodesic: true,
            strokeColor: '#3b82f6',
            strokeOpacity: 0,
            strokeWeight: 0,
            icons: [{
              icon: { path: 'M 0,-1 0,1', strokeOpacity: 0.7, strokeWeight: 3, scale: 3 },
              offset: '0',
              repeat: '15px'
            }]
          });
          route._directionsMetrics = null;
        }
        routePolyline.setMap(routeMap);
      }

      // Fit map to route bounds
      if (coordinates.length > 0) {
        routeMap.fitBounds(bounds);
      }

      // Update legend
      updateRouteLegend(route);
      document.getElementById('route-legend').style.display = 'block';

      // Refresh icons
      lucide.createIcons();
    }

    function getOutcomeLabel(outcome) {
      const labels = {
        'sale': 'Venta',
        'no_stock': 'Sin Stock',
        'not_interested': 'No Interesado',
        'pending': 'Pendiente',
        'visited': 'Visitado',
        'contacted': 'Contactado',
        'no_contact': 'Sin Contacto'
      };
      return labels[outcome] || outcome || 'Pendiente';
    }

    // =============================================
    // ROUTE METRICS & ACTIVE ROUTE FUNCTIONS
    // =============================================

    let currentActiveRoute = null;
    let FUEL_PRICE_PER_LITER = 1141; // CLP - Bencina 93 octanos Chile
    const AVERAGE_SPEED_KMH = 30; // Average city driving speed

    // Calculate distance between two points using Haversine formula
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Calculate total route distance from clients
    function calculateRouteMetrics(clients, vehicle, directionsMetrics = null) {
      if (!clients || clients.length === 0) {
        return { distance: 0, duration: 0, fuelCost: 0, source: 'none' };
      }

      const fuelEfficiency = vehicle?.fuel_efficiency_kml || 12; // km per liter

      // If we have real Directions API metrics, use them
      if (directionsMetrics) {
        const totalDistance = directionsMetrics.distanceKm;
        const travelTime = directionsMetrics.durationMin / 60; // hours
        const validClients = clients.filter(c => c.lat != null && c.lng != null && c.lat !== '' && c.lng !== '');
        const visitTime = validClients.length * 1; // 1 hour per client visit
        const totalDuration = travelTime + visitTime;
        const fuelUsed = totalDistance / fuelEfficiency;
        const fuelCost = Math.round(fuelUsed * FUEL_PRICE_PER_LITER);

        return {
          distance: totalDistance,
          duration: totalDuration,
          fuelCost: fuelCost,
          source: 'directions'
        };
      }

      // Fallback: Haversine estimation
      // Filter clients with valid coordinates within Chile bounds
      const validClients = clients.filter(c => {
        const lat = parseFloat(c.lat);
        const lng = parseFloat(c.lng);
        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) return false;
        // Validate Chile bounds: Lat -56 to -17, Lng -76 to -66
        if (lat < -56 || lat > -17 || lng < -76 || lng > -66) {
          console.warn(`Client ${c.name || c.id} excluded: coords out of Chile bounds (${lat}, ${lng})`);
          return false;
        }
        return true;
      });
      console.log('Valid clients with coords:', validClients.length, 'of', clients.length);
      if (validClients.length === 0) {
        return { distance: 0, duration: 0, fuelCost: 0, source: 'haversine' };
      }

      let totalDistance = 0;

      // Calculate distance between consecutive clients, cap 300km per segment
      for (let i = 0; i < validClients.length - 1; i++) {
        const dist = calculateDistance(
          parseFloat(validClients[i].lat),
          parseFloat(validClients[i].lng),
          parseFloat(validClients[i+1].lat),
          parseFloat(validClients[i+1].lng)
        );
        if (dist > 300) {
          console.warn(`Segment ${i}→${i+1} skipped: ${dist.toFixed(1)}km exceeds 300km cap`);
          continue;
        }
        totalDistance += dist;
      }

      // Add 20% for real road distance (roads aren't straight lines)
      totalDistance = totalDistance * 1.2;

      // Calculate duration (distance / speed) + 15 min per client for visit
      const travelTime = totalDistance / AVERAGE_SPEED_KMH; // hours
      const visitTime = validClients.length * 0.25; // 15 min per client
      const totalDuration = travelTime + visitTime;

      // Calculate fuel cost
      const fuelUsed = totalDistance / fuelEfficiency;
      const fuelCost = Math.round(fuelUsed * FUEL_PRICE_PER_LITER);

      return {
        distance: Math.round(totalDistance * 10) / 10,
        duration: totalDuration,
        fuelCost: fuelCost,
        source: 'haversine'
      };
    }

    // Format duration to hours and minutes
    function formatDuration(hours) {
      const h = Math.floor(hours);
      const m = Math.round((hours - h) * 60);
      if (h === 0) return `${m} min`;
      return `${h}h ${m}m`;
    }

    // Check and display active route for selected executive
    let currentStaleRoute = null; // Track stale route from other days

    async function checkActiveRoute(userId) {
      const infoPanel = document.getElementById('active-route-info');
      const staleWarning = document.getElementById('stale-route-warning');
      const form = document.getElementById('form-start-day');

      if (!userId) {
        infoPanel.style.display = 'none';
        staleWarning.style.display = 'none';
        form.style.display = 'block';
        currentStaleRoute = null;
        return;
      }

      // SYNC: Actualizar selectedExecutiveId y cargar clientes
      selectedExecutiveId = userId;
      loadExecutiveClients();
      loadExecutiveRouteOnMap();

      // También sincronizar el buscador del header
      const exec = executives.find(e => e.id === userId);
      if (exec) {
        document.getElementById('executive-search').value = exec.full_name;
      }

      try {
        const res = await fetch(`${API}/api/users/${userId}/routes`);
        const data = await res.json();

        const today = new Date().toISOString().split('T')[0];

        // Separate today's active route from stale (other days)
        let activeRoute = null;
        let staleRoute = null;
        if (data.success && data.data.length > 0) {
          const allActive = data.data.filter(r => r.status === 'active');
          activeRoute = allActive.find(r => r.date === today);
          staleRoute = allActive.find(r => r.date !== today);
        }

        // Handle stale route banner
        currentStaleRoute = staleRoute || null;
        if (staleRoute) {
          const staleDate = staleRoute.date || staleRoute.created_at?.split('T')[0] || '?';
          const staleExec = exec ? exec.full_name : 'Vendedor';
          const formattedDate = new Date(staleDate + 'T12:00:00').toLocaleDateString('es-CL', { weekday: 'short', day: 'numeric', month: 'short' });
          document.getElementById('stale-route-text').textContent = `Ruta sin finalizar del ${formattedDate} — ${staleExec}`;
          staleWarning.style.display = 'block';
        } else {
          staleWarning.style.display = 'none';
        }

        if (activeRoute) {
          // Active route for TODAY — show panel, block form
          currentActiveRoute = activeRoute;
          displayActiveRouteInfo(activeRoute);
          infoPanel.style.display = 'block';
          form.querySelector('button[type="submit"]').innerHTML = '<i data-lucide="play" style="width: 16px; height: 16px;"></i> Ya hay ruta activa';
          form.querySelector('button[type="submit"]').disabled = true;
          lucide.createIcons();
          return;
        }

        // No active route today — enable form
        currentActiveRoute = null;
        infoPanel.style.display = 'none';
        form.querySelector('button[type="submit"]').innerHTML = '<i data-lucide="play" style="width: 16px; height: 16px;"></i> Iniciar Día';
        form.querySelector('button[type="submit"]').disabled = false;

        // Suggest last end_km as starting point
        const hint = document.getElementById('start-km-hint');
        if (data.success && data.data.length > 0) {
          const completedRoutes = data.data.filter(r => r.status === 'completed' && r.end_km);
          if (completedRoutes.length > 0) {
            // Sort by date desc to get most recent
            completedRoutes.sort((a, b) => new Date(b.date || b.created_at) - new Date(a.date || a.created_at));
            const lastEndKm = completedRoutes[0].end_km;
            const kmInput = document.getElementById('start-km');
            if (!kmInput.value) {
              kmInput.value = lastEndKm;
            }
            hint.textContent = `Última ruta finalizada: ${lastEndKm.toLocaleString()} km`;
            hint.style.display = 'block';
          } else {
            hint.style.display = 'none';
          }
        } else {
          hint.style.display = 'none';
        }

        lucide.createIcons();

      } catch (error) {
        console.error('Error checking active route:', error);
      }
    }

    // End a stale route (from a previous day)
    function endStaleRoute() {
      if (!currentStaleRoute) return;
      const routeId = currentStaleRoute.id;
      const startKm = currentStaleRoute.start_km || 0;
      document.getElementById('end-route-id').value = routeId;
      document.getElementById('end-route-start-km').textContent = startKm.toLocaleString() + ' km';
      document.getElementById('end-route-km-input').value = '';
      document.getElementById('end-route-km-diff').textContent = 'Ingresa el KM final para ver el recorrido';
      document.getElementById('end-route-km-input').min = startKm;
      const modal = document.getElementById('end-route-modal');
      modal.style.display = 'flex';
      lucide.createIcons();

      // Live diff calculation
      document.getElementById('end-route-km-input').oninput = function() {
        const val = parseInt(this.value);
        if (!isNaN(val) && val >= startKm) {
          const diff = val - startKm;
          document.getElementById('end-route-km-diff').innerHTML = `<span style="font-size:20px;font-weight:700;color:var(--primary);">${diff.toLocaleString()} km</span><br><span style="font-size:11px;">recorridos</span>`;
        } else if (!isNaN(val) && val < startKm) {
          document.getElementById('end-route-km-diff').innerHTML = '<span style="color:var(--danger);">KM final debe ser mayor al inicial</span>';
        } else {
          document.getElementById('end-route-km-diff').textContent = 'Ingresa el KM final para ver el recorrido';
        }
      };
    }

    // Display active route information
    function displayActiveRouteInfo(route) {
      const details = document.getElementById('active-route-details');
      const visits = route.visits || [];

      // Use assigned clients if no visits yet, otherwise use visit clients
      let clients = visits.map(v => v.client).filter(c => c);
      if (clients.length === 0 && route.user_id) {
        // Get assigned clients for this executive
        clients = allClients.filter(c => c.assigned_user_id === route.user_id);
      }

      // Check how many have coordinates (handle string or number)
      const clientsWithCoords = clients.filter(c => c.lat != null && c.lng != null && c.lat !== '' && c.lng !== '');

      // Calculate metrics (use Directions data if available, or haversine)
      let metrics = calculateRouteMetrics(clients, route.vehicle, route._directionsMetrics);
      let metricsSource = metrics.source;

      // Show route date badge
      const dateBadge = document.getElementById('active-route-date-badge');
      if (dateBadge) {
        const routeDate = route.date || route.created_at?.split('T')[0];
        if (routeDate) {
          dateBadge.textContent = new Date(routeDate + 'T12:00:00').toLocaleDateString('es-CL', { weekday: 'short', day: 'numeric', month: 'short' });
          dateBadge.style.display = 'inline';
        } else {
          dateBadge.style.display = 'none';
        }
      }

      // Odometer KM
      const odometerEl = document.getElementById('route-odometer-km');
      const comparisonEl = document.getElementById('route-km-comparison');
      const metricsGrid = document.getElementById('active-route-metrics-grid');
      const noGpsWarning = document.getElementById('active-route-no-gps-warning');

      if (route.status === 'completed' && route.end_km) {
        const realKm = route.end_km - (route.start_km || 0);
        odometerEl.textContent = realKm.toLocaleString() + ' km';
        odometerEl.parentElement.querySelector('div:last-child').textContent = 'KM Reales';
        // Compare real vs calculated
        if (metrics.distance > 0) {
          const diff = realKm - metrics.distance;
          const pct = Math.round((diff / metrics.distance) * 100);
          const sign = diff >= 0 ? '+' : '';
          const color = Math.abs(pct) <= 15 ? '#10b981' : '#f59e0b';
          comparisonEl.innerHTML = `Real vs Calculado: <strong style="color: ${color};">${sign}${diff.toLocaleString()} km (${sign}${pct}%)</strong>`;
          comparisonEl.style.display = 'block';
        }
      } else {
        odometerEl.textContent = route.start_km ? route.start_km.toLocaleString() : '-';
        odometerEl.parentElement.querySelector('div:last-child').textContent = 'KM Inicio';
        comparisonEl.style.display = 'none';
      }

      // Handle GPS availability for metrics display
      const noGpsClients = clients.length - clientsWithCoords.length;
      if (clients.length > 0 && clientsWithCoords.length < 2 && metrics.distance === 0) {
        // Not enough GPS data to calculate route distance — hide misleading metrics
        metricsGrid.style.display = 'none';
        noGpsWarning.innerHTML = `&#9888;&#65039; ${noGpsClients} de ${clients.length} clientes sin GPS — las métricas de distancia y costo no se pueden calcular`;
        noGpsWarning.style.display = 'block';
      } else {
        metricsGrid.style.display = 'grid';
        noGpsWarning.style.display = 'none';
        document.getElementById('route-distance').textContent = metrics.distance + ' km';
        document.getElementById('route-duration').textContent = formatDuration(metrics.duration);
        document.getElementById('route-fuel-cost').textContent = '$' + metrics.fuelCost.toLocaleString();

        // Update metric source labels
        const distLabel = document.querySelector('#route-distance + div') || document.querySelector('[id="route-distance"]')?.parentElement?.querySelector('div:last-child');
        if (distLabel && distLabel.textContent.includes('Km')) {
          distLabel.textContent = metricsSource === 'directions' ? 'Km (Ruta Real)' : 'Km Calculados';
        }
      }

      // Update display
      const routeDateStr = route.date || route.created_at?.split('T')[0] || '';
      const kmRecorridos = (route.status === 'completed' && route.end_km) ? (route.end_km - (route.start_km || 0)) : null;
      details.innerHTML = `
        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
          <div><strong>Fecha:</strong> ${routeDateStr ? new Date(routeDateStr + 'T12:00:00').toLocaleDateString('es-CL', {day: 'numeric', month: 'short', year: 'numeric'}) : 'N/A'}</div>
          <div><strong>Vehículo:</strong> ${route.vehicle?.license_plate || 'N/A'} (${route.vehicle?.model || ''})</div>
          <div><strong>Inicio:</strong> ${new Date(route.created_at).toLocaleTimeString('es-CL', {hour: '2-digit', minute: '2-digit'})}</div>
          <div><strong>Km inicial:</strong> ${route.start_km?.toLocaleString() || 0}</div>
          ${kmRecorridos !== null ? `<div><strong>Km recorridos:</strong> <span style="color:var(--success);font-weight:700;">${kmRecorridos.toLocaleString()} km</span></div>` : ''}
          <div><strong>Clientes:</strong> ${clients.length} ${clientsWithCoords.length < clients.length ? `<span style="color:#f59e0b;">(${clientsWithCoords.length} con GPS)</span>` : ''}</div>
        </div>
      `;

      lucide.createIcons();
    }

    // View active route on map
    async function viewActiveRouteOnMap() {
      if (currentActiveRoute) {
        // If no visits, create a mock route with assigned clients
        let routeToDisplay = currentActiveRoute;
        if (!currentActiveRoute.visits || currentActiveRoute.visits.length === 0) {
          const assignedClients = allClients.filter(c => c.assigned_user_id === currentActiveRoute.user_id);

          // Check if clients have coordinates
          const clientsWithCoords = assignedClients.filter(c => c.lat && c.lng);
          if (clientsWithCoords.length === 0) {
            showToast('warning', 'Sin coordenadas', 'Los clientes asignados no tienen ubicación GPS');
          }

          routeToDisplay = {
            ...currentActiveRoute,
            visits: assignedClients.map(client => ({ client, outcome: 'pending' }))
          };
        }

        await displayRouteOnMap(routeToDisplay);

        // Trigger map resize in case it wasn't visible
        if (routeMap) {
          setTimeout(() => {
            google.maps.event.trigger(routeMap, 'resize');
            // Re-fit bounds after resize
            if (routeMarkers.length > 0) {
              const bounds = new google.maps.LatLngBounds();
              routeMarkers.forEach(m => bounds.extend(m.getPosition()));
              routeMap.fitBounds(bounds);
            }
          }, 100);
        }

        // Scroll to map if needed
        document.getElementById('map-route').scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // =============================================
    // EXECUTIVE MANAGEMENT FUNCTIONS
    // =============================================

    let selectedExecutiveId = null;
    let executiveClients = [];
    let excludedClientIds = new Set(); // Clients excluded from route optimization

    // Executive search dropdown functions
    function showExecutiveDropdown() {
      const dropdown = document.getElementById('executive-dropdown');
      dropdown.style.display = 'block';
      // Always show all vendors on focus so user can switch quickly
      filterExecutiveDropdown('');

      // Close on click outside
      setTimeout(() => {
        document.addEventListener('click', closeExecutiveDropdownOnClickOutside);
      }, 100);
    }

    function closeExecutiveDropdownOnClickOutside(e) {
      const dropdown = document.getElementById('executive-dropdown');
      const searchInput = document.getElementById('executive-search');
      if (!dropdown.contains(e.target) && e.target !== searchInput) {
        dropdown.style.display = 'none';
        document.removeEventListener('click', closeExecutiveDropdownOnClickOutside);
      }
    }

    function filterExecutiveDropdown(searchTerm) {
      const dropdown = document.getElementById('executive-dropdown-list');
      const search = searchTerm.toLowerCase().trim();
      const schedData = window._dashboardScheduleData || {};

      let filtered = executives;
      if (search) {
        filtered = executives.filter(e =>
          e.full_name.toLowerCase().includes(search) ||
          e.email.toLowerCase().includes(search)
        );
      }

      // Separate: without routes first, then with routes
      const withoutRoutes = filtered.filter(e => !schedData[e.id]);
      const withRoutes = filtered.filter(e => !!schedData[e.id]);

      let html = '';

      if (withoutRoutes.length > 0) {
        html += `<div style="padding:4px 14px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#ef4444;font-weight:700;background:rgba(239,68,68,0.05);border-bottom:1px solid rgba(239,68,68,0.1);">Sin ruta programada</div>`;
        withoutRoutes.forEach(e => { html += _buildExecDropdownItem(e, schedData); });
      }
      if (withRoutes.length > 0) {
        html += `<div style="padding:4px 14px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#10b981;font-weight:700;background:rgba(16,185,129,0.05);border-bottom:1px solid rgba(16,185,129,0.1);">Con ruta cargada</div>`;
        withRoutes.forEach(e => { html += _buildExecDropdownItem(e, schedData); });
      }

      if (filtered.length === 0) {
        html = `<div style="padding: 14px; text-align: center; color: var(--text-muted);">No se encontraron vendedores</div>`;
      }

      dropdown.innerHTML = html;
    }

    function _buildExecDropdownItem(e, schedData) {
      const isSelected = e.id === selectedExecutiveId;
      const gsData = findVendedorData(e.full_name);
      let zona = gsData ? gsData.zona : '';
      if (!zona) {
        const clientZones = allClients.filter(c => c.assigned_user_id === e.id && c.zone).map(c => c.zone);
        if (clientZones.length > 0) {
          const zoneCounts = {};
          clientZones.forEach(z => { zoneCounts[z] = (zoneCounts[z] || 0) + 1; });
          zona = Object.entries(zoneCounts).sort((a, b) => b[1] - a[1])[0][0];
        }
      }
      const zc = ZONE_COLORS[(zona || '').toLowerCase()] || null;
      const zoneTag = zona ? `<span style="background:${zc ? zc.bg : 'rgba(107,114,128,0.08)'};color:${zc ? zc.color : '#6b7280'};border:1px solid ${zc ? zc.border : 'rgba(107,114,128,0.2)'};padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${zona}</span>` : '';
      const clientCount = allClients.filter(c => c.assigned_user_id === e.id).length;
      const hasRoute = !!schedData[e.id];
      const schedInfo = hasRoute ? schedData[e.id] : null;
      const schedDays = schedInfo ? Object.keys(schedInfo.dates).length : 0;
      const schedClients = schedInfo ? Object.values(schedInfo.dates).flat().length : 0;
      const routeTag = hasRoute
        ? `<span style="background:rgba(16,185,129,0.1);color:#10b981;border:1px solid rgba(16,185,129,0.2);padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${schedDays}d · ${schedClients}cl</span>`
        : '';
      return `<div class="executive-option" onclick="selectExecutive('${e.id}')"
        style="padding: 8px 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; ${isSelected ? 'background: var(--primary-light); font-weight: 500;' : ''} ${hasRoute ? 'opacity:0.6;' : ''}"
        onmouseover="this.style.background='#f5f5f5'"
        onmouseout="this.style.background='${isSelected ? 'var(--primary-light)' : 'white'}'">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;"><span style="font-weight: 500; font-size: 13px;">${e.full_name}</span>${zoneTag}${routeTag}<span style="font-size:10px;color:var(--text-muted);">(${clientCount} clientes)</span></div>
      </div>`;
    }

    function selectExecutive(execId) {
      selectedExecutiveId = execId;
      const searchInput = document.getElementById('executive-search');
      const dropdown = document.getElementById('executive-dropdown');

      if (execId) {
        const exec = executives.find(e => e.id === execId);
        searchInput.value = exec ? exec.full_name : '';
      } else {
        searchInput.value = '';
        searchInput.placeholder = 'Buscar vendedor por nombre...';
      }

      dropdown.style.display = 'none';
      document.removeEventListener('click', closeExecutiveDropdownOnClickOutside);

      // Clear excluded clients when switching vendor
      excludedClientIds.clear();

      // Update vendor info card and show/hide sections
      updateSelectedVendorCard(execId);

      // Show vendor start point + clients on map
      showVendorPreviewOnMap(execId);

      // Trigger the filter
      filterByExecutive(execId);
    }

    function clearExecutiveFilter() {
      selectedExecutiveId = null;
      document.getElementById('executive-search').value = '';
      updateSelectedVendorCard('');
      clearPreviewMarkers();
      filterByExecutive('');
    }

    function updateSelectedVendorCard(execId) {
      const vendorCard = document.getElementById('selected-vendor-card');
      const jornadaWrapper = document.getElementById('iniciar-jornada-wrapper');

      if (!execId) {
        if (vendorCard) vendorCard.style.display = 'none';
        if (jornadaWrapper) jornadaWrapper.style.display = 'none';
        return;
      }

      const exec = executives.find(e => e.id === execId);
      if (!exec) return;

      // Get vendor data
      const assignedClients = allClients.filter(c => c.assigned_user_id === execId);
      const clientsWithGps = assignedClients.filter(c => c.lat && c.lng);
      const gpsPercent = assignedClients.length > 0 ? Math.round((clientsWithGps.length / assignedClients.length) * 100) : 0;

      // Check route status
      const execRoute = todayRoutesData.find(r => r.user_id === execId);
      const hasActiveRoute = execRoute && execRoute.status === 'active';
      const hasCompletedRoute = execRoute && execRoute.status === 'completed';
      const visitsCount = execRoute ? (execRoute.visits?.length || execRoute.visits_count || 0) : 0;

      // Fetch scheduled routes count from API (async, updates after render)
      const scheduledCount = 0;
      fetchScheduledCountForVendor(execId);

      // Get zone info
      const gsData = findVendedorData(exec.full_name);
      const zona = gsData ? gsData.zona : '';

      // Update card elements
      document.getElementById('vendor-card-name').textContent = exec.full_name;
      document.getElementById('vendor-card-zone').textContent = zona ? `Zona: ${zona}` : (exec.email || '');
      document.getElementById('vendor-card-clients').textContent = assignedClients.length;
      document.getElementById('vendor-card-visits').textContent = visitsCount;
      document.getElementById('vendor-card-scheduled').textContent = scheduledCount;
      document.getElementById('vendor-card-gps').textContent = gpsPercent + '%';

      // Status badge
      const badge = document.getElementById('vendor-card-status-badge');
      if (hasActiveRoute) {
        badge.textContent = 'Ruta Activa';
        badge.style.cssText = 'padding:5px 14px;border-radius:12px;font-size:12px;font-weight:600;background:rgba(16,185,129,0.1);color:#10b981;';
      } else if (hasCompletedRoute) {
        badge.textContent = 'Completada';
        badge.style.cssText = 'padding:5px 14px;border-radius:12px;font-size:12px;font-weight:600;background:rgba(59,130,246,0.1);color:#3b82f6;';
      } else {
        badge.textContent = 'Sin Ruta';
        badge.style.cssText = 'padding:5px 14px;border-radius:12px;font-size:12px;font-weight:600;background:rgba(245,158,11,0.1);color:#f59e0b;';
      }

      // GPS warning bar
      const gpsWarning = document.getElementById('vendor-card-gps-warning');
      const noGpsCount = assignedClients.length - clientsWithGps.length;
      if (gpsWarning) {
        if (gpsPercent < 80 && noGpsCount > 0) {
          gpsWarning.style.display = 'flex';
          document.getElementById('vendor-card-no-gps-count').textContent = noGpsCount;
        } else {
          gpsWarning.style.display = 'none';
        }
      }

      // Show vendor card
      vendorCard.style.display = 'block';

      // Show iniciar jornada only if no active route
      if (jornadaWrapper) {
        jornadaWrapper.style.display = hasActiveRoute ? 'none' : 'block';
      }

      lucide.createIcons();
    }

    // Preview: show vendor start point + all clients on map when selected
    let previewMarkers = [];

    function showVendorPreviewOnMap(execId) {
      // Clear previous preview markers
      previewMarkers.forEach(m => m.setMap(null));
      previewMarkers = [];

      // Also clear any existing route polyline
      if (window.routePolyline) {
        window.routePolyline.setMap(null);
        window.routePolyline = null;
      }
      // Clear route markers too
      if (typeof routeMarkers !== 'undefined') {
        routeMarkers.forEach(m => m.setMap(null));
        routeMarkers = [];
      }

      if (!execId || !routeMap) return;

      const vendor = allUsers.find(u => u.id === execId);
      if (!vendor) return;

      const assignedClients = allClients.filter(c => c.assigned_user_id === execId);
      const clientsWithGps = assignedClients.filter(c => c.lat && c.lng);

      if (clientsWithGps.length === 0 && !vendor.home_lat) return;

      const bounds = new google.maps.LatLngBounds();

      // Home/start marker (purple house)
      if (vendor.home_lat && vendor.home_lng) {
        const homePos = { lat: parseFloat(vendor.home_lat), lng: parseFloat(vendor.home_lng) };
        bounds.extend(homePos);

        const homeSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="48" viewBox="0 0 40 48">
          <path d="M20 0C10 0 0 9 0 20c0 15 20 28 20 28s20-13 20-28C40 9 30 0 20 0z" fill="#7c3aed" stroke="white" stroke-width="2.5"/>
          <path d="M20 10l-9 8v9h6v-5h6v5h6v-9z" fill="white"/>
        </svg>`;
        const homeMarker = new google.maps.Marker({
          position: homePos,
          map: routeMap,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(homeSvg),
            scaledSize: new google.maps.Size(40, 48),
            anchor: new google.maps.Point(20, 48)
          },
          title: `Punto de inicio: ${vendor.home_address || vendor.full_name}`,
          zIndex: 999
        });
        homeMarker.addListener('click', () => {
          routeInfoWindow.setContent(`
            <div style="min-width:200px;padding:6px;">
              <div style="font-weight:700;font-size:14px;color:#7c3aed;margin-bottom:6px;">
                <span style="margin-right:6px;">🏠</span> Punto de Inicio
              </div>
              <div style="font-size:13px;color:#374151;font-weight:600;">${vendor.full_name}</div>
              <div style="font-size:12px;color:#6b7280;margin-top:4px;">${vendor.home_address || 'Sin dirección registrada'}</div>
            </div>
          `);
          routeInfoWindow.open(routeMap, homeMarker);
        });
        previewMarkers.push(homeMarker);
      }

      // Client markers (blue dots)
      const positionCounts = {};
      clientsWithGps.forEach((client) => {
        let lat = parseFloat(client.lat);
        let lng = parseFloat(client.lng);

        // Offset overlapping positions
        const posKey = `${lat.toFixed(3)},${lng.toFixed(3)}`;
        positionCounts[posKey] = (positionCounts[posKey] || 0);
        const count = positionCounts[posKey];
        if (count > 0) {
          const angle = (count * (360 / 8)) * (Math.PI / 180);
          const offset = 0.002;
          lat += Math.cos(angle) * offset;
          lng += Math.sin(angle) * offset;
        }
        positionCounts[posKey]++;

        const pos = { lat, lng };
        bounds.extend(pos);

        // Determine color by segment
        const seg = (client.segment || '').toUpperCase();
        const _segCols = { A: '#d97706', B: '#3b82f6', C: '#059669', D: '#8b5cf6', E: '#9ca3af', FOCO: '#ef4444' };
        let color = _segCols[seg] || '#9ca3af';
        const extIdPrev = client.external_id || '';

        const marker = new google.maps.Marker({
          position: pos,
          map: routeMap,
          label: extIdPrev ? {
            text: extIdPrev.length > 6 ? extIdPrev.slice(-5) : extIdPrev,
            color: 'white',
            fontSize: '8px',
            fontWeight: 'bold'
          } : undefined,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: color,
            fillOpacity: 0.9,
            strokeColor: '#fff',
            strokeWeight: 1.5,
            scale: extIdPrev ? 14 : 8
          },
          title: `${extIdPrev} — ${client.fantasy_name || client.name}`,
          zIndex: 10
        });
        marker.addListener('click', () => {
          const sheetsBtnP = window._sheetsUrl
            ? `<a href="${window._sheetsUrl}" target="_blank" rel="noopener"
                 style="display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:5px 10px;background:#16a34a;color:white;border-radius:6px;font-size:11px;font-weight:600;text-decoration:none;">
                 <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                 Editar en Sheets (${extIdPrev})
               </a>`
            : '';
          routeInfoWindow.setContent(`
            <div style="min-width:210px;padding:6px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <div style="font-weight:700;font-size:13px;color:#1f2937;">${client.fantasy_name || client.name}</div>
                <code style="font-size:10px;background:#6366f1;color:white;padding:2px 6px;border-radius:4px;">${extIdPrev}</code>
              </div>
              <div style="font-size:11px;color:#6b7280;">${client.address || 'Sin dirección'}</div>
              ${client.commune ? `<div style="font-size:10px;color:#9ca3af;margin-top:2px;">${client.commune}</div>` : ''}
              ${seg ? `<span style="display:inline-block;margin-top:4px;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;background:${color}20;color:${color};">Seg ${seg}</span>` : ''}
              ${sheetsBtnP}
            </div>
          `);
          routeInfoWindow.open(routeMap, marker);
        });
        previewMarkers.push(marker);
      });

      // Fit map to show all markers
      if (previewMarkers.length > 0) {
        if (previewMarkers.length === 1) {
          routeMap.setCenter(previewMarkers[0].getPosition());
          routeMap.setZoom(13);
        } else {
          routeMap.fitBounds(bounds, { top: 40, right: 40, bottom: 40, left: 40 });
        }
      }

      // Show legend overlay on map
      showPreviewLegend(clientsWithGps.length, assignedClients.length - clientsWithGps.length);
    }

    function showPreviewLegend(withGps, withoutGps) {
      // Remove existing legend
      const existing = document.getElementById('preview-map-legend');
      if (existing) existing.remove();

      const legend = document.createElement('div');
      legend.id = 'preview-map-legend';
      legend.style.cssText = 'position:absolute;bottom:24px;left:12px;background:rgba(255,255,255,0.95);backdrop-filter:blur(8px);border-radius:10px;padding:10px 14px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:12px;z-index:10;';
      legend.innerHTML = `
        <div style="font-weight:700;font-size:11px;color:#6b7280;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Clientes del vendedor</div>
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
          <span style="width:10px;height:10px;border-radius:50%;background:#3b82f6;display:inline-block;"></span>
          <span style="color:#374151;">${withGps} con ubicación</span>
        </div>
        ${withoutGps > 0 ? `<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
          <span style="width:10px;height:10px;border-radius:50%;background:#d1d5db;display:inline-block;border:1px dashed #9ca3af;"></span>
          <span style="color:#9ca3af;">${withoutGps} sin GPS</span>
        </div>` : ''}
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="width:10px;height:10px;border-radius:50%;background:#7c3aed;display:inline-block;"></span>
          <span style="color:#374151;">Punto de inicio</span>
        </div>
      `;

      const mapContainer = document.getElementById('map-route')?.parentElement;
      if (mapContainer) {
        mapContainer.style.position = 'relative';
        mapContainer.appendChild(legend);
      }
    }

    function clearPreviewMarkers() {
      previewMarkers.forEach(m => m.setMap(null));
      previewMarkers = [];
      const legend = document.getElementById('preview-map-legend');
      if (legend) legend.remove();
    }

    async function fetchScheduledCountForVendor(execId) {
      try {
        // Get date range: today to 3 months ahead
        const today = new Date();
        const future = new Date();
        future.setMonth(future.getMonth() + 3);
        const startDate = today.toISOString().split('T')[0];
        const endDate = future.toISOString().split('T')[0];
        const res = await fetch(`${API}/api/routes/schedule/${execId}?startDate=${startDate}&endDate=${endDate}`);
        const data = await res.json();
        if (data.success) {
          let count = 0;
          Object.values(data.data).forEach(dayRoutes => { count += dayRoutes.length; });
          const el = document.getElementById('vendor-card-scheduled');
          if (el) el.textContent = count;
        }
      } catch (e) {
        console.error('Error fetching scheduled count:', e);
      }
    }

    // =============================================
    // RUTA OPTIMIZADA
    // =============================================

    let optimizedRouteData = null;
    let selectedZone = null;
    let selectedOptDay = null;

    async function generateOptimizedRoute() {
      if (!selectedExecutiveId) {
        showToast('warning', 'Atención', 'Selecciona un vendedor primero');
        return;
      }

      // Primero obtener las zonas disponibles para este vendedor
      try {
        const zonesRes = await fetch(`${API}/routes/zones/${selectedExecutiveId}`);
        const zonesData = await zonesRes.json();

        if (!zonesData.success || !zonesData.data.length) {
          showToast('warning', 'Sin zonas', 'Este vendedor no tiene clientes con zona asignada');
          return;
        }

        // Mostrar selector de zona
        showZoneSelector(zonesData.data);

      } catch (error) {
        console.error('Error fetching zones:', error);
        showToast('error', 'Error', 'No se pudieron obtener las zonas');
      }
    }

    function showZoneSelector(zones) {
      const exec = executives.find(e => e.id === selectedExecutiveId);
      const vendorName = exec ? exec.full_name : 'Vendedor';

      // Filtrar zonas con al menos 2 clientes con GPS (zonas con 1 solo cliente no generan ruta útil)
      const validZones = zones.filter(z => (z.withGps || 0) >= 2);
      const singleClientZones = zones.filter(z => (z.withGps || 0) === 1);

      // Calcular totales (sobre zonas válidas)
      const totalClients = zones.reduce((sum, z) => sum + z.clientCount, 0);
      const totalWithGps = validZones.reduce((sum, z) => sum + (z.withGps || 0), 0);

      // Crear modal de selección de zona
      const modal = document.createElement('div');
      modal.id = 'zone-selector-modal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 9999;
        display: flex; align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 24px; max-width: 450px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
          <h3 style="margin: 0 0 8px 0; color: #1e40af; display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
            Seleccionar Zona
          </h3>
          <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px;">
            Vendedor: <strong>${vendorName}</strong><br>
            <span style="font-size: 12px;">${totalClients} clientes total, ${totalWithGps} con ubicación GPS</span>
          </p>

          ${totalWithGps > 0 ? `
          <button onclick="selectZoneAndGenerateRoute('')" style="
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 14px 16px; margin-bottom: 12px;
            border: 2px solid #10b981; border-radius: 10px;
            background: #ecfdf5; cursor: pointer; font-size: 14px;
          ">
            <span style="font-weight: 600; color: #059669;"><i data-lucide="globe" style="width:14px;height:14px;display:inline-block;vertical-align:middle;"></i> Todas las zonas (ruta completa)</span>
            <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px;">
              ${totalWithGps} con GPS
            </span>
          </button>
          ` : ''}

          <div style="display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto;">
            ${validZones.map(z => `
              <button onclick="selectZoneAndGenerateRoute('${z.zone}')" style="
                display: flex; justify-content: space-between; align-items: center;
                padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px;
                background: white; cursor: pointer; transition: all 0.2s;
                font-size: 14px;
              " onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff';"
                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                <div style="text-align: left;">
                  <div style="font-weight: 600; color: #1f2937;">${z.zone}</div>
                  <div style="font-size: 11px; color: #10b981;">
                    ${z.withGps}/${z.clientCount} con GPS
                  </div>
                </div>
                <span style="background: #3b82f6; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px;">
                  ${z.clientCount} clientes
                </span>
              </button>
            `).join('')}
          </div>

          ${singleClientZones.length > 0 ? `
          <div style="margin-top: 8px; padding: 8px 10px; background: #fef2f2; border-radius: 8px; font-size: 11px; color: #991b1b;">
            <strong>Zonas excluidas</strong> (1 solo cliente con GPS): ${singleClientZones.map(z => z.zone).join(', ')}
          </div>` : ''}

          <div style="margin-top: 8px; padding: 10px; background: #fef3c7; border-radius: 8px; font-size: 11px; color: #92400e;">
            <strong><i data-lucide="lightbulb" style="width:12px;height:12px;color:#92400e;display:inline-block;vertical-align:middle;"></i> Tip:</strong> Los clientes sin GPS necesitan geocodificación. Ve a Dashboard → "Cargar Ubicaciones"
          </div>

          <button onclick="closeZoneSelector()" style="
            width: 100%; margin-top: 12px; padding: 12px; border: none;
            background: #f3f4f6; color: #6b7280; border-radius: 8px;
            cursor: pointer; font-size: 14px;
          ">Cancelar</button>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function closeZoneSelector() {
      const modal = document.getElementById('zone-selector-modal');
      if (modal) modal.remove();
    }

    async function selectZoneAndGenerateRoute(zone) {
      closeZoneSelector();
      selectedZone = zone;

      const exec = executives.find(e => e.id === selectedExecutiveId);
      const vendorName = exec ? exec.full_name : 'Vendedor';

      try {
        showToast('info', 'Calculando', `Generando ruta para ${zone}...`);

        const excludeParam = excludedClientIds.size > 0 ? `&exclude=${[...excludedClientIds].join(',')}` : '';
        const res = await fetch(`${API}/routes/optimize/${selectedExecutiveId}?zone=${encodeURIComponent(zone)}${excludeParam}`);
        const data = await res.json();

        if (!data.success) {
          showToast('error', 'Error', data.error || 'Error al calcular ruta');
          return;
        }

        if (!data.data.route || data.data.route.length === 0) {
          showToast('warning', 'Sin clientes', `No hay clientes con coordenadas en ${zone}`);
          return;
        }

        optimizedRouteData = data.data;
        displayOptimizedRoute(vendorName, zone);
        goToRouteStep(2);

        // Draw first day if multi-day, or all if single
        const firstDay = optimizedRouteData.days ? Object.keys(optimizedRouteData.days).sort()[0] : null;
        await drawOptimizedRouteOnMap(firstDay);

        // Mostrar warning de dispersión geográfica si existe
        if (data.data.geoWarning) {
          showToast('warning', 'Clientes dispersos', data.data.geoWarning);
        } else {
          const totalDays = data.data.totalStats?.totalDays;
          const msg = totalDays > 1
            ? `${data.data.totalStats.totalClients} clientes en ${totalDays} días, ${data.data.totalStats.distanceKm} km total`
            : `${data.data.route.length} clientes, ${data.data.stats.distanceKm} km`;
          showToast('success', 'Ruta Optimizada', msg);
        }

      } catch (error) {
        console.error('Error generating optimized route:', error);
        showToast('error', 'Error', 'No se pudo generar la ruta optimizada');
      }
    }

    function displayOptimizedRoute(vendorName, zone = null) {
      const panel = document.getElementById('optimized-route-panel');
      const isMultiDay = optimizedRouteData.days && Object.keys(optimizedRouteData.days).length > 0;
      const stats = isMultiDay ? optimizedRouteData.totalStats : optimizedRouteData.stats;

      document.getElementById('opt-vendor-name').textContent = zone ? `${vendorName} - ${zone}` : vendorName;

      // Day tabs
      const tabsContainer = document.getElementById('opt-day-tabs');
      if (isMultiDay) {
        const dayKeys = Object.keys(optimizedRouteData.days).sort();
        selectedOptDay = dayKeys[0];

        // Show first day stats in header (updates when switching tabs)
        const firstDayStats = optimizedRouteData.days[dayKeys[0]].stats;
        document.getElementById('opt-total-clients').textContent = firstDayStats.totalClients;
        document.getElementById('opt-distance').textContent = `${firstDayStats.distanceKm} km`;
        document.getElementById('opt-liters').textContent = `${firstDayStats.litersUsed} L`;
        document.getElementById('opt-cost').textContent = `$${firstDayStats.costCLP.toLocaleString('es-CL')}`;
        const firstDayMin = firstDayStats.estimatedTime || 0;
        if (firstDayMin >= 60) {
          const h = Math.floor(firstDayMin / 60);
          const m = firstDayMin % 60;
          document.getElementById('opt-time').textContent = m > 0 ? `${h}h ${m}m` : `${h}h`;
        } else {
          document.getElementById('opt-time').textContent = `${firstDayMin} min`;
        }
        // Add "Total Semana" label
        const weeklyTotals = document.getElementById('opt-weekly-totals');
        if (weeklyTotals) weeklyTotals.setAttribute('title', `Total ${stats.totalDays} días de ruta`);

        // Render day tabs as wrapping grid + weekly total row
        const dayNames = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
        let totalTime = stats.estimatedTime;
        let totalTimeStr = totalTime >= 60 ? `${Math.floor(totalTime/60)}h ${totalTime%60}m` : `${totalTime}m`;

        tabsContainer.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">' + dayKeys.map((date, i) => {
          const d = new Date(date + 'T12:00:00');
          const dayName = dayNames[d.getDay()];
          const dayNum = d.getDate();
          const dayData = optimizedRouteData.days[date];
          const nClients = dayData.stats.totalClients;
          const km = dayData.stats.distanceKm;
          const isActive = date === selectedOptDay;
          const txtColor = isActive ? 'white' : 'var(--text-muted)';
          return `<button onclick="selectOptDay('${date}')" data-date="${date}" style="
            display: flex; flex-direction: column; align-items: flex-start; gap: 4px;
            padding: 10px 14px; border-radius: 10px; border: 2px solid ${isActive ? '#10b981' : 'var(--border)'};
            background: ${isActive ? '#10b981' : 'var(--bg-card)'}; color: ${isActive ? 'white' : 'var(--text)'};
            cursor: pointer; white-space: nowrap; transition: all 0.15s; min-width: 110px;
          ">
            <span style="font-weight:800; font-size:15px; letter-spacing:-0.3px;">${dayName} ${dayNum}</span>
            <span style="display:flex; align-items:center; gap:4px; font-size:13px; font-weight:600; color:${txtColor};">
              <i data-lucide="users" style="width:12px;height:12px;"></i> ${nClients} clientes
            </span>
            <span style="display:flex; align-items:center; gap:4px; font-size:12px; font-weight:500; color:${txtColor};">
              <i data-lucide="map" style="width:11px;height:11px;"></i> ${km} km
            </span>
          </button>`;
        }).join('') + '</div>' +
        `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(16,185,129,0.08); border-radius: 10px; border: 1px solid rgba(16,185,129,0.2); margin-top: 6px;">
          <span style="font-size: 14px; font-weight: 700; color: #059669; display: flex; align-items: center; gap: 6px;"><i data-lucide="bar-chart-3" style="width:16px;height:16px;display:inline-block;vertical-align:middle;"></i> Total Semana (${stats.totalDays} días)</span>
          <span style="font-size: 14px; font-weight: 700; color: var(--text); display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;">
            <span>${stats.totalClients} clientes</span>
            <span>·</span>
            <span>${stats.distanceKm} km</span>
            <span>·</span>
            <span>${totalTimeStr}</span>
            <span>·</span>
            <span style="color: #6366f1;">$${stats.costCLP.toLocaleString('es-CL')}</span>
          </span>
        </div>`;
        tabsContainer.style.display = 'block';
        // Show first day detail
        renderOptDayDetail(selectedOptDay);
      } else {
        tabsContainer.style.display = 'none';
        selectedOptDay = null;
        document.getElementById('opt-total-clients').textContent = stats.totalClients;
        document.getElementById('opt-distance').textContent = `${stats.distanceKm} km`;
        document.getElementById('opt-liters').textContent = `${stats.litersUsed} L`;
        document.getElementById('opt-cost').textContent = `$${stats.costCLP.toLocaleString('es-CL')}`;
        const totalMin = stats.estimatedTime;
        if (totalMin >= 60) {
          const h = Math.floor(totalMin / 60);
          const m = totalMin % 60;
          document.getElementById('opt-time').textContent = m > 0 ? `${h}h ${m}m` : `${h}h`;
        } else {
          document.getElementById('opt-time').textContent = `${totalMin} min`;
        }
      }

      document.getElementById('opt-efficiency').textContent = `${stats.fuelEfficiency || stats.vehicleConfig?.FUEL_EFFICIENCY_KML || 10} km/L`;
      document.getElementById('opt-fuel-type').textContent = stats.vehicleConfig?.FUEL_TYPE || '93 octanos';
      document.getElementById('opt-fuel-price').textContent = `$${(stats.fuelPriceCLP || stats.vehicleConfig?.FUEL_PRICE_CLP || 1141).toLocaleString('es-CL')}/L`;

      panel.style.display = 'block';
      lucide.createIcons();
    }

    function selectOptDay(date) {
      selectedOptDay = date;
      // Update tab styling
      document.querySelectorAll('#opt-day-tabs button[data-date]').forEach(btn => {
        const isActive = btn.dataset.date === date;
        btn.style.background = isActive ? '#10b981' : 'var(--bg-card)';
        btn.style.color = isActive ? 'white' : 'var(--text)';
        btn.style.borderColor = isActive ? '#10b981' : 'var(--border)';
        // Update sub-text colors (clients + km lines)
        const subSpans = btn.querySelectorAll('span > span, button > span:nth-child(n+2)');
        btn.querySelectorAll(':scope > span:not(:first-child)').forEach(s => {
          s.style.color = isActive ? 'white' : 'var(--text-muted)';
        });
      });
      // Update header stats to show selected day's data
      if (optimizedRouteData?.days?.[date]) {
        const dayStats = optimizedRouteData.days[date].stats;
        document.getElementById('opt-total-clients').textContent = dayStats.totalClients;
        document.getElementById('opt-distance').textContent = `${dayStats.distanceKm} km`;
        document.getElementById('opt-liters').textContent = `${dayStats.litersUsed} L`;
        document.getElementById('opt-cost').textContent = `$${dayStats.costCLP.toLocaleString('es-CL')}`;
        const totalMin = dayStats.estimatedTime || 0;
        if (totalMin >= 60) {
          const h = Math.floor(totalMin / 60);
          const m = totalMin % 60;
          document.getElementById('opt-time').textContent = m > 0 ? `${h}h ${m}m` : `${h}h`;
        } else {
          document.getElementById('opt-time').textContent = `${totalMin} min`;
        }
      }
      // Show day detail with clients
      renderOptDayDetail(date);
      // Redraw map for this day
      drawOptimizedRouteOnMap(date);
    }

    function renderOptDayDetail(date) {
      const detailPanel = document.getElementById('opt-day-detail');
      if (!date || !optimizedRouteData?.days?.[date]) {
        if (detailPanel) detailPanel.style.display = 'none';
        return;
      }
      const dayData = optimizedRouteData.days[date];
      const clients = dayData.route || [];
      const stats = dayData.stats;
      const d = new Date(date + 'T12:00:00');
      const dayNames = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
      const dayTitle = `${dayNames[d.getDay()]} ${d.getDate()}`;

      // Format time
      let timeStr = `${stats.estimatedTime} min`;
      if (stats.estimatedTime >= 60) {
        const h = Math.floor(stats.estimatedTime / 60);
        const m = stats.estimatedTime % 60;
        timeStr = m > 0 ? `${h}h ${m}m` : `${h}h`;
      }

      document.getElementById('opt-day-detail-title').textContent = `${dayTitle} — ${clients.length} clientes`;
      document.getElementById('opt-day-detail-stats').innerHTML = `${stats.distanceKm}km · ${timeStr} · <span style="color:#6366f1;">$${stats.costCLP.toLocaleString('es-CL')}</span>`;

      // Get vendor home for start/end display
      const dayVendor = selectedExecutiveId ? allUsers.find(u => u.id === selectedExecutiveId) : null;
      const hasHome = dayVendor && dayVendor.home_lat && dayVendor.home_lng;

      // Render compact client list with home start/end
      let clientsHtml = '';

      // Home start row
      if (hasHome) {
        clientsHtml += `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-bottom: 1px solid var(--border); font-size: 12px; background: rgba(124,58,237,0.06);">
          <span style="width: 20px; height: 20px; border-radius: 4px; background: #7c3aed; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0;"><i data-lucide="home" style="width:12px;height:12px;"></i></span>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: #7c3aed; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Salida: Punto de inicio</div>
            <div style="font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${dayVendor.home_address || 'Punto de inicio'}</div>
          </div>
        </div>`;
      }

      // Build list of other days for "move to" dropdown
      const allDayKeys = optimizedRouteData.days ? Object.keys(optimizedRouteData.days).sort() : [];
      const otherDays = allDayKeys.filter(d => d !== date);
      const dayNamesShort = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];

      clientsHtml += clients.map((c, i) => {
        const hasGps = c.lat && c.lng;
        const is8020 = c.segmentation === '80-20';
        // Move-to options
        const moveOpts = otherDays.map(d => {
          const dd = new Date(d + 'T12:00:00');
          return `<option value="${d}">${dayNamesShort[dd.getDay()]} ${dd.getDate()}</option>`;
        }).join('');
        return `<div style="display: flex; align-items: center; gap: 8px; padding: 8px 14px; border-bottom: 1px solid var(--border); font-size: 13px; ${is8020 ? 'border-left: 3px solid #f5c842; background: rgba(245,200,66,0.04);' : ''}">
          <span style="width: 24px; height: 24px; border-radius: 50%; background: ${i === 0 ? '#10b981' : is8020 ? '#d4a017' : '#3b82f6'}; color: white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0;">${i + 1}</span>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.fantasy_name || c.name} ${is8020 ? '<span style="color:#c9a227;font-size:11px;">★</span>' : ''}</div>
            <div style="font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.commune || ''} ${c.address ? '· ' + c.address : ''}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
            <span><i data-lucide="${hasGps ? 'map-pin' : 'alert-triangle'}" style="width:13px;height:13px;color:${hasGps ? '#10b981' : '#f59e0b'};"></i></span>
            ${hasGps ? `<button onclick="openWazeToClient(${c.lat},${c.lng})" style="background: #33ccff15; border: 1px solid #33ccff40; border-radius: 5px; cursor: pointer; padding: 4px 6px; display:flex; align-items:center;" title="Waze"><i data-lucide="navigation" style="width:13px;height:13px;color:#33ccff;"></i></button>` : ''}
            ${otherDays.length > 0 ? `<select onchange="moveClientToDay('${c.id}','${date}',this.value); this.selectedIndex=0;" style="background:var(--bg-hover);border:1px solid var(--border);border-radius:5px;padding:3px 4px;font-size:10px;cursor:pointer;color:var(--text-muted);width:56px;" title="Mover a otro día">
              <option value="">Mover</option>${moveOpts}
            </select>` : ''}
            <button onclick="removeClientFromRoute('${c.id}','${date}')" style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:5px;cursor:pointer;padding:4px 6px;display:flex;align-items:center;" title="Quitar de la ruta"><i data-lucide="x" style="width:13px;height:13px;color:#ef4444;"></i></button>
          </div>
        </div>`;
      }).join('');

      // Home return row
      if (hasHome) {
        clientsHtml += `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; font-size: 12px; background: rgba(124,58,237,0.06);">
          <span style="width: 20px; height: 20px; border-radius: 4px; background: #7c3aed; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0;"><i data-lucide="home" style="width:12px;height:12px;"></i></span>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: #7c3aed; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Regreso: Punto de inicio</div>
            <div style="font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${dayVendor.home_address || 'Punto de inicio'}</div>
          </div>
        </div>`;
      }

      document.getElementById('opt-day-detail-clients').innerHTML = clientsHtml;
      detailPanel.style.display = 'block';
      lucide.createIcons();
    }

    function openDayRouteInMapsFromOpt() {
      if (!selectedOptDay || !optimizedRouteData?.days?.[selectedOptDay]) return;
      const clients = optimizedRouteData.days[selectedOptDay].route.filter(c => c.lat && c.lng);
      openFullRouteInMaps(clients);
    }

    // Gas Stations on map via Google Places API
    let gasStationMarkers = [];
    let gasStationsVisible = false;

    function toggleGasStations() {
      const btn = document.getElementById('btn-toggle-gas');
      if (gasStationsVisible) {
        // Hide gas stations
        gasStationMarkers.forEach(m => m.setMap(null));
        gasStationMarkers = [];
        gasStationsVisible = false;
        if (btn) {
          btn.style.background = 'none';
          btn.style.color = 'var(--text-muted)';
          btn.style.borderColor = 'var(--border)';
        }
        return;
      }

      if (!routeMap) return;

      // Search gas stations near the current map center/bounds
      const service = new google.maps.places.PlacesService(routeMap);
      const bounds = routeMap.getBounds();
      const center = routeMap.getCenter();

      service.nearbySearch({
        location: center,
        radius: 15000, // 15 km radius
        type: 'gas_station'
      }, (results, status) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results) {
          showToast('warning', 'Bencinerías', 'No se encontraron bencinerías cercanas');
          return;
        }

        gasStationMarkers.forEach(m => m.setMap(null));
        gasStationMarkers = [];

        results.forEach(place => {
          const marker = new google.maps.Marker({
            position: place.geometry.location,
            map: routeMap,
            icon: {
              url: 'data:image/svg+xml,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11" fill="#f97316" stroke="white" stroke-width="2"/><path d="M5.2 10l1.5-4.5A2 2 0 018.6 4h2.8a2 2 0 011.9 1.5L14.8 10M5.2 10h9.6M5.2 10l-.7 2.1a1 1 0 00.9 1.4h.6M14.8 10l.7 2.1a1 1 0 01-.9 1.4h-.6M7 16.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM13 16.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" fill="none" stroke="white" stroke-width="1.5" transform="translate(2,2) scale(0.8)"/></svg>`),
              scaledSize: new google.maps.Size(28, 28),
              anchor: new google.maps.Point(14, 14)
            },
            title: place.name,
            zIndex: 5
          });

          const rating = place.rating ? `<i data-lucide="star" style="width:11px;height:11px;color:#f59e0b;display:inline-block;vertical-align:middle;"></i> ${place.rating}` : '';
          const open = place.opening_hours?.open_now !== undefined
            ? (place.opening_hours.open_now ? '<span style="color:#10b981;">Abierta</span>' : '<span style="color:#ef4444;">Cerrada</span>')
            : '';

          marker.addListener('click', () => {
            routeInfoWindow.setContent(`
              <div style="min-width: 180px; font-family: Inter, sans-serif;">
                <div style="font-weight: 700; font-size: 13px; margin-bottom: 4px;"><i data-lucide="fuel" style="width:13px;height:13px;color:#f97316;display:inline-block;vertical-align:middle;"></i> ${place.name}</div>
                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">${place.vicinity || ''}</div>
                <div style="font-size: 11px; display: flex; gap: 8px;">${rating} ${open}</div>
                <a href="https://www.google.com/maps/place/?q=place_id:${place.place_id}" target="_blank" rel="noopener"
                   style="display: inline-block; margin-top: 6px; padding: 4px 10px; background: #f97316; color: white; border-radius: 4px; font-size: 11px; font-weight: 600; text-decoration: none;">
                  Ver en Maps
                </a>
              </div>
            `);
            routeInfoWindow.open(routeMap, marker);
          });

          gasStationMarkers.push(marker);
        });

        gasStationsVisible = true;
        if (btn) {
          btn.style.background = '#f97316';
          btn.style.color = 'white';
          btn.style.borderColor = '#f97316';
        }
        showToast('success', 'Bencinerías', `${results.length} estaciones encontradas`);
      });
    }

    function buildStep4Summary() {
      const container = document.getElementById('wizard-step4-summary');
      if (!container || !optimizedRouteData) return;

      const isMultiDay = optimizedRouteData.days && Object.keys(optimizedRouteData.days).length > 0;
      const stats = isMultiDay ? optimizedRouteData.totalStats : optimizedRouteData.stats;
      const dayNames = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];

      let timeStr = `${stats.estimatedTime} min`;
      if (stats.estimatedTime >= 60) {
        const h = Math.floor(stats.estimatedTime / 60);
        const m = stats.estimatedTime % 60;
        timeStr = m > 0 ? `${h}h ${m}m` : `${h}h`;
      }

      let daysHtml = '';
      if (isMultiDay) {
        const dayKeys = Object.keys(optimizedRouteData.days).sort();
        daysHtml = '<div style="padding: 8px 10px; border-top: 1px solid var(--border);">' +
          '<div style="font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Desglose por día</div>' +
          dayKeys.map(date => {
            const d = new Date(date + 'T12:00:00');
            const dayData = optimizedRouteData.days[date];
            const ds = dayData.stats;
            let dt = `${ds.estimatedTime}m`;
            if (ds.estimatedTime >= 60) { const h = Math.floor(ds.estimatedTime / 60); const m = ds.estimatedTime % 60; dt = m > 0 ? `${h}h${m}m` : `${h}h`; }
            return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 3px 0; font-size: 11px; border-bottom: 1px solid var(--border);">
              <span style="font-weight: 600;">${dayNames[d.getDay()]} ${d.getDate()}</span>
              <span style="color: var(--text-muted);">${ds.totalClients} cl · ${ds.distanceKm}km · ${dt} · <span style="color: var(--danger); font-weight: 600;">$${ds.costCLP.toLocaleString('es-CL')}</span></span>
            </div>`;
          }).join('') +
          `<div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 12px; font-weight: 700; margin-top: 2px;">
            <span>Total Semana</span>
            <span style="color: var(--danger);">$${stats.costCLP.toLocaleString('es-CL')}</span>
          </div>` +
        '</div>';
      }

      container.innerHTML = `
        <div style="padding: 8px 10px; background: var(--bg-hover); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 12px; font-weight: 600;">Resumen de Ruta</span>
          <button onclick="openFullRouteInMaps()" class="btn btn-sm" style="background: #4285f4; color: white; border: none; padding: 3px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 3px;"><i data-lucide="map-pin" style="width:10px;height:10px;"></i> Maps</button>
        </div>
        <div style="padding: 8px 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 0; border-bottom: 1px solid var(--border);">
          <div style="text-align: center; padding: 2px; border-right: 1px solid var(--border);">
            <div style="font-size: 16px; font-weight: 700; color: var(--accent);">${stats.totalClients}</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">Clientes</div>
          </div>
          <div style="text-align: center; padding: 2px; border-right: 1px solid var(--border);">
            <div style="font-size: 16px; font-weight: 700;">${stats.distanceKm} km</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">Distancia</div>
          </div>
          <div style="text-align: center; padding: 2px; border-right: 1px solid var(--border);">
            <div style="font-size: 16px; font-weight: 700; color: var(--warning);">${timeStr}</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">Tiempo</div>
          </div>
          <div style="text-align: center; padding: 2px;">
            <div style="font-size: 16px; font-weight: 700; color: var(--danger);">$${stats.costCLP.toLocaleString('es-CL')}</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">Costo Total</div>
          </div>
        </div>
        ${daysHtml}
      `;
      lucide.createIcons();
    }

    function closeOptimizedRoutePanel() {
      document.getElementById('optimized-route-panel').style.display = 'none';
      optimizedRouteData = null;
      selectedOptDay = null;
      // Hide day tabs
      const tabsEl = document.getElementById('opt-day-tabs');
      if (tabsEl) tabsEl.style.display = 'none';
      // Clear route line from map
      if (window.routePolyline) {
        window.routePolyline.setMap(null);
        window.routePolyline = null;
      }
    }

    function scheduleOptimizedRoute() {
      const hasRoute = optimizedRouteData && (
        (optimizedRouteData.route && optimizedRouteData.route.length > 0) ||
        (optimizedRouteData.days && Object.keys(optimizedRouteData.days).length > 0)
      );
      if (!hasRoute) {
        showToast('warning', 'Sin ruta', 'Genera una ruta optimizada primero');
        return;
      }
      if (!selectedExecutiveId) {
        showToast('warning', 'Sin vendedor', 'Selecciona un vendedor primero');
        return;
      }

      const vendor = allUsers.find(u => u.id === selectedExecutiveId);
      document.getElementById('schedule-vendor-name').textContent = vendor?.full_name || 'Vendedor';

      const isMultiDay = optimizedRouteData.days && Object.keys(optimizedRouteData.days).length > 0;

      if (isMultiDay) {
        const dayKeys = Object.keys(optimizedRouteData.days).sort();
        const totalClients = optimizedRouteData.totalStats?.totalClients || (optimizedRouteData.route && optimizedRouteData.route.length) || 0;
        document.getElementById('schedule-client-count').textContent = `${totalClients} clientes en ${dayKeys.length} días`;
        document.getElementById('schedule-single-date').style.display = 'none';
        document.getElementById('schedule-multi-summary').style.display = 'block';

        // Set default start date
        document.getElementById('schedule-multi-start-date').value = dayKeys[0];

        renderMultiDaySummaryTable(dayKeys);
      } else {
        // Fallback: single day
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        while (tomorrow.getDay() === 0 || tomorrow.getDay() === 6) {
          tomorrow.setDate(tomorrow.getDate() + 1);
        }
        document.getElementById('schedule-client-count').textContent = `${optimizedRouteData.route.length} clientes en orden optimizado`;
        document.getElementById('schedule-single-date').style.display = 'block';
        document.getElementById('schedule-multi-summary').style.display = 'none';
        document.getElementById('schedule-route-date').value = tomorrow.toISOString().split('T')[0];
      }

      document.getElementById('schedule-route-modal').style.display = 'flex';
      lucide.createIcons();
    }

    function closeScheduleRouteModal() {
      document.getElementById('schedule-route-modal').style.display = 'none';
    }

    function renderMultiDaySummaryTable(dayKeys) {
      const dayNames = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
      const originalKeys = Object.keys(optimizedRouteData.days).sort();
      const tbody = document.getElementById('schedule-multi-tbody');
      tbody.innerHTML = dayKeys.map((date, i) => {
        const d = new Date(date + 'T12:00:00');
        const origKey = originalKeys[i];
        const dayData = optimizedRouteData.days[origKey];
        if (!dayData) return '';
        return `<tr data-orig-date="${origKey}" data-new-date="${date}">
          <td style="padding:6px 8px; border-bottom:1px solid var(--border);">${dayNames[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}</td>
          <td style="padding:6px 8px; text-align:center; border-bottom:1px solid var(--border); font-weight:600;">${dayData.stats.totalClients}</td>
          <td style="padding:6px 8px; text-align:center; border-bottom:1px solid var(--border);">${dayData.stats.distanceKm} km</td>
          <td style="padding:6px 8px; text-align:center; border-bottom:1px solid var(--border);">${dayData.stats.totalHours || Math.round(dayData.stats.estimatedTime/60*10)/10}h</td>
        </tr>`;
      }).join('');
    }

    function recalcMultiDayDates() {
      if (!optimizedRouteData || !optimizedRouteData.days) return;
      const startStr = document.getElementById('schedule-multi-start-date').value;
      if (!startStr) return;

      const originalKeys = Object.keys(optimizedRouteData.days).sort();
      const numDays = originalKeys.length;

      // Generate new weekdays starting from selected date
      const newDays = [];
      const cursor = new Date(startStr + 'T12:00:00');
      while (newDays.length < numDays) {
        if (cursor.getDay() >= 1 && cursor.getDay() <= 5) {
          newDays.push(cursor.toISOString().split('T')[0]);
        }
        cursor.setDate(cursor.getDate() + 1);
      }

      renderMultiDaySummaryTable(newDays);
    }

    function getShiftedDaysMapping() {
      // Returns mapping: { newDate: originalDayData } based on modal table
      const rows = document.querySelectorAll('#schedule-multi-tbody tr[data-orig-date]');
      const mapping = {};
      rows.forEach(row => {
        const origDate = row.getAttribute('data-orig-date');
        const newDate = row.getAttribute('data-new-date');
        if (origDate && newDate && optimizedRouteData.days[origDate]) {
          mapping[newDate] = optimizedRouteData.days[origDate];
        }
      });
      return mapping;
    }

    async function confirmScheduleRoute() {
      const isMultiDay = optimizedRouteData.days && Object.keys(optimizedRouteData.days).length > 0;
      const vendorId = selectedExecutiveId;

      // Read data from modal BEFORE replacing content with overlay
      const shiftedMapping = isMultiDay ? getShiftedDaysMapping() : null;
      const singleDate = !isMultiDay ? document.getElementById('schedule-route-date').value : null;

      // Calculate totals for progress display
      const totalDaysCount = isMultiDay ? Object.keys(shiftedMapping).length : 1;
      const totalClientsCount = isMultiDay
        ? Object.values(shiftedMapping).reduce((s, d) => s + d.route.length, 0)
        : (optimizedRouteData.route ? optimizedRouteData.route.length : 0);

      // Show branded loading overlay on modal
      const modalContent = document.querySelector('#schedule-route-modal > div');
      const originalContent = modalContent.innerHTML;
      modalContent.innerHTML = `
        <div style="text-align:center; padding:48px 24px;">
          <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,#6366f1,#4f46e5);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 8px 24px rgba(99,102,241,0.3);">
            <i data-lucide="route" style="width:32px;height:32px;color:white;"></i>
          </div>
          <h3 style="margin:0 0 6px 0; color:var(--text); font-size:18px; font-weight:700;">Programando ruta</h3>
          <p style="color:var(--text-muted); font-size:13px; margin:0 0 8px 0;">Optimizando recorridos y guardando horarios...</p>
          <div style="display:flex;justify-content:center;gap:16px;margin-bottom:20px;">
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:800;color:var(--accent);">${totalClientsCount}</div>
              <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Clientes</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:800;color:#10b981;">${totalDaysCount}</div>
              <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;">Días</div>
            </div>
          </div>
          <div id="schedule-progress-percent" style="font-size:28px;font-weight:800;color:var(--accent);margin-bottom:8px;">0%</div>
          <div style="width:100%;max-width:280px;height:8px;border-radius:4px;background:var(--bg-hover);margin:0 auto;overflow:hidden;">
            <div id="schedule-progress-bar" style="width:0%;height:100%;border-radius:4px;background:linear-gradient(90deg,#6366f1,#10b981);transition:width 0.4s ease;"></div>
          </div>
          <div id="schedule-progress-text" style="font-size:12px;color:var(--text-muted);margin-top:10px;font-weight:600;">Preparando...</div>
          <p style="color:var(--text-muted); font-size:11px; margin:16px 0 0 0; opacity:0.7;">LEKER Logistics</p>
        </div>`;
      lucide.createIcons();

      // Animate progress text and percentage
      const progressTextEl = document.getElementById('schedule-progress-text');
      const progressBarEl = document.getElementById('schedule-progress-bar');
      const progressPctEl = document.getElementById('schedule-progress-percent');
      const steps = [
        { text: 'Preparando...', pct: 5 },
        { text: 'Validando clientes...', pct: 20 },
        { text: 'Calculando rutas óptimas...', pct: 45 },
        { text: 'Optimizando recorridos...', pct: 65 },
        { text: 'Guardando horarios...', pct: 80 },
        { text: 'Finalizando...', pct: 95 }
      ];
      let stepIdx = 0;
      function updateProgress(pct, text) {
        if (progressBarEl) progressBarEl.style.width = pct + '%';
        if (progressPctEl) progressPctEl.textContent = pct + '%';
        if (text && progressTextEl) progressTextEl.textContent = text;
      }
      updateProgress(steps[0].pct, steps[0].text);
      const stepInterval = setInterval(() => {
        stepIdx++;
        if (stepIdx < steps.length) updateProgress(steps[stepIdx].pct, steps[stepIdx].text);
      }, 800);

      try {
        let firstDate;
        let scheduledClientCount = 0;

        if (isMultiDay) {
          const daysPayload = {};
          const newDates = Object.keys(shiftedMapping).sort();
          firstDate = newDates[0];

          for (const newDate of newDates) {
            const dayData = shiftedMapping[newDate];
            daysPayload[newDate] = dayData.route.map(c => ({
              id: c.id,
              estimatedArrival: c.estimatedArrival || null
            }));
            scheduledClientCount += dayData.route.length;
          }

          const res = await fetch(`${API}/api/routes/schedule-optimized-multi`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: vendorId, days: daysPayload })
          });
          const data = await res.json();
          if (!data.success) {
            clearInterval(stepInterval);
            showToast('error', 'Error', data.error || 'No se pudo programar la ruta');
            modalContent.innerHTML = originalContent;
            lucide.createIcons();
            return;
          }

          // Show success in modal briefly
          clearInterval(stepInterval);
          updateProgress(100, 'Completado');
          await new Promise(r => setTimeout(r, 400));
          modalContent.innerHTML = `
            <div style="text-align:center; padding:48px 24px;">
              <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#10b981,#059669);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;box-shadow:0 8px 24px rgba(16,185,129,0.3);animation:scaleIn 0.3s ease;">
                <i data-lucide="check" style="width:32px;height:32px;color:white;"></i>
              </div>
              <h3 style="margin:0 0 8px 0; color:var(--success); font-size:18px; font-weight:700;">Ruta programada</h3>
              <p style="color:var(--text-muted); font-size:14px; margin:0;">${scheduledClientCount} clientes en ${newDates.length} días</p>
              <style>@keyframes scaleIn{0%{transform:scale(0)}50%{transform:scale(1.15)}100%{transform:scale(1)}}</style>
            </div>`;
          lucide.createIcons();

        } else {
          const date = singleDate;
          if (!date) {
            showToast('warning', 'Sin fecha', 'Selecciona una fecha');
            modalContent.innerHTML = originalContent;
            lucide.createIcons();
            return;
          }
          firstDate = date;
          const clients = optimizedRouteData.route.map(c => ({ id: c.id }));
          scheduledClientCount = clients.length;

          const res = await fetch(`${API}/api/routes/schedule-optimized`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: vendorId, date, clients })
          });
          const data = await res.json();
          if (!data.success) {
            clearInterval(stepInterval);
            showToast('error', 'Error', data.error || 'No se pudo programar la ruta');
            modalContent.innerHTML = originalContent;
            lucide.createIcons();
            return;
          }

          clearInterval(stepInterval);
          updateProgress(100, 'Completado');
          await new Promise(r => setTimeout(r, 400));
          const dateObj = new Date(date + 'T12:00:00');
          const dateLabel = dateObj.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' });
          modalContent.innerHTML = `
            <div style="text-align:center; padding:48px 24px;">
              <div style="width:48px;height:48px;border-radius:50%;background:rgba(16,185,129,0.15);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                <i data-lucide="check" style="width:28px;height:28px;color:var(--success);"></i>
              </div>
              <h3 style="margin:0 0 8px 0; color:var(--success); font-size:16px;">Ruta programada</h3>
              <p style="color:var(--text-muted); font-size:13px; margin:0;">${clients.length} clientes para ${dateLabel}</p>
            </div>`;
          lucide.createIcons();
        }

        // Brief pause to show success animation
        await new Promise(r => setTimeout(r, 1200));
        closeScheduleRouteModal();
        modalContent.innerHTML = originalContent;
        lucide.createIcons();

        // 1. Calculate target week BEFORE switching tab
        const targetDate = new Date(firstDate + 'T12:00:00');
        const now = new Date();
        const dayOfWeek = now.getDay();
        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const thisMonday = new Date(now);
        thisMonday.setDate(now.getDate() + mondayOffset);
        thisMonday.setHours(0,0,0,0);
        const diffDays = Math.floor((targetDate - thisMonday) / (1000 * 60 * 60 * 24));
        const weekOffset = Math.floor(diffDays / 7);

        // 2. Set correct week dates FIRST
        setWeekFromOffset(weekOffset);

        // 3. Reset wizard (clears route data, goes to step 1)
        resetRouteWizard();

        // 4. Switch to Planner (auto-calls loadWeeklyAllExecs with correct dates)
        switchRouteTab('planner');

        // 5. Scroll to planner
        setTimeout(() => {
          const plannerCard = document.getElementById('weekly-planner-card');
          if (plannerCard) plannerCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      } catch (e) {
        console.error('Error scheduling route:', e);
        showToast('error', 'Error', 'Error al programar: ' + (e.message || 'Error desconocido'));
        modalContent.innerHTML = originalContent;
        lucide.createIcons();
      }
    }

    // Reset wizard to step 1 clean state (after scheduling or manually)
    function resetRouteWizard() {
      // Clear route data
      optimizedRouteData = null;
      selectedOptDay = null;

      // Reset to step 1
      goToRouteStep(1);

      // Clear vendor selection
      clearExecutiveFilter();

      // Clear step 4 success state
      const successDiv = document.getElementById('wizard-step4-success');
      const contentDiv = document.getElementById('wizard-step4-content');
      if (successDiv) successDiv.style.display = 'none';
      if (contentDiv) contentDiv.style.display = 'block';

      // Clear step 4 summary
      const summary = document.getElementById('wizard-step4-summary');
      if (summary) summary.innerHTML = '';

      // Clear optimized route panel
      const optPanel = document.getElementById('optimized-route-panel');
      if (optPanel) optPanel.style.display = 'none';

      // Clear route markers from map
      if (routeMarkers) {
        routeMarkers.forEach(m => m.setMap(null));
        routeMarkers = [];
      }
      if (window.routePolyline) {
        window.routePolyline.setMap(null);
        window.routePolyline = null;
      }
    }

    async function drawOptimizedRouteOnMap(dayDate) {
      if (!optimizedRouteData) return;

      // Clear preview markers (from vendor selection)
      clearPreviewMarkers();

      // Determine which clients to draw
      let routeClients;
      if (dayDate && optimizedRouteData.days && optimizedRouteData.days[dayDate]) {
        routeClients = optimizedRouteData.days[dayDate].route;
      } else if (optimizedRouteData.route && optimizedRouteData.route.length) {
        routeClients = optimizedRouteData.route;
      } else {
        return;
      }
      if (!routeMap) return;

      // Clear existing route line
      if (window.routePolyline) {
        window.routePolyline.setMap(null);
        window.routePolyline = null;
      }

      // Clear existing markers
      routeMarkers.forEach(m => m.setMap(null));
      routeMarkers = [];

      // Get vendor's home address for start/end point
      const vendor = selectedExecutiveId ? allUsers.find(u => u.id === selectedExecutiveId) : null;
      const homePoint = vendor && vendor.home_lat && vendor.home_lng
        ? { lat: parseFloat(vendor.home_lat), lng: parseFloat(vendor.home_lng) }
        : null;

      // Build coordinates array and add numbered markers
      const path = [];
      const bounds = new google.maps.LatLngBounds();

      // Add home marker as start point
      if (homePoint) {
        bounds.extend(homePoint);
        const homeSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="44" viewBox="0 0 36 44">
          <path d="M18 0C9 0 0 8 0 18c0 13.5 18 26 18 26s18-12.5 18-26C36 8 27 0 18 0z" fill="#7c3aed" stroke="white" stroke-width="2"/>
          <path d="M18 9l-8 7v8h5v-5h6v5h5v-8z" fill="white"/>
        </svg>`;
        const homeMarker = new google.maps.Marker({
          position: homePoint,
          map: routeMap,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(homeSvg),
            scaledSize: new google.maps.Size(36, 44),
            anchor: new google.maps.Point(18, 44)
          },
          title: `Punto de inicio: ${vendor.home_address || vendor.full_name}`,
          zIndex: 999
        });
        homeMarker.addListener('click', () => {
          routeInfoWindow.setContent(`
            <div style="min-width: 180px; padding: 4px;">
              <div style="font-weight: 700; font-size: 14px; color: #7c3aed; margin-bottom: 6px;">
                Punto de Partida / Llegada
              </div>
              <div style="font-size: 12px; color: #6b7280;">${vendor.home_address || 'Punto de inicio'}</div>
              <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">${vendor.full_name}</div>
            </div>
          `);
          routeInfoWindow.open(routeMap, homeMarker);
        });
        routeMarkers.push(homeMarker);
        path.push(homePoint);
      }

      // Track positions to offset overlapping markers
      const positionCounts = {};

      console.log(`[Map] Drawing ${routeClients.length} clients for day ${dayDate}`);

      routeClients.forEach((client, idx) => {
        if (client.lat && client.lng) {
          const origLat = parseFloat(client.lat);
          const origLng = parseFloat(client.lng);
          let lat = origLat;
          let lng = origLng;

          // Offset overlapping markers in a circle pattern (visible at city zoom)
          const posKey = `${lat.toFixed(3)},${lng.toFixed(3)}`;
          positionCounts[posKey] = (positionCounts[posKey] || 0);
          const count = positionCounts[posKey];
          if (count > 0) {
            const angle = (count * (360 / 6)) * (Math.PI / 180); // 6 positions around circle
            const offset = 0.003; // ~330m offset — visible at city zoom
            lat += Math.cos(angle) * offset;
            lng += Math.sin(angle) * offset;
          }
          positionCounts[posKey]++;

          const pos = { lat, lng };
          path.push({ lat: origLat, lng: origLng }); // original for polyline
          bounds.extend(pos);

          console.log(`[Map] Marker ${idx+1}: ${client.fantasy_name || client.name} at ${lat.toFixed(5)},${lng.toFixed(5)} (offset: ${count > 0 ? 'yes' : 'no'})`);

          const num = idx + 1;
          const markerColor = idx === 0 ? '#10b981' : '#3b82f6';

          // Create numbered marker with inline SVG (always visible at any zoom)
          const svgMarker = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40">
            <path d="M16 0C7.2 0 0 7.2 0 16c0 12 16 24 16 24s16-12 16-24C32 7.2 24.8 0 16 0z" fill="${markerColor}" stroke="white" stroke-width="2"/>
            <text x="16" y="20" text-anchor="middle" fill="white" font-size="14" font-weight="bold" font-family="Arial">${num}</text>
          </svg>`;
          const marker = new google.maps.Marker({
            position: pos,
            map: routeMap,
            icon: {
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svgMarker),
              scaledSize: new google.maps.Size(32, 40),
              anchor: new google.maps.Point(16, 40)
            },
            title: `${num}. ${client.fantasy_name || client.name}`,
            zIndex: 100 + num
          });

          const infoContent = `
            <div style="min-width: 220px; padding: 4px;">
              <div style="font-weight: 700; font-size: 15px; color: #1e40af; margin-bottom: 8px;">
                ${num}. ${client.fantasy_name || client.name}
              </div>
              <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                <strong>Dirección:</strong> ${client.address || 'Sin dirección'}
              </div>
              <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">
                <strong>Comuna:</strong> ${client.commune || '-'}
              </div>
              <div style="font-size: 12px; margin-bottom: 8px;">
                <span style="background: ${{A:'#d97706',B:'#3b82f6',C:'#059669',D:'#f97316',E:'#9ca3af'}[client.segment] || '#9ca3af'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px;">Segmento ${client.segment || '-'}</span>
                ${client.priority === 'FOCO' ? '<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 4px;">FOCO</span>' : ''}
              </div>
              <div style="display: flex; gap: 6px;">
                <a href="https://www.google.com/maps/dir/?api=1&destination=${pos.lat},${pos.lng}&travelmode=driving" target="_blank" rel="noopener"
                   style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: #4285f4; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; text-decoration: none;">
                  Google Maps
                </a>
                <a href="https://waze.com/ul?ll=${pos.lat},${pos.lng}&navigate=yes" target="_blank" rel="noopener"
                   style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: #33ccff; color: #000; border-radius: 6px; font-size: 12px; font-weight: 600; text-decoration: none;">
                  Waze
                </a>
              </div>
            </div>
          `;

          marker.addListener('click', () => {
            routeInfoWindow.setContent(infoContent);
            routeInfoWindow.open(routeMap, marker);
          });

          routeMarkers.push(marker);
        }
      });

      // Add home as return point (close the loop)
      if (homePoint) {
        path.push(homePoint);
      }

      // Fit map to show all markers FIRST (so markers are always visible)
      if (path.length > 0) {
        routeMap.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });
      }

      // Draw route polyline (real streets via Directions API)
      if (path.length > 1) {
        // Always draw a fallback straight-line polyline immediately
        window.routePolyline = new google.maps.Polyline({
          path: path,
          geodesic: true,
          strokeColor: '#10b981',
          strokeOpacity: 0.4,
          strokeWeight: 3,
          icons: [{ icon: { path: 'M 0,-1 0,1', strokeOpacity: 0.6, scale: 3 }, offset: '0', repeat: '15px' }]
        });
        window.routePolyline.setMap(routeMap);

        // Then try to get real street directions (replaces the straight line)
        try {
          console.log(`[Map] Requesting Directions for ${path.length} waypoints...`);
          const directions = await getDirectionsRoute(path);
          console.log(`[Map] Directions result:`, directions ? `${directions.totalDistanceKm}km, ${directions.path.length} path points` : 'NULL (fallback to straight lines)');
          if (directions && directions.path.length > 0) {
            // Remove straight-line fallback
            if (window.routePolyline) window.routePolyline.setMap(null);
            window.routePolyline = new google.maps.Polyline({
              path: directions.path,
              geodesic: false,
              strokeColor: '#10b981',
              strokeOpacity: 0.8,
              strokeWeight: 4
            });
            window.routePolyline.setMap(routeMap);
            // Update stats panel with real Directions data
            const fuelEff = optimizedRouteData?.totalStats?.vehicleConfig?.FUEL_EFFICIENCY_KML || optimizedRouteData?.stats?.vehicleConfig?.FUEL_EFFICIENCY_KML || 10;
            const liters = (directions.totalDistanceKm / fuelEff).toFixed(1);
            const cost = Math.round((directions.totalDistanceKm / fuelEff) * FUEL_PRICE_PER_LITER);
            const clientCount = routeClients.length;
            const totalTimeMin = directions.totalDurationMin + (clientCount * 60); // + 60min per visit (1 hora por cliente)
            document.getElementById('opt-distance').textContent = `${directions.totalDistanceKm} km`;
            document.getElementById('opt-liters').textContent = `${liters} L`;
            document.getElementById('opt-cost').textContent = `$${cost.toLocaleString('es-CL')}`;
            if (totalTimeMin >= 60) {
              const h = Math.floor(totalTimeMin / 60);
              const m = totalTimeMin % 60;
              document.getElementById('opt-time').textContent = m > 0 ? `${h}h ${m}m` : `${h}h`;
            } else {
              document.getElementById('opt-time').textContent = `${totalTimeMin} min`;
            }
          }
        } catch (e) {
          console.warn('Directions failed, keeping straight-line fallback:', e.message);
        }
      }
    }

    function filterByExecutive(execId) {
      if (execId !== undefined) {
        selectedExecutiveId = execId;
      }
      updateExecutiveStats();
      loadExecutiveClients();
      loadExecutiveRouteOnMap();

      // Sync with visits panel
      const visitFilter = document.getElementById('visit-executive-filter');
      if (visitFilter) visitFilter.value = selectedExecutiveId;
      filterVisitsByExecutive();

      // Sync with "Iniciar Jornada" form
      const startUserSelect = document.getElementById('start-user');
      if (startUserSelect && selectedExecutiveId) {
        startUserSelect.value = selectedExecutiveId;
        // Check for active route
        checkActiveRoute(selectedExecutiveId);
      }
    }

    function filterVisitsByExecutive() {
      const execId = document.getElementById('visit-executive-filter').value;
      const routeSelect = document.getElementById('checkin-route');

      // Sync with main executive search
      if (execId && selectedExecutiveId !== execId) {
        selectExecutive(execId);
      }

      // Filter routes for this executive
      routeSelect.innerHTML = '';

      // Remove any previous "Iniciar Jornada" button
      const prevStartBtn = document.getElementById('visit-start-day-btn');
      if (prevStartBtn) prevStartBtn.remove();

      if (!execId) {
        routeSelect.innerHTML = '<option value="">-- Selecciona un vendedor arriba --</option>';
        document.getElementById('client-count-label').textContent = '';
        renderTodayVisits();
        return;
      }

      const execRoutes = todayRoutesData.filter(r => r.user_id === execId);
      const activeRoute = execRoutes.find(r => r.status === 'active');
      const scheduledClients = todayScheduledData[execId] || [];

      const statusEl = document.getElementById('visit-route-status');

      // Reset inline styles that may persist from scheduled-route branch
      statusEl.style.background = '';
      statusEl.style.color = '';

      if (activeRoute) {
        routeSelect.innerHTML = `<option value="${activeRoute.id}">${activeRoute.user?.full_name || 'Vendedor'} - Ruta activa</option>`;
        document.getElementById('route-info-text').textContent = `Vehículo: ${activeRoute.vehicle?.license_plate || 'N/A'} | Inicio: ${activeRoute.start_km} km`;
        document.getElementById('route-info-text').style.display = 'block';
        statusEl.textContent = 'Ruta Activa';
        statusEl.className = 'badge badge-success';
        statusEl.style.display = 'inline-block';
      } else if (execRoutes.length > 0) {
        routeSelect.innerHTML = `<option value="">Ruta completada hoy</option>`;
        statusEl.textContent = 'Completada';
        statusEl.className = 'badge badge-secondary';
        statusEl.style.display = 'inline-block';
      } else if (scheduledClients.length > 0) {
        // Has scheduled route but no daily_route started
        routeSelect.innerHTML = `<option value="">Ruta programada (${scheduledClients.length} clientes) — Inicie jornada</option>`;
        document.getElementById('route-info-text').textContent = '';
        document.getElementById('route-info-text').style.display = 'none';
        statusEl.textContent = 'Ruta Programada';
        statusEl.className = 'badge';
        statusEl.style.display = 'inline-block';
        statusEl.style.background = '#f59e0b';
        statusEl.style.color = '#fff';

        // Add "Iniciar Jornada" button after the route select
        const startBtn = document.createElement('button');
        startBtn.id = 'visit-start-day-btn';
        startBtn.className = 'btn btn-success';
        startBtn.style.cssText = 'margin-top: 10px; width: 100%; font-weight: 600;';
        startBtn.innerHTML = '<i data-lucide="play-circle" style="width:16px;height:16px;"></i> Iniciar Jornada';
        startBtn.onclick = () => startDayFromVisits(execId);
        routeSelect.parentNode.appendChild(startBtn);
        lucide.createIcons();
      } else {
        routeSelect.innerHTML = `<option value="">Sin ruta activa hoy</option>`;
        statusEl.textContent = 'Sin Ruta';
        statusEl.className = 'badge badge-warning';
        statusEl.style.display = 'inline-block';
      }

      // Update client count for this executive's assigned clients
      const assignedClients = allClients.filter(c => c.assigned_user_id === execId);
      document.getElementById('client-count-label').textContent = `(${assignedClients.length} asignados)`;

      // Render today's visits section
      renderTodayVisits();
    }

    // Start daily route from Visits panel for an executive with scheduled routes
    async function startDayFromVisits(execId) {
      const btn = document.getElementById('visit-start-day-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width:16px;height:16px;"></i> Iniciando...';
        lucide.createIcons();
      }

      try {
        // Find first active vehicle
        const activeVehicle = allVehicles.find(v => v.status === 'active');
        if (!activeVehicle) {
          showToast('error', 'Sin vehículo', 'No hay vehículos activos disponibles');
          return;
        }

        const res = await fetch(`${API}/routes/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: execId, vehicleId: activeVehicle.id, startKm: 0 })
        });
        const data = await res.json();

        if (data.success) {
          showToast('success', 'Jornada iniciada', `Ruta creada para ${data.data.user?.name || 'vendedor'}`);
          // Reload today's routes and refresh the panel
          try {
            const todayRes = await fetch(`${API}/api/daily-routes/today`);
            const todayData = await todayRes.json();
            todayRoutesData = todayData.success ? todayData.data : [];
          } catch (e) {
            todayRoutesData = [];
          }
          filterVisitsByExecutive();
        } else {
          showToast('error', 'Error', data.error || 'No se pudo iniciar la jornada');
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i data-lucide="play-circle" style="width:16px;height:16px;"></i> Iniciar Jornada';
          lucide.createIcons();
        }
      }
    }

    // Render "Visitas de Hoy" section with completed visits and pending scheduled clients
    function renderTodayVisits() {
      const container = document.getElementById('today-visits');
      if (!container) return;

      const execId = document.getElementById('visit-executive-filter')?.value;

      // No vendor selected → show overview of ALL vendors
      if (!execId) {
        renderTodayVisitsOverview(container);
        return;
      }

      // Get data
      const execRoute = todayRoutesData.find(r => r.user_id === execId);
      const completedVisits = execRoute?.visits || [];
      const scheduledClients = (todayScheduledData[execId] || []);
      const visitedClientIds = new Set(completedVisits.map(v => v.client_id));
      const pendingScheduled = scheduledClients.filter(sc => !visitedClientIds.has(sc.client_id));
      const execUser = allUsers.find(u => u.id === execId);
      const execName = execUser?.full_name || 'Vendedor';
      const totalCount = completedVisits.length + pendingScheduled.length;
      const pct = totalCount > 0 ? Math.round((completedVisits.length / totalCount) * 100) : 0;

      if (completedVisits.length === 0 && pendingScheduled.length === 0) {
        container.innerHTML = `<div class="empty-state" style="padding: 24px;">
          <i data-lucide="clipboard" style="width: 40px; height: 40px;"></i>
          <p style="font-size: 13px;">Sin visitas ni clientes programados para ${execName}</p>
        </div>`;
        lucide.createIcons();
        return;
      }

      // Outcomes
      const outcomes = { sale: 0, contacted: 0, no_contact: 0, pending: 0 };
      completedVisits.forEach(v => {
        if (v.outcome === 'sale' || v.outcome === 'venta') outcomes.sale++;
        else if (v.outcome === 'contacted' || v.outcome === 'seguimiento') outcomes.contacted++;
        else if (v.outcome === 'no_contact' || v.outcome === 'no_contacto' || v.outcome === 'sin_venta') outcomes.no_contact++;
        else outcomes.pending++;
      });

      const isActive = execRoute && execRoute.status === 'active';
      const statusLabel = isActive ? 'En Ruta' : execRoute?.status === 'completed' ? 'Jornada Terminada' : scheduledClients.length > 0 ? 'Sin Iniciar' : 'Sin Ruta';
      const statusColor = isActive ? '#10b981' : execRoute?.status === 'completed' ? '#6b7280' : '#f59e0b';

      let html = `
      <div style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <button onclick="document.getElementById('visit-executive-filter').value='';filterVisitsByExecutive();" style="background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;cursor:pointer;display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text-muted);">
              <i data-lucide="arrow-left" style="width:12px;height:12px;"></i> Todos
            </button>
            <span style="font-size: 15px; font-weight: 700;">${execName}</span>
            <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: ${statusColor}20; color: ${statusColor};">${statusLabel}</span>
          </div>
          <span style="font-size: 22px; font-weight: 800; color: ${pct >= 80 ? '#10b981' : pct >= 40 ? '#f59e0b' : 'var(--text-muted)'};">${pct}%</span>
        </div>
        <div style="height: 6px; border-radius: 3px; background: var(--bg-hover); overflow: hidden; margin-bottom: 6px;">
          <div style="height: 100%; width: ${pct}%; border-radius: 3px; background: linear-gradient(90deg, #6366f1, #10b981); transition: width 0.5s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 10px;">
          <span>${completedVisits.length} de ${totalCount} visitas</span>
          <span>${pendingScheduled.length} pendiente${pendingScheduled.length !== 1 ? 's' : ''}</span>
        </div>
        ${completedVisits.length > 0 ? `
        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;">
          ${outcomes.sale > 0 ? `<span style="background:rgba(16,185,129,0.1);color:#10b981;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid rgba(16,185,129,0.2);">${outcomes.sale} Venta${outcomes.sale > 1 ? 's' : ''}</span>` : ''}
          ${outcomes.contacted > 0 ? `<span style="background:rgba(59,130,246,0.1);color:#3b82f6;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid rgba(59,130,246,0.2);">${outcomes.contacted} Contacto${outcomes.contacted > 1 ? 's' : ''}</span>` : ''}
          ${outcomes.no_contact > 0 ? `<span style="background:rgba(107,114,128,0.1);color:#6b7280;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid rgba(107,114,128,0.2);">${outcomes.no_contact} Sin contacto</span>` : ''}
          ${outcomes.pending > 0 ? `<span style="background:rgba(245,158,11,0.1);color:#f59e0b;padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid rgba(245,158,11,0.2);">${outcomes.pending} Pendiente</span>` : ''}
        </div>` : ''}
      </div>`;

      const outcomeColors = { 'venta': '#10b981', 'sin_venta': '#ef4444', 'no_contacto': '#6b7280', 'seguimiento': '#3b82f6', 'sale': '#10b981', 'contacted': '#3b82f6', 'no_contact': '#6b7280', 'pending': '#f59e0b' };
      const outcomeLabels = { 'venta': 'Venta', 'sin_venta': 'Sin venta', 'no_contacto': 'No contacto', 'seguimiento': 'Contactado', 'sale': 'Venta', 'contacted': 'Contactado', 'no_contact': 'Sin contacto', 'pending': 'Pendiente' };

      // Timeline: merge completed + pending in route order
      html += `<div style="font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; padding: 6px 0; margin-bottom: 4px;">Timeline de visitas</div>`;

      // First show completed
      completedVisits.forEach((v, i) => {
        const time = (v.check_in || v.checked_in_at) ? new Date(v.check_in || v.checked_in_at).toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' }) : '--:--';
        const clientName = v.client?.fantasy_name || v.client?.name || 'Cliente';
        const commune = v.client?.commune || '';
        const oc = outcomeColors[v.outcome] || '#6b7280';
        const ocLabel = outcomeLabels[v.outcome] || v.outcome || 'Registrado';

        html += `<div style="display: flex; align-items: stretch; gap: 0; font-size: 13px;">
          <div style="width: 50px; text-align: right; padding: 10px 8px 10px 0; font-size: 11px; color: var(--text-muted); font-weight: 600;">${time}</div>
          <div style="width: 24px; display: flex; flex-direction: column; align-items: center;">
            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${oc}; flex-shrink: 0; margin-top: 12px; box-shadow: 0 0 0 3px ${oc}30;"></div>
            <div style="width: 2px; flex: 1; background: ${oc}30;"></div>
          </div>
          <div style="flex: 1; padding: 8px 10px; border-bottom: 1px solid var(--border);">
            <div style="font-weight: 600;">${clientName}</div>
            <div style="display: flex; align-items: center; gap: 6px; margin-top: 2px;">
              <span style="padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; background: ${oc}15; color: ${oc};">${ocLabel}</span>
              ${commune ? `<span style="font-size: 10px; color: var(--text-muted);">${commune}</span>` : ''}
            </div>
          </div>
        </div>`;
      });

      // Then pending
      pendingScheduled.forEach((sc, i) => {
        const client = sc.client || {};
        const clientName = client.fantasy_name || client.name || 'Cliente';
        const commune = client.commune || '';
        const arrival = sc.estimated_arrival || '';
        const is8020 = client.segmentation === '80-20';
        const hasGps = client.lat && client.lng;

        html += `<div style="display: flex; align-items: stretch; gap: 0; font-size: 13px;">
          <div style="width: 50px; text-align: right; padding: 10px 8px 10px 0; font-size: 11px; color: var(--text-muted); opacity: 0.65;">${arrival ? arrival.substring(0, 5) : '—'}</div>
          <div style="width: 24px; display: flex; flex-direction: column; align-items: center; opacity: 0.65;">
            <div style="width: 10px; height: 10px; border-radius: 50%; border: 2px solid #d1d5db; background: white; flex-shrink: 0; margin-top: 12px;"></div>
            ${i < pendingScheduled.length - 1 ? '<div style="width: 2px; flex: 1; background: #e5e7eb;"></div>' : '<div style="flex:1;"></div>'}
          </div>
          <div style="flex: 1; padding: 8px 10px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
              <span style="font-weight: 500;">${clientName}</span>
              ${is8020 ? '<span style="font-size:9px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;padding:1px 5px;border-radius:8px;">⭐ 80/20</span>' : ''}
            </div>
            <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px; flex-wrap: wrap;">
              <span style="font-size: 10px; color: #f59e0b; font-weight: 600;">Pendiente</span>
              ${commune ? `<span style="font-size: 10px; color: var(--text-muted);">${commune}</span>` : ''}
              ${hasGps ? `<button onclick="openWazeToClient(${client.lat},${client.lng})" style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:5px;cursor:pointer;padding:2px 8px;font-size:9px;font-weight:600;color:#10b981;">Waze</button>` : ''}
              ${client.id ? `<button onclick="goToCheckinClient('${client.id}')" style="background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);border-radius:5px;cursor:pointer;padding:2px 8px;font-size:9px;font-weight:600;color:#6366f1;">Registrar</button>` : ''}
            </div>
          </div>
        </div>`;
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    // Overview of all vendors when no vendor is selected
    function renderTodayVisitsOverview(container) {
      // Global totals
      const totalVisits = todayRoutesData.reduce((sum, r) => sum + (r.visits?.length || 0), 0);
      const totalScheduled = Object.values(todayScheduledData).reduce((sum, arr) => sum + arr.length, 0);
      const activeCount = todayRoutesData.filter(r => r.status === 'active').length;
      const completedCount = todayRoutesData.filter(r => r.status === 'completed').length;
      const globalPct = totalScheduled > 0 ? Math.round((totalVisits / totalScheduled) * 100) : 0;

      let html = `
      <div style="margin-bottom: 14px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <div style="font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="activity" style="width:16px;height:16px;color:var(--accent);"></i>
            Monitor de Rutas — Hoy
          </div>
          <span style="font-size: 11px; color: var(--text-muted);">${new Date().toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 12px;">
          <div style="padding: 10px; text-align: center; background: var(--bg-hover); border-right: 1px solid var(--border);">
            <div style="font-size: 20px; font-weight: 800; color: #10b981;">${activeCount}</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">En ruta</div>
          </div>
          <div style="padding: 10px; text-align: center; background: var(--bg-hover); border-right: 1px solid var(--border);">
            <div style="font-size: 20px; font-weight: 800; color: #3b82f6;">${totalVisits}</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Check-ins</div>
          </div>
          <div style="padding: 10px; text-align: center; background: var(--bg-hover); border-right: 1px solid var(--border);">
            <div style="font-size: 20px; font-weight: 800; color: #f59e0b;">${totalScheduled - totalVisits}</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Pendientes</div>
          </div>
          <div style="padding: 10px; text-align: center; background: var(--bg-hover);">
            <div style="font-size: 20px; font-weight: 800; color: ${globalPct >= 80 ? '#10b981' : globalPct >= 40 ? '#f59e0b' : 'var(--text-muted)'};">${globalPct}%</div>
            <div style="font-size: 9px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Avance</div>
          </div>
        </div>
        <div style="height: 6px; border-radius: 3px; background: var(--bg-hover); overflow: hidden; margin-bottom: 4px;">
          <div style="height: 100%; width: ${globalPct}%; border-radius: 3px; background: linear-gradient(90deg, #6366f1, #10b981); transition: width 0.5s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted);">
          <span>${totalVisits} de ${totalScheduled} visitas completadas</span>
          <span>${completedCount} jornada${completedCount !== 1 ? 's' : ''} terminada${completedCount !== 1 ? 's' : ''}</span>
        </div>
      </div>`;

      // Build rows per exec
      const rows = [];
      executives.forEach(exec => {
        const dailyRoute = todayRoutesData.find(r => r.user_id === exec.id);
        const scheduled = todayScheduledData[exec.id] || [];
        const visits = dailyRoute?.visits || [];
        const visitsCount = visits.length;
        const scheduledCount = scheduled.length;
        const visitedClientIds = new Set(visits.map(v => v.client_id));

        let status = 'none';
        let sortOrder = 4;
        if (dailyRoute && dailyRoute.status === 'active') { status = 'active'; sortOrder = 0; }
        else if (dailyRoute && dailyRoute.status === 'completed') { status = 'completed'; sortOrder = 2; }
        else if (scheduledCount > 0) { status = 'scheduled'; sortOrder = 1; }

        // Outcomes breakdown
        const outcomes = { sale: 0, contacted: 0, no_contact: 0, pending: 0 };
        visits.forEach(v => {
          if (v.outcome === 'sale' || v.outcome === 'venta') outcomes.sale++;
          else if (v.outcome === 'contacted' || v.outcome === 'seguimiento') outcomes.contacted++;
          else if (v.outcome === 'no_contact' || v.outcome === 'no_contacto') outcomes.no_contact++;
          else outcomes.pending++;
        });

        // Last check-in time
        let lastCheckin = null;
        if (visits.length > 0) {
          const times = visits.map(v => v.check_in || v.checked_in_at).filter(Boolean).sort();
          if (times.length) lastCheckin = new Date(times[times.length - 1]);
        }

        rows.push({ exec, status, sortOrder, visitsCount, scheduledCount, visits, outcomes, lastCheckin, visitedClientIds, scheduled });
      });

      rows.sort((a, b) => a.sortOrder - b.sortOrder);

      // Vendor cards
      rows.forEach(row => {
        const pct = row.scheduledCount > 0 ? Math.round((row.visitsCount / row.scheduledCount) * 100) : 0;
        const pending = Math.max(0, row.scheduledCount - row.visitsCount);

        // Status badge
        const statusMap = {
          active: { label: 'En Ruta', bg: '#10b98120', color: '#10b981', icon: 'play-circle' },
          completed: { label: 'Jornada Terminada', bg: '#6b728020', color: '#6b7280', icon: 'check-circle' },
          scheduled: { label: 'Sin Iniciar', bg: '#f59e0b20', color: '#f59e0b', icon: 'clock' },
          none: { label: 'Sin Ruta', bg: '#ef444420', color: '#ef4444', icon: 'alert-circle' }
        };
        const st = statusMap[row.status];

        // Progress bar color
        const barColor = row.status === 'active' ? '#10b981' : row.status === 'completed' ? '#6b7280' : '#f59e0b';

        // Outcome pills
        let outcomeHtml = '';
        if (row.visitsCount > 0) {
          const pills = [];
          if (row.outcomes.sale > 0) pills.push(`<span style="background:rgba(16,185,129,0.12);color:#10b981;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${row.outcomes.sale} venta${row.outcomes.sale > 1 ? 's' : ''}</span>`);
          if (row.outcomes.contacted > 0) pills.push(`<span style="background:rgba(59,130,246,0.12);color:#3b82f6;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${row.outcomes.contacted} contacto${row.outcomes.contacted > 1 ? 's' : ''}</span>`);
          if (row.outcomes.no_contact > 0) pills.push(`<span style="background:rgba(107,114,128,0.12);color:#6b7280;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${row.outcomes.no_contact} sin contacto</span>`);
          outcomeHtml = `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">${pills.join('')}</div>`;
        }

        // Last activity
        const lastTimeStr = row.lastCheckin ? `Ultimo check-in: ${row.lastCheckin.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' })}` : '';

        html += `
        <div style="border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.15s; ${row.status === 'active' ? 'background: linear-gradient(135deg, rgba(16,185,129,0.04), transparent);' : ''}"
          onmouseenter="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.06)'" onmouseleave="this.style.boxShadow=''"
          onclick="document.getElementById('visit-executive-filter').value='${row.exec.id}';filterVisitsByExecutive();">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${row.status === 'active' ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #6366f1, #8b5cf6)'}; display: flex; align-items: center; justify-content: center; color: white; font-size: 13px; font-weight: 700; flex-shrink: 0;">
              ${(row.exec.full_name || '?').charAt(0).toUpperCase()}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 14px; font-weight: 700;">${row.exec.full_name}</span>
                <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: ${st.bg}; color: ${st.color};">
                  <i data-lucide="${st.icon}" style="width:10px;height:10px;display:inline-block;vertical-align:middle;margin-right:2px;"></i>${st.label}
                </span>
              </div>
              <div style="font-size: 11px; color: var(--text-muted);">${lastTimeStr}${lastTimeStr && row.scheduledCount > 0 ? ' · ' : ''}${row.scheduledCount > 0 ? row.visitsCount + '/' + row.scheduledCount + ' visitas' : 'Sin programacion'}</div>
            </div>
            <div style="text-align: right; flex-shrink: 0;">
              <div style="font-size: 22px; font-weight: 800; color: ${pct >= 80 ? '#10b981' : pct >= 40 ? '#f59e0b' : 'var(--text-muted)'}; line-height: 1;">${pct}%</div>
            </div>
          </div>
          ${row.scheduledCount > 0 ? `
          <div style="height: 5px; border-radius: 3px; background: var(--bg-hover); overflow: hidden; margin-bottom: 6px;">
            <div style="height: 100%; width: ${pct}%; border-radius: 3px; background: ${barColor}; transition: width 0.5s;"></div>
          </div>` : ''}
          ${outcomeHtml}
        </div>`;
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    function onRouteSelected() {
      const routeId = document.getElementById('checkin-route').value;
      if (routeId) {
        // Route selected, enable check-in
      }
    }

    async function loadExecutiveClients() {
      const listDiv = document.getElementById('executive-clients-list');

      if (!selectedExecutiveId) {
        listDiv.innerHTML = `
          <div class="empty-state" style="padding: 24px;">
            <i data-lucide="user-search" style="width: 36px; height: 36px;"></i>
            <p style="font-size: 13px;">Selecciona un vendedor para ver sus clientes asignados</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      executiveClients = allClients.filter(c => c.assigned_user_id === selectedExecutiveId);

      if (executiveClients.length === 0) {
        listDiv.innerHTML = `
          <div class="empty-state" style="padding: 24px;">
            <i data-lucide="users" style="width: 36px; height: 36px;"></i>
            <p style="font-size: 13px;">Este vendedor no tiene clientes asignados</p>
            <button class="btn btn-primary" onclick="openAssignClientsModal()" style="margin-top: 12px;">
              <i data-lucide="user-plus" style="width: 14px; height: 14px;"></i> Asignar Clientes
            </button>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      // If optimized route exists, show clients grouped by day in route order
      if (optimizedRouteData && optimizedRouteData.days) {
        renderRouteOrderedClients(listDiv);
        return;
      }

      // No optimized route — show plain list with exclude buttons
      renderPlainClientList(listDiv);
    }

    function renderRouteOrderedClients(listDiv) {
      const dayKeys = Object.keys(optimizedRouteData.days).sort();
      const dayNames = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
      const excludedCount = excludedClientIds.size;

      // Get vendor home for start/end display
      const routeVendor = selectedExecutiveId ? allUsers.find(u => u.id === selectedExecutiveId) : null;
      const vendorHasHome = routeVendor && routeVendor.home_lat && routeVendor.home_lng;

      // Build set of all route client IDs
      const routeClientIds = new Set();
      dayKeys.forEach(date => {
        (optimizedRouteData.days[date].route || []).forEach(c => routeClientIds.add(c.id));
      });

      // Clients not in route (no GPS or excluded)
      const notInRoute = executiveClients.filter(c => !routeClientIds.has(c.id));

      let html = '';

      // Header
      html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 12px; background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(59,130,246,0.08)); border-bottom: 1px solid var(--border);">
        <span style="font-size: 11px; font-weight: 600; color: var(--text);"><i data-lucide="route" style="width:12px;height:12px;display:inline-block;vertical-align:middle;"></i> Ruta optimizada · ${routeClientIds.size} clientes</span>
        ${excludedCount > 0 ? `<button onclick="restoreAllClients()" style="background: none; border: 1px solid #10b981; color: #10b981; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">Restaurar excluidos (${excludedCount})</button>` : ''}
      </div>`;

      // Render each day as collapsible
      dayKeys.forEach((date, dayIdx) => {
        const d = new Date(date + 'T12:00:00');
        const dayName = dayNames[d.getDay()];
        const dayNum = d.getDate();
        const dayData = optimizedRouteData.days[date];
        const clients = dayData.route || [];
        const stats = dayData.stats;
        const panelId = `day-clients-${date}`;
        const isFirst = dayIdx === 0;

        // Day header — clickable to toggle
        html += `<div onclick="toggleDayClients('${panelId}', this); selectOptDay('${date}')" style="padding: 8px 12px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; font-size: 11px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; border-bottom: 1px solid rgba(255,255,255,0.1);">
          <span style="display:flex;align-items:center;gap:6px;">
            <i data-lucide="${isFirst ? 'chevron-down' : 'chevron-right'}" class="day-toggle-icon" style="width:14px;height:14px;transition:transform 0.2s;"></i>
            <i data-lucide="calendar" style="width:12px;height:12px;"></i>
            ${dayName} ${dayNum} — ${clients.length} clientes
          </span>
          <span style="opacity: 0.85; font-weight: 500; font-size: 10px;">${stats.distanceKm}km · $${stats.costCLP.toLocaleString('es-CL')}</span>
        </div>`;

        // Client rows — first day expanded, rest collapsed
        html += `<div id="${panelId}" style="${isFirst ? '' : 'display:none;'}">`;

        // Home departure row
        if (vendorHasHome) {
          html += `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-bottom: 1px solid var(--border); font-size: 12px; background: rgba(124,58,237,0.06);">
            <span style="width: 22px; height: 22px; border-radius: 4px; background: #7c3aed; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><i data-lucide="home" style="width:12px;height:12px;"></i></span>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #7c3aed; font-size: 11px;">Salida</div>
              <div style="font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${routeVendor.home_address || 'Punto de inicio'}</div>
            </div>
          </div>`;
        }

        clients.forEach((c, i) => {
          const hasGps = c.lat && c.lng;
          const isStart = i === 0;
          html += `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-bottom: 1px solid var(--border); font-size: 12px;">
            <span style="width: 22px; height: 22px; border-radius: 50%; background: ${isStart ? '#10b981' : '#3b82f6'}; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0;">${i + 1}</span>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.fantasy_name || c.name}</div>
              <div style="font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.commune || ''} ${c.address ? '· ' + c.address : ''}</div>
            </div>
            <div style="display: flex; gap: 4px; align-items: center; flex-shrink: 0;">
              ${hasGps ? `<button onclick="event.stopPropagation(); openWazeToClient(${c.lat},${c.lng})" style="background: none; border: none; cursor: pointer; padding: 2px; display:flex;" title="Waze"><i data-lucide="navigation" style="width:12px;height:12px;color:#33ccff;"></i></button>` : ''}
              <button onclick="event.stopPropagation(); removeClientFromRoute('${c.id}','${date}')" style="background: none; border: none; cursor: pointer; padding: 2px; display:flex;" title="Quitar de la ruta"><i data-lucide="x" style="width:13px;height:13px;color:#ef4444;"></i></button>
            </div>
          </div>`;
        });

        // Home return row
        if (vendorHasHome) {
          html += `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-bottom: 1px solid var(--border); font-size: 12px; background: rgba(124,58,237,0.06);">
            <span style="width: 22px; height: 22px; border-radius: 4px; background: #7c3aed; color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><i data-lucide="home" style="width:12px;height:12px;"></i></span>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #7c3aed; font-size: 11px;">Regreso</div>
              <div style="font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${routeVendor.home_address || 'Punto de inicio'}</div>
            </div>
          </div>`;
        }

        html += `</div>`;
      });

      // Clients not in route (sin GPS) — also collapsible
      if (notInRoute.length > 0) {
        html += `<div onclick="toggleDayClients('no-gps-clients', this)" style="padding: 8px 12px; background: #fef3c7; color: #92400e; font-size: 11px; font-weight: 700; display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none;">
          <i data-lucide="chevron-right" class="day-toggle-icon" style="width:14px;height:14px;transition:transform 0.2s;"></i>
          <i data-lucide="alert-triangle" style="width:12px;height:12px;"></i> ${notInRoute.length} clientes sin ubicación confirmada (no incluidos)
        </div>`;
        html += `<div id="no-gps-clients" style="display:none;">`;
        notInRoute.slice(0, 20).forEach(c => {
          html += `<div style="display: flex; align-items: center; gap: 8px; padding: 5px 12px; border-bottom: 1px solid var(--border); font-size: 11px; opacity: 0.6;">
            <span style="width: 22px; height: 22px; border-radius: 50%; background: #d1d5db; color: white; display: flex; align-items: center; justify-content: center; font-size: 9px; flex-shrink: 0;">—</span>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.fantasy_name || c.name}</div>
              <div style="font-size: 9px; color: var(--text-muted);">${c.commune || 'Sin comuna'} · ${c.address || 'Sin dirección'}</div>
            </div>
            <button onclick="event.stopPropagation(); openEditLocationModal('${c.id}', '${(c.fantasy_name || c.name).replace(/'/g, "\\'")}', '${c.address || ''}')" style="background: #fbbf24; color: #78350f; border: none; padding: 2px 6px; border-radius: 4px; font-size: 9px; cursor: pointer; font-weight: 600;">+ GPS</button>
          </div>`;
        });
        if (notInRoute.length > 20) {
          html += `<div style="padding: 4px 12px; text-align: center; color: var(--text-muted); font-size: 10px;">... y ${notInRoute.length - 20} más sin GPS</div>`;
        }
        html += `</div>`;
      }

      listDiv.innerHTML = html;
      lucide.createIcons();
    }

    function toggleDayClients(panelId, headerEl) {
      const panel = document.getElementById(panelId);
      if (!panel) return;
      const isOpen = panel.style.display !== 'none';
      panel.style.display = isOpen ? 'none' : 'block';
      // Update chevron icon
      const icon = headerEl.querySelector('.day-toggle-icon');
      if (icon) {
        icon.setAttribute('data-lucide', isOpen ? 'chevron-right' : 'chevron-down');
        lucide.createIcons();
      }
    }

    function renderPlainClientList(listDiv) {
      const sortedClients = [...executiveClients].sort((a, b) => {
        const aExcl = excludedClientIds.has(a.id) ? 1 : 0;
        const bExcl = excludedClientIds.has(b.id) ? 1 : 0;
        return aExcl - bExcl;
      });

      const activeCount = executiveClients.filter(c => !excludedClientIds.has(c.id)).length;
      const excludedCount = excludedClientIds.size;

      let headerHtml = `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 12px; background: var(--bg-hover); border-bottom: 1px solid var(--border);">
        <span style="font-size: 11px; font-weight: 600; color: var(--text);">${activeCount} en ruta${excludedCount > 0 ? ` · <span style="color:#ef4444;">${excludedCount} excluidos</span>` : ''}</span>
        ${excludedCount > 0 ? `<button onclick="restoreAllClients()" style="background: none; border: 1px solid #10b981; color: #10b981; padding: 2px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600;">Restaurar todos</button>` : ''}
      </div>`;

      listDiv.innerHTML = headerHtml + sortedClients.slice(0, 50).map(c => {
        const segmentColors = { A: '#d97706', B: '#3b82f6', C: '#059669', D: '#f97316', E: '#9ca3af' };
        const segment = c.segment || 'C';
        const segmentColor = segmentColors[segment] || '#6b7280';
        const isFoco = c.priority === 'FOCO';
        const hasGps = c.lat && c.lng;
        const isExcluded = excludedClientIds.has(c.id);
        return `
        <div style="padding: 10px 12px; border-bottom: 1px solid var(--border); ${isExcluded ? 'opacity: 0.4; background: rgba(239,68,68,0.05);' : ''} ${!isExcluded && isFoco ? 'background: rgba(239,68,68,0.05);' : ''} ${!isExcluded && !hasGps ? 'background: rgba(251,191,36,0.1);' : ''}">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                <span style="color: ${isExcluded ? '#9ca3af' : hasGps ? 'var(--text)' : '#b45309'}; ${isExcluded ? 'text-decoration: line-through;' : ''}">${c.fantasy_name || c.name}</span>
                ${isExcluded ? '<span style="background: #ef4444; color: white; padding: 1px 5px; border-radius: 3px; font-size: 9px; font-weight: 600;">EXCLUIDO</span>' : ''}
                ${!isExcluded && isFoco ? '<span style="background: #ef4444; color: white; padding: 1px 5px; border-radius: 3px; font-size: 9px; font-weight: 600;">FOCO</span>' : ''}
                ${!isExcluded && !hasGps ? '<span title="Sin ubicación GPS"><i data-lucide="map-pin-off" style="width:12px;height:12px;color:#f59e0b;"></i></span>' : !isExcluded ? '<span title="Con GPS"><i data-lucide="map-pin" style="width:12px;height:12px;color:#10b981;"></i></span>' : ''}
              </div>
              <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                <code style="background: var(--bg-hover); padding: 1px 4px; border-radius: 3px; font-size: 10px;">${c.external_id}</code>
                ${c.zone ? `<span style="margin-left: 6px; color: #6366f1;"><i data-lucide="map-pin" style="width:10px;height:10px;display:inline-block;vertical-align:middle;"></i> ${c.zone}</span>` : ''}
              </div>
              <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${c.address || ''}">${c.address || 'Sin dirección'}</div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
              ${isExcluded
                ? `<button onclick="toggleExcludeClient('${c.id}')" style="background: #10b981; color: white; border: none; padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600; display:inline-flex; align-items:center; gap:3px;" title="Restaurar cliente"><i data-lucide="plus" style="width:10px;height:10px;"></i> Incluir</button>`
                : `<button onclick="toggleExcludeClient('${c.id}')" style="background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; padding: 3px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; font-weight: 600; display:inline-flex; align-items:center; gap:3px;" title="Quitar de la ruta"><i data-lucide="x" style="width:10px;height:10px;"></i> Quitar</button>`
              }
              <span style="background: ${segmentColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">${segment}</span>
              ${!isExcluded && hasGps ? `<button onclick="openWazeToClient(${c.lat}, ${c.lng})" style="background: #33ccff; color: #000; border: none; padding: 2px 6px; border-radius: 4px; font-size: 9px; cursor: pointer; font-weight: 600; display:inline-flex; align-items:center; gap:2px;" title="Ir con Waze"><i data-lucide="navigation" style="width:10px;height:10px;"></i></button>` : !isExcluded ? `<button onclick="openEditLocationModal('${c.id}', '${(c.fantasy_name || c.name).replace(/'/g, "\\'")}', '${c.address || ''}')" style="background: #fbbf24; color: #78350f; border: none; padding: 2px 6px; border-radius: 4px; font-size: 9px; cursor: pointer;" title="Agregar ubicación">+ GPS</button>` : ''}
            </div>
          </div>
        </div>`;
      }).join('');

      if (sortedClients.length > 50) {
        listDiv.innerHTML += `<div style="padding: 8px; text-align: center; color: var(--text-muted); font-size: 12px;">... y ${sortedClients.length - 50} más</div>`;
      }
      lucide.createIcons();
    }

    function removeClientFromRoute(clientId, date) {
      if (!optimizedRouteData || !optimizedRouteData.days || !optimizedRouteData.days[date]) return;

      const dayData = optimizedRouteData.days[date];
      const removedClient = dayData.route.find(c => c.id === clientId);
      if (!removedClient) return;

      // Remove client from the day's route
      dayData.route = dayData.route.filter(c => c.id !== clientId);

      // Recalculate day stats
      recalcDayStats(dayData);

      // If day has no clients, remove the day
      if (dayData.route.length === 0) {
        delete optimizedRouteData.days[date];
      }

      // Recalculate total stats
      recalcTotalStats();

      // Also add to excluded so regeneration won't include this client
      excludedClientIds.add(clientId);

      // Refresh UI
      const exec = executives.find(e => e.id === selectedExecutiveId);
      const vendorName = exec ? exec.full_name : 'Vendedor';
      displayOptimizedRoute(vendorName, selectedZone);

      // Refresh step 3 list
      loadExecutiveClients();

      // Redraw map
      const remainingDays = Object.keys(optimizedRouteData.days).sort();
      if (remainingDays.length > 0) {
        if (!remainingDays.includes(selectedOptDay)) {
          selectedOptDay = remainingDays[0];
        }
        drawOptimizedRouteOnMap(selectedOptDay);
      }

      showToast('success', 'Cliente removido', `${removedClient.fantasy_name || removedClient.name} fue quitado de la ruta.`);
    }

    function moveClientToDay(clientId, fromDate, toDate) {
      if (!toDate || !optimizedRouteData?.days?.[fromDate] || !optimizedRouteData?.days?.[toDate]) return;

      const fromDay = optimizedRouteData.days[fromDate];
      const toDay = optimizedRouteData.days[toDate];
      const clientIdx = fromDay.route.findIndex(c => c.id === clientId);
      if (clientIdx === -1) return;

      // Move client
      const [client] = fromDay.route.splice(clientIdx, 1);
      toDay.route.push(client);

      // Recalc both days
      recalcDayStats(fromDay);
      recalcDayStats(toDay);

      // Remove empty day
      if (fromDay.route.length === 0) {
        delete optimizedRouteData.days[fromDate];
      }

      recalcTotalStats();

      // Refresh UI — stay on target day
      selectedOptDay = toDate;
      const exec = executives.find(e => e.id === selectedExecutiveId);
      const vendorName = exec ? exec.full_name : 'Vendedor';
      displayOptimizedRoute(vendorName, selectedZone);
      drawOptimizedRouteOnMap(toDate);

      const dayNames = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
      const dd = new Date(toDate + 'T12:00:00');
      showToast('success', 'Cliente movido', `${client.fantasy_name || client.name} → ${dayNames[dd.getDay()]} ${dd.getDate()}`);
    }

    function recalcDayStats(dayData) {
      const route = dayData.route;
      let totalDist = 0;
      const AVG_VISIT_MIN = 60;
      const AVG_SPEED = 30; // km/h

      for (let i = 1; i < route.length; i++) {
        const prev = route[i - 1];
        const curr = route[i];
        if (prev.lat && prev.lng && curr.lat && curr.lng) {
          totalDist += haversineDistanceFront(parseFloat(prev.lat), parseFloat(prev.lng), parseFloat(curr.lat), parseFloat(curr.lng));
        }
      }

      const distKm = Math.round(totalDist * 10) / 10;
      const travelMin = Math.round((totalDist / AVG_SPEED) * 60);
      const visitMin = route.length * AVG_VISIT_MIN;
      const totalMin = travelMin + visitMin;
      const liters = Math.round((distKm / 10) * 100) / 100;
      const cost = Math.round(liters * 1141);

      dayData.stats.totalClients = route.length;
      dayData.stats.distanceKm = distKm;
      dayData.stats.estimatedTime = totalMin;
      dayData.stats.litersUsed = liters;
      dayData.stats.costCLP = cost;
    }

    function recalcTotalStats() {
      const days = optimizedRouteData.days;
      const dayKeys = Object.keys(days);
      let totalClients = 0, totalDist = 0, totalTime = 0, totalLiters = 0, totalCost = 0;

      dayKeys.forEach(date => {
        const s = days[date].stats;
        totalClients += s.totalClients;
        totalDist += s.distanceKm;
        totalTime += s.estimatedTime;
        totalLiters += s.litersUsed;
        totalCost += s.costCLP;
      });

      if (!optimizedRouteData.totalStats) optimizedRouteData.totalStats = {};
      optimizedRouteData.totalStats.totalClients = totalClients;
      optimizedRouteData.totalStats.totalDays = dayKeys.length;
      optimizedRouteData.totalStats.distanceKm = Math.round(totalDist * 10) / 10;
      optimizedRouteData.totalStats.estimatedTime = totalTime;
      optimizedRouteData.totalStats.litersUsed = Math.round(totalLiters * 100) / 100;
      optimizedRouteData.totalStats.costCLP = Math.round(totalCost);
    }

    // Frontend haversine for recalculating distances
    function haversineDistanceFront(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function toggleExcludeClient(clientId) {
      if (excludedClientIds.has(clientId)) {
        excludedClientIds.delete(clientId);
      } else {
        excludedClientIds.add(clientId);
      }
      loadExecutiveClients();
    }

    function restoreAllClients() {
      excludedClientIds.clear();
      loadExecutiveClients();
    }

    // Modal para editar ubicación de cliente manualmente
    let editLocationMap = null;
    let editLocationMarker = null;
    let editingClientId = null;

    function openEditLocationModal(clientId, clientName, clientAddress) {
      editingClientId = clientId;

      const modal = document.createElement('div');
      modal.id = 'edit-location-modal';
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); z-index: 9999;
        display: flex; align-items: center; justify-content: center;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 24px; max-width: 600px; width: 95%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
          <h3 style="margin: 0 0 8px 0; color: #1e40af;"><i data-lucide="map-pin" style="width:16px;height:16px;display:inline-block;vertical-align:middle;"></i> Agregar Ubicación GPS</h3>
          <p style="margin: 0 0 4px 0; font-weight: 600; color: #1f2937;">${clientName}</p>
          <p style="margin: 0 0 16px 0; font-size: 12px; color: #6b7280;">${clientAddress || 'Sin dirección registrada'}</p>

          <div id="edit-location-map" style="height: 300px; border-radius: 12px; margin-bottom: 16px; background: #f3f4f6;"></div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div>
              <label style="font-size: 12px; color: #6b7280;">Latitud</label>
              <input type="number" step="0.000001" id="edit-lat" class="form-control" placeholder="-33.4569" style="font-size: 14px;">
            </div>
            <div>
              <label style="font-size: 12px; color: #6b7280;">Longitud</label>
              <input type="number" step="0.000001" id="edit-lng" class="form-control" placeholder="-70.6483" style="font-size: 14px;">
            </div>
          </div>

          <p style="font-size: 11px; color: #6b7280; margin-bottom: 16px;">
            <i data-lucide="lightbulb" style="width:12px;height:12px;color:#6b7280;display:inline-block;vertical-align:middle;"></i> Haz clic en el mapa para seleccionar la ubicación, o ingresa las coordenadas manualmente.
          </p>

          <div style="display: flex; gap: 12px;">
            <button onclick="closeEditLocationModal()" style="flex: 1; padding: 12px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; cursor: pointer;">Cancelar</button>
            <button onclick="saveClientLocation()" style="flex: 1; padding: 12px; border: none; background: #10b981; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Guardar Ubicación</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Initialize map after modal is in DOM
      setTimeout(() => {
        editLocationMap = L.map('edit-location-map').setView([-33.45, -70.65], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap'
        }).addTo(editLocationMap);

        // Add click handler
        editLocationMap.on('click', function(e) {
          const { lat, lng } = e.latlng;
          document.getElementById('edit-lat').value = lat.toFixed(6);
          document.getElementById('edit-lng').value = lng.toFixed(6);

          if (editLocationMarker) {
            editLocationMap.removeLayer(editLocationMarker);
          }
          editLocationMarker = L.marker([lat, lng]).addTo(editLocationMap);
        });
      }, 100);
    }

    function closeEditLocationModal() {
      const modal = document.getElementById('edit-location-modal');
      if (modal) {
        if (editLocationMap) {
          editLocationMap.remove();
          editLocationMap = null;
        }
        modal.remove();
      }
      editingClientId = null;
      editLocationMarker = null;
    }

    async function saveClientLocation() {
      const lat = parseFloat(document.getElementById('edit-lat').value);
      const lng = parseFloat(document.getElementById('edit-lng').value);

      if (isNaN(lat) || isNaN(lng)) {
        showToast('warning', 'Coordenadas inválidas', 'Ingresa latitud y longitud válidas');
        return;
      }

      // Validate Chile bounds
      if (lat < -56 || lat > -17 || lng < -76 || lng > -66) {
        showToast('warning', 'Fuera de Chile', 'Las coordenadas deben estar dentro de Chile');
        return;
      }

      try {
        const res = await fetch(`${API}/api/clients/${editingClientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat, lng })
        });

        const data = await res.json();
        if (data.success) {
          showToast('success', 'Ubicación guardada', 'El cliente ahora tiene coordenadas GPS');
          closeEditLocationModal();
          // Refresh data
          await loadData();
          loadExecutiveClients();
        } else {
          showToast('error', 'Error', data.error || 'No se pudo guardar');
        }
      } catch (error) {
        console.error('Error saving location:', error);
        showToast('error', 'Error', 'No se pudo guardar la ubicación');
      }
    }

    async function loadExecutiveRouteOnMap() {
      if (!selectedExecutiveId) {
        clearRouteFromMap();
        return;
      }

      // Find active route for this executive
      const execRoute = todayRoutesData.find(r => r.user_id === selectedExecutiveId && r.status === 'active');

      if (execRoute) {
        // Load full route with visits
        try {
          const res = await fetch(`${API}/api/daily-routes/${execRoute.id}`);
          const data = await res.json();
          if (data.success) {
            await displayRouteOnMap(data.data);
          }
        } catch (e) {
          console.error('Error loading route:', e);
        }
      } else {
        // Show assigned clients on map (all clients, function handles GPS check)
        clearRouteFromMap();
        const clients = allClients.filter(c => c.assigned_user_id === selectedExecutiveId);
        displayClientsOnRouteMap(clients);
      }
    }

    function displayClientsOnRouteMap(clients) {
      clearRouteFromMap();

      // Get legend/info element
      const legendEl = document.getElementById('route-legend');
      const infoEl = document.getElementById('route-info');

      if (!clients || clients.length === 0) {
        if (legendEl) {
          legendEl.style.display = 'block';
          infoEl.innerHTML = `
            <div style="text-align: center; padding: 10px; color: var(--text-muted);">
              <i data-lucide="user-x" style="width: 24px; height: 24px; margin-bottom: 8px;"></i>
              <div style="font-size: 12px;">Sin clientes asignados</div>
            </div>
          `;
          lucide.createIcons();
        }
        return;
      }

      // Separate clients with and without GPS
      const clientsWithGPS = clients.filter(c => c.lat && c.lng);
      const clientsWithoutGPS = clients.filter(c => !c.lat || !c.lng);

      // Show info in legend
      if (legendEl) {
        legendEl.style.display = 'block';
        let infoHtml = `<div style="font-size: 11px;">`;
        infoHtml += `<div style="margin-bottom: 6px;"><strong>${clients.length}</strong> clientes asignados</div>`;
        if (clientsWithGPS.length > 0) {
          infoHtml += `<div style="color: var(--success);"><i data-lucide="check" style="width:12px;height:12px;display:inline-block;vertical-align:middle;"></i> ${clientsWithGPS.length} con ubicación</div>`;
        }
        if (clientsWithoutGPS.length > 0) {
          infoHtml += `<div style="color: var(--warning);"><i data-lucide="alert-triangle" style="width:12px;height:12px;display:inline-block;vertical-align:middle;"></i> ${clientsWithoutGPS.length} dirección pendiente</div>`;
          infoHtml += `<div style="margin-top: 8px; font-size: 10px; color: var(--text-muted);">`;
          clientsWithoutGPS.slice(0, 5).forEach(c => {
            infoHtml += `<div>• ${c.fantasy_name || c.name}</div>`;
          });
          if (clientsWithoutGPS.length > 5) {
            infoHtml += `<div>... y ${clientsWithoutGPS.length - 5} más</div>`;
          }
          infoHtml += `</div>`;
        }
        infoHtml += `</div>`;
        infoEl.innerHTML = infoHtml;
      }

      if (clientsWithGPS.length === 0) return;

      const bounds = new google.maps.LatLngBounds();

      clientsWithGPS.forEach((client, index) => {
        const position = { lat: parseFloat(client.lat), lng: parseFloat(client.lng) };
        bounds.extend(position);

        const segCol = {A:'#d97706',B:'#3b82f6',C:'#059669',D:'#8b5cf6',E:'#9ca3af'}[client.segment] || '#9ca3af';
        const extId2 = client.external_id || '';
        const marker = new google.maps.Marker({
          position: position,
          map: routeMap,
          label: extId2 ? {
            text: extId2.length > 6 ? extId2.slice(-5) : extId2,
            color: 'white',
            fontSize: '8px',
            fontWeight: 'bold'
          } : undefined,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: segCol,
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 1.5,
            scale: extId2 ? 14 : 8
          },
          title: `${extId2} — ${client.fantasy_name || client.name}`
        });

        marker.addListener('click', () => {
          const sheetsBtn2 = window._sheetsUrl
            ? `<a href="${window._sheetsUrl}" target="_blank" rel="noopener"
                 style="display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:5px 10px;background:#16a34a;color:white;border-radius:6px;font-size:11px;font-weight:600;text-decoration:none;">
                 <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                 Editar en Sheets (${extId2})
               </a>`
            : '';
          routeInfoWindow.setContent(`
            <div style="min-width:210px;padding:8px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <strong style="font-size:13px;color:#1f2937;">${client.fantasy_name || client.name}</strong>
                <code style="font-size:10px;background:#6366f1;color:white;padding:2px 6px;border-radius:4px;">${extId2}</code>
              </div>
              <div style="font-size:11px;color:#6b7280;">${client.address || ''}, ${client.commune || ''}</div>
              <div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">
                ${client.segment ? `<span style="padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;background:${segCol}20;color:${segCol};">Seg ${client.segment}</span>` : ''}
                ${client.segmentation === '80-20' ? '<span style="background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;">⭐ 80/20</span>' : ''}
              </div>
              ${sheetsBtn2}
            </div>
          `);
          routeInfoWindow.open(routeMap, marker);
        });

        routeMarkers.push(marker);
      });

      if (clientsWithGPS.length > 0) {
        routeMap.fitBounds(bounds);
      }
    }

    function updateExecutiveStats() {
      const executives = allUsers.filter(u => u.role === 'executive');
      const activeRoutes = todayRoutesData.filter(r => r.status === 'active');
      const todayVisits = todayRoutesData.reduce((sum, r) => sum + (r.visits?.length || r.visits_count || 0), 0);
      const assignedClients = selectedExecutiveId
        ? allClients.filter(c => c.assigned_user_id === selectedExecutiveId).length
        : allClients.filter(c => c.assigned_user_id).length;

      document.getElementById('stat-total-executives').textContent = executives.length;
      document.getElementById('stat-active-routes').textContent = activeRoutes.length;
      document.getElementById('stat-today-visits').textContent = todayVisits;
      document.getElementById('stat-assigned-clients').textContent = assignedClients;
    }

    // =============================================
    // CLIENT ASSIGNMENT MODAL FUNCTIONS
    // =============================================

    let availableClientsForAssignment = [];
    let assignedClientsForModal = [];

    function openAssignClientsModal() {
      const modal = document.getElementById('modal-assign-clients');
      const execSelect = document.getElementById('assign-executive');
      const zoneFilter = document.getElementById('assign-zone-filter');

      // Populate executives
      const executives = allUsers.filter(u => u.role === 'executive');
      execSelect.innerHTML = '<option value="">-- Seleccionar vendedor --</option>' +
        executives.map(e => `<option value="${e.id}">${e.full_name}</option>`).join('');

      // Populate zones
      const zones = [...new Set(allClients.map(c => c.commune || c.zone).filter(Boolean))].sort();
      zoneFilter.innerHTML = '<option value="">-- Todas las zonas --</option>' +
        zones.map(z => `<option value="${z}">${z}</option>`).join('');

      // Pre-select current executive
      if (selectedExecutiveId) {
        execSelect.value = selectedExecutiveId;
        loadClientsForAssignment();
      }

      modal.style.display = 'flex';
      lucide.createIcons();
    }

    function closeAssignClientsModal() {
      document.getElementById('modal-assign-clients').style.display = 'none';
      // Refresh data
      loadExecutiveClients();
    }

    function loadClientsForAssignment() {
      const execId = document.getElementById('assign-executive').value;
      const availableDiv = document.getElementById('available-clients-list');
      const assignedDiv = document.getElementById('assigned-clients-list');

      if (!execId) {
        availableDiv.innerHTML = '<div class="empty-state" style="padding: 20px;"><p style="font-size: 12px;">Selecciona un vendedor</p></div>';
        assignedDiv.innerHTML = '<div class="empty-state" style="padding: 20px;"><p style="font-size: 12px;">Sin clientes asignados</p></div>';
        return;
      }

      // Get assigned and available clients
      assignedClientsForModal = allClients.filter(c => c.assigned_user_id === execId);
      availableClientsForAssignment = allClients.filter(c => !c.assigned_user_id || c.assigned_user_id !== execId);

      renderAvailableClients();
      renderAssignedClients();
    }

    function renderAvailableClients() {
      const div = document.getElementById('available-clients-list');
      const search = document.getElementById('search-available').value.toLowerCase();
      const zoneFilter = document.getElementById('assign-zone-filter').value;
      const countEl = document.getElementById('available-count');

      let filtered = availableClientsForAssignment;

      // Filter by zone
      if (zoneFilter) {
        filtered = filtered.filter(c => (c.commune || c.zone) === zoneFilter);
      }

      // Filter by search
      if (search.length >= 2) {
        filtered = filtered.filter(c =>
          (c.external_id && c.external_id.toLowerCase().includes(search)) ||
          (c.name && c.name.toLowerCase().includes(search)) ||
          (c.fantasy_name && c.fantasy_name.toLowerCase().includes(search)) ||
          (c.commune && c.commune.toLowerCase().includes(search))
        );
      }

      // Update count
      if (countEl) countEl.textContent = `(${filtered.length})`;

      // Limit display
      const displayFiltered = filtered.slice(0, 150);

      if (displayFiltered.length === 0) {
        div.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 12px;">No hay clientes disponibles</div>';
        return;
      }

      div.innerHTML = displayFiltered.map(c => `
        <label style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s;" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">
          <input type="checkbox" class="available-client-cb" value="${c.id}" style="width: 16px; height: 16px;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.fantasy_name || c.name}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${c.external_id} &bull; ${c.commune || c.zone || 'Sin zona'}</div>
          </div>
        </label>
      `).join('');
    }

    function renderAssignedClients() {
      const div = document.getElementById('assigned-clients-list');
      const search = document.getElementById('search-assigned').value.toLowerCase();

      let filtered = assignedClientsForModal;
      if (search.length >= 2) {
        filtered = filtered.filter(c =>
          (c.external_id && c.external_id.toLowerCase().includes(search)) ||
          (c.name && c.name.toLowerCase().includes(search)) ||
          (c.fantasy_name && c.fantasy_name.toLowerCase().includes(search))
        );
      }

      document.getElementById('assigned-count').textContent = `(${assignedClientsForModal.length})`;

      if (filtered.length === 0) {
        div.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted); font-size: 12px;">Sin clientes asignados</div>';
        return;
      }

      div.innerHTML = filtered.map(c => `
        <label style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s;" onmouseenter="this.style.background='var(--bg-hover)'" onmouseleave="this.style.background='transparent'">
          <input type="checkbox" class="assigned-client-cb" value="${c.id}" style="width: 16px; height: 16px;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.fantasy_name || c.name}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${c.external_id} &bull; ${c.commune || c.zone || 'Sin zona'}</div>
          </div>
        </label>
      `).join('');
    }

    function filterAvailableClients() {
      renderAvailableClients();
    }

    function filterAssignedClients() {
      renderAssignedClients();
    }

    async function assignSelectedClients() {
      const execId = document.getElementById('assign-executive').value;
      if (!execId) return;

      const checkboxes = document.querySelectorAll('.available-client-cb:checked');
      if (checkboxes.length === 0) {
        showToast('warning', 'Atención', 'Selecciona al menos un cliente');
        return;
      }

      const clientIds = Array.from(checkboxes).map(cb => cb.value);

      showToast('info', 'Procesando', `Asignando ${clientIds.length} clientes...`);

      let success = 0;
      for (const clientId of clientIds) {
        try {
          await fetch(`${API}/api/clients/${clientId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assigned_user_id: execId })
          });
          success++;

          // Update local data
          const client = allClients.find(c => c.id === clientId);
          if (client) client.assigned_user_id = execId;
        } catch (e) {
          console.error('Error assigning client:', e);
        }
      }

      showToast('success', 'Completado', `${success} clientes asignados`);
      loadClientsForAssignment();
      updateExecutiveStats();
      // Also update main list if the same executive is selected
      if (selectedExecutiveId === execId) {
        loadExecutiveClients();
      }
    }

    async function unassignSelectedClients() {
      const checkboxes = document.querySelectorAll('.assigned-client-cb:checked');
      if (checkboxes.length === 0) {
        showToast('warning', 'Atención', 'Selecciona al menos un cliente');
        return;
      }

      const clientIds = Array.from(checkboxes).map(cb => cb.value);

      showToast('info', 'Procesando', `Quitando ${clientIds.length} clientes...`);

      let success = 0;
      for (const clientId of clientIds) {
        try {
          await fetch(`${API}/api/clients/${clientId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assigned_user_id: null })
          });
          success++;

          // Update local data
          const client = allClients.find(c => c.id === clientId);
          if (client) client.assigned_user_id = null;
        } catch (e) {
          console.error('Error unassigning client:', e);
        }
      }

      showToast('success', 'Completado', `${success} clientes desasignados`);
      loadClientsForAssignment();
      updateExecutiveStats();
      // Also update main list
      loadExecutiveClients();
    }

    function getBadgeColor(status) {
      const colors = {
        'sale': 'success',
        'visited': 'success',
        'current': 'primary',
        'no_stock': 'warning',
        'not_interested': 'danger',
        'pending': 'secondary'
      };
      return colors[status] || 'secondary';
    }

    function updateRouteLegend(route) {
      const info = document.getElementById('route-info');
      const visits = route.visits || [];
      const clients = visits.map(v => v.client).filter(c => c);

      const completed = visits.filter(v => v.check_out).length;
      const inProgress = visits.filter(v => v.check_in && !v.check_out).length;
      const pending = visits.length - completed - inProgress;
      const sales = visits.filter(v => v.outcome === 'sale').length;

      // Calculate route metrics (use Directions data if available)
      const metrics = calculateRouteMetrics(clients, route.vehicle, route._directionsMetrics);
      const sourceLabel = metrics.source === 'directions'
        ? '<span style="font-size: 9px; color: #10b981;">&#10003; Ruta real</span>'
        : '<span style="font-size: 9px; color: #f59e0b;">~ Estimado</span>';

      info.innerHTML = `
        <div style="margin-bottom: 8px;">
          <strong>${route.user?.full_name || 'Vendedor'}</strong><br>
          <span style="font-size: 12px; color: var(--text-muted);">${route.vehicle?.license_plate || ''} - ${route.date}</span>
        </div>
        <div class="legend-item"><div class="legend-dot visited"></div> Completadas: ${completed}</div>
        <div class="legend-item"><div class="legend-dot current"></div> En curso: ${inProgress}</div>
        <div class="legend-item"><div class="legend-dot pending"></div> Pendientes: ${pending}</div>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
          <span style="color: var(--success); font-weight: 600;">Ventas: ${sales}</span>
        </div>
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; font-size: 11px; text-align: center;">
          <div>
            <div style="font-weight: 600; color: var(--primary);">${metrics.distance} km</div>
            <div style="color: var(--text-muted); font-size: 9px;">Distancia</div>
          </div>
          <div>
            <div style="font-weight: 600; color: var(--warning);">${formatDuration(metrics.duration)}</div>
            <div style="color: var(--text-muted); font-size: 9px;">Duración</div>
          </div>
          <div>
            <div style="font-weight: 600; color: var(--danger);">$${metrics.fuelCost.toLocaleString()}</div>
            <div style="color: var(--text-muted); font-size: 9px;">Bencina</div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 4px;">${sourceLabel}</div>
        <div style="display: flex; gap: 6px; margin-top: 8px;">
          <button onclick="openFullRouteInMaps()" style="flex: 1; padding: 8px; background: #4285f4; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px;">
            <i data-lucide="map-pin" style="width:13px;height:13px;"></i> Ruta Maps
          </button>
          <button onclick="openWazeNextPending()" style="flex: 1; padding: 8px; background: #33ccff; color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 4px;">
            <i data-lucide="navigation" style="width:13px;height:13px;"></i> Waze
          </button>
        </div>
      `;
    }

    function openWazeNextPending() {
      // If optimized route exists, navigate to first client
      if (optimizedRouteData && optimizedRouteData.route.length > 0) {
        const first = optimizedRouteData.route[0];
        if (first.lat && first.lng) {
          window.open(`https://waze.com/ul?ll=${first.lat},${first.lng}&navigate=yes`, '_blank');
          return;
        }
      }
      // Otherwise use first route marker
      if (routeMarkers.length > 0) {
        const pos = routeMarkers[0].getPosition();
        window.open(`https://waze.com/ul?ll=${pos.lat()},${pos.lng()}&navigate=yes`, '_blank');
        return;
      }
      showToast('warning', 'Sin destino', 'No hay puntos de ruta para navegar');
    }

    function openFullRouteInMaps(clientsOverride) {
      let clients = clientsOverride || [];

      if (clients.length === 0 && optimizedRouteData) {
        // If multi-day and a day is selected, use that day's clients
        if (selectedOptDay && optimizedRouteData.days && optimizedRouteData.days[selectedOptDay]) {
          clients = optimizedRouteData.days[selectedOptDay].route || [];
        } else {
          clients = optimizedRouteData.route || [];
        }
      }

      // Filter only clients with valid coordinates
      const validClients = clients.filter(c => c.lat && c.lng);

      if (validClients.length === 0) {
        showToast('warning', 'Sin coordenadas', 'No hay clientes con GPS para abrir la ruta');
        return;
      }

      // Google Maps Directions URL: /dir/lat1,lng1/lat2,lng2/...
      // Limit to ~25 waypoints (Google Maps limit)
      const waypoints = validClients.slice(0, 25);
      const coords = waypoints.map(c => `${c.lat},${c.lng}`).join('/');
      const url = `https://www.google.com/maps/dir/${coords}`;
      window.open(url, '_blank');
    }

    function openWazeToClient(lat, lng) {
      if (lat && lng) {
        window.open(`https://waze.com/ul?ll=${lat},${lng}&navigate=yes`, '_blank');
      }
    }

    // Quick check-in from route card: switch to visits tab + pre-select client
    async function goToCheckinClient(clientId) {
      document.querySelector('[data-tab=visits]').click();
      await new Promise(r => setTimeout(r, 200));
      // For exec: if no active route but has scheduled, auto-start day first
      if (currentUser && currentUser.role === 'executive') {
        const execId = currentUser.id;
        const activeRoute = todayRoutesData.find(r => r.user_id === execId && r.status === 'active');
        const scheduledClients = todayScheduledData[execId] || [];
        if (!activeRoute && scheduledClients.length > 0) {
          await startDayFromVisits(execId);
          await new Promise(r => setTimeout(r, 300));
        }
      }
      selectCheckinClient(clientId);
      const form = document.getElementById('form-checkin');
      if (form) form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Start day directly from exec dashboard (no navigation needed)
    async function startDayFromDashboard() {
      if (!currentUser) return;
      const btn = document.getElementById('exec-start-day-btn');
      if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width:14px;height:14px;vertical-align:-2px;"></i> Iniciando...'; lucide.createIcons(); }
      await startDayFromVisits(currentUser.id);
      // After starting, re-render exec dashboard to show active route
      renderExecDashboard();
    }

    // Open exec's today route in Google Maps
    function openExecRouteMaps() {
      if (!currentUser) return;
      const scheduled = todayScheduledData[currentUser.id] || [];
      const clients = scheduled.map(s => allClients.find(c => c.id === s.client_id)).filter(c => c && c.lat && c.lng);
      if (clients.length === 0) { showToast('warning', 'Sin GPS', 'Clientes sin coordenadas GPS'); return; }
      openFullRouteInMaps(clients);
    }

    function openDayRouteInMaps(date, userId) {
      if (!lastScheduleData || !lastScheduleData.schedule[date]) {
        showToast('warning', 'Sin datos', 'No hay datos de ruta para este día');
        return;
      }
      const dayClients = lastScheduleData.schedule[date].clients || [];
      openFullRouteInMaps(dayClients);
    }

    // Load Comparison
    async function loadComparison() {
      const productId = document.getElementById('compare-product').value;
      if (!productId) return;
      try {
        const res = await fetch(`${API}/intelligence/product/${productId}/comparison`);
        const data = await res.json();
        if (data.success) {
          renderComparison(data.data);
        }
      } catch (error) {
        console.error('Error loading comparison:', error);
      }
    }

    function renderComparison(data) {
      const container = document.getElementById('comparison-result');
      const lekerPrice = data.product.list_price;

      let html = `
        <div class="price-card">
          <div class="price-card-header">
            <span class="price-card-title">Precio LEKER</span>
          </div>
          <div class="price-value leker">$${lekerPrice.toLocaleString()}</div>
        </div>
      `;

      if (data.competitors.length === 0) {
        html += '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No hay precios de competidores registrados</p>';
      } else {
        data.competitors.forEach(c => {
          const diff = lekerPrice - c.detected_price;
          const diffPercent = ((diff / c.detected_price) * 100).toFixed(1);
          const diffClass = diff > 0 ? 'negative' : 'positive';
          const diffText = diff > 0 ? `+$${diff.toLocaleString()}` : `-$${Math.abs(diff).toLocaleString()}`;

          html += `
            <div class="price-card">
              <div class="price-card-header">
                <span class="price-card-title">${c.competitor.name}</span>
                <span class="price-diff ${diffClass}">${diffText}</span>
              </div>
              <div class="price-value">$${c.detected_price.toLocaleString()}</div>
            </div>
          `;
        });
      }

      container.innerHTML = html;
    }

    function getInitials(name) {
      if (!name) return '??';
      const parts = name.trim().split(/[\s.]+/).filter(p => p.length > 0);
      if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
      return parts.slice(0, 2).map(p => p[0].toUpperCase()).join('');
    }

    function normalizeName(n) {
      if (!n) return '';
      return n.toLowerCase().replace(/\./g, ' ').replace(/\s+/g, ' ').trim();
    }

    function findVendedorData(fullName) {
      if (!fullName) return null;
      const norm = normalizeName(fullName);
      return (gsheetsVendedoresParsed || []).find(v => v.name && normalizeName(v.name) === norm) ||
             (gsheetsVendedoresParsed || []).find(v => v.name && (normalizeName(v.name).includes(norm) || norm.includes(normalizeName(v.name)))) ||
             null;
    }

    function renderExecutivesPanel(routes) {
      const container = document.getElementById('executives-panel');
      if (!container) return;
      const countBadge = document.getElementById('executives-count-badge');
      const execUsers = allUsers.filter(u => u.role === 'executive' || u.role === 'supervisor');

      // Update the badge with count
      if (countBadge) {
        countBadge.textContent = execUsers.length;
      }

      if (execUsers.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 24px;">
            <i data-lucide="user-x" style="width: 48px; height: 48px;"></i>
            <p>No hay vendedores registrados</p>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      // Enrich with Google Sheets zone data
      const enriched = execUsers.map(exec => {
        const gsData = findVendedorData(exec.full_name);
        return { ...exec, _zona: gsData ? gsData.zona : '', _isZonal: gsData ? gsData.isZonal : false, _zonal: gsData ? gsData.zonal : '', _mail: gsData ? gsData.mail : exec.email, _cel: gsData ? gsData.cel : '' };
      });

      // Group by zone using Google Sheets data
      const ZONE_ORDER = ['Zona Norte', 'Zona Centro', 'Zona Centro Sur', 'Zona Sur', 'Sin Zona'];
      const zoneGroups = {};
      enriched.forEach(exec => {
        const zone = exec._zona || 'Sin Zona';
        if (!zoneGroups[zone]) zoneGroups[zone] = [];
        zoneGroups[zone].push(exec);
      });

      let html = '';
      const sortedZones = ZONE_ORDER.filter(z => zoneGroups[z]);
      Object.keys(zoneGroups).forEach(z => { if (!sortedZones.includes(z)) sortedZones.push(z); });

      sortedZones.forEach(zone => {
        const zoneExecs = zoneGroups[zone];
        const zonal = zoneExecs.find(e => e._isZonal);
        const zc = ZONE_COLORS[(zone || '').toLowerCase()] || { bg: 'var(--bg-hover)', color: '#6b7280', border: 'var(--border)' };
        const zoneColor = zc.color;

        html += `
          <div style="padding: 8px 16px; background: ${zc.bg}; border-left: 3px solid ${zoneColor}; margin: 4px 0; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 700; font-size: 12px; color: ${zoneColor}; text-transform: uppercase; letter-spacing: 0.5px;">
              ${zone}
            </div>
            <div style="font-size: 11px; color: var(--text-muted);">
              ${zonal ? `Zonal: ${zonal.full_name}` : ''} &middot; ${zoneExecs.length} vendedores
            </div>
          </div>
        `;

        zoneExecs.forEach(exec => {
          const initials = getInitials(exec.full_name);
          const activeRoute = routes?.find(r => r.user_id === exec.id && r.status === 'active');
          const assignedClients = allClients.filter(c => c.assigned_user_id === exec.id).length;
          const isActive = exec.status !== 'inactive';
          const hasRoute = !!activeRoute;

          html += `
            <div class="executive-item" data-exec-id="${exec.id}">
              <div class="executive-header" onclick="toggleExecutiveDetails('${exec.id}')">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div class="executive-avatar" style="background: ${hasRoute ? '#059669' : exec._isZonal ? zoneColor : isActive ? '#1e40af' : '#6b7280'};">
                    ${initials}
                  </div>
                  <div>
                    <div style="font-weight: 600; font-size: 14px;">
                      ${exec.full_name}
                      ${exec._isZonal ? '<span style="font-size: 9px; background: ' + zoneColor + '; color: white; padding: 1px 6px; border-radius: 4px; margin-left: 6px;">ZONAL</span>' : ''}
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">${exec._mail || exec.email}</div>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="badge badge-primary" style="font-size: 10px; cursor: pointer;" onclick="event.stopPropagation(); toggleVendorClients('${exec.id}')">${assignedClients} clientes</span>
                  ${hasRoute ? '<span class="badge badge-success" style="font-size: 10px;">En Ruta</span>' : ''}
                  <span class="badge ${isActive ? 'badge-primary' : 'badge-secondary'}" style="font-size: 10px;">${isActive ? 'Activo' : 'Inactivo'}</span>
                  <i data-lucide="chevron-down" class="exec-chevron" style="width: 16px; height: 16px; color: var(--text-muted); transition: transform 0.2s;"></i>
                </div>
              </div>
              <div class="executive-details" id="exec-details-${exec.id}" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                  <div style="text-align: center; padding: 8px; background: var(--bg-hover); border-radius: 6px;">
                    <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${assignedClients}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">Clientes</div>
                  </div>
                  <div style="text-align: center; padding: 8px; background: var(--bg-hover); border-radius: 6px;">
                    <div style="font-size: 18px; font-weight: 700; color: ${hasRoute ? 'var(--success)' : 'var(--text-muted)'};">${hasRoute ? activeRoute.visits_count || 0 : '-'}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">Visitas Hoy</div>
                  </div>
                  <div style="text-align: center; padding: 8px; background: var(--bg-hover); border-radius: 6px;">
                    <div style="font-size: 18px; font-weight: 700; color: var(--warning);">${hasRoute ? (activeRoute.vehicle?.license_plate || '-') : '-'}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">Vehículo</div>
                  </div>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                  <button class="btn btn-secondary" onclick="toggleVendorClients('${exec.id}')" style="flex: 1; padding: 8px; font-size: 11px;">
                    <i data-lucide="list" style="width: 14px; height: 14px;"></i> Ver Clientes (${assignedClients})
                  </button>
                  <button class="btn btn-secondary" onclick="goToExecutiveRoutes('${exec.id}')" style="flex: 1; padding: 8px; font-size: 11px;">
                    <i data-lucide="route" style="width: 14px; height: 14px;"></i> Ver Rutas
                  </button>
                  <button class="btn btn-primary" onclick="goToAssignClients('${exec.id}')" style="flex: 1; padding: 8px; font-size: 11px;">
                    <i data-lucide="user-plus" style="width: 14px; height: 14px;"></i> Asignar
                  </button>
                  <button class="btn ${isActive ? 'btn-danger' : 'btn-success'}" onclick="toggleExecutiveStatus('${exec.id}', ${isActive})" style="padding: 8px; font-size: 11px;">
                    <i data-lucide="${isActive ? 'user-minus' : 'user-check'}" style="width: 14px; height: 14px;"></i>
                  </button>
                </div>
                <div id="vendor-clients-${exec.id}" style="display: none;"></div>
              </div>
            </div>
          `;
        });
      });

      container.innerHTML = html;
      lucide.createIcons();
    }

    let executivesCardOpen = true; // Start expanded
    function toggleExecutivesCard() {
      const body = document.getElementById('executives-body');
      const chevron = document.getElementById('executives-chevron');

      executivesCardOpen = !executivesCardOpen;

      if (executivesCardOpen) {
        body.style.display = 'block';
        chevron.style.transform = 'rotate(0deg)';
      } else {
        body.style.display = 'none';
        chevron.style.transform = 'rotate(-90deg)';
      }
    }

    // Initialize chevron rotation on load (expanded by default)
    document.addEventListener('DOMContentLoaded', () => {
      const chevron = document.getElementById('executives-chevron');
      if (chevron) chevron.style.transform = 'rotate(0deg)';
    });

    function toggleExecutiveDetails(execId) {
      const details = document.getElementById(`exec-details-${execId}`);
      const item = details.closest('.executive-item');
      const chevron = item.querySelector('.exec-chevron');

      if (details.style.display === 'none') {
        // Close all other details first
        document.querySelectorAll('.executive-details').forEach(d => {
          d.style.display = 'none';
          d.closest('.executive-item')?.querySelector('.exec-chevron')?.style.setProperty('transform', 'rotate(0deg)');
        });
        details.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        details.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
      }
      lucide.createIcons();
    }

    // Toggle vendor's client list (expandable)
    async function toggleVendorClients(userId) {
      const container = document.getElementById(`vendor-clients-${userId}`);
      if (!container) return;

      if (container.style.display !== 'none' && container.innerHTML !== '') {
        container.style.display = 'none';
        return;
      }

      container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">Cargando clientes...</div>';
      container.style.display = 'block';

      try {
        const res = await fetch(`${API}/api/users/${userId}/clients`);
        const result = await res.json();

        if (!result.success || !result.data || result.data.length === 0) {
          container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">Sin clientes asignados</div>';
          return;
        }

        const clients = result.data;
        let html = `
          <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
            <div style="padding: 8px 12px; background: var(--bg-hover); font-size: 11px; font-weight: 600; display: flex; justify-content: space-between;">
              <span>${clients.length} clientes asignados</span>
              <button class="btn btn-secondary" onclick="openReassignFromVendor('${userId}')" style="padding: 2px 8px; font-size: 10px;">
                <i data-lucide="arrow-left-right" style="width: 10px; height: 10px;"></i> Reasignar
              </button>
            </div>
            <div style="max-height: 250px; overflow-y: auto;">
        `;

        clients.forEach(c => {
          const segColors = { 'A': '#d97706', 'B': '#3b82f6', 'C': '#059669', 'D': '#f97316', 'E': '#9ca3af' };
          html += `
            <div style="padding: 6px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 600; color: var(--text-muted); font-size: 10px; min-width: 55px;">${c.external_id || '-'}</span>
                <span style="font-weight: 500;">${c.fantasy_name || c.name}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 10px; color: var(--text-muted);">${c.commune || ''}</span>
                <span style="font-size: 9px; font-weight: 700; color: ${segColors[c.segment] || '#6b7280'}; background: ${segColors[c.segment] || '#6b7280'}20; padding: 1px 6px; border-radius: 4px;">${c.segment || '-'}</span>
              </div>
            </div>
          `;
        });

        html += '</div></div>';
        container.innerHTML = html;
        lucide.createIcons();
      } catch (e) {
        container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--danger); font-size: 12px;">Error al cargar clientes</div>';
      }
    }

    function openReassignFromVendor(userId) {
      openReassignModal();
      setTimeout(() => {
        document.getElementById('reassign-from').value = userId;
        updateReassignPreview();
      }, 100);
    }

    function showPanel(tabName) {
      // Find direct nav item or first subitem for this tab
      const navItem = document.querySelector(`.nav-item:not(.nav-item-parent)[data-tab="${tabName}"]`);
      if (navItem) {
        navItem.click();
      } else {
        // Try clicking the first subitem of this tab (for expandable menus)
        const subItem = document.querySelector(`.nav-subitem[data-tab="${tabName}"]`);
        if (subItem) {
          subItem.click();
        } else {
          // Final fallback
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          document.querySelectorAll('.nav-subitem').forEach(i => i.classList.remove('active'));
          document.querySelectorAll('.nav-item-expandable').forEach(i => i.classList.remove('has-active-child'));
          document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
          const panel = document.getElementById(`panel-${tabName}`);
          if (panel) panel.classList.add('active');
        }

        const titles = {
          dashboard: 'Dashboard',
          routes: 'Rutas y Mapa',
          visits: 'Gestión de Visitas',
          crm: 'Logística CRM',
          intelligence: 'Inteligencia de Mercado',
          data: 'Datos del Sistema',
          marketing: 'Marketing Digital',
          gsheets: 'Datos Comerciales',
          users: 'Usuarios y Roles'
        };
        document.getElementById('page-title').textContent = titles[tabName] || 'Dashboard';
      }
    }

    function goToExecutiveRoutes(execId) {
      // Switch to Routes panel and select executive
      showPanel('routes');
      setTimeout(() => {
        selectExecutive(execId);
      }, 100);
    }

    function goToAssignClients(execId) {
      // Switch to Routes panel, select executive and open assign modal
      showPanel('routes');
      setTimeout(() => {
        selectExecutive(execId);
        setTimeout(() => openAssignClientsModal(), 200);
      }, 100);
    }

    async function toggleExecutiveStatus(execId, currentlyActive) {
      const newStatus = currentlyActive ? 'inactive' : 'active';
      const action = currentlyActive ? 'desactivar' : 'activar';

      if (!confirm(`¿Estás seguro de ${action} este vendedor?`)) return;

      try {
        // Update user status (we'll add a status field)
        const exec = allUsers.find(u => u.id === execId);
        if (exec) {
          exec.status = newStatus;
          renderExecutivesPanel(todayRoutesData);
          showToast('success', 'Actualizado', `Vendedor ${newStatus === 'active' ? 'activado' : 'desactivado'}`);
        }
      } catch (e) {
        console.error('Error toggling status:', e);
        showToast('error', 'Error', 'No se pudo actualizar el estado');
      }
    }

    // Toggle expand/collapse executives list
    let executivesExpanded = false;
    function toggleExpandExecutives() {
      const panel = document.getElementById('executives-panel');
      const link = document.getElementById('toggle-executives-link');
      if (!panel || !link) return;
      executivesExpanded = !executivesExpanded;
      if (executivesExpanded) {
        panel.style.maxHeight = 'none';
        link.textContent = 'Colapsar vendedores ↑';
      } else {
        panel.style.maxHeight = '300px';
        link.textContent = 'Ver todos los vendedores ↓';
      }
    }

    // Reassign clients modal
    function openReassignModal() {
      const modal = document.getElementById('modal-reassign');
      const fromSelect = document.getElementById('reassign-from');
      const toSelect = document.getElementById('reassign-to');
      const executives = allUsers.filter(u => u.role === 'executive');

      const options = executives.map(e => {
        const clientCount = allClients.filter(c => c.assigned_user_id === e.id).length;
        return `<option value="${e.id}">${e.full_name} (${clientCount} clientes)</option>`;
      }).join('');

      fromSelect.innerHTML = '<option value="">Seleccionar vendedor origen...</option>' + options;
      toSelect.innerHTML = '<option value="">Seleccionar vendedor destino...</option>' + options;

      document.getElementById('reassign-preview').style.display = 'none';
      modal.style.display = 'flex';
      lucide.createIcons();
    }

    function closeReassignModal() {
      document.getElementById('modal-reassign').style.display = 'none';
    }

    async function updateReassignPreview() {
      const fromId = document.getElementById('reassign-from').value;
      const preview = document.getElementById('reassign-preview');
      const content = document.getElementById('reassign-preview-content');
      const clientList = document.getElementById('reassign-client-list');

      if (!fromId) {
        preview.style.display = 'none';
        return;
      }

      preview.style.display = 'block';
      clientList.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">Cargando clientes...</div>';

      try {
        const res = await fetch(`${API}/api/users/${fromId}/clients`);
        const result = await res.json();

        if (!result.success || !result.data || result.data.length === 0) {
          clientList.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">Sin clientes asignados</div>';
          content.innerHTML = '';
          return;
        }

        const clients = result.data;
        const segColors = { 'A': '#d97706', 'B': '#3b82f6', 'C': '#059669', 'D': '#f97316', 'E': '#9ca3af' };
        let html = '';
        clients.forEach(c => {
          html += `
            <label style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 12px;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
              <input type="checkbox" class="reassign-client-cb" value="${c.id}" checked onchange="updateReassignCount()" style="width: 14px; height: 14px;">
              <span style="font-weight: 600; color: var(--text-muted); font-size: 10px; min-width: 55px;">${c.external_id || '-'}</span>
              <span style="flex: 1; font-weight: 500;">${c.fantasy_name || c.name}</span>
              <span style="font-size: 10px; color: var(--text-muted);">${c.commune || ''}</span>
              <span style="font-size: 9px; font-weight: 700; color: ${segColors[c.segment] || '#6b7280'}; background: ${segColors[c.segment] || '#6b7280'}20; padding: 1px 6px; border-radius: 4px;">${c.segment || '-'}</span>
            </label>
          `;
        });

        clientList.innerHTML = html;
        document.getElementById('reassign-select-all').checked = true;
        updateReassignCount();

        const fromExec = allUsers.find(u => u.id === fromId);
        content.innerHTML = `<strong>${fromExec.full_name}</strong> tiene <strong>${clients.length}</strong> clientes asignados. Selecciona los que deseas transferir.`;
      } catch (e) {
        clientList.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--danger); font-size: 12px;">Error al cargar clientes</div>';
      }
    }

    function toggleReassignSelectAll(checked) {
      document.querySelectorAll('.reassign-client-cb').forEach(cb => cb.checked = checked);
      updateReassignCount();
    }

    function updateReassignCount() {
      const selected = document.querySelectorAll('.reassign-client-cb:checked').length;
      const total = document.querySelectorAll('.reassign-client-cb').length;
      document.getElementById('reassign-selected-count').textContent = `${selected}/${total} seleccionados`;
      document.getElementById('reassign-select-all').checked = selected === total;
    }

    async function executeReassign() {
      const fromId = document.getElementById('reassign-from').value;
      const toId = document.getElementById('reassign-to').value;

      if (!fromId || !toId) {
        showToast('warning', 'Campos requeridos', 'Selecciona vendedor origen y destino');
        return;
      }
      if (fromId === toId) {
        showToast('warning', 'Error', 'El vendedor origen y destino no pueden ser el mismo');
        return;
      }

      const selectedCbs = document.querySelectorAll('.reassign-client-cb:checked');
      const selectedClientIds = Array.from(selectedCbs).map(cb => cb.value);

      if (selectedClientIds.length === 0) {
        showToast('warning', 'Sin selección', 'Selecciona al menos un cliente para reasignar');
        return;
      }

      const fromExec = allUsers.find(u => u.id === fromId);
      const toExec = allUsers.find(u => u.id === toId);
      const allSelected = selectedClientIds.length === document.querySelectorAll('.reassign-client-cb').length;

      if (!confirm(`¿Reasignar ${selectedClientIds.length} cliente${selectedClientIds.length > 1 ? 's' : ''} de ${fromExec.full_name} a ${toExec.full_name}?\n\nEsta acción no se puede deshacer.`)) return;

      const btn = document.getElementById('btn-reassign');
      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px;"></i> Reasignando...';

      try {
        let response;
        if (allSelected) {
          // Use bulk reassign for all clients
          response = await fetch(`${API}/api/clients/reassign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fromUserId: fromId, toUserId: toId })
          });
        } else {
          // Use selective reassign
          response = await fetch(`${API}/api/clients/reassign-selected`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clientIds: selectedClientIds, toUserId: toId })
          });
        }
        const result = await response.json();

        if (result.success) {
          showToast('success', 'Reasignación completa', `${result.data.updated} clientes transferidos a ${toExec.full_name}`);
          closeReassignModal();
          await loadData();
        } else {
          showToast('error', 'Error', result.error || 'No se pudo reasignar');
        }
      } catch (e) {
        console.error('Error reassigning:', e);
        showToast('error', 'Error', 'Error de conexión al reasignar');
      }

      btn.disabled = false;
      btn.innerHTML = '<i data-lucide="arrow-left-right" style="width: 16px; height: 16px;"></i> Reasignar Seleccionados';
      lucide.createIcons();
    }

    // Render tables
    function renderClientsTable(data) {
      const tbody = document.querySelector('#table-clients tbody');
      const isAdmin = currentUser && currentUser.role === 'admin';
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 40px;">No hay clientes que coincidan</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(c => {
        const vendorName = c.assigned_user?.full_name || '-';
        const zoneName = c.zone || c.commune || '-';
        const currentSegment = c.segment || 'C';
        const isFoco = c.priority === 'FOCO';
        const clientSeg = c.segmentation || '';
        const segBadge = clientSeg === '80-20'
          ? `<span title="80/20 Clave" style="font-size:9px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:1px 5px;border-radius:4px;">80/20</span>`
          : clientSeg === 'L'
            ? `<span title="Con ventas 2025" style="font-size:9px;font-weight:700;background:rgba(37,99,235,0.12);color:#2563eb;border:1px solid rgba(37,99,235,0.3);padding:1px 5px;border-radius:4px;">L</span>`
            : '';
        const addrStatus = c.address_status || (c.lat && c.lng ? 'auto' : 'pending');
        const addrDot = addrStatus === 'confirmed'
          ? '<span title="Dirección confirmada" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#10b981;margin-right:4px;vertical-align:middle;"></span>'
          : addrStatus === 'pending'
            ? '<span title="Dirección pendiente" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#f59e0b;margin-right:4px;vertical-align:middle;"></span>'
            : '';
        // Address column with audit tooltip (admin only)
        const addrText = c.address ? (c.address.length > 30 ? c.address.substring(0, 30) + '...' : c.address) : '-';
        let addrAuditTooltip = '';
        if (isAdmin && c.address_updated_at) {
          const updaterUser = c.address_updated_by ? allUsers.find(u => u.id === c.address_updated_by) : null;
          const updater = updaterUser ? updaterUser.full_name : 'sistema';
          const updDate = new Date(c.address_updated_at).toLocaleDateString('es-CL');
          addrAuditTooltip = ` title="Modificado: ${updDate} por ${updater}"`;
        }
        return `
          <tr>
            <td><code style="font-size: 11px; background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;">${c.external_id || '-'}</code></td>
            <td>
              <div style="font-weight: 500; display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">${addrDot}${c.fantasy_name || c.name || '-'} ${segBadge}</div>
              ${c.fantasy_name && c.name ? `<div style="font-size: 11px; color: var(--text-muted);">${c.name}</div>` : ''}
            </td>
            <td style="font-size: 12px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"${addrAuditTooltip}>
              ${addrDot}${addrText}${c.commune ? `<div style="font-size:10px;color:var(--text-muted);">${c.commune}</div>` : ''}
            </td>
            <td><span class="badge" style="background: var(--bg-hover); color: var(--text-secondary);">${zoneName}</span></td>
            <td style="font-size: 13px;">${vendorName}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 6px;">
                <select onchange="updateClientSegment('${c.id}', this.value)" class="form-control" style="width: 60px; padding: 4px 6px; font-size: 11px; font-weight: 600; border-radius: 4px; background: ${currentSegment === 'A' ? 'rgba(5,150,105,0.15)' : currentSegment === 'B' ? 'rgba(217,119,6,0.15)' : 'rgba(107,114,128,0.15)'}; color: ${currentSegment === 'A' ? '#059669' : currentSegment === 'B' ? '#d97706' : '#6b7280'}; border: 1px solid ${currentSegment === 'A' ? '#059669' : currentSegment === 'B' ? '#d97706' : '#9ca3af'};">
                  <option value="A" ${currentSegment === 'A' ? 'selected' : ''}>A</option>
                  <option value="B" ${currentSegment === 'B' ? 'selected' : ''}>B</option>
                  <option value="C" ${currentSegment === 'C' ? 'selected' : ''}>C</option>
                </select>
                <label style="display: flex; align-items: center; gap: 3px; cursor: pointer; font-size: 10px;" title="Cliente prioritario">
                  <input type="checkbox" ${isFoco ? 'checked' : ''} onchange="updateClientFoco('${c.id}', this.checked)" style="width: 14px; height: 14px;">
                  <span style="color: ${isFoco ? '#ef4444' : 'var(--text-muted)'}; font-weight: ${isFoco ? '600' : '400'};">FOCO</span>
                </label>
              </div>
            </td>
            <td>
              <div style="display: flex; gap: 4px;">
                <button class="btn-icon" onclick="openClientModal('${c.id}')" title="Editar">
                  <i data-lucide="pencil" style="width: 14px; height: 14px;"></i>
                </button>
                <button class="btn-icon" onclick="assignVendorQuick('${c.id}')" title="Asignar vendedor">
                  <i data-lucide="user-plus" style="width: 14px; height: 14px;"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update client segment
    async function updateClientSegment(clientId, segment) {
      try {
        const res = await fetch(`${API}/api/clients/${clientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ segment })
        });
        const data = await res.json();
        if (data.success) {
          const client = allClients.find(c => c.id === clientId);
          if (client) client.segment = segment;
          showToast('success', 'Actualizado', `Segmento cambiado a ${segment}`);
          renderClientsTablePaginated();
        }
      } catch (e) {
        showToast('error', 'Error', 'No se pudo actualizar el segmento');
      }
    }

    // Update client FOCO priority
    async function updateClientFoco(clientId, isFoco) {
      try {
        const res = await fetch(`${API}/api/clients/${clientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ priority: isFoco ? 'FOCO' : 'Normal' })
        });
        const data = await res.json();
        if (data.success) {
          const client = allClients.find(c => c.id === clientId);
          if (client) client.priority = isFoco ? 'FOCO' : 'Normal';
          showToast('success', 'Actualizado', isFoco ? 'Cliente marcado como FOCO' : 'Cliente desmarcado');
          renderClientsTablePaginated();
        }
      } catch (e) {
        showToast('error', 'Error', 'No se pudo actualizar');
      }
    }

    // Paginated clients render
    function renderClientsTablePaginated() {
      const totalPages = Math.ceil(filteredClients.length / CLIENTS_PER_PAGE);
      const start = (currentClientsPage - 1) * CLIENTS_PER_PAGE;
      const end = start + CLIENTS_PER_PAGE;
      const pageData = filteredClients.slice(start, end);

      renderClientsTable(pageData);

      // Update pagination info
      document.getElementById('clients-showing').textContent =
        `Mostrando ${start + 1}-${Math.min(end, filteredClients.length)} de ${filteredClients.length}`;
      document.getElementById('clients-page-info').textContent =
        `Página ${currentClientsPage} de ${totalPages || 1}`;
      document.getElementById('clients-count').textContent = filteredClients.length;

      // Update buttons
      document.getElementById('btn-prev-clients').disabled = currentClientsPage <= 1;
      document.getElementById('btn-next-clients').disabled = currentClientsPage >= totalPages;

      lucide.createIcons();
    }

    function prevClientsPage() {
      if (currentClientsPage > 1) {
        currentClientsPage--;
        renderClientsTablePaginated();
      }
    }

    function nextClientsPage() {
      const totalPages = Math.ceil(filteredClients.length / CLIENTS_PER_PAGE);
      if (currentClientsPage < totalPages) {
        currentClientsPage++;
        renderClientsTablePaginated();
      }
    }

    // Filter clients in check-in form
    function filterCheckinClients() {
      const search = document.getElementById('checkin-client-search').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('client-search-results');

      if (!allClients || allClients.length === 0) {
        resultsDiv.style.display = 'none';
        return;
      }

      if (search.length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }

      const filtered = allClients.filter(c => {
        const matchCode = c.external_id && c.external_id.toLowerCase().includes(search);
        const matchName = c.name && c.name.toLowerCase().includes(search);
        const matchFantasy = c.fantasy_name && c.fantasy_name.toLowerCase().includes(search);
        return matchCode || matchName || matchFantasy;
      }).slice(0, 20); // Limit to 20 results

      if (filtered.length === 0) {
        resultsDiv.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No se encontraron clientes</div>';
        resultsDiv.style.display = 'block';
        return;
      }

      resultsDiv.innerHTML = filtered.map(c => `
        <div class="client-search-item" onclick="selectCheckinClient('${c.id}')" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <div style="font-weight: 600; font-size: 13px;">${c.fantasy_name || c.name}</div>
              ${c.fantasy_name && c.name !== c.fantasy_name ? `<div style="font-size: 11px; color: var(--text-muted);">${c.name}</div>` : ''}
            </div>
            <code style="font-size: 11px; background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px;">${c.external_id}</code>
          </div>
          <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; font-size: 11px; color: var(--text-secondary); align-items: center;">
            <span><i data-lucide="map-pin" style="width: 10px; height: 10px; display: inline;"></i> ${c.commune || c.zone || 'Sin zona'}</span>
            <span class="badge badge-${(c.segment || 'c').toLowerCase()}" style="font-size: 10px; padding: 1px 6px;">${c.segment || 'C'}</span>
            ${c.segmentation === '80-20' ? '<span style="font-size:10px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:1px 6px;border-radius:4px;">⭐ 80/20</span>' : ''}
            ${c.priority === 'FOCO' ? '<span class="badge badge-foco" style="font-size: 10px; padding: 1px 6px;">FOCO</span>' : ''}
          </div>
        </div>
      `).join('');

      resultsDiv.style.display = 'block';
      lucide.createIcons();

      // Add hover effect
      resultsDiv.querySelectorAll('.client-search-item').forEach(item => {
        item.addEventListener('mouseenter', () => item.style.background = 'var(--bg-hover)');
        item.addEventListener('mouseleave', () => item.style.background = 'transparent');
      });
    }

    function selectCheckinClient(clientId) {
      const client = allClients.find(c => c.id === clientId);
      if (!client) return;

      // Set hidden input value
      document.getElementById('checkin-client').value = clientId;

      // Hide results
      document.getElementById('client-search-results').style.display = 'none';

      // Update search input
      document.getElementById('checkin-client-search').value = `${client.external_id} - ${client.fantasy_name || client.name}`;

      // Show selected client card
      const cardDiv = document.getElementById('selected-client-card');
      const addrStatus = client.address_status || (client.lat && client.lng ? 'auto' : 'pending');
      const addrBadge = addrStatus === 'confirmed'
        ? '<span style="display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;background:rgba(16,185,129,0.1);color:#10b981;padding:2px 8px;border-radius:10px;"><i data-lucide="check-circle" style="width:10px;height:10px;"></i> Confirmada</span>'
        : addrStatus === 'pending'
          ? '<span style="display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;background:rgba(245,158,11,0.1);color:#f59e0b;padding:2px 8px;border-radius:10px;"><i data-lucide="alert-circle" style="width:10px;height:10px;"></i> Pendiente</span>'
          : '<span style="display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;background:rgba(107,114,128,0.1);color:#6b7280;padding:2px 8px;border-radius:10px;">Auto</span>';
      const confirmBtn = addrStatus !== 'confirmed'
        ? `<button type="button" onclick="confirmClientAddressFromCheckin('${client.id}')" style="margin-top:6px;background:#10b981;color:white;border:none;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:4px;"><i data-lucide="map-pin-check" style="width:12px;height:12px;"></i> Confirmar Ubicación</button>`
        : '';
      cardDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <div style="font-weight: 600;">${client.fantasy_name || client.name}</div>
            ${client.fantasy_name && client.name !== client.fantasy_name ? `<div style="font-size: 12px; color: var(--text-muted);">${client.name}</div>` : ''}
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; display: flex; align-items: center; gap: 6px;">
              <span><i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i>
              ${client.address || 'Sin dirección'}, ${client.commune || ''}</span>
              ${addrBadge}
            </div>
            ${confirmBtn}
          </div>
          <div style="text-align: right;">
            <code style="font-size: 12px; background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px;">${client.external_id}</code>
            <div style="margin-top: 4px; display: flex; flex-direction: column; align-items: flex-end; gap: 3px;">
              <span class="badge badge-${(client.segment || 'c').toLowerCase()}">${client.segment || 'C'}</span>
              ${client.segmentation === '80-20' ? '<span style="font-size:10px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:2px 8px;border-radius:10px;">⭐ 80/20</span>' : ''}
              ${client.priority === 'FOCO' ? '<span class="badge badge-foco">FOCO</span>' : ''}
            </div>
          </div>
        </div>
        <button type="button" onclick="clearSelectedClient()" style="position: absolute; top: 8px; right: 8px; background: none; border: none; cursor: pointer; color: var(--text-muted);">
          <i data-lucide="x" style="width: 16px; height: 16px;"></i>
        </button>
      `;
      cardDiv.style.display = 'block';
      cardDiv.style.position = 'relative';
      lucide.createIcons();

      // Trigger address verification
      selectedClientData = client;
      onClientSelectChange();

      // Show checklist panel and load data
      loadChecklistForClient(clientId, client);
    }

    function clearSelectedClient() {
      document.getElementById('checkin-client').value = '';
      document.getElementById('checkin-client-search').value = '';
      document.getElementById('selected-client-card').style.display = 'none';
      document.getElementById('address-verification').style.display = 'none';
      document.getElementById('checklist-panel').style.display = 'none';
      document.getElementById('checklist-warning').style.display = 'none';
      document.getElementById('btn-checkin-submit').disabled = false;
      selectedClientData = null;
    }

    // Confirm client address from check-in (uses current GPS if available)
    async function confirmClientAddressFromCheckin(clientId) {
      const client = allClients.find(c => c.id === clientId);
      if (!client) return;

      const user = JSON.parse(localStorage.getItem('leker_user') || '{}');
      const body = { confirmedBy: user.id };

      // If we have current GPS position, use it
      if (navigator.geolocation) {
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000, enableHighAccuracy: true });
          });
          body.lat = pos.coords.latitude;
          body.lng = pos.coords.longitude;
        } catch (e) {
          // No GPS available, just confirm with existing coords
          if (client.lat && client.lng) {
            body.lat = client.lat;
            body.lng = client.lng;
          }
        }
      } else if (client.lat && client.lng) {
        body.lat = client.lat;
        body.lng = client.lng;
      }

      if (client.address) body.address = client.address;

      try {
        const res = await fetch(`${API}/api/clients/${clientId}/confirm-address`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
          // Update local allClients
          const idx = allClients.findIndex(c => c.id === clientId);
          if (idx !== -1) {
            allClients[idx].address_status = 'confirmed';
            allClients[idx].address_confirmed_at = new Date().toISOString();
            if (body.lat) allClients[idx].lat = body.lat;
            if (body.lng) allClients[idx].lng = body.lng;
          }
          showToast('success', 'Dirección confirmada', `${client.fantasy_name || client.name}`);
          // Re-render the selected client card
          selectCheckinClient(clientId);
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (e) {
        showToast('error', 'Error de conexión', e.message);
      }
    }

    // Marketing config functions
    function saveGaConfig() {
      const measurementId = document.getElementById('ga-measurement-id').value.trim();
      if (measurementId) {
        localStorage.setItem('ga_measurement_id', measurementId);
        showToast('success', 'Google Analytics', 'Configuración guardada: ' + measurementId);
      } else {
        showToast('warning', 'Campo vacío', 'Ingresa el Measurement ID');
      }
    }

    function saveGadsConfig() {
      const conversionId = document.getElementById('gads-conversion-id').value.trim();
      const conversionLabel = document.getElementById('gads-conversion-label').value.trim();
      if (conversionId) {
        localStorage.setItem('gads_conversion_id', conversionId);
        localStorage.setItem('gads_conversion_label', conversionLabel);
        showToast('success', 'Google Ads', 'Configuración guardada: ' + conversionId);
      } else {
        showToast('warning', 'Campo vacío', 'Ingresa el Conversion ID');
      }
    }

    function saveMetaConfig() {
      const pixelId = document.getElementById('meta-pixel-id').value.trim();
      if (pixelId) {
        localStorage.setItem('meta_pixel_id', pixelId);
        showToast('success', 'Meta Pixel', 'Configuración guardada: ' + pixelId);
      } else {
        showToast('warning', 'Campo vacío', 'Ingresa el Pixel ID');
      }
    }

    function loadMarketingConfig() {
      const gaId = localStorage.getItem('ga_measurement_id');
      const gadsId = localStorage.getItem('gads_conversion_id');
      const gadsLabel = localStorage.getItem('gads_conversion_label');
      const metaId = localStorage.getItem('meta_pixel_id');

      if (gaId) document.getElementById('ga-measurement-id').value = gaId;
      if (gadsId) document.getElementById('gads-conversion-id').value = gadsId;
      if (gadsLabel) document.getElementById('gads-conversion-label').value = gadsLabel;
      if (metaId) document.getElementById('meta-pixel-id').value = metaId;
    }

    // Filter functions
    function goToClientsBySegmentation(seg) {
      const subtab = document.querySelector('.nav-subitem[data-tab="data"][data-subtab="clientes"]');
      if (subtab) subtab.click();
      setTimeout(() => {
        document.getElementById('filter-segmentation').value = seg;
        document.getElementById('search-clients').value = '';
        document.getElementById('filter-zone').value = '';
        document.getElementById('filter-segment').value = '';
        document.getElementById('filter-priority').value = '';
        filterClients();
      }, 150);
    }

    function filterClients() {
      const search = document.getElementById('search-clients').value.toLowerCase();
      const zone = document.getElementById('filter-zone').value;
      const segment = document.getElementById('filter-segment').value;
      const segmentation = document.getElementById('filter-segmentation').value;
      const priority = document.getElementById('filter-priority').value;

      filteredClients = allClients.filter(c => {
        const matchSearch = !search ||
          (c.external_id && c.external_id.toLowerCase().includes(search)) ||
          (c.name && c.name.toLowerCase().includes(search)) ||
          (c.fantasy_name && c.fantasy_name.toLowerCase().includes(search));
        const matchZone = !zone || c.zone === zone || c.commune === zone;
        const matchSegment = !segment || c.segment === segment;
        const matchSegmentation = !segmentation || c.segmentation === segmentation;
        const matchPriority = !priority || c.priority === priority;
        return matchSearch && matchZone && matchSegment && matchSegmentation && matchPriority;
      });

      currentClientsPage = 1;
      renderClientsTablePaginated();
    }

    // Client Modal Functions
    function openClientModal(clientId = null) {
      const modal = document.getElementById('modal-client');
      const title = document.getElementById('modal-client-title');
      const vendorSelect = document.getElementById('client-vendor');

      // Populate vendor dropdown
      vendorSelect.innerHTML = '<option value="">Sin asignar</option>' +
        allUsers.filter(u => u.role === 'executive').map(u =>
          `<option value="${u.id}">${u.full_name}</option>`
        ).join('');

      const auditPanel = document.getElementById('client-audit-info');
      const isAdmin = currentUser && currentUser.role === 'admin';

      if (clientId) {
        // Edit mode
        const client = allClients.find(c => c.id === clientId);
        if (!client) return;

        title.textContent = 'Editar Cliente';
        document.getElementById('client-id').value = client.id;
        document.getElementById('client-code').value = client.external_id || '';
        document.getElementById('client-name').value = client.name || '';
        document.getElementById('client-fantasy').value = client.fantasy_name || '';
        document.getElementById('client-address').value = client.address || '';
        document.getElementById('client-commune').value = client.commune || '';
        document.getElementById('client-zone').value = client.zone || '';
        document.getElementById('client-segment').value = client.segment || 'C';
        document.getElementById('client-priority').value = client.priority || 'Normal';
        document.getElementById('client-vendor').value = client.assigned_user_id || '';
        document.getElementById('client-phone').value = client.phone || '';
        document.getElementById('client-email').value = client.email || '';
        document.getElementById('client-observations').value = client.observations || '';

        // Show audit info (admin only)
        if (isAdmin) {
          auditPanel.style.display = 'block';
          const addrStatus = client.address_status || (client.lat && client.lng ? 'auto' : 'pending');
          const statusLabels = { confirmed: 'Confirmada en terreno', auto: 'Auto (geocodificada)', pending: 'Pendiente de confirmación' };
          const statusColors = { confirmed: '#10b981', auto: '#6366f1', pending: '#f59e0b' };
          document.getElementById('client-audit-status').innerHTML =
            `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;background:${statusColors[addrStatus]}20;color:${statusColors[addrStatus]};font-weight:600;font-size:11px;">
              <span style="width:6px;height:6px;border-radius:50%;background:${statusColors[addrStatus]};"></span>
              ${statusLabels[addrStatus] || addrStatus}
            </span>`;
          if (client.address_updated_at) {
            const updDate = new Date(client.address_updated_at).toLocaleString('es-CL');
            const updaterUser = client.address_updated_by ? allUsers.find(u => u.id === client.address_updated_by) : null;
            const updaterName = updaterUser ? updaterUser.full_name : 'sistema';
            document.getElementById('client-audit-detail').innerHTML =
              `<span style="font-size:11px;">Modificado: <strong>${updDate}</strong> por <strong>${updaterName}</strong></span>`;
          } else {
            document.getElementById('client-audit-detail').innerHTML = '<span style="font-size:11px;">Sin modificaciones registradas</span>';
          }
        } else {
          auditPanel.style.display = 'none';
        }
      } else {
        // Create mode
        title.textContent = 'Nuevo Cliente';
        document.getElementById('client-id').value = '';
        document.getElementById('client-code').value = '';
        document.getElementById('client-name').value = '';
        document.getElementById('client-fantasy').value = '';
        document.getElementById('client-address').value = '';
        document.getElementById('client-commune').value = '';
        document.getElementById('client-zone').value = '';
        document.getElementById('client-segment').value = 'C';
        document.getElementById('client-priority').value = 'Normal';
        document.getElementById('client-vendor').value = '';
        document.getElementById('client-phone').value = '';
        document.getElementById('client-email').value = '';
        document.getElementById('client-observations').value = '';
        auditPanel.style.display = 'none';
      }

      // Load visit history async (edit mode only)
      const histDiv = document.getElementById('client-visit-history');
      const histBody = document.getElementById('client-visit-history-body');
      if (clientId && histDiv && histBody) {
        histDiv.style.display = 'block';
        histBody.innerHTML = '<div style="color:var(--text-muted);padding:6px 0;">Cargando historial...</div>';
        fetch(`${API}/api/clients/${clientId}/checklist-data`)
          .then(r => r.json())
          .then(res => {
            if (!res.success || !res.data.visitHistory || res.data.visitHistory.length === 0) {
              histBody.innerHTML = '<div style="color:var(--text-muted);padding:6px 0;">Sin visitas registradas</div>';
              return;
            }
            const OUTCOME_LABELS = { sale: '✅ Venta', contacted: '✔️ Contactado', no_contact: '❌ Sin contacto', postponed: '⏱️ Postergado' };
            histBody.innerHTML = res.data.visitHistory.slice(0, 5).map(v => {
              const dateStr = v.route?.date ? new Date(v.route.date + 'T00:00:00').toLocaleDateString('es-CL', { day: 'numeric', month: 'short' }) : '-';
              const vendorName = v.route?.user?.full_name || '-';
              const outcome = OUTCOME_LABELS[v.outcome] || v.outcome || '-';
              return `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);">
                <div>
                  <span style="font-weight:600;">${dateStr}</span>
                  <span style="color:var(--text-muted);margin-left:6px;font-size:11px;">${vendorName}</span>
                </div>
                <span style="font-size:11px;">${outcome}</span>
              </div>`;
            }).join('');
          })
          .catch(() => { histBody.innerHTML = '<div style="color:var(--text-muted);font-size:11px;">Error cargando historial</div>'; });
      } else if (histDiv) {
        histDiv.style.display = 'none';
      }

      modal.style.display = 'flex';
      lucide.createIcons();
    }

    function closeClientModal() {
      document.getElementById('modal-client').style.display = 'none';
    }

    async function saveClient() {
      const id = document.getElementById('client-id').value;
      const code = document.getElementById('client-code').value.trim();
      const name = document.getElementById('client-name').value.trim();

      if (!code || !name) {
        showToast('warning', 'Campos requeridos', 'Código y Razón Social son obligatorios');
        return;
      }

      const clientData = {
        external_id: code,
        name: name,
        fantasy_name: document.getElementById('client-fantasy').value.trim() || null,
        address: document.getElementById('client-address').value.trim() || null,
        commune: document.getElementById('client-commune').value.trim() || null,
        zone: document.getElementById('client-zone').value.trim() || null,
        segment: document.getElementById('client-segment').value,
        priority: document.getElementById('client-priority').value,
        assigned_user_id: document.getElementById('client-vendor').value || null,
        phone: document.getElementById('client-phone').value.trim() || null,
        email: document.getElementById('client-email').value.trim() || null,
        observations: document.getElementById('client-observations').value.trim() || null
      };

      try {
        const url = id ? `${API}/api/clients/${id}` : `${API}/api/clients`;
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(clientData)
        });

        const data = await res.json();

        if (data.success) {
          showToast('success', id ? 'Cliente actualizado' : 'Cliente creado', name);
          closeClientModal();
          loadData();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    }

    async function assignVendorQuick(clientId) {
      const client = allClients.find(c => c.id === clientId);
      if (!client) return;

      const executives = allUsers.filter(u => u.role === 'executive');
      const options = executives.map(u => `<option value="${u.id}" ${client.assigned_user_id === u.id ? 'selected' : ''}>${u.full_name}</option>`).join('');

      const select = document.createElement('select');
      select.innerHTML = `<option value="">Sin asignar</option>${options}`;
      select.className = 'form-control';
      select.style.cssText = 'width: 200px;';

      const result = await new Promise(resolve => {
        const modal = document.createElement('div');
        modal.innerHTML = `
          <div class="modal" style="display: flex;">
            <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
            <div class="modal-content" style="max-width: 350px;">
              <div class="modal-header">
                <h3>Asignar Vendedor</h3>
                <button class="btn-close" onclick="this.closest('.modal').remove()">&times;</button>
              </div>
              <div class="modal-body">
                <p style="margin-bottom: 12px; font-size: 13px; color: var(--text-muted);">${client.fantasy_name || client.name}</p>
                <div class="form-group">
                  <label>Vendedor</label>
                  <select id="quick-vendor" class="form-control">
                    <option value="">Sin asignar</option>
                    ${options}
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                <button class="btn btn-primary" id="btn-assign-confirm">Asignar</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        modal.querySelector('#btn-assign-confirm').onclick = async () => {
          const vendorId = modal.querySelector('#quick-vendor').value;
          modal.remove();

          try {
            const res = await fetch(`${API}/api/clients/${clientId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ assigned_user_id: vendorId || null })
            });

            const data = await res.json();
            if (data.success) {
              const vendorName = vendorId ? executives.find(u => u.id === vendorId)?.full_name : 'ninguno';
              showToast('success', 'Vendedor asignado', vendorName);
              loadData();
            } else {
              showToast('error', 'Error', data.error);
            }
          } catch (error) {
            showToast('error', 'Error', error.message);
          }
        };
      });
    }

    function populateZoneFilter() {
      const zones = [...new Set(allClients.map(c => c.zone || c.commune).filter(Boolean))].sort();
      const select = document.getElementById('filter-zone');
      select.innerHTML = '<option value="">Todas las zonas</option>';
      zones.forEach(zone => {
        select.innerHTML += `<option value="${zone}">${zone}</option>`;
      });
    }

    function filterUsers() {
      const search = document.getElementById('search-users').value.toLowerCase();
      const roleFilter = document.getElementById('filter-user-role')?.value || '';
      const zoneFilter = document.getElementById('filter-user-zone')?.value || '';

      let filtered = allUsers.filter(u => {
        // Exclude admin unless specifically filtering for admin role
        if (!roleFilter && u.role === 'admin') return false;
        return u.full_name.toLowerCase().includes(search) ||
          u.email.toLowerCase().includes(search);
      });

      if (roleFilter) {
        filtered = filtered.filter(u => u.role === roleFilter);
      }

      if (zoneFilter) {
        if (zoneFilter === 'sin_zona') {
          filtered = filtered.filter(u => {
            const gs = findVendedorData(u.full_name);
            return !gs || !gs.zona;
          });
        } else {
          filtered = filtered.filter(u => {
            const gs = findVendedorData(u.full_name);
            return gs && gs.zona === zoneFilter;
          });
        }
      }

      renderUsersTable(filtered);
      document.getElementById('users-count').textContent = filtered.length;
    }

    function filterVehicles() {
      const search = document.getElementById('search-vehicles').value.toLowerCase();
      const filtered = allVehicles.filter(v =>
        v.license_plate.toLowerCase().includes(search) ||
        v.model.toLowerCase().includes(search)
      );
      renderVehiclesTable(filtered);
      document.getElementById('vehicles-count').textContent = filtered.length;
    }

    function renderProductsTable(data) {
      const tbody = document.querySelector('#table-products tbody');
      tbody.innerHTML = data.map(p => `
        <tr>
          <td><code>${p.sku}</code></td>
          <td>${p.name}</td>
          <td>$${p.base_cost.toLocaleString()}</td>
          <td>$${p.list_price.toLocaleString()}</td>
        </tr>
      `).join('');
    }

    function renderRoutesTable(data) {
      renderTodayRoutesTable();
    }

    function renderTodayRoutesTable() {
      const tbody = document.querySelector('#table-routes tbody');
      if (!tbody) return;
      const data = todayRoutesData;

      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 40px;">No hay rutas iniciadas hoy</td></tr>';
        return;
      }

      // Filter by selected executive if any
      let filteredData = data;
      if (selectedExecutiveId) {
        filteredData = data.filter(r => r.user_id === selectedExecutiveId);
      }

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 40px;">Este vendedor no tiene rutas hoy</td></tr>';
        return;
      }

      tbody.innerHTML = filteredData.map(r => {
        const assignedClients = allClients.filter(c => c.assigned_user_id === r.user_id).length;
        const visits = r.visits?.length || r.visits_count || 0;
        const progress = assignedClients > 0 ? Math.round((visits / assignedClients) * 100) : 0;
        const startTime = r.created_at ? new Date(r.created_at).toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' }) : '-';
        const gsData = findVendedorData(r.user?.full_name);
        const zona = gsData ? gsData.zona : '';
        const zc = ZONE_COLORS[(zona || '').toLowerCase()] || null;
        const zoneTag = zc ? `<span style="background:${zc.bg};color:${zc.color};border:1px solid ${zc.border};padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;white-space:nowrap;">${zona}</span>` : '';

        return `
          <tr class="vendor-route-row" onclick="goToVendorRoute('${r.user_id}')" style="cursor:pointer;">
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 32px; height: 32px; border-radius: 50%; background: ${zc ? zc.color : 'var(--primary)'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                  ${(r.user?.full_name || 'E')[0]}
                </div>
                <div>
                  <div style="display:flex;align-items:center;gap:6px;"><span style="font-weight: 500;">${r.user?.full_name || '-'}</span>${zoneTag}</div>
                  <div style="font-size: 11px; color: var(--text-muted);">${assignedClients} clientes asignados</div>
                </div>
              </div>
            </td>
            <td><code style="font-size: 11px;">${r.vehicle?.license_plate || '-'}</code></td>
            <td>${startTime}</td>
            <td>
              ${r.status === 'completed' && r.end_km ? `
                <div style="font-size:12px;">${r.start_km?.toLocaleString() || 0} → ${r.end_km.toLocaleString()} km</div>
                <div style="font-size:11px; color:var(--success); font-weight:600;">${(r.end_km - (r.start_km || 0)).toLocaleString()} km recorridos</div>
              ` : `${r.start_km?.toLocaleString() || 0} km`}
            </td>
            <td style="font-weight: 600;">${visits}</td>
            <td style="min-width: 120px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                  <div style="height: 100%; width: ${progress}%; background: ${progress >= 80 ? 'var(--success)' : progress >= 50 ? 'var(--warning)' : 'var(--primary)'}; border-radius: 3px; transition: width 0.3s;"></div>
                </div>
                <span style="font-size: 11px; font-weight: 600; color: ${progress >= 80 ? 'var(--success)' : progress >= 50 ? 'var(--warning)' : 'var(--text-muted)'};">${progress}%</span>
              </div>
            </td>
            <td><span class="badge badge-${r.status === 'active' ? 'success' : r.status === 'completed' ? 'secondary' : 'warning'}">${r.status === 'active' ? 'En Ruta' : r.status === 'completed' ? 'Terminado' : r.status}</span></td>
            <td>
              <div style="display: flex; gap: 4px;">
                <button class="btn btn-sm btn-primary" onclick="viewRoute('${r.id}')" title="Ver detalles">
                  <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                </button>
                ${r.status === 'active' ? `
                  <button class="btn btn-sm btn-secondary" onclick="endRoute('${r.id}')" title="Finalizar ruta">
                    <i data-lucide="flag" style="width: 14px; height: 14px;"></i>
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
      lucide.createIcons();
    }

    async function deleteRouteById(routeId) {
      if (!routeId) return;
      try {
        const res = await fetch(`/api/routes/daily/${routeId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Ruta eliminada', 'La ruta fue eliminada correctamente');
          loadData();
          updateRouteDashboard();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    function endRoute(routeId) {
      if (!routeId) return;
      // Find the route to show start_km (check todayRoutesData first, then currentActiveRoute)
      const route = todayRoutesData.find(r => r.id === routeId) || (currentActiveRoute?.id === routeId ? currentActiveRoute : null);
      const startKm = route?.start_km || 0;
      document.getElementById('end-route-id').value = routeId;
      document.getElementById('end-route-start-km').textContent = startKm.toLocaleString() + ' km';
      document.getElementById('end-route-km-input').value = '';
      document.getElementById('end-route-km-diff').textContent = 'Ingresa el KM final para ver el recorrido';
      document.getElementById('end-route-km-input').min = startKm;
      const modal = document.getElementById('end-route-modal');
      modal.style.display = 'flex';
      lucide.createIcons();

      // Calculate estimated km for comparison
      let estimatedKm = 0;
      if (currentActiveRoute) {
        const routeClients = allClients.filter(c => c.assigned_user_id === currentActiveRoute.user_id);
        const routeMetrics = calculateRouteMetrics(routeClients, currentActiveRoute.vehicle);
        estimatedKm = routeMetrics.distance || 0;
      }

      // Live diff calculation
      document.getElementById('end-route-km-input').oninput = function() {
        const val = parseInt(this.value);
        if (!isNaN(val) && val >= startKm) {
          const diff = val - startKm;
          let compHtml = '';
          if (estimatedKm > 0) {
            const kmDiff = diff - estimatedKm;
            const pct = Math.round((kmDiff / estimatedKm) * 100);
            const sign = kmDiff >= 0 ? '+' : '';
            const color = Math.abs(pct) <= 15 ? '#10b981' : '#f59e0b';
            compHtml = `<br><span style="font-size:11px;">Ruta calculada: ${estimatedKm} km | Diferencia: <strong style="color:${color};">${sign}${kmDiff} km (${sign}${pct}%)</strong></span>`;
          }
          document.getElementById('end-route-km-diff').innerHTML = `<span style="font-size:20px;font-weight:700;color:var(--primary);">${diff.toLocaleString()} km</span><br><span style="font-size:11px;">recorridos hoy</span>${compHtml}`;
        } else if (!isNaN(val) && val < startKm) {
          document.getElementById('end-route-km-diff').innerHTML = '<span style="color:var(--danger);">KM final debe ser mayor al inicial</span>';
        } else {
          document.getElementById('end-route-km-diff').textContent = 'Ingresa el KM final para ver el recorrido';
        }
      };
    }

    function closeEndRouteModal() {
      document.getElementById('end-route-modal').style.display = 'none';
    }

    async function confirmEndRoute() {
      const routeId = document.getElementById('end-route-id').value;
      const endKm = parseInt(document.getElementById('end-route-km-input').value);
      const route = todayRoutesData.find(r => r.id === routeId) || (currentActiveRoute?.id === routeId ? currentActiveRoute : null) || (currentStaleRoute?.id === routeId ? currentStaleRoute : null);
      const startKm = route?.start_km || 0;

      if (isNaN(endKm) || endKm < startKm) {
        showToast('warning', 'KM inválido', 'Ingresa un kilometraje final válido');
        return;
      }

      try {
        const res = await fetch(`${API}/routes/${routeId}/end`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ endKm })
        });
        const data = await res.json();
        if (data.success) {
          closeEndRouteModal();
          showToast('success', 'Ruta finalizada', `Jornada completada — ${(endKm - startKm).toLocaleString()} km recorridos`);
          // Clear stale/active state
          currentStaleRoute = null;
          currentActiveRoute = null;
          document.getElementById('stale-route-warning').style.display = 'none';
          document.getElementById('active-route-info').style.display = 'none';
          loadData();
          // Re-check the selected executive
          const selUser = document.getElementById('start-user').value;
          if (selUser) setTimeout(() => checkActiveRoute(selUser), 500);
        } else {
          showToast('error', 'Error', data.error || 'No se pudo finalizar la ruta');
        }
      } catch (e) {
        showToast('error', 'Error', 'Error al finalizar la ruta');
      }
    }

    function renderPricesTable(data) {
      const tbody = document.querySelector('#table-prices tbody');
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">No hay precios registrados</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(p => `
        <tr>
          <td>${p.product?.name || '-'}</td>
          <td>${p.competitor?.name || '-'}</td>
          <td><strong>$${p.detected_price.toLocaleString()}</strong></td>
          <td><span class="badge badge-${p.source === 'n8n_scraper' ? 'active' : 'pending'}">${p.source}</span></td>
          <td>${new Date(p.captured_at).toLocaleString('es-CL')}</td>
        </tr>
      `).join('');
    }

    function viewRoute(routeId) {
      // Switch to routes tab
      document.querySelector('[data-tab="routes"]').click();
    }

    // =============================================
    // GESTIÓN DE VENDEDORES
    // =============================================

    let addUserFormOpen = false;
    function toggleAddUserForm() {
      addUserFormOpen = !addUserFormOpen;
      const body = document.getElementById('add-user-form-body');
      const chevron = document.getElementById('add-user-chevron');
      body.style.display = addUserFormOpen ? 'block' : 'none';
      chevron.style.transform = addUserFormOpen ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    function updateExecutivesStats() {
      const executives = allUsers.filter(u => u.role === 'executive' || u.role === 'zonal');
      const activeToday = todayRoutesData.filter(r => r.status === 'active').length;
      const assignedClientsCount = allClients.filter(c => c.assigned_user_id).length;
      const unassignedClientsCount = allClients.filter(c => !c.assigned_user_id).length;

      document.getElementById('stat-exec-total').textContent = executives.length;
      document.getElementById('stat-exec-active').textContent = activeToday;
      document.getElementById('stat-exec-clients').textContent = assignedClientsCount;
      document.getElementById('stat-exec-unassigned').textContent = unassignedClientsCount;
    }

    function renderUserZonesBadges(userId) {
      const uClients = allClients.filter(c => c.assigned_user_id === userId);
      const zonesMap = {};
      uClients.forEach(c => {
        const z = c.zone || 'Sin Zona';
        if (!zonesMap[z]) zonesMap[z] = new Set();
        if (c.commune) zonesMap[z].add(c.commune);
      });
      const zoneEntries = Object.entries(zonesMap);
      if (zoneEntries.length === 0) return '<span style="color:var(--text-muted);font-size:11px;">Sin zonas</span>';
      const zColors = {'Norte':'#3b82f6','Centro':'#8b5cf6','Centro Sur':'#f59e0b','Sur':'#10b981'};
      return '<div style="display:flex;flex-wrap:wrap;gap:3px;">' + zoneEntries.map(function(entry) {
        const z = entry[0];
        const communes = entry[1];
        const col = zColors[z] || '#6b7280';
        const communeCount = communes.size;
        const communeTitle = Array.from(communes).sort().join(', ');
        return '<span style="background:' + col + '15;color:' + col + ';padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;white-space:nowrap;" title="' + communeTitle + '">' + z + (communeCount > 0 ? ' (' + communeCount + ')' : '') + '</span>';
      }).join('') + '</div>';
    }

    function renderUsersTable(data) {
      const tbody = document.querySelector('#table-users tbody');
      updateExecutivesStats();

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 40px;">No hay usuarios que coincidan</td></tr>';
        return;
      }

      // Enrich with Google Sheets zone data
      const enriched = data.map(u => {
        const gsData = findVendedorData(u.full_name);
        return { ...u, _zona: gsData ? gsData.zona : '', _isZonal: gsData ? gsData.isZonal : false, _zonal: gsData ? gsData.zonal : '', _mail: gsData ? gsData.mail : '', _cel: gsData ? gsData.cel : '' };
      });

      // Group users by zone using Google Sheets data
      const ZONE_ORDER = ['Zona Norte', 'Zona Centro', 'Zona Centro Sur', 'Zona Sur', 'Sin Zona'];
      const zoneGroups = {};
      enriched.forEach(u => {
        const zone = u._zona || 'Sin Zona';
        if (!zoneGroups[zone]) zoneGroups[zone] = [];
        zoneGroups[zone].push(u);
      });

      const sortedZones = ZONE_ORDER.filter(z => zoneGroups[z]);
      Object.keys(zoneGroups).forEach(z => { if (!sortedZones.includes(z)) sortedZones.push(z); });

      let html = '';
      sortedZones.forEach(zone => {
        const zc = ZONE_COLORS[(zone || '').toLowerCase()] || { bg: 'var(--bg-hover)', color: '#6b7280', border: 'var(--border)' };
        const zoneColor = zc.color;
        const zoneUsers = zoneGroups[zone];
        const zonal = zoneUsers.find(u => u._isZonal);

        // Zone header row
        html += `
          <tr style="background: ${zc.bg};">
            <td colspan="6" style="padding: 10px 16px; border-left: 3px solid ${zoneColor};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 700; font-size: 13px; color: ${zoneColor}; text-transform: uppercase; letter-spacing: 0.5px;">
                  ${zone}
                </div>
                <div style="font-size: 11px; color: var(--text-muted);">
                  ${zonal ? 'Zonal: <strong>' + zonal.full_name + '</strong> &middot; ' : ''}${zoneUsers.length} vendedores
                </div>
              </div>
            </td>
          </tr>
        `;

        zoneUsers.forEach(u => {
          const assignedClients = allClients.filter(c => c.assigned_user_id === u.id).length;
          const todayRoute = todayRoutesData.find(r => r.user_id === u.id);
          const hasActiveRoute = todayRoute?.status === 'active';
          const todayVisits = todayRoute?.visits_count || todayRoute?.visits?.length || 0;
          const isActive = u.status !== 'inactive';
          const initials = getInitials(u.full_name);
          const roleLabel = u.role === 'admin' ? 'Admin' : u._isZonal ? 'Zonal' : 'Vendedor';
          const roleClass = u.role === 'admin' ? 'badge-secondary' : u._isZonal ? 'badge-warning' : 'badge-primary';

          html += `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 36px; height: 36px; border-radius: 50%; background: ${u._isZonal ? zoneColor : u.role === 'admin' ? '#6b7280' : '#1e40af'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                  ${initials}
                </div>
                <div>
                  <div style="font-weight: 600; display: flex; align-items: center; gap: 5px;">
                    ${u.full_name}
                    ${u.home_lat && u.home_lng
                      ? '<span title="Punto de inicio: ' + (u.home_address || '').replace(/"/g, '&quot;') + '" style="color: var(--success); display: inline-flex;"><i data-lucide="map-pin" style="width: 13px; height: 13px;"></i></span>'
                      : '<span title="Sin punto de inicio configurado" style="color: var(--text-muted); opacity: 0.4; display: inline-flex;"><i data-lucide="map-pin" style="width: 13px; height: 13px;"></i></span>'}
                  </div>
                  <span class="badge ${roleClass}" style="font-size: 9px;">${roleLabel}${u._isZonal ? ' (Lider)' : ''}</span>
                </div>
              </div>
            </td>
            <td style="overflow: hidden;">
              <div style="max-height: 60px; overflow: hidden;">
              ${u._zona ? (() => { const zcb = ZONE_COLORS[(u._zona || '').toLowerCase()] || { bg: 'var(--bg-hover)', color: 'var(--text-muted)', border: 'var(--border)' }; return '<span style="background:' + zcb.bg + ';color:' + zcb.color + ';border:1px solid ' + zcb.border + ';padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;display:inline-block;">' + u._zona + '</span>'; })() : renderUserZonesBadges(u.id)}
              </div>
            </td>
            <td style="text-align: center;">
              ${u.role === 'executive' || u.role === 'supervisor' || u._isZonal ? `
                <div style="cursor: pointer;" onclick="toggleTableVendorClients('${u.id}', this)">
                  <div style="font-size: 14px; font-weight: 700; color: var(--primary);">${assignedClients}</div>
                  <div style="font-size: 10px; color: var(--accent);">ver clientes</div>
                </div>
              ` : '<span style="color: var(--text-muted);">-</span>'}
            </td>
            <td style="text-align: center;">
              ${u.role === 'executive' || u.role === 'supervisor' || u._isZonal ? `
                ${hasActiveRoute ? `
                  <span class="badge badge-success" style="font-size: 10px;">En Ruta</span>
                ` : todayRoute ? `
                  <span class="badge badge-secondary" style="font-size: 10px;">Completada</span>
                ` : `
                  <span class="badge badge-warning" style="font-size: 10px;">Sin iniciar</span>
                `}
              ` : '<span style="color: var(--text-muted);">-</span>'}
            </td>
            <td style="text-align: center;">
              <label style="display: inline-flex; align-items: center; gap: 4px; cursor: pointer;">
                <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleUserStatus('${u.id}', this.checked)" style="width: 15px; height: 15px;">
                <span style="font-size: 11px; color: ${isActive ? 'var(--success)' : 'var(--text-muted)'};">${isActive ? 'Activo' : 'Inact.'}</span>
              </label>
            </td>
            <td>
              <div style="display: flex; gap: 4px; justify-content: center; align-items: center;">
                ${u.role === 'executive' || u.role === 'supervisor' || u._isZonal ? `
                  <button class="btn btn-primary" onclick="quickAssignToUser('${u.id}')" style="padding: 3px 8px; font-size: 10px;" title="Asignar clientes">
                    <i data-lucide="user-plus" style="width: 12px; height: 12px;"></i>
                  </button>
                  <button class="btn btn-secondary" onclick="viewUserRoutes('${u.id}')" style="padding: 3px 8px; font-size: 10px;" title="Ver rutas">
                    <i data-lucide="route" style="width: 12px; height: 12px;"></i>
                  </button>
                ` : ''}
                <button class="btn-icon" onclick="editUser('${u.id}')" title="Editar" style="padding: 3px;">
                  <i data-lucide="pencil" style="width: 13px; height: 13px;"></i>
                </button>
                <button class="btn-icon" style="color: var(--danger); padding: 3px;" onclick="deleteUser('${u.id}')" title="Eliminar">
                  <i data-lucide="trash-2" style="width: 13px; height: 13px;"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr id="vendor-clients-row-${u.id}" style="display: none;">
            <td colspan="6" style="padding: 0;"><div id="vendor-clients-table-${u.id}"></div></td>
          </tr>
          `;
        });
      });

      tbody.innerHTML = html;
      lucide.createIcons();
    }

    // Toggle client list inline in table
    async function toggleTableVendorClients(userId, el) {
      const row = document.getElementById(`vendor-clients-row-${userId}`);
      const container = document.getElementById(`vendor-clients-table-${userId}`);
      if (!row || !container) return;

      if (row.style.display !== 'none') {
        row.style.display = 'none';
        return;
      }

      container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">Cargando clientes...</div>';
      row.style.display = 'table-row';

      try {
        const res = await fetch(`${API}/api/users/${userId}/clients`);
        const result = await res.json();

        if (!result.success || !result.data || result.data.length === 0) {
          container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted); font-size: 12px;">Sin clientes asignados</div>';
          return;
        }

        const clients = result.data;
        const segColors = { 'A': '#d97706', 'B': '#3b82f6', 'C': '#059669', 'D': '#f97316', 'E': '#9ca3af' };
        let html = '<div style="background: var(--bg-hover); border-left: 3px solid var(--accent); margin: 0;">';
        html += '<div style="padding: 6px 12px; font-size: 11px; font-weight: 600; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border);">';
        html += `<span>${clients.length} clientes asignados</span>`;
        html += `<button class="btn btn-secondary" onclick="openReassignFromVendor('${userId}')" style="padding: 2px 8px; font-size: 10px;">Reasignar</button>`;
        html += '</div>';
        html += '<div style="max-height: 250px; overflow-y: auto;">';

        clients.forEach(c => {
          html += `
            <div style="padding: 5px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-weight: 600; color: var(--text-muted); font-size: 10px; min-width: 55px;">${c.external_id || '-'}</span>
                <span style="font-weight: 500;">${c.fantasy_name || c.name}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 10px; color: var(--text-muted);">${c.commune || ''}</span>
                <span style="font-size: 9px; font-weight: 700; color: ${segColors[c.segment] || '#6b7280'}; background: ${segColors[c.segment] || '#6b7280'}20; padding: 1px 6px; border-radius: 4px;">${c.segment || '-'}</span>
              </div>
            </div>
          `;
        });

        html += '</div></div>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--danger); font-size: 12px;">Error al cargar clientes</div>';
      }
    }

    async function toggleUserStatus(userId, isActive) {
      const user = allUsers.find(u => u.id === userId);
      if (user) {
        user.status = isActive ? 'active' : 'inactive';
        showToast('success', 'Estado actualizado', `${user.full_name} ahora está ${isActive ? 'activo' : 'inactivo'}`);
        // Note: This only updates locally. To persist, we'd need to add status column to users table
      }
    }

    function quickAssignToUser(userId) {
      showPanel('routes');
      setTimeout(() => {
        selectExecutive(userId);
        setTimeout(() => openAssignClientsModal(), 200);
      }, 100);
    }

    function viewUserRoutes(userId) {
      showPanel('routes');
      setTimeout(() => {
        selectExecutive(userId);
      }, 100);
    }

    function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      document.getElementById('edit-user-id').value = user.id;
      document.getElementById('edit-user-name').value = user.full_name || '';
      document.getElementById('edit-user-role').value = user.role || 'executive';
      document.getElementById('edit-user-home-address').value = user.home_address || '';
      document.getElementById('edit-user-home-lat').value = user.home_lat || '';
      document.getElementById('edit-user-home-lng').value = user.home_lng || '';
      document.getElementById('edit-user-geocode-status').style.display = 'none';

      document.getElementById('modal-edit-user').style.display = 'flex';
      lucide.createIcons();
    }

    function closeEditUserModal() {
      document.getElementById('modal-edit-user').style.display = 'none';
    }

    async function geocodeUserAddress() {
      const address = document.getElementById('edit-user-home-address').value.trim();
      if (!address) {
        showToast('warning', 'Dirección vacía', 'Ingresa una dirección para geocodificar');
        return;
      }

      const statusEl = document.getElementById('edit-user-geocode-status');
      statusEl.style.display = 'block';
      statusEl.style.background = 'var(--bg-hover)';
      statusEl.style.color = 'var(--text-muted)';
      statusEl.textContent = 'Geocodificando...';

      try {
        const geocoder = new google.maps.Geocoder();
        const result = await new Promise((resolve, reject) => {
          geocoder.geocode({ address: address + ', Chile' }, (results, status) => {
            if (status === 'OK' && results[0]) resolve(results[0]);
            else reject(new Error('No se encontró la dirección'));
          });
        });

        const lat = result.geometry.location.lat().toFixed(8);
        const lng = result.geometry.location.lng().toFixed(8);
        document.getElementById('edit-user-home-lat').value = lat;
        document.getElementById('edit-user-home-lng').value = lng;

        statusEl.style.background = 'rgba(16, 185, 129, 0.1)';
        statusEl.style.color = 'var(--success)';
        statusEl.textContent = '✓ ' + result.formatted_address;
      } catch (err) {
        statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
        statusEl.style.color = 'var(--danger)';
        statusEl.textContent = '✗ ' + err.message;
      }
    }

    async function saveEditUser() {
      const userId = document.getElementById('edit-user-id').value;
      const fullName = document.getElementById('edit-user-name').value.trim();
      const role = document.getElementById('edit-user-role').value;
      const homeAddress = document.getElementById('edit-user-home-address').value.trim();
      const homeLat = document.getElementById('edit-user-home-lat').value || null;
      const homeLng = document.getElementById('edit-user-home-lng').value || null;

      if (!fullName) {
        showToast('warning', 'Nombre requerido', 'El nombre no puede estar vacío');
        return;
      }

      try {
        const res = await fetch(`${API}/api/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            full_name: fullName,
            role,
            home_address: homeAddress || null,
            home_lat: homeLat ? parseFloat(homeLat) : null,
            home_lng: homeLng ? parseFloat(homeLng) : null
          })
        });
        const data = await res.json();
        if (data.success) {
          closeEditUserModal();
          loadData();
          showToast('success', 'Usuario actualizado', `${fullName} guardado correctamente`);
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    }

    document.getElementById('form-add-user').addEventListener('submit', async (e) => {
      e.preventDefault();
      const body = {
        fullName: document.getElementById('user-name').value,
        email: document.getElementById('user-email').value,
        role: document.getElementById('user-role').value
      };
      const zone = document.getElementById('user-zone')?.value;
      try {
        const res = await fetch(`${API}/api/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
          // If zone was selected, assign it
          if (zone && data.data?.id) {
            const isLeader = body.role === 'zonal';
            await fetch(`${API}/api/users/${data.data.id}/zone`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ zone, zone_leader: isLeader })
            });
          }
          document.getElementById('form-add-user').reset();
          loadData();
          showToast('success', 'Vendedor agregado', data.data?.full_name || 'Nuevo vendedor registrado');
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    });

    async function deleteUser(userId) {
      if (!confirm('¿Estás seguro de eliminar este vendedor?')) return;
      try {
        const res = await fetch(`${API}/api/users/${userId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          loadData();
          showToast('success', 'Vendedor eliminado', 'El vendedor ha sido eliminado correctamente');
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    }

    // =============================================
    // REASIGNACIÓN DE CLIENTES - SECCIÓN DEDICADA
    // =============================================

    let sectionOriginClients = [];
    let sectionSelectedIds = new Set();

    function initReassignSection() {
      const fromSelect = document.getElementById('reassign-section-from');
      const toSelect = document.getElementById('reassign-section-to');
      if (!fromSelect || !toSelect) return;

      const executives = allUsers.filter(u => u.role === 'executive' || u.role === 'zonal');
      const options = executives.map(e => {
        const count = allClients.filter(c => c.assigned_user_id === e.id).length;
        return `<option value="${e.id}">${e.full_name} (${count} clientes)</option>`;
      }).join('');

      fromSelect.innerHTML = '<option value="">Seleccionar vendedor...</option>' + options;
      toSelect.innerHTML = '<option value="">Seleccionar vendedor...</option>' + options;
    }

    async function loadOriginClients() {
      const fromId = document.getElementById('reassign-section-from').value;
      const panels = document.getElementById('reassign-section-panels');
      const empty = document.getElementById('reassign-section-empty');
      const originList = document.getElementById('section-origin-list');
      const originInfo = document.getElementById('origin-info');

      sectionSelectedIds.clear();
      sectionOriginClients = [];

      if (!fromId) {
        panels.style.display = 'none';
        empty.style.display = 'block';
        originInfo.style.display = 'none';
        return;
      }

      panels.style.display = 'block';
      empty.style.display = 'none';
      originList.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted); font-size: 12px;">Cargando clientes...</div>';

      try {
        const res = await fetch(`${API}/api/users/${fromId}/clients`);
        const result = await res.json();

        if (!result.success || !result.data || result.data.length === 0) {
          originList.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted); font-size: 12px;">Sin clientes asignados</div>';
          originInfo.style.display = 'none';
          renderSectionDestPreview();
          return;
        }

        sectionOriginClients = result.data;
        document.getElementById('origin-client-total').textContent = sectionOriginClients.length;
        originInfo.style.display = 'block';
        renderSectionOriginList();
        renderSectionDestPreview();
        updateSectionBtn();
      } catch (e) {
        originList.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--danger); font-size: 12px;">Error al cargar clientes</div>';
      }
      lucide.createIcons();
    }

    function renderSectionOriginList() {
      const container = document.getElementById('section-origin-list');
      const segColors = { 'A': '#d97706', 'B': '#3b82f6', 'C': '#059669', 'D': '#f97316', 'E': '#9ca3af' };

      if (sectionOriginClients.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted); font-size: 12px;">Sin clientes</div>';
        return;
      }

      container.innerHTML = sectionOriginClients.map(c => {
        const sel = sectionSelectedIds.has(c.id);
        const segColor = segColors[c.segment] || '#6b7280';
        return `
          <div onclick="sectionToggleClient('${c.id}')" style="border: 1px solid ${sel ? 'var(--accent)' : 'var(--border)'}; border-left: 3px solid ${sel ? 'var(--accent)' : 'transparent'}; border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; background: ${sel ? 'rgba(59,130,246,0.04)' : 'var(--bg-card)'}; cursor: pointer; transition: all 0.15s;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" ${sel ? 'checked' : ''} onclick="event.stopPropagation(); sectionToggleClient('${c.id}')" style="width: 15px; height: 15px; cursor: pointer; flex-shrink: 0;">
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-weight: 600; font-size: 10px; color: var(--text-muted); min-width: 50px;">${c.external_id || '-'}</span>
                  <span style="font-size: 9px; font-weight: 700; color: ${segColor}; background: ${segColor}20; padding: 1px 5px; border-radius: 3px;">${c.segment || '-'}</span>
                </div>
                <div style="font-size: 12px; font-weight: 500; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c.fantasy_name || c.name}</div>
                <div style="font-size: 10px; color: var(--text-muted); margin-top: 1px;">${c.commune || ''}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function sectionToggleClient(clientId) {
      if (sectionSelectedIds.has(clientId)) {
        sectionSelectedIds.delete(clientId);
      } else {
        sectionSelectedIds.add(clientId);
      }
      renderSectionOriginList();
      renderSectionDestPreview();
      updateSectionBtn();
      const cb = document.getElementById('section-select-all');
      if (cb) cb.checked = sectionSelectedIds.size === sectionOriginClients.length;
    }

    function sectionToggleAll(checked) {
      sectionSelectedIds.clear();
      if (checked) {
        sectionOriginClients.forEach(c => sectionSelectedIds.add(c.id));
      }
      renderSectionOriginList();
      renderSectionDestPreview();
      updateSectionBtn();
    }

    function renderSectionDestPreview() {
      const container = document.getElementById('section-dest-list');
      const countEl = document.getElementById('section-preview-count');
      const segColors = { 'A': '#d97706', 'B': '#3b82f6', 'C': '#059669', 'D': '#f97316', 'E': '#9ca3af' };

      const count = sectionSelectedIds.size;
      countEl.textContent = `${count} seleccionado${count !== 1 ? 's' : ''}`;

      if (count === 0) {
        container.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; padding: 40px 20px; text-align: center; color: var(--text-muted);">
            <i data-lucide="inbox" style="width: 40px; height: 40px; opacity: 0.2; margin-bottom: 8px;"></i>
            <div style="font-size: 12px;">Selecciona clientes de la izquierda</div>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      const selected = sectionOriginClients.filter(c => sectionSelectedIds.has(c.id));
      container.innerHTML = selected.map(c => {
        const segColor = segColors[c.segment] || '#6b7280';
        return `
          <div style="border: 1px solid var(--success); border-left: 3px solid var(--success); border-radius: 6px; padding: 8px 10px; margin-bottom: 6px; background: rgba(16,185,129,0.03);">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 22px; height: 22px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i data-lucide="check" style="width: 12px; height: 12px; color: white;"></i>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span style="font-weight: 600; font-size: 10px; color: var(--text-muted);">${c.external_id || '-'}</span>
                  <span style="font-size: 9px; font-weight: 700; color: ${segColor}; background: ${segColor}20; padding: 1px 5px; border-radius: 3px;">${c.segment || '-'}</span>
                </div>
                <div style="font-size: 12px; font-weight: 500; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c.fantasy_name || c.name}</div>
                <div style="font-size: 10px; color: var(--text-muted); margin-top: 1px;">${c.commune || ''}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      lucide.createIcons();
    }

    function updateSectionPreview() {
      const destId = document.getElementById('reassign-section-to').value;
      const destInfo = document.getElementById('dest-info');
      if (destId) {
        const destCount = allClients.filter(c => c.assigned_user_id === destId).length;
        document.getElementById('dest-client-total').textContent = destCount;
        destInfo.style.display = 'block';
      } else {
        destInfo.style.display = 'none';
      }
      updateSectionBtn();
    }

    function updateSectionBtn() {
      const btn = document.getElementById('btn-section-reassign');
      const fromId = document.getElementById('reassign-section-from').value;
      const toId = document.getElementById('reassign-section-to').value;
      btn.disabled = !(fromId && toId && fromId !== toId && sectionSelectedIds.size > 0);
    }

    async function executeSectionReassign() {
      const fromId = document.getElementById('reassign-section-from').value;
      const toId = document.getElementById('reassign-section-to').value;

      if (!fromId || !toId || fromId === toId || sectionSelectedIds.size === 0) return;

      const fromExec = allUsers.find(u => u.id === fromId);
      const toExec = allUsers.find(u => u.id === toId);
      const count = sectionSelectedIds.size;
      const isAll = count === sectionOriginClients.length;

      if (!confirm(`¿Reasignar ${count} cliente${count > 1 ? 's' : ''} de ${fromExec?.full_name} a ${toExec?.full_name}?\n\nEsta acción no se puede deshacer.`)) return;

      const btn = document.getElementById('btn-section-reassign');
      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader" style="width: 18px; height: 18px;"></i> Reasignando...';
      lucide.createIcons();

      try {
        let response;
        if (isAll) {
          response = await fetch(`${API}/api/clients/reassign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fromUserId: fromId, toUserId: toId })
          });
        } else {
          response = await fetch(`${API}/api/clients/reassign-selected`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ clientIds: Array.from(sectionSelectedIds), toUserId: toId })
          });
        }

        const result = await response.json();
        if (result.success) {
          showToast('success', 'Reasignación completa', `${result.data.updated} cliente${result.data.updated > 1 ? 's transferidos' : ' transferido'} a ${toExec.full_name}`);
          resetSectionReassign();
          await loadData();
          initReassignSection();
        } else {
          showToast('error', 'Error', result.error || 'No se pudo reasignar');
        }
      } catch (e) {
        showToast('error', 'Error', 'Error de conexión al reasignar');
      }

      btn.disabled = false;
      btn.innerHTML = '<i data-lucide="check-circle" style="width: 18px; height: 18px;"></i> Confirmar Reasignación';
      lucide.createIcons();
    }

    function resetSectionReassign() {
      document.getElementById('reassign-section-from').value = '';
      document.getElementById('reassign-section-to').value = '';
      document.getElementById('origin-info').style.display = 'none';
      document.getElementById('dest-info').style.display = 'none';
      document.getElementById('reassign-section-panels').style.display = 'none';
      document.getElementById('reassign-section-empty').style.display = 'block';
      sectionSelectedIds.clear();
      sectionOriginClients = [];
      const cb = document.getElementById('section-select-all');
      if (cb) cb.checked = false;
    }

    // =============================================
    // GESTIÓN DE VEHÍCULOS
    // =============================================

    function renderVehiclesTable(data) {
      const tbody = document.querySelector('#table-vehicles tbody');
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">No hay vehículos</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(v => {
        const statusColors = {
          active: 'badge-a',
          maintenance: 'badge-b',
          inactive: 'badge-c'
        };
        const statusLabels = {
          active: 'Activo',
          maintenance: 'Mantención',
          inactive: 'Inactivo'
        };
        return `
          <tr>
            <td><strong>${v.license_plate}</strong></td>
            <td>${v.model}</td>
            <td>${v.fuel_efficiency_kml} km/L</td>
            <td>
              <select class="form-control" style="padding: 6px 10px; font-size: 12px; width: auto;" onchange="updateVehicleStatus('${v.id}', this.value)">
                <option value="active" ${v.status === 'active' ? 'selected' : ''}>Activo</option>
                <option value="maintenance" ${v.status === 'maintenance' ? 'selected' : ''}>Mantención</option>
                <option value="inactive" ${v.status === 'inactive' ? 'selected' : ''}>Inactivo</option>
              </select>
            </td>
            <td>
              <button class="btn btn-sm" class="btn-danger" onclick="deleteVehicle('${v.id}')">
                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      lucide.createIcons();
    }

    document.getElementById('form-add-vehicle').addEventListener('submit', async (e) => {
      e.preventDefault();
      const body = {
        licensePlate: document.getElementById('vehicle-plate').value,
        model: document.getElementById('vehicle-model').value,
        fuelEfficiency: document.getElementById('vehicle-efficiency').value
      };
      try {
        const res = await fetch(`${API}/api/vehicles`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('form-add-vehicle').reset();
          document.getElementById('vehicle-efficiency').value = '12';
          loadData();
          showToast('success', 'Vehículo agregado', data.data?.license_plate || 'Nuevo vehículo registrado');
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    });

    async function deleteVehicle(vehicleId) {
      if (!confirm('¿Estás seguro de eliminar este vehículo?')) return;
      try {
        const res = await fetch(`${API}/api/vehicles/${vehicleId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          loadData();
          showToast('success', 'Vehículo eliminado', 'El vehículo ha sido eliminado correctamente');
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    }

    async function updateVehicleStatus(vehicleId, status) {
      try {
        const res = await fetch(`${API}/api/vehicles/${vehicleId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Estado actualizado', `Vehículo ahora está ${status === 'active' ? 'activo' : status === 'maintenance' ? 'en mantención' : 'inactivo'}`);
        } else {
          showToast('error', 'Error', data.error);
          loadData();
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    }

    // =============================================
    // DATA PANEL TABS
    // =============================================

    function switchDataTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.data-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.subtab === tabName) {
          tab.classList.add('active');
        }
      });

      // Update subpanels
      document.querySelectorAll('.data-subpanel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById(`subpanel-${tabName}`).classList.add('active');

      lucide.createIcons();
    }

    // =============================================
    // ROUTE PANEL — SUBTABS & WIZARD STEPPER
    // =============================================
    let currentRouteStep = 1;

    function switchRouteTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.route-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.routetab === tabName) {
          tab.classList.add('active');
        }
      });
      // Update subpanels
      document.querySelectorAll('.route-subpanel').forEach(panel => {
        panel.classList.remove('active');
      });
      const sub = document.getElementById(`route-subpanel-${tabName}`);
      if (sub) sub.classList.add('active');

      // Trigger data refresh for specific tabs
      if (tabName === 'dashboard') {
        updateRouteDashboard();
      } else if (tabName === 'gestionar') {
        // Always resize and show map when entering gestionar tab
        const resizeMap = () => {
          if (routeMap) {
            google.maps.event.trigger(routeMap, 'resize');
            if (selectedExecutiveId) {
              loadExecutiveRouteOnMap();
            }
          }
        };
        setTimeout(resizeMap, 100);
        setTimeout(resizeMap, 500);
      } else if (tabName === 'planner') {
        // Ensure vendor dropdown is populated before loading
        const vendorSel = document.getElementById('schedule-vendor');
        if (vendorSel && vendorSel.options.length <= 1 && allUsers && allUsers.length > 0) {
          const vendorExecs = allUsers.filter(u => u.role === 'executive' || u.role === 'zonal' || u.role === 'supervisor');
          if (currentUser && currentUser.role === 'executive') {
            vendorSel.innerHTML = `<option value="${currentUser.id}">${currentUser.full_name}</option>`;
          } else {
            vendorSel.innerHTML = '<option value="">-- Seleccionar Vendedor --</option>' +
              vendorExecs.map(u => `<option value="${u.id}">${u.full_name}</option>`).join('');
          }
        }
        if (!document.getElementById('schedule-start').value) setWeekFromOffset(0);
        // Executive: load only their own schedule directly (skip all-execs overview)
        if (currentUser && currentUser.role === 'executive') {
          showExecWeekDetail(currentUser.id);
        } else {
          loadWeeklyAllExecs();
        }
      } else if (tabName === 'monthly') {
        if (!monthlyCalendarData) {
          loadMonthlyCalendar();
        }
      }

      lucide.createIcons();
    }

    function goToRouteStep(step) {
      if (step < 1 || step > 4) return;
      currentRouteStep = step;

      // Update stepper visual
      document.querySelectorAll('.route-step').forEach(s => {
        const sNum = parseInt(s.dataset.step);
        s.classList.remove('active', 'completed');
        if (sNum === step) s.classList.add('active');
        else if (sNum < step) s.classList.add('completed');
      });

      // Update step lines
      document.querySelectorAll('.step-line').forEach((line, idx) => {
        line.classList.toggle('completed', idx < step - 1);
      });

      // Show/hide step content
      document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
      const content = document.getElementById(`wizard-step-${step}`);
      if (content) content.classList.add('active');

      // Step 3: refresh client list with route order
      if (step === 3) {
        loadExecutiveClients();
      }

      // Step 4: populate summary
      if (step === 4 && optimizedRouteData) {
        buildStep4Summary();
      }

      // Always resize map when changing steps (container visibility changes)
      setTimeout(() => {
        if (routeMap) {
          google.maps.event.trigger(routeMap, 'resize');
          // Step 2: draw optimized route on map
          if (step === 2 && optimizedRouteData) {
            drawOptimizedRouteOnMap(selectedOptDay);
          }
          // Step 4: show full route overview on map
          if (step === 4 && optimizedRouteData) {
            drawOptimizedRouteOnMap(selectedOptDay);
          }
        }
      }, 150);

      lucide.createIcons();
    }

    // Navigate to gestionar tab with specific vendor pre-selected
    function goToVendorRoute(userId) {
      // Go to Planner Semanal to VIEW the exec's routes
      switchRouteTab('planner');
      const vendorSel = document.getElementById('schedule-vendor');
      if (vendorSel) vendorSel.value = userId;
      if (!document.getElementById('schedule-start').value) setWeekFromOffset(0);
      showExecWeekDetail(userId);
    }

    function goToVendorGestionar(userId) {
      switchRouteTab('gestionar');
      goToRouteStep(1);
      const user = allUsers.find(u => u.id === userId);
      if (user) {
        const searchInput = document.getElementById('executive-search');
        if (searchInput) searchInput.value = user.full_name || user.name;
        selectExecutive(userId);
      }
    }

    // =============================================
    // DASHBOARD STAT CARD DRILLDOWN
    // =============================================
    let _activeStatDetail = null;
    const _closeStatPanel = "document.getElementById('dash-stat-detail').style.display='none';_activeStatDetail=null;document.querySelectorAll('.route-stat-card').forEach(c=>c.classList.remove('active-card'));";

    function scrollToExecRow(userId) {
      const row = document.getElementById('dash-row-' + userId);
      if (!row) return;
      // Expand if not already expanded
      if (!row.classList.contains('expanded')) {
        toggleDashboardExecDetail(userId, row);
      }
      // Scroll into view with offset
      setTimeout(() => {
        row.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Flash highlight
        row.style.transition = 'box-shadow 0.3s';
        row.style.boxShadow = '0 0 0 3px rgba(59,130,246,0.4)';
        setTimeout(() => { row.style.boxShadow = ''; }, 1500);
      }, 100);
    }

    function toggleStatDetail(type) {
      const panel = document.getElementById('dash-stat-detail');
      if (!panel) return;
      // Toggle off if same type clicked
      if (_activeStatDetail === type) {
        panel.style.display = 'none';
        _activeStatDetail = null;
        document.querySelectorAll('.route-stat-card').forEach(c => c.classList.remove('active-card'));
        return;
      }
      _activeStatDetail = type;
      document.querySelectorAll('.route-stat-card').forEach(c => c.classList.remove('active-card'));
      event.currentTarget.classList.add('active-card');

      const st = window._dashboardState || {};
      const execList = (executives && executives.length > 0) ? executives : allUsers.filter(u => u.role === 'executive');
      let html = '';
      const closeBtn = `<button onclick="${_closeStatPanel}" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:22px;padding:2px 6px;line-height:1;border-radius:6px;transition:background 0.15s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='none'">&times;</button>`;

      if (type === 'with-route') {
        const withRoute = execList.filter(u => st.executivesWithRoute && st.executivesWithRoute.has(u.id));
        html = `<div class="dash-stat-detail-panel">
          <h4><span><i data-lucide="users" style="width:18px;height:18px;color:#3b82f6;"></i> Vendedores con ruta hoy (${withRoute.length})</span>${closeBtn}</h4>
          <div class="dash-stat-detail-list">${withRoute.map(u => {
            const hasRow = !!document.getElementById('dash-row-' + u.id);
            return `<div class="dash-stat-detail-chip" style="cursor:pointer;" onclick="event.stopPropagation();scrollToExecRow('${u.id}')"><span class="chip-dot" style="background:#3b82f6;"></span>${u.full_name || u.name}${hasRow ? '<i data-lucide="arrow-down" style="width:14px;height:14px;color:#3b82f6;margin-left:4px;" title="Ver detalle abajo"></i>' : ''}</div>`;
          }).join('')}
          ${withRoute.length === 0 ? '<div class="dash-stat-detail-empty">Ningún vendedor con ruta activa hoy</div>' : ''}</div></div>`;
      } else if (type === 'without-route') {
        const withoutRoute = execList.filter(u => !st.executivesWithRoute || !st.executivesWithRoute.has(u.id));
        html = `<div class="dash-stat-detail-panel">
          <h4><span><i data-lucide="user-x" style="width:18px;height:18px;color:#ef4444;"></i> Vendedores sin ruta (${withoutRoute.length})</span>${closeBtn}</h4>
          <div class="dash-stat-detail-subtitle">Haz clic en un vendedor para asignarle una ruta</div>
          <div class="dash-stat-detail-list">${withoutRoute.map(u => `<div class="dash-stat-detail-chip" style="cursor:pointer;" onclick="event.stopPropagation();goToVendorGestionar('${u.id}')"><span class="chip-dot" style="background:#ef4444;"></span>${u.full_name || u.name}<i data-lucide="plus-circle" style="width:14px;height:14px;color:#3b82f6;margin-left:4px;" title="Asignar ruta"></i></div>`).join('')}
          ${withoutRoute.length === 0 ? '<div class="dash-stat-detail-empty">Todos los vendedores tienen ruta asignada</div>' : ''}</div></div>`;
      } else if (type === 'completed') {
        const completed = (st.completedRoutes || []);
        const completedExecs = completed.map(r => { const u = allUsers.find(x => x.id === r.user_id); return { name: u ? (u.full_name || u.name) : 'Desconocido', id: r.user_id }; });
        html = `<div class="dash-stat-detail-panel">
          <h4><span><i data-lucide="check-circle" style="width:18px;height:18px;color:#10b981;"></i> Rutas completadas hoy (${completed.length})</span>${closeBtn}</h4>
          <div class="dash-stat-detail-list">${completedExecs.map(e => `<div class="dash-stat-detail-chip"><span class="chip-dot" style="background:#10b981;"></span>${e.name}</div>`).join('')}
          ${completed.length === 0 ? '<div class="dash-stat-detail-empty">Sin rutas completadas hoy</div>' : ''}</div></div>`;
      } else if (type === 'scheduled') {
        const schedData = window._dashboardScheduleData || {};
        const entries = Object.entries(schedData);
        html = `<div class="dash-stat-detail-panel">
          <h4><span><i data-lucide="calendar-check" style="width:18px;height:18px;color:#8b5cf6;"></i> Rutas programadas (${st.scheduledCount || 0} visitas)</span>${closeBtn}</h4>
          <div class="dash-stat-detail-subtitle">Haz clic en un vendedor para ver su detalle en la tabla</div>
          <div class="dash-stat-detail-list">${entries.map(([uid, info]) => { const days = Object.keys(info.dates).length; const clients = Object.values(info.dates).flat().length; return `<div class="dash-stat-detail-chip" style="cursor:pointer;" onclick="event.stopPropagation();scrollToExecRow('${uid}')"><span class="chip-dot" style="background:#8b5cf6;"></span>${info.userName || 'Sin nombre'} <span style="color:var(--text-muted);font-size:13px;font-weight:400;">${days} días · ${clients} clientes</span><i data-lucide="arrow-down" style="width:14px;height:14px;color:#8b5cf6;margin-left:4px;" title="Ver abajo"></i></div>`; }).join('')}
          ${entries.length === 0 ? '<div class="dash-stat-detail-empty">Sin rutas programadas</div>' : ''}</div></div>`;
      } else if (type === 'fuel') {
        const totalCost = st.totalFuelCost || 0;
        const schedData = window._dashboardScheduleData || {};
        const eff = (window.vehicleConfig && window.vehicleConfig.FUEL_EFFICIENCY_KML) || 10;
        const fp = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1150;
        let details = '';
        Object.entries(schedData).forEach(([uid, info]) => {
          const allR = Object.values(info.dates).flat();
          const _eu = allUsers ? allUsers.find(u => u.id === uid) : null;
          const _sp = (_eu && _eu.home_lat && _eu.home_lng) ? { lat: parseFloat(_eu.home_lat), lng: parseFloat(_eu.home_lng) } : null;
          const km = calcRoutesDistanceKm(allR, _sp);
          const cost = Math.round((km / eff) * fp);
          if (km > 0) details += `<div class="dash-stat-detail-chip" style="cursor:pointer;" onclick="event.stopPropagation();scrollToExecRow('${uid}')"><span class="chip-dot" style="background:#6366f1;"></span>${info.userName || 'Sin nombre'} <span style="font-weight:700;color:#6366f1;font-size:14px;">$${cost.toLocaleString('es-CL')}</span> <span style="color:var(--text-muted);font-size:13px;">(${Math.round(km)} km)</span><i data-lucide="arrow-down" style="width:14px;height:14px;color:#6366f1;margin-left:4px;" title="Ver abajo"></i></div>`;
        });
        html = `<div class="dash-stat-detail-panel">
          <h4><span><i data-lucide="fuel" style="width:18px;height:18px;color:#6366f1;"></i> Desglose costo bencina — Total: <span style="color:#6366f1;">$${Math.round(totalCost).toLocaleString('es-CL')}</span></span>${closeBtn}</h4>
          <div class="dash-stat-detail-subtitle">Rendimiento: ${eff} km/L · Precio: $${fp.toLocaleString('es-CL')}/L · Clic en vendedor para ver detalle</div>
          <div class="dash-stat-detail-list">${details || '<div class="dash-stat-detail-empty">Sin datos de distancia disponibles</div>'}</div></div>`;
      }

      panel.innerHTML = html;
      panel.style.display = 'block';
      lucide.createIcons();
    }

    // =============================================
    // DASHBOARD EXPANDABLE ROWS
    // =============================================
    function toggleDashboardExecDetail(userId, rowEl) {
      const detailRow = document.getElementById('exec-detail-' + userId);
      if (!detailRow) return;
      const isVisible = detailRow.style.display !== 'none';
      if (isVisible) {
        detailRow.style.display = 'none';
        rowEl.classList.remove('expanded');
      } else {
        detailRow.style.display = '';
        rowEl.classList.add('expanded');
        const container = document.getElementById('exec-detail-content-' + userId);
        if (container && !container.dataset.loaded) {
          renderExecDetailContent(userId, container);
          container.dataset.loaded = '1';
        }
      }
      lucide.createIcons();
    }

    function renderExecDetailContent(userId, container) {
      const schedData = window._dashboardScheduleData || {};
      const info = schedData[userId];
      if (!info) { container.innerHTML = '<div style="padding:10px;color:var(--text-muted);">Sin datos</div>'; return; }
      const dates = Object.keys(info.dates).sort();
      const execName = info.userName || 'Sin nombre';
      const efficiency = (window.vehicleConfig && window.vehicleConfig.FUEL_EFFICIENCY_KML) || 10;
      const price = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1150;
      let html = `<div class="exec-detail-header">
        <span class="exec-detail-title-badge"><i data-lucide="map-pin" style="width:16px;height:16px;"></i> Detalle de Rutas — ${execName}</span>
        <button onclick="event.stopPropagation(); goToVendorRoute('${userId}')" class="btn btn-primary" style="font-size:13px;padding:8px 18px;border-radius:8px;font-weight:600;">
          <i data-lucide="calendar" style="width:14px;height:14px;"></i> Ver en Planner Semanal
        </button>
      </div>`;
      const _execU = allUsers ? allUsers.find(u => u.id === userId) : null;
      const _startP = (_execU && _execU.home_lat && _execU.home_lng) ? { lat: parseFloat(_execU.home_lat), lng: parseFloat(_execU.home_lng) } : null;
      dates.forEach((date, idx) => {
        const dayRoutes = (info.dates[date] || []).slice().sort((a, b) => (a.priority || 999) - (b.priority || 999));
        const dayKm = calcRoutesDistanceKm(dayRoutes, _startP);
        const dayCost = Math.round((dayKm / efficiency) * price);
        const dateLabel = new Date(date + 'T12:00:00').toLocaleDateString('es-CL', { weekday:'long', day:'numeric', month:'long' });
        const panelId = 'exec-day-' + userId + '-' + date.replace(/-/g, '');
        html += `<div class="exec-day-bar" onclick="toggleExecDayDetail('${panelId}', this)">
          <div><i data-lucide="chevron-right" class="day-chevron" style="width:13px;height:13px;color:#10b981;"></i> <strong style="text-transform:capitalize;">${dateLabel}</strong> — ${dayRoutes.length} cliente${dayRoutes.length !== 1 ? 's' : ''}</div>
          <div style="display:flex;gap:12px;font-size:12px;color:var(--text-muted);">
            <span>${Math.round(dayKm)} km</span>
            <span>$${dayCost.toLocaleString('es-CL')}</span>
          </div>
        </div>`;
        html += `<div class="exec-day-clients" id="${panelId}" style="display:none;">`;
        dayRoutes.forEach((r, i) => {
          const client = r.client || r;
          const name = client.business_name || client.name || 'Cliente';
          const addr = client.address || '';
          const arrival = r.estimated_arrival || '';
          const lat = client.lat || '';
          const lng = client.lng || '';
          html += `<div class="exec-day-client-item">
            <span class="exec-day-client-num">${i + 1}</span>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
              <div style="font-size:11px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${addr}</div>
            </div>
            ${arrival ? `<span style="font-size:11px;color:var(--primary-color);white-space:nowrap;">${arrival}</span>` : ''}
            ${lat && lng ? `<button onclick="event.stopPropagation(); openWazeToClient(${lat}, ${lng})" style="background:none;border:1px solid rgba(59,130,246,0.25);color:#3b82f6;padding:3px 8px;border-radius:6px;cursor:pointer;font-size:11px;white-space:nowrap;display:inline-flex;align-items:center;gap:3px;" title="Abrir en Waze"><i data-lucide="navigation" style="width:11px;height:11px;"></i> Waze</button>` : ''}
          </div>`;
        });
        html += '</div>';
      });
      container.innerHTML = html;
      lucide.createIcons();
    }

    function toggleExecDayDetail(panelId, headerEl) {
      const panel = document.getElementById(panelId);
      if (!panel) return;
      const isVisible = panel.style.display !== 'none';
      panel.style.display = isVisible ? 'none' : 'block';
      if (isVisible) headerEl.classList.remove('expanded');
      else headerEl.classList.add('expanded');
      lucide.createIcons();
    }

    // ─── Logística CRM Panel ───────────────────────────────────────────────────

    let _crmFiltered = [];
    let _crmPage = 1;
    const CRM_PAGE_SIZE = 50;

    function renderCrmPanel() {
      _crmPage = 1;
      _populateCrmFilters();
      _applyCrmFilter();
    }

    function _populateCrmFilters() {
      const clients = allClients || [];
      // Vendors
      const vendorSel = document.getElementById('crm-vendor-filter');
      if (vendorSel) {
        const vendorNames = [...new Set(clients.map(c => c.assigned_user?.full_name).filter(Boolean))].sort();
        vendorSel.innerHTML = '<option value="">Todos los vendedores</option>' +
          vendorNames.map(n => `<option value="${n}">${n}</option>`).join('');
      }
      // Zones
      const zoneSel = document.getElementById('crm-zone-filter');
      if (zoneSel) {
        const zones = [...new Set(clients.map(c => c.zone || c.commune).filter(Boolean))].sort();
        zoneSel.innerHTML = '<option value="">Todas las zonas</option>' +
          zones.map(z => `<option value="${z}">${z}</option>`).join('');
      }
      // Stats bar
      const total = clients.length;
      const c8020 = clients.filter(c => c.segmentation === '80-20').length;
      const noGps = clients.filter(c => !c.lat || !c.lng).length;
      const sinVendedor = clients.filter(c => !c.assigned_user_id).length;
      const statsBar = document.getElementById('crm-stats-bar');
      if (statsBar) {
        statsBar.innerHTML = `
          <div style="text-align:center;color:white;">
            <div style="font-size:20px;font-weight:700;">${total.toLocaleString('es-CL')}</div>
            <div style="font-size:10px;opacity:0.7;text-transform:uppercase;letter-spacing:0.5px;">Clientes</div>
          </div>
          <div style="text-align:center;color:#fde68a;">
            <div style="font-size:20px;font-weight:700;">⭐ ${c8020.toLocaleString('es-CL')}</div>
            <div style="font-size:10px;opacity:0.8;text-transform:uppercase;letter-spacing:0.5px;">80/20 Clave</div>
          </div>
          <div style="text-align:center;color:#fca5a5;">
            <div style="font-size:20px;font-weight:700;">${noGps.toLocaleString('es-CL')}</div>
            <div style="font-size:10px;opacity:0.8;text-transform:uppercase;letter-spacing:0.5px;">Sin GPS</div>
          </div>
          <div style="text-align:center;color:#a5f3fc;">
            <div style="font-size:20px;font-weight:700;">${sinVendedor.toLocaleString('es-CL')}</div>
            <div style="font-size:10px;opacity:0.8;text-transform:uppercase;letter-spacing:0.5px;">Sin vendedor</div>
          </div>`;
      }
    }

    function _applyCrmFilter() {
      const clients = allClients || [];
      const search = (document.getElementById('crm-search')?.value || '').toLowerCase().trim();
      const vendor = document.getElementById('crm-vendor-filter')?.value || '';
      const zone   = document.getElementById('crm-zone-filter')?.value || '';
      const seg    = document.getElementById('crm-seg-filter')?.value || '';
      const gps    = document.getElementById('crm-gps-filter')?.value || '';

      _crmFiltered = clients.filter(c => {
        if (search) {
          const extId = (c.external_id || '').toLowerCase();
          const name  = (c.fantasy_name || c.name || '').toLowerCase();
          if (!extId.includes(search) && !name.includes(search)) return false;
        }
        if (vendor && (c.assigned_user?.full_name || '') !== vendor) return false;
        if (zone   && (c.zone || c.commune || '') !== zone) return false;
        if (seg    && (c.segmentation || '') !== seg) return false;
        const hasGps = !!(c.lat && c.lng);
        if (gps === 'has' && !hasGps) return false;
        if (gps === 'none' && hasGps) return false;
        return true;
      });

      // Sort: 80-20 first, then L, then rest; within group alphabetically
      const segOrder = { '80-20': 0, 'L': 1 };
      _crmFiltered.sort((a, b) => {
        const sa = segOrder[a.segmentation] ?? 2;
        const sb = segOrder[b.segmentation] ?? 2;
        if (sa !== sb) return sa - sb;
        return (a.fantasy_name || a.name || '').localeCompare(b.fantasy_name || b.name || '');
      });

      _renderCrmTable();
    }

    function _renderCrmTable() {
      const tbody = document.getElementById('crm-clients-body');
      const pagination = document.getElementById('crm-pagination');
      const countLabel = document.getElementById('crm-count-label');
      if (!tbody) return;

      const total = _crmFiltered.length;
      const totalPages = Math.max(1, Math.ceil(total / CRM_PAGE_SIZE));
      if (_crmPage > totalPages) _crmPage = totalPages;
      const start = (_crmPage - 1) * CRM_PAGE_SIZE;
      const page  = _crmFiltered.slice(start, start + CRM_PAGE_SIZE);

      if (countLabel) countLabel.textContent = `${total.toLocaleString('es-CL')} clientes`;

      if (total === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:40px;">No hay clientes que coincidan con los filtros</td></tr>';
        if (pagination) pagination.innerHTML = '';
        return;
      }

      const ZONE_COLORS = {
        'RM': '#6366f1', 'Santiago': '#6366f1',
        'Concepción': '#059669', 'Temuco': '#f59e0b', 'Puerto Montt': '#3b82f6'
      };

      tbody.innerHTML = page.map(c => {
        const vendorName = c.assigned_user?.full_name || '<span style="color:var(--text-muted);font-style:italic;">Sin asignar</span>';
        const zoneName   = c.zone || c.commune || '-';
        const seg        = c.segmentation || '';
        const hasGps     = !!(c.lat && c.lng);
        const addrStatus = c.address_status || (hasGps ? 'auto' : 'pending');

        // Segmentation badge
        let segBadge = '';
        if (seg === '80-20') {
          segBadge = '<span style="font-size:11px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:2px 8px;border-radius:10px;">⭐ 80/20</span>';
        } else if (seg === 'L') {
          segBadge = '<span style="font-size:11px;font-weight:600;background:rgba(37,99,235,0.1);color:#2563eb;border:1px solid rgba(37,99,235,0.25);padding:2px 8px;border-radius:10px;">L Venta</span>';
        } else if (seg === 'N') {
          segBadge = '<span style="font-size:11px;color:var(--text-muted);border:1px solid var(--border);padding:2px 8px;border-radius:10px;">N Nuevo</span>';
        } else {
          segBadge = '<span style="font-size:11px;color:var(--text-muted);">-</span>';
        }

        // Name badge (80/20 inline)
        const nameBadge = seg === '80-20'
          ? '<span style="font-size:9px;font-weight:700;background:rgba(212,175,55,0.2);color:#b8860b;border:1px solid rgba(212,175,55,0.4);padding:1px 5px;border-radius:4px;margin-left:4px;">80/20</span>'
          : '';

        // GPS indicator
        const gpsDot = hasGps
          ? '<span title="Tiene GPS" style="color:#10b981;font-size:16px;">●</span>'
          : '<span title="Sin GPS" style="color:#ef4444;font-size:16px;">●</span>';

        // Address status dot
        const addrDot = addrStatus === 'confirmed'
          ? '<span title="Confirmada" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#10b981;margin-right:4px;vertical-align:middle;"></span>'
          : addrStatus === 'auto'
            ? '<span title="Auto" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#6366f1;margin-right:4px;vertical-align:middle;"></span>'
            : '<span title="Pendiente" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:#f59e0b;margin-right:4px;vertical-align:middle;"></span>';

        const addrText = c.address ? (c.address.length > 28 ? c.address.substring(0, 28) + '…' : c.address) : '-';

        // Zone color chip
        const zoneColor = ZONE_COLORS[zoneName] || '#6b7280';
        const zoneChip = `<span style="font-size:11px;background:${zoneColor}18;color:${zoneColor};border:1px solid ${zoneColor}35;padding:2px 8px;border-radius:10px;font-weight:500;">${zoneName}</span>`;

        return `<tr>
          <td><code style="font-size:11px;background:var(--bg-hover);padding:2px 6px;border-radius:4px;">${c.external_id || '-'}</code></td>
          <td>
            <div style="font-weight:500;">${c.fantasy_name || c.name || '-'}${nameBadge}</div>
            ${c.fantasy_name && c.name ? `<div style="font-size:11px;color:var(--text-muted);">${c.name}</div>` : ''}
          </td>
          <td style="font-size:12px;max-width:160px;">
            <div>${addrDot}${addrText}</div>
            ${c.commune ? `<div style="font-size:10px;color:var(--text-muted);">${c.commune}</div>` : ''}
          </td>
          <td>${zoneChip}</td>
          <td style="font-size:13px;">${vendorName}</td>
          <td>${segBadge}</td>
          <td style="text-align:center;">${gpsDot}</td>
          <td>
            <div style="display:flex;gap:4px;">
              <button class="btn-icon" onclick="openClientModal('${c.id}')" title="Editar cliente">
                <i data-lucide="pencil" style="width:13px;height:13px;"></i>
              </button>
              ${hasGps ? `<button class="btn-icon" title="Ver en Google Maps" onclick="window.open('https://www.google.com/maps?q=${c.lat},${c.lng}','_blank')">
                <i data-lucide="map-pin" style="width:13px;height:13px;"></i>
              </button>` : ''}
            </div>
          </td>
        </tr>`;
      }).join('');

      // Pagination
      if (pagination) {
        const showing = Math.min(start + CRM_PAGE_SIZE, total);
        pagination.innerHTML = `
          <span>Mostrando ${(start + 1).toLocaleString('es-CL')}–${showing.toLocaleString('es-CL')} de ${total.toLocaleString('es-CL')}</span>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="_crmPageGo(${_crmPage - 1})" ${_crmPage <= 1 ? 'disabled' : ''}>‹ Anterior</button>
            <span style="padding:4px 10px;font-size:12px;color:var(--text-secondary);">Pág ${_crmPage}/${totalPages}</span>
            <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="_crmPageGo(${_crmPage + 1})" ${_crmPage >= totalPages ? 'disabled' : ''}>Siguiente ›</button>
          </div>`;
      }
      lucide.createIcons();
    }

    function filterCrmClients() {
      _crmPage = 1;
      _applyCrmFilter();
    }

    function resetCrmFilters() {
      ['crm-search', 'crm-vendor-filter', 'crm-zone-filter', 'crm-seg-filter', 'crm-gps-filter']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      filterCrmClients();
    }

    function _crmPageGo(page) {
      _crmPage = page;
      _renderCrmTable();
      document.getElementById('panel-crm')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function exportCrmCsv() {
      if (!_crmFiltered || _crmFiltered.length === 0) {
        showToast('warning', 'Sin datos', 'No hay clientes para exportar con los filtros actuales');
        return;
      }
      const headers = ['Código', 'Razón Social', 'Nombre Fantasía', 'Dirección', 'Comuna', 'Zona', 'Vendedor', 'Segmentación', 'Segmento', 'GPS Lat', 'GPS Lng', 'Teléfono', 'Email'];
      const rows = _crmFiltered.map(c => {
        const vendor = (allUsers || []).find(u => u.id === c.assigned_user_id);
        return [
          c.external_id || '',
          (c.name || '').replace(/,/g, ' '),
          (c.fantasy_name || '').replace(/,/g, ' '),
          (c.address || '').replace(/,/g, ' '),
          c.commune || '',
          c.zone || '',
          vendor ? vendor.full_name.replace(/,/g, ' ') : '',
          c.segmentation || '',
          c.segment || '',
          c.lat || '',
          c.lng || '',
          c.phone || '',
          c.email || ''
        ].join(',');
      });
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }); // BOM for Excel
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const date = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `clientes_leker_${date}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('success', 'Exportado', `${_crmFiltered.length} clientes exportados`);
    }

    // ─── End Logística CRM Panel ───────────────────────────────────────────────

    // Dashboard data updater
    async function updateRouteDashboard() {
      // Reset stat detail panel and expanded rows
      _activeStatDetail = null;
      const sdp = document.getElementById('dash-stat-detail');
      if (sdp) sdp.style.display = 'none';
      document.querySelectorAll('.route-stat-card').forEach(c => c.classList.remove('active-card'));
      try {
        const todayStr = new Date().toISOString().split('T')[0];
        // End date: 60 days ahead to capture all upcoming scheduled routes
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 60);
        const endStr = endDate.toISOString().split('T')[0];
        // Fetch today's daily routes + ALL scheduled routes in parallel
        const [res, schedRes] = await Promise.all([
          fetch(`${API}/api/daily-routes/today`),
          fetch(`/api/routes/schedule-all?startDate=${todayStr}&endDate=${endStr}`)
        ]);
        const data = await res.json();
        const schedData = await schedRes.json();
        window._dashboardScheduleData = (schedData.success && schedData.data) ? schedData.data : {};
        const routes = (data.success && data.data) ? data.data : [];

        // Scheduled routes for today
        const scheduledExecs = schedData.success ? Object.keys(schedData.data || {}) : [];
        let scheduledCount = 0;
        if (schedData.success && schedData.data) {
          Object.values(schedData.data).forEach(info => {
            Object.values(info.dates).forEach(dayRoutes => { scheduledCount += dayRoutes.length; });
          });
        }

        const activeRoutes = routes.filter(r => r.status === 'active');
        const completedRoutes = routes.filter(r => r.status === 'completed');
        const executivesWithRoute = new Set([...routes.map(r => r.user_id), ...scheduledExecs]);

        // Ensure executives list is loaded (may not be ready if navigated before loadData finishes)
        if (!executives || executives.length === 0) {
          try {
            const usersRes = await fetch(`${API}/api/users`);
            const usersData = await usersRes.json();
            if (usersData.success && usersData.data) {
              if (!allUsers || allUsers.length === 0) allUsers = usersData.data;
              executives = usersData.data.filter(u => u.role === 'executive');
            }
          } catch(e) { /* will use whatever is available */ }
        }
        const totalExecs = executives.length || allUsers.filter(u => u.role === 'executive').length;
        const withoutRoute = Math.max(0, totalExecs - executivesWithRoute.size);

        // Calculate total fuel cost (daily routes + scheduled routes)
        const efficiency = (window.vehicleConfig && window.vehicleConfig.FUEL_EFFICIENCY_KML) || 10;
        const fuelPrice = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1150;
        let totalFuelCost = 0;
        routes.forEach(r => {
          if (r.total_distance) {
            const km = parseFloat(r.total_distance) || 0;
            totalFuelCost += (km / efficiency) * fuelPrice;
          }
        });
        // Add scheduled routes fuel cost
        if (schedData.success && schedData.data) {
          Object.entries(schedData.data).forEach(([_uid, info]) => {
            const allSchedRoutes = Object.values(info.dates).flat();
            const _eu2 = allUsers ? allUsers.find(u => u.id === _uid) : null;
            const _sp2 = (_eu2 && _eu2.home_lat && _eu2.home_lng) ? { lat: parseFloat(_eu2.home_lat), lng: parseFloat(_eu2.home_lng) } : null;
            const schedKm = calcRoutesDistanceKm(allSchedRoutes, _sp2);
            totalFuelCost += (schedKm / efficiency) * fuelPrice;
          });
        }

        // Store dashboard state for stat card drilldown
        window._dashboardState = { routes, activeRoutes, completedRoutes, executivesWithRoute, withoutRoute, totalExecs, scheduledExecs, scheduledCount, totalFuelCost };

        // Update stat cards
        const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
        el('dash-rt-active-vendors', executivesWithRoute.size);
        el('dash-rt-no-route', withoutRoute);
        el('dash-rt-completed', completedRoutes.length);
        el('dash-rt-scheduled', scheduledCount);
        el('dash-rt-fuel-cost', '$' + Math.round(totalFuelCost).toLocaleString('es-CL'));

        // Generate dashboard alerts
        const alertsDiv = document.getElementById('dashboard-route-alerts');
        if (alertsDiv) {
          let alertsHtml = '';
          // Stale routes (active from previous days)
          const staleRoutes = routes.filter(r => r.status === 'active' && r.date && r.date < todayStr);
          staleRoutes.forEach(r => {
            const userName = allUsers.find(u => u.id === r.user_id)?.name || 'Vendedor';
            alertsHtml += `<div class="route-alert-item alert-warning">
              <i data-lucide="alert-triangle" style="width:20px;height:20px;color:#f59e0b;flex-shrink:0;"></i>
              <div style="flex:1;"><strong>${userName}</strong> tiene una ruta sin finalizar del ${r.date}</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button onclick="endRoute('${r.id}')" class="btn" style="background:#f59e0b;color:white;padding:8px 16px;font-size:13px;font-weight:600;border:none;border-radius:8px;cursor:pointer;">Finalizar</button>
                <button onclick="if(confirm('¿Eliminar esta ruta?')) deleteRouteById('${r.id}')" class="btn" style="background:none;border:1px solid rgba(239,68,68,0.3);color:#ef4444;padding:8px 10px;font-size:13px;border-radius:8px;cursor:pointer;" title="Eliminar ruta">
                  <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
                </button>
              </div>
            </div>`;
          });
          // Vendors without route
          if (withoutRoute > 0) {
            alertsHtml += `<div class="route-alert-item alert-info">
              <i data-lucide="info" style="width:20px;height:20px;color:#3b82f6;flex-shrink:0;"></i>
              <div style="flex:1;font-size:14px;"><strong style="font-size:16px;">${withoutRoute}</strong> vendedor(es) sin ruta asignada hoy</div>
              <button onclick="switchRouteTab('gestionar')" class="btn" style="background:#3b82f6;color:white;padding:10px 22px;font-size:14px;font-weight:600;border:none;border-radius:10px;cursor:pointer;box-shadow:0 2px 8px rgba(59,130,246,0.3);"><i data-lucide="plus-circle" style="width:15px;height:15px;vertical-align:-2px;"></i> Asignar Ruta</button>
            </div>`;
          }
          alertsDiv.innerHTML = alertsHtml;
        }

        // Render scheduled routes table
        const schedTableDiv = document.getElementById('dashboard-scheduled-table');
        if (schedTableDiv && schedData.success && schedData.data) {
          const execEntries = Object.entries(schedData.data);
          if (execEntries.length === 0) {
            schedTableDiv.innerHTML = '<div style="padding:32px;text-align:center;color:var(--text-muted);font-size:15px;">No hay rutas programadas</div>';
          } else {
            const colCount = 7;
            let tableHtml = '<table style="width:100%;font-size:14px;"><thead><tr><th style="width:32px;"></th><th style="font-size:13px;">Vendedor</th><th style="font-size:13px;">Días</th><th style="font-size:13px;">Clientes</th><th style="font-size:13px;">KM aprox</th><th style="font-size:13px;">Costo recorrido</th><th style="font-size:13px;">Acciones</th></tr></thead><tbody>';
            execEntries.forEach(([uid, info]) => {
              const dates = Object.keys(info.dates).sort();
              const allRoutes = Object.values(info.dates).flat();
              const clientCount = allRoutes.length;
              const daysCount = dates.length;
              const _eu3 = allUsers ? allUsers.find(u => u.id === uid) : null;
              const _sp3 = (_eu3 && _eu3.home_lat && _eu3.home_lng) ? { lat: parseFloat(_eu3.home_lat), lng: parseFloat(_eu3.home_lng) } : null;
              const km = calcRoutesDistanceKm(allRoutes, _sp3);
              const efficiency = (window.vehicleConfig && window.vehicleConfig.FUEL_EFFICIENCY_KML) || 10;
              const price = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1150;
              const cost = Math.round((km / efficiency) * price);
              const dateRange = daysCount === 1
                ? new Date(dates[0] + 'T12:00:00').toLocaleDateString('es-CL', { day:'numeric', month:'short' })
                : new Date(dates[0] + 'T12:00:00').toLocaleDateString('es-CL', { day:'numeric', month:'short' }) + ' — ' + new Date(dates[dates.length-1] + 'T12:00:00').toLocaleDateString('es-CL', { day:'numeric', month:'short' });
              tableHtml += `<tr class="vendor-route-row" id="dash-row-${uid}" onclick="toggleDashboardExecDetail('${uid}', this)" style="cursor:pointer;">
                <td style="text-align:center;"><i data-lucide="chevron-right" class="chevron-icon" style="width:16px;height:16px;"></i></td>
                <td style="padding:12px 10px;"><strong style="font-size:14px;">${info.userName || 'Sin nombre'}</strong></td>
                <td style="padding:12px 10px;"><span style="font-weight:600;">${daysCount} día${daysCount>1?'s':''}</span> <span style="color:var(--text-muted);font-size:13px;">(${dateRange})</span></td>
                <td style="padding:12px 10px;font-weight:600;font-size:15px;">${clientCount}</td>
                <td style="padding:12px 10px;font-size:14px;">${Math.round(km)} km</td>
                <td style="padding:12px 10px;font-weight:700;color:#6366f1;font-size:15px;">$${cost.toLocaleString('es-CL')}</td>
                <td style="padding:12px 10px;">
                  <div style="display:flex;gap:6px;align-items:center;">
                    <button onclick="event.stopPropagation(); goToVendorGestionar('${uid}')" class="btn" style="font-size:12px;padding:6px 12px;background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.25);color:#6366f1;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;" title="Gestionar ruta">
                      <i data-lucide="route" style="width:13px;height:13px;"></i> Gestionar
                    </button>
                    <button onclick="event.stopPropagation(); deleteExecSchedule('${uid}', '${(info.userName || 'Sin nombre').replace(/'/g, "\\'")}', ${clientCount})" class="btn" style="font-size:12px;padding:6px 12px;background:none;border:1px solid rgba(239,68,68,0.25);color:#ef4444;border-radius:8px;cursor:pointer;" title="Eliminar rutas">
                      <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
                    </button>
                  </div>
                </td>
              </tr>`;
              tableHtml += `<tr class="exec-detail-row" id="exec-detail-${uid}" style="display:none;"><td colspan="${colCount}"><div class="exec-detail-content" id="exec-detail-content-${uid}"></div></td></tr>`;
            });
            tableHtml += '</tbody></table>';
            schedTableDiv.innerHTML = tableHtml;
          }
        }
      } catch (err) {
        console.error('Error updating route dashboard:', err);
      }
      lucide.createIcons();
    }

    function updateDataTabCounts() {
      const usersCount = allUsers.filter(u => u.role !== 'admin').length;
      const vehiclesCount = allVehicles.length;
      const clientsCount = allClients.length;

      // Update tab badges
      const tabUsersCount = document.getElementById('tab-users-count');
      const tabVehiclesCount = document.getElementById('tab-vehicles-count');
      const tabClientsCount = document.getElementById('tab-clients-count');

      if (tabUsersCount) tabUsersCount.textContent = usersCount;
      if (tabVehiclesCount) tabVehiclesCount.textContent = vehiclesCount;
      if (tabClientsCount) tabClientsCount.textContent = clientsCount;
    }

    // =============================================
    // IMPORTACIÓN DE EXCEL
    // =============================================

    async function uploadClientsExcel() {
      const fileInput = document.getElementById('file-clients');
      const resultDiv = document.getElementById('upload-result');

      if (!fileInput.files.length) {
        showToast('warning', 'Sin archivo', 'Selecciona un archivo Excel');
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);

      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<div style="color: var(--accent);"><i data-lucide="loader-2" class="spin" style="width: 16px; height: 16px;"></i> Procesando archivo...</div>';
      lucide.createIcons();

      try {
        const res = await fetch(`${API}/api/upload/clients`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid var(--success);">
              <strong style="color: var(--success);">Importación exitosa</strong><br>
              <span style="font-size: 13px; color: var(--text-secondary);">
                Hoja: ${data.data.sheet}<br>
                Registros procesados: ${data.data.totalRows}<br>
                Insertados/Actualizados: ${data.data.inserted}
              </span>
            </div>
          `;
          showToast('success', 'Importación completada', `${data.data.inserted} clientes importados`);
          fileInput.value = '';
          loadData();
        } else {
          resultDiv.innerHTML = `<div style="color: var(--danger);">Error: ${data.error}</div>`;
          showToast('error', 'Error en importación', data.error);
        }
      } catch (error) {
        resultDiv.innerHTML = `<div style="color: var(--danger);">Error: ${error.message}</div>`;
        showToast('error', 'Error de conexión', error.message);
      }
    }

    // Import Excel by category
    async function importExcelFile() {
      const fileInput = document.getElementById('import-file');
      const category = document.getElementById('import-category').value;
      const mode = document.getElementById('import-mode').value;
      const resultDiv = document.getElementById('import-result');

      if (!fileInput.files.length) {
        showToast('warning', 'Sin archivo', 'Selecciona un archivo Excel');
        return;
      }

      const categoryNames = { clients: 'Clientes', users: 'Vendedores', vehicles: 'Vehículos', products: 'Productos' };
      const modeNames = { upsert: 'Incremental', replace: 'Reemplazo Total' };

      if (mode === 'replace' && !confirm(`¿Estás seguro de hacer un REEMPLAZO TOTAL de ${categoryNames[category]}?\n\nEsto eliminará todos los registros existentes.`)) {
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('category', category);
      formData.append('mode', mode);

      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `<div style="color: var(--accent); display: flex; align-items: center; gap: 8px;">
        <i data-lucide="loader-2" class="spin" style="width: 16px; height: 16px;"></i>
        Procesando ${categoryNames[category]}...
      </div>`;
      lucide.createIcons();

      try {
        const res = await fetch(`${API}/api/upload/${category}`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid var(--success);">
              <strong style="color: var(--success); display: flex; align-items: center; gap: 8px;">
                <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i>
                Importación Exitosa
              </strong>
              <div style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">
                <div>Categoría: <strong>${categoryNames[category]}</strong></div>
                <div>Modo: <strong>${modeNames[mode]}</strong></div>
                <div>Registros procesados: <strong>${data.data.totalRows || 0}</strong></div>
                <div>Insertados/Actualizados: <strong>${data.data.inserted || 0}</strong></div>
                ${data.data.errors?.length > 0 ? `<div style="color: var(--warning);">Errores: ${data.data.errors.length}</div>` : ''}
              </div>
            </div>
          `;
          showToast('success', 'Importación completada', `${data.data.inserted || data.data.totalRows} ${categoryNames[category].toLowerCase()} importados`);
          fileInput.value = '';
          loadData();
          addImportHistory(categoryNames[category], modeNames[mode], data.data.inserted || data.data.totalRows);
        } else {
          resultDiv.innerHTML = `
            <div style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid var(--danger);">
              <strong style="color: var(--danger);">Error en importación</strong>
              <div style="margin-top: 8px; font-size: 13px;">${data.error}</div>
            </div>
          `;
          showToast('error', 'Error en importación', data.error);
        }
        lucide.createIcons();
      } catch (error) {
        resultDiv.innerHTML = `<div style="color: var(--danger);">Error: ${error.message}</div>`;
        showToast('error', 'Error de conexión', error.message);
      }
    }

    // Add to import history (stored in localStorage)
    function addImportHistory(category, mode, count) {
      const history = JSON.parse(localStorage.getItem('importHistory') || '[]');
      history.unshift({
        date: new Date().toLocaleString('es-CL'),
        category,
        mode,
        count
      });
      // Keep only last 10
      localStorage.setItem('importHistory', JSON.stringify(history.slice(0, 10)));
      renderImportHistory();
    }

    function renderImportHistory() {
      const container = document.getElementById('import-history');
      const history = JSON.parse(localStorage.getItem('importHistory') || '[]');

      if (history.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No hay importaciones recientes</div>';
        return;
      }

      container.innerHTML = history.map(h => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
          <div>
            <strong>${h.category}</strong>
            <span class="badge" style="margin-left: 8px; background: var(--bg-hover);">${h.mode}</span>
          </div>
          <div style="text-align: right; font-size: 12px; color: var(--text-muted);">
            <div>${h.count} registros</div>
            <div>${h.date}</div>
          </div>
        </div>
      `).join('');
    }

    // Initialize
    // Submenu navigation
    document.querySelectorAll('.nav-subitem').forEach(item => {
      item.addEventListener('click', () => {
        const tab = item.dataset.tab;
        const subtab = item.dataset.subtab;

        // Update nav items
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.nav-subitem').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.nav-item-expandable').forEach(i => i.classList.remove('has-active-child'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

        item.classList.add('active');
        document.getElementById(`panel-${tab}`).classList.add('active');
        setTimeout(() => item.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 150);

        // Highlight parent expandable and ensure it's open
        const parentExpandable = item.closest('.nav-item-expandable');
        if (parentExpandable) {
          parentExpandable.classList.add('has-active-child');
          if (!parentExpandable.classList.contains('open')) {
            parentExpandable.classList.add('open');
          }
        }

        // Save current tab to localStorage
        localStorage.setItem('leker_active_tab', tab);
        if (subtab) {
          localStorage.setItem('leker_active_subtab', subtab);
        }

        // Switch to subtab
        if (subtab) {
          if (tab === 'gsheets') {
            switchGsheetsTab(subtab);
            if (subtab === 'gs-rendimiento') {
              loadVisitPerformance();
            } else if (subtab === 'gs-vendedores') {
              loadGoogleSheetsData();
              loadVendedorZonesDetail();
              loadVendedorNotasUI();
            } else {
              loadGoogleSheetsData();
            }
          } else {
            switchDataTab(subtab);
          }
        }

        // Update page title
        const subtabTitles = {
          vendedores: 'Vendedores',
          vehiculos: 'Vehículos',
          clientes: 'Clientes',
          productos: 'Productos',
          importar: 'Importar Excel',
          'gs-rendimiento': 'Rendimiento Visitas',
          'gs-ventas': 'Ventas por Mes',
          'gs-cobranzas': 'Cobranzas',
          'gs-vendedores': 'Vendedores / Zonales',
          'gs-8020': 'Análisis 80-20',
          'gs-direcciones': 'Direcciones',
          'gs-reasignacion': 'Reasignación'
        };
        document.getElementById('page-title').textContent = subtabTitles[subtab] || (tab === 'gsheets' ? 'Datos Comerciales' : 'Datos del Sistema');

        // Close sidebar on mobile after navigation
        if (window.innerWidth <= 1024) {
          document.querySelector('.sidebar').classList.remove('open');
          document.getElementById('sidebar-overlay').classList.remove('active');
        }

        lucide.createIcons();
      });
    });

    // Address verification variables
    let selectedClientData = null;
    let addressAutocomplete = null;
    let correctedAddress = null;

    // Initialize Google Places Autocomplete
    function initAddressAutocomplete() {
      const input = document.getElementById('address-search');
      if (!input || !google.maps.places) return;

      addressAutocomplete = new google.maps.places.Autocomplete(input, {
        componentRestrictions: { country: 'cl' },
        fields: ['formatted_address', 'geometry', 'address_components']
      });

      addressAutocomplete.addListener('place_changed', () => {
        const place = addressAutocomplete.getPlace();
        if (place.geometry) {
          correctedAddress = {
            address: place.formatted_address,
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };

          // Extract commune from address components
          const communeComponent = place.address_components?.find(c =>
            c.types.includes('locality') || c.types.includes('administrative_area_level_3')
          );
          if (communeComponent) {
            document.getElementById('address-commune').value = communeComponent.long_name;
            correctedAddress.commune = communeComponent.long_name;
          }

          document.getElementById('new-lat').textContent = correctedAddress.lat.toFixed(6);
          document.getElementById('new-lng').textContent = correctedAddress.lng.toFixed(6);

          // Sync map picker marker
          if (addressMapMarker) {
            addressMapMarker.setPosition({ lat: correctedAddress.lat, lng: correctedAddress.lng });
          }
          if (addressMapPicker) {
            addressMapPicker.panTo({ lat: correctedAddress.lat, lng: correctedAddress.lng });
          }
        }
      });
    }

    // When client is selected, show address verification
    function onClientSelectChange() {
      const clientId = document.getElementById('checkin-client').value;
      const verificationDiv = document.getElementById('address-verification');
      const distanceDiv = document.getElementById('distance-check');

      if (!clientId) {
        verificationDiv.style.display = 'none';
        selectedClientData = null;
        return;
      }

      selectedClientData = allClients.find(c => c.id === clientId);
      if (!selectedClientData) {
        verificationDiv.style.display = 'none';
        return;
      }

      // Show verification section
      verificationDiv.style.display = 'block';

      // Show current address
      const addressText = [
        selectedClientData.address,
        selectedClientData.commune
      ].filter(Boolean).join(', ') || 'Sin dirección registrada';

      document.getElementById('client-address-text').textContent = addressText;

      // Reset correction fields and map picker
      document.getElementById('correct-address-check').checked = false;
      document.getElementById('address-correction-fields').style.display = 'none';
      document.getElementById('address-search').value = '';
      document.getElementById('address-commune').value = '';
      correctedAddress = null;
      addressMapPicker = null;
      addressMapMarker = null;
      const mapDiv = document.getElementById('address-map-picker');
      if (mapDiv) mapDiv.style.display = 'none';

      // Check distance if we have both locations
      checkDistanceToClient();

      lucide.createIcons();
    }

    // Calculate distance between current GPS and client location
    function checkDistanceToClient() {
      const distanceDiv = document.getElementById('distance-check');

      if (!currentGpsPosition || !selectedClientData) {
        distanceDiv.style.display = 'none';
        return;
      }

      if (!selectedClientData.lat || !selectedClientData.lng) {
        distanceDiv.style.display = 'block';
        distanceDiv.style.background = 'rgba(245, 158, 11, 0.1)';
        distanceDiv.style.border = '1px solid var(--warning)';
        distanceDiv.innerHTML = `
          <i data-lucide="alert-triangle" style="width: 14px; height: 14px; color: var(--warning);"></i>
          <span style="color: var(--warning);">Cliente sin coordenadas GPS. Se usará tu ubicación actual.</span>
        `;
        lucide.createIcons();
        return;
      }

      // Calculate distance using Haversine formula
      const distance = calculateDistance(
        currentGpsPosition.lat, currentGpsPosition.lng,
        parseFloat(selectedClientData.lat), parseFloat(selectedClientData.lng)
      );

      distanceDiv.style.display = 'flex';
      distanceDiv.style.alignItems = 'center';
      distanceDiv.style.gap = '8px';

      if (distance < 100) {
        // Within 100m - good
        distanceDiv.style.background = 'rgba(16, 185, 129, 0.1)';
        distanceDiv.style.border = '1px solid var(--success)';
        distanceDiv.innerHTML = `
          <i data-lucide="check-circle" style="width: 14px; height: 14px; color: var(--success);"></i>
          <span style="color: var(--success);">Estás a ${Math.round(distance)}m del cliente - Ubicación correcta</span>
        `;
      } else if (distance < 500) {
        // Between 100m and 500m - warning
        distanceDiv.style.background = 'rgba(245, 158, 11, 0.1)';
        distanceDiv.style.border = '1px solid var(--warning)';
        distanceDiv.innerHTML = `
          <i data-lucide="alert-triangle" style="width: 14px; height: 14px; color: var(--warning);"></i>
          <span style="color: var(--warning);">Estás a ${Math.round(distance)}m del cliente - Verifica la dirección</span>
        `;
      } else {
        // More than 500m - error
        distanceDiv.style.background = 'rgba(239, 68, 68, 0.1)';
        distanceDiv.style.border = '1px solid var(--danger)';
        distanceDiv.innerHTML = `
          <i data-lucide="x-circle" style="width: 14px; height: 14px; color: var(--danger);"></i>
          <span style="color: var(--danger);">Estás a ${distance >= 1000 ? (distance/1000).toFixed(1) + 'km' : Math.round(distance) + 'm'} del cliente - Dirección posiblemente incorrecta</span>
        `;
      }

      lucide.createIcons();
    }

    // Haversine formula to calculate distance between two points
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371000; // Earth's radius in meters
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Map picker variables
    let addressMapPicker = null;
    let addressMapMarker = null;

    function initAddressMapPicker() {
      const mapDiv = document.getElementById('address-map-picker');
      if (!mapDiv || addressMapPicker) return;
      mapDiv.style.display = 'block';

      // Center: GPS position > client coords > Santiago default
      let center = { lat: -33.4489, lng: -70.6693 };
      if (currentGpsPosition) {
        center = { lat: currentGpsPosition.lat, lng: currentGpsPosition.lng };
      } else if (selectedClientData?.lat && selectedClientData?.lng) {
        const clat = parseFloat(selectedClientData.lat);
        const clng = parseFloat(selectedClientData.lng);
        if (!isNaN(clat) && !isNaN(clng) && clat !== 0) {
          center = { lat: clat, lng: clng };
        }
      }

      addressMapPicker = new google.maps.Map(mapDiv, {
        center,
        zoom: 15,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      addressMapMarker = new google.maps.Marker({
        position: center,
        map: addressMapPicker,
        draggable: true,
        title: 'Arrastra para corregir ubicación'
      });

      // Click on map → move marker → reverse geocode
      addressMapPicker.addListener('click', (e) => {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();
        addressMapMarker.setPosition(e.latLng);
        updatePickedLocation(lat, lng);
      });

      // Drag marker end → reverse geocode
      addressMapMarker.addListener('dragend', (e) => {
        const lat = e.latLng.lat();
        const lng = e.latLng.lng();
        updatePickedLocation(lat, lng);
      });
    }

    function updatePickedLocation(lat, lng) {
      correctedAddress = {
        lat: lat,
        lng: lng,
        address: null,
        commune: null
      };

      document.getElementById('new-lat').textContent = lat.toFixed(6);
      document.getElementById('new-lng').textContent = lng.toFixed(6);

      // Move marker and center map if they exist
      if (addressMapMarker) {
        addressMapMarker.setPosition({ lat, lng });
      }
      if (addressMapPicker) {
        addressMapPicker.panTo({ lat, lng });
      }

      // Reverse geocode
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === 'OK' && results[0]) {
          document.getElementById('address-search').value = results[0].formatted_address;
          correctedAddress.address = results[0].formatted_address;

          const communeComponent = results[0].address_components?.find(c =>
            c.types.includes('locality') || c.types.includes('administrative_area_level_3')
          );
          if (communeComponent) {
            document.getElementById('address-commune').value = communeComponent.long_name;
            correctedAddress.commune = communeComponent.long_name;
          }
        }
      });
    }

    // Toggle address correction fields
    function toggleAddressCorrection() {
      const checked = document.getElementById('correct-address-check').checked;
      const fieldsDiv = document.getElementById('address-correction-fields');
      fieldsDiv.style.display = checked ? 'block' : 'none';

      if (checked) {
        if (!addressAutocomplete) {
          setTimeout(initAddressAutocomplete, 100);
        }
        // Initialize map picker
        setTimeout(initAddressMapPicker, 200);
      } else {
        // Hide map and reset
        const mapDiv = document.getElementById('address-map-picker');
        if (mapDiv) mapDiv.style.display = 'none';
        addressMapPicker = null;
        addressMapMarker = null;
      }
    }

    // Use current GPS location as new address
    function useCurrentGpsLocation() {
      if (!currentGpsPosition) {
        showToast('warning', 'Sin GPS', 'No hay ubicación GPS disponible');
        return;
      }

      // Use shared updatePickedLocation to update everything (coords, map, reverse geocode)
      updatePickedLocation(currentGpsPosition.lat, currentGpsPosition.lng);

      showToast('success', 'Ubicación capturada', `${currentGpsPosition.lat.toFixed(4)}, ${currentGpsPosition.lng.toFixed(4)}`);
    }

    // GPS Status monitoring
    let currentGpsPosition = null;

    function updateGpsStatus() {
      const statusDiv = document.getElementById('gps-status');
      if (!statusDiv) return;

      if (!navigator.geolocation) {
        statusDiv.innerHTML = `
          <i data-lucide="x-circle" style="width: 16px; height: 16px; color: var(--danger);"></i>
          <span style="color: var(--danger);">GPS no disponible en este dispositivo</span>
        `;
        lucide.createIcons();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          currentGpsPosition = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy
          };
          statusDiv.style.background = 'rgba(16, 185, 129, 0.1)';
          statusDiv.style.border = '1px solid var(--success)';
          statusDiv.innerHTML = `
            <i data-lucide="navigation" style="width: 16px; height: 16px; color: var(--success);"></i>
            <span style="color: var(--success);">GPS activo</span>
            <span style="color: var(--text-muted); font-size: 11px; margin-left: auto;">
              ${currentGpsPosition.lat.toFixed(5)}, ${currentGpsPosition.lng.toFixed(5)}
              (±${Math.round(currentGpsPosition.accuracy)}m)
            </span>
          `;
          lucide.createIcons();
          // Update distance check if client is selected
          checkDistanceToClient();
        },
        (error) => {
          statusDiv.style.background = 'rgba(245, 158, 11, 0.1)';
          statusDiv.style.border = '1px solid var(--warning)';
          let errorMsg = 'Error de ubicación';
          if (error.code === 1) errorMsg = 'Permiso denegado - habilita ubicación';
          if (error.code === 2) errorMsg = 'Ubicación no disponible';
          if (error.code === 3) errorMsg = 'Tiempo de espera agotado';
          statusDiv.innerHTML = `
            <i data-lucide="alert-triangle" style="width: 16px; height: 16px; color: var(--warning);"></i>
            <span style="color: var(--warning);">${errorMsg}</span>
            <button onclick="updateGpsStatus()" class="btn btn-secondary" style="margin-left: auto; padding: 4px 8px; font-size: 11px;">Reintentar</button>
          `;
          lucide.createIcons();
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    // =============================================
    // GESTIÓN DE USUARIOS Y ROLES
    // =============================================

    let allUsersFiltered = [];

    function renderAllUsersTable() {
      const tbody = document.getElementById('tbody-all-users');
      if (!tbody) return;

      // Update stats
      updateUserStats();

      // Apply filters
      filterAllUsers();
    }

    function filterAllUsers() {
      const roleFilter = document.getElementById('filter-users-role')?.value || '';
      const statusFilter = document.getElementById('filter-users-status')?.value || '';
      const searchTerm = document.getElementById('search-all-users')?.value?.toLowerCase() || '';

      allUsersFiltered = allUsers.filter(user => {
        // Role filter
        if (roleFilter && user.role !== roleFilter) return false;

        // Status filter (for now, all users are considered active)
        // This can be extended when status field is added to users table

        // Search filter
        if (searchTerm) {
          const name = (user.full_name || '').toLowerCase();
          const email = (user.email || '').toLowerCase();
          if (!name.includes(searchTerm) && !email.includes(searchTerm)) return false;
        }

        return true;
      });

      renderUsersTableBody();
    }

    // Role configuration
    const ROLE_CONFIG = {
      admin:      { label: 'Administrador', color: '#374151', permissions: 'Completo', icon: 'shield-check' },
      supervisor: { label: 'Supervisor', color: '#7c3aed', permissions: 'Gestión', icon: 'user-cog' },
      zonal:      { label: 'Zonal', color: '#0891b2', permissions: 'Zona', icon: 'map' },
      executive:  { label: 'Vendedor', color: '#1e40af', permissions: 'Básico', icon: 'briefcase' },
      viewer:     { label: 'Lectura', color: '#059669', permissions: 'Solo ver', icon: 'eye' }
    };

    function getRoleConfig(role) {
      return ROLE_CONFIG[role] || ROLE_CONFIG.executive;
    }

    function renderUsersTableBody() {
      const tbody = document.getElementById('tbody-all-users');
      if (!tbody) return;

      if (allUsersFiltered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">
              <i data-lucide="users" style="width: 40px; height: 40px; margin-bottom: 10px; opacity: 0.3;"></i>
              <div>No se encontraron usuarios</div>
            </td>
          </tr>
        `;
        lucide.createIcons();
        return;
      }

      tbody.innerHTML = allUsersFiltered.map(user => {
        const initials = getInitials(user.full_name);
        const roleConfig = getRoleConfig(user.role);
        const isAdmin = user.role === 'admin';
        const canHaveClients = ['executive', 'supervisor', 'zonal'].includes(user.role);
        const canHaveRoutes = ['executive', 'supervisor', 'zonal'].includes(user.role);

        // Enrich with Google Sheets data
        const gsData = findVendedorData(user.full_name);
        const zona = gsData ? gsData.zona : '';
        const zc = ZONE_COLORS[(zona || '').toLowerCase()] || null;
        const zoneTag = zc ? `<span style="background:${zc.bg};color:${zc.color};border:1px solid ${zc.border};padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${zona}</span>` : '';

        // Count assigned clients
        const assignedClients = allClients.filter(c => c.assigned_user_id === user.id).length;

        // Check if user has active route today
        const hasActiveRoute = allRoutes.some(r => r.user_id === user.id && r.status === 'active');

        const permissionsBadge = `<span style="background: ${roleConfig.color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px;">${roleConfig.permissions}</span>`;

        let statusBadge = '<span style="background: #94a3b8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px;">-</span>';
        if (canHaveRoutes) {
          statusBadge = hasActiveRoute
            ? '<span style="background: #059669; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px;">En ruta</span>'
            : '<span style="background: #94a3b8; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px;">Disponible</span>';
        }

        return `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 36px; height: 36px; background: ${zc ? zc.color : roleConfig.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 13px;">
                  ${initials}
                </div>
                <div>
                  <div style="display:flex;align-items:center;gap:6px;"><span style="font-weight: 500;">${user.full_name}</span>${zoneTag}</div>
                  ${canHaveClients ? `<div style="font-size: 11px; color: var(--text-muted);">${assignedClients} clientes</div>` : ''}
                </div>
              </div>
            </td>
            <td style="color: var(--text-secondary); font-size: 13px;">${gsData && gsData.mail ? gsData.mail : user.email}</td>
            <td>
              <select class="form-control" style="padding: 4px 8px; font-size: 12px; width: 130px;" onchange="changeUserRole('${user.id}', this.value)" ${isAdmin && allUsers.filter(u => u.role === 'admin').length === 1 ? 'disabled title="Debe haber al menos un administrador"' : ''}>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                <option value="supervisor" ${user.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                <option value="zonal" ${user.role === 'zonal' ? 'selected' : ''}>Zonal</option>
                <option value="executive" ${user.role === 'executive' ? 'selected' : ''}>Vendedor</option>
                <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Lectura</option>
              </select>
            </td>
            <td>${permissionsBadge}</td>
            <td>${statusBadge}</td>
            <td style="font-size: 12px; color: var(--text-muted);">-</td>
            <td style="text-align: center;">
              <div style="display: flex; gap: 4px; justify-content: center;">
                ${canHaveRoutes ? `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="showPanel('executives'); setTimeout(() => { document.getElementById('filter-executive')?.querySelectorAll('option').forEach(o => { if(o.value === '${user.id}') o.selected = true; }); filterByExecutive(); }, 100);" title="Ver en mapa">
                  <i data-lucide="map-pin" style="width: 12px; height: 12px;"></i>
                </button>` : ''}
                ${currentUser && currentUser.role === 'admin' ? `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px; color: #6366f1;" onclick="setUserPassword('${user.id}', '${user.full_name.replace(/'/g, "\\'")}')" title="Cambiar Contraseña">
                  <i data-lucide="key" style="width: 12px; height: 12px;"></i>
                </button>` : ''}
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px; color: var(--danger);" onclick="deleteUserConfirm('${user.id}', '${user.full_name}')" ${isAdmin && allUsers.filter(u => u.role === 'admin').length === 1 ? 'disabled title="No se puede eliminar el único administrador"' : ''} title="Eliminar">
                  <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      lucide.createIcons();
    }

    function updateUserStats() {
      const totalUsers = allUsers.length;
      const admins = allUsers.filter(u => u.role === 'admin').length;
      const supervisors = allUsers.filter(u => u.role === 'supervisor').length;
      const zonals = allUsers.filter(u => u.role === 'zonal').length;
      const executives = allUsers.filter(u => u.role === 'executive').length;
      const viewers = allUsers.filter(u => u.role === 'viewer').length;

      document.getElementById('stat-users-total').textContent = totalUsers;
      document.getElementById('stat-users-admin').textContent = admins;
      document.getElementById('stat-users-supervisor').textContent = supervisors;
      document.getElementById('stat-users-zonal').textContent = zonals;
      document.getElementById('stat-users-exec').textContent = executives;
      document.getElementById('stat-users-viewer').textContent = viewers;

      // Update current admin info
      updateCurrentAdminInfo();

      // Render permissions matrix if on users panel
      renderPermissionsMatrix();
    }

    // =============================================
    // PERMISSIONS MATRIX
    // =============================================

    function renderPermissionsMatrix() {
      const container = document.getElementById('permissions-matrix-body');
      if (!container) return;

      const allPanels = Object.keys(PANEL_LABELS);
      const roles = ['admin', 'supervisor', 'zonal', 'executive', 'viewer'];
      const roleHeaders = { admin: 'Admin', supervisor: 'Sup.', zonal: 'Zonal', executive: 'Ejec.', viewer: 'View' };

      let html = `<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
        <thead>
          <tr style="border-bottom: 2px solid var(--border-color);">
            <th style="text-align: left; padding: 8px 12px; font-weight: 600;">Panel</th>
            ${roles.map(r => `<th style="text-align: center; padding: 8px 6px; font-weight: 600; color: ${ROLE_CONFIG[r]?.color || '#333'};">${roleHeaders[r]}</th>`).join('')}
          </tr>
        </thead>
        <tbody>`;

      allPanels.forEach(panel => {
        html += `<tr style="border-bottom: 1px solid var(--border-color);">
          <td style="padding: 8px 12px; font-weight: 500;">${PANEL_LABELS[panel]}</td>`;
        roles.forEach(role => {
          const checked = (ROLE_PANELS[role] || []).includes(panel);
          const isAdmin = role === 'admin';
          html += `<td style="text-align: center; padding: 8px 6px;">
            <input type="checkbox" ${checked ? 'checked' : ''} ${isAdmin ? 'disabled' : ''}
              onchange="toggleRolePanel('${role}', '${panel}', this.checked)"
              style="width: 16px; height: 16px; cursor: ${isAdmin ? 'not-allowed' : 'pointer'}; accent-color: ${ROLE_CONFIG[role]?.color || '#333'};">
          </td>`;
        });
        html += `</tr>`;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    function toggleRolePanel(role, panel, checked) {
      if (role === 'admin') return; // admin always has all panels

      if (checked) {
        if (!ROLE_PANELS[role].includes(panel)) {
          ROLE_PANELS[role].push(panel);
        }
      } else {
        ROLE_PANELS[role] = ROLE_PANELS[role].filter(p => p !== panel);
        // Ensure at least dashboard
        if (!ROLE_PANELS[role].includes('dashboard')) {
          ROLE_PANELS[role].unshift('dashboard');
        }
      }

      // Save to localStorage
      localStorage.setItem('leker_role_panels', JSON.stringify(ROLE_PANELS));

      // Re-apply if current user is affected
      applyRolePermissions();

      showToast('Permisos actualizados', 'success');
    }

    function resetRolePermissions() {
      ROLE_PANELS = JSON.parse(JSON.stringify(DEFAULT_ROLE_PANELS));
      localStorage.removeItem('leker_role_panels');
      renderPermissionsMatrix();
      applyRolePermissions();
      showToast('Permisos restaurados a valores predeterminados', 'success');
    }

    // =============================================
    // INTEGRACIONES N8N
    // =============================================

    function toggleN8nPanel() {
      const panel = document.getElementById('n8n-panel');
      const icon = document.getElementById('n8n-toggle-icon');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        loadN8nWebhookConfig();
        updateWebhookUrls();
        loadN8nApiStatus();
      } else {
        panel.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    async function loadN8nApiStatus() {
      try {
        const res = await fetch(`${API}/api/n8n/status`);
        const data = await res.json();

        const statusEl = document.getElementById('n8n-connection-status');

        if (data.configured) {
          // Try to test connection
          const testRes = await fetch(`${API}/api/n8n/test`);
          const testData = await testRes.json();

          if (testData.success) {
            statusEl.textContent = 'Conectado';
            statusEl.style.background = '#059669';
            loadN8nWorkflows();
          } else {
            statusEl.textContent = 'Error de conexión';
            statusEl.style.background = '#dc2626';
          }

          if (data.apiUrl) {
            document.getElementById('n8n-api-url').value = data.apiUrl;
          }
        } else {
          statusEl.textContent = 'No configurado';
          statusEl.style.background = '#94a3b8';
        }
      } catch (error) {
        console.error('Error loading n8n status:', error);
      }
    }

    async function testN8nApiConnection() {
      const url = document.getElementById('n8n-api-url').value.trim();
      const key = document.getElementById('n8n-api-key').value.trim();

      if (!url) {
        showToast('warning', 'URL requerida', 'Ingresa la URL de tu n8n Cloud');
        return;
      }

      showToast('info', 'Probando conexión...', 'Conectando con n8n');

      try {
        // First save config temporarily
        const saveRes = await fetch(`${API}/api/n8n/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiUrl: url.endsWith('/api/v1') ? url : `${url}/api/v1`,
            apiKey: key
          })
        });

        const saveData = await saveRes.json();

        if (saveData.success && saveData.connectionTest?.success) {
          document.getElementById('n8n-connection-status').textContent = 'Conectado';
          document.getElementById('n8n-connection-status').style.background = '#059669';
          showToast('success', 'Conexión exitosa', 'n8n conectado correctamente');
          loadN8nWorkflows();
        } else {
          document.getElementById('n8n-connection-status').textContent = 'Error';
          document.getElementById('n8n-connection-status').style.background = '#dc2626';
          showToast('error', 'Error de conexión', saveData.connectionTest?.error || 'No se pudo conectar');
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      }
    }

    async function saveN8nApiConfig() {
      const url = document.getElementById('n8n-api-url').value.trim();
      const key = document.getElementById('n8n-api-key').value.trim();

      if (!url || !key) {
        showToast('warning', 'Campos requeridos', 'URL y API Key son necesarios');
        return;
      }

      try {
        const res = await fetch(`${API}/api/n8n/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            apiUrl: url.endsWith('/api/v1') ? url : `${url}/api/v1`,
            apiKey: key
          })
        });

        const data = await res.json();

        if (data.success) {
          showToast('success', 'Configuración guardada', 'n8n configurado correctamente');
          loadN8nApiStatus();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      }
    }

    async function loadN8nWorkflows() {
      const listEl = document.getElementById('n8n-workflows-list');

      try {
        const res = await fetch(`${API}/api/n8n/workflows`);
        const data = await res.json();

        if (data.success && data.data?.data) {
          const workflows = data.data.data;

          if (workflows.length === 0) {
            listEl.innerHTML = `
              <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">
                No hay workflows en n8n
              </div>
            `;
            return;
          }

          listEl.innerHTML = workflows.map(wf => `
            <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 500; font-size: 13px;">${wf.name}</div>
                <div style="font-size: 11px; color: var(--text-muted);">ID: ${wf.id}</div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span style="font-size: 10px; padding: 3px 8px; border-radius: 4px; background: ${wf.active ? '#059669' : '#94a3b8'}; color: white;">
                  ${wf.active ? 'Activo' : 'Inactivo'}
                </span>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px;" onclick="${wf.active ? 'deactivateWorkflow' : 'activateWorkflow'}('${wf.id}')">
                  ${wf.active ? 'Desactivar' : 'Activar'}
                </button>
                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 10px;" onclick="executeWorkflow('${wf.id}')">
                  <i data-lucide="play" style="width: 10px; height: 10px;"></i>
                </button>
              </div>
            </div>
          `).join('');

          lucide.createIcons();
        } else {
          listEl.innerHTML = `
            <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">
              ${data.error || 'Error al cargar workflows'}
            </div>
          `;
        }
      } catch (error) {
        listEl.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">
            Error: ${error.message}
          </div>
        `;
      }
    }

    async function activateWorkflow(workflowId) {
      try {
        const res = await fetch(`${API}/api/n8n/workflows/${workflowId}/activate`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showToast('success', 'Workflow activado', 'El workflow está ahora activo');
          loadN8nWorkflows();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      }
    }

    async function deactivateWorkflow(workflowId) {
      try {
        const res = await fetch(`${API}/api/n8n/workflows/${workflowId}/deactivate`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          showToast('success', 'Workflow desactivado', 'El workflow está ahora inactivo');
          loadN8nWorkflows();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      }
    }

    async function executeWorkflow(workflowId) {
      try {
        showToast('info', 'Ejecutando...', 'Iniciando workflow');

        const res = await fetch(`${API}/api/n8n/workflows/${workflowId}/execute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });

        const data = await res.json();

        if (data.success) {
          showToast('success', 'Workflow ejecutado', 'Revisa los resultados en n8n');
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      }
    }

    function updateWebhookUrls() {
      const baseUrl = window.location.origin;
      document.getElementById('webhook-url-clients').textContent = `${baseUrl}/webhooks/n8n-sync-clients`;
      document.getElementById('webhook-url-products').textContent = `${baseUrl}/webhooks/n8n-sync-products`;
      document.getElementById('webhook-url-users').textContent = `${baseUrl}/webhooks/n8n-sync-users`;
      document.getElementById('webhook-url-prices').textContent = `${baseUrl}/webhooks/n8n-price-update`;
      document.getElementById('webhook-url-comparativo').textContent = `${baseUrl}/webhooks/n8n-comparativo`;
    }

    async function loadN8nWebhookConfig() {
      try {
        const res = await fetch(`${API}/api/webhooks/config`);
        const data = await res.json();

        if (data.success) {
          const config = data.data;
          document.getElementById('n8n-webhook-url').value = config.url || '';
          document.getElementById('n8n-webhook-enabled').checked = config.enabled || false;

          // Set event checkboxes
          const events = config.events || [];
          document.getElementById('evt-route-completed').checked = events.includes('route_completed');
          document.getElementById('evt-visit-registered').checked = events.includes('visit_registered');
          document.getElementById('evt-sync-completed').checked = events.includes('sync_completed');
          document.getElementById('evt-price-alert').checked = events.includes('price_alert');
        }
      } catch (error) {
        console.error('Error loading webhook config:', error);
      }
    }

    async function saveN8nWebhookConfig() {
      const url = document.getElementById('n8n-webhook-url').value.trim();
      const secret = document.getElementById('n8n-webhook-secret').value.trim();
      const enabled = document.getElementById('n8n-webhook-enabled').checked;

      const events = [];
      if (document.getElementById('evt-route-completed').checked) events.push('route_completed');
      if (document.getElementById('evt-visit-registered').checked) events.push('visit_registered');
      if (document.getElementById('evt-sync-completed').checked) events.push('sync_completed');
      if (document.getElementById('evt-price-alert').checked) events.push('price_alert');

      try {
        const res = await fetch(`${API}/api/webhooks/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, secret, events, enabled })
        });

        const data = await res.json();

        if (data.success) {
          showToast('success', 'Configuración guardada', 'Webhook de n8n actualizado');
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
      }
    }

    async function testN8nWebhook() {
      const url = document.getElementById('n8n-webhook-url').value.trim();

      if (!url) {
        showToast('warning', 'URL requerida', 'Ingresa la URL del webhook de n8n');
        return;
      }

      try {
        showToast('info', 'Enviando test...', 'Probando conexión con n8n');

        const res = await fetch(`${API}/api/webhooks/test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();

        if (data.success) {
          showToast('success', 'Test exitoso', 'El webhook respondió correctamente');
        } else {
          showToast('error', 'Test fallido', data.error || 'No se pudo conectar con n8n');
        }
      } catch (error) {
        showToast('error', 'Error', error.message);
      }
    }

    // =============================================
    // COMPARATIVO DE COMPETENCIA
    // =============================================

    let comparativoData = {};
    let currentSourceFilter = 'all';

    // Colores para fuentes de comparativo (LEKER es la principal en azul)
    const SOURCE_COLORS = {
      'LEKER': '#3b82f6',      // Azul - Principal (base de productos)
      'DVP': '#f97316',        // Naranja
      'SODIMAC': '#059669',    // Verde
      'PRODALAM': '#7c3aed',   // Púrpura
      'IMPERIAL': '#dc2626',   // Rojo
      'BOLD': '#0891b2'        // Cyan
    };

    // Colores adicionales para fuentes dinámicas
    const EXTRA_COLORS = ['#6366f1', '#ec4899', '#14b8a6', '#f59e0b', '#8b5cf6', '#ef4444', '#10b981', '#3b82f6'];
    let colorIndex = 0;

    function getSourceColor(source) {
      if (SOURCE_COLORS[source]) return SOURCE_COLORS[source];
      // Asignar color dinámico para fuentes nuevas
      if (!SOURCE_COLORS[source]) {
        SOURCE_COLORS[source] = EXTRA_COLORS[colorIndex % EXTRA_COLORS.length];
        colorIndex++;
      }
      return SOURCE_COLORS[source];
    }

    function toggleComparativoPanel() {
      const panel = document.getElementById('comparativo-panel');
      const icon = document.getElementById('comparativo-toggle-icon');
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        loadComparativoData();
      } else {
        panel.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
      }
    }

    async function loadComparativoData() {
      try {
        // Cargar estadísticas
        const statsRes = await fetch(`${API}/api/comparativo/stats`);
        const statsData = await statsRes.json();

        // Cargar datos completos
        const dataRes = await fetch(`${API}/api/comparativo`);
        const fullData = await dataRes.json();

        if (statsData.success && statsData.data) {
          updateComparativoStats(statsData.data);
          renderComparativoTable(statsData.data);
        }

        if (fullData.success && fullData.data) {
          comparativoData = fullData.data;
          renderSourceFilters(Object.keys(comparativoData));
          renderComparativoChart(statsData.data || []);
          filterComparativoBySource(currentSourceFilter);
        }

      } catch (error) {
        console.error('Error loading comparativo data:', error);
        showToast('error', 'Error', 'No se pudieron cargar los datos del comparativo');
      }
    }

    function updateComparativoStats(stats) {
      const totalProducts = stats.reduce((sum, s) => sum + s.total_productos, 0);
      const sources = stats.length;
      const avgPrice = stats.length > 0
        ? Math.round(stats.reduce((sum, s) => sum + s.precio_promedio, 0) / stats.length)
        : 0;

      // Update intelligence panel
      document.getElementById('comp-total-products').textContent = totalProducts.toLocaleString();
      document.getElementById('comp-sources').textContent = sources;
      document.getElementById('comp-avg-price').textContent = avgPrice > 0 ? `$${avgPrice.toLocaleString()}` : '-';
      document.getElementById('comp-last-update').textContent = 'Hoy';

      // Update dashboard summary
      updateDashboardComparativoSummary(stats);
    }

    function updateDashboardComparativoSummary(stats) {
      const totalProducts = stats.reduce((sum, s) => sum + s.total_productos, 0);
      const sources = stats.length;
      const avgPrice = stats.length > 0
        ? Math.round(stats.reduce((sum, s) => sum + s.precio_promedio, 0) / stats.length)
        : 0;

      // Update dashboard cards
      const dashProducts = document.getElementById('dash-comp-products');
      const dashSources = document.getElementById('dash-comp-sources');
      const dashAvg = document.getElementById('dash-comp-avg');
      const dashBars = document.getElementById('dash-comp-bars');

      if (dashProducts) dashProducts.textContent = totalProducts.toLocaleString();
      if (dashSources) dashSources.textContent = sources;
      if (dashAvg) dashAvg.textContent = avgPrice > 0 ? `$${avgPrice.toLocaleString()}` : '-';

      // Render mini bars
      if (dashBars && stats.length > 0) {
        const maxPrice = Math.max(...stats.map(s => s.precio_promedio || 0));

        dashBars.innerHTML = stats.map(s => {
          const percentage = maxPrice > 0 ? ((s.precio_promedio || 0) / maxPrice) * 100 : 0;
          const color = getSourceColor(s.fuente);
          return `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <span style="width: 70px; font-size: 11px; font-weight: 500;">${s.fuente}</span>
              <div style="flex: 1; height: 18px; background: var(--bg-hover); border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: ${percentage}%; background: ${color};"></div>
              </div>
              <span style="font-size: 10px; width: 55px; text-align: right;">$${(s.precio_promedio || 0).toLocaleString()}</span>
            </div>
          `;
        }).join('');
      } else if (dashBars) {
        dashBars.innerHTML = `<div style="text-align: center; color: var(--text-muted); font-size: 11px; padding: 12px;">Sin datos de competencia</div>`;
      }
    }

    async function loadDashboardComparativoSummary() {
      try {
        const res = await fetch(`${API}/api/comparativo/stats`);
        const data = await res.json();

        if (data.success && data.data) {
          updateDashboardComparativoSummary(data.data);
        }
      } catch (error) {
        console.error('Error loading dashboard comparativo:', error);
      }
    }

    function renderComparativoTable(stats) {
      const tbody = document.getElementById('comparativo-table-body');

      if (!stats || stats.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 40px; text-align: center; color: var(--text-muted);">
              Sin datos. Ejecuta el workflow n8n "LEKER v32 - STOCKS FIX" para obtener datos.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = stats.map(s => `
        <tr style="border-bottom: 1px solid var(--border);">
          <td style="padding: 12px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="width: 10px; height: 10px; border-radius: 50%; background: ${getSourceColor(s.fuente)};"></span>
              <span style="font-weight: 500;">${s.fuente}</span>
            </div>
          </td>
          <td style="padding: 12px; text-align: center;">${s.total_productos}</td>
          <td style="padding: 12px; text-align: right; color: #059669;">$${s.precio_min?.toLocaleString() || '-'}</td>
          <td style="padding: 12px; text-align: right; font-weight: 600;">$${s.precio_promedio?.toLocaleString() || '-'}</td>
          <td style="padding: 12px; text-align: right; color: #dc2626;">$${s.precio_max?.toLocaleString() || '-'}</td>
        </tr>
      `).join('');
    }

    function renderSourceFilters(sources) {
      const filtersEl = document.getElementById('comparativo-source-filters');

      let html = `
        <button class="btn ${currentSourceFilter === 'all' ? 'btn-primary' : 'btn-secondary'}"
                data-source="all" onclick="filterComparativoBySource('all')" style="font-size: 11px; padding: 6px 12px;">
          Todas
        </button>
      `;

      sources.forEach(source => {
        const isActive = currentSourceFilter === source;
        const color = getSourceColor(source);
        html += `
          <button class="btn ${isActive ? '' : 'btn-secondary'}"
                  style="font-size: 11px; padding: 6px 12px; ${isActive ? `background: ${color}; border-color: ${color}; color: white;` : ''}"
                  data-source="${source}" onclick="filterComparativoBySource('${source}')">
            ${source}
          </button>
        `;
      });

      filtersEl.innerHTML = html;
    }

    function filterComparativoBySource(source) {
      currentSourceFilter = source;
      renderSourceFilters(Object.keys(comparativoData));

      const listEl = document.getElementById('comparativo-products-list');

      let products = [];
      if (source === 'all') {
        Object.values(comparativoData).forEach(sourceProducts => {
          products = products.concat(sourceProducts);
        });
      } else {
        products = comparativoData[source] || [];
      }

      if (products.length === 0) {
        listEl.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--text-muted); font-size: 12px;">
            No hay productos para esta fuente
          </div>
        `;
        return;
      }

      // Ordenar por precio
      products.sort((a, b) => (a.precio_neto || 0) - (b.precio_neto || 0));

      listEl.innerHTML = products.map(p => `
        <div style="padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <div style="font-weight: 500; font-size: 13px; margin-bottom: 4px;">${p.nombre}</div>
            <div style="font-size: 11px; color: var(--text-muted); display: flex; gap: 12px;">
              <span style="display: inline-flex; align-items: center; gap: 4px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${getSourceColor(p.fuente)};"></span>
                ${p.fuente}
              </span>
              ${p.tipo ? `<span>${p.tipo}</span>` : ''}
              ${p.espesor ? `<span>${p.espesor}</span>` : ''}
            </div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 16px; font-weight: 700; color: var(--accent);">
              ${p.precio_neto ? `$${p.precio_neto.toLocaleString()}` : '-'}
            </div>
            ${p.precio_anterior && p.precio_anterior !== p.precio_neto ?
              `<div style="font-size: 11px; text-decoration: line-through; color: var(--text-muted);">
                $${p.precio_anterior.toLocaleString()}
              </div>` : ''
            }
          </div>
        </div>
      `).join('');
    }

    function renderComparativoChart(stats) {
      const chartEl = document.getElementById('comparativo-chart');

      if (!stats || stats.length === 0) {
        chartEl.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 260px; color: var(--text-muted); font-size: 13px;">
            <div style="text-align: center;">
              <i data-lucide="bar-chart-2" style="width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
              <p>Sin datos para mostrar</p>
              <p style="font-size: 11px;">Los datos se reciben desde el workflow n8n</p>
            </div>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      // Crear gráfico de barras simple con CSS
      const maxPrice = Math.max(...stats.map(s => s.precio_promedio || 0));

      chartEl.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 16px; height: 100%;">
          <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
            Precio promedio por fuente (últimos 7 días)
          </div>
          ${stats.map(s => {
            const percentage = maxPrice > 0 ? ((s.precio_promedio || 0) / maxPrice) * 100 : 0;
            const color = getSourceColor(s.fuente);
            return `
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 100px; font-size: 12px; font-weight: 500;">${s.fuente}</div>
                <div style="flex: 1; height: 32px; background: var(--bg-hover); border-radius: 4px; overflow: hidden; position: relative;">
                  <div style="height: 100%; width: ${percentage}%; background: ${color}; border-radius: 4px; transition: width 0.5s ease;"></div>
                  <span style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 600;">
                    $${(s.precio_promedio || 0).toLocaleString()}
                  </span>
                </div>
                <div style="width: 50px; text-align: right; font-size: 11px; color: var(--text-muted);">
                  ${s.total_productos} prod
                </div>
              </div>
            `;
          }).join('')}
          <div style="margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
              <span>Total productos monitoreados: ${stats.reduce((sum, s) => sum + s.total_productos, 0)}</span>
              <span>Fuentes: ${stats.length}</span>
            </div>
          </div>
        </div>
      `;
    }

    function updateCurrentAdminInfo() {
      // Find the first admin (current user) - in production this would come from auth
      const currentAdmin = allUsers.find(u => u.role === 'admin');

      if (currentAdmin) {
        const initials = getInitials(currentAdmin.full_name);

        // Update Control Maestro panel
        const avatarEl = document.getElementById('current-admin-avatar');
        const nameEl = document.getElementById('current-admin-name');
        const emailEl = document.getElementById('current-admin-email');

        if (avatarEl) avatarEl.textContent = initials;
        if (nameEl) nameEl.textContent = currentAdmin.full_name;
        if (emailEl) emailEl.textContent = currentAdmin.email;

        // Update sidebar footer
        const sidebarAvatar = document.getElementById('sidebar-admin-avatar');
        const sidebarName = document.getElementById('sidebar-admin-name');

        if (sidebarAvatar) sidebarAvatar.textContent = initials;
        if (sidebarName) sidebarName.textContent = currentAdmin.full_name;
      }
    }

    function openAddUserModal() {
      const modal = document.createElement('div');
      modal.innerHTML = `
        <div class="modal" style="display: flex;">
          <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
          <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
              <h3><i data-lucide="user-plus" style="width: 18px; height: 18px;"></i> Nuevo Usuario</h3>
              <button class="btn-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Nombre Completo *</label>
                <input type="text" id="new-user-name" class="form-control" placeholder="Ej: Juan Pérez">
              </div>
              <div class="form-group">
                <label>Email *</label>
                <input type="email" id="new-user-email" class="form-control" placeholder="juan@empresa.cl">
              </div>
              <div class="form-group">
                <label>Rol</label>
                <select id="new-user-role" class="form-control">
                  <option value="executive">Vendedor - Vendedor/Representante</option>
                  <option value="supervisor">Supervisor - Vendedor Administrador</option>
                  <option value="viewer">Lectura - Solo visualización</option>
                  <option value="admin">Administrador - Control total</option>
                </select>
              </div>
              <div id="role-description" style="background: var(--bg-hover); padding: 12px; border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                <strong>Vendedor:</strong> Gestiona sus propias rutas y clientes asignados.
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
              <button class="btn btn-primary" onclick="createNewUser(this)">Crear Usuario</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      lucide.createIcons();
      document.getElementById('new-user-name').focus();
    }

    async function createNewUser(btn) {
      const modal = btn.closest('.modal');
      const name = document.getElementById('new-user-name').value.trim();
      const email = document.getElementById('new-user-email').value.trim();
      const role = document.getElementById('new-user-role').value;

      if (!name || !email) {
        showToast('warning', 'Campos requeridos', 'Nombre y email son obligatorios');
        return;
      }

      if (!email.includes('@')) {
        showToast('warning', 'Email inválido', 'Ingresa un email válido');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Creando...';

      try {
        const res = await fetch(`${API}/api/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fullName: name, email, role })
        });

        const data = await res.json();

        if (data.success) {
          showToast('success', 'Usuario creado', name);
          modal.remove();
          loadData();
        } else {
          showToast('error', 'Error', data.error);
          btn.disabled = false;
          btn.textContent = 'Crear Usuario';
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
        btn.disabled = false;
        btn.textContent = 'Crear Usuario';
      }
    }

    async function changeUserRole(userId, newRole) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      // Prevent removing last admin
      if (user.role === 'admin' && newRole !== 'admin') {
        const adminCount = allUsers.filter(u => u.role === 'admin').length;
        if (adminCount <= 1) {
          showToast('warning', 'Acción no permitida', 'Debe haber al menos un administrador');
          renderAllUsersTable(); // Reset select
          return;
        }
      }

      try {
        const res = await fetch(`${API}/api/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole })
        });

        const data = await res.json();

        if (data.success) {
          const roleConfig = getRoleConfig(newRole);
          showToast('success', 'Rol actualizado', `${user.full_name} es ahora ${roleConfig.label}`);
          loadData();
        } else {
          showToast('error', 'Error', data.error);
          renderAllUsersTable(); // Reset select
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
        renderAllUsersTable(); // Reset select
      }
    }

    function deleteUserConfirm(userId, userName) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      // Prevent deleting last admin
      if (user.role === 'admin') {
        const adminCount = allUsers.filter(u => u.role === 'admin').length;
        if (adminCount <= 1) {
          showToast('warning', 'Acción no permitida', 'No se puede eliminar el único administrador');
          return;
        }
      }

      const modal = document.createElement('div');
      modal.innerHTML = `
        <div class="modal" style="display: flex;">
          <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
          <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
              <h3 style="color: var(--danger);"><i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i> Eliminar Usuario</h3>
              <button class="btn-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div class="modal-body">
              <p>¿Estás seguro de eliminar a <strong>${userName}</strong>?</p>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Esta acción no se puede deshacer. Si el usuario tiene rutas activas, no se podrá eliminar.</p>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
              <button class="btn" style="background: var(--danger); color: white;" onclick="deleteUserExecute('${userId}', this)">Eliminar</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      lucide.createIcons();
    }

    async function deleteUserExecute(userId, btn) {
      const modal = btn.closest('.modal');
      btn.disabled = true;
      btn.textContent = 'Eliminando...';

      try {
        const res = await fetch(`${API}/api/users/${userId}`, {
          method: 'DELETE'
        });

        const data = await res.json();

        if (data.success) {
          showToast('success', 'Usuario eliminado', 'El usuario ha sido eliminado');
          modal.remove();
          loadData();
        } else {
          showToast('error', 'Error', data.error);
          btn.disabled = false;
          btn.textContent = 'Eliminar';
        }
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
        btn.disabled = false;
        btn.textContent = 'Eliminar';
      }
    }

    // =============================================
    // DASHBOARD SUMMARY FUNCTIONS
    // =============================================

    function renderDashboardRouteSummary() {
      const container = document.getElementById('dash-rutas-summary');
      if (!container) return;

      const activeRoutes = todayRoutesData.filter(r => r.status === 'active');
      if (activeRoutes.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px;"><i data-lucide="route" style="width: 32px; height: 32px; margin-bottom: 8px; opacity: 0.4;"></i><p>No hay rutas activas hoy</p></div>';
        lucide.createIcons();
        return;
      }

      let html = '<div style="display: flex; flex-direction: column; gap: 6px;">';
      activeRoutes.slice(0, 6).forEach(route => {
        const user = allUsers.find(u => u.id === route.user_id);
        const userName = user ? user.full_name : 'Vendedor';
        const initials = userName.split(' ').map(n => n[0] || '').join('').substring(0, 2).toUpperCase();
        const completedVisits = (route.visits || []).filter(v => v.status === 'completed').length;
        const visits = completedVisits || route.visits_count || 0;
        const scheduledToday = (todayScheduledData[route.user_id] || []).length;
        const totalClients = scheduledToday || route.clients?.length || route.total_clients || 0;
        const progress = totalClients > 0 ? Math.round((visits / totalClients) * 100) : 0;
        const gsData = user && gsheetsVendedoresParsed.length > 0 ? gsheetsVendedoresParsed.find(v => v.name && v.name.toLowerCase().includes(userName.split(' ')[0].toLowerCase())) : null;
        const zona = gsData ? gsData.zona : (user?.zone || '');
        const zc = ZONE_COLORS[(zona || '').toLowerCase()] || { bg: 'rgba(139,92,246,0.1)', color: '#8b5cf6', border: 'rgba(139,92,246,0.25)' };
        const progressColor = progress >= 80 ? '#10b981' : progress >= 50 ? '#f59e0b' : '#ef4444';

        html += `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;background:var(--bg-hover);cursor:pointer;" onclick="goToVendorRoute('${route.user_id}')">
          <div style="width:32px;height:32px;border-radius:50%;background:${zc.color};color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;">${initials}</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${userName}</div>
            <div style="display:flex;align-items:center;gap:5px;margin-top:2px;">
              ${zona ? `<span style="background:${zc.bg};color:${zc.color};border:1px solid ${zc.border};padding:1px 5px;border-radius:4px;font-size:9px;font-weight:600;">${zona}</span>` : ''}
              <span style="font-size:11px;color:var(--text-muted);">${visits}/${totalClients} visitas</span>
            </div>
          </div>
          <div style="width:52px;text-align:right;flex-shrink:0;">
            <div style="font-size:13px;font-weight:700;color:${progressColor};">${progress}%</div>
            <div style="height:3px;background:var(--border);border-radius:2px;margin-top:3px;">
              <div style="height:100%;width:${progress}%;background:${progressColor};border-radius:2px;transition:width 0.3s;"></div>
            </div>
          </div>
        </div>`;
      });

      if (activeRoutes.length > 6) {
        html += `<div style="text-align: center; font-size: 12px; color: var(--text-muted); padding: 4px;">+${activeRoutes.length - 6} rutas más</div>`;
      }
      html += '</div>';
      container.innerHTML = html;
      lucide.createIcons();
    }

    function renderDashboardSummary() {
      // --- Ventas Summary ---
      const ventasContainer = document.getElementById('dash-ventas-summary');
      if (ventasContainer && gsheetsAllVentas && gsheetsAllVentas.length > 1) {
        const headers = gsheetsAllVentas[0];
        const vendedorIdx = headers.findIndex(h => h && (h.toLowerCase().includes('vendedor') || h.toLowerCase().includes('ejecutivo')));
        const montoIdx = headers.findIndex(h => h && (h.toLowerCase().includes('monto') || h.toLowerCase().includes('venta') || h.toLowerCase().includes('total')));

        if (vendedorIdx >= 0 && montoIdx >= 0) {
          const salesByVendor = {};
          gsheetsAllVentas.slice(1).forEach(row => {
            const vendor = row[vendedorIdx];
            const monto = parseFloat(String(row[montoIdx] || '0').replace(/[$.,\s]/g, '')) || 0;
            if (vendor) {
              salesByVendor[vendor] = (salesByVendor[vendor] || 0) + monto;
            }
          });

          const sorted = Object.entries(salesByVendor).sort((a, b) => b[1] - a[1]).slice(0, 5);
          const maxVal = sorted.length > 0 ? sorted[0][1] : 1;

          let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
          sorted.forEach(([vendor, total], i) => {
            const pct = Math.round((total / maxVal) * 100);
            html += `<div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span style="font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%;">${i + 1}. ${vendor}</span>
                <span style="font-size: 12px; font-weight: 700; color: #10b981;">$${total.toLocaleString('es-CL')}</span>
              </div>
              <div style="height: 6px; background: var(--border); border-radius: 3px;">
                <div style="height: 100%; width: ${pct}%; background: linear-gradient(90deg, #10b981, #059669); border-radius: 3px;"></div>
              </div>
            </div>`;
          });
          html += '</div>';
          ventasContainer.innerHTML = html;
        } else {
          ventasContainer.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Datos de ventas sin columnas reconocibles</div>';
        }
      } else if (ventasContainer) {
        ventasContainer.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Sin datos de ventas disponibles</div>';
      }

      // --- 80-20 Stat (unique codes only) ---
      const stat8020 = document.getElementById('stat-8020');
      if (stat8020 && gs8020VendClean && gs8020VendClean.length > 1) {
        const _codeCol8020 = findCodeColumn(gs8020VendClean[0]);
        const _codes8020 = new Set();
        gs8020VendClean.slice(1).forEach(row => {
          const code = String(row[_codeCol8020] || '').trim();
          if (code && code !== '0') _codes8020.add(code);
        });
        stat8020.textContent = _codes8020.size;
      }

      // --- Cobranzas Vencidas Stat + Summary ---
      const statCobranzas = document.getElementById('stat-cobranzas-vencidas');
      const cobranzasContainer = document.getElementById('dash-cobranzas-summary');
      const cobranzasBadge = document.getElementById('dash-cobranzas-badge');

      if (gsheetsAllCobranzas && gsheetsAllCobranzas.length > 1) {
        const headers = gsheetsAllCobranzas[0];
        const clienteIdx = headers.findIndex(h => h && (h.toLowerCase().includes('cliente') || h.toLowerCase().includes('razón') || h.toLowerCase().includes('razon')));
        const montoIdx = headers.findIndex(h => h && (h.toLowerCase().includes('monto') || h.toLowerCase().includes('saldo') || h.toLowerCase().includes('deuda')));
        const vencIdx = headers.findIndex(h => h && (h.toLowerCase().includes('venc') || h.toLowerCase().includes('fecha')));
        const diasIdx = headers.findIndex(h => h && (h.toLowerCase().includes('días') || h.toLowerCase().includes('dias') || h.toLowerCase().includes('atraso')));

        // Count vencidas (rows with dias > 0 or status vencida)
        let vencidasRows = [];
        gsheetsAllCobranzas.slice(1).forEach(row => {
          const dias = diasIdx >= 0 ? parseInt(String(row[diasIdx] || '0').replace(/[^\d-]/g, '')) : 0;
          if (dias > 0) {
            vencidasRows.push({
              cliente: clienteIdx >= 0 ? row[clienteIdx] : '-',
              monto: montoIdx >= 0 ? row[montoIdx] : '-',
              dias: dias
            });
          }
        });

        // If no dias column, count all rows as pending
        if (diasIdx < 0) {
          vencidasRows = gsheetsAllCobranzas.slice(1).map(row => ({
            cliente: clienteIdx >= 0 ? row[clienteIdx] : '-',
            monto: montoIdx >= 0 ? row[montoIdx] : '-',
            dias: 0
          }));
        }

        if (statCobranzas) statCobranzas.textContent = vencidasRows.length;
        if (cobranzasBadge && vencidasRows.length > 0) {
          cobranzasBadge.textContent = vencidasRows.length;
          cobranzasBadge.style.display = 'inline';
        }

        if (cobranzasContainer) {
          const top5 = vencidasRows.sort((a, b) => b.dias - a.dias).slice(0, 5);
          if (top5.length === 0) {
            cobranzasContainer.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Sin cobranzas vencidas</div>';
          } else {
            let html = '<div style="display: flex; flex-direction: column;">';
            top5.forEach(item => {
              const diasColor = item.dias > 60 ? '#ef4444' : item.dias > 30 ? '#f59e0b' : '#6b7280';
              html += `<div style="display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid var(--border);">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.cliente}</div>
                  <div style="font-size: 11px; color: var(--text-muted);">${item.monto}</div>
                </div>
                ${item.dias > 0 ? `<span style="font-size: 11px; font-weight: 700; color: ${diasColor}; background: ${diasColor}15; padding: 2px 8px; border-radius: 10px; white-space: nowrap;">${item.dias}d</span>` : ''}
              </div>`;
            });
            html += '</div>';
            cobranzasContainer.innerHTML = html;
          }
        }
      } else {
        if (statCobranzas) statCobranzas.textContent = '-';
        if (cobranzasContainer) cobranzasContainer.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Sin datos de cobranzas</div>';
      }

      // --- Zonas Summary ---
      const zonasContainer = document.getElementById('dash-zonas-summary');
      if (zonasContainer && gsheetsVendedoresParsed && gsheetsVendedoresParsed.length > 0) {
        const ZONAS = ['Zona Norte', 'Zona Centro', 'Zona Centro Sur', 'Zona Sur'];
        let html = '';
        ZONAS.forEach(zona => {
          const zc = ZONE_COLORS[zona.toLowerCase()] || { bg: 'var(--bg-hover)', color: 'var(--text-muted)', border: 'var(--border)', icon: 'map-pin' };
          const vendedoresInZone = gsheetsVendedoresParsed.filter(v => v.zona === zona && !v.isZonal);
          const clientsInZone = allClients.filter(c => {
            const assignedUser = allUsers.find(u => u.id === c.assigned_user_id);
            if (!assignedUser) return false;
            const vendedor = gsheetsVendedoresParsed.find(v => v.name && v.name.toLowerCase().includes(assignedUser.full_name.toLowerCase()));
            return vendedor && vendedor.zona === zona;
          });

          const clients8020Zone = clientsInZone.filter(c => c.segmentation === '80-20');
          const pct8020 = clientsInZone.length > 0 ? Math.round(clients8020Zone.length / clientsInZone.length * 100) : 0;
          html += `<div style="background: ${zc.bg}; border: 1px solid ${zc.border}; border-radius: 10px; padding: 12px; text-align: center; cursor: pointer;" onclick="document.querySelector('[data-tab=gsheets][data-subtab=gs-vendedores]')?.click()">
            <i data-lucide="${zc.icon || 'map-pin'}" style="width: 18px; height: 18px; color: ${zc.color}; margin-bottom: 4px;"></i>
            <div style="font-size: 11px; font-weight: 700; color: ${zc.color}; margin-bottom: 4px;">${zona.replace('Zona ', '')}</div>
            <div style="font-size: 18px; font-weight: 800; color: ${zc.color}; line-height: 1;">${vendedoresInZone.length}</div>
            <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">vendedores</div>
            <div style="font-size: 11px; font-weight: 600; color: var(--text-secondary);">${clientsInZone.length} clientes</div>
            ${clients8020Zone.length > 0 ? `<div style="margin-top: 4px; display: inline-flex; align-items: center; gap: 3px; background: rgba(212,175,55,0.15); border: 1px solid rgba(212,175,55,0.35); border-radius: 5px; padding: 2px 6px;">
              <span style="font-size: 10px; font-weight: 700; color: #b8860b;">⭐ ${clients8020Zone.length} 80/20</span>
              <span style="font-size: 9px; color: var(--text-muted);">(${pct8020}%)</span>
            </div>` : ''}
          </div>`;
        });
        zonasContainer.innerHTML = html;
        lucide.createIcons();
      }

      lucide.createIcons();
    }

    // =============================================
    // GOOGLE SHEETS DATA PANEL
    // =============================================

    let gsheetsData = null;
    let gsheetsLoaded = false;
    let gsheetsAllVentas = [];
    let gsheetsAllCobranzas = [];
    let gsheetsAllDirecciones = [];

    function switchGsheetsTab(tabName) {
      document.querySelectorAll('#panel-gsheets .data-tab').forEach(t => {
        t.classList.remove('active');
        if (t.dataset.gstab === tabName) t.classList.add('active');
      });
      document.querySelectorAll('#panel-gsheets .data-subpanel').forEach(p => p.classList.remove('active'));
      const sub = document.getElementById(`gs-subpanel-${tabName}`);
      if (sub) sub.classList.add('active');

      // Lazy-load data per tab
      if (tabName === 'gs-rendimiento') {
        loadVisitPerformance();
      } else if (tabName === 'gs-vendedores') {
        loadVendedorZonesDetail();
        loadVendedorNotasUI();
      } else if (tabName === 'gs-direcciones') {
        // Load from DB (Supabase) as primary source
        initDireccionesFromDB();
      }

      lucide.createIcons();
    }

    // Progress helper for GSheets loader
    let _gsCurrentStep = '';
    function _gsLoadProgress(pct, step, detail) {
      const bar = document.getElementById('gs-load-bar');
      const pctEl = document.getElementById('gs-load-percent');
      const stepEl = document.getElementById('gs-load-step');
      const detailEl = document.getElementById('gs-load-detail');
      if (bar) bar.style.width = pct + '%';
      if (pctEl) pctEl.textContent = Math.round(pct) + '%';
      if (stepEl && step) stepEl.textContent = step;
      if (detailEl && detail) detailEl.textContent = detail;

      // Update step checklist
      let activeStep = 'connect';
      if (pct >= 10) activeStep = 'download';
      if (pct >= 70) activeStep = 'process';
      if (pct >= 88) activeStep = 'render';
      if (activeStep !== _gsCurrentStep) {
        _gsCurrentStep = activeStep;
        const stepsContainer = document.getElementById('gs-load-steps');
        if (stepsContainer) {
          const steps = ['connect', 'download', 'process', 'render'];
          const activeIdx = steps.indexOf(activeStep);
          steps.forEach((s, i) => {
            const el = stepsContainer.querySelector(`[data-step="${s}"]`);
            if (!el) return;
            const dot = el.querySelector('div:first-child');
            if (i < activeIdx) {
              // Completed
              el.style.opacity = '1';
              el.style.color = '#10b981';
              dot.style.borderColor = '#10b981';
              dot.style.background = '#10b981';
              dot.innerHTML = '<i data-lucide="check" style="width:10px;height:10px;color:white;"></i>';
            } else if (i === activeIdx) {
              // Active
              el.style.opacity = '1';
              el.style.color = 'var(--accent)';
              el.style.fontWeight = '600';
              dot.style.borderColor = 'var(--accent)';
              dot.innerHTML = '<div style="width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 1s ease-in-out infinite;"></div>';
            } else {
              // Pending
              el.style.opacity = '0.4';
              el.style.color = 'var(--text-muted)';
              el.style.fontWeight = 'normal';
            }
          });
          try { lucide.createIcons(); } catch(e) {}
        }
      }
    }

    // Cache key for sessionStorage
    const GS_CACHE_KEY = 'leker_gsheets_cache';
    const GS_CACHE_TS_KEY = 'leker_gsheets_ts';
    let _gsScriptUrl = null; // Fetched from backend

    function _gsCacheGet() {
      try {
        const raw = sessionStorage.getItem(GS_CACHE_KEY);
        const ts = sessionStorage.getItem(GS_CACHE_TS_KEY);
        if (raw && ts) return { data: JSON.parse(raw), ts: parseInt(ts) };
      } catch (e) { /* cache miss */ }
      return null;
    }

    function _gsCacheSet(data) {
      try {
        sessionStorage.setItem(GS_CACHE_KEY, JSON.stringify(data));
        sessionStorage.setItem(GS_CACHE_TS_KEY, String(Date.now()));
      } catch (e) { /* storage full — ignore */ }
    }

    /**
     * Fetch Google Sheets data through backend API
     */
    async function _gsFetchViaBackend() {
      const res = await fetch(`${API}/api/gsheets/all`);
      const result = await res.json();
      if (!result.success) throw new Error(result.error || 'Error desconocido');
      return result.data;
    }

    async function loadGoogleSheetsData(forceRefresh = false, initialLoad = false) {
      if (gsheetsLoaded && !forceRefresh) return;

      const loading = document.getElementById('gs-loading');
      const content = document.getElementById('gs-content');
      const notConfigured = document.getElementById('gs-not-configured');
      const errorDiv = document.getElementById('gs-error');
      const refreshBtn = document.getElementById('gs-refresh-btn');

      // Check if configured + get script URL
      _gsLoadProgress(5, 'Verificando configuración...', 'Conectando...');
      try {
        const statusRes = await fetch(`${API}/api/gsheets/status`);
        const statusData = await statusRes.json();
        if (!statusData.configured) {
          if (loading) loading.style.display = 'none';
          if (content) content.style.display = 'none';
          if (errorDiv) errorDiv.style.display = 'none';
          if (notConfigured) notConfigured.style.display = 'block';
          if (initialLoad) updateDashLoadingProgress(100, 'Listo (Google Sheets no configurado)');
          lucide.createIcons();
          return;
        }
        if (statusData.scriptUrl) _gsScriptUrl = statusData.scriptUrl;
      } catch (e) {
        // continue to try loading anyway
      }

      // Try loading from sessionStorage cache first (instant)
      const cached = _gsCacheGet();
      const cacheAge = cached ? (Date.now() - cached.ts) / 1000 : Infinity;
      if (cached && !forceRefresh && cacheAge < 600) {
        // Cache is < 10 min old — use it instantly
        _gsLoadProgress(50, 'Cargando desde caché...', 'Datos recientes disponibles');
        gsheetsData = cached.data;
        gsheetsLoaded = true;

        if (loading) loading.style.display = 'none';
        if (content) content.style.display = 'block';
        if (errorDiv) errorDiv.style.display = 'none';

        renderAllGsheetsData(gsheetsData);
        _gsLoadProgress(100, 'Listo', `Desde caché (${Math.round(cacheAge / 60)} min)`);

        if (initialLoad) {
          updateDashLoadingProgress(95, 'Renderizando dashboard...');
          renderDashboardSummary();
          updateDashLoadingProgress(100, 'Dashboard listo');
        }
        lucide.createIcons();

        // Auto-generate geo links in background (silent)
        setTimeout(() => batchGenerateGeoLinks(false), 2000);

        // Background refresh if cache > 3 min
        if (cacheAge > 180) {
          _gsFetchViaBackend().then(data => {
            gsheetsData = data;
            _gsCacheSet(data);
            renderAllGsheetsData(gsheetsData);
            showToast('info', 'Actualizado', 'Datos actualizados en segundo plano');
          }).catch(() => { /* silent fail for background refresh */ });
        }
        return;
      }

      if (loading) loading.style.display = 'block';
      if (content) content.style.display = 'none';
      if (notConfigured) notConfigured.style.display = 'none';
      if (errorDiv) errorDiv.style.display = 'none';
      if (refreshBtn) { refreshBtn.disabled = true; refreshBtn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width:16px;height:16px;"></i> Cargando...'; }
      lucide.createIcons();

      _gsLoadProgress(10, 'Conectando con Google Sheets...', 'Solicitando datos...');
      if (initialLoad) updateDashLoadingProgress(65, 'Descargando datos de Google Sheets...');

      // Animate progress while waiting for fetch
      let fakePct = 10;
      let _fetchDone = false;
      const fakeInterval = setInterval(() => {
        if (_fetchDone) return;
        const remaining = 92 - fakePct;
        fakePct += remaining * 0.04 + 0.3;
        fakePct = Math.min(fakePct, 92);
        const pct = Math.round(fakePct);

        if (pct < 20) {
          _gsLoadProgress(pct, 'Conectando con Google Sheets...', 'Estableciendo conexión...');
        } else if (pct < 35) {
          _gsLoadProgress(pct, 'Descargando hojas de datos...', 'Ventas, Cobranzas...');
        } else if (pct < 50) {
          _gsLoadProgress(pct, 'Descargando hojas de datos...', 'Vendedores, Zonales...');
        } else if (pct < 65) {
          _gsLoadProgress(pct, 'Descargando direcciones...', '~7,800 registros...');
        } else if (pct < 80) {
          _gsLoadProgress(pct, 'Recibiendo datos...', 'Descarga en progreso...');
        } else {
          _gsLoadProgress(pct, 'Recibiendo datos...', 'Casi listo...');
        }
      }, 500);

      try {
        const data = await _gsFetchViaBackend();

        _fetchDone = true;
        clearInterval(fakeInterval);
        _gsLoadProgress(93, 'Datos recibidos', 'Procesando...');

        _gsLoadProgress(82, 'Procesando datos comerciales...', 'Organizando hojas...');
        if (initialLoad) updateDashLoadingProgress(80, 'Procesando datos comerciales...');

        gsheetsData = data;
        gsheetsLoaded = true;
        _gsCacheSet(data); // Save to cache for instant reload next time

        _gsLoadProgress(90, 'Renderizando tablas...', 'Generando vistas...');
        await new Promise(r => setTimeout(r, 200));

        if (loading) loading.style.display = 'none';
        if (content) content.style.display = 'block';

        renderAllGsheetsData(gsheetsData);
        _gsLoadProgress(100, 'Listo', 'Completado');

        if (initialLoad) {
          updateDashLoadingProgress(95, 'Renderizando dashboard...');
          renderDashboardSummary();
          updateDashLoadingProgress(100, 'Dashboard listo');
        }

        if (!initialLoad) showToast('success', 'Datos cargados', 'Google Sheets sincronizado correctamente');

        // Auto-generate geo links in background (silent)
        setTimeout(() => batchGenerateGeoLinks(false), 2000);
      } catch (error) {
        _fetchDone = true;
        clearInterval(fakeInterval);

        // If fetch failed but we have stale cache, use it
        if (cached) {
          _gsLoadProgress(80, 'Usando caché anterior...', 'No se pudo descargar nueva data');
          gsheetsData = cached.data;
          gsheetsLoaded = true;
          if (loading) loading.style.display = 'none';
          if (content) content.style.display = 'block';
          renderAllGsheetsData(gsheetsData);
          _gsLoadProgress(100, 'Listo (caché)', `Última actualización: ${new Date(cached.ts).toLocaleTimeString('es-CL')}`);
          if (initialLoad) {
            updateDashLoadingProgress(95, 'Renderizando dashboard...');
            renderDashboardSummary();
            updateDashLoadingProgress(100, 'Dashboard listo');
          }
          showToast('warning', 'Sin conexión', 'Usando datos en caché. Los cambios recientes pueden no aparecer.');
        } else {
          _gsLoadProgress(100, 'Error al cargar', error.message);
          if (loading) loading.style.display = 'none';
          if (errorDiv) {
            errorDiv.style.display = 'block';
            const errMsg = document.getElementById('gs-error-msg');
            if (errMsg) errMsg.textContent = error.message;
          }
          if (initialLoad) {
            updateDashLoadingProgress(100, 'Listo (sin Google Sheets)');
          } else {
            showToast('error', 'Error', 'No se pudieron cargar datos de Google Sheets');
          }
        }
      } finally {
        if (refreshBtn) { refreshBtn.disabled = false; refreshBtn.innerHTML = '<i data-lucide="refresh-cw" style="width:16px;height:16px;"></i> Actualizar Datos'; }
        lucide.createIcons();
      }
    }

    function findSheetData(data, namePatterns) {
      if (!data) return null;
      // data could be an object with sheet names as keys or an array
      if (Array.isArray(data)) {
        // Array of {name, data} objects
        for (const pattern of namePatterns) {
          const found = data.find(s => s.name && s.name.toLowerCase().includes(pattern.toLowerCase()));
          if (found) return found.data || found.rows || found;
        }
      } else {
        // Object with sheet names as keys
        for (const pattern of namePatterns) {
          for (const key of Object.keys(data)) {
            if (key.toLowerCase().includes(pattern.toLowerCase())) {
              return data[key];
            }
          }
        }
      }
      return null;
    }

    // Find real header row in sheet data (skip empty/decorative rows)
    function cleanSheetData(data) {
      if (!data || data.length === 0) return data;
      for (let i = 0; i < Math.min(data.length, 10); i++) {
        const nonEmpty = data[i].filter(c => c !== '' && c != null).length;
        if (nonEmpty >= 2) return data.slice(i);
      }
      return data;
    }

    function renderAllGsheetsData(data) {
      // Log sheet names for debugging
      if (Array.isArray(data)) {
        console.log('[GSheets] Hojas encontradas:', data.map(s => s.name));
      } else if (data && typeof data === 'object') {
        console.log('[GSheets] Hojas encontradas:', Object.keys(data));
      }

      // Find and render each sheet
      const ventas = findSheetData(data, ['ventas por mes', 'ventas']);
      const cobranzas = findSheetData(data, ['cobranza']);
      const vendedores = findSheetData(data, ['vendedores', 'zonales']);
      const v8020 = findSheetData(data, ['80-20 vendedores', '80-20 vend', '80-20', '80/20', 'pareto', 'analisis 80']);
      const z8020 = findSheetData(data, ['80-20 zonales', '80-20 zon', '80-20 zonal']);
      const direcciones = findSheetData(data, ['direcciones validadas']);
      const direccionesRaw = findSheetData(data, ['direccion']);
      const reasignacion = findSheetData(data, ['reasignacion', 'reasignación']);
      const codClientes = findSheetData(data, ['cod. clientes', 'cod clientes', 'codigos']);
      const tablaDinamica = findSheetData(data, ['tabla dinámica', 'tabla dinamica']);

      renderGsheetsVentas(ventas);
      renderGsheetsCobranzas(cobranzas);
      renderGsheetsVendedores(vendedores);
      renderGsheets8020(v8020, z8020);
      renderGsheetsDirecciones(direccionesRaw, direcciones);
      renderGsheetsReasignacion(reasignacion);

      // Update tab badges with row counts
      function setBadge(id, data) {
        const el = document.getElementById(id);
        if (el && data && data.length > 1) el.textContent = data.length - 1;
        else if (el) el.textContent = '';
      }
      setBadge('gs-badge-ventas', ventas);
      setBadge('gs-badge-cobranzas', cobranzas);
      setBadge('gs-badge-vendedores', vendedores);
      setBadge('gs-badge-8020', v8020);
      setBadge('gs-badge-direcciones', direccionesRaw);
      setBadge('gs-badge-reasignacion', reasignacion);
      console.log('[GSheets] 80-20 vendedores:', v8020 ? (v8020.length - 1) + ' rows' : 'NO ENCONTRADA');
      console.log('[GSheets] 80-20 zonales:', z8020 ? (z8020.length - 1) + ' rows' : 'NO ENCONTRADA');

      // Update dashboard summary with fresh data
      renderDashboardSummary();
    }

    function sheetToTable(rows, containerId, opts = {}) {
      const container = document.getElementById(containerId);
      if (!rows || rows.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">Sin datos disponibles</p>';
        return [];
      }

      const headers = rows[0];
      const dataRows = rows.slice(1).filter(r => r.some(cell => cell !== '' && cell != null));

      if (opts.maxRows && dataRows.length > opts.maxRows && !opts.showAll) {
        const pageSize = opts.maxRows || 100;
        const page = opts.page || 0;
        const start = page * pageSize;
        const pageRows = dataRows.slice(start, start + pageSize);
        const totalPages = Math.ceil(dataRows.length / pageSize);

        let html = buildTableHtml(headers, pageRows, opts);
        html += `<div class="gs-pagination">
          <span class="gs-pagination-info">Mostrando ${start + 1}-${Math.min(start + pageSize, dataRows.length)} de ${dataRows.length} registros</span>
          <div class="gs-pagination-controls">
            ${page > 0 ? `<button onclick="gsPageTable('${containerId}', ${page - 1}, '${opts.storeKey || ''}')">Anterior</button>` : ''}
            <span class="gs-pagination-page">Pag. ${page + 1} / ${totalPages}</span>
            ${page < totalPages - 1 ? `<button onclick="gsPageTable('${containerId}', ${page + 1}, '${opts.storeKey || ''}')">Siguiente</button>` : ''}
          </div>
        </div>`;
        container.innerHTML = html;
      } else {
        container.innerHTML = buildTableHtml(headers, dataRows, opts);
      }

      lucide.createIcons();
      return dataRows;
    }

    function buildTableHtml(headers, rows, opts = {}) {
      let html = '<div class="gs-table-wrap"><table class="gs-table"><thead><tr>';
      headers.forEach(h => {
        html += `<th>${h || ''}</th>`;
      });
      html += '</tr></thead><tbody>';

      rows.forEach(row => {
        let rowClass = '';
        let rowStyleStr = '';
        if (opts.highlightFn) {
          const style = opts.highlightFn(row, headers);
          if (style) {
            rowStyleStr = ` style="${style}"`;
            if (style.includes('239,68,68')) rowClass = ' class="row-danger"';
          }
        }
        html += `<tr${rowClass}${rowStyleStr}>`;
        row.forEach((cell, i) => {
          const val = cell != null ? cell : '';
          const isNum = isNumericColumn(cell);
          const str = String(val);
          const truncated = str.length > 50 ? str.slice(0, 47) + '...' : str;
          const titleAttr = str.length > 50 ? ` title="${str.replace(/"/g, '&quot;')}"` : '';
          const isAccent = opts.accentCols && opts.accentCols.includes(i);
          const cellStyle = isAccent && str ? ` style="color: var(--accent); font-weight: 600;"` : '';
          html += `<td${isNum ? ' class="num"' : ''}${titleAttr}${cellStyle}>${truncated}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      return html;
    }

    function isNumericColumn(val) {
      if (val == null || val === '') return false;
      const str = String(val).replace(/[$%.,\s]/g, '');
      return !isNaN(str) && str !== '';
    }

    // Ventas por Mes
    // Returns Set of client codes present in the 80/20 sheet
    function _get8020Codes() {
      if (!gs8020VendClean || gs8020VendClean.length <= 1) return new Set();
      const codeIdx = findCodeColumn(gs8020VendClean[0]);
      return new Set(gs8020VendClean.slice(1).map(r => String(r[codeIdx] || '').trim()).filter(Boolean));
    }

    // Highlight function for ventas table: gold bg for 80/20 clients
    function _ventasHighlightFn(row, headers) {
      const codeIdx = findCodeColumn(headers);
      const code = String(row[codeIdx] || '').trim();
      if (!code) return '';
      const codes8020 = _get8020Codes();
      return codes8020.has(code) ? 'background: rgba(212,175,55,0.12); border-left: 2px solid rgba(212,175,55,0.6);' : '';
    }

    function _ventasVendorIdx(headers) {
      return headers.findIndex(h => h && (
        h.toLowerCase().includes('vendedor') ||
        h.toLowerCase() === 'vend' ||
        h.toLowerCase().includes('ejecutivo')
      ));
    }

    function renderGsheetsVentas(data) {
      if (!data || data.length === 0) return;
      data = cleanSheetData(data);
      gsheetsAllVentas = data;

      const headers = data[0];
      const mesIdx = headers.findIndex(h => h && h.toLowerCase().includes('mes'));
      const vendIdx = _ventasVendorIdx(headers);

      // Populate month filter
      const monthSelect = document.getElementById('gs-ventas-mes');
      if (mesIdx >= 0 && monthSelect) {
        const months = [...new Set(data.slice(1).map(r => r[mesIdx]).filter(Boolean))];
        monthSelect.innerHTML = '<option value="">Todos los meses</option>' + months.map(m => `<option value="${m}">${m}</option>`).join('');
      }

      // Populate vendor filter
      const vendorSelect = document.getElementById('gs-ventas-vendor');
      if (vendIdx >= 0 && vendorSelect) {
        const vendors = [...new Set(data.slice(1).map(r => r[vendIdx]).filter(Boolean))].sort();
        vendorSelect.innerHTML = '<option value="">Todos los vendedores</option>' + vendors.map(v => `<option value="${v}">${v}</option>`).join('');
      }

      const vendAccent = vendIdx >= 0 ? [vendIdx] : [];
      sheetToTable(data, 'gs-ventas-body', { maxRows: 100, page: 0, storeKey: 'ventas', highlightFn: _ventasHighlightFn, accentCols: vendAccent });
      _showVentasLegend();
    }

    function _showVentasLegend() {
      const legend = document.getElementById('gs-ventas-legend');
      if (legend) legend.style.display = _get8020Codes().size > 0 ? 'flex' : 'none';
    }

    function filterGsheetsVentas() {
      if (!gsheetsAllVentas || gsheetsAllVentas.length === 0) return;
      const search = (document.getElementById('gs-ventas-search').value || '').toLowerCase();
      const mes = document.getElementById('gs-ventas-mes').value;
      const vendor = document.getElementById('gs-ventas-vendor')?.value || '';
      const headers = gsheetsAllVentas[0];
      const mesIdx = headers.findIndex(h => h && h.toLowerCase().includes('mes'));
      const vendIdx = _ventasVendorIdx(headers);

      let filtered = [headers];
      gsheetsAllVentas.slice(1).forEach(row => {
        const matchSearch = !search || row.some(cell => String(cell).toLowerCase().includes(search));
        const matchMes = !mes || (mesIdx >= 0 && row[mesIdx] === mes);
        const matchVendor = !vendor || (vendIdx >= 0 && row[vendIdx] === vendor);
        if (matchSearch && matchMes && matchVendor) filtered.push(row);
      });

      const vendAccent = vendIdx >= 0 ? [vendIdx] : [];
      sheetToTable(filtered, 'gs-ventas-body', { maxRows: 100, page: 0, storeKey: 'ventas', highlightFn: _ventasHighlightFn, accentCols: vendAccent });
      _showVentasLegend();
    }

    // Cobranzas
    function renderGsheetsCobranzas(data) {
      if (!data || data.length === 0) return;
      data = cleanSheetData(data);
      gsheetsAllCobranzas = data;

      // Populate vendor filter
      const headers = data[0] || [];
      const vendorIdxCob = headers.findIndex(h => h && (h.toLowerCase().includes('vendedor') || h.toLowerCase().includes('ejecutivo') || h.toLowerCase() === 'vend'));
      const vendorSelCob = document.getElementById('gs-cobranzas-vendor');
      if (vendorIdxCob >= 0 && vendorSelCob) {
        const vendors = [...new Set(data.slice(1).map(r => r[vendorIdxCob]).filter(Boolean))].sort();
        vendorSelCob.innerHTML = '<option value="">Todos los vendedores</option>' +
          vendors.map(n => `<option value="${n}">${n}</option>`).join('');
      }

      sheetToTable(data, 'gs-cobranzas-body', {
        maxRows: 100, page: 0, storeKey: 'cobranzas',
        highlightFn: (row, headers) => {
          const vencIdx = headers.findIndex(h => h && h.toLowerCase().includes('vencimiento'));
          if (vencIdx >= 0 && row[vencIdx]) {
            try {
              const parts = String(row[vencIdx]).split(/[\/\-]/);
              let date;
              if (parts.length === 3) {
                // Try DD/MM/YYYY or YYYY-MM-DD
                if (parts[0].length === 4) date = new Date(parts[0], parts[1] - 1, parts[2]);
                else date = new Date(parts[2], parts[1] - 1, parts[0]);
              }
              if (date && date < new Date()) {
                return 'background: rgba(239,68,68,0.08);';
              }
            } catch (e) {}
          }
          return '';
        }
      });
    }

    function filterGsheetsCobranzas() {
      if (!gsheetsAllCobranzas || gsheetsAllCobranzas.length === 0) return;
      const search = (document.getElementById('gs-cobranzas-search').value || '').toLowerCase();
      const filter = document.getElementById('gs-cobranzas-filter').value;
      const vendor = document.getElementById('gs-cobranzas-vendor')?.value || '';
      const headers = gsheetsAllCobranzas[0];
      const vencIdx = headers.findIndex(h => h && h.toLowerCase().includes('vencimiento'));
      const vendorIdxCob = headers.findIndex(h => h && (h.toLowerCase().includes('vendedor') || h.toLowerCase().includes('ejecutivo') || h.toLowerCase() === 'vend'));

      let filtered = [headers];
      gsheetsAllCobranzas.slice(1).forEach(row => {
        const matchSearch = !search || row.some(cell => String(cell).toLowerCase().includes(search));
        const matchVendor = !vendor || (vendorIdxCob >= 0 && row[vendorIdxCob] === vendor);
        let matchFilter = true;
        if (filter && vencIdx >= 0 && row[vencIdx]) {
          try {
            const parts = String(row[vencIdx]).split(/[\/\-]/);
            let date;
            if (parts.length === 3) {
              if (parts[0].length === 4) date = new Date(parts[0], parts[1] - 1, parts[2]);
              else date = new Date(parts[2], parts[1] - 1, parts[0]);
            }
            if (date) {
              const isVencido = date < new Date();
              matchFilter = (filter === 'vencido' && isVencido) || (filter === 'vigente' && !isVencido);
            }
          } catch (e) {}
        }
        if (matchSearch && matchVendor && matchFilter) filtered.push(row);
      });

      sheetToTable(filtered, 'gs-cobranzas-body', {
        maxRows: 100, page: 0, storeKey: 'cobranzas',
        highlightFn: (row, headers) => {
          const vi = headers.findIndex(h => h && h.toLowerCase().includes('vencimiento'));
          if (vi >= 0 && row[vi]) {
            try {
              const parts = String(row[vi]).split(/[\/\-]/);
              let date;
              if (parts.length === 3) {
                if (parts[0].length === 4) date = new Date(parts[0], parts[1] - 1, parts[2]);
                else date = new Date(parts[2], parts[1] - 1, parts[0]);
              }
              if (date && date < new Date()) return 'background: rgba(239,68,68,0.08);';
            } catch (e) {}
          }
          return '';
        }
      });
    }

    // Vendedores / Zonales
    let gsheetsVendedoresParsed = [];

    const ZONE_COLORS = {
      'zona norte': { bg: 'rgba(59,130,246,0.08)', color: '#3b82f6', border: 'rgba(59,130,246,0.2)', icon: 'compass' },
      'zona centro': { bg: 'rgba(16,185,129,0.08)', color: '#10b981', border: 'rgba(16,185,129,0.2)', icon: 'building' },
      'zona centro sur': { bg: 'rgba(245,158,11,0.08)', color: '#f59e0b', border: 'rgba(245,158,11,0.2)', icon: 'mountain' },
      'zona sur': { bg: 'rgba(139,92,246,0.08)', color: '#8b5cf6', border: 'rgba(139,92,246,0.2)', icon: 'trees' }
    };

    function renderGsheetsVendedores(data) {
      if (!data || data.length === 0) return;

      // Find real header row
      let headerIdx = 0;
      for (let i = 0; i < Math.min(data.length, 5); i++) {
        if (data[i].some(cell => cell && String(cell).toLowerCase().includes('vendedor'))) {
          headerIdx = i; break;
        }
      }
      const cleanData = data.slice(headerIdx);
      gsheetsAllVendedores = cleanData;

      const headers = cleanData[0];
      const rows = cleanData.slice(1).filter(r => r.some(c => c !== '' && c != null));

      // Find column indices
      const nameIdx = headers.findIndex(h => h && String(h).toLowerCase().includes('vendedor'));
      const zonaIdx = headers.findIndex(h => h && String(h).toLowerCase().includes('zona'));
      const zonalIdx = headers.findIndex(h => h && String(h).toLowerCase().includes('zonal'));
      const mailIdx = headers.findIndex(h => h && String(h).toLowerCase().includes('mail'));
      const celIdx = headers.findIndex(h => h && String(h).toLowerCase().includes('celular'));
      const regionIdx = headers.findIndex(h => h && String(h).toLowerCase().includes('region'));

      // Parse all vendedores
      gsheetsVendedoresParsed = [];
      const zones = new Set();
      rows.forEach(row => {
        const name = (nameIdx >= 0 ? row[nameIdx] : '') || '';
        if (!name) return;
        const zona = (zonaIdx >= 0 ? row[zonaIdx] : '') || '';
        const isZonal = row[0] && String(row[0]).toLowerCase().includes('zonal');
        if (zona) zones.add(zona);
        gsheetsVendedoresParsed.push({
          name,
          zona,
          zonal: (zonalIdx >= 0 ? row[zonalIdx] : '') || '',
          mail: (mailIdx >= 0 ? row[mailIdx] : '') || '',
          cel: (celIdx >= 0 ? row[celIdx] : '') || '',
          region: (regionIdx >= 0 ? row[regionIdx] : '') || '',
          isZonal
        });
      });

      // Populate zone filter
      const zoneFilter = document.getElementById('gs-vendedores-zona-filter');
      if (zoneFilter) {
        zoneFilter.innerHTML = '<option value="">Todas las zonas</option>' +
          [...zones].sort().map(z => `<option value="${z}">${z}</option>`).join('');
      }

      renderVendedoresCards(gsheetsVendedoresParsed);
    }

    function filterGsheetsVendedoresCards() {
      const search = (document.getElementById('gs-vendedores-search').value || '').toLowerCase();
      const zona = document.getElementById('gs-vendedores-zona-filter').value;
      let filtered = gsheetsVendedoresParsed.filter(v => {
        const matchSearch = !search || v.name.toLowerCase().includes(search) || v.zona.toLowerCase().includes(search) || v.mail.toLowerCase().includes(search);
        const matchZona = !zona || v.zona === zona;
        return matchSearch && matchZona;
      });
      renderVendedoresCards(filtered);
    }

    let vendedoresViewMode = 'zonales'; // 'zonales' or 'todos'

    function renderVendedoresCards(vendedores) {
      const container = document.getElementById('gs-vendedores-body');
      if (!vendedores || vendedores.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">Sin resultados</p>';
        return;
      }

      const zonales = vendedores.filter(v => v.isZonal);
      const execs = vendedores.filter(v => !v.isZonal);

      let html = '';

      // View toggle
      const activeStyle = 'background:var(--bg-card);color:var(--accent);font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,0.08);';
      const inactiveStyle = 'background:transparent;color:var(--text-secondary);font-weight:500;box-shadow:none;';
      html += `<div style="display:flex;gap:0;margin-bottom:16px;background:var(--bg-hover);border-radius:10px;padding:4px;border:1px solid var(--border);">
        <button onclick="vendedoresViewMode='zonales';renderVendedoresCards(gsheetsVendedoresParsed)" style="flex:1;padding:10px 16px;border:none;border-radius:8px;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;font-family:inherit;${vendedoresViewMode === 'zonales' ? activeStyle : inactiveStyle}">
          <i data-lucide="network" style="width:15px;height:15px;"></i> Por Zonal
        </button>
        <button onclick="vendedoresViewMode='todos';renderVendedoresCards(gsheetsVendedoresParsed)" style="flex:1;padding:10px 16px;border:none;border-radius:8px;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all 0.2s;font-family:inherit;${vendedoresViewMode === 'todos' ? activeStyle : inactiveStyle}">
          <i data-lucide="layout-grid" style="width:15px;height:15px;"></i> Todos
        </button>
      </div>`;

      if (vendedoresViewMode === 'zonales') {
        // Group by zonal
        zonales.forEach(z => {
          const myExecs = execs.filter(e => e.zonal.toLowerCase() === z.name.toLowerCase());
          const zc = ZONE_COLORS[z.zona.toLowerCase()] || { bg:'var(--bg-hover)', color:'var(--text-muted)', border:'var(--border)' };
          const cardId = 'zonal-group-' + z.name.replace(/[^a-zA-Z]/g, '');

          html += `<div style="margin-bottom:16px;border:1px solid var(--border);border-radius:12px;overflow:hidden;">`;
          // Zonal header - clickable
          html += `<div onclick="toggleZonalGroup('${cardId}')" style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;cursor:pointer;background:${zc.bg};border-left:4px solid ${zc.color};transition:background 0.15s;" onmouseenter="this.style.opacity='0.85'" onmouseleave="this.style.opacity='1'">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:40px;height:40px;border-radius:50%;background:${zc.color};display:flex;align-items:center;justify-content:center;">
                <i data-lucide="shield" style="width:18px;height:18px;color:white;"></i>
              </div>
              <div>
                <div style="font-weight:700;font-size:15px;color:var(--text-primary);">${z.name}</div>
                <div style="font-size:12px;color:var(--text-muted);display:flex;gap:8px;align-items:center;margin-top:2px;">
                  <span style="background:${zc.bg};color:${zc.color};border:1px solid ${zc.border};padding:1px 8px;border-radius:12px;font-size:10px;font-weight:600;">${z.zona}</span>
                  <span>${myExecs.length} vendedor${myExecs.length !== 1 ? 'es' : ''}</span>
                  ${z.region ? `<span>| ${z.region}</span>` : ''}
                </div>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              ${z.mail ? `<a href="mailto:${z.mail}" onclick="event.stopPropagation()" style="font-size:11px;color:var(--accent);text-decoration:none;background:rgba(59,130,246,0.08);padding:4px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;"><i data-lucide="mail" style="width:10px;height:10px;"></i>${z.mail}</a>` : ''}
              ${z.cel ? `<a href="tel:${z.cel.replace(/\\s/g,'')}" onclick="event.stopPropagation()" style="font-size:11px;color:var(--text-secondary);text-decoration:none;background:var(--bg-hover);padding:4px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;"><i data-lucide="phone" style="width:10px;height:10px;"></i>${z.cel}</a>` : ''}
              <i data-lucide="chevron-down" id="${cardId}-icon" style="width:18px;height:18px;color:var(--text-muted);transition:transform 0.2s;"></i>
            </div>
          </div>`;

          // Ejecutivos grid - collapsed by default
          html += `<div id="${cardId}" style="display:none;padding:12px 16px;background:var(--bg-card);border-top:1px solid var(--border);">
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;">`;
          myExecs.forEach(e => { html += buildVendedorCard(e, false); });
          if (myExecs.length === 0) {
            html += '<p style="color:var(--text-muted);font-size:13px;padding:8px;">Sin vendedores asignados</p>';
          }
          html += `</div></div></div>`;
        });

        // Ejecutivos sin zonal
        const sinZonal = execs.filter(e => !zonales.some(z => z.name.toLowerCase() === e.zonal.toLowerCase()));
        if (sinZonal.length > 0) {
          html += `<div style="margin-top:8px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:600;margin-bottom:10px;padding:0 4px;">Sin zonal asignado</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;">`;
          sinZonal.forEach(e => { html += buildVendedorCard(e, false); });
          html += '</div></div>';
        }

      } else {
        // Todos view - flat grid
        if (zonales.length > 0) {
          html += '<div style="margin-bottom:16px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:600;margin-bottom:10px;padding:0 4px;">Zonales</div>';
          html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;">';
          zonales.forEach(v => { html += buildVendedorCard(v, true); });
          html += '</div></div>';
        }
        if (execs.length > 0) {
          html += '<div><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:600;margin-bottom:10px;padding:0 4px;">Vendedores</div>';
          html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;">';
          execs.forEach(v => { html += buildVendedorCard(v, false); });
          html += '</div></div>';
        }
      }

      container.innerHTML = html;
      lucide.createIcons();
    }

    function toggleZonalGroup(id) {
      const el = document.getElementById(id);
      const icon = document.getElementById(id + '-icon');
      if (el.style.display === 'none') {
        el.style.display = 'block';
        if (icon) icon.style.transform = 'rotate(180deg)';
      } else {
        el.style.display = 'none';
        if (icon) icon.style.transform = 'rotate(0deg)';
      }
    }

    function buildVendedorCard(v, isZonal) {
      const zc = ZONE_COLORS[v.zona.toLowerCase()] || { bg: 'var(--bg-hover)', color: 'var(--text-muted)', border: 'var(--border)', icon: 'map-pin' };
      const borderLeft = isZonal ? `border-left: 3px solid ${zc.color};` : '';
      const bgCard = isZonal ? `background: ${zc.bg};` : 'background: var(--bg-card);';

      // Cross-reference with allUsers/allClients for client + route stats
      let clientStats = '';
      let routeStatus = '';
      let gestionarBtn = '';
      if (!isZonal) {
        const firstName = v.name.split(' ')[0].toLowerCase();
        const user = (allUsers || []).find(u => u.role === 'executive' && u.full_name && u.full_name.toLowerCase().includes(firstName));
        if (user) {
          // Client stats
          const vc = (allClients || []).filter(c => c.assigned_user_id === user.id);
          const vc8020 = vc.filter(c => c.segmentation === '80-20');
          const pct = vc.length > 0 ? Math.round(vc8020.length / vc.length * 100) : 0;
          if (vc.length > 0) {
            clientStats = `<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);">
              <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px;">
                <span style="color:var(--text-muted);">${vc.length} clientes</span>
                ${vc8020.length > 0 ? `<span style="font-weight:700;color:#b8860b;">⭐ ${vc8020.length} 80/20 (${pct}%)</span>` : ''}
              </div>
              ${vc8020.length > 0 ? `<div style="height:3px;background:var(--border);border-radius:2px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:linear-gradient(90deg,#d4af37,#b8860b);border-radius:2px;"></div></div>` : ''}
            </div>`;
          }

          // Route status today
          const activeRoute = (todayRoutesData || []).find(r => r.user_id === user.id);
          const scheduleData = window._dashboardScheduleData;
          const hasSchedule = scheduleData && Object.values(scheduleData.schedule || {}).some(dayData => {
            return (dayData.clients || dayData.route || []).some(c => c.assigned_user_id === user.id || c.user_id === user.id) ||
                   (scheduleData.schedule[new Date().toISOString().split('T')[0]] &&
                    scheduleData.userId === user.id);
          });
          const todayScheduled = (todayScheduledData || {})[user.id] || [];

          if (activeRoute && activeRoute.status === 'active') {
            const visits = activeRoute.visits || [];
            const done = visits.filter(v => v.status === 'completed').length;
            const total = todayScheduled.length || visits.length;
            routeStatus = `<div style="margin-top:6px;display:flex;align-items:center;gap:6px;">
              <span style="width:7px;height:7px;border-radius:50%;background:#10b981;flex-shrink:0;animation:pulse 1.5s infinite;"></span>
              <span style="font-size:11px;color:#10b981;font-weight:600;">En ruta</span>
              ${total > 0 ? `<span style="font-size:11px;color:var(--text-muted);">${done}/${total} visitas</span>` : ''}
            </div>`;
          } else if (todayScheduled.length > 0) {
            routeStatus = `<div style="margin-top:6px;display:flex;align-items:center;gap:6px;">
              <span style="width:7px;height:7px;border-radius:50%;background:#3b82f6;flex-shrink:0;"></span>
              <span style="font-size:11px;color:#3b82f6;font-weight:600;">Programada hoy</span>
              <span style="font-size:11px;color:var(--text-muted);">${todayScheduled.length} clientes</span>
            </div>`;
          } else {
            routeStatus = `<div style="margin-top:6px;display:flex;align-items:center;gap:6px;">
              <span style="width:7px;height:7px;border-radius:50%;background:var(--text-muted);flex-shrink:0;opacity:0.5;"></span>
              <span style="font-size:11px;color:var(--text-muted);">Sin ruta hoy</span>
            </div>`;
          }

          // Gestionar quick-link
          gestionarBtn = `<button onclick="goToVendorGestionar('${user.id}')" style="margin-top:2px;background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.25);border-radius:6px;cursor:pointer;padding:3px 10px;font-size:10px;font-weight:600;color:#6366f1;display:inline-flex;align-items:center;gap:3px;"><i data-lucide="route" style="width:10px;height:10px;"></i> Gestionar</button>`;
        }
      }

      return `<div style="${bgCard}${borderLeft}border:1px solid var(--border);border-radius:10px;padding:14px 16px;transition:box-shadow 0.15s;" onmouseenter="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.06)'" onmouseleave="this.style.boxShadow='none'">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
          <div style="display:flex;align-items:center;gap:8px;min-width:0;">
            <div style="width:36px;height:36px;min-width:36px;border-radius:50%;background:${zc.color};display:flex;align-items:center;justify-content:center;color:white;font-size:13px;font-weight:700;">
              ${v.name.split(' ').map(n=>n[0]||'').join('').substring(0,2).toUpperCase()}
            </div>
            <div style="min-width:0;">
              <div style="font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${v.name}</div>
              ${isZonal ? '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:' + zc.color + ';font-weight:600;">Zonal</div>' : ''}
            </div>
          </div>
          <span style="background:${zc.bg};color:${zc.color};border:1px solid ${zc.border};padding:2px 10px;border-radius:20px;font-size:10px;font-weight:600;white-space:nowrap;flex-shrink:0;">${v.zona || 'Sin zona'}</span>
        </div>
        <div style="margin-top:6px;display:flex;flex-direction:column;gap:2px;font-size:12px;">
          ${!isZonal && v.zonal ? `<div style="color:var(--text-muted);">Reporta a: <strong style="color:var(--text-secondary);">${v.zonal}</strong></div>` : ''}
          ${v.region ? `<div style="color:var(--text-muted);"><i data-lucide="map-pin" style="width:11px;height:11px;display:inline-block;vertical-align:-1px;"></i> ${v.region}</div>` : ''}
        </div>
        ${routeStatus}
        ${clientStats}
        ${gestionarBtn ? `<div style="margin-top:8px;">${gestionarBtn}</div>` : ''}
        ${(v.mail || v.cel) ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;border-top:1px solid var(--border);padding-top:8px;">
          ${v.mail ? `<a href="mailto:${v.mail}" style="font-size:11px;color:var(--accent);text-decoration:none;background:rgba(59,130,246,0.06);padding:3px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;"><i data-lucide="mail" style="width:10px;height:10px;"></i>${v.mail}</a>` : ''}
          ${v.cel ? `<a href="tel:${v.cel.replace(/\s/g,'')}" style="font-size:11px;color:var(--text-secondary);text-decoration:none;background:var(--bg-hover);padding:3px 10px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;"><i data-lucide="phone" style="width:10px;height:10px;"></i>${v.cel}</a>` : ''}
        </div>` : ''}
      </div>`;
    }

    // 80-20
    let gs8020VendClean = null;
    let gs8020ZonClean = null;

    function renderGsheets8020(vendedoresData, zonalesData) {
      console.log('[GSheets 80-20] vendedoresData:', vendedoresData ? vendedoresData.length + ' rows' : 'null');
      console.log('[GSheets 80-20] zonalesData:', zonalesData ? zonalesData.length + ' rows' : 'null');
      if (vendedoresData && vendedoresData.length > 0) {
        gs8020VendClean = cleanSheetData(vendedoresData);
        gs8020VendClean = removeEmptyCols(gs8020VendClean);
        console.log('[GSheets 80-20] Vend headers:', gs8020VendClean[0]);
        console.log('[GSheets 80-20] Vend sample row:', gs8020VendClean[1]);
        render8020Vendedores(gs8020VendClean);
      }
      if (zonalesData && zonalesData.length > 0) {
        gs8020ZonClean = cleanSheetData(zonalesData);
        gs8020ZonClean = removeEmptyCols(gs8020ZonClean);
        console.log('[GSheets 80-20] Zon headers:', gs8020ZonClean[0]);
        render8020Zonales(gs8020ZonClean);
      }
      render8020Summary();
    }

    function removeEmptyCols(data) {
      if (!data || data.length === 0) return data;
      const cols = data[0].length;
      const emptyIdx = [];
      for (let c = 0; c < cols; c++) {
        const hasData = data.some(row => row[c] !== '' && row[c] != null);
        if (!hasData) emptyIdx.push(c);
      }
      return data.map(row => row.filter((_, i) => !emptyIdx.includes(i)));
    }

    function render8020Summary() {
      const container = document.getElementById('gs-8020-summary');
      if (!container) return;

      // Count per vendedor
      const vendCounts = {};
      if (gs8020VendClean && gs8020VendClean.length > 1) {
        const h = gs8020VendClean[0];
        const vendIdx = h.findIndex(c => c && (String(c).toLowerCase().includes('final') || String(c).toLowerCase().includes('vendedor')));
        const idx = vendIdx >= 0 ? vendIdx : 3;
        gs8020VendClean.slice(1).forEach(r => {
          const v = r[idx] || 'Sin asignar';
          vendCounts[v] = (vendCounts[v] || 0) + 1;
        });
      }

      // Count per zonal
      const zonCounts = {};
      if (gs8020ZonClean && gs8020ZonClean.length > 1) {
        const hz = gs8020ZonClean[0];
        const zonIdx = hz.length - 1;
        gs8020ZonClean.slice(1).forEach(r => {
          const z = r[zonIdx] || 'Sin asignar';
          zonCounts[z] = (zonCounts[z] || 0) + 1;
        });
      }

      const totalVend = Object.values(vendCounts).reduce((a, b) => a + b, 0);
      const totalZon = Object.values(zonCounts).reduce((a, b) => a + b, 0);
      const sortedVend = Object.entries(vendCounts).sort((a, b) => b[1] - a[1]);
      const sortedZon = Object.entries(zonCounts).sort((a, b) => b[1] - a[1]);

      let html = `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:700;color:var(--accent);">${totalVend}</div>
        <div style="font-size:11px;color:var(--text-muted);">Clientes Vendedores</div>
      </div>`;
      html += `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:700;color:#8b5cf6;">${totalZon}</div>
        <div style="font-size:11px;color:var(--text-muted);">Clientes Zonales</div>
      </div>`;

      // Vendedor cards
      sortedVend.slice(0, 5).forEach(([name, count]) => {
        const vData = findVendedorData(name);
        const zona = vData ? vData.zona : '';
        const zc = ZONE_COLORS[zona.toLowerCase()] || { color: 'var(--text-muted)', bg: 'var(--bg-hover)', border: 'var(--border)' };
        const pct = totalVend > 0 ? Math.round(count / totalVend * 100) : 0;
        html += `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;cursor:pointer;" onclick="switch8020View('vendedores');document.getElementById('gs-8020-vend-filter').value='${name}';filter8020Vendedores();">
          <div style="font-size:20px;font-weight:700;color:${zc.color};">${count}</div>
          <div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-top:2px;">${name}</div>
          <div style="font-size:10px;color:var(--text-muted);">${pct}%</div>
        </div>`;
      });

      // Zonal cards
      sortedZon.forEach(([name, count]) => {
        const vData = findVendedorData(name);
        const zona = vData ? vData.zona : '';
        const zc = ZONE_COLORS[zona.toLowerCase()] || { color: '#8b5cf6', bg: 'rgba(139,92,246,0.08)', border: 'rgba(139,92,246,0.2)' };
        const pct = totalZon > 0 ? Math.round(count / totalZon * 100) : 0;
        html += `<div style="background:${zc.bg};border:1px solid ${zc.border};border-radius:10px;padding:12px;text-align:center;cursor:pointer;" onclick="switch8020View('zonales');document.getElementById('gs-8020-zon-filter').value='${name}';filter8020Zonales();">
          <div style="font-size:20px;font-weight:700;color:${zc.color};">${count}</div>
          <div style="font-size:11px;font-weight:600;color:var(--text-primary);margin-top:2px;">${name}</div>
          <div style="display:flex;align-items:center;justify-content:center;gap:4px;margin-top:3px;">
            <span style="font-size:9px;background:${zc.color};color:white;padding:1px 6px;border-radius:4px;font-weight:600;">ZONAL</span>
            <span style="font-size:10px;color:var(--text-muted);">${pct}%</span>
          </div>
        </div>`;
      });

      container.innerHTML = html;
    }

    function render8020Vendedores(data) {
      if (!data) return;
      const headers = data[0];
      // Populate filter
      const vendIdx = headers.findIndex(c => c && (String(c).toLowerCase().includes('final') || String(c).toLowerCase().includes('vendedor')));
      const idx = vendIdx >= 0 ? vendIdx : 3;
      const vendedores = [...new Set(data.slice(1).map(r => r[idx]).filter(Boolean))].sort();
      const select = document.getElementById('gs-8020-vend-filter');
      if (select) {
        select.innerHTML = '<option value="">Todos los vendedores</option>' +
          vendedores.map(v => `<option value="${v}">${v}</option>`).join('');
      }
      sheetToTable(data, 'gs-8020-vendedores-body', { maxRows: 50, page: 0, storeKey: '8020vend' });
    }

    function filter8020Vendedores() {
      if (!gs8020VendClean) return;
      const filter = document.getElementById('gs-8020-vend-filter').value;
      const search = (document.getElementById('gs-8020-vend-search').value || '').toLowerCase();
      const headers = gs8020VendClean[0];
      const vendIdx = headers.findIndex(c => c && (String(c).toLowerCase().includes('final') || String(c).toLowerCase().includes('vendedor')));
      const idx = vendIdx >= 0 ? vendIdx : 3;

      let filtered = [headers];
      gs8020VendClean.slice(1).forEach(row => {
        const matchVend = !filter || row[idx] === filter;
        const matchSearch = !search || row.some(c => String(c).toLowerCase().includes(search));
        if (matchVend && matchSearch) filtered.push(row);
      });
      sheetToTable(filtered, 'gs-8020-vendedores-body', { maxRows: 50, page: 0, storeKey: '8020vend' });
    }

    function render8020Zonales(data) {
      if (!data) return;
      const headers = data[0];
      const zonIdx = headers.length - 1; // last col is zonal name
      const zonales = [...new Set(data.slice(1).map(r => r[zonIdx]).filter(Boolean))].sort();
      const select = document.getElementById('gs-8020-zon-filter');
      if (select) {
        select.innerHTML = '<option value="">Todos los zonales</option>' +
          zonales.map(z => {
            const vData = findVendedorData(z);
            const zona = vData ? vData.zona : '';
            return `<option value="${z}">${z}${zona ? ' (' + zona + ')' : ''}</option>`;
          }).join('');
      }

      // Render zonal summary cards above table
      const summaryDiv = document.getElementById('gs-8020-zonales-summary');
      if (summaryDiv) {
        let summaryHtml = '';
        zonales.forEach(z => {
          const count = data.slice(1).filter(r => r[zonIdx] === z).length;
          const vData = findVendedorData(z);
          const zona = vData ? vData.zona : '';
          const zc = ZONE_COLORS[zona.toLowerCase()] || { color: '#8b5cf6', bg: 'rgba(139,92,246,0.08)', border: 'rgba(139,92,246,0.2)' };
          summaryHtml += `<div style="background:${zc.bg};border:1px solid ${zc.border};border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="document.getElementById('gs-8020-zon-filter').value='${z}';filter8020Zonales();">
            <div style="width:40px;height:40px;border-radius:50%;background:${zc.color};color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;">
              ${z.split('.').map(p => p.trim()[0] || '').join('').toUpperCase().substring(0,2)}
            </div>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:600;font-size:13px;">${z}</div>
              <div style="font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:6px;">
                ${zona ? '<span style="background:' + zc.bg + ';color:' + zc.color + ';border:1px solid ' + zc.border + ';padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">' + zona + '</span>' : ''}
                <span>${count} clientes</span>
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:22px;font-weight:700;color:${zc.color};">${count}</div>
            </div>
          </div>`;
        });
        summaryDiv.innerHTML = summaryHtml;
      }

      sheetToTable(data, 'gs-8020-zonales-body', { maxRows: 50, page: 0, storeKey: '8020zon' });
    }

    function filter8020Zonales() {
      if (!gs8020ZonClean) return;
      const filter = document.getElementById('gs-8020-zon-filter').value;
      const search = (document.getElementById('gs-8020-zon-search').value || '').toLowerCase();
      const headers = gs8020ZonClean[0];
      const zonIdx = headers.length - 1;

      let filtered = [headers];
      gs8020ZonClean.slice(1).forEach(row => {
        const matchZon = !filter || row[zonIdx] === filter;
        const matchSearch = !search || row.some(c => String(c).toLowerCase().includes(search));
        if (matchZon && matchSearch) filtered.push(row);
      });
      sheetToTable(filtered, 'gs-8020-zonales-body', { maxRows: 50, page: 0, storeKey: '8020zon' });
    }

    function switch8020View(view) {
      const vendView = document.getElementById('gs-8020-view-vendedores');
      const zonView = document.getElementById('gs-8020-view-zonales');
      const btnVend = document.getElementById('btn-8020-vendedores');
      const btnZon = document.getElementById('btn-8020-zonales');
      if (view === 'vendedores') {
        vendView.style.display = 'block';
        zonView.style.display = 'none';
        btnVend.style.background = 'var(--bg-card)';
        btnVend.style.color = 'var(--accent)';
        btnVend.style.fontWeight = '600';
        btnVend.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';
        btnZon.style.background = 'transparent';
        btnZon.style.color = 'var(--text-secondary)';
        btnZon.style.fontWeight = '500';
        btnZon.style.boxShadow = 'none';
      } else {
        vendView.style.display = 'none';
        zonView.style.display = 'block';
        btnZon.style.background = 'var(--bg-card)';
        btnZon.style.color = 'var(--accent)';
        btnZon.style.fontWeight = '600';
        btnZon.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';
        btnVend.style.background = 'transparent';
        btnVend.style.color = 'var(--text-secondary)';
        btnVend.style.fontWeight = '500';
        btnVend.style.boxShadow = 'none';
      }
      lucide.createIcons();
    }

    // Direcciones — store Sheet data for import, render from DB
    function renderGsheetsDirecciones(rawData, validadasData) {
      if (rawData && rawData.length > 0) {
        rawData = cleanSheetData(rawData);
        gsheetsAllDirecciones = rawData;
      }
      // Primary view is from DB (allClients)
      initDireccionesFromDB();
    }

    // Title Case helper: "JUAN CARLOS PEREZ" → "Juan Carlos Perez"
    function toTitleCase(str) {
      if (!str) return '';
      return str.toLowerCase().replace(/(?:^|\s|[-/])\S/g, c => c.toUpperCase());
    }

    let _dirCurrentPage = 0;
    let _dirFilterGeo = false; // false = all, 'has' = only with geo link, 'none' = only without geo
    let _dirColWidths = null; // persisted column widths
    let _dirDBPage = 0;
    let _dirDBFiltered = []; // filtered allClients for Direcciones view

    // ====== DIRECCIONES FROM DATABASE (Supabase) ======

    // Normalize region names client-side (same logic as backend)
    const _REGION_NORM = {
      'metropolitana':'Metropolitana','region metropolitana':'Metropolitana','rm':'Metropolitana',
      'primera':'Primera','i':'Primera','tarapaca':'Primera','tarapacá':'Primera',
      'segunda':'Segunda','ii':'Segunda','antofagasta':'Segunda',
      'tercera':'Tercera','iii':'Tercera','atacama':'Tercera',
      'cuarta':'Cuarta','iv':'Cuarta','coquimbo':'Cuarta',
      'quinta':'Quinta','v':'Quinta','valparaiso':'Quinta','valparaíso':'Quinta',
      'sexta':'Sexta Región','vi':'Sexta Región',"o'higgins":'Sexta Región','ohiggins':'Sexta Región',
      'séptima':'Séptima','septima':'Séptima','vii':'Séptima','maule':'Séptima',
      'octava':'Octava','viii':'Octava','biobio':'Octava','bío-bío':'Octava','biobío':'Octava','ñuble':'Octava',
      'novena':'Novena','ix':'Novena','araucania':'Novena','araucanía':'Novena',
      'decima':'Décima','décima':'Décima','x':'Décima','los lagos':'Décima',
      'undecima':'Undécima','undécima':'Undécima','xi':'Undécima','aysen':'Undécima','aysén':'Undécima',
      'duodecima':'Duodécima','duodécima':'Duodécima','xii':'Duodécima','magallanes':'Duodécima',
      'decimo cuarta':'Décimo Cuarta','décimo cuarta':'Décimo Cuarta','xiv':'Décimo Cuarta','los rios':'Décimo Cuarta','los ríos':'Décimo Cuarta',
      'decimo quinta':'Décimo Quinta','décimo quinta':'Décimo Quinta','xv':'Décimo Quinta','arica':'Décimo Quinta',
    };
    function _normRegionClient(raw) {
      if (!raw) return '';
      const key = raw.trim().replace(/\s+/g,' ').toLowerCase()
        .replace(/región\s*(de\s+|del\s+|de\s+la\s+|de\s+los\s+)?/gi,'')
        .replace(/region\s*(de\s+|del\s+|de\s+la\s+|de\s+los\s+)?/gi,'')
        .trim();
      return _REGION_NORM[key] || _REGION_NORM[raw.trim().toLowerCase()] || raw.trim().replace(/\s+/g,' ');
    }

    function populateDirFilters() {
      // Region dropdown — valores exactos del DB (sin normalizar para evitar mismatch)
      const regionSelect = document.getElementById('dir-db-region');
      if (regionSelect) {
        const current = regionSelect.value;
        const regions = [...new Set(allClients.map(c => (c.region || '').trim()).filter(Boolean))].sort();
        regionSelect.innerHTML = '<option value="">Todas las regiones</option>';
        regions.forEach(r => {
          regionSelect.innerHTML += `<option value="${r}" ${current === r ? 'selected' : ''}>${r}</option>`;
        });
      }
      // Vendor dropdown
      const vendorSelect = document.getElementById('dir-db-vendor');
      if (vendorSelect) {
        const current = vendorSelect.value;
        vendorSelect.innerHTML = '<option value="">Todos los vendedores</option><option value="__none__">Sin asignar</option>';
        (executives || []).forEach(u => {
          vendorSelect.innerHTML += `<option value="${u.id}" ${current === u.id ? 'selected' : ''}>${u.full_name}</option>`;
        });
      }
    }

    function filterDireccionesDB() {
      const search = (document.getElementById('dir-db-search')?.value || '').toLowerCase().trim();
      const region = document.getElementById('dir-db-region')?.value || '';
      const vendor = document.getElementById('dir-db-vendor')?.value || '';

      let filtered = allClients;

      if (search) {
        filtered = filtered.filter(c =>
          (c.external_id || '').toLowerCase().includes(search) ||
          (c.name || '').toLowerCase().includes(search) ||
          (c.fantasy_name || '').toLowerCase().includes(search) ||
          (c.address || '').toLowerCase().includes(search) ||
          (c.commune || '').toLowerCase().includes(search) ||
          (c.city || '').toLowerCase().includes(search)
        );
      }
      if (region) {
        filtered = filtered.filter(c => (c.region || '').trim() === region);
      }
      if (vendor === '__none__') {
        filtered = filtered.filter(c => !c.assigned_user_id);
      } else if (vendor) {
        filtered = filtered.filter(c => c.assigned_user_id === vendor);
      }
      if (_dirFilterGeo === 'has') {
        filtered = filtered.filter(c => c.geo_link);
      } else if (_dirFilterGeo === 'none') {
        filtered = filtered.filter(c => !c.geo_link);
      }

      _dirDBFiltered = filtered;
      _dirDBPage = 0;
      renderDireccionesFromDB(filtered, 0);
    }

    function renderDireccionesFromDB(clients, page) {
      const container = document.getElementById('gs-direcciones-body');
      if (!container) return;
      if (!clients || clients.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">Sin clientes</p>';
        const countEl = document.getElementById('dir-total-count');
        if (countEl) countEl.textContent = '';
        return;
      }
      _dirDBPage = page;

      const isAdmin = currentUser && currentUser.role === 'admin';
      const geoCount = clients.filter(c => c.geo_link).length;
      const noGeoCount = clients.length - geoCount;

      // Update total count
      const countEl = document.getElementById('dir-total-count');
      if (countEl) countEl.textContent = `(${allClients.length.toLocaleString()} total)`;

      // Geo filter buttons
      const geoFiltersEl = document.getElementById('dir-db-geo-filters');
      if (geoFiltersEl) {
        geoFiltersEl.innerHTML = `
          <button onclick="_dirFilterGeo=_dirFilterGeo==='has'?false:'has';filterDireccionesDB()" style="padding:3px 8px;border:1px solid ${_dirFilterGeo === 'has' ? '#10b981' : 'var(--border)'};border-radius:5px;background:${_dirFilterGeo === 'has' ? 'rgba(16,185,129,0.1)' : 'transparent'};color:${_dirFilterGeo === 'has' ? '#10b981' : 'var(--text-muted)'};font-size:11px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:3px;white-space:nowrap;"><i data-lucide="map-pin" style="width:11px;height:11px;"></i>${geoCount.toLocaleString()} con geo</button>
          <button onclick="_dirFilterGeo=_dirFilterGeo==='none'?false:'none';filterDireccionesDB()" style="padding:3px 8px;border:1px solid ${_dirFilterGeo === 'none' ? '#f59e0b' : 'var(--border)'};border-radius:5px;background:${_dirFilterGeo === 'none' ? 'rgba(245,158,11,0.1)' : 'transparent'};color:${_dirFilterGeo === 'none' ? '#f59e0b' : 'var(--text-muted)'};font-size:11px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:3px;white-space:nowrap;"><i data-lucide="map-pin-off" style="width:11px;height:11px;"></i>${noGeoCount.toLocaleString()} sin geo</button>`;
      }

      const pageSize = 100;
      const start = page * pageSize;
      const pageRows = clients.slice(start, start + pageSize);
      const totalPages = Math.ceil(clients.length / pageSize);

      // Vendor lookup map
      const vendorMap = {};
      (allUsers || []).forEach(u => { vendorMap[u.id] = u.full_name; });

      // Column config
      const wrapEl = container;
      const availW = wrapEl ? wrapEl.clientWidth - 20 : 1000;
      const baseW = Math.max(availW, 850);
      const cols = [
        { key: 'code', label: 'Código', w: Math.round(baseW * 0.08) },
        { key: 'client', label: 'Cliente', w: Math.round(baseW * 0.17) },
        { key: 'address', label: 'Dirección', w: Math.round(baseW * 0.22) },
        { key: 'commune', label: 'Comuna', w: Math.round(baseW * 0.10) },
        { key: 'city', label: 'Ciudad', w: Math.round(baseW * 0.08) },
        { key: 'region', label: 'Región', w: Math.round(baseW * 0.10) },
        { key: 'geo', label: 'Mapa', w: Math.round(baseW * 0.04) },
        { key: 'vendor', label: 'Vendedor', w: Math.round(baseW * 0.11) },
        { key: 'actions', label: '', w: Math.round(baseW * 0.07) },
      ];

      // Restore saved widths
      if (_dirColWidths) {
        cols.forEach((c, i) => { if (_dirColWidths[i]) c.w = _dirColWidths[i]; });
      }

      // Pagination
      const makePag = (pos) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 12px;background:var(--bg-hover);border-radius:8px;margin-${pos === 'top' ? 'bottom' : 'top'}:6px;flex-wrap:wrap;gap:6px;">
        <span style="font-size:12px;color:var(--text-secondary);font-weight:600;">${clients.length.toLocaleString()} clientes</span>
        <div style="display:flex;align-items:center;gap:5px;">
          ${totalPages > 1 ? `
            ${page > 0 ? `<button onclick="renderDireccionesFromDB(_dirDBFiltered,${page - 1})" style="padding:3px 8px;border:1px solid var(--border);border-radius:5px;background:var(--bg-card);color:var(--text-secondary);font-size:11px;cursor:pointer;">←</button>` : ''}
            <span style="font-size:12px;font-weight:700;color:var(--text-primary);">${page + 1}/${totalPages}</span>
            ${page < totalPages - 1 ? `<button onclick="renderDireccionesFromDB(_dirDBFiltered,${page + 1})" style="padding:3px 8px;border:1px solid var(--border);border-radius:5px;background:var(--bg-card);color:var(--text-secondary);font-size:11px;cursor:pointer;">→</button>` : ''}
          ` : ''}
        </div>
      </div>`;

      let html = makePag('top');

      const tableId = 'dir-resize-table';
      const totalW = cols.reduce((s, c) => s + c.w, 0);
      const colGroupHtml = cols.map((c, i) => `<col data-col="${i}" style="width:${c.w}px;">`).join('');

      html += `<div class="gs-table-wrap" style="overflow-x:auto;"><table id="${tableId}" class="gs-table" style="font-size:12px;table-layout:fixed;width:${totalW}px;min-width:750px;">
        <colgroup>${colGroupHtml}</colgroup><thead><tr>`;

      cols.forEach((c, i) => {
        const isLast = i === cols.length - 1;
        const canResize = c.key !== 'actions' && !isLast;
        const borderRight = !isLast ? 'border-right:1px solid var(--border);' : '';
        const resizer = canResize ? `<div class="dir-col-resizer" data-col="${i}" style="position:absolute;right:-4px;top:0;bottom:0;width:9px;cursor:col-resize;z-index:3;background:transparent;" onmouseenter="this.style.background='rgba(99,102,241,0.3)'" onmouseleave="this.style.background='transparent'"></div>` : '';
        const align = c.key === 'geo' || c.key === 'actions' ? 'text-align:center;' : '';
        html += `<th style="padding:6px 5px;font-size:11px;position:relative;${align}${borderRight}user-select:none;overflow:hidden;">${c.label}${resizer}</th>`;
      });
      html += `</tr></thead><tbody>`;

      pageRows.forEach(c => {
        const name = toTitleCase(c.fantasy_name || c.name || '-');
        const sub = c.fantasy_name && c.name && c.fantasy_name !== c.name ? `<div style="font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${toTitleCase(c.name)}</div>` : '';
        const dir = toTitleCase(c.address || '');
        const commune = toTitleCase(c.commune || '');
        const city = toTitleCase(c.city || '');
        const region = c.region || '';
        const geoLink = c.geo_link || '';
        const vendorName = c.assigned_user_id ? (vendorMap[c.assigned_user_id] || '?') : '';
        const hasGeo = !!geoLink;
        const rowBg = hasGeo ? 'background:rgba(16,185,129,0.04);' : '';
        const code = c.external_id || '';

        const safeDir = dir.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeComuna = commune.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeName = name.replace(/'/g, "\\'").replace(/"/g, '&quot;');

        // Geo cell
        let geoCell;
        if (hasGeo) {
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><a href="${geoLink}" target="_blank" rel="noopener" title="Geo verificado" style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(16,185,129,0.15);color:#10b981;text-decoration:none;"><i data-lucide="map-pin" style="width:14px;height:14px;"></i></a></td>`;
        } else if (dir && isAdmin) {
          const mapsUrl = _buildMapsSearchUrl(dir, commune, city);
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><a href="${mapsUrl}" target="_blank" rel="noopener" title="Buscar en Maps" style="display:inline-flex;align-items:center;justify-content:center;width:13px;height:26px;border-radius:50%;color:rgba(99,102,241,0.4);text-decoration:none;"><i data-lucide="search" style="width:12px;height:12px;"></i></a><button onclick="openAddGeoLink('${code}','${safeName}','${safeDir}','${safeComuna}')" title="Agregar geo" style="border:none;background:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:13px;height:26px;color:rgba(245,158,11,0.6);"><i data-lucide="plus" style="width:11px;height:11px;"></i></button></td>`;
        } else if (dir) {
          const mapsUrl = _buildMapsSearchUrl(dir, commune, city);
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><a href="${mapsUrl}" target="_blank" rel="noopener" title="Buscar en Maps" style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;color:rgba(99,102,241,0.35);text-decoration:none;"><i data-lucide="search" style="width:12px;height:12px;"></i></a></td>`;
        } else {
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><span style="color:var(--text-muted);opacity:0.15;">—</span></td>`;
        }

        // Vendor cell
        const vendorCell = vendorName
          ? `<td style="padding:3px 5px;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;border-right:1px solid var(--border);" title="${vendorName}"><span style="background:rgba(99,102,241,0.1);color:var(--accent);padding:1px 6px;border-radius:4px;font-weight:500;">${vendorName.split(' ')[0]}</span></td>`
          : `<td style="padding:3px 5px;font-size:10px;border-right:1px solid var(--border);"><span style="color:var(--text-muted);opacity:0.3;">sin asignar</span></td>`;

        // Actions
        let actionsHtml = '';
        if (isAdmin) {
          actionsHtml = `<td style="padding:3px 2px;text-align:center;">
            <button onclick="openEditClientFullModal('${c.id}')" class="btn-icon" title="Editar" style="padding:2px;"><i data-lucide="pencil" style="width:12px;height:12px;"></i></button>
            <button onclick="deleteClientFromDirecciones('${c.id}','${code}','${safeName}')" class="btn-icon" title="Eliminar" style="padding:2px;color:#ef4444;"><i data-lucide="trash-2" style="width:12px;height:12px;"></i></button>
          </td>`;
        } else {
          actionsHtml = `<td style="padding:3px 2px;text-align:center;">
            <button onclick="openEditClientFullModal('${c.id}')" class="btn-icon" title="Ver" style="padding:2px;"><i data-lucide="eye" style="width:12px;height:12px;"></i></button>
          </td>`;
        }

        const br = 'border-right:1px solid var(--border);';
        html += `<tr style="${rowBg}">
          <td style="padding:3px 5px;overflow:hidden;${br}"><code style="font-size:10px;background:var(--bg-hover);padding:1px 3px;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;">${code}</code></td>
          <td style="padding:3px 5px;overflow:hidden;${br}"><div style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;" title="${name}">${name}</div>${sub}</td>
          <td style="padding:3px 5px;font-size:11px;overflow:hidden;${br}" title="${dir}"><div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${dir || '<span style="opacity:0.3">—</span>'}</div></td>
          <td style="padding:3px 5px;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;${br}">${commune}</td>
          <td style="padding:3px 5px;font-size:11px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;${br}">${city}</td>
          <td style="padding:3px 5px;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;${br}">${region}</td>
          ${geoCell}
          ${vendorCell}
          ${actionsHtml}
        </tr>`;
      });

      html += '</tbody></table></div>';
      html += makePag('bottom');
      container.innerHTML = html;
      lucide.createIcons();
      _initDirColumnResizers(tableId);
    }

    function initDireccionesFromDB() {
      if (!allClients || allClients.length === 0) return;
      populateDirFilters();

      // Auto-seleccionar vendedor activo (Gestionar Rutas o Panel de Rutas)
      const vendorSelect = document.getElementById('dir-db-vendor');
      if (vendorSelect && !vendorSelect.value) {
        const activeVendor = selectedExecutiveId
          || document.getElementById('schedule-vendor')?.value
          || '';
        if (activeVendor) vendorSelect.value = activeVendor;
      }

      filterDireccionesDB();

      // Show import banner if Sheet has many more clients than DB
      const sheetCount = gsheetsAllDirecciones ? gsheetsAllDirecciones.length - 1 : 0;
      const dbCount = allClients.length;
      const bannerEl = document.getElementById('dir-import-banner');
      if (sheetCount > dbCount + 100 && bannerEl) {
        bannerEl.style.display = 'block';
        bannerEl.innerHTML = `
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <div style="flex:1;">
              <strong style="font-size:13px;">Google Sheets tiene ${sheetCount.toLocaleString()} clientes, pero solo ${dbCount.toLocaleString()} están en la base de datos.</strong>
              <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Haz click en "Importar Excel → DB" para migrar todos los clientes. Después de importar, se cargarán siempre desde la base de datos (más rápido).</div>
            </div>
            <button onclick="importAllFromSheets()" style="background:#10b981;color:white;border:none;padding:8px 16px;font-size:12px;border-radius:8px;cursor:pointer;font-weight:700;white-space:nowrap;">
              <i data-lucide="database" style="width:14px;height:14px;display:inline;vertical-align:-2px;"></i> Importar ${sheetCount.toLocaleString()} clientes
            </button>
          </div>`;
        lucide.createIcons();
      } else if (bannerEl) {
        bannerEl.style.display = 'none';
      }
    }

    // ====== CREATE CLIENT MODAL ======
    function openCreateClientModal() {
      const existing = document.getElementById('modal-create-client');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.id = 'modal-create-client';
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;';

      const vendorOptions = (executives || []).map(u => `<option value="${u.id}">${u.full_name}</option>`).join('');
      const regionOptions = [...new Set(allClients.map(c => c.region).filter(Boolean))].sort().map(r => `<option value="${r}">${r}</option>`).join('');

      overlay.innerHTML = `
        <div style="background:var(--bg-card);border-radius:14px;padding:0;max-width:520px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;max-height:90vh;overflow-y:auto;">
          <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:15px;font-weight:700;color:var(--text-primary);"><i data-lucide="user-plus" style="width:16px;height:16px;display:inline;vertical-align:-2px;"></i> Nuevo Cliente</h3>
            <button onclick="document.getElementById('modal-create-client').remove()" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--text-muted);line-height:1;padding:4px;">&times;</button>
          </div>
          <div style="padding:20px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Código (RUT)</label>
                <input type="text" id="cc-code" class="form-control" placeholder="Ej: 76.123.456-7" style="font-size:13px;">
                <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">Dejar vacío para auto-generar</div>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Nombre Fantasía *</label>
                <input type="text" id="cc-fantasy" class="form-control" style="font-size:13px;" placeholder="Nombre comercial">
              </div>
              <div class="form-group" style="grid-column:span 2;">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Razón Social *</label>
                <input type="text" id="cc-name" class="form-control" style="font-size:13px;" placeholder="Razón social completa">
              </div>
              <div class="form-group" style="grid-column:span 2;">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Dirección</label>
                <input type="text" id="cc-address" class="form-control" style="font-size:13px;" placeholder="Calle y número">
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Comuna</label>
                <input type="text" id="cc-commune" class="form-control" style="font-size:13px;">
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Ciudad</label>
                <input type="text" id="cc-city" class="form-control" style="font-size:13px;">
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Región</label>
                <select id="cc-region" class="form-control" style="font-size:13px;">
                  <option value="">-- Seleccionar --</option>
                  ${regionOptions}
                </select>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Vendedor</label>
                <select id="cc-vendor" class="form-control" style="font-size:13px;">
                  <option value="">Sin asignar</option>
                  ${vendorOptions}
                </select>
              </div>
            </div>
          </div>
          <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;">
            <button onclick="document.getElementById('modal-create-client').remove()" class="btn btn-secondary" style="font-size:12px;padding:7px 16px;">Cancelar</button>
            <button onclick="saveNewClient()" class="btn btn-primary" id="btn-save-new-client" style="font-size:12px;padding:7px 16px;">Crear Cliente</button>
          </div>
        </div>`;
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
      document.body.appendChild(overlay);
      lucide.createIcons();
      document.getElementById('cc-code').focus();
    }

    async function saveNewClient() {
      const code = document.getElementById('cc-code').value.trim();
      const name = document.getElementById('cc-name').value.trim();
      const fantasy = document.getElementById('cc-fantasy').value.trim();
      const address = document.getElementById('cc-address').value.trim();
      const commune = document.getElementById('cc-commune').value.trim();
      const city = document.getElementById('cc-city').value.trim();
      const region = document.getElementById('cc-region').value;
      const vendor = document.getElementById('cc-vendor').value;
      const btn = document.getElementById('btn-save-new-client');

      if (!name && !fantasy) {
        showToast('warning', 'Datos requeridos', 'Ingresa al menos nombre o nombre fantasía');
        return;
      }

      // Auto-generate code if empty
      const finalCode = code || ('CLI-' + Date.now().toString(36).toUpperCase());

      // Check duplicate
      if (allClients.find(c => c.external_id === finalCode)) {
        showToast('warning', 'Código duplicado', `Ya existe un cliente con código ${finalCode}`);
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Creando...';

      try {
        const body = {
          external_id: finalCode,
          name: name || fantasy,
          fantasy_name: fantasy || null,
          address: address || null,
          commune: commune || null,
          city: city || null,
          region: region || null,
          assigned_user_id: vendor || null
        };

        const res = await fetch(`${API}/api/clients`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        if (data.success) {
          allClients.push(data.data);
          showToast('success', 'Cliente creado', `${finalCode} — ${name || fantasy}`);
          document.getElementById('modal-create-client').remove();
          filterDireccionesDB();
        } else {
          showToast('error', 'Error', data.error);
          btn.disabled = false;
          btn.textContent = 'Crear Cliente';
        }
      } catch (e) {
        showToast('error', 'Error', e.message);
        btn.disabled = false;
        btn.textContent = 'Crear Cliente';
      }
    }

    // ====== EDIT CLIENT FULL MODAL ======
    function openEditClientFullModal(clientId) {
      const client = allClients.find(c => c.id === clientId);
      if (!client) { showToast('error', 'Error', 'Cliente no encontrado'); return; }

      const existing = document.getElementById('modal-edit-client-full');
      if (existing) existing.remove();

      const isAdmin = currentUser && currentUser.role === 'admin';
      const vendorOptions = (executives || []).map(u => `<option value="${u.id}" ${client.assigned_user_id === u.id ? 'selected' : ''}>${u.full_name}</option>`).join('');
      const regionOptions = [...new Set(allClients.map(c => c.region).filter(Boolean))].sort().map(r => `<option value="${r}" ${client.region === r ? 'selected' : ''}>${r}</option>`).join('');

      const overlay = document.createElement('div');
      overlay.id = 'modal-edit-client-full';
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;';

      overlay.innerHTML = `
        <div style="background:var(--bg-card);border-radius:14px;padding:0;max-width:520px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;max-height:90vh;overflow-y:auto;">
          <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h3 style="margin:0;font-size:15px;font-weight:700;color:var(--text-primary);">${isAdmin ? 'Editar' : 'Ver'} Cliente</h3>
              <div style="font-size:11px;color:var(--text-muted);margin-top:2px;"><code style="background:var(--bg-hover);padding:1px 5px;border-radius:3px;font-size:10px;">${client.external_id || ''}</code></div>
            </div>
            <button onclick="document.getElementById('modal-edit-client-full').remove()" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--text-muted);line-height:1;padding:4px;">&times;</button>
          </div>
          <div style="padding:20px;">
            <input type="hidden" id="ec-id" value="${client.id}">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Código</label>
                <input type="text" id="ec-code" class="form-control" value="${client.external_id || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Nombre Fantasía</label>
                <input type="text" id="ec-fantasy" class="form-control" value="${client.fantasy_name || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
              </div>
              <div class="form-group" style="grid-column:span 2;">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Razón Social</label>
                <input type="text" id="ec-name" class="form-control" value="${client.name || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
              </div>
              <div class="form-group" style="grid-column:span 2;">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Dirección</label>
                <input type="text" id="ec-address" class="form-control" value="${client.address || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Comuna</label>
                <input type="text" id="ec-commune" class="form-control" value="${client.commune || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Ciudad</label>
                <input type="text" id="ec-city" class="form-control" value="${client.city || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Región</label>
                <select id="ec-region" class="form-control" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
                  <option value="">—</option>
                  ${regionOptions}
                </select>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Vendedor</label>
                <select id="ec-vendor" class="form-control" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
                  <option value="">Sin asignar</option>
                  ${vendorOptions}
                </select>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Zona</label>
                <input type="text" id="ec-zone" class="form-control" value="${client.zone || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
              </div>
              <div class="form-group">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Segmento</label>
                <select id="ec-segment" class="form-control" style="font-size:13px;" ${isAdmin ? '' : 'disabled'}>
                  <option value="">—</option>
                  <option value="A" ${client.segment === 'A' ? 'selected' : ''}>A - 80/20 Top</option>
                  <option value="B" ${client.segment === 'B' ? 'selected' : ''}>B - Con dirección</option>
                  <option value="C" ${client.segment === 'C' ? 'selected' : ''}>C - Con vendedor</option>
                  <option value="D" ${client.segment === 'D' ? 'selected' : ''}>D - Potencial</option>
                  <option value="E" ${client.segment === 'E' ? 'selected' : ''}>E - Sin dirección</option>
                </select>
              </div>
              <div class="form-group" style="grid-column:span 2;">
                <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Geo Link</label>
                <input type="text" id="ec-geolink" class="form-control" value="${client.geo_link || ''}" style="font-size:13px;" ${isAdmin ? '' : 'disabled'} placeholder="URL de Google Maps">
              </div>
            </div>
            ${client.address_updated_at ? `<div style="margin-top:12px;padding:8px 12px;background:var(--bg-hover);border-radius:8px;font-size:11px;color:var(--text-muted);">Última modificación: ${new Date(client.address_updated_at).toLocaleString('es-CL')}</div>` : ''}
          </div>
          <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;">
            <button onclick="document.getElementById('modal-edit-client-full').remove()" class="btn btn-secondary" style="font-size:12px;padding:7px 16px;">Cerrar</button>
            ${isAdmin ? `<button onclick="saveEditClientFull()" class="btn btn-primary" id="btn-save-edit-client" style="font-size:12px;padding:7px 16px;">Guardar</button>` : ''}
          </div>
        </div>`;
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
      document.body.appendChild(overlay);
      lucide.createIcons();
    }

    async function saveEditClientFull() {
      const clientId = document.getElementById('ec-id').value;
      const btn = document.getElementById('btn-save-edit-client');

      const body = {
        external_id: document.getElementById('ec-code').value.trim(),
        name: document.getElementById('ec-name').value.trim(),
        fantasy_name: document.getElementById('ec-fantasy').value.trim() || null,
        address: document.getElementById('ec-address').value.trim() || null,
        commune: document.getElementById('ec-commune').value.trim() || null,
        city: document.getElementById('ec-city').value.trim() || null,
        region: document.getElementById('ec-region').value || null,
        zone: document.getElementById('ec-zone').value.trim() || null,
        segment: document.getElementById('ec-segment').value || null,
        assigned_user_id: document.getElementById('ec-vendor').value || null,
        geo_link: document.getElementById('ec-geolink').value.trim() || null
      };

      if (!body.name && !body.fantasy_name) {
        showToast('warning', 'Datos requeridos', 'Ingresa al menos nombre o nombre fantasía');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Guardando...';

      try {
        const res = await fetch(`${API}/api/clients/${clientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        if (data.success) {
          // Update local allClients
          const idx = allClients.findIndex(c => c.id === clientId);
          if (idx !== -1) {
            allClients[idx] = { ...allClients[idx], ...data.data };
          }
          showToast('success', 'Cliente actualizado', `${body.external_id} — guardado en BD + Excel`);
          document.getElementById('modal-edit-client-full').remove();
          filterDireccionesDB();
        } else {
          showToast('error', 'Error', data.error);
          btn.disabled = false;
          btn.textContent = 'Guardar';
        }
      } catch (e) {
        showToast('error', 'Error', e.message);
        btn.disabled = false;
        btn.textContent = 'Guardar';
      }
    }

    // ====== DELETE CLIENT ======
    async function deleteClientFromDirecciones(clientId, code, name) {
      if (!confirm(`¿Eliminar cliente ${name} (${code})?\n\nSe eliminará de la base de datos y del Excel.`)) return;

      try {
        const res = await fetch(`${API}/api/clients/${clientId}`, { method: 'DELETE' });
        const data = await res.json();

        if (data.success) {
          allClients = allClients.filter(c => c.id !== clientId);
          showToast('success', 'Cliente eliminado', `${code} — eliminado de BD + Excel`);
          filterDireccionesDB();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (e) {
        showToast('error', 'Error', e.message);
      }
    }

    // ====== IMPORT FROM SHEETS ======
    async function importAllFromSheets() {
      // First check if we have sheet data
      if (!gsheetsAllDirecciones || gsheetsAllDirecciones.length < 2) {
        showToast('info', 'Cargando Excel', 'Descargando datos de Google Sheets primero...');
        try {
          const res = await fetch(`${API}/api/gsheets/Direcciones`);
          const result = await res.json();
          if (result.success && result.data && result.data.length > 1) {
            gsheetsAllDirecciones = cleanSheetData(result.data);
          } else {
            showToast('error', 'Sin datos', 'No se pudo cargar datos de Google Sheets');
            return;
          }
        } catch (e) {
          showToast('error', 'Error', 'No se pudo conectar con Google Sheets: ' + e.message);
          return;
        }
      }

      const headers = gsheetsAllDirecciones[0].map(h => String(h || '').trim().toLowerCase());
      const rows = gsheetsAllDirecciones.slice(1).filter(r => r.some(c => c !== '' && c != null));

      const colCode = headers.findIndex(h => h.includes('cod'));
      const colRazon = headers.findIndex(h => h.includes('raz'));
      const colFantasia = headers.findIndex(h => h.includes('fan'));
      const colDir = headers.findIndex(h => h.includes('direcc') || h.includes('address'));
      const colComuna = headers.findIndex(h => h.includes('comun'));
      const colCiudad = headers.findIndex(h => h.includes('ciudad'));
      const colRegion = headers.findIndex(h => h.includes('region') || h.includes('región'));
      const colLink = headers.findIndex(h => h.includes('link') || h.includes('geo'));

      if (colCode === -1) {
        showToast('error', 'Error', 'No se encontró columna de código');
        return;
      }

      const cell = (row, idx) => idx >= 0 && row[idx] ? String(row[idx]).trim() : '';

      const importRows = rows.map(row => ({
        external_id: cell(row, colCode),
        name: cell(row, colRazon) || cell(row, colFantasia) || cell(row, colCode),
        fantasy_name: cell(row, colFantasia) || null,
        address: cell(row, colDir) || null,
        commune: cell(row, colComuna) || null,
        city: cell(row, colCiudad) || null,
        region: cell(row, colRegion) || null,
        geo_link: cell(row, colLink) || null
      })).filter(r => r.external_id);

      if (!confirm(`¿Importar ${importRows.length.toLocaleString()} clientes de Google Sheets a la base de datos?\n\nExistentes se actualizarán, nuevos se crearán.`)) return;

      // Show progress
      const progressDiv = document.getElementById('dir-import-progress');
      const progressBar = document.getElementById('dir-import-bar');
      const progressTitle = document.getElementById('dir-import-title');
      const progressDetail = document.getElementById('dir-import-detail');
      if (progressDiv) progressDiv.style.display = 'block';

      const batchSize = 200;
      let totalCreated = 0, totalUpdated = 0, totalErrors = 0;

      try {
        for (let i = 0; i < importRows.length; i += batchSize) {
          const batch = importRows.slice(i, i + batchSize);
          const pct = Math.round(((i + batch.length) / importRows.length) * 100);

          if (progressBar) progressBar.style.width = pct + '%';
          if (progressTitle) progressTitle.textContent = `Importando... ${pct}%`;
          if (progressDetail) progressDetail.textContent = `${i + batch.length} / ${importRows.length}`;

          const res = await fetch(`${API}/api/clients/import-from-sheets`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rows: batch })
          });
          const data = await res.json();

          if (data.success && data.data) {
            totalCreated += data.data.created || 0;
            totalUpdated += data.data.updated || 0;
            totalErrors += (data.data.errors || []).length;
          }
        }

        if (progressTitle) progressTitle.textContent = 'Importación completada';
        if (progressDetail) progressDetail.textContent = `${totalCreated} creados, ${totalUpdated} actualizados${totalErrors ? `, ${totalErrors} errores` : ''}`;
        if (progressBar) progressBar.style.width = '100%';

        showToast('success', 'Importación completa', `${totalCreated} creados, ${totalUpdated} actualizados`);

        // Reload allClients from DB
        const clientsRes = await fetch(`${API}/api/clients`);
        const clientsData = await clientsRes.json();
        if (clientsData.success) {
          allClients = clientsData.data;
          filterDireccionesDB();
          populateDirFilters();
        }

        // Hide progress after 3 seconds
        setTimeout(() => { if (progressDiv) progressDiv.style.display = 'none'; }, 3000);

      } catch (e) {
        showToast('error', 'Error importación', e.message);
        if (progressTitle) progressTitle.textContent = 'Error en importación';
        if (progressDetail) progressDetail.textContent = e.message;
      }
    }

    // Build Google Maps search URL from address
    function _buildMapsSearchUrl(address, commune, city) {
      const parts = [address, commune, city, 'Chile'].filter(Boolean);
      return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(parts.join(', '));
    }

    function renderDireccionesCustomTable(data, containerId, page) {
      const container = document.getElementById(containerId);
      if (!data || data.length < 2) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">Sin datos</p>';
        return;
      }
      _dirCurrentPage = page;

      const headers = data[0].map(h => String(h || '').trim().toLowerCase());
      let rows = data.slice(1).filter(r => r.some(c => c !== '' && c != null));

      const colCode = headers.findIndex(h => h.includes('cod'));
      const colRazon = headers.findIndex(h => h.includes('raz'));
      const colFantasia = headers.findIndex(h => h.includes('fan'));
      const colComuna = headers.findIndex(h => h.includes('comun'));
      const colCiudad = headers.findIndex(h => h.includes('ciudad'));
      const colDir = headers.findIndex(h => h.includes('direcc') || h.includes('address'));
      const colLink = headers.findIndex(h => h.includes('link') || h.includes('geo'));
      const colModPor = headers.findIndex(h => h.includes('modificado por') || h.includes('updated by'));
      const colModAt = headers.findIndex(h => h.includes('ltima modif') || h.includes('fecha modif') || h.includes('updated at'));

      const geoCount = rows.filter(r => colLink >= 0 && r[colLink] && String(r[colLink]).trim()).length;
      const noGeoCount = rows.length - geoCount;

      // Apply geo filter
      if (_dirFilterGeo === 'has') {
        rows = rows.filter(r => colLink >= 0 && r[colLink] && String(r[colLink]).trim());
      } else if (_dirFilterGeo === 'none') {
        rows = rows.filter(r => !(colLink >= 0 && r[colLink] && String(r[colLink]).trim()));
      }

      const pageSize = 100;
      const start = page * pageSize;
      const pageRows = rows.slice(start, start + pageSize);
      const totalPages = Math.ceil(rows.length / pageSize);

      const cell = (row, idx) => idx >= 0 && row[idx] ? String(row[idx]).trim() : '';
      const isAdmin = currentUser && currentUser.role === 'admin';

      // Column config — proportional to available width
      const wrapEl = document.getElementById(containerId);
      const availW = wrapEl ? wrapEl.clientWidth - 20 : 900;
      const baseW = Math.max(availW, 750);
      const cols = [
        { key: 'code', label: 'Código', w: Math.round(baseW * 0.09) },
        { key: 'client', label: 'Cliente', w: Math.round(baseW * 0.20) },
        { key: 'address', label: 'Dirección', w: Math.round(baseW * 0.28) },
        { key: 'commune', label: 'Comuna', w: Math.round(baseW * 0.13) },
        { key: 'city', label: 'Ciudad', w: Math.round(baseW * 0.10) },
        { key: 'geo', label: 'Mapa', w: Math.round(baseW * 0.05) },
        { key: 'edited', label: 'Editado', w: Math.round(baseW * 0.10) },
      ];
      if (isAdmin) cols.push({ key: 'edit', label: '', w: Math.round(baseW * 0.04) });

      // Restore saved widths
      if (_dirColWidths) {
        cols.forEach((c, i) => { if (_dirColWidths[i]) c.w = _dirColWidths[i]; });
      }

      // Filter buttons
      const filterBtns = `
        <button onclick="_dirFilterGeo=_dirFilterGeo==='has'?false:'has';renderDireccionesCustomTable(gsheetsAllDirecciones,'${containerId}',0)" style="padding:3px 8px;border:1px solid ${_dirFilterGeo === 'has' ? '#10b981' : 'var(--border)'};border-radius:5px;background:${_dirFilterGeo === 'has' ? 'rgba(16,185,129,0.1)' : 'transparent'};color:${_dirFilterGeo === 'has' ? '#10b981' : 'var(--text-muted)'};font-size:11px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:3px;white-space:nowrap;"><i data-lucide="map-pin" style="width:11px;height:11px;"></i>${geoCount} con geo</button>
        <button onclick="_dirFilterGeo=_dirFilterGeo==='none'?false:'none';renderDireccionesCustomTable(gsheetsAllDirecciones,'${containerId}',0)" style="padding:3px 8px;border:1px solid ${_dirFilterGeo === 'none' ? '#f59e0b' : 'var(--border)'};border-radius:5px;background:${_dirFilterGeo === 'none' ? 'rgba(245,158,11,0.1)' : 'transparent'};color:${_dirFilterGeo === 'none' ? '#f59e0b' : 'var(--text-muted)'};font-size:11px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:3px;white-space:nowrap;"><i data-lucide="map-pin-off" style="width:11px;height:11px;"></i>${noGeoCount.toLocaleString()} sin geo</button>`;

      // Pagination bar
      const makePagination = (pos) => {
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 12px;background:var(--bg-hover);border-radius:8px;margin-${pos === 'top' ? 'bottom' : 'top'}:6px;flex-wrap:wrap;gap:6px;">
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:12px;color:var(--text-secondary);font-weight:600;">${rows.length.toLocaleString()}</span>
            ${filterBtns}
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            ${totalPages > 1 ? `
              ${page > 0 ? `<button onclick="renderDireccionesCustomTable(gsheetsAllDirecciones,'${containerId}',${page - 1})" style="padding:3px 8px;border:1px solid var(--border);border-radius:5px;background:var(--bg-card);color:var(--text-secondary);font-size:11px;cursor:pointer;">←</button>` : ''}
              <span style="font-size:12px;font-weight:700;color:var(--text-primary);">${page + 1}/${totalPages}</span>
              ${page < totalPages - 1 ? `<button onclick="renderDireccionesCustomTable(gsheetsAllDirecciones,'${containerId}',${page + 1})" style="padding:3px 8px;border:1px solid var(--border);border-radius:5px;background:var(--bg-card);color:var(--text-secondary);font-size:11px;cursor:pointer;">→</button>` : ''}
            ` : ''}
          </div>
        </div>`;
      };

      let html = makePagination('top');

      // Table with resizable columns — compute total width in px
      const tableId = 'dir-resize-table';
      const totalW = cols.reduce((s, c) => s + c.w, 0);
      const colGroupHtml = cols.map((c, i) => `<col data-col="${i}" style="width:${c.w}px;">`).join('');

      html += `<div class="gs-table-wrap" style="overflow-x:auto;"><table id="${tableId}" class="gs-table" style="font-size:12px;table-layout:fixed;width:${totalW}px;min-width:650px;">
        <colgroup>${colGroupHtml}</colgroup>
        <thead><tr>`;

      cols.forEach((c, i) => {
        const isLast = i === cols.length - 1;
        const canResize = c.key !== 'edit' && !isLast;
        // Visible separator line + wider grab area for resizer
        const borderRight = !isLast ? 'border-right:1px solid var(--border);' : '';
        const resizer = canResize ? `<div class="dir-col-resizer" data-col="${i}" style="position:absolute;right:-4px;top:0;bottom:0;width:9px;cursor:col-resize;z-index:3;background:transparent;" onmouseenter="this.style.background='rgba(99,102,241,0.3)'" onmouseleave="this.style.background='transparent'"></div>` : '';
        const align = c.key === 'geo' ? 'text-align:center;' : '';
        html += `<th style="padding:6px 5px;font-size:11px;position:relative;${align}${borderRight}user-select:none;overflow:hidden;">${c.label}${resizer}</th>`;
      });

      html += `</tr></thead><tbody>`;

      pageRows.forEach(row => {
        const code = cell(row, colCode);
        const razon = toTitleCase(cell(row, colRazon));
        const fantasia = toTitleCase(cell(row, colFantasia));
        const comuna = toTitleCase(cell(row, colComuna));
        const ciudad = toTitleCase(cell(row, colCiudad));
        const dir = toTitleCase(cell(row, colDir));
        const link = cell(row, colLink);
        const modPor = cell(row, colModPor);
        const modAt = cell(row, colModAt);

        const clientName = fantasia || razon || '-';
        const clientSub = fantasia && razon && fantasia !== razon ? `<div style="font-size:9px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${razon}</div>` : '';

        const hasGeoLink = !!link;
        const rowBg = hasGeoLink ? 'background:rgba(16,185,129,0.04);' : '';

        // Safe strings for onclick handlers (must be before geo cell)
        const safeDir = dir.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeComuna = comuna.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const safeName = clientName.replace(/'/g, "\\'").replace(/"/g, '&quot;');

        // Geo cell: green = existing link from Excel, blue = search Maps, click to add
        let geoCell;
        if (hasGeoLink) {
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><a href="${link}" target="_blank" rel="noopener" title="Geo verificado — Click para ver en mapa" style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:rgba(16,185,129,0.15);color:#10b981;text-decoration:none;"><i data-lucide="map-pin" style="width:14px;height:14px;"></i></a></td>`;
        } else if (dir && isAdmin) {
          const mapsUrl = _buildMapsSearchUrl(dir, comuna, ciudad);
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><a href="${mapsUrl}" target="_blank" rel="noopener" title="Buscar en Maps: ${dir}, ${comuna}" style="display:inline-flex;align-items:center;justify-content:center;width:13px;height:26px;border-radius:50%;color:rgba(99,102,241,0.4);text-decoration:none;"><i data-lucide="search" style="width:12px;height:12px;"></i></a><button onclick="openAddGeoLink('${code}','${safeName}','${safeDir}','${safeComuna}')" title="Agregar georeferencia" style="border:none;background:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:13px;height:26px;color:rgba(245,158,11,0.6);"><i data-lucide="plus" style="width:11px;height:11px;"></i></button></td>`;
        } else if (dir) {
          const mapsUrl = _buildMapsSearchUrl(dir, comuna, ciudad);
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><a href="${mapsUrl}" target="_blank" rel="noopener" title="Buscar en Google Maps" style="display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;color:rgba(99,102,241,0.35);text-decoration:none;"><i data-lucide="search" style="width:12px;height:12px;"></i></a></td>`;
        } else {
          geoCell = `<td style="padding:3px 2px;text-align:center;border-right:1px solid var(--border);"><span style="color:var(--text-muted);opacity:0.15;">—</span></td>`;
        }

        let modHtml = '<span style="color:var(--text-muted);opacity:0.2;font-size:10px;">—</span>';
        if (modPor || modAt) {
          const modName = modPor.replace(/@.*/, '');
          const modDate = modAt ? new Date(modAt).toLocaleDateString('es-CL') : '';
          modHtml = `<div style="font-size:10px;line-height:1.3;"><strong style="color:var(--text-secondary);">${modName}</strong>${modDate ? `<br><span style="color:var(--text-muted);">${modDate}</span>` : ''}</div>`;
        }
        const editBtn = isAdmin ? `<td style="padding:3px 2px;text-align:center;"><button onclick="openEditDireccion('${code}','${safeName}','${safeDir}','${safeComuna}')" class="btn-icon" title="Editar" style="padding:2px;"><i data-lucide="pencil" style="width:12px;height:12px;"></i></button></td>` : '';

        const br = 'border-right:1px solid var(--border);';
        html += `<tr style="${rowBg}">
          <td style="padding:3px 5px;overflow:hidden;${br}"><code style="font-size:10px;background:var(--bg-hover);padding:1px 3px;border-radius:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;">${code}</code></td>
          <td style="padding:3px 5px;overflow:hidden;${br}"><div style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;" title="${clientName}">${clientName}</div>${clientSub}</td>
          <td style="padding:3px 5px;font-size:11px;overflow:hidden;${br}" title="${dir}"><div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${dir || '<span style="opacity:0.3">—</span>'}</div></td>
          <td style="padding:3px 5px;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;${br}">${comuna}</td>
          <td style="padding:3px 5px;font-size:11px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;${br}">${ciudad}</td>
          ${geoCell}
          <td style="padding:3px 5px;overflow:hidden;${isAdmin ? br : ''}">${modHtml}</td>
          ${editBtn}
        </tr>`;
      });

      html += '</tbody></table></div>';
      html += makePagination('bottom');

      container.innerHTML = html;
      lucide.createIcons();

      // Initialize column resizers
      _initDirColumnResizers(tableId);
    }

    // Column resize system (drag borders like Excel)
    function _initDirColumnResizers(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const ths = table.querySelectorAll('thead th');
      const colEls = table.querySelectorAll('colgroup col');

      ths.forEach((th, idx) => {
        const resizer = th.querySelector('.dir-col-resizer');
        if (!resizer) return;

        resizer.addEventListener('mousedown', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const colIdx = parseInt(this.dataset.col);
          const col = colEls[colIdx];
          if (!col) return;

          const startX = e.pageX;
          const startW = th.getBoundingClientRect().width;
          const startTableW = table.getBoundingClientRect().width;
          const resizerEl = this;

          // Visual feedback
          resizerEl.style.background = 'rgba(99,102,241,0.6)';
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';

          const onMove = (ev) => {
            const diff = ev.pageX - startX;
            const newW = Math.max(30, Math.round(startW + diff));
            col.style.width = newW + 'px';
            // Update table total width so other columns keep their size
            table.style.width = Math.round(startTableW + diff) + 'px';
          };
          const onUp = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onUp);
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            resizerEl.style.background = 'transparent';
            // Save widths for persistence across pagination
            if (!_dirColWidths) _dirColWidths = {};
            _dirColWidths[colIdx] = parseInt(col.style.width);
          };
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', onUp);
        });
      });
    }

    async function reloadDireccionesFromSheet() {
      showToast('info', 'Recargando', 'Obteniendo datos actualizados del Excel...');
      try {
        const res = await fetch(`${API}/api/gsheets/Direcciones`);
        const result = await res.json();
        if (result.success && result.data && result.data.length > 1) {
          gsheetsAllDirecciones = cleanSheetData(result.data);
          showToast('success', 'Listo', `${result.data.length - 1} direcciones cargadas desde Excel (datos disponibles para importar)`);
        } else {
          showToast('warning', 'Sin datos', 'No se encontraron datos en la hoja Direcciones');
        }
      } catch (e) {
        showToast('error', 'Error', 'No se pudo conectar con Google Sheets');
      }
    }

    function filterGsheetsDirecciones() {
      // Delegate to DB filter (backward compat)
      filterDireccionesDB();
    }

    // Editar dirección desde tabla Direcciones (modal rápido)
    function openEditDireccion(code, name, address, commune) {
      const existing = document.getElementById('modal-edit-direccion');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.id = 'modal-edit-direccion';
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
      overlay.innerHTML = `
        <div style="background:var(--bg-card);border-radius:14px;padding:0;max-width:440px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
          <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h3 style="margin:0;font-size:15px;font-weight:700;color:var(--text-primary);">Editar Dirección</h3>
              <div style="font-size:11px;color:var(--text-muted);margin-top:2px;"><code style="background:var(--bg-hover);padding:1px 5px;border-radius:3px;font-size:10px;">${code}</code> ${name}</div>
            </div>
            <button onclick="document.getElementById('modal-edit-direccion').remove()" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--text-muted);line-height:1;padding:4px;">&times;</button>
          </div>
          <div style="padding:20px;">
            <div class="form-group" style="margin-bottom:14px;">
              <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Dirección</label>
              <input type="text" id="edit-dir-address" class="form-control" value="${address}" style="font-size:13px;">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Comuna</label>
              <input type="text" id="edit-dir-commune" class="form-control" value="${commune}" style="font-size:13px;">
            </div>
            <input type="hidden" id="edit-dir-code" value="${code}">
          </div>
          <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;">
            <button onclick="document.getElementById('modal-edit-direccion').remove()" class="btn btn-secondary" style="font-size:12px;padding:7px 16px;">Cancelar</button>
            <button onclick="saveEditDireccion()" class="btn btn-primary" id="btn-save-dir" style="font-size:12px;padding:7px 16px;">Guardar</button>
          </div>
        </div>`;
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
      document.body.appendChild(overlay);
      document.getElementById('edit-dir-address').focus();
    }

    async function saveEditDireccion() {
      const code = document.getElementById('edit-dir-code').value;
      const address = document.getElementById('edit-dir-address').value.trim();
      const commune = document.getElementById('edit-dir-commune').value.trim();
      const btn = document.getElementById('btn-save-dir');

      if (!address && !commune) {
        showToast('warning', 'Sin datos', 'Ingresa al menos una dirección o comuna');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Guardando...';

      try {
        // 1. Find client in allClients by external_id
        const client = allClients.find(c => c.external_id === code);

        // 2. If client exists in Supabase, update there (auto-syncs to Sheet)
        if (client) {
          const res = await fetch(`${API}/api/clients/${client.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address, commune })
          });
          const data = await res.json();
          if (data.success) {
            // Update local allClients
            const idx = allClients.findIndex(c => c.id === client.id);
            if (idx !== -1) {
              allClients[idx].address = address;
              allClients[idx].commune = commune;
              allClients[idx].address_updated_at = new Date().toISOString();
            }
            showToast('success', 'Dirección actualizada', `${code} — guardado en BD + Excel`);
          } else {
            showToast('error', 'Error BD', data.error);
            btn.disabled = false;
            btn.textContent = 'Guardar';
            return;
          }
        } else {
          // 3. Client only in Sheet, sync directly to Sheet
          const res = await fetch(`${API}/api/clients/sync-to-sheet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates: [{ code, address, commune }] })
          });
          const data = await res.json();
          if (data.success) {
            showToast('success', 'Excel actualizado', `${code} — actualizado en Google Sheet`);
          } else {
            showToast('error', 'Error', data.error);
            btn.disabled = false;
            btn.textContent = 'Guardar';
            return;
          }
        }

        // 4. Update local sheet data and re-render
        if (gsheetsAllDirecciones) {
          const headers = gsheetsAllDirecciones[0].map(h => String(h || '').trim().toLowerCase());
          const colCode = headers.findIndex(h => h.includes('cod'));
          const colDir = headers.findIndex(h => h.includes('direcc') || h.includes('address'));
          const colComuna = headers.findIndex(h => h.includes('comun'));
          const colModPor = headers.findIndex(h => h.includes('modificado por'));
          const colModAt = headers.findIndex(h => h.includes('ltima modif'));
          const user = JSON.parse(localStorage.getItem('leker_user') || '{}');

          for (let i = 1; i < gsheetsAllDirecciones.length; i++) {
            if (String(gsheetsAllDirecciones[i][colCode]).trim() === code) {
              if (colDir >= 0) gsheetsAllDirecciones[i][colDir] = address;
              if (colComuna >= 0) gsheetsAllDirecciones[i][colComuna] = commune;
              if (colModPor >= 0) gsheetsAllDirecciones[i][colModPor] = user.email || 'admin';
              if (colModAt >= 0) gsheetsAllDirecciones[i][colModAt] = new Date().toISOString();
              break;
            }
          }
          filterDireccionesDB();
        }

        document.getElementById('modal-edit-direccion').remove();
      } catch (error) {
        showToast('error', 'Error de conexión', error.message);
        btn.disabled = false;
        btn.textContent = 'Guardar';
      }
    }

    // Save a geo link to Google Sheet for a specific client code
    async function saveGeoLinkToSheet(code, geoLink) {
      if (!code || !geoLink) return;
      try {
        showToast('info', 'Guardando geo', `Guardando link para ${code}...`);
        const data = await _postGeoLinksBatch([{ code, geoLink }]);
        if (data.success) {
          // Update local data
          if (gsheetsAllDirecciones) {
            const headers = gsheetsAllDirecciones[0].map(h => String(h || '').trim().toLowerCase());
            const colCode = headers.findIndex(h => h.includes('cod'));
            const colLink = headers.findIndex(h => h.includes('link') || h.includes('geo'));
            if (colLink >= 0) {
              for (let i = 1; i < gsheetsAllDirecciones.length; i++) {
                if (String(gsheetsAllDirecciones[i][colCode]).trim() === code) {
                  gsheetsAllDirecciones[i][colLink] = geoLink;
                  break;
                }
              }
            }
            // Also update allClients geo_link
            const cl = allClients.find(c => c.external_id === code);
            if (cl) cl.geo_link = geoLink;
            filterDireccionesDB();
            if (gsheetsData) { _gsCacheSet(gsheetsData); }
          }
          showToast('success', 'Geo guardado', `Link guardado en Excel para ${code}`);
        } else {
          showToast('error', 'Error', data.error || 'No se pudo guardar');
        }
      } catch (e) {
        showToast('error', 'Error', e.message);
      }
    }

    // Open modal to add geo link for a client
    function openAddGeoLink(code, name, address, commune) {
      const mapsUrl = _buildMapsSearchUrl(address, commune, '');
      const existing = document.getElementById('modal-add-geo');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.id = 'modal-add-geo';
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
      overlay.innerHTML = `
        <div style="background:var(--bg-card);border-radius:14px;padding:0;max-width:480px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
          <div style="padding:16px 20px;border-bottom:1px solid var(--border);">
            <h3 style="margin:0;font-size:15px;font-weight:700;color:var(--text-primary);">Agregar Georeferencia</h3>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;"><code style="background:var(--bg-hover);padding:1px 5px;border-radius:3px;font-size:10px;">${code}</code> ${name}</div>
          </div>
          <div style="padding:16px 20px;">
            <div style="background:rgba(99,102,241,0.06);border-radius:8px;padding:12px;margin-bottom:14px;">
              <p style="font-size:12px;color:var(--text-secondary);margin:0 0 8px;">1. Abre Google Maps con la dirección:</p>
              <a href="${mapsUrl}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--accent);color:white;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none;"><i data-lucide="map" style="width:14px;height:14px;"></i> Abrir en Google Maps</a>
              <p style="font-size:11px;color:var(--text-muted);margin:8px 0 0;">2. Verifica que el punto sea correcto, luego copia el link de Maps (Compartir → Copiar enlace).</p>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block;">Pega el link de Google Maps</label>
              <input type="text" id="add-geo-link" class="form-control" placeholder="https://maps.app.goo.gl/..." style="font-size:13px;">
            </div>
            <input type="hidden" id="add-geo-code" value="${code}">
          </div>
          <div style="padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;">
            <button onclick="document.getElementById('modal-add-geo').remove()" class="btn btn-secondary" style="font-size:12px;padding:7px 16px;">Cancelar</button>
            <button onclick="_saveGeoFromModal()" class="btn btn-primary" id="btn-save-geo" style="font-size:12px;padding:7px 16px;">Guardar Geo</button>
          </div>
        </div>`;
      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
      document.body.appendChild(overlay);
      lucide.createIcons();
      document.getElementById('add-geo-link').focus();
    }

    async function _saveGeoFromModal() {
      const code = document.getElementById('add-geo-code').value;
      const link = document.getElementById('add-geo-link').value.trim();
      const btn = document.getElementById('btn-save-geo');
      if (!link) {
        showToast('warning', 'Sin link', 'Pega el link de Google Maps');
        return;
      }
      if (!link.includes('google') && !link.includes('goo.gl') && !link.includes('maps')) {
        showToast('warning', 'Link inválido', 'El link debe ser de Google Maps');
        return;
      }
      btn.disabled = true;
      btn.textContent = 'Guardando...';
      await saveGeoLinkToSheet(code, link);
      const modal = document.getElementById('modal-add-geo');
      if (modal) modal.remove();
    }

    // Batch generate Google Maps links for all addresses without geo and save to Sheet
    let _batchGeoAbort = false;
    let _batchGeoRunning = false;

    function stopBatchGeoLinks() {
      _batchGeoAbort = true;
      const stopBtn = document.getElementById('btn-batch-geo-stop');
      if (stopBtn) {
        stopBtn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width:13px;height:13px;"></i> Deteniendo...';
        lucide.createIcons();
      }
    }

    /**
     * POST geo links via backend API
     */
    async function _postGeoLinksBatch(rows) {
      const res = await fetch(`${API}/api/clients/save-geo-link`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ batch: rows })
      });
      return await res.json();
    }

    /**
     * Auto-genera y guarda geo links para direcciones sin geo.
     * Se ejecuta automáticamente en segundo plano después de cargar datos.
     * También se puede llamar manualmente con el botón.
     * @param {boolean} manual - true si fue llamado por el usuario (muestra confirm)
     */
    async function batchGenerateGeoLinks(manual = true) {
      if (_batchGeoRunning) return;
      if (!gsheetsAllDirecciones || gsheetsAllDirecciones.length < 2) {
        if (manual) showToast('warning', 'Sin datos', 'Carga los datos del Excel primero');
        return;
      }
      if (!currentUser || currentUser.role !== 'admin') {
        if (manual) showToast('warning', 'Sin permiso', 'Solo admin puede cargar geo links');
        return;
      }

      const headers = gsheetsAllDirecciones[0].map(h => String(h || '').trim().toLowerCase());
      const colCode = headers.findIndex(h => h.includes('cod'));
      const colDir = headers.findIndex(h => h.includes('direcc') || h.includes('address'));
      const colComuna = headers.findIndex(h => h.includes('comun'));
      const colCiudad = headers.findIndex(h => h.includes('ciudad'));
      const colLink = headers.findIndex(h => h.includes('link') || h.includes('geo'));

      const toProcess = [];
      for (let i = 1; i < gsheetsAllDirecciones.length; i++) {
        const row = gsheetsAllDirecciones[i];
        const code = colCode >= 0 ? String(row[colCode] || '').trim() : '';
        const dir = colDir >= 0 ? String(row[colDir] || '').trim() : '';
        const hasLink = colLink >= 0 && row[colLink] && String(row[colLink]).trim();
        if (code && dir && !hasLink) {
          const comuna = colComuna >= 0 ? String(row[colComuna] || '').trim() : '';
          const ciudad = colCiudad >= 0 ? String(row[colCiudad] || '').trim() : '';
          toProcess.push({ code, dir, comuna, ciudad, rowIdx: i });
        }
      }

      if (toProcess.length === 0) {
        if (manual) showToast('info', 'Todo listo', 'Todas las direcciones ya tienen geo link');
        return;
      }

      // If manual, ask confirmation. If auto, just run silently.
      const btn = document.getElementById('btn-batch-geo');
      const stopBtn = document.getElementById('btn-batch-geo-stop');
      if (manual) {
        const confirmed = confirm(`Se generarán links de Google Maps para ${toProcess.length.toLocaleString()} direcciones sin geo y se guardarán en el Excel.\n\n¿Continuar?`);
        if (!confirmed) return;
      }

      _batchGeoAbort = false;
      _batchGeoRunning = true;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = `<i data-lucide="loader-2" class="spin" style="width:13px;height:13px;"></i> 0% (0/${toProcess.length})`;
      }
      if (stopBtn) { stopBtn.style.display = 'inline-flex'; }
      lucide.createIcons();

      // Batches of 20 — POST directo al Apps Script (sin Vercel timeout)
      const BATCH_SIZE = 20;
      let processed = 0;
      let saved = 0;
      let errors = 0;
      let stopped = false;

      for (let b = 0; b < toProcess.length; b += BATCH_SIZE) {
        if (_batchGeoAbort) { stopped = true; break; }

        const batch = toProcess.slice(b, b + BATCH_SIZE);
        const rows = batch.map(item => ({
          code: item.code,
          geoLink: _buildMapsSearchUrl(item.dir, item.comuna, item.ciudad)
        }));

        try {
          const data = await _postGeoLinksBatch(rows);
          if (data.success) {
            saved += batch.length;
            batch.forEach((item, j) => {
              if (colLink >= 0) gsheetsAllDirecciones[item.rowIdx][colLink] = rows[j].geoLink;
            });
          } else {
            errors += batch.length;
          }
        } catch (e) {
          errors += batch.length;
          console.warn('[GeoLink] Batch error:', e.message);
        }

        processed += batch.length;
        const pct = Math.round((processed / toProcess.length) * 100);
        if (btn) {
          btn.innerHTML = `<i data-lucide="loader-2" class="spin" style="width:13px;height:13px;"></i> ${pct}% (${processed}/${toProcess.length})`;
          lucide.createIcons();
        }

        // Delay between batches
        if (b + BATCH_SIZE < toProcess.length) {
          await new Promise(r => setTimeout(r, 800));
        }
      }

      // Reset
      _batchGeoRunning = false;
      if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="locate" style="width:13px;height:13px;"></i> Cargar Geo'; }
      if (stopBtn) { stopBtn.style.display = 'none'; stopBtn.innerHTML = '<i data-lucide="square" style="width:13px;height:13px;"></i> Detener'; }
      lucide.createIcons();

      // Update table from DB (geo links saved to Sheet, re-render DB view)
      filterDireccionesDB();
      if (gsheetsData) { _gsCacheSet(gsheetsData); }

      const remaining = toProcess.length - processed;
      if (stopped) {
        showToast('info', 'Detenido', `${saved} geo links guardados. Quedan ${remaining} pendientes.`);
      } else if (errors > 0) {
        showToast('warning', 'Parcial', `${saved} links guardados, ${errors} errores`);
      } else {
        showToast('success', 'Geo completo', `${saved} links de Google Maps guardados en Excel`);
      }
    }

    // Sincronizar direcciones de GSheets → Supabase
    async function syncAddressesFromGSheets() {
      if (!gsheetsAllDirecciones || gsheetsAllDirecciones.length < 2) {
        showToast('warning', 'Sin datos', 'No hay datos de direcciones en Google Sheets. Carga primero los datos.');
        return;
      }

      const headers = gsheetsAllDirecciones[0].map(h => String(h || '').toLowerCase().trim());
      const rows = gsheetsAllDirecciones.slice(1).filter(r => r.some(c => c !== '' && c != null));

      // Find column indices by common header names
      const codeIdx = headers.findIndex(h => h.includes('cod') || h.includes('código') || h.includes('codigo') || h === 'id' || h.includes('external'));
      const addrIdx = headers.findIndex(h => h.includes('direcc') || h.includes('address'));
      const communeIdx = headers.findIndex(h => h.includes('comun') || h.includes('commune'));
      const cityIdx = headers.findIndex(h => h.includes('ciudad') || h.includes('city'));
      const regionIdx = headers.findIndex(h => h.includes('region') || h.includes('región'));

      if (codeIdx === -1) {
        showToast('error', 'Error', 'No se encontró columna de código de cliente en la hoja de direcciones. Columnas: ' + headers.join(', '));
        return;
      }
      if (addrIdx === -1 && communeIdx === -1) {
        showToast('error', 'Error', 'No se encontró columna de dirección ni comuna.');
        return;
      }

      // Build addresses array
      const addresses = [];
      for (const row of rows) {
        const code = String(row[codeIdx] || '').trim();
        if (!code) continue;

        const entry = { code };
        if (addrIdx !== -1 && row[addrIdx]) entry.address = String(row[addrIdx]).trim();
        if (communeIdx !== -1 && row[communeIdx]) entry.commune = String(row[communeIdx]).trim();
        if (cityIdx !== -1 && row[cityIdx]) entry.city = String(row[cityIdx]).trim();
        if (regionIdx !== -1 && row[regionIdx]) entry.region = String(row[regionIdx]).trim();

        if (entry.address || entry.commune) {
          addresses.push(entry);
        }
      }

      if (addresses.length === 0) {
        showToast('warning', 'Sin direcciones', 'No se encontraron direcciones válidas para sincronizar.');
        return;
      }

      showToast('info', 'Sincronizando', `Enviando ${addresses.length} direcciones al servidor...`);

      try {
        // Send in batches of 200
        let totalUpdated = 0, totalNotFound = 0, totalSkipped = 0;
        const batchSize = 200;

        for (let i = 0; i < addresses.length; i += batchSize) {
          const batch = addresses.slice(i, i + batchSize);
          const res = await fetch(`${API}/api/clients/sync-addresses`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ addresses: batch })
          });
          const data = await res.json();
          if (data.success) {
            totalUpdated += data.data.updated;
            totalNotFound += data.data.notFound;
            totalSkipped += data.data.skipped;
          }
        }

        showToast('success', 'Sync completado',
          `${totalUpdated} actualizados, ${totalNotFound} no encontrados, ${totalSkipped} sin cambios`);

        // Reload clients data to refresh GPS stats
        if (totalUpdated > 0) {
          const clientsRes = await fetch(`${API}/api/clients`);
          const clientsData = await clientsRes.json();
          if (clientsData.success) {
            allClients = clientsData.data;
            showToast('info', 'Datos actualizados', 'Clientes recargados. Ahora puedes geocodificar los que tienen dirección.');
          }
        }
      } catch (error) {
        showToast('error', 'Error', 'Error sincronizando: ' + error.message);
      }
    }

    // Reasignación
    let gsheetsAllReasignacion = null;

    function renderGsheetsReasignacion(data) {
      if (!data || data.length === 0) return;

      // Find the real header row (first row with "Zona" or "Vendedor" in it)
      let headerIdx = 0;
      for (let i = 0; i < Math.min(data.length, 10); i++) {
        if (data[i].some(cell => cell && String(cell).toLowerCase().includes('zona'))) {
          headerIdx = i;
          break;
        }
      }
      // Use data from headerIdx onwards
      const cleanData = data.slice(headerIdx);
      gsheetsAllReasignacion = cleanData;
      sheetToTable(cleanData, 'gs-reasignacion-body', { maxRows: 100, page: 0, storeKey: 'reasignacion' });

      // Use zones from vendedores parsed data (has all 4 zones)
      const zoneSelect = document.getElementById('reasign-zone-select');
      if (zoneSelect) {
        const ZONAS = ['Zona Norte', 'Zona Centro', 'Zona Centro Sur', 'Zona Sur'];
        // Also add any extra zones from vendedores data
        if (gsheetsVendedoresParsed && gsheetsVendedoresParsed.length > 0) {
          gsheetsVendedoresParsed.forEach(v => {
            if (v.zona && !ZONAS.includes(v.zona)) ZONAS.push(v.zona);
          });
        }
        zoneSelect.innerHTML = '<option value="">-- Seleccionar zona --</option>' + ZONAS.map(z => `<option value="${z}">${z}</option>`).join('');
      }

      // Populate executive select grouped by zone
      const execSelect = document.getElementById('reasign-exec-select');
      if (execSelect && allUsers) {
        let html = '<option value="">-- Seleccionar vendedor --</option>';
        const ZONAS = ['Zona Norte', 'Zona Centro', 'Zona Centro Sur', 'Zona Sur'];
        ZONAS.forEach(zona => {
          const vendedoresInZone = gsheetsVendedoresParsed.filter(v => v.zona === zona);
          if (vendedoresInZone.length > 0) {
            html += `<optgroup label="${zona}">`;
            vendedoresInZone.forEach(v => {
              const user = allUsers.find(u => u.full_name && u.full_name.toLowerCase() === v.name.toLowerCase());
              if (user) {
                html += `<option value="${user.id}">${v.name}${v.isZonal ? ' (Zonal)' : ''}</option>`;
              }
            });
            html += '</optgroup>';
          }
        });
        // Add users not in any zone
        const mapped = gsheetsVendedoresParsed.map(v => v.name.toLowerCase());
        const unmapped = allUsers.filter(u => !mapped.includes(u.full_name.toLowerCase()));
        if (unmapped.length > 0) {
          html += '<optgroup label="Sin zona">';
          unmapped.forEach(u => { html += `<option value="${u.id}">${u.full_name}</option>`; });
          html += '</optgroup>';
        }
        execSelect.innerHTML = html;
      }

      // Preview on zone change
      if (zoneSelect) zoneSelect.onchange = previewZoneReassign;
    }

    function filterGsheetsReasignacion() {
      if (!gsheetsAllReasignacion || gsheetsAllReasignacion.length === 0) return;
      const search = (document.getElementById('gs-reasignacion-search').value || '').toLowerCase();
      const headers = gsheetsAllReasignacion[0];
      let filtered = [headers];
      gsheetsAllReasignacion.slice(1).forEach(row => {
        if (!search || row.some(cell => String(cell).toLowerCase().includes(search))) {
          filtered.push(row);
        }
      });
      sheetToTable(filtered, 'gs-reasignacion-body', { maxRows: 100, page: 0, storeKey: 'reasignacion' });
    }

    async function previewZoneReassign() {
      const zone = document.getElementById('reasign-zone-select').value;
      const preview = document.getElementById('reasign-preview');
      if (!zone) { preview.innerHTML = ''; return; }

      try {
        // Find vendedores in this zone
        const vendedoresInZone = gsheetsVendedoresParsed.filter(v => v.zona === zone && !v.isZonal);
        const vendedorNames = vendedoresInZone.map(v => v.name.toLowerCase());

        // Find their user IDs
        const userIds = allUsers
          .filter(u => vendedorNames.includes(u.full_name.toLowerCase()))
          .map(u => u.id);

        // Find clients assigned to these users
        let totalClients = 0;
        const clientIds = [];
        const details = [];

        for (const uid of userIds) {
          const res = await fetch(`${API}/api/users/${uid}/clients`);
          const json = await res.json();
          if (json.success && json.data) {
            totalClients += json.data.length;
            json.data.forEach(c => clientIds.push(c.id));
            const userName = allUsers.find(u => u.id === uid)?.full_name || uid;
            details.push(`${userName}: ${json.data.length}`);
          }
        }

        const zc = ZONE_COLORS[zone.toLowerCase()] || { bg: 'rgba(59,130,246,0.06)', color: 'var(--accent)' };
        preview.innerHTML = `<div style="padding: 12px 16px; background: ${zc.bg}; border-radius: 8px; font-size: 13px;">
          <div style="font-weight: 600; color: ${zc.color}; margin-bottom: 6px;">${zone} - ${totalClients} clientes</div>
          <div style="color: var(--text-muted); font-size: 12px;">
            Vendedores: ${vendedoresInZone.map(v => v.name).join(', ')}<br>
            ${details.length > 0 ? 'Detalle: ' + details.join(' | ') : ''}
          </div>
        </div>`;
        preview.dataset.clientIds = JSON.stringify(clientIds);
      } catch (e) {
        preview.innerHTML = `<div style="padding: 10px 14px; background: rgba(239,68,68,0.06); border-radius: 8px; font-size: 13px; color: var(--danger);">Error: ${e.message}</div>`;
      }
    }

    async function executeZoneReassign() {
      const zone = document.getElementById('reasign-zone-select').value;
      const execId = document.getElementById('reasign-exec-select').value;
      const result = document.getElementById('reasign-result');
      const preview = document.getElementById('reasign-preview');

      if (!zone || !execId) {
        showToast('warning', 'Campos requeridos', 'Selecciona zona y vendedor');
        return;
      }

      const clientIds = preview.dataset.clientIds ? JSON.parse(preview.dataset.clientIds) : [];
      if (clientIds.length === 0) {
        showToast('warning', 'Sin clientes', 'No hay clientes en esta zona para reasignar');
        return;
      }

      const execName = document.getElementById('reasign-exec-select').selectedOptions[0].text;
      if (!confirm(`Reasignar ${clientIds.length} clientes de zona "${zone}" a ${execName}?`)) return;

      try {
        result.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">Reasignando...</p>';
        const res = await fetch(`${API}/api/clients/reassign-selected`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientIds, toUserId: execId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);
        result.innerHTML = `<div style="padding: 10px 14px; background: rgba(16,185,129,0.08); border-radius: 8px; font-size: 13px; color: var(--success);">
          <strong>${json.data.updated}</strong> clientes reasignados exitosamente a <strong>${execName}</strong>
        </div>`;
        showToast('success', 'Reasignacion completa', `${json.data.updated} clientes movidos a ${execName}`);
      } catch (e) {
        result.innerHTML = `<div style="padding: 10px 14px; background: rgba(239,68,68,0.06); border-radius: 8px; font-size: 13px; color: var(--danger);">Error: ${e.message}</div>`;
        showToast('error', 'Error', e.message);
      }
    }

    // =============================================
    // RENDIMIENTO DE VISITAS
    // =============================================

    let perfDataLoaded = false;

    async function loadVisitPerformance() {
      const container = document.getElementById('perf-table-body');
      container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;"><span class="spin" style="display:inline-block;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50;"></span> Cargando rendimiento...</p>';

      const dateFrom = document.getElementById('perf-date-from').value || '';
      const dateTo = document.getElementById('perf-date-to').value || '';
      let url = `${API}/api/visit-performance`;
      const params = [];
      if (dateFrom) params.push(`from=${dateFrom}`);
      if (dateTo) params.push(`to=${dateTo}`);
      if (params.length) url += '?' + params.join('&');

      try {
        const res = await fetch(url);
        const result = await res.json();
        if (!result.success) throw new Error(result.error);

        const { stats, totals } = result.data;

        // Update summary cards
        document.getElementById('perf-total-visits').textContent = totals.totalVisits.toLocaleString('es-CL');
        document.getElementById('perf-total-sales').textContent = totals.totalSales.toLocaleString('es-CL');
        document.getElementById('perf-avg-effectiveness').textContent = totals.avgEffectiveness + '%';
        document.getElementById('perf-total-vendors').textContent = totals.totalVendedores;

        renderPerformanceTable(stats);
        perfDataLoaded = true;
      } catch (error) {
        container.innerHTML = `<p style="text-align:center;color:var(--danger);padding:20px;">Error: ${error.message}</p>`;
      }
      lucide.createIcons();
    }

    function renderPerformanceTable(stats) {
      const container = document.getElementById('perf-table-body');

      if (!stats || stats.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">No hay datos de rendimiento</p>';
        return;
      }

      // Sort by zone, then by name within each zone
      const ZONE_ORDER = ['zona norte', 'zona centro', 'zona centro sur', 'zona sur'];
      const enriched = stats.map(s => {
        const gsData = findVendedorData(s.name);
        const zona = gsData ? gsData.zona : '';
        const isZonal = gsData ? gsData.isZonal : false;
        return { ...s, _zona: zona, _isZonal: isZonal };
      });
      enriched.sort((a, b) => {
        const zA = ZONE_ORDER.indexOf((a._zona || '').toLowerCase());
        const zB = ZONE_ORDER.indexOf((b._zona || '').toLowerCase());
        const orderA = zA >= 0 ? zA : 999;
        const orderB = zB >= 0 ? zB : 999;
        if (orderA !== orderB) return orderA - orderB;
        // Zonales first within zone
        if (a._isZonal !== b._isZonal) return a._isZonal ? -1 : 1;
        return a.name.localeCompare(b.name);
      });

      let html = `<div class="gs-table-wrap"><table class="gs-table">
        <thead><tr>
          <th>Vendedor</th>
          <th>Zona</th>
          <th style="text-align:center;">Rutas</th>
          <th style="text-align:center;">Días</th>
          <th style="text-align:center;">Visitas</th>
          <th style="text-align:center;">Prom/Día</th>
          <th style="text-align:center;">Ventas</th>
          <th style="text-align:center;">Contactados</th>
          <th style="text-align:center;">Sin Contacto</th>
          <th style="text-align:center;">Efectividad</th>
          <th style="text-align:center;">Nota</th>
        </tr></thead><tbody>`;

      let lastZona = null;
      enriched.forEach(s => {
        // Zone separator row
        const zona = s._zona || 'Sin Zona';
        const isZonal = s._isZonal || false;
        const zc = ZONE_COLORS[(zona || '').toLowerCase()] || { bg: 'var(--bg-hover)', color: 'var(--text-muted)', border: 'var(--border)' };
        if (zona !== lastZona) {
          const zoneCount = enriched.filter(x => (x._zona || 'Sin Zona') === zona).length;
          html += `<tr><td colspan="11" style="padding:10px 12px;background:${zc.bg};border-left:4px solid ${zc.color};font-weight:700;font-size:13px;color:${zc.color};">
            ${zona} <span style="font-weight:400;font-size:11px;color:var(--text-muted);margin-left:8px;">(${zoneCount} vendedores)</span>
          </td></tr>`;
          lastZona = zona;
        }
        const effColor = s.effectiveness >= 70 ? 'var(--success)' : s.effectiveness >= 40 ? '#f59e0b' : 'var(--danger)';
        const effBg = s.effectiveness >= 70 ? 'rgba(16,185,129,0.1)' : s.effectiveness >= 40 ? 'rgba(245,158,11,0.1)' : 'rgba(239,68,68,0.1)';
        const nota = getVendedorNota(s.userId);
        const notaPreview = nota ? (nota.length > 30 ? nota.substring(0, 30) + '...' : nota) : '';

        html += `<tr>
          <td style="padding:8px 12px;border-bottom:1px solid var(--border);">
            <div style="font-weight:600;">${s.name}</div>
            <div style="font-size:11px;color:var(--text-muted);">${isZonal ? 'Zonal' : 'Vendedor'}</div>
          </td>
          <td style="padding:8px 12px;border-bottom:1px solid var(--border);">
            ${zona ? `<span style="background:${zc.bg};color:${zc.color};border:1px solid ${zc.border};padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600;">${zona}</span>` : '<span style="font-size:12px;color:var(--text-muted);">Sin zona</span>'}
          </td>
          <td style="text-align:center;">${s.totalRoutes}<br><span style="font-size:10px;color:var(--text-muted);">${s.completedRoutes} comp.</span></td>
          <td style="text-align:center;">${s.daysWorked}</td>
          <td style="text-align:center;font-weight:600;">${s.totalVisits}</td>
          <td style="text-align:center;">${s.avgVisitsPerDay}</td>
          <td style="text-align:center;color:var(--success);font-weight:600;">${s.outcomes.sale}</td>
          <td style="text-align:center;">${s.outcomes.contacted}</td>
          <td style="text-align:center;color:var(--danger);">${s.outcomes.no_contact}</td>
          <td style="text-align:center;">
            <span style="background:${effBg};color:${effColor};padding:4px 10px;border-radius:20px;font-weight:700;font-size:12px;">${s.effectiveness}%</span>
          </td>
          <td style="text-align:center;">
            ${notaPreview ? `<span title="${nota}" style="cursor:help;font-size:12px;color:var(--text-muted);">${notaPreview}</span>` : '<span style="color:var(--text-muted);font-size:11px;">-</span>'}
          </td>
        </tr>`;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    // =============================================
    // ZONAS DETALLADAS POR VENDEDOR
    // =============================================

    let vendorZonesLoaded = false;

    async function loadVendedorZonesDetail() {
      if (vendorZonesLoaded) return;
      const container = document.getElementById('gs-vendedores-zonas-body');
      container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">Cargando zonas...</p>';

      try {
        // Get users and their clients from allUsers / allClients already loaded
        if (!allUsers || allUsers.length === 0) {
          container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">Carga los datos principales primero</p>';
          return;
        }

        const executives = allUsers.filter(u => u.role === 'executive' || u.role === 'zonal' || u.role === 'supervisor');

        let html = '';
        executives.forEach(exec => {
          const clients = allClients.filter(c => c.assigned_user_id === exec.id);
          if (clients.length === 0) return;

          // Group by zone, then by commune
          const zoneMap = {};
          clients.forEach(c => {
            const zone = c.zone || 'Sin Zona';
            const commune = c.commune || 'Sin Comuna';
            if (!zoneMap[zone]) zoneMap[zone] = {};
            if (!zoneMap[zone][commune]) zoneMap[zone][commune] = 0;
            zoneMap[zone][commune]++;
          });

          const totalClients = clients.length;
          const withGps = clients.filter(c => c.lat && c.lng).length;
          const zones = Object.keys(zoneMap);

          html += `
          <div style="border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
              <div>
                <div style="font-weight: 700; font-size: 14px;">${exec.full_name}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${(() => { const gs = findVendedorData(exec.full_name); const z = gs ? gs.zona : ''; const isZ = gs ? gs.isZonal : false; const zcl = ZONE_COLORS[(z || '').toLowerCase()]; return (isZ ? 'Zonal' : 'Vendedor') + (z && zcl ? ' | <span style="background:' + zcl.bg + ';color:' + zcl.color + ';border:1px solid ' + zcl.border + ';padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">' + z + '</span>' : ''); })()}</div>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="background: var(--bg-hover); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">${totalClients} clientes</span>
                <span style="background: rgba(16,185,129,0.1); color: var(--success); padding: 4px 10px; border-radius: 6px; font-size: 12px;">${withGps} GPS</span>
                <span style="background: rgba(245,158,11,0.1); color: #f59e0b; padding: 4px 10px; border-radius: 6px; font-size: 12px;">${zones.length} zona${zones.length !== 1 ? 's' : ''}</span>
              </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

          zones.forEach(zone => {
            const communes = zoneMap[zone];
            const communeList = Object.entries(communes);
            const totalInZone = communeList.reduce((s, [, c]) => s + c, 0);

            html += `
              <div style="background: var(--bg-hover); border-radius: 8px; padding: 10px 14px; min-width: 180px; flex: 1;">
                <div style="font-weight: 600; font-size: 13px; color: #6366f1; margin-bottom: 6px;">
                  <i data-lucide="map-pin" style="width: 12px; height: 12px; display: inline;"></i> ${zone}
                  <span style="font-weight: 400; color: var(--text-muted); font-size: 11px;">(${totalInZone})</span>
                </div>
                <div style="font-size: 11px; color: var(--text-muted);">`;

            communeList.sort((a, b) => b[1] - a[1]).forEach(([commune, count]) => {
              html += `<div style="display: flex; justify-content: space-between; padding: 2px 0;">
                <span>${commune}</span>
                <span style="font-weight: 600;">${count}</span>
              </div>`;
            });

            html += `</div></div>`;
          });

          html += `</div></div>`;
        });

        if (!html) {
          container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px;">No hay vendedores con clientes asignados</p>';
        } else {
          container.innerHTML = html;
        }

        vendorZonesLoaded = true;
        lucide.createIcons();
      } catch (error) {
        container.innerHTML = `<p style="text-align:center;color:var(--danger);padding:20px;">Error: ${error.message}</p>`;
      }
    }

    // =============================================
    // NOTAS POR VENDEDOR (localStorage)
    // =============================================

    function getVendedorNotas() {
      return JSON.parse(localStorage.getItem('leker_vendedor_notas') || '{}');
    }

    function getVendedorNota(userId) {
      const notas = getVendedorNotas();
      const entry = notas[userId];
      return entry ? entry.nota : '';
    }

    function saveVendedorNota() {
      const select = document.getElementById('nota-vendedor-select');
      const textarea = document.getElementById('nota-vendedor-text');
      const userId = select.value;
      const nota = textarea.value.trim();

      if (!userId) {
        showToast('warning', 'Sin vendedor', 'Selecciona un vendedor');
        return;
      }
      if (!nota) {
        showToast('warning', 'Sin nota', 'Escribe una nota');
        return;
      }

      const notas = getVendedorNotas();
      const vendedorName = select.options[select.selectedIndex].text;
      notas[userId] = {
        nota,
        vendedor: vendedorName,
        fecha: new Date().toLocaleString('es-CL')
      };
      localStorage.setItem('leker_vendedor_notas', JSON.stringify(notas));

      textarea.value = '';
      select.value = '';
      renderVendedorNotasList();
      showToast('success', 'Nota guardada', `Nota guardada para ${vendedorName}`);
    }

    function deleteVendedorNota(userId) {
      if (!confirm('¿Eliminar esta nota?')) return;
      const notas = getVendedorNotas();
      delete notas[userId];
      localStorage.setItem('leker_vendedor_notas', JSON.stringify(notas));
      renderVendedorNotasList();
      showToast('info', 'Nota eliminada', 'La nota fue eliminada');
    }

    function renderVendedorNotasList() {
      const container = document.getElementById('notas-vendedores-list');
      const notas = getVendedorNotas();
      const entries = Object.entries(notas);

      if (entries.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 12px;">No hay notas guardadas</p>';
        return;
      }

      // Sort by date (most recent first)
      entries.sort((a, b) => new Date(b[1].fecha) - new Date(a[1].fecha));

      container.innerHTML = entries.map(([userId, entry]) => `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid var(--border);">
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; font-size: 13px;">${entry.vendedor}</div>
            <div style="font-size: 13px; margin-top: 4px; color: var(--text); white-space: pre-wrap;">${entry.nota}</div>
            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${entry.fecha}</div>
          </div>
          <button onclick="deleteVendedorNota('${userId}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 4px 8px; font-size: 18px;" title="Eliminar nota">&times;</button>
        </div>
      `).join('');
    }

    function loadVendedorNotasUI() {
      // Populate select with vendedores
      const select = document.getElementById('nota-vendedor-select');
      if (select && allUsers && allUsers.length > 0) {
        const executives = allUsers.filter(u => u.role === 'executive' || u.role === 'zonal' || u.role === 'supervisor');
        select.innerHTML = '<option value="">-- Seleccionar vendedor --</option>' +
          executives.map(u => `<option value="${u.id}">${u.full_name}</option>`).join('');
      }
      renderVendedorNotasList();
    }

    // Vendedores search/filter from GSheets data
    let gsheetsAllVendedores = [];

    function filterGsheetsVendedoresTable() {
      if (!gsheetsAllVendedores || gsheetsAllVendedores.length === 0) return;
      const search = (document.getElementById('gs-vendedores-search').value || '').toLowerCase();
      const headers = gsheetsAllVendedores[0];
      let filtered = [headers];
      gsheetsAllVendedores.slice(1).forEach(row => {
        if (!search || row.some(cell => String(cell).toLowerCase().includes(search))) {
          filtered.push(row);
        }
      });
      sheetToTable(filtered, 'gs-vendedores-body');
    }

    // Pagination helper
    window._gsPageData = {};
    function gsPageTable(containerId, page, storeKey) {
      // Re-render the appropriate table at the new page
      let data;
      switch (storeKey) {
        case 'ventas': data = gsheetsAllVentas; break;
        case 'cobranzas': data = gsheetsAllCobranzas; break;
        case 'direcciones': data = gsheetsAllDirecciones; break;
        default: return;
      }
      if (!data) return;

      const opts = { maxRows: 100, page: page, storeKey: storeKey };
      if (storeKey === 'ventas') {
        opts.highlightFn = _ventasHighlightFn;
        if (data && data[0]) {
          const vi = _ventasVendorIdx(data[0]);
          if (vi >= 0) opts.accentCols = [vi];
        }
      }
      if (storeKey === 'cobranzas') {
        opts.highlightFn = (row, headers) => {
          const vi = headers.findIndex(h => h && h.toLowerCase().includes('vencimiento'));
          if (vi >= 0 && row[vi]) {
            try {
              const parts = String(row[vi]).split(/[\/\-]/);
              let date;
              if (parts.length === 3) {
                if (parts[0].length === 4) date = new Date(parts[0], parts[1] - 1, parts[2]);
                else date = new Date(parts[2], parts[1] - 1, parts[0]);
              }
              if (date && date < new Date()) return 'background: rgba(239,68,68,0.08);';
            } catch (e) {}
          }
          return '';
        };
      }
      sheetToTable(data, containerId, opts);
    }

    // =============================================
    // SEGMENTACIÓN DE CLIENTES
    // =============================================

    function getSegBadge(segmentation) {
      const seg = segmentation || 'N';
      const labels = { '80-20': '80-20', 'L': 'L', 'N': 'N' };
      const classes = { '80-20': 'seg-badge-8020', 'L': 'seg-badge-L', 'N': 'seg-badge-N' };
      return `<span class="seg-badge ${classes[seg] || 'seg-badge-N'}">${labels[seg] || 'N'}</span>`;
    }

    function findCodeColumn(headers) {
      if (!headers) return 0;
      const idx = headers.findIndex(h => {
        if (!h) return false;
        const low = String(h).toLowerCase().trim();
        return low === 'cliente' || low.includes('codigo') || low.includes('código') || low === 'cod' || low === 'cod.' || low.includes('cod cliente') || low.includes('cod. cliente');
      });
      return idx >= 0 ? idx : 0;
    }

    async function syncSegmentation() {
      const btn = document.getElementById('btn-sync-seg');
      if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" class="spin" style="width: 14px; height: 14px;"></i> Sincronizando...'; lucide.createIcons(); }

      try {
        // Ensure Google Sheets data is loaded
        if (!gsheetsLoaded) {
          showToast('info', 'Cargando', 'Descargando datos de Google Sheets primero...');
          await loadGoogleSheetsData(true);
        }

        // Extract 80-20 codes from loaded sheets (clientes clave)
        const codes8020 = [];
        if (gs8020VendClean && gs8020VendClean.length > 1) {
          const codeCol = findCodeColumn(gs8020VendClean[0]);
          console.log('[Segmentación] 80-20 Vend headers:', gs8020VendClean[0], '| codeCol:', codeCol, '| rows:', gs8020VendClean.length - 1);
          gs8020VendClean.slice(1).forEach(row => {
            const code = String(row[codeCol] || '').trim();
            if (code && code !== '0') codes8020.push(code);
          });
        } else {
          console.log('[Segmentación] gs8020VendClean no disponible:', gs8020VendClean);
        }
        if (gs8020ZonClean && gs8020ZonClean.length > 1) {
          const codeCol = findCodeColumn(gs8020ZonClean[0]);
          console.log('[Segmentación] 80-20 Zon headers:', gs8020ZonClean[0], '| codeCol:', codeCol, '| rows:', gs8020ZonClean.length - 1);
          gs8020ZonClean.slice(1).forEach(row => {
            const code = String(row[codeCol] || '').trim();
            if (code && code !== '0') codes8020.push(code);
          });
        }
        const unique8020 = [...new Set(codes8020)];

        // Todos los clientes existentes son L por defecto.
        // Solo necesitamos enviar los 80-20 para sobreescribir.
        console.log('[Segmentación] Códigos 80-20 encontrados:', unique8020.length, '| Muestra:', unique8020.slice(0, 10));

        const res = await fetch(`${API}/api/clients/sync-segmentation`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codes8020: unique8020 })
        });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Segmentación', data.message);
          loadSegmentationStats();
          loadData();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        console.error('[Segmentación] Error:', err);
        showToast('error', 'Error', err.message);
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Sincronizar Segmentación'; lucide.createIcons(); }
      }
    }

    async function loadSegmentationStats() {
      try {
        const res = await fetch(`${API}/api/clients/segmentation-stats`);
        const data = await res.json();
        if (data.success) {
          // Segmentation (80-20, L, N)
          const el8020 = document.getElementById('seg-8020-count');
          if (el8020) el8020.textContent = (data.data['80-20'] || 0).toLocaleString('es-CL');
          // Update stat card sub-label
          const sub8020 = document.getElementById('stat-clients-8020');
          if (sub8020) sub8020.textContent = (data.data['80-20'] || 0).toLocaleString('es-CL');
          document.getElementById('seg-L-count').textContent = (data.data.L || 0).toLocaleString('es-CL');
          document.getElementById('seg-N-count').textContent = (data.data.N || 0).toLocaleString('es-CL');
          document.getElementById('seg-total-count').textContent = (data.data.total || 0).toLocaleString('es-CL');

          // Segments A-E
          if (data.data.segments) {
            ['A','B','C','D','E'].forEach(s => {
              const el = document.getElementById('seg-' + s + '-count');
              if (el) el.textContent = (data.data.segments[s] || 0).toLocaleString('es-CL');
            });
          }

          // Regions chart
          if (data.data.regions) {
            renderRegionsChart(data.data.regions, data.data.total);
          }
        }
      } catch (err) {
        console.warn('Error loading segmentation stats:', err);
      }
    }

    function renderRegionsChart(regions, total) {
      const container = document.getElementById('regions-chart');
      if (!container) return;

      // Sort by count, group small ones
      const sorted = Object.entries(regions)
        .sort((a, b) => b[1] - a[1]);

      const regionColors = [
        '#3b82f6', '#059669', '#d97706', '#8b5cf6', '#ef4444',
        '#14b8a6', '#f97316', '#6366f1', '#ec4899', '#84cc16',
        '#06b6d4', '#a855f7', '#f43f5e', '#10b981', '#eab308'
      ];

      let html = '';
      sorted.forEach(([name, count], i) => {
        const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
        const barWidth = total > 0 ? Math.max(2, (count / sorted[0][1]) * 100) : 0;
        const color = regionColors[i % regionColors.length];
        const shortName = name.replace(/\(.*?\)/g, '').replace(/Región\s*/i, '').replace(/Decimo\s*/i, '').trim();

        html += `
          <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border);">
            <div style="width: 160px; font-size: 11px; color: var(--text-secondary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${name}">${shortName}</div>
            <div style="flex: 1; height: 20px; background: var(--bg-hover); border-radius: 4px; overflow: hidden; position: relative;">
              <div style="height: 100%; width: ${barWidth}%; background: ${color}; border-radius: 4px; transition: width 0.5s ease;"></div>
            </div>
            <div style="width: 55px; text-align: right; font-size: 12px; font-weight: 700; color: var(--text-primary);">${count.toLocaleString('es-CL')}</div>
            <div style="width: 40px; text-align: right; font-size: 10px; color: var(--text-muted);">${pct}%</div>
          </div>`;
      });

      container.innerHTML = html;
    }

    function goToClientsBySegment(segment) {
      document.querySelector('[data-tab="clients"]').click();
      setTimeout(() => {
        const filterSeg = document.getElementById('filter-segment');
        if (filterSeg) { filterSeg.value = segment; filterClients(); }
      }, 200);
    }

    // =============================================
    // CHECKLIST DE VISITA
    // =============================================

    async function loadChecklistForClient(clientId, clientData) {
      const panel = document.getElementById('checklist-panel');
      const warning = document.getElementById('checklist-warning');
      panel.style.display = 'block';
      warning.style.display = 'block';

      // Reset checkboxes
      ['chk-cobranzas', 'chk-compra', 'chk-visita'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.checked = false; }
      });
      updateChecklistState();

      // Fill profile fields from client data
      document.getElementById('chk-owner').value = clientData.owner_name || '';
      document.getElementById('chk-buyer').value = clientData.buyer_name || '';
      document.getElementById('chk-phone').value = clientData.phone || '';
      document.getElementById('chk-phone2').value = clientData.phone2 || '';
      document.getElementById('chk-email').value = clientData.email || '';
      document.getElementById('chk-observations').value = clientData.observations || '';
      document.getElementById('chk-segmentation').value = clientData.segmentation || 'N';
      document.getElementById('chk-is-competitor').checked = clientData.is_competitor_client || false;
      document.getElementById('chk-competitor1').value = clientData.competitor_provider1 || '';
      document.getElementById('chk-competitor2').value = clientData.competitor_provider2 || '';

      // Load checklist data from API
      try {
        const res = await fetch(`${API}/api/clients/${clientId}/checklist-data`);
        const data = await res.json();
        if (data.success) {
          const cd = data.data;

          // Update cobranzas detail
          document.getElementById('chk-cobranzas-detail').textContent =
            'Verificar facturas vencidas o próximas a vencer';

          // Update last purchase detail
          if (cd.client?.last_sale_date) {
            const d = new Date(cd.client.last_sale_date);
            document.getElementById('chk-compra-detail').textContent =
              `Última venta: ${d.toLocaleDateString('es-CL')}`;
          } else {
            document.getElementById('chk-compra-detail').textContent = 'Sin registro de última venta';
          }

          // Update last visit detail
          if (cd.lastVisit) {
            const d = new Date(cd.lastVisit.check_in);
            const vendedor = cd.lastVisit.route?.user?.full_name || '';
            document.getElementById('chk-visita-detail').textContent =
              `Última visita: ${d.toLocaleDateString('es-CL')} ${vendedor ? '(' + vendedor + ')' : ''} - ${cd.lastVisit.outcome || 'pendiente'}`;
          } else {
            document.getElementById('chk-visita-detail').textContent = 'Sin visitas anteriores registradas';
          }

          // Update profile fields from API data (may have more updated data)
          if (cd.client) {
            if (cd.client.owner_name) document.getElementById('chk-owner').value = cd.client.owner_name;
            if (cd.client.buyer_name) document.getElementById('chk-buyer').value = cd.client.buyer_name;
            if (cd.client.phone) document.getElementById('chk-phone').value = cd.client.phone;
            if (cd.client.phone2) document.getElementById('chk-phone2').value = cd.client.phone2;
            if (cd.client.email) document.getElementById('chk-email').value = cd.client.email;
            if (cd.client.observations) document.getElementById('chk-observations').value = cd.client.observations;
            if (cd.client.segmentation) document.getElementById('chk-segmentation').value = cd.client.segmentation;
            document.getElementById('chk-is-competitor').checked = cd.client.is_competitor_client || false;
            if (cd.client.competitor_provider1) document.getElementById('chk-competitor1').value = cd.client.competitor_provider1;
            if (cd.client.competitor_provider2) document.getElementById('chk-competitor2').value = cd.client.competitor_provider2;
          }
        }
      } catch (err) {
        console.warn('Error loading checklist data:', err);
      }

      lucide.createIcons();
    }

    function updateChecklistState() {
      const chks = ['chk-cobranzas', 'chk-compra', 'chk-visita'];
      let allChecked = true;

      chks.forEach(id => {
        const el = document.getElementById(id);
        const item = el?.closest('.checklist-item');
        if (el && item) {
          item.classList.toggle('checked', el.checked);
          if (!el.checked) allChecked = false;
        }
      });

      const warning = document.getElementById('checklist-warning');
      const btn = document.getElementById('btn-checkin-submit');
      if (warning) warning.style.display = allChecked ? 'none' : 'block';
      if (btn) btn.disabled = !allChecked;
    }

    async function saveClientProfile() {
      const clientId = document.getElementById('checkin-client').value;
      if (!clientId) {
        showToast('warning', 'Sin cliente', 'Selecciona un cliente primero');
        return;
      }

      const profileData = {
        owner_name: document.getElementById('chk-owner').value,
        buyer_name: document.getElementById('chk-buyer').value,
        phone: document.getElementById('chk-phone').value,
        phone2: document.getElementById('chk-phone2').value,
        email: document.getElementById('chk-email').value,
        observations: document.getElementById('chk-observations').value,
        segmentation: document.getElementById('chk-segmentation').value,
        is_competitor_client: document.getElementById('chk-is-competitor').checked,
        competitor_provider1: document.getElementById('chk-competitor1').value,
        competitor_provider2: document.getElementById('chk-competitor2').value
      };

      try {
        const res = await fetch(`${API}/api/clients/${clientId}/profile`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData)
        });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Ficha guardada', 'Datos del cliente actualizados');
          // Update local client data
          const idx = allClients.findIndex(c => c.id === clientId);
          if (idx >= 0) Object.assign(allClients[idx], profileData);
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // =============================================
    // PLANIFICADOR DE RUTAS V2
    // =============================================

    // Haversine: distance between two points in km
    function haversineKm(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Calculate total route distance including optional startPoint (home/office)
    function calcRoutesDistanceKm(routes, startPoint) {
      let total = 0;
      const pts = routes.map(r => r.client || r).filter(c => c.lat && c.lng);
      if (pts.length === 0) return 0;
      // Home → first client
      if (startPoint && startPoint.lat && startPoint.lng) {
        total += haversineKm(startPoint.lat, startPoint.lng, pts[0].lat, pts[0].lng);
      }
      // Client to client
      for (let i = 1; i < pts.length; i++) {
        total += haversineKm(pts[i-1].lat, pts[i-1].lng, pts[i].lat, pts[i].lng);
      }
      // Last client → home
      if (startPoint && startPoint.lat && startPoint.lng) {
        total += haversineKm(pts[pts.length-1].lat, pts[pts.length-1].lng, startPoint.lat, startPoint.lng);
      }
      return Math.round(total * 10) / 10;
    }

    let currentWeekOffset = 0;
    let lastScheduleData = null;
    let lastScheduleUserId = null;

    // Initialize week dates on load
    function initWeekDates() {
      setWeekFromOffset(0);
    }

    function getWeekDates(offset = 0) {
      const now = new Date();
      const dayOfWeek = now.getDay();
      const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      const monday = new Date(now);
      monday.setDate(now.getDate() + mondayOffset + (offset * 7));
      const friday = new Date(monday);
      friday.setDate(monday.getDate() + 4);
      return {
        start: monday.toISOString().split('T')[0],
        end: friday.toISOString().split('T')[0],
        monday, friday
      };
    }

    function setWeekFromOffset(offset) {
      currentWeekOffset = offset;
      const { start, end, monday, friday } = getWeekDates(offset);
      document.getElementById('schedule-start').value = start;
      document.getElementById('schedule-end').value = end;

      const label = `${monday.toLocaleDateString('es-CL', { day: 'numeric', month: 'short' })} — ${friday.toLocaleDateString('es-CL', { day: 'numeric', month: 'short', year: 'numeric' })}`;
      document.getElementById('week-label').textContent = label;
    }

    function navigateWeek(direction) {
      setWeekFromOffset(currentWeekOffset + direction);
      // Auto-load all execs overview (or individual if in detail view)
      const vendorControls = document.getElementById('planner-vendor-controls');
      if (vendorControls && vendorControls.style.display !== 'none') {
        const userId = document.getElementById('schedule-vendor').value;
        if (userId) loadExistingSchedule();
      } else {
        loadWeeklyAllExecs();
      }
    }

    async function generateWeeklySchedule() {
      const userId = document.getElementById('schedule-vendor').value;
      const startDate = document.getElementById('schedule-start').value;
      const endDate = document.getElementById('schedule-end').value;

      if (!userId) {
        showToast('warning', 'Datos faltantes', 'Selecciona un vendedor');
        return;
      }
      if (!startDate || !endDate) {
        setWeekFromOffset(0);
      }

      const resultDiv = document.getElementById('schedule-result');
      resultDiv.innerHTML = '<div style="text-align: center; padding: 24px;"><i data-lucide="loader-2" class="spin" style="width: 24px; height: 24px;"></i><p style="font-size: 12px; margin-top: 8px;">Generando plan semanal...</p></div>';
      lucide.createIcons();

      try {
        const res = await fetch(`${API}/api/routes/generate-schedule`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            startDate: document.getElementById('schedule-start').value,
            endDate: document.getElementById('schedule-end').value
          })
        });
        const data = await res.json();

        if (data.success) {
          showToast('success', 'Plan generado', data.message);
          lastScheduleData = data.data;
          lastScheduleUserId = userId;
          renderWeeklyPlanner(data.data, userId);
        } else {
          showToast('error', 'Error', data.error);
          resultDiv.innerHTML = `<div class="empty-state" style="padding: 24px;"><p style="color: var(--danger); font-size: 13px;">${data.error}</p></div>`;
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
        resultDiv.innerHTML = `<div class="empty-state" style="padding: 24px;"><p style="color: var(--danger); font-size: 13px;">${err.message}</p></div>`;
      }
    }

    let weeklyAllExecsData = null;

    async function loadWeeklyAllExecs() {
      const startDate = document.getElementById('schedule-start').value;
      const endDate = document.getElementById('schedule-end').value;
      if (!startDate || !endDate) setWeekFromOffset(0);

      const s = document.getElementById('schedule-start').value;
      const e = document.getElementById('schedule-end').value;

      // Hide vendor controls, show overview mode
      const vendorControls = document.getElementById('planner-vendor-controls');
      if (vendorControls) vendorControls.style.display = 'none';

      const resultDiv = document.getElementById('schedule-result');
      resultDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto 8px;"></div><div style="font-size: 12px; color: var(--text-muted);">Cargando vendedores...</div></div>';

      try {
        const res = await fetch(`/api/routes/schedule-all?startDate=${s}&endDate=${e}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        weeklyAllExecsData = json.data;
        renderWeeklyAllExecs(json.data, s, e);
      } catch (err) {
        resultDiv.innerHTML = `<div class="empty-state" style="padding: 24px;"><p style="color: var(--danger);">${err.message}</p></div>`;
      }
    }

    function renderWeeklyAllExecs(data, startDate, endDate) {
      const resultDiv = document.getElementById('schedule-result');
      const execEntries = Object.entries(data);
      const fuelEff = 10;
      const fuelPrice = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1141;

      if (execEntries.length === 0) {
        resultDiv.innerHTML = `
          <div class="empty-state" style="padding: 40px;">
            <div style="width:64px;height:64px;border-radius:16px;background:rgba(99,102,241,0.08);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
              <i data-lucide="calendar-x" style="width: 32px; height: 32px; color: var(--text-muted);"></i>
            </div>
            <p style="font-size: 15px; font-weight: 700; margin: 0 0 6px 0;">Sin rutas esta semana</p>
            <p style="font-size: 12px; color: var(--text-muted); margin: 0 0 16px 0; max-width: 320px;">Ningun vendedor tiene rutas programadas para esta semana. Genera una ruta seleccionando un vendedor.</p>
            <button class="btn btn-primary" onclick="showExecWeekDetail(null)" style="font-size: 13px; padding: 10px 20px; border-radius: 8px;">
              <i data-lucide="calendar-plus" style="width: 15px; height: 15px;"></i> Generar Ruta para Vendedor
            </button>
          </div>`;
        lucide.createIcons();
        return;
      }

      // Calculate totals
      let grandTotalClients = 0, grandTotalKm = 0, grandTotalCost = 0;
      const execRows = [];

      execEntries.forEach(([uid, info]) => {
        let clients = 0, km = 0, days = Object.keys(info.dates).length;
        let has8020 = false;
        const dayStats = {};
        // Get vendor's start point (home/office) for distance calculation
        const execUser = allUsers ? allUsers.find(u => u.id === uid) : null;
        const startPt = (execUser && execUser.home_lat && execUser.home_lng) ? { lat: parseFloat(execUser.home_lat), lng: parseFloat(execUser.home_lng) } : null;

        Object.entries(info.dates).forEach(([date, routes]) => {
          clients += routes.length;
          const dayKm = calcRoutesDistanceKm(routes, startPt);
          km += dayKm;
          if (routes.some(r => r.client?.segmentation === '80-20')) has8020 = true;
          dayStats[date] = { count: routes.length, km: dayKm };
        });

        const cost = Math.round((km / fuelEff) * fuelPrice);
        grandTotalClients += clients;
        grandTotalKm += km;
        grandTotalCost += cost;

        execRows.push({ uid, name: info.userName, clients, km: Math.round(km), cost, days, has8020, dayStats });
      });

      // Build week day columns
      const weekStart = new Date(startDate + 'T12:00:00');
      const weekDays = [];
      const shortDayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
      for (let i = 0; i < 5; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        weekDays.push({
          date: d.toISOString().split('T')[0],
          label: shortDayNames[d.getDay()],
          dayNum: d.getDate()
        });
      }

      // Execs with/without routes
      const execsConRuta = execRows.filter(e => e.clients > 0).length;
      const totalExecs = allUsers ? allUsers.filter(u => u.role === 'executive').length : execRows.length;
      const execsSinRuta = totalExecs - execsConRuta;

      let html = `
        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            <span style="font-size: 13px; font-weight: 700; color: var(--text);">Resumen semanal</span>
            <span style="font-size: 11px; color: var(--text-muted);">Click en un vendedor para ver detalle</span>
          </div>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0; border-radius: 10px; overflow: hidden; border: 1px solid var(--border);">
            <div style="padding: 12px; text-align: center; background: var(--bg-hover); border-right: 1px solid var(--border);">
              <div style="font-size: 22px; font-weight: 800; color: var(--accent);">${execsConRuta}<span style="font-size: 12px; color: var(--text-muted); font-weight: 500;">/${totalExecs}</span></div>
              <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Vendedores con ruta</div>
            </div>
            <div style="padding: 12px; text-align: center; background: var(--bg-hover); border-right: 1px solid var(--border);">
              <div style="font-size: 22px; font-weight: 800;">${grandTotalClients}</div>
              <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Visitas programadas</div>
            </div>
            <div style="padding: 12px; text-align: center; background: var(--bg-hover); border-right: 1px solid var(--border);">
              <div style="font-size: 22px; font-weight: 800;">${Math.round(grandTotalKm)} km</div>
              <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Recorrido total</div>
            </div>
            <div style="padding: 12px; text-align: center; background: var(--bg-hover);">
              <div style="font-size: 22px; font-weight: 800; color: #6366f1;">$${grandTotalCost.toLocaleString('es-CL')}</div>
              <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">Costo bencina aprox</div>
            </div>
          </div>
        </div>

        <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px;">
          <thead>
            <tr style="background: var(--bg-hover);">
              <th style="text-align: left; padding: 10px 14px; font-weight: 700; border-bottom: 2px solid var(--border); border-radius: 8px 0 0 0;">Vendedor</th>
              ${weekDays.map((wd, i) => `<th style="text-align: center; padding: 10px 8px; font-weight: 700; border-bottom: 2px solid var(--border); min-width: 70px;">
                <div style="font-size: 11px; color: var(--text-muted);">${wd.label}</div>
                <div style="font-size: 14px;">${wd.dayNum}</div>
              </th>`).join('')}
              <th style="text-align: center; padding: 10px 8px; font-weight: 700; border-bottom: 2px solid var(--border);">Total</th>
              <th style="text-align: right; padding: 10px 8px; font-weight: 700; border-bottom: 2px solid var(--border);">Costo</th>
              <th style="text-align: center; padding: 10px 8px; font-weight: 700; border-bottom: 2px solid var(--border); border-radius: 0 8px 0 0; width: 40px;"></th>
            </tr>
          </thead>
          <tbody>`;

      execRows.sort((a, b) => b.clients - a.clients);

      execRows.forEach((exec, idx) => {
        const color = EXEC_COLORS[idx % EXEC_COLORS.length];
        html += `
            <tr style="cursor: pointer; transition: background 0.1s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''" onclick="showExecWeekDetail('${exec.uid}')">
              <td style="padding: 10px 14px; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 8px; height: 28px; border-radius: 4px; background: ${color}; flex-shrink: 0;"></div>
                  <div>
                    <div style="font-weight: 700; font-size: 13px;">${exec.name}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">${exec.days} días · ${exec.clients} clientes ${exec.has8020 ? '<span style="color: #c9a227;">★ 80-20</span>' : ''}</div>
                  </div>
                </div>
              </td>`;

        weekDays.forEach(wd => {
          const ds = exec.dayStats[wd.date];
          if (ds) {
            html += `<td style="text-align: center; padding: 8px; border-bottom: 1px solid var(--border);">
              <div onclick="event.stopPropagation(); toggleWeekDayClients('${exec.uid}', '${wd.date}', this)" style="background: ${color}12; color: ${color}; border-radius: 8px; padding: 6px 8px; font-weight: 800; font-size: 16px; cursor: pointer; transition: transform 0.1s;" onmousedown="this.style.transform='scale(0.93)'" onmouseup="this.style.transform='scale(1)'">${ds.count}</div>
            </td>`;
          } else {
            html += `<td style="text-align: center; padding: 8px; border-bottom: 1px solid var(--border);"><span style="color: var(--text-muted); font-size: 11px;">—</span></td>`;
          }
        });

        html += `
              <td style="text-align: center; padding: 8px; border-bottom: 1px solid var(--border); font-weight: 800; font-size: 15px; color: var(--accent);">${exec.clients}</td>
              <td style="text-align: right; padding: 10px 8px; border-bottom: 1px solid var(--border); font-weight: 700; color: #6366f1; font-size: 13px;">$${exec.cost.toLocaleString('es-CL')}</td>
              <td style="text-align: center; padding: 8px; border-bottom: 1px solid var(--border);">
                <button onclick="event.stopPropagation(); deleteExecSchedule('${exec.uid}', '${exec.name.replace(/'/g, "\\'")}', ${exec.clients})" title="Eliminar rutas de ${exec.name}" style="background: none; border: 1px solid rgba(239,68,68,0.2); color: #ef4444; padding: 4px 6px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; transition: background 0.15s;" onmouseover="this.style.background='rgba(239,68,68,0.08)'" onmouseout="this.style.background='none'">
                  <i data-lucide="trash-2" style="width: 13px; height: 13px;"></i>
                </button>
              </td>
            </tr>`;
      });

      html += `
          </tbody>
        </table>
        </div>
        ${execsSinRuta > 0 ? `
        <div style="text-align: center; margin-top: 16px; padding: 14px; background: rgba(99,102,241,0.04); border-radius: 10px; border: 1px dashed rgba(99,102,241,0.2);">
          <span style="font-size: 12px; color: var(--text-muted); margin-right: 8px;">${execsSinRuta} vendedor${execsSinRuta > 1 ? 'es' : ''} sin ruta programada</span>
          <button class="btn btn-primary" onclick="showExecWeekDetail(null)" style="font-size: 12px; padding: 7px 16px; border-radius: 6px;">
            <i data-lucide="calendar-plus" style="width: 13px; height: 13px;"></i> Generar Ruta
          </button>
        </div>` : `
        <div style="text-align: center; margin-top: 12px;">
          <span style="font-size: 11px; color: var(--success); font-weight: 600;"><i data-lucide="check-circle" style="width:12px;height:12px;display:inline-block;vertical-align:middle;"></i> Todos los vendedores tienen ruta asignada</span>
        </div>`}`;

      resultDiv.innerHTML = html;
      lucide.createIcons();
    }

    function toggleWeekDayClients(uid, date, el) {
      // If already expanded, collapse
      const existing = el.parentElement.querySelector('.week-day-clients');
      if (existing) { existing.remove(); return; }

      // Close other expanded day cells
      document.querySelectorAll('.week-day-clients').forEach(e => e.remove());

      if (!weeklyAllExecsData || !weeklyAllExecsData[uid]) return;
      const info = weeklyAllExecsData[uid];
      const routes = info.dates[date];
      if (!routes || routes.length === 0) return;

      const d = new Date(date + 'T12:00:00');
      const fullDayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
      let clientsHtml = `<div class="week-day-clients" style="position: absolute; top: 100%; left: 50%; transform: translateX(-50%); z-index: 100; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 10px; min-width: 260px; max-width: 320px; margin-top: 4px;">
        <div style="font-size: 11px; font-weight: 700; margin-bottom: 6px; color: var(--text-muted); text-transform: uppercase;">
          ${info.userName} — ${fullDayNames[d.getDay()]} ${d.getDate()}
        </div>`;

      routes.forEach((r, idx) => {
        const c = r.client || {};
        const is8020 = c.segmentation === '80-20';
        clientsHtml += `
          <div style="display: flex; align-items: center; gap: 6px; padding: 4px 6px; border-radius: 4px; margin-bottom: 2px; font-size: 11px; ${is8020 ? 'border-left: 3px solid #f59e0b; background: rgba(245,158,11,0.06);' : ''}">
            <span style="font-weight: 700; color: var(--text-muted); min-width: 14px;">${idx + 1}</span>
            <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c.fantasy_name || c.name || 'Sin nombre'}</span>
            ${is8020 ? '<span style="color: #f59e0b; font-size: 9px; flex-shrink: 0;">★</span>' : ''}
          </div>`;
      });

      clientsHtml += '</div>';
      el.parentElement.style.position = 'relative';
      el.insertAdjacentHTML('afterend', clientsHtml);

      // Click outside to close
      const closeHandler = (ev) => {
        if (!el.parentElement.contains(ev.target)) {
          el.parentElement.querySelector('.week-day-clients')?.remove();
          document.removeEventListener('click', closeHandler);
        }
      };
      setTimeout(() => document.addEventListener('click', closeHandler), 10);
    }

    // === Planner Vendor Custom Dropdown ===
    function openPlannerVendorDropdown() {
      const dropdown = document.getElementById('planner-vendor-dropdown');
      dropdown.style.display = 'block';
      filterPlannerVendorDropdown(document.getElementById('planner-vendor-search').value);
      setTimeout(() => {
        document.addEventListener('click', _closePlannerDropdownOutside);
      }, 50);
    }

    function _closePlannerDropdownOutside(e) {
      const dd = document.getElementById('planner-vendor-dropdown');
      const inp = document.getElementById('planner-vendor-search');
      if (dd && !dd.contains(e.target) && e.target !== inp) {
        dd.style.display = 'none';
        document.removeEventListener('click', _closePlannerDropdownOutside);
      }
    }

    function filterPlannerVendorDropdown(searchTerm) {
      const listEl = document.getElementById('planner-vendor-dropdown-list');
      if (!listEl) return;
      const search = (searchTerm || '').toLowerCase().trim();
      const schedData = weeklyAllExecsData || window._dashboardScheduleData || {};
      const today = new Date().toISOString().split('T')[0];

      // Get all exec-type users
      let vendors = (allUsers || []).filter(u => u.role === 'executive' || u.role === 'zonal' || u.role === 'supervisor');
      if (search) {
        vendors = vendors.filter(v => (v.full_name || '').toLowerCase().includes(search));
      }

      // Classify: en ruta hoy, con ruta programada, sin ruta
      const enRutaHoy = [];
      const conRuta = [];
      const sinRuta = [];

      vendors.forEach(v => {
        const sched = schedData[v.id];
        if (sched && sched.dates) {
          const dates = Object.keys(sched.dates);
          const totalClients = Object.values(sched.dates).flat().length;
          const hasToday = dates.includes(today);
          const info = { ...v, schedDays: dates.length, schedClients: totalClients, hasToday };
          if (hasToday) {
            enRutaHoy.push(info);
          } else {
            conRuta.push(info);
          }
        } else {
          sinRuta.push({ ...v, schedDays: 0, schedClients: 0, hasToday: false });
        }
      });

      let html = '';

      if (enRutaHoy.length > 0) {
        html += `<div style="padding:5px 14px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#6366f1;font-weight:700;background:rgba(99,102,241,0.05);border-bottom:1px solid rgba(99,102,241,0.1);">En ruta hoy</div>`;
        enRutaHoy.forEach(v => { html += _buildPlannerVendorItem(v); });
      }
      if (conRuta.length > 0) {
        html += `<div style="padding:5px 14px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#10b981;font-weight:700;background:rgba(16,185,129,0.05);border-bottom:1px solid rgba(16,185,129,0.1);">Con ruta programada</div>`;
        conRuta.forEach(v => { html += _buildPlannerVendorItem(v); });
      }
      if (sinRuta.length > 0) {
        html += `<div style="padding:5px 14px;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#ef4444;font-weight:700;background:rgba(239,68,68,0.05);border-bottom:1px solid rgba(239,68,68,0.1);">Sin ruta programada</div>`;
        sinRuta.forEach(v => { html += _buildPlannerVendorItem(v); });
      }

      if (vendors.length === 0) {
        html = `<div style="padding:14px;text-align:center;color:var(--text-muted);font-size:12px;">No se encontraron vendedores</div>`;
      }

      listEl.innerHTML = html;
    }

    function _buildPlannerVendorItem(v) {
      const currentVal = document.getElementById('schedule-vendor').value;
      const isSelected = v.id === currentVal;

      // Zone tag
      const clientZones = (allClients || []).filter(c => c.assigned_user_id === v.id && c.zone).map(c => c.zone);
      let zona = '';
      if (clientZones.length > 0) {
        const zc2 = {};
        clientZones.forEach(z => { zc2[z] = (zc2[z] || 0) + 1; });
        zona = Object.entries(zc2).sort((a, b) => b[1] - a[1])[0][0];
      }
      const zc = ZONE_COLORS[(zona || '').toLowerCase()] || null;
      const zoneTag = zona ? `<span style="background:${zc ? zc.bg : 'rgba(107,114,128,0.08)'};color:${zc ? zc.color : '#6b7280'};border:1px solid ${zc ? zc.border : 'rgba(107,114,128,0.2)'};padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${zona}</span>` : '';

      // Route status tag
      let statusTag = '';
      if (v.schedDays > 0) {
        if (v.hasToday) {
          statusTag = `<span style="background:rgba(99,102,241,0.1);color:#6366f1;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${v.schedDays}d · ${v.schedClients}cl</span>`;
        } else {
          statusTag = `<span style="background:rgba(16,185,129,0.1);color:#10b981;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">${v.schedDays}d · ${v.schedClients}cl</span>`;
        }
      } else {
        statusTag = `<span style="font-size:10px;color:#ef4444;font-weight:500;">sin ruta</span>`;
      }

      return `<div onclick="selectPlannerVendor('${v.id}','${(v.full_name || '').replace(/'/g, "\\'")}')"
        style="padding:8px 14px;cursor:pointer;border-bottom:1px solid #f0f0f0;${isSelected ? 'background:rgba(99,102,241,0.06);' : ''}"
        onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${isSelected ? 'rgba(99,102,241,0.06)' : ''}'">
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
          <span style="font-weight:600;font-size:13px;">${v.full_name}</span>${zoneTag}${statusTag}
        </div>
      </div>`;
    }

    function selectPlannerVendor(userId, name) {
      const hiddenSel = document.getElementById('schedule-vendor');
      // Ensure option exists
      if (!hiddenSel.querySelector(`option[value="${userId}"]`)) {
        hiddenSel.innerHTML += `<option value="${userId}">${name}</option>`;
      }
      hiddenSel.value = userId;
      document.getElementById('planner-vendor-search').value = name;
      document.getElementById('planner-vendor-dropdown').style.display = 'none';
      document.removeEventListener('click', _closePlannerDropdownOutside);
      showExecWeekDetail(userId);
    }

    function showExecWeekDetail(userId) {
      const vendorControls = document.getElementById('planner-vendor-controls');
      const isExecRole = currentUser && currentUser.role === 'executive';

      if (vendorControls) {
        if (isExecRole) {
          // Executive: hide all vendor controls (back button, vendor selector, generate button)
          vendorControls.style.display = 'none';
        } else {
          vendorControls.style.display = '';
        }
      }

      // Ensure vendor dropdown is populated (may be empty if init ran before allUsers loaded)
      const vendorSel = document.getElementById('schedule-vendor');
      if (vendorSel && vendorSel.options.length <= 1 && allUsers && allUsers.length > 0) {
        const vendorExecs = allUsers.filter(u => u.role === 'executive' || u.role === 'zonal' || u.role === 'supervisor');
        if (isExecRole) {
          vendorSel.innerHTML = `<option value="${currentUser.id}">${currentUser.full_name}</option>`;
        } else {
          vendorSel.innerHTML = '<option value="">-- Seleccionar Vendedor --</option>' +
            vendorExecs.map(u => `<option value="${u.id}">${u.full_name}</option>`).join('');
        }
      }

      if (userId) {
        if (vendorSel) vendorSel.value = userId;
        // Sync planner search input text
        const plannerSearch = document.getElementById('planner-vendor-search');
        if (plannerSearch) {
          const vendor = (allUsers || []).find(u => u.id === userId);
          plannerSearch.value = vendor ? vendor.full_name : '';
        }
        loadExistingSchedule(userId);
      } else {
        // Show empty state for generating route
        const vendorSel = document.getElementById('schedule-vendor');
        if (vendorSel) vendorSel.value = '';
        const resultDiv = document.getElementById('schedule-result');
        resultDiv.innerHTML = `
          <div class="empty-state" style="padding: 32px;">
            <div style="width:56px;height:56px;border-radius:14px;background:rgba(99,102,241,0.08);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
              <i data-lucide="route" style="width: 28px; height: 28px; color: var(--accent);"></i>
            </div>
            <p style="font-size: 14px; font-weight: 600; margin: 0 0 6px 0;">Selecciona un vendedor</p>
            <p style="font-size: 12px; color: var(--text-muted); margin: 0;">Elige un vendedor del dropdown de arriba y haz click en <strong>"Generar Ruta"</strong> para crear su plan semanal</p>
          </div>`;
        lucide.createIcons();
      }
    }

    async function loadExistingSchedule(overrideUserId) {
      const userId = overrideUserId || document.getElementById('schedule-vendor').value;
      if (!userId) {
        showToast('warning', 'Selecciona vendedor', 'Elige un vendedor para cargar su plan');
        return;
      }
      // Ensure dropdown matches
      const vendorSel = document.getElementById('schedule-vendor');
      if (vendorSel && vendorSel.value !== userId) vendorSel.value = userId;
      const startDate = document.getElementById('schedule-start').value;
      const endDate = document.getElementById('schedule-end').value;
      if (!startDate || !endDate) setWeekFromOffset(0);

      const resultDiv = document.getElementById('schedule-result');
      resultDiv.innerHTML = '<div style="text-align: center; padding: 24px;"><i data-lucide="loader-2" class="spin" style="width: 24px; height: 24px;"></i><p style="font-size: 12px; margin-top: 8px;">Cargando plan...</p></div>';
      lucide.createIcons();

      try {
        const s = document.getElementById('schedule-start').value;
        const e = document.getElementById('schedule-end').value;
        const res = await fetch(`${API}/api/routes/schedule/${userId}?startDate=${s}&endDate=${e}`);
        const data = await res.json();

        if (data.success) {
          // Transform from grouped-by-date format to schedule format
          const schedule = {};
          const dates = Object.keys(data.data).sort();
          if (dates.length === 0) {
            resultDiv.innerHTML = '<div class="empty-state" style="padding: 24px;"><i data-lucide="calendar-x" style="width: 36px; height: 36px;"></i><p style="font-size: 13px;">No hay rutas planificadas para esta semana</p><p style="font-size: 11px; color: var(--text-muted);">Haz click en "Generar Ruta" para crear un plan</p></div>';
            lucide.createIcons();
            return;
          }
          // Get vendor's start point (home/office)
          const execUser = allUsers ? allUsers.find(u => u.id === userId) : null;
          const homePt = (execUser && execUser.home_lat && execUser.home_lng) ? { lat: parseFloat(execUser.home_lat), lng: parseFloat(execUser.home_lng) } : null;

          let totalClients = 0;
          dates.forEach(date => {
            const routes = data.data[date];
            const clients = routes.map(r => ({
              ...r.client,
              estimatedArrival: r.estimated_arrival || null,
              scheduledRouteId: r.id,
              routeStatus: r.status
            }));
            // Calculate distances including home → first client and last client → home
            let totalDist = 0;
            const pts = clients.filter(c => c.lat && c.lng);
            if (pts.length > 0) {
              if (homePt) totalDist += haversineKm(homePt.lat, homePt.lng, pts[0].lat, pts[0].lng);
              for (let i = 1; i < pts.length; i++) {
                totalDist += haversineKm(pts[i-1].lat, pts[i-1].lng, pts[i].lat, pts[i].lng);
              }
              if (homePt) totalDist += haversineKm(pts[pts.length-1].lat, pts[pts.length-1].lng, homePt.lat, homePt.lng);
            }
            // Estimate hours: travel at 40km/h + 35min per client
            const travelH = totalDist / 40;
            const visitH = clients.length * (35 / 60);
            const totalH = Math.round((travelH + visitH) * 10) / 10;

            schedule[date] = {
              clients: clients,
              totalDistance: Math.round(totalDist * 10) / 10,
              totalHours: totalH,
              estimatedTime: Math.round(totalH * 60),
              overloaded: totalH > 8
            };
            totalClients += clients.length;
          });

          const scheduleData = { totalClients, days: dates.length, schedule };
          lastScheduleData = scheduleData;
          lastScheduleUserId = userId;
          renderWeeklyPlanner(scheduleData, userId);
        } else {
          resultDiv.innerHTML = `<div class="empty-state" style="padding: 24px;"><p style="color: var(--danger);">${data.error}</p></div>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="empty-state" style="padding: 24px;"><p style="color: var(--danger);">${err.message}</p></div>`;
      }
    }

    function renderWeeklyPlanner(scheduleData, userId) {
      const resultDiv = document.getElementById('schedule-result');
      const schedule = scheduleData.schedule;
      const days = Object.keys(schedule).sort();
      const isExec = currentUser && currentUser.role === 'executive';

      if (days.length === 0) {
        resultDiv.innerHTML = '<div class="empty-state" style="padding: 24px;"><p>No hay clientes programados en este período</p></div>';
        return;
      }

      const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

      // Summary row
      const totalClients = days.reduce((s, d) => s + schedule[d].clients.length, 0);
      const totalKm = days.reduce((s, d) => s + (schedule[d].totalDistance || 0), 0);
      const totalH = days.reduce((s, d) => s + (schedule[d].totalHours || 0), 0);
      const fuelPrice = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1141;
      const totalCost = Math.round((totalKm / 10) * fuelPrice);

      // Find executive name (fallback to currentUser if self, never show UUID)
      const execUser = allUsers.find(u => u.id === userId);
      const execName = execUser ? execUser.full_name
                     : (currentUser && currentUser.id === userId ? currentUser.full_name : 'Vendedor');

      let html = `
        <div class="planner-header">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="planner-avatar">
              <i data-lucide="user" style="width: 18px; height: 18px; color: white;"></i>
            </div>
            <div>
              <div class="planner-exec-name">${execName}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${totalClients} clientes · ${days.length} días programados</div>
            </div>
          </div>
          ${!isExec ? `
          <div style="display: flex; gap: 6px;">
            <button class="btn" onclick="deleteAllScheduledDays()" style="font-size: 11px; padding: 5px 12px; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); color: #ef4444; border-radius: 6px;">
              <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i> Eliminar Todo
            </button>
            <button class="btn" onclick="rescheduleAllPending()" style="font-size: 11px; padding: 5px 12px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px;">
              <i data-lucide="clock" style="width: 12px; height: 12px;"></i> Reprogramar
            </button>
          </div>` : ''}
        </div>
        <div class="planner-summary-grid">
          <div class="planner-summary-cell">
            <div class="planner-summary-val" style="color: var(--accent);">${totalClients}</div>
            <div class="planner-summary-label">Clientes</div>
          </div>
          <div class="planner-summary-cell">
            <div class="planner-summary-val">${Math.round(totalKm)} km</div>
            <div class="planner-summary-label">Recorrido</div>
          </div>
          <div class="planner-summary-cell">
            <div class="planner-summary-val">${Math.round(totalH * 10)/10}h</div>
            <div class="planner-summary-label">Tiempo</div>
          </div>
          <div class="planner-summary-cell">
            <div class="planner-summary-val" style="color: #6366f1;">$${totalCost.toLocaleString('es-CL')}</div>
            <div class="planner-summary-label">Costo aprox</div>
          </div>
        </div>
        <div class="schedule-calendar">
      `;

      const fullDayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

      days.forEach(date => {
        const dayData = schedule[date];
        const d = new Date(date + 'T12:00:00');
        const fullDayName = fullDayNames[d.getDay()];
        const dateFormatted = d.toLocaleDateString('es-CL', { day: 'numeric', month: 'long' });
        const h = dayData.totalHours || 0;
        const colorClass = h < 7 ? 'day-green' : h <= 8 ? 'day-yellow' : 'day-red';
        const count8020 = dayData.clients.filter(c => c.segmentation === '80-20').length;
        const dayCostVal = Math.round(((dayData.totalDistance || 0) / 10) * fuelPrice);

        html += `
          <div class="schedule-day ${colorClass}" onclick="expandDayDetail('${date}', '${userId}')">
            <div class="schedule-day-header">
              <div>
                <div style="font-size: 13px; font-weight: 800;">${fullDayName}</div>
                <div style="font-size: 11px; color: var(--text-muted); font-weight: 500;">${dateFormatted}</div>
              </div>
              <div style="display: flex; flex-direction: column; align-items: center;">
                <span style="font-size: 20px; font-weight: 800; color: var(--accent); line-height: 1;">${dayData.clients.length}</span>
                <span style="font-size: 9px; color: var(--text-muted); text-transform: uppercase;">clientes</span>
              </div>
            </div>
            <div class="schedule-day-stats">
              <span><i data-lucide="navigation" style="width: 10px; height: 10px;"></i> ${dayData.totalDistance || 0}km</span>
              <span><i data-lucide="clock" style="width: 10px; height: 10px;"></i> ${h}h</span>
              ${count8020 > 0 ? `<span style="color: #c9a227; font-weight: 600; font-size: 11px;">★ ${count8020} clave</span>` : ''}
            </div>
            <div style="font-size: 12px; color: #6366f1; font-weight: 700; margin-top: 4px; padding: 4px 10px; background: rgba(99,102,241,0.06); border-radius: 6px; display: inline-block;">Costo: $${dayCostVal.toLocaleString('es-CL')}</div>
            <div style="max-height: 220px; overflow-y: auto; margin-top: 6px;">
        `;

        dayData.clients.forEach((client) => {
          const is8020 = client.segmentation === '80-20';
          const arrival = client.estimatedArrival || '';
          const statusIcon = client.routeStatus === 'completed' ? '<i data-lucide="check-circle" style="width: 11px; height: 11px; color: #10b981;"></i>' :
                             client.routeStatus === 'skipped' ? '<i data-lucide="x-circle" style="width: 11px; height: 11px; color: #ef4444;"></i>' : '';
          html += `
            <div class="schedule-day-client ${is8020 ? 'client-8020' : ''}">
              <span class="time-badge">${arrival ? arrival.substring(0,5) : ''}</span>
              ${getSegBadge(client.segmentation)}
              <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${client.name}${client.address ? ' — ' + client.address : ''}">${client.fantasy_name || client.name}</span>
              ${statusIcon}
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      html += '</div>';
      resultDiv.innerHTML = html;
      lucide.createIcons();
    }

    function expandDayDetail(date, userId) {
      if (!lastScheduleData || !lastScheduleData.schedule[date]) return;
      const dayData = lastScheduleData.schedule[date];
      const d = new Date(date + 'T12:00:00');
      const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
      const isExec = currentUser && currentUser.role === 'executive';
      const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'supervisor');

      // Calculate cost for this day
      const distKm = dayData.totalDistance || 0;
      const fuelEff = 10; // km/L
      const fuelPrice = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1141;
      const dayCost = Math.round((distKm / fuelEff) * fuelPrice);
      const count8020 = dayData.clients.filter(c => c.segmentation === '80-20').length;
      const completedCount = dayData.clients.filter(c => c.routeStatus === 'completed').length;
      const pendingCount = dayData.clients.filter(c => c.routeStatus === 'pending').length;
      const communes = [...new Set(dayData.clients.map(c => c.commune).filter(Boolean))];

      let html = `
        <div class="day-detail-overlay" onclick="if(event.target===this) this.remove()">
          <div class="day-detail-panel">
            <div class="detail-header" style="padding: 14px 20px;">
              <div>
                <div style="font-size: 16px; font-weight: 800;">${dayNames[d.getDay()]} ${d.toLocaleDateString('es-CL', { day: 'numeric', month: 'long' })}</div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                  ${communes.length > 0 ? communes.join(', ') : 'Sin comunas'}
                </div>
              </div>
              <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                <button class="btn" onclick="openDayRouteInMaps('${date}', '${userId}')" style="font-size: 11px; padding: 5px 10px; background: #4285f4; color: white; border: none; border-radius: 6px; display: inline-flex; align-items: center; gap: 3px;" title="Abrir ruta en Google Maps">
                  <i data-lucide="map-pin" style="width:12px;height:12px;"></i> Ruta Maps
                </button>
                ${isAdmin ? `
                <button class="btn" onclick="deleteScheduledDay('${userId}', '${date}')" style="font-size: 11px; padding: 5px 10px; background: rgba(239,68,68,0.1); border: 1px solid #ef4444; color: #ef4444; border-radius: 6px;" title="Eliminar rutas del día">
                  <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i> Eliminar
                </button>
                <button class="btn" onclick="rescheduleDay('${userId}', '${date}')" style="font-size: 11px; padding: 5px 10px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px;">
                  <i data-lucide="calendar-clock" style="width: 12px; height: 12px;"></i> Reprogramar
                </button>` : ''}
                <button onclick="this.closest('.day-detail-overlay').remove()" style="background: none; border: none; cursor: pointer; padding: 4px;">
                  <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                </button>
              </div>
            </div>

            <!-- Stats bar -->
            <div class="day-detail-stats">
              <div class="day-detail-stat-cell">
                <div class="day-detail-stat-val" style="color: var(--accent);">${dayData.clients.length}</div>
                <div class="day-detail-stat-lbl">Clientes</div>
              </div>
              <div class="day-detail-stat-cell">
                <div class="day-detail-stat-val">${distKm} km</div>
                <div class="day-detail-stat-lbl">Recorrido</div>
              </div>
              <div class="day-detail-stat-cell">
                <div class="day-detail-stat-val">${dayData.totalHours || 0}h</div>
                <div class="day-detail-stat-lbl">Tiempo</div>
              </div>
              <div class="day-detail-stat-cell">
                <div class="day-detail-stat-val" style="color: #6366f1;">$${dayCost.toLocaleString('es-CL')}</div>
                <div class="day-detail-stat-lbl">Costo aprox</div>
              </div>
              <div class="day-detail-stat-cell">
                <div class="day-detail-stat-val" style="color: #f59e0b;">${count8020}</div>
                <div class="day-detail-stat-lbl">80-20</div>
              </div>
            </div>

            <!-- Two-column layout: clients + map -->
            <div class="day-detail-body">
              <!-- Left: Client list -->
              <div class="day-detail-clients-col">
                <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: space-between;">
                  <span>Clientes (${dayData.clients.length})</span>
                  ${completedCount > 0 ? `<span style="color: #10b981;">${completedCount} completados</span>` : ''}
                  ${pendingCount > 0 && completedCount > 0 ? `<span>${pendingCount} pendientes</span>` : ''}
                </div>
      `;

      dayData.clients.forEach((client, idx) => {
        const arrival = client.estimatedArrival || '';
        const is8020 = client.segmentation === '80-20';
        const statusBg = client.routeStatus === 'completed' ? 'background: rgba(16,185,129,0.06);' :
                         client.routeStatus === 'skipped' ? 'background: rgba(239,68,68,0.06);' : '';
        const statusIcon = client.routeStatus === 'completed' ? '<span style="color: #10b981;"><i data-lucide="check" style="width:10px;height:10px;"></i></span>' :
                           client.routeStatus === 'skipped' ? '<span style="color: #ef4444; font-size: 9px; font-weight: 700;">✗</span>' : '';
        html += `
          <div style="display: flex; align-items: center; gap: 8px; padding: 7px 8px; border-radius: 6px; margin-bottom: 2px; ${statusBg} ${is8020 ? 'border-left: 3px solid #f59e0b;' : ''}">
            <div style="min-width: 22px; height: 22px; border-radius: 50%; background: ${is8020 ? '#f59e0b' : 'var(--accent)'}; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;">${idx+1}</div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${client.name}">
                ${client.fantasy_name || client.name} ${statusIcon}
              </div>
              <div style="font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${client.address || ''} ${client.commune ? '— ' + client.commune : ''}
              </div>
              ${arrival ? `<div style="font-size: 9px; color: var(--accent); font-weight: 600;"><i data-lucide="clock" style="width:9px;height:9px;display:inline-block;vertical-align:middle;"></i> ${arrival.substring(0,5)}</div>` : ''}
            </div>
            <div style="display: flex; gap: 2px; align-items: center; flex-shrink: 0;">
              ${client.lat && client.lng ? `
                <button onclick="event.stopPropagation(); openWazeToClient(${client.lat}, ${client.lng})" title="Waze" style="background: #33ccff; border: none; cursor: pointer; color: #000; padding: 2px 5px; border-radius: 4px; font-size: 10px; display:inline-flex; align-items:center;"><i data-lucide="navigation" style="width:11px;height:11px;"></i></button>
              ` : ''}
              ${client.routeStatus === 'pending' && client.scheduledRouteId ? `
                ${isAdmin ? `
                  <button onclick="event.stopPropagation(); deleteScheduledRoute('${client.scheduledRouteId}')" title="Eliminar" style="background: none; border: none; cursor: pointer; color: #ef4444; padding: 3px;">
                    <i data-lucide="trash-2" style="width: 12px; height: 12px;"></i>
                  </button>
                ` : ''}
                ${isExec ? `
                  <button onclick="event.stopPropagation(); skipRouteClient('${client.scheduledRouteId}')" title="Saltar" style="background: none; border: none; cursor: pointer; color: #ef4444; padding: 3px;">
                    <i data-lucide="x-circle" style="width: 13px; height: 13px;"></i>
                  </button>
                  <button onclick="event.stopPropagation(); rescheduleRouteClient('${client.scheduledRouteId}')" title="Reagendar" style="background: none; border: none; cursor: pointer; color: #f59e0b; padding: 3px;">
                    <i data-lucide="calendar-clock" style="width: 13px; height: 13px;"></i>
                  </button>
                ` : ''}
              ` : ''}
            </div>
          </div>
        `;
      });

      html += `
              </div>
              <!-- Right: Mini-map -->
              <div class="day-detail-map-col">
                <div id="day-detail-map" style="width: 100%; height: 100%; min-height: 300px;"></div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', html);
      lucide.createIcons();

      // Initialize mini-map for this day's route
      initDayDetailMap(dayData.clients);
    }

    // Create a mini-map inside the day detail overlay showing the route
    function initDayDetailMap(clients) {
      const mapDiv = document.getElementById('day-detail-map');
      if (!mapDiv || !google?.maps) return;

      const clientsWithGPS = clients.filter(c => c.lat && c.lng);
      if (clientsWithGPS.length === 0) {
        mapDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 12px;">Sin coordenadas GPS</div>';
        return;
      }

      const center = { lat: clientsWithGPS[0].lat, lng: clientsWithGPS[0].lng };
      const miniMap = new google.maps.Map(mapDiv, {
        center,
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: true,
        styles: [{ featureType: 'poi', stylers: [{ visibility: 'off' }] }]
      });

      const bounds = new google.maps.LatLngBounds();

      // Add numbered markers
      clientsWithGPS.forEach((client, idx) => {
        const pos = { lat: client.lat, lng: client.lng };
        bounds.extend(pos);

        const is8020 = client.segmentation === '80-20';
        const marker = new google.maps.Marker({
          position: pos,
          map: miniMap,
          label: {
            text: String(idx + 1),
            color: 'white',
            fontSize: '10px',
            fontWeight: '700'
          },
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 14,
            fillColor: is8020 ? '#f59e0b' : '#6366f1',
            fillOpacity: 1,
            strokeColor: 'white',
            strokeWeight: 2
          },
          title: client.fantasy_name || client.name
        });

        const infoWindow = new google.maps.InfoWindow({
          content: `<div style="font-size: 12px; max-width: 200px;">
            <strong>${idx+1}. ${client.fantasy_name || client.name}</strong>
            <div style="color: #666; margin-top: 2px;">${client.address || ''}</div>
            ${client.commune ? `<div style="color: #999;">${client.commune}</div>` : ''}
          </div>`
        });
        marker.addListener('click', () => infoWindow.open(miniMap, marker));
      });

      miniMap.fitBounds(bounds);
      if (clientsWithGPS.length === 1) { miniMap.setZoom(14); return; }

      // Draw driving route using Directions API
      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer({
        map: miniMap,
        suppressMarkers: true, // We already have custom markers
        polylineOptions: {
          strokeColor: '#6366f1',
          strokeOpacity: 0.8,
          strokeWeight: 4
        }
      });

      // Directions API supports max 25 waypoints; origin + destination + 23 intermediate
      const origin = { lat: clientsWithGPS[0].lat, lng: clientsWithGPS[0].lng };
      const destination = { lat: clientsWithGPS[clientsWithGPS.length - 1].lat, lng: clientsWithGPS[clientsWithGPS.length - 1].lng };
      const waypointClients = clientsWithGPS.slice(1, -1);

      // If more than 23 intermediate waypoints, sample evenly
      let waypoints;
      if (waypointClients.length <= 23) {
        waypoints = waypointClients.map(c => ({ location: { lat: c.lat, lng: c.lng }, stopover: true }));
      } else {
        waypoints = [];
        const step = waypointClients.length / 23;
        for (let i = 0; i < 23; i++) {
          const c = waypointClients[Math.round(i * step)];
          waypoints.push({ location: { lat: c.lat, lng: c.lng }, stopover: true });
        }
      }

      directionsService.route({
        origin,
        destination,
        waypoints,
        optimizeWaypoints: false, // Keep our order
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        } else {
          // Fallback: draw straight polyline if Directions fails
          console.warn('[Map] Directions failed:', status, '- using polyline fallback');
          const path = clientsWithGPS.map(c => ({ lat: c.lat, lng: c.lng }));
          new google.maps.Polyline({
            path,
            geodesic: true,
            strokeColor: '#6366f1',
            strokeOpacity: 0.6,
            strokeWeight: 3,
            strokeDashArray: [4, 4],
            map: miniMap
          });
        }
      });
    }

    // Executive: skip a client
    async function skipRouteClient(routeId) {
      const reason = prompt('Razón para saltar este cliente:');
      if (reason === null) return;

      try {
        const res = await fetch(`${API}/api/routes/schedule/${routeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'skip', reason })
        });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Cliente saltado', 'Se notificó al admin');
          document.querySelector('.day-detail-overlay')?.remove();
          loadExistingSchedule();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // Executive: reschedule a client
    async function rescheduleRouteClient(routeId) {
      const reason = prompt('Razón para reagendar:');
      if (reason === null) return;
      const newDate = prompt('Nueva fecha (YYYY-MM-DD):');
      if (!newDate) return;

      try {
        const res = await fetch(`${API}/api/routes/schedule/${routeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'reschedule', reason, newDate })
        });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Cliente reagendado', 'Se notificó al admin');
          document.querySelector('.day-detail-overlay')?.remove();
          loadExistingSchedule();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    async function rescheduleDay(userId, date) {
      if (!confirm(`¿Reprogramar visitas pendientes del ${date} al siguiente día hábil?`)) return;

      try {
        const res = await fetch(`${API}/api/routes/reschedule-incomplete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, date })
        });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Reprogramado', data.message);
          document.querySelector('.day-detail-overlay')?.remove();
          loadExistingSchedule();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    async function rescheduleAllPending() {
      const userId = document.getElementById('schedule-vendor').value;
      if (!userId) return;
      const today = new Date().toISOString().split('T')[0];
      if (!confirm(`¿Reprogramar todas las visitas pendientes de hoy (${today})?`)) return;

      try {
        const res = await fetch(`${API}/api/routes/auto-reschedule`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Auto-reprogramación', data.message);
          loadExistingSchedule();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // Admin: delete all scheduled days for this vendor/week
    async function deleteAllScheduledDays() {
      const userId = document.getElementById('schedule-vendor').value;
      if (!userId) return;
      if (!lastScheduleData || !lastScheduleData.schedule) return;

      const days = Object.keys(lastScheduleData.schedule).sort();
      if (days.length === 0) return;

      const totalClients = days.reduce((s, d) => s + (lastScheduleData.schedule[d]?.clients?.length || 0), 0);
      if (!confirm(`¿Eliminar TODAS las rutas programadas de la semana?\n\n${totalClients} clientes en ${days.length} días serán eliminados.\nEsta acción no se puede deshacer.`)) return;

      try {
        let totalDeleted = 0;
        for (const date of days) {
          const res = await fetch(`${API}/api/routes/schedule/${userId}/${date}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) totalDeleted += data.data.deleted;
        }
        showToast('success', 'Eliminado', `${totalDeleted} rutas eliminadas`);
        loadExistingSchedule();
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // Admin: delete all scheduled routes for a specific executive
    async function deleteExecSchedule(userId, execName, totalClients) {
      if (!confirm(`¿Eliminar TODAS las rutas programadas de ${execName}?\n\n${totalClients} clientes serán eliminados.\nEsta acción no se puede deshacer.`)) return;

      try {
        // Try to get dates from weeklyAllExecsData (planner) or fetch from API
        let dates = [];
        const execData = weeklyAllExecsData && weeklyAllExecsData[userId];
        if (execData && execData.dates) {
          dates = Object.keys(execData.dates);
        } else {
          // Fetch exec's scheduled routes to find all dates
          const todayStr = new Date().toISOString().split('T')[0];
          const futureDate = new Date();
          futureDate.setDate(futureDate.getDate() + 60);
          const endStr = futureDate.toISOString().split('T')[0];
          const res = await fetch(`${API}/api/routes/schedule/${userId}?startDate=${todayStr}&endDate=${endStr}`);
          const json = await res.json();
          if (json.success && json.data) {
            dates = Object.keys(json.data);
          }
        }

        if (dates.length === 0) {
          showToast('warning', 'Sin datos', 'No se encontraron rutas programadas para este vendedor');
          return;
        }

        let totalDeleted = 0;
        for (const date of dates) {
          const res = await fetch(`${API}/api/routes/schedule/${userId}/${date}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) totalDeleted += data.data.deleted;
        }
        showToast('success', 'Eliminado', `${totalDeleted} rutas de ${execName} eliminadas`);
        // Refresh whichever view is active
        if (document.getElementById('route-subpanel-planner')?.classList.contains('active')) {
          loadWeeklyAllExecs();
        } else {
          updateRouteDashboard();
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // Admin: delete ALL scheduled routes for ALL executives
    async function deleteAllScheduledRoutes() {
      const schedData = window._dashboardScheduleData || {};
      const entries = Object.entries(schedData);
      if (entries.length === 0) {
        showToast('info', 'Sin rutas', 'No hay rutas programadas para eliminar');
        return;
      }
      const totalExecs = entries.length;
      let totalClients = 0;
      entries.forEach(([, info]) => {
        Object.values(info.dates).forEach(day => { totalClients += day.length; });
      });
      if (!confirm(`¿Eliminar TODAS las rutas programadas?\n\n${totalExecs} vendedores · ${totalClients} visitas totales\n\nEsta acción NO se puede deshacer.`)) return;

      try {
        let totalDeleted = 0;
        for (const [uid, info] of entries) {
          const dates = Object.keys(info.dates);
          for (const date of dates) {
            const res = await fetch(`${API}/api/routes/schedule/${uid}/${date}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) totalDeleted += data.data.deleted;
          }
        }
        showToast('success', 'Eliminadas', `${totalDeleted} rutas programadas eliminadas de ${totalExecs} vendedores`);
        updateRouteDashboard();
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // Admin: delete all pending routes for a day
    async function deleteScheduledDay(userId, date) {
      const d = new Date(date + 'T12:00:00');
      const dateLabel = d.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' });
      if (!confirm(`¿Eliminar TODAS las rutas pendientes del ${dateLabel}?\n\nEsta acción no se puede deshacer.`)) return;

      try {
        const res = await fetch(`${API}/api/routes/schedule/${userId}/${date}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Eliminado', `${data.data.deleted} rutas eliminadas del ${dateLabel}`);
          document.querySelector('.day-detail-overlay')?.remove();
          loadExistingSchedule();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // Admin: delete individual scheduled route
    async function deleteScheduledRoute(routeId) {
      if (!confirm('¿Eliminar este cliente de la ruta programada?')) return;

      try {
        const res = await fetch(`${API}/api/routes/schedule-route/${routeId}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          showToast('success', 'Eliminado', 'Cliente eliminado de la ruta');
          document.querySelector('.day-detail-overlay')?.remove();
          loadExistingSchedule();
        } else {
          showToast('error', 'Error', data.error);
        }
      } catch (err) {
        showToast('error', 'Error', err.message);
      }
    }

    // =============================================
    // ALERTAS DE RUTAS
    // =============================================

    async function loadRouteAlerts() {
      if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'supervisor')) {
        document.getElementById('route-alerts-section').style.display = 'none';
        return;
      }
      document.getElementById('route-alerts-section').style.display = '';

      try {
        const res = await fetch(`${API}/api/routes/alerts`);
        const data = await res.json();
        if (data.success) {
          renderRouteAlerts(data.data || []);
        }
      } catch (err) { /* silent */ }

      updateAlertBadge();
    }

    function renderRouteAlerts(alerts) {
      const list = document.getElementById('route-alerts-list');
      const unread = alerts.filter(a => !a.read);
      const countBadge = document.getElementById('alerts-count-badge');

      if (unread.length > 0) {
        countBadge.textContent = unread.length;
        countBadge.style.display = '';
      } else {
        countBadge.style.display = 'none';
      }

      if (alerts.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 16px; font-size: 12px; color: var(--text-muted);">Sin alertas recientes</div>';
        return;
      }

      let html = '';
      alerts.slice(0, 20).forEach(alert => {
        const time = new Date(alert.created_at).toLocaleString('es-CL', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        const icon = alert.alert_type === 'visit_skipped' ? 'x-circle' :
                     alert.alert_type === 'route_rescheduled' ? 'calendar-clock' : 'bell';
        const iconColor = alert.alert_type === 'visit_skipped' ? '#ef4444' : '#f59e0b';
        html += `
          <div class="route-alert-item ${alert.read ? '' : 'unread'}" onclick="markRouteAlertRead('${alert.id}', this)">
            <i data-lucide="${icon}" style="width: 16px; height: 16px; color: ${iconColor}; flex-shrink: 0; margin-top: 1px;"></i>
            <div style="flex: 1;">${alert.message}</div>
            <div class="alert-time">${time}</div>
          </div>
        `;
      });
      list.innerHTML = html;
      lucide.createIcons();
    }

    async function markRouteAlertRead(alertId, el) {
      try {
        await fetch(`${API}/api/routes/alerts/${alertId}/read`, { method: 'PUT' });
        if (el) el.classList.remove('unread');
        updateAlertBadge();
      } catch (err) { /* silent */ }
    }

    async function markAllRouteAlertsRead() {
      try {
        await fetch(`${API}/api/routes/alerts/read-all`, { method: 'PUT' });
        document.querySelectorAll('.route-alert-item.unread').forEach(el => el.classList.remove('unread'));
        document.getElementById('alerts-count-badge').style.display = 'none';
        updateAlertBadge();
        showToast('success', 'Alertas', 'Todas marcadas como leídas');
      } catch (err) { /* silent */ }
    }

    async function updateAlertBadge() {
      if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'supervisor')) {
        const navBadge = document.getElementById('nav-route-alerts-badge');
        if (navBadge) navBadge.style.display = 'none';
        return;
      }

      try {
        const res = await fetch(`${API}/api/routes/alerts/count`);
        const data = await res.json();
        const count = data.count || 0;

        const navBadge = document.getElementById('nav-route-alerts-badge');
        if (navBadge) {
          if (count > 0) {
            navBadge.textContent = count > 99 ? '99+' : count;
            navBadge.style.display = '';
          } else {
            navBadge.style.display = 'none';
          }
        }
      } catch (err) { /* silent */ }
    }

    // =============================================
    // MONTHLY CALENDAR MULTI-EXEC
    // =============================================
    let currentMonthOffset = 0;
    let monthlyCalendarData = null;
    const EXEC_COLORS = [
      '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
      '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#6366f1',
      '#84cc16', '#e11d48'
    ];
    let execColorMap = {};

    function getMonthRange(offset) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + offset;
      const d = new Date(year, month, 1);
      const y = d.getFullYear();
      const m = d.getMonth();
      const firstDay = new Date(y, m, 1);
      const lastDay = new Date(y, m + 1, 0);
      return {
        year: y,
        month: m,
        startDate: firstDay.toISOString().split('T')[0],
        endDate: lastDay.toISOString().split('T')[0]
      };
    }

    function navigateMonth(direction) {
      currentMonthOffset += direction;
      updateMonthLabel();
      loadMonthlyCalendar();
    }

    function updateMonthLabel() {
      const { year, month } = getMonthRange(currentMonthOffset);
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const label = document.getElementById('monthly-label');
      if (label) label.textContent = `${monthNames[month]} ${year}`;
    }

    async function loadMonthlyCalendar() {
      const { year, month, startDate, endDate } = getMonthRange(currentMonthOffset);
      updateMonthLabel();

      // Update subtitle for executive view
      const subtitle = document.getElementById('monthly-subtitle');
      if (subtitle) {
        subtitle.textContent = (currentUser && currentUser.role === 'executive') ? 'Mi Calendario' : 'Todos los Vendedores';
      }

      const container = document.getElementById('monthly-calendar-container');
      if (container) container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><div class="spinner" style="margin: 0 auto 8px;"></div>Cargando calendario...</div>';

      try {
        const res = await fetch(`/api/routes/schedule-all?startDate=${startDate}&endDate=${endDate}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        // Executive: filter to only their own data
        if (currentUser && currentUser.role === 'executive') {
          const filtered = {};
          if (json.data[currentUser.id]) filtered[currentUser.id] = json.data[currentUser.id];
          monthlyCalendarData = filtered;
        } else {
          monthlyCalendarData = json.data;
        }
        assignExecColors(monthlyCalendarData);
        renderMonthlyCalendar(monthlyCalendarData, year, month);
      } catch (err) {
        if (container) container.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444;">Error: ${err.message}</div>`;
      }
    }

    function assignExecColors(data) {
      execColorMap = {};
      let idx = 0;
      Object.keys(data).forEach(uid => {
        execColorMap[uid] = EXEC_COLORS[idx % EXEC_COLORS.length];
        idx++;
      });
    }

    function renderMonthlyCalendar(data, year, month) {
      const container = document.getElementById('monthly-calendar-container');
      const legendEl = document.getElementById('monthly-exec-legend');
      const totalsEl = document.getElementById('monthly-totals');
      if (!container) return;

      const fuelEff = 10;
      const fuelPrice = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1141;
      const todayStr = new Date().toISOString().split('T')[0];

      // Exec legend
      let legendHtml = '';
      let totalClients = 0, totalKm = 0, totalCost = 0;
      const execStats = {};

      Object.entries(data).forEach(([uid, info]) => {
        const color = execColorMap[uid] || '#666';
        let clients = 0, km = 0;
        const _eu4 = allUsers ? allUsers.find(u => u.id === uid) : null;
        const _sp4 = (_eu4 && _eu4.home_lat && _eu4.home_lng) ? { lat: parseFloat(_eu4.home_lat), lng: parseFloat(_eu4.home_lng) } : null;
        Object.values(info.dates).forEach(routes => {
          clients += routes.length;
          const dayKm = calcRoutesDistanceKm(routes, _sp4);
          km += dayKm;
        });
        const cost = Math.round((km / fuelEff) * fuelPrice);
        execStats[uid] = { clients, km: Math.round(km), cost, days: Object.keys(info.dates).length };
        totalClients += clients;
        totalKm += km;
        totalCost += cost;

        legendHtml += `
          <div class="exec-legend-item">
            <div class="legend-dot" style="background: ${color};"></div>
            <span>${info.userName}</span>
            <span style="color: var(--text-muted); font-weight: 400;">${clients} clientes · $${cost.toLocaleString('es-CL')}</span>
          </div>`;
      });

      if (legendEl) legendEl.innerHTML = legendHtml;

      // Totals bar
      const execCount = Object.keys(data).length;
      if (totalsEl) {
        totalsEl.innerHTML = `
          <div class="monthly-totals-bar">
            <div class="mt-stat"><strong>${execCount}</strong> vendedores</div>
            <div class="mt-stat"><strong>${totalClients}</strong> clientes</div>
            <div class="mt-stat" style="color: #6366f1; font-weight: 700;">
              Costo total recorrido aprox: <strong>$${Math.round(totalCost).toLocaleString('es-CL')}</strong>
            </div>
          </div>`;
      }

      // Build calendar grid
      const firstDayOfMonth = new Date(year, month, 1);
      const lastDayOfMonth = new Date(year, month + 1, 0);
      const daysInMonth = lastDayOfMonth.getDate();

      // Monday = 0 in our grid
      let startWeekday = firstDayOfMonth.getDay() - 1;
      if (startWeekday < 0) startWeekday = 6;

      const dayHeaders = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
      let html = '<div class="monthly-calendar-grid">';
      dayHeaders.forEach((dh, i) => {
        html += `<div class="cal-header ${i >= 5 ? 'weekend' : ''}">${dh}</div>`;
      });

      // Previous month padding
      const prevMonthLast = new Date(year, month, 0).getDate();
      for (let i = startWeekday - 1; i >= 0; i--) {
        const dayNum = prevMonthLast - i;
        html += `<div class="monthly-cal-day other-month"><div class="day-number">${dayNum}</div></div>`;
      }

      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dow = new Date(year, month, day).getDay();
        const isWeekend = dow === 0 || dow === 6;
        const isToday = dateStr === todayStr;

        let classes = 'monthly-cal-day';
        if (isWeekend) classes += ' weekend';
        if (isToday) classes += ' today';

        let badgesHtml = '';
        Object.entries(data).forEach(([uid, info]) => {
          const dayRoutes = info.dates[dateStr];
          if (!dayRoutes || dayRoutes.length === 0) return;

          const color = execColorMap[uid] || '#666';
          const shortName = (info.userName || '').split(' ')[0];
          const count = dayRoutes.length;
          const has8020 = dayRoutes.some(r => r.client?.segmentation === '80-20');
          const _eu5 = allUsers ? allUsers.find(u => u.id === uid) : null;
          const _sp5 = (_eu5 && _eu5.home_lat && _eu5.home_lng) ? { lat: parseFloat(_eu5.home_lat), lng: parseFloat(_eu5.home_lng) } : null;
          const dayKm = calcRoutesDistanceKm(dayRoutes, _sp5);
          const dayH = dayRoutes.length * 30; // ~30min per client
          const dayCost = Math.round((dayKm / fuelEff) * fuelPrice);

          badgesHtml += `
            <div class="exec-badge" style="background: ${color}22; color: ${color}; border-left: 3px solid ${color};"
              onclick="event.stopPropagation(); showMonthlyDayDetail('${dateStr}', '${uid}')"
              title="${info.userName}: ${count} clientes, ~${Math.round(dayKm)}km, ~${(dayH / 60).toFixed(1)}h, $${dayCost.toLocaleString('es-CL')}">
              <span class="eb-name">${shortName}</span>
              <span class="eb-count">${count}</span>
              ${has8020 ? '<span class="eb-star">★</span>' : ''}
            </div>`;
        });

        html += `
          <div class="${classes}">
            <div class="day-number">${day}</div>
            <div class="exec-badges">${badgesHtml}</div>
          </div>`;
      }

      // Next month padding
      const totalCells = startWeekday + daysInMonth;
      const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="monthly-cal-day other-month"><div class="day-number">${i}</div></div>`;
      }

      html += '</div>';
      container.innerHTML = html;
      lucide.createIcons();
    }

    function showMonthlyDayDetail(date, userId) {
      if (!monthlyCalendarData || !monthlyCalendarData[userId]) return;
      const info = monthlyCalendarData[userId];
      const dayRoutes = info.dates[date];
      if (!dayRoutes || dayRoutes.length === 0) return;

      const d = new Date(date + 'T12:00:00');
      const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
      const color = execColorMap[userId] || '#3b82f6';
      const fuelEff = 10;
      const fuelPrice = (window.vehicleConfig && window.vehicleConfig.FUEL_PRICE_PER_LITER) || 1141;

      const _eu6 = allUsers ? allUsers.find(u => u.id === userId) : null;
      const _sp6 = (_eu6 && _eu6.home_lat && _eu6.home_lng) ? { lat: parseFloat(_eu6.home_lat), lng: parseFloat(_eu6.home_lng) } : null;
      const totalKm = calcRoutesDistanceKm(dayRoutes, _sp6);
      const totalMin = dayRoutes.reduce((s, r) => s + (r.estimated_duration || 0), 0);
      const dayCost = Math.round((totalKm / fuelEff) * fuelPrice);
      const count8020 = dayRoutes.filter(r => r.client?.segmentation === '80-20').length;
      const communes = [...new Set(dayRoutes.map(r => r.client?.commune).filter(Boolean))];

      let html = `
        <div class="monthly-detail-overlay" onclick="if(event.target===this) this.remove()">
          <div class="monthly-detail-panel">
            <div style="padding: 14px 20px; border-bottom: 3px solid ${color}; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 15px; font-weight: 800;">${info.userName}</div>
                <div style="font-size: 12px; color: var(--text-muted);">
                  ${dayNames[d.getDay()]} ${d.toLocaleDateString('es-CL', { day: 'numeric', month: 'long', year: 'numeric' })}
                </div>
                <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">
                  ${communes.length > 0 ? communes.join(', ') : ''}
                </div>
              </div>
              <div style="display: flex; gap: 6px; align-items: center;">
                <button class="btn" onclick="drillDownToExecWeek('${userId}', '${date}')" style="font-size: 11px; padding: 5px 10px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px;">
                  <i data-lucide="calendar-range" style="width: 12px; height: 12px;"></i> Ver Semana
                </button>
                <button onclick="this.closest('.monthly-detail-overlay').remove()" style="background: none; border: none; cursor: pointer; padding: 4px;">
                  <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                </button>
              </div>
            </div>

            <!-- Stats bar -->
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0; border-bottom: 1px solid var(--border); background: var(--bg-hover);">
              <div style="padding: 10px; text-align: center; border-right: 1px solid var(--border);">
                <div style="font-size: 18px; font-weight: 800; color: var(--accent);">${dayRoutes.length}</div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Clientes</div>
              </div>
              <div style="padding: 10px; text-align: center; border-right: 1px solid var(--border);">
                <div style="font-size: 18px; font-weight: 800;">${Math.round(totalKm)}</div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">KM</div>
              </div>
              <div style="padding: 10px; text-align: center; border-right: 1px solid var(--border);">
                <div style="font-size: 18px; font-weight: 800;">${(totalMin / 60).toFixed(1)}h</div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Tiempo</div>
              </div>
              <div style="padding: 10px; text-align: center; border-right: 1px solid var(--border);">
                <div style="font-size: 18px; font-weight: 800; color: #6366f1;">$${dayCost.toLocaleString('es-CL')}</div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Costo total recorrido</div>
              </div>
              <div style="padding: 10px; text-align: center;">
                <div style="font-size: 18px; font-weight: 800; color: #f59e0b;">${count8020}</div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">80-20</div>
              </div>
            </div>

            <!-- Client list -->
            <div style="overflow-y: auto; max-height: 50vh; padding: 12px 16px;">
              <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">
                Clientes (${dayRoutes.length})
              </div>`;

      dayRoutes.forEach((route, idx) => {
        const client = route.client || {};
        const is8020 = client.segmentation === '80-20';
        const statusBg = route.status === 'completed' ? 'background: rgba(16,185,129,0.06);' :
                         route.status === 'skipped' ? 'background: rgba(239,68,68,0.06);' : '';
        const statusIcon = route.status === 'completed' ? '<span style="color: #10b981;"><i data-lucide="check" style="width:10px;height:10px;"></i></span>' :
                           route.status === 'skipped' ? '<span style="color: #ef4444; font-size: 9px; font-weight: 700;">✗</span>' : '';

        html += `
              <div style="display: flex; align-items: center; gap: 8px; padding: 7px 8px; border-radius: 6px; margin-bottom: 2px; ${statusBg} ${is8020 ? 'border-left: 3px solid #f59e0b;' : ''}">
                <div style="min-width: 22px; height: 22px; border-radius: 50%; background: ${is8020 ? '#f59e0b' : color}; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700;">${idx + 1}</div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${client.name || ''}">
                    ${client.fantasy_name || client.name || 'Sin nombre'} ${statusIcon}
                  </div>
                  <div style="font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${client.address || ''} ${client.commune ? '— ' + client.commune : ''}
                  </div>
                </div>
                <div style="display: flex; gap: 2px; align-items: center; flex-shrink: 0;">
                  ${is8020 ? '<span class="seg-badge seg-badge-8020" style="font-size: 9px; padding: 1px 5px;">80-20</span>' : ''}
                  ${client.lat && client.lng ? `
                    <button onclick="event.stopPropagation(); openWazeToClient(${client.lat}, ${client.lng})" title="Waze" style="background: #33ccff; border: none; cursor: pointer; color: #000; padding: 2px 5px; border-radius: 4px; font-size: 10px; display:inline-flex; align-items:center;"><i data-lucide="navigation" style="width:11px;height:11px;"></i></button>
                  ` : ''}
                </div>
              </div>`;
      });

      html += `
            </div>
          </div>
        </div>`;

      document.body.insertAdjacentHTML('beforeend', html);
      lucide.createIcons();
    }

    function drillDownToExecWeek(userId, date) {
      // Close monthly overlay
      document.querySelector('.monthly-detail-overlay')?.remove();

      // Calculate week offset for the given date
      const target = new Date(date + 'T12:00:00');
      const now = new Date();
      const startOfThisWeek = new Date(now);
      const dayOfWeek = startOfThisWeek.getDay();
      const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
      startOfThisWeek.setDate(startOfThisWeek.getDate() + diffToMonday);
      startOfThisWeek.setHours(0, 0, 0, 0);

      const startOfTargetWeek = new Date(target);
      const targetDow = startOfTargetWeek.getDay();
      const diffToTargetMonday = targetDow === 0 ? -6 : 1 - targetDow;
      startOfTargetWeek.setDate(startOfTargetWeek.getDate() + diffToTargetMonday);
      startOfTargetWeek.setHours(0, 0, 0, 0);

      const weekDiff = Math.round((startOfTargetWeek - startOfThisWeek) / (7 * 24 * 60 * 60 * 1000));
      currentWeekOffset = weekDiff;
      setWeekFromOffset(currentWeekOffset);

      // Switch to planner tab and show individual exec
      switchRouteTab('planner');
      setTimeout(() => showExecWeekDetail(userId), 300);
    }

    // =============================================
    // AI CHAT ASSISTANT
    // =============================================
    let aiChatHistory = [];

    function toggleAiChat() {
      const panel = document.getElementById('ai-chat-panel');
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        document.getElementById('ai-chat-input').focus();
        lucide.createIcons();
      }
    }

    async function sendAiMessage() {
      const input = document.getElementById('ai-chat-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';

      // Add user message to UI
      const messagesDiv = document.getElementById('ai-chat-messages');
      messagesDiv.innerHTML += `<div class="ai-msg user">${escapeHtml(message)}</div>`;

      // Add loading indicator
      const loadingId = 'ai-loading-' + Date.now();
      messagesDiv.innerHTML += `<div class="ai-msg assistant" id="${loadingId}" style="opacity: 0.6;"><i data-lucide="loader-2" class="spin" style="width: 16px; height: 16px;"></i> Pensando...</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      lucide.createIcons();

      try {
        // Build context
        const context = {
          totalVendedores: executives ? executives.length : 0,
          totalClientes: allClients.length,
          rutasHoy: todayRoutesData ? todayRoutesData.length : 0,
          fecha: new Date().toLocaleDateString('es-CL')
        };

        aiChatHistory.push({ role: 'user', content: message });

        const res = await fetch(`${API}/api/assistant/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, context, history: aiChatHistory.slice(-10) })
        });
        const data = await res.json();

        // Remove loading
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        if (data.success) {
          const response = data.data.response;
          aiChatHistory.push({ role: 'assistant', content: response });
          messagesDiv.innerHTML += `<div class="ai-msg assistant">${formatAiResponse(response)}</div>`;
        } else {
          messagesDiv.innerHTML += `<div class="ai-msg assistant" style="color: #ef4444;">${data.error || 'Error al procesar tu consulta'}</div>`;
        }
      } catch (err) {
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();
        messagesDiv.innerHTML += `<div class="ai-msg assistant" style="color: #ef4444;">Error de conexión. Verifica que el servidor esté corriendo.</div>`;
      }

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      lucide.createIcons();
    }

    function formatAiResponse(text) {
      // Basic markdown: bold, italic, code
      return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code style="background:var(--bg-hover);padding:2px 4px;border-radius:3px;font-size:12px;">$1</code>')
        .replace(/\n/g, '<br>');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // =============================================
    // DASHBOARD VENDEDOR + CALENDARIO
    // =============================================

    async function loadVendorDashboard() {
      const monthInput = document.getElementById('vendor-stats-month');
      if (!monthInput.value) {
        monthInput.value = new Date().toISOString().slice(0, 7);
      }
      const month = monthInput.value;
      const grid = document.getElementById('vendor-stats-grid');
      grid.innerHTML = '<div style="text-align: center; padding: 24px; grid-column: 1 / -1;"><i data-lucide="loader-2" class="spin" style="width: 24px; height: 24px;"></i><p style="font-size: 12px; margin-top: 8px;">Cargando estadísticas...</p></div>';
      lucide.createIcons();

      try {
        const res = await fetch(`${API}/api/dashboard/vendor-stats?month=${month}`);
        const data = await res.json();

        if (data.success && data.data.length > 0) {
          let html = '';
          data.data.forEach(vendor => {
            // Cross-reference allClients to get 80/20 count for this vendor
            const user = (allUsers || []).find(u => u.full_name === vendor.name);
            const userId = user ? user.id : null;
            const vendorClients = userId ? (allClients || []).filter(c => c.assigned_user_id === userId) : [];
            const clients8020 = vendorClients.filter(c => c.segmentation === '80-20');
            const clientsL = vendorClients.filter(c => c.segmentation === 'L');
            const pct8020 = vendorClients.length > 0 ? Math.round(clients8020.length / vendorClients.length * 100) : 0;
            const zc = user && user.zone ? (ZONE_COLORS[user.zone.toLowerCase()] || {color:'var(--text-muted)',bg:'var(--bg-hover)',border:'var(--border)'}) : {color:'var(--text-muted)',bg:'var(--bg-hover)',border:'var(--border)'};

            let weeklyHtml = '';
            vendor.weekly.forEach(w => {
              weeklyHtml += `<div style="display: flex; justify-content: space-between; font-size: 11px; padding: 3px 0; border-bottom: 1px solid var(--border);">
                <span>${w.week}</span>
                <span>${w.clients} cl, ${w.days} días</span>
              </div>`;
            });

            html += `
              <div class="vendor-stat-card">
                <h4 style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                  <span style="width:28px;height:28px;border-radius:50%;background:${zc.color};color:white;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">${vendor.name.split(' ').map(n=>n[0]||'').join('').substring(0,2).toUpperCase()}</span>
                  <span>${vendor.name}</span>
                  ${user && user.zone ? `<span style="font-size:10px;background:${zc.bg};color:${zc.color};border:1px solid ${zc.border};padding:1px 6px;border-radius:4px;font-weight:600;">${user.zone}</span>` : ''}
                </h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 10px;">
                  <div style="text-align: center; padding: 8px 4px; background: var(--bg-hover); border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: 700; color: var(--accent);">${vendor.clientsWithSale}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">Con vta</div>
                  </div>
                  <div style="text-align: center; padding: 8px 4px; background: var(--bg-hover); border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: 700; color: var(--success);">${vendor.totalVisits}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">Visitas</div>
                  </div>
                  <div style="text-align: center; padding: 8px 4px; background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px;">
                    <div style="font-size: 18px; font-weight: 700; color: #b8860b;">${clients8020.length}</div>
                    <div style="font-size: 10px; color: var(--text-muted);">80/20</div>
                  </div>
                </div>
                ${vendorClients.length > 0 ? `
                <div style="margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px;">
                    <span style="color: var(--text-muted);">${vendorClients.length} asignados</span>
                    <span style="font-weight: 600; color: #b8860b;">${pct8020}% 80/20</span>
                  </div>
                  <div style="height: 5px; background: var(--border); border-radius: 3px; overflow: hidden;">
                    <div style="height: 100%; width: ${pct8020}%; background: linear-gradient(90deg,#d4af37,#b8860b); border-radius: 3px;"></div>
                  </div>
                </div>` : ''}
                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 6px;">Días trabajados: <strong>${vendor.daysWorked}</strong></div>
                ${weeklyHtml}
              </div>
            `;
          });

          grid.innerHTML = html;
        } else {
          grid.innerHTML = '<div style="text-align: center; padding: 24px; color: var(--text-muted); grid-column: 1 / -1;">No hay datos para este mes</div>';
        }
      } catch (err) {
        grid.innerHTML = `<div style="text-align: center; padding: 24px; color: var(--danger); grid-column: 1 / -1;">${err.message}</div>`;
      }

      lucide.createIcons();
    }

    async function loadVendorCalendar() {
      const userId = document.getElementById('calendar-vendor').value;
      const monthInput = document.getElementById('calendar-month');
      if (!monthInput.value) {
        monthInput.value = new Date().toISOString().slice(0, 7);
      }
      const month = monthInput.value;
      const grid = document.getElementById('calendar-grid');

      if (!userId) {
        grid.innerHTML = '<div style="text-align: center; padding: 24px; color: var(--text-muted);">Selecciona un vendedor</div>';
        return;
      }

      grid.innerHTML = '<div style="text-align: center; padding: 24px;"><i data-lucide="loader-2" class="spin" style="width: 24px; height: 24px;"></i></div>';
      lucide.createIcons();

      try {
        const res = await fetch(`${API}/api/dashboard/calendar/${userId}?month=${month}`);
        const data = await res.json();

        if (data.success) {
          renderMonthCalendar(data.data, month);
        } else {
          grid.innerHTML = `<div style="text-align: center; padding: 24px; color: var(--danger);">${data.error || 'Error al cargar'}</div>`;
        }
      } catch (err) {
        grid.innerHTML = `<div style="text-align: center; padding: 24px; color: var(--danger);">${err.message}</div>`;
      }
    }

    function renderMonthCalendar(calendarData, month) {
      const grid = document.getElementById('calendar-grid');
      const [year, mon] = month.split('-').map(Number);
      const firstDay = new Date(year, mon - 1, 1);
      const lastDay = new Date(year, mon, 0);
      const today = new Date().toISOString().split('T')[0];

      const dayHeaders = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
      let html = '<div class="month-calendar">';

      // Headers
      dayHeaders.forEach(d => {
        html += `<div class="month-calendar-header">${d}</div>`;
      });

      // Empty cells for days before first of month (Monday = 0)
      let startDay = firstDay.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1; // Convert to Mon=0

      for (let i = 0; i < startDay; i++) {
        html += '<div class="month-calendar-day"></div>';
      }

      // Days
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateStr = `${year}-${String(mon).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dayData = calendarData[dateStr] || { scheduled: 0, completed: 0, pending: 0, segmentation: {} };
        const isToday = dateStr === today;
        const hasData = dayData.scheduled > 0 || dayData.completed > 0;

        html += `<div class="month-calendar-day ${isToday ? 'today' : ''} ${hasData ? 'has-data' : ''}">
          <div class="day-num">${d}</div>`;

        if (hasData) {
          html += `<div style="font-size: 9px;">
            ${dayData.completed > 0 ? `<span style="color: #10b981;">${dayData.completed}v</span>` : ''}
            ${dayData.pending > 0 ? `<span style="color: #f59e0b;">${dayData.pending}p</span>` : ''}
          </div>
          <div class="day-stats">
            ${(dayData.segmentation['80-20'] || 0) > 0 ? `<div class="day-dot" style="background: #b8860b;" title="80/20: ${dayData.segmentation['80-20']}"></div>` : ''}
            ${(dayData.segmentation.L || 0) > 0 ? `<div class="day-dot" style="background: #2563eb;" title="L: ${dayData.segmentation.L}"></div>` : ''}
            ${(dayData.segmentation.N || 0) > 0 ? `<div class="day-dot" style="background: #6b7280;" title="N: ${dayData.segmentation.N}"></div>` : ''}
          </div>`;
        }

        html += '</div>';
      }

      html += '</div>';
      grid.innerHTML = html;
    }

    // =============================================
    // INITIALIZATION HELPERS
    // =============================================

    function initNewDashboardComponents() {
      // Set default month for vendor stats
      const monthInput = document.getElementById('vendor-stats-month');
      if (monthInput && !monthInput.value) {
        monthInput.value = new Date().toISOString().slice(0, 7);
      }
      const calMonth = document.getElementById('calendar-month');
      if (calMonth && !calMonth.value) {
        calMonth.value = new Date().toISOString().slice(0, 7);
      }

      // Set default dates for schedule planner
      const startInput = document.getElementById('schedule-start');
      const endInput = document.getElementById('schedule-end');
      if (startInput && !startInput.value) {
        const today = new Date();
        // Next Monday
        const nextMon = new Date(today);
        nextMon.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7);
        startInput.value = nextMon.toISOString().split('T')[0];
        // Friday of that week
        const fri = new Date(nextMon);
        fri.setDate(nextMon.getDate() + 4);
        if (endInput) endInput.value = fri.toISOString().split('T')[0];
      }

      // Populate vendor selects for new features
      if (allUsers && allUsers.length > 0) {
        const vendorExecs = allUsers.filter(u => u.role === 'executive' || u.role === 'zonal' || u.role === 'supervisor');

        const scheduleVendor = document.getElementById('schedule-vendor');
        const calendarVendor = document.getElementById('calendar-vendor');

        [scheduleVendor, calendarVendor].forEach(sel => {
          if (!sel) return;
          const current = sel.value;
          // If executive, only show their own entry and pre-select
          if (currentUser && currentUser.role === 'executive') {
            sel.innerHTML = `<option value="${currentUser.id}">${currentUser.full_name}</option>`;
            sel.value = currentUser.id;
          } else {
            sel.innerHTML = '<option value="">-- Seleccionar Vendedor --</option>' +
              vendorExecs.map(u => `<option value="${u.id}">${u.full_name}</option>`).join('');
            if (current) sel.value = current;
          }
        });
      }

      // Load segmentation stats
      loadSegmentationStats();

      // Load Google Sheets URL for map edit links
      fetch(`${API}/api/config/sheets-url`).then(r => r.json()).then(d => {
        window._sheetsUrl = d.url || null;
      }).catch(() => {});

      // Init week planner dates and alerts
      initWeekDates();
      loadRouteAlerts();

      // Auto-load vendor dashboard
      loadVendorDashboard();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      initMaps();

      // Init mobile-style password peek on all password fields
      initPasswordPeek('login-password');
      initPasswordPeek('setup-password');
      initPasswordPeek('setup-password-confirm');

      // Check if user is already logged in
      const savedToken = localStorage.getItem('leker_token');
      const savedUser = localStorage.getItem('leker_user');

      if (savedToken && savedUser) {
        try {
          // Verify token is still valid
          const res = await _originalFetch(API + '/api/auth/me', {
            headers: { 'Authorization': 'Bearer ' + savedToken }
          });
          if (res.ok) {
            const data = await res.json();
            currentUser = data.data;
            localStorage.setItem('leker_user', JSON.stringify(currentUser));
            document.getElementById('login-overlay').classList.add('hidden');
            applyRolePermissions();
            updateSidebarUser();
            loadData();
            updateGpsStatus();
            loadDashboardComparativoSummary();
            setInterval(updateGpsStatus, 30000);

            // Restore saved tab
            const savedTab = localStorage.getItem('leker_active_tab');
            const savedSubtab = localStorage.getItem('leker_active_subtab');
            if (savedTab && savedTab !== 'dashboard') {
              setTimeout(() => {
                let tabItem = document.querySelector(`.nav-subitem[data-tab="${savedTab}"][data-subtab="${savedSubtab}"]`);
                if (!tabItem) {
                  tabItem = document.querySelector(`.nav-item[data-tab="${savedTab}"]`) ||
                            document.querySelector(`.nav-subitem[data-tab="${savedTab}"]`);
                }
                if (tabItem) tabItem.click();
              }, 100);
            }
            return;
          } else {
            // Token expired
            localStorage.removeItem('leker_token');
            localStorage.removeItem('leker_user');
          }
        } catch(e) {
          localStorage.removeItem('leker_token');
          localStorage.removeItem('leker_user');
        }
      }

      // Show login screen
      document.getElementById('login-overlay').classList.remove('hidden');
      checkSetupNeeded();
      lucide.createIcons();
    });
  </script>

  <!-- AI Chat Assistant Widget (pendiente - descomentar cuando se active OPENAI_API_KEY) -->
  <!-- <button class="ai-chat-fab" onclick="toggleAiChat()" title="Asistente IA" id="ai-chat-fab">
    <i data-lucide="bot" style="width: 28px; height: 28px;"></i>
  </button>
  <div class="ai-chat-panel" id="ai-chat-panel">
    <div class="ai-chat-header">
      <div>
        <div style="font-weight: 700; font-size: 15px;">Asistente LEKER <span style="font-size: 10px; opacity: 0.7; font-weight: 400;">ChatGPT</span></div>
        <div style="font-size: 11px; opacity: 0.8;">IA para consultas logísticas</div>
      </div>
      <button onclick="toggleAiChat()" style="background: none; border: none; color: white; cursor: pointer; padding: 4px;">
        <i data-lucide="x" style="width: 20px; height: 20px;"></i>
      </button>
    </div>
    <div class="ai-chat-messages" id="ai-chat-messages">
      <div class="ai-msg assistant">Hola! Soy el asistente de LEKER. Puedo ayudarte con consultas sobre vendedores, rutas, clientes y costos. ¿En qué te puedo ayudar?</div>
    </div>
    <div class="ai-chat-input">
      <input type="text" id="ai-chat-input" placeholder="Escribe tu pregunta..." onkeypress="if(event.key==='Enter')sendAiMessage()">
      <button onclick="sendAiMessage()">Enviar</button>
    </div>
  </div> -->

  <!-- Geocoding Progress Panel -->
  <div class="geocode-panel" id="geocode-panel">
    <div class="geocode-panel-header" onclick="toggleGeocodePanel()">
      <div style="display: flex; align-items: center; gap: 8px;">
        <i data-lucide="map-pin" style="width: 16px; height: 16px;"></i>
        <span id="geocode-panel-title">Geocodificación</span>
      </div>
      <div class="geocode-header-actions">
        <span id="geocode-panel-pct" style="font-size: 11px; opacity: 0.85;">0%</span>
        <button onclick="event.stopPropagation(); toggleGeocodePanel()" title="Minimizar/Expandir">
          <i data-lucide="minus" style="width: 14px; height: 14px;" id="geocode-toggle-icon"></i>
        </button>
        <button onclick="event.stopPropagation(); closeGeocodePanel()" title="Cerrar" id="geocode-close-btn">
          <i data-lucide="x" style="width: 14px; height: 14px;"></i>
        </button>
      </div>
    </div>
    <div class="geocode-progress-bar">
      <div class="fill" id="geocode-progress-fill" style="width: 0%;"></div>
    </div>
    <div class="geocode-panel-stats">
      <span style="color: #059669;"><i data-lucide="check-circle" style="width:11px;height:11px;display:inline-block;vertical-align:middle;"></i> <span id="geocode-stat-ok">0</span> OK</span>
      <span style="color: #dc2626;"><i data-lucide="x-circle" style="width:11px;height:11px;display:inline-block;vertical-align:middle;"></i> <span id="geocode-stat-err">0</span> Error</span>
      <span style="color: #6b7280;"><i data-lucide="loader" style="width:11px;height:11px;display:inline-block;vertical-align:middle;"></i> <span id="geocode-stat-pending">0</span> Pendientes</span>
    </div>
    <div class="geocode-panel-body" id="geocode-panel-log">
    </div>
  </div>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js');
}

// PWA Install prompt
let deferredInstallPrompt = null;
let pwaInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

function showInstallButtons(show) {
  const loginBtn = document.getElementById('install-btn-login');
  const sidebarBtn = document.getElementById('install-btn-sidebar');
  if (loginBtn) loginBtn.style.display = show ? 'flex' : 'none';
  if (sidebarBtn) sidebarBtn.style.display = show ? 'block' : 'none';
}

// If already running as installed PWA, buttons stay hidden (default)
// If NOT installed, show buttons after DOM ready
if (!pwaInstalled) {
  document.addEventListener('DOMContentLoaded', () => showInstallButtons(true));
}

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Browser confirms app is installable — show buttons
  showInstallButtons(true);
});

window.addEventListener('appinstalled', () => {
  pwaInstalled = true;
  deferredInstallPrompt = null;
  showInstallButtons(false);
  showToast('success', 'Listo', 'App instalada correctamente');
});

function installPWA() {
  // If we have the native prompt, use it
  if (deferredInstallPrompt) {
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then((result) => {
      if (result.outcome === 'accepted') {
        showToast('Instalando LEKER...', 'success');
      }
      deferredInstallPrompt = null;
    });
    return;
  }

  // Already installed
  if (pwaInstalled) {
    showToast('La app ya está instalada en este dispositivo', 'info');
    return;
  }

  // Fallback: show instructions modal
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
  const isEdge = /Edg/.test(navigator.userAgent);

  let instructions = '';
  if (isIOS) {
    instructions = `
      <div style="text-align:center;">
        <div style="font-size:40px;margin-bottom:12px;">📱</div>
        <h3 style="margin:0 0 12px;font-size:17px;color:#1f2937;">Instalar en iPhone/iPad</h3>
        <div style="text-align:left;font-size:14px;color:#4b5563;line-height:1.8;">
          <p><strong>1.</strong> Toca el botón <strong>Compartir</strong> <span style="font-size:18px;">⬆</span> en Safari</p>
          <p><strong>2.</strong> Selecciona <strong>"Agregar a pantalla de inicio"</strong></p>
          <p><strong>3.</strong> Toca <strong>"Agregar"</strong></p>
        </div>
      </div>`;
  } else if (isChrome) {
    instructions = `
      <div style="text-align:center;">
        <div style="font-size:40px;margin-bottom:12px;">💻</div>
        <h3 style="margin:0 0 12px;font-size:17px;color:#1f2937;">Instalar en Chrome</h3>
        <div style="text-align:left;font-size:14px;color:#4b5563;line-height:1.8;">
          <p><strong>1.</strong> Haz clic en el ícono <strong>⋮</strong> (menú) arriba a la derecha</p>
          <p><strong>2.</strong> Selecciona <strong>"Instalar LEKER..."</strong> o <strong>"Guardar y compartir" → "Instalar..."</strong></p>
          <p><strong>3.</strong> Confirma haciendo clic en <strong>"Instalar"</strong></p>
        </div>
        <div style="margin-top:12px;padding:8px 14px;background:#f0fdf4;border-radius:8px;font-size:12px;color:#166534;">
          También busca el ícono <strong>⊕</strong> en la barra de direcciones
        </div>
      </div>`;
  } else if (isEdge) {
    instructions = `
      <div style="text-align:center;">
        <div style="font-size:40px;margin-bottom:12px;">🌐</div>
        <h3 style="margin:0 0 12px;font-size:17px;color:#1f2937;">Instalar en Edge</h3>
        <div style="text-align:left;font-size:14px;color:#4b5563;line-height:1.8;">
          <p><strong>1.</strong> Haz clic en el ícono <strong>···</strong> (menú) arriba a la derecha</p>
          <p><strong>2.</strong> Selecciona <strong>"Apps" → "Instalar este sitio como app"</strong></p>
          <p><strong>3.</strong> Confirma haciendo clic en <strong>"Instalar"</strong></p>
        </div>
      </div>`;
  } else {
    instructions = `
      <div style="text-align:center;">
        <div style="font-size:40px;margin-bottom:12px;">📲</div>
        <h3 style="margin:0 0 12px;font-size:17px;color:#1f2937;">Instalar LEKER</h3>
        <div style="font-size:14px;color:#4b5563;line-height:1.8;">
          <p>Abre el menú de tu navegador y busca la opción <strong>"Instalar app"</strong> o <strong>"Agregar a pantalla de inicio"</strong>.</p>
        </div>
      </div>`;
  }

  // Show modal with instructions
  const overlay = document.createElement('div');
  overlay.id = 'pwa-install-modal';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99999;display:flex;align-items:center;justify-content:center;padding:20px;';
  overlay.innerHTML = `
    <div style="background:white;border-radius:16px;padding:28px;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);position:relative;">
      <button onclick="document.getElementById('pwa-install-modal').remove()" style="position:absolute;top:12px;right:12px;background:none;border:none;cursor:pointer;font-size:20px;color:#9ca3af;line-height:1;">✕</button>
      ${instructions}
      <button onclick="document.getElementById('pwa-install-modal').remove()" style="width:100%;margin-top:16px;padding:10px;background:#6366f1;color:white;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">Entendido</button>
    </div>
  `;
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
  document.body.appendChild(overlay);
}
</script>
</body>
</html>
